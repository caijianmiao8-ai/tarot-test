<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{{ spread_config.name }} - 塔罗占卜</title>

  <!-- 本地化资源 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}" />

  <style>
    :root{
      --primary-color:#8e6c88;
      --secondary-color:#d1bfa7;
      --accent-color:#6d4c67;
      --light-color:#f8f4e9;
      --dark-color:#333333;
      --chat-bg:#f5f3f0;
      --user-msg-bg:#8e6c88;
      --ai-msg-bg:#ffffff;
    }
    html,body{ height:100dvh; height:calc(var(--vh,1vh)*100) }
    body{
      background:linear-gradient(135deg,#f8f4e9 0%,#efe7db 100%);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      margin:0; display:flex; flex-direction:column; color:var(--dark-color);
      -webkit-font-smoothing:antialiased;
      min-height: calc(var(--vh,1vh)*100);
    }
    /* 顶部栏 */
    .chat-header{
      background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:14px 20px; display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:5; padding-top: env(safe-area-inset-top, 0px);
    }
    .back-button{
      color:var(--accent-color); text-decoration:none; display:flex; align-items:center; gap:8px;
      transition:.25s ease; font-weight:600; border:1px solid transparent; border-radius:999px; padding:6px 10px;
    }
    .back-button:hover{ color:var(--primary-color); transform:translateX(-2px); background: rgba(0,0,0,0.02); }
    .spread-info{ display:flex; align-items:center; gap:14px; }
    .spread-icon{
      width:40px;height:40px;border-radius:12px; display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--secondary-color),#c6ac92); color:#6a4c45; box-shadow:0 4px 14px rgba(0,0,0,.12);
    }
    .spread-details{ text-align:center; }
    .spread-name{ font-weight:700;color:var(--accent-color);letter-spacing:.2px;margin:0; }
    .spread-count{ font-size:.9rem;color:#6b7280;margin-top:2px; }
    .chat-limit{
      background:rgba(142,108,136,.08); color:var(--accent-color);
      border:1px solid rgba(142,108,136,.18); padding:6px 12px;border-radius:999px;
      font-weight:600;font-size:.92rem;
    }
    .chat-limit .count{color:var(--primary-color)}

    /* 主布局 */
    .main-container{ flex:1; display:flex; overflow:hidden; position:relative; }

    /* 左侧：牌阵展示 */
    .spread-display{
      width:380px;min-width:300px;max-width:420px; background:#fff;overflow:auto;padding:26px;
      border-right:1px solid #eee; box-shadow:2px 0 12px rgba(0,0,0,.04);
      transition:margin-left .28s ease;
    }
    .spread-display.collapsed{ margin-left:-380px }

    .toggle-spread{
      position:absolute;left:380px;top:50%;transform:translateY(-50%);
      width:32px;height:60px;border:1px solid #e5e7eb;border-left:none;border-radius:0 10px 10px 0;background:#fff;
      display:flex;align-items:center;justify-content:center; cursor:pointer; transition:background .2s ease,color .2s ease;
      z-index:3;color:#6b7280;
    }
    .toggle-spread:hover{ background:var(--light-color); color:var(--accent-color) }
    .spread-display.collapsed + .toggle-spread{ left:0 }

    .spread-title{
      font-size:1.35rem;font-weight:800;color:var(--accent-color);
      text-align:center;margin:0 0 10px;
    }
    .spread-question{
      background:rgba(142,108,136,.05);
      border:1px dashed rgba(142,108,136,.25);
      color:#6b7280;padding:12px 14px;border-radius:12px;
      text-align:center;margin-bottom:18px; word-break: break-word;
    }
    .cards-layout{ display:flex;flex-direction:column;gap:14px }
    .card-position{
      background:#fff;border:2px solid #eee;border-radius:14px;padding:16px;
      transition:all .2s ease;position:relative;overflow:hidden;
    }
    .card-position:hover{ border-color:var(--primary-color); transform:translateX(4px) }
    .position-number{
      position:absolute;top:10px;left:12px;width:28px;height:28px;border-radius:50%;
      background:var(--primary-color);color:#fff;font-weight:700;font-size:.9rem; display:flex;align-items:center;justify-content:center;
    }
    .position-info{ margin-left:38px }
    .position-name{ font-weight:700;color:var(--accent-color);margin-bottom:4px }
    .position-meaning{ font-size:.9rem;color:#6b7280;margin-bottom:10px; word-break: break-word; }
    .drawn-card{
      background:linear-gradient(135deg,rgba(142,108,136,.05),rgba(109,76,103,.05));
      border:1px solid rgba(142,108,136,.12);
      border-radius:12px;padding:10px;display:flex;gap:12px;align-items:center;
    }
    .card-image{
      width:62px;height:92px;border-radius:10px;overflow:hidden;flex:0 0 auto;
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
      display:flex;align-items:center;justify-content:center;color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .card-image img{ width:100%;height:100%;object-fit:cover;display:block }
    .card-image.reversed img{ transform:rotate(180deg) }
    .card-details{ flex:1 }
    .card-name{ font-weight:700 }
    .card-direction{ font-size:.88rem;color:var(--primary-color) }

    /* 右侧：聊天区 */
    .chat-container{ flex:1;display:flex;flex-direction:column;background:var(--chat-bg) }
    .messages-area{
      flex:1;overflow:auto;padding:18px; display:flex;flex-direction:column;gap:14px;scroll-behavior:smooth;
    }
    .messages-area::-webkit-scrollbar{ width:6px }
    .messages-area::-webkit-scrollbar-thumb{ background:rgba(142,108,136,.35); border-radius:3px }

    /* 初始骨架 */
    .loading-skeleton{ text-align:center;color:var(--accent-color);padding:30px 10px; opacity:.9; }

    /* 对话泡泡 */
    .message{ display:flex;gap:10px;max-width:820px;width:100%;animation:msgIn .28s ease-out }
    @keyframes msgIn{ from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .message.user{ flex-direction:row-reverse;align-self:flex-end }
    .message.assistant{ align-self:flex-start }
    .message-avatar{
      width:36px;height:36px;border-radius:50%; display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0;
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
    }
    .message.user .message-avatar{ background:var(--user-msg-bg) }
    .message-content{
      max-width:72%;padding:12px 16px;border-radius:18px;line-height:1.6;
      background:#fff;color:var(--dark-color);
      border-bottom-left-radius:6px;box-shadow:0 2px 10px rgba(0,0,0,.05);
      word-wrap:break-word;overflow-wrap:break-word; word-break: break-word;
    }
    .message.user .message-content{
      background:var(--user-msg-bg);color:#fff;border-bottom-right-radius:6px;border-bottom-left-radius:18px;
    }

    /* markdown 任务清单 */
    .message-content .task-list{ list-style:none; padding-left:0; margin:.8em 0; }
    .message-content .task-list li{ margin:.35em 0; }
    .message-content .task-list input[type="checkbox"]{
      margin-right:8px; transform:scale(1.05); vertical-align:middle; accent-color:var(--primary-color); pointer-events:none;
    }

    /* Markdown 样式 */
    .message-content h1{font-size:1.35rem;margin:1em 0 .5em;color:var(--accent-color);font-weight:800}
    .message-content h2{font-size:1.2rem;margin:.9em 0 .45em;color:var(--accent-color);font-weight:700}
    .message-content h3{font-size:1.06rem;margin:.7em 0 .35em;font-weight:700}
    .message-content p{margin:.8em 0}
    .message-content ul,.message-content ol{margin:.8em 0;padding-left:1.4em}
    .message-content li{margin:.35em 0}
    .message-content strong{font-weight:800;color:var(--accent-color)}
    .message.user .message-content strong{color:#fff}
    .message-content em{font-style:italic}
    .message-content del{opacity:.75;text-decoration:line-through}
    .message-content blockquote{
      margin:.8em 0;padding:.6em 1em;border-left:4px solid var(--primary-color);
      background:rgba(142,108,136,.06);border-radius:0 10px 10px 0;
    }
    .message-content hr{border:none;border-top:2px solid #e5e7eb;margin:1.2em 0}
    .message-content code{
      background:rgba(142,108,136,.12);padding:2px 6px;border-radius:6px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.92em;color:var(--accent-color);
    }
    .message-content pre{
      background:#f6f8fa;border:1px solid #e5e7eb;border-radius:10px;padding:14px;overflow:auto;margin:1em 0;
    }
    .message-content pre code{background:none;padding:0;color:inherit;font-size:.9em}

    /* markdown 表格 */
    .markdown-table{width:100%;border-collapse:collapse;margin:.9em 0;display:block;overflow:auto}
    .markdown-table td,.markdown-table th{border:1px solid #e1e4e8;padding:8px 12px;text-align:left}
    .markdown-table tr:nth-child(even){background:#f9fafb}
    .markdown-table th{background:rgba(142,108,136,.1);font-weight:700}

    /* 打字动画 */
    .typing-indicator{display:flex;gap:10px;align-items:center;max-width:820px;width:100%;align-self:flex-start}
    .typing-dots{display:flex;gap:4px;padding:14px;background:#fff;border-radius:18px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .typing-dot{width:8px;height:8px;border-radius:50%;background:#a1a1aa;animation:td 1.4s infinite}
    .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes td{0%,60%,100%{transform:translateY(0);opacity:.55}30%{transform:translateY(-8px);opacity:1}}

    /* 快速问题 */
    .quick-questions{
      display:flex;flex-wrap:wrap;gap:10px;justify-content:center;
      margin:8px auto 14px;max-width:820px;
    }
    .quick-question{
      background:#fff;border:1px solid #e5e7eb;border-radius:999px;
      padding:9px 16px;font-weight:600;font-size:.95rem;cursor:pointer; transition:.2s;user-select:none;
    }
    .quick-question:hover{
      background:var(--primary-color);color:#fff;transform:translateY(-2px);
      box-shadow:0 8px 18px rgba(142,108,136,.25);
    }

    /* 输入区 */
    .input-area{
      background:#fff;border-top:1px solid #eee;padding:16px 18px;
      box-shadow:0 -4px 12px rgba(0,0,0,.04); padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
    }
    .input-container{ display:flex;gap:12px;align-items:flex-end;max-width:820px;margin:0 auto }
    .message-input{
      flex:1;border:2px solid #e5e7eb;border-radius:20px;padding:12px 16px;
      resize:none;outline:none;transition:.2s;font-size:1rem;max-height:120px;font-family:inherit;
    }
    .message-input:focus{ border-color:var(--primary-color) }
    .send-button{
      width:48px;height:48px;border-radius:50%;border:none;cursor:pointer;
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
      color:#fff;display:flex;align-items:center;justify-content:center;
      box-shadow:0 10px 24px rgba(142,108,136,.35);transition:.2s;
    }
    .send-button:hover:not(:disabled){ transform:translateY(-2px) }
    .send-button:disabled{ opacity:.6;cursor:not-allowed }
    .limit-reached{
      background:rgba(239,68,68,.09);border:1px solid rgba(239,68,68,.28);
      color:#dc2626;border-radius:12px;padding:14px;text-align:center;font-weight:600;
    }

    /* 响应式 */
    @media (max-width:1024px){
      .spread-display{ position:absolute;left:0;top:0;bottom:0;z-index:4;width:320px }
      .spread-display.collapsed{ margin-left:-320px }
      .toggle-spread{ left:320px }
      .spread-display.collapsed + .toggle-spread{ left:0 }
    }
    @media (max-width:768px){
      .spread-info{ display:none }
      .message-content{ max-width:86% }
      .messages-area{ padding:14px }
    }

    /* 减少动态偏好 */
    @media (prefers-reduced-motion: reduce){
      .message, .typing-dot, .send-button, .toggle-spread { animation:none!important; transition:none!important; }
      .messages-area{ scroll-behavior:auto; }
    }
    /* =============== 统一主题 token（补齐） =============== */
:root{
  --bg-ivory: #f8f4e9;
  --ink: #333333;
  --muted: #7a707a;

  --card: #ffffff;
  --border: rgba(0,0,0,0.08);
  --shadow-sm: 0 4px 16px rgba(30,20,35,0.08);
  --shadow-md: 0 10px 28px rgba(30,20,35,0.12);
  --shadow-lg: 0 16px 44px rgba(30,20,35,0.16);

  --radius-lg: 18px;
  --radius-md: 14px;
  --radius-sm: 10px;
}

/* =============== 背景丝绒+星尘（与其它页一致） =============== */
body{
  background:
    radial-gradient(1000px 800px at 10% 0%, #fbf9f3 0%, rgba(251,249,243,0) 60%),
    radial-gradient(1200px 900px at 90% 10%, #f3ece1 0%, rgba(243,236,225,0) 60%),
    linear-gradient(135deg, #f8f4e9 0%, #efe7db 100%);
}
body::before{
  content:"";
  position:fixed; inset:0; pointer-events:none;
  /* 微星尘，高透明，不影响可读性 */
  background:
    radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.25) 0 40%, transparent 60%),
    radial-gradient(1.5px 1.5px at 70% 80%, rgba(255,255,255,.15) 0 40%, transparent 60%),
    radial-gradient(2px 2px at 40% 70%, rgba(255,255,255,.12) 0 40%, transparent 60%);
  opacity:.35; mix-blend-mode:screen;
  z-index:0;
}

/* =============== 通用玻璃态工具类 =============== */
.glass{
  background: rgba(255,255,255,0.82);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  backdrop-filter: blur(14px) saturate(140%);
  -webkit-backdrop-filter: blur(14px) saturate(140%);
}

/* =============== 顶部栏：纯白 → 玻璃 =============== */
.chat-header{
  background: rgba(255,255,255,0.82);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  backdrop-filter: blur(14px) saturate(140%);
  -webkit-backdrop-filter: blur(14px) saturate(140%);
}

/* =============== 左侧牌阵面板：纯白 → 玻璃 =============== */
.spread-display{
  background: rgba(255,255,255,0.78);
  border-right: 1px solid var(--border);
  box-shadow: var(--shadow-md);
  backdrop-filter: blur(14px) saturate(140%);
  -webkit-backdrop-filter: blur(14px) saturate(140%);
  position: relative;
  z-index: 1; /* 盖过星尘层，保证清晰 */
}

/* 展开/收起钮：做成玻璃胶囊 */
.toggle-spread{
  background: rgba(255,255,255,0.85);
  border-color: var(--border);
  box-shadow: var(--shadow-sm);
  backdrop-filter: blur(12px) saturate(140%);
  -webkit-backdrop-filter: blur(12px) saturate(140%);
}

/* 卡位条目：边框与悬浮更精致 */
.card-position{
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
}
.card-position:hover{
  transform: translateX(4px);
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
}

/* =============== 聊天区域的玻璃统一 =============== */
/* 快捷问题“胶囊”：玻璃 */
.quick-question{
  background: rgba(255,255,255,0.85);
  border: 1px solid var(--border);
  backdrop-filter: blur(10px) saturate(140%);
  -webkit-backdrop-filter: blur(10px) saturate(140%);
  box-shadow: var(--shadow-sm);
}

/* 打字泡泡也玻璃 */
.typing-dots{
  background: rgba(255,255,255,0.85);
  border: 1px solid var(--border);
  backdrop-filter: blur(10px) saturate(140%);
  -webkit-backdrop-filter: blur(10px) saturate(140%);
}

/* AI气泡保持纯白提高可读性（不透明度别降） */

/* =============== 输入区：纯白 → 玻璃 =============== */
.input-area{
  background: rgba(255,255,255,0.82);
  border-top: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  backdrop-filter: blur(14px) saturate(140%);
  -webkit-backdrop-filter: blur(14px) saturate(140%);
}

/* 输入框边框与圆角用 token */
.message-input{
  border: 2px solid var(--border);
  border-radius: 20px;
}

/* =============== “减少动态”兼容 =============== */
@media (prefers-reduced-motion: reduce){
  body::before{ opacity:.25; }
}

  </style>
</head>
<body>
  <!-- 顶部导航 -->
  <div class="chat-header">
    <a class="back-button" href="{{ url_for('spread') }}">
      <i class="fas fa-arrow-left"></i><span>返回</span>
    </a>

    <div class="spread-info">
      <div class="spread-icon"><i class="fas fa-layer-group"></i></div>
      <div class="spread-details">
        <div class="spread-name">{{ spread_config.name }}</div>
        <div class="spread-count">{{ spread_config.card_count }}张牌</div>
      </div>
    </div>

    <div class="chat-limit">剩余对话：<span class="count" id="remaining-count">{{ remaining_chats }}</span></div>
  </div>

  <!-- 主容器 -->
  <div class="main-container">
    <!-- 左侧：牌阵展示 -->
    <aside class="spread-display" id="spreadDisplay" aria-label="牌阵展示">
      <h2 class="spread-title">{{ spread_config.name }}</h2>

      {% if reading.question %}
      <div class="spread-question">
        <i class="fas fa-question-circle"></i>
        {{ reading.question }}
      </div>
      {% endif %}

      <div class="cards-layout">
        {% for card in reading.cards %}
        {% set pos = (spread_config.positions[loop.index0] if spread_config.positions|length > loop.index0 else None) %}
        <div class="card-position">
          <div class="position-number">{{ loop.index }}</div>
          <div class="position-info">
            <div class="position-name">{{ pos.name if pos else ('位置 ' ~ loop.index) }}</div>
            <div class="position-meaning">{{ pos.meaning if pos else '' }}</div>
            <div class="drawn-card">
              <div class="card-image {% if card.direction == '逆位' %}reversed{% endif %}">
                {% if card.image %}
                  <img src="{{ card.image }}" alt="{{ card.card_name }}" loading="lazy" />
                {% else %}
                  <i class="fas fa-star" aria-hidden="true"></i>
                {% endif %}
              </div>
              <div class="card-details">
                <div class="card-name">{{ card.card_name }}</div>
                <div class="card-direction">{{ card.direction }}</div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </aside>

    <!-- 左侧开合按钮（无内联事件） -->
    <button class="toggle-spread" id="toggleSpread" type="button" aria-controls="spreadDisplay" aria-expanded="true">
      <i class="fas fa-chevron-left" id="toggleIcon" aria-hidden="true"></i>
      <span class="sr-only" style="position:absolute;left:-9999px;">开合牌阵面板</span>
    </button>

    <!-- 右侧：聊天 -->
    <section class="chat-container" aria-label="聊天区域">
      <div class="messages-area" id="messages-area" aria-live="polite">
        {% if messages %}
          {% for msg in messages %}
          <div class="message {{ msg.role }}">
            <div class="message-avatar">
              {% if msg.role == 'user' %}
                <i class="fas fa-user"></i>
              {% else %}
                {% if ai_personality == 'mystic' %}
                  <i class="fas fa-moon"></i>
                {% elif ai_personality == 'wisdom' %}
                  <i class="fas fa-book"></i>
                {% else %}
                  <i class="fas fa-heart"></i>
                {% endif %}
              {% endif %}
            </div>
            <!-- 历史消息显式转义，前端再做 Markdown 渲染（assistant） -->
            <div class="message-content">{{ msg.content | e }}</div>
          </div>
          {% endfor %}

          <!-- 若已有历史消息，直接显示快捷问题（无内联事件） -->
          <div class="quick-questions" id="quick-questions">
            <button class="quick-question" type="button" data-q="这个牌阵的整体建议是什么？">整体建议</button>
            <button class="quick-question" type="button" data-q="我应该注意什么？">注意事项</button>
            <button class="quick-question" type="button" data-q="下一步该怎么做？">行动指南</button>
          </div>
        {% else %}
          <!-- 首次进入：骨架加载 -->
          <div class="loading-skeleton" id="loading-skeleton">
            <div class="fas fa-spinner fa-spin" style="font-size:2.2rem;margin-bottom:12px;" aria-hidden="true"></div>
            <div>正在连接牌阵能量，请稍候…</div>
          </div>
        {% endif %}
      </div>

      <div class="input-area">
        {% if can_chat %}
        <div class="input-container">
          <textarea class="message-input" id="message-input" rows="1" maxlength="500" placeholder="深入探讨这个牌阵…（Shift+Enter 换行）"></textarea>
          <button class="send-button" id="send-button" type="button" aria-label="发送消息"><i class="fas fa-paper-plane"></i></button>
        </div>
        {% else %}
        <div class="limit-reached">
          <i class="fas fa-moon"></i> 今日对话次数已用完，明天再来探索塔罗的奥秘吧
        </div>
        {% endif %}
      </div>
    </section>
  </div>

  <script>
    /* ===== iOS 100vh 修复 ===== */
    (function fixIOSVh(){
      const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
      setVh(); window.addEventListener('resize', setVh); window.addEventListener('orientationchange', setVh);
    })();

    /* ===== 模板变量 ===== */
    const readingId = "{{ reading.id }}";
    const hasHistory = {{ has_history|tojson }};
    const aiPersonality = "{{ ai_personality or 'warm' }}";
    let remainingChats = {{ remaining_chats }};
    let isTyping = false;

    /* ===== 工具：HTML 转义 & Markdown 格式化 ===== */
    function escapeHtml(text){
      const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
      return String(text||'').replace(/[&<>"']/g,m=>map[m]);
    }

    // 表格“挤成一行”的容错拆分：在提取代码块之后、escapeHtml 之前执行
    function normalizeCompactTables(s){
      s = s.replace(/\|\s*\|([ :\-|]{3,})\|\s*/g, '|\n|$1|\n');
      s = s.replace(/\s\|\s\|/g, '\n|');
      return s;
    }

    function formatAIMessage(content){
      let text = String(content || '').replace(/\r\n/g,'\n');

      // 0) 代码块
      const fences = [];
      text = text.replace(/```([a-zA-Z0-9_+\-]*)\n([\s\S]*?)```/g, (m, lang, body) => {
        const id = `__FENCE_${fences.length}__`;
        fences.push(`<pre><code class="language-${(lang||'plaintext').toLowerCase()}">${escapeHtml(body)}</code></pre>`);
        return id;
      });

      // 0.1) 表格容错
      text = normalizeCompactTables(text);

      // 1) 统一转义
      text = escapeHtml(text);

      // 2) 标题
      text = text.replace(/^\s*(#{1,6})[ \t\u00A0\u3000]+(.+)$/gm, (m, hs, t) => `<h${Math.min(hs.length,6)}>${t.trim()}</h${Math.min(hs.length,6)}>`);

      // 3) 水平线
      text = text.replace(/^\s*---+\s*$/gm, '<hr>');

      // 4) 多行引用
      text = text.replace(/(?:^|\n)(?:&gt;\s?.*(?:\n|$))+?/g, (block) => {
        const inner = block.replace(/(^|\n)&gt;\s?/g, '$1').trim();
        return `\n<blockquote>${inner.replace(/\n/g,'<br>')}</blockquote>\n`;
      });

      // 5) 行内代码
      text = text.replace(/`([^`]+)`/g, (m, code) => `<code>${code}</code>`);

      // 6) 强/斜体
      text = text
        .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/___(.+?)___/g, '<strong><em>$1</em></strong>')
        .replace(/__(.+?)__/g, '<strong>$1</strong>')
        .replace(/_(.+?)_/g, '<em>$1</em>');

      // 7) 链接
      text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer nofollow">$1</a>');

      // 8) 任务清单
      text = text.replace(/^\s*[-*+]\s+\[( |x|X)\]\s+(.+)$/gm,(m, chk, body)=>`<li data-task="1"><input type="checkbox" disabled ${/x/i.test(chk)?'checked':''}> ${body}</li>`);
      text = text.replace(/(?:^(?:<li data-task="1">.*<\/li>\n?)+)/gms, b => `<ul class="task-list">${b.replace(/ data-task="1"/g,'').trim()}</ul>\n`);

      // 9) 普通列表
      text = text
        .replace(/^\s*(\d+)\.\s+(.+)$/gm, (m, n, item) => `<li data-ol="1">${item}</li>`)
        .replace(/^\s*[-*+]\s+(.+)$/gm, (m, item) => `<li data-ul="1">${item}</li>`);
      text = text.replace(/(?:^(?:<li[^>]*>.*<\/li>\n?)+)/gms, block => {
        const isOl = /<li[^>]*data-ol="1"/.test(block) && !/<li[^>]*data-ul="1"/.test(block);
        const clean = block.replace(/ data-(ol|ul)="1"/g, '');
        return (isOl ? `<ol>${clean.trim()}</ol>` : `<ul>${clean.trim()}</ul>`) + '\n';
      });

      // 10) 表格
      text = text.replace(
        /(?:^|\n)\|([^\n|]+(?:\|[^\n|]+)+)\|\n\|([ :\-|]+)\|\n((?:\|[^\n|]+(?:\|[^\n|]+)+\|\n?)+)/g,
        (m, header, sep, rows) => {
          const ths = header.split('|').map(s => `<th>${s.trim()}</th>`).join('');
          const trs = rows.trim().split('\n').map(r => {
            const tds = r.replace(/^\||\|$/g,'').split('|').map(s => `<td>${s.trim()}</td>`).join('');
            return `<tr>${tds}</tr>`;
          }).join('');
          return `\n<table class="markdown-table"><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>\n`;
        }
      );

      // 11) 段落
      const parts = text.split(/\n{2,}/).map(seg => {
        const s = seg.trim();
        if (!s) return '';
        if (/^<(h\d|blockquote|hr|ul|ol|table|pre)/i.test(s)) return s;
        return `<p>${s.replace(/\n/g,'<br>')}</p>`;
      }).filter(Boolean);
      let html = parts.join('\n');

      // 12) 回填代码块
      fences.forEach((codeHtml, i) => { html = html.replace(`__FENCE_${i}__`, codeHtml); });

      // 13) 清理包裹
      html = html.replace(/<p><(h\d|blockquote|hr|ul|ol|table|pre)/g,'<$1')
                 .replace(/<\/(h\d|blockquote|hr|ul|ol|table|pre)><\/p>/g,'</$1>');

      return html;
    }

    /* ===== 初始化：格式化历史 / 首次触发与轮询 ===== */
    document.addEventListener('DOMContentLoaded', () => {
      // 绑定：左侧开合
      const toggleBtn = document.getElementById('toggleSpread');
      toggleBtn?.addEventListener('click', toggleSpreadDisplay);

      // 绑定：发送
      const sendBtn = document.getElementById('send-button');
      sendBtn?.addEventListener('click', sendMessage);

      // 绑定：快捷问题（事件委托）
      bindQuickQuestions();

      // 历史消息格式化（仅 assistant）
      if (hasHistory) {
        document.querySelectorAll('.message.assistant .message-content').forEach(el=>{
          const raw = el.textContent;
          el.innerHTML = formatAIMessage(raw);
        });
      } else {
        kickOffInitialOnce();
        pollInitialAndInsert();
      }

      // 输入区增强
      const input = document.getElementById('message-input');
      if (input) {
        input.addEventListener('input', function(){
          this.style.height='auto';
          this.style.height=Math.min(this.scrollHeight,120)+'px';
        });
        input.addEventListener('keydown', function(e){
          if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
      }
    });

    function bindQuickQuestions(){
      const box = document.getElementById('quick-questions');
      if (!box) return;
      box.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-q]');
        if (!btn) return;
        quickAsk(btn.getAttribute('data-q') || '');
      });
    }

    let _kicked=false;
    async function kickOffInitialOnce(){
      if(_kicked) return; _kicked=true;
      try{
        await fetch('/api/spread/generate_initial',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({reading_id:readingId}),
          cache:'no-store'
        });
      }catch(e){ console.warn('kickOffInitial failed',e); }
    }

    let _inserted=false;
    async function pollInitialAndInsert(){
      const messagesArea=document.getElementById('messages-area');
      const loading=document.getElementById('loading-skeleton');
      const maxTries=25; let tries=0;

      const timer=setInterval(async ()=>{
        tries++;
        try{
          const r=await fetch(`/api/spread/status/${encodeURIComponent(readingId)}?t=${Date.now()}`,{cache:'no-store'});
          if(!r.ok) throw new Error('status not ok');
          const s=await r.json();

          if(s.has_initial||s.status==='ready'){
            clearInterval(timer);
            if(!_inserted && s.initial_text){
              loading?.remove();
              appendMessage('assistant', s.initial_text, true);
              showQuickQuestions(); _inserted=true;
            }
            return;
          }
          if(!_inserted && s.message_count>0 && s.initial_text){
            loading?.remove();
            appendMessage('assistant', s.initial_text, true);
            showQuickQuestions(); _inserted=true;
          }
          if(tries>=maxTries && !_inserted){
            clearInterval(timer);
            loading?.remove();
            appendMessage('assistant', '服务器有点忙，我还在连接牌阵的能量…稍后也可以再点我继续聊～', true);
          }
        }catch(e){
          console.warn('poll status failed',e);
          if(tries>=maxTries && !_inserted){
            clearInterval(timer);
            loading?.remove();
            appendMessage('assistant','网络有些不稳，稍后再试试或刷新页面。',true);
          }
        }
      },1000);
    }

    /* ===== UI 操作 ===== */
    function toggleSpreadDisplay(){
      const panel=document.getElementById('spreadDisplay');
      const icon=document.getElementById('toggleIcon');
      const btn=document.getElementById('toggleSpread');
      panel.classList.toggle('collapsed');
      const collapsed = panel.classList.contains('collapsed');
      icon.className = collapsed ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
      btn.setAttribute('aria-expanded', String(!collapsed));
    }

    function showQuickQuestions(){
      if(document.getElementById('quick-questions')) return;
      const messagesArea=document.getElementById('messages-area');
      const box=document.createElement('div');
      box.className='quick-questions';
      box.id='quick-questions';
      box.innerHTML=`
        <button class="quick-question" type="button" data-q="这个牌阵的整体建议是什么？">整体建议</button>
        <button class="quick-question" type="button" data-q="我应该注意什么？">注意事项</button>
        <button class="quick-question" type="button" data-q="下一步该怎么做？">行动指南</button>
      `;
      messagesArea.appendChild(box);
      messagesArea.scrollTop=messagesArea.scrollHeight;
      bindQuickQuestions(); // 事件委托（首次插入时绑定）
    }

    function quickAsk(q){
      const input=document.getElementById('message-input');
      if(input){ input.value=q; sendMessage(); }
    }

    /* ===== 对话：插入/打字动画/发送 ===== */
    function personaIcon(){
      if(aiPersonality==='mystic') return '<i class="fas fa-moon"></i>';
      if(aiPersonality==='wisdom') return '<i class="fas fa-book"></i>';
      return '<i class="fas fa-heart"></i>';
    }

    function appendMessage(role, content, shouldFormat){
      const area = document.getElementById('messages-area');
      const quick = area.querySelector('.quick-questions');
      if (quick && role === 'user') quick.remove();

      const wrap = document.createElement('div'); wrap.className = `message ${role}`;
      const avatar = document.createElement('div'); avatar.className = 'message-avatar';
      avatar.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : personaIcon();

      const cont = document.createElement('div'); cont.className = 'message-content';
      if (role === 'assistant') {
        cont.innerHTML = shouldFormat ? formatAIMessage(content) : escapeHtml(String(content||'')); 
      } else {
        cont.textContent = String(content || '');
      }
      wrap.appendChild(avatar); wrap.appendChild(cont); area.appendChild(wrap);

      setTimeout(()=>{ area.scrollTop = area.scrollHeight; }, 50);
    }

    function showTyping(){
      const area=document.getElementById('messages-area');
      const typing=document.createElement('div');
      typing.id='typing-indicator'; typing.className='message assistant typing-indicator';
      typing.innerHTML=`<div class="message-avatar">${personaIcon()}</div>
        <div class="typing-dots">
          <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
        </div>`;
      area.appendChild(typing); area.scrollTop=area.scrollHeight;
    }

    function hideTyping(){
      const t=document.getElementById('typing-indicator'); if(t) t.remove();
    }

    async function sendMessage(){
      const input=document.getElementById('message-input');
      const msg=(input?.value||'').trim(); if(!msg || isTyping) return;
      input.value=''; input.style.height='auto';
      appendMessage('user', msg, false);
      showTyping(); isTyping=true;

      try{
        const r=await fetch('/api/spread/chat/send',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({reading_id:readingId,message:msg}),
          cache:'no-store'
        });
        const data=await r.json();
        hideTyping(); isTyping=false;
        appendMessage('assistant', data.reply || '让我再感应一下…', true);
        if(typeof data.remaining==='number'){
          remainingChats=data.remaining;
          const el=document.getElementById('remaining-count'); if(el) el.textContent=remainingChats;
        }
        if(data.limit_reached){ disableInput(); }
      }catch(e){
        console.error(e);
        hideTyping(); isTyping=false;
        appendMessage('assistant','抱歉，网络有点卡，请稍后再试。',true);
      }
    }

    function disableInput(){
      const box=document.querySelector('.input-area');
      if(box){
        box.innerHTML=`<div class="limit-reached"><i class="fas fa-moon"></i> 今日对话次数已用完，明天再来探索塔罗的奥秘吧</div>`;
      }
    }
  </script>
</body>
</html>
