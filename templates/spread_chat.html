<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ spread_config.name }} - 塔罗占卜</title>

        <!-- 本地化资源 -->
        <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">

        <style>
                :root {
                        --primary-color: #8e6c88;
                        --secondary-color: #d1bfa7;
                        --accent-color: #6d4c67;
                        --light-color: #f8f4e9;
                        --dark-color: #333333;
                        --chat-bg: #f5f3f0;
                        --user-msg-bg: #8e6c88;
                        --ai-msg-bg: #ffffff;
                }

                body {
                        background: linear-gradient(135deg, #f8f4e9 0%, #e8e0d1 100%);
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        height: 100vh;
                        margin: 0;
                        display: flex;
                        flex-direction: column;
                }

                /* 顶部导航栏 */
                .chat-header {
                        background: white;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        padding: 15px 20px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                }

                .back-button {
                        color: var(--accent-color);
                        text-decoration: none;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.3s;
                }

                .back-button:hover {
                        color: var(--primary-color);
                        transform: translateX(-3px);
                }

                .spread-info {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                }

                .spread-icon {
                        width: 40px;
                        height: 40px;
                        background: linear-gradient(135deg, var(--secondary-color), #c0a58d);
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                        color: var(--accent-color);
                }

                .spread-details {
                        text-align: center;
                }

                .spread-name {
                        font-weight: 600;
                        color: var(--accent-color);
                        margin-bottom: 2px;
                }

                .spread-count {
                        font-size: 0.9rem;
                        color: #666;
                }

                .chat-limit {
                        background: var(--light-color);
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-size: 0.9rem;
                        color: var(--accent-color);
                }

                .chat-limit .count {
                        font-weight: 600;
                        color: var(--primary-color);
                }

                /* 主容器 */
                .main-container {
                        flex: 1;
                        display: flex;
                        overflow: hidden;
                        position: relative;
                }

                /* 牌阵展示区 */
                .spread-display {
                        width: 380px;
                        background: white;
                        box-shadow: 2px 0 10px rgba(0,0,0,0.05);
                        overflow-y: auto;
                        padding: 30px;
                        transition: margin-left 0.3s;
                }

                .spread-display.collapsed {
                        margin-left: -380px;
                }

                .toggle-spread {
                        position: absolute;
                        left: 380px;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 30px;
                        height: 60px;
                        background: white;
                        border: 1px solid #e0e0e0;
                        border-left: none;
                        border-radius: 0 10px 10px 0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.3s;
                        z-index: 10;
                }

                .toggle-spread:hover {
                        background: var(--light-color);
                }

                .spread-display.collapsed + .toggle-spread {
                        left: 0;
                }

                /* 牌阵标题 */
                .spread-title {
                        font-size: 1.5rem;
                        color: var(--accent-color);
                        margin-bottom: 10px;
                        text-align: center;
                }

                .spread-question {
                        background: rgba(142, 108, 136, 0.05);
                        padding: 15px;
                        border-radius: 10px;
                        margin-bottom: 25px;
                        text-align: center;
                        color: #666;
                }

                /* 牌阵布局可视化 */
                .cards-layout {
                        margin-bottom: 30px;
                }

                .card-position {
                        background: white;
                        border: 2px solid var(--secondary-color);
                        border-radius: 15px;
                        padding: 20px;
                        margin-bottom: 20px;
                        transition: all 0.3s;
                        position: relative;
                        overflow: hidden;
                }

                .card-position:hover {
                        border-color: var(--primary-color);
                        transform: translateX(5px);
                }

                .position-number {
                        position: absolute;
                        top: 10px;
                        left: 15px;
                        width: 30px;
                        height: 30px;
                        background: var(--primary-color);
                        color: white;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 600;
                        font-size: 0.9rem;
                }

                .position-info {
                        margin-left: 40px;
                }

                .position-name {
                        font-weight: 600;
                        color: var(--accent-color);
                        margin-bottom: 5px;
                }

                .position-meaning {
                        font-size: 0.85rem;
                        color: #666;
                        margin-bottom: 10px;
                }

                .drawn-card {
                        background: linear-gradient(135deg, rgba(142,108,136,0.05), rgba(109,76,103,0.05));
                        padding: 12px;
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                }

                .card-image {
                        width: 60px;
                        height: 90px;
                        border-radius: 8px;
                        overflow: hidden;
                        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                        position: relative;
                        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                        display: flex;
                        align-items: center;
                        justify-content: center;
                }

                .card-image img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        display: block;
                }

                .card-image.reversed img {
                        transform: rotate(180deg);
                }

                .card-image .placeholder-icon {
                        color: white;
                        font-size: 1.5rem;
                }

                .card-details { flex: 1; }

                .card-name {
                        font-weight: 600;
                        color: var(--dark-color);
                        margin-bottom: 2px;
                }

                .card-direction {
                        font-size: 0.85rem;
                        color: var(--primary-color);
                }

                /* 聊天区域 */
                .chat-container {
                        flex: 1;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        background: var(--chat-bg);
                }

                /* 消息区域 */
                .messages-area {
                        flex: 1;
                        overflow-y: auto;
                        padding: 20px;
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                        scroll-behavior: smooth;
                }

                .messages-area::-webkit-scrollbar { width: 6px; }
                .messages-area::-webkit-scrollbar-track { background: transparent; }
                .messages-area::-webkit-scrollbar-thumb {
                        background: rgba(142, 108, 136, 0.3);
                        border-radius: 3px;
                }
                .messages-area::-webkit-scrollbar-thumb:hover { background: rgba(142, 108, 136, 0.5); }

                /* 初始解读卡片（无历史时的骨架） */
                .loading-skeleton {
                        text-align: center;
                        padding: 40px;
                        color: var(--accent-color);
                }

                /* 消息气泡 */
                .message {
                        display: flex;
                        gap: 10px;
                        animation: messageSlide 0.3s ease-out;
                        max-width: 800px;
                        width: 100%;
                }

                @keyframes messageSlide {
                        from { opacity: 0; transform: translateY(10px); }
                        to   { opacity: 1; transform: translateY(0); }
                }

                .message.user { flex-direction: row-reverse; align-self: flex-end; }
                .message.assistant { align-self: flex-start; }

                .message-avatar {
                        width: 36px; height: 36px; border-radius: 50%;
                        display: flex; align-items: center; justify-content: center;
                        font-size: 1rem; color: white; flex-shrink: 0;
                }

                .user .message-avatar { background: var(--user-msg-bg); }
                .assistant .message-avatar { background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); }

                .message-content {
                        max-width: 70%;
                        padding: 12px 18px;
                        border-radius: 18px;
                        line-height: 1.5;
                }

                .user .message-content {
                        background: var(--user-msg-bg);
                        color: white;
                        border-bottom-right-radius: 4px;
                }

                .assistant .message-content {
                        background: var(--ai-msg-bg);
                        color: var(--dark-color);
                        border-bottom-left-radius: 4px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                }

                /* Markdown/富文本 */
                .message-content p { margin: 0.8em 0; line-height: 1.6; }
                .message-content p:first-child { margin-top: 0; }
                .message-content p:last-child { margin-bottom: 0; }
                .message-content ul, .message-content ol { margin: 0.8em 0; padding-left: 1.5em; }
                .message-content li { margin: 0.4em 0; line-height: 1.5; }
                .message-content strong { font-weight: 600; color: var(--accent-color); }
                .user .message-content strong { color: white; font-weight: 700; }
                .message-content h1 { font-size: 1.5rem; margin: 1em 0 0.5em; color: var(--accent-color); font-weight: 700; }
                .message-content h2 { font-size: 1.3rem; margin: 1em 0 0.5em; color: var(--accent-color); font-weight: 600; }
                .message-content h3 { font-size: 1.1rem; margin: 0.8em 0 0.4em; color: var(--dark-color); font-weight: 600; }
                .message-content h4 { font-size: 1rem; margin: 0.6em 0 0.3em; color: var(--dark-color); font-weight: 600; }
                .message-content h5, .message-content h6 { font-size: 0.9rem; margin: 0.5em 0 0.2em; color: #666; font-weight: 500; }
                .message-content code {
                        background: rgba(142, 108, 136, 0.1);
                        padding: 2px 6px; border-radius: 4px;
                        font-family: 'Consolas','Monaco','Courier New', monospace;
                        font-size: 0.9em; color: var(--accent-color);
                }
                .message-content pre {
                        background: #f6f8fa; border: 1px solid #e1e4e8;
                        border-radius: 8px; padding: 16px; overflow-x: auto; margin: 1em 0;
                }
                .message-content pre code { background: none; padding: 0; color: inherit; font-size: 0.875em; line-height: 1.5; }
                .message-content blockquote {
                        margin: 0.8em 0; padding: 0.5em 1em;
                        border-left: 4px solid var(--primary-color);
                        background: rgba(142, 108, 136, 0.05);
                        font-style: italic; border-radius: 0 8px 8px 0;
                }
                .message-content hr { margin: 1.5em 0; border: none; border-top: 2px solid #e1e4e8; }
                .message-content del { text-decoration: line-through; opacity: 0.7; }
                .message-content em { font-style: italic; }

                .message-content .markdown-table { width: 100%; border-collapse: collapse; margin: 1em 0; overflow-x: auto; display: block; }
                .message-content .markdown-table td, .message-content .markdown-table th { border: 1px solid #e1e4e8; padding: 8px 12px; text-align: left; }
                .message-content .markdown-table tr:nth-child(even) { background: #f6f8fa; }
                .message-content .markdown-table th { background: rgba(142,108,136,0.1); font-weight: 600; }

                /* 快速问题 */
                .quick-questions {
                        display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
                        margin: 20px auto; max-width: 800px;
                }
                .quick-question {
                        background: white; padding: 10px 20px; border-radius: 20px;
                        cursor: pointer; transition: all 0.3s; border: 1px solid #e0e0e0;
                        font-size: 0.95rem;
                }
                .quick-question:hover {
                        background: var(--primary-color); color: white; transform: translateY(-2px);
                        box-shadow: 0 5px 15px rgba(142,108,136,0.3);
                }

                /* 打字动画 */
                .typing-indicator {
                        display: flex; gap: 10px; align-items: center; max-width: 800px; width: 100%; align-self: flex-start;
                }
                .typing-dots {
                        display: flex; gap: 4px; padding: 15px; background: white; border-radius: 18px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                }
                .typing-dot {
                        width: 8px; height: 8px; background: #999; border-radius: 50%;
                        animation: typingDot 1.4s infinite;
                }
                .typing-dot:nth-child(2) { animation-delay: 0.2s; }
                .typing-dot:nth-child(3) { animation-delay: 0.4s; }
                @keyframes typingDot {
                        0%,60%,100% { transform: translateY(0); opacity: 0.5; }
                        30% { transform: translateY(-10px); opacity: 1; }
                }

                /* 输入区域 */
                .input-area {
                        background: white; border-top: 1px solid #e0e0e0; padding: 20px;
                        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
                }
                .input-container {
                        display: flex; gap: 12px; align-items: flex-end; max-width: 800px; margin: 0 auto;
                }
                .message-input {
                        flex: 1; border: 2px solid #e0e0e0; border-radius: 24px; padding: 12px 20px;
                        resize: none; outline: none; font-size: 1rem; transition: all 0.3s; max-height: 120px; font-family: inherit;
                }
                .message-input:focus { border-color: var(--primary-color); }
                .send-button {
                        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                        color: white; border: none; width: 48px; height: 48px; border-radius: 50%;
                        display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s;
                        box-shadow: 0 4px 15px rgba(142,108,136,0.3);
                }
                .send-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(142,108,136,0.4); }
                .send-button:disabled { opacity: 0.6; cursor: not-allowed; }

                /* 限制提示 */
                .limit-reached {
                        background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
                        padding: 15px; border-radius: 12px; text-align: center; color: #dc2626;
                }

                /* 响应式 */
                @media (max-width: 1024px) {
                        .spread-display { position: absolute; left: 0; top: 0; bottom: 0; z-index: 100; width: 320px; }
                        .spread-display.collapsed { margin-left: -320px; }
                        .toggle-spread { left: 320px; }
                        .spread-display.collapsed + .toggle-spread { left: 0; }
                }
                @media (max-width: 768px) {
                        .spread-info { display: none; }
                        .message-content { max-width: 85%; }
                        .quick-questions { padding: 0 10px; }
                        .messages-area { padding: 15px; }
                }
        </style>
</head>
<body>
        <!-- 顶部导航 -->
        <div class="chat-header">
                <a href="{{ url_for('spread') }}" class="back-button">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回</span>
                </a>

                <div class="spread-info">
                        <div class="spread-icon"><i class="fas fa-layer-group"></i></div>
                        <div class="spread-details">
                                <div class="spread-name">{{ spread_config.name }}</div>
                                <div class="spread-count">{{ spread_config.card_count }}张牌</div>
                        </div>
                </div>

                <div class="chat-limit">
                        剩余对话: <span class="count" id="remaining-count">{{ remaining_chats }}</span>
                </div>
        </div>

        <!-- 主容器 -->
        <div class="main-container">
                <!-- 牌阵展示区 -->
                <div class="spread-display" id="spreadDisplay">
                        <h2 class="spread-title">{{ spread_config.name }}</h2>

                        {% if reading.question %}
                        <div class="spread-question">
                                <i class="fas fa-question-circle"></i> {{ reading.question }}
                        </div>
                        {% endif %}

                        <div class="cards-layout">
                                {% for card in reading.cards %}
                                <div class="card-position">
                                        <div class="position-number">{{ loop.index }}</div>
                                        <div class="position-info">
                                                <div class="position-name">{{ spread_config.positions[loop.index0].name }}</div>
                                                <div class="position-meaning">{{ spread_config.positions[loop.index0].meaning }}</div>
                                                <div class="drawn-card">
                                                        <div class="card-image {% if card.direction == '逆位' %}reversed{% endif %}">
                                                                {% if card.image %}
                                                                        <img src="{{ card.image }}" alt="{{ card.card_name }}">
                                                                {% else %}
                                                                        <i class="fas fa-star placeholder-icon"></i>
                                                                {% endif %}
                                                        </div>
                                                        <div class="card-details">
                                                                <div class="card-name">{{ card.card_name }}</div>
                                                                <div class="card-direction">{{ card.direction }}</div>
                                                        </div>
                                                </div>
                                        </div>
                                </div>
                                {% endfor %}
                        </div>
                </div>

                <!-- 折叠按钮 -->
                <div class="toggle-spread" id="toggleSpread" onclick="toggleSpreadDisplay()">
                        <i class="fas fa-chevron-left" id="toggleIcon"></i>
                </div>

                <!-- 聊天容器 -->
                <div class="chat-container">
                        <div class="messages-area" id="messages-area">
                                {% if messages %}
                                        {% for msg in messages %}
                                        <div class="message {{ msg.role }}">
                                                <div class="message-avatar">
                                                        {% if msg.role == 'user' %}
                                                                <i class="fas fa-user"></i>
                                                        {% else %}
                                                                {% if ai_personality == 'mystic' %}
                                                                        <i class="fas fa-moon"></i>
                                                                {% elif ai_personality == 'wisdom' %}
                                                                        <i class="fas fa-book"></i>
                                                                {% else %}
                                                                        <i class="fas fa-heart"></i>
                                                                {% endif %}
                                                        {% endif %}
                                                </div>
                                                <div class="message-content">{{ msg.content }}</div>
                                        </div>
                                        {% endfor %}
                                {% else %}
                                        <div class="loading-skeleton" id="loading-skeleton">
                                                <div class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 20px;"></div>
                                                <div>正在解读牌阵能量，请稍候...</div>
                                        </div>
                                {% endif %}

                                {% if messages %}
                                <div class="quick-questions">
                                        <div class="quick-question" onclick="quickAsk('这个牌阵的整体建议是什么？')">整体建议</div>
                                        <div class="quick-question" onclick="quickAsk('我应该注意什么？')">注意事项</div>
                                        <div class="quick-question" onclick="quickAsk('下一步该怎么做？')">行动指南</div>
                                </div>
                                {% endif %}
                        </div>

                        <!-- 输入区域 -->
                        <div class="input-area">
                                {% if can_chat %}
                                <div class="input-container">
                                        <textarea class="message-input" id="message-input" placeholder="深入探讨这个牌阵..." rows="1" maxlength="500"></textarea>
                                        <button class="send-button" id="send-button" onclick="sendMessage()">
                                                <i class="fas fa-paper-plane"></i>
                                        </button>
                                </div>
                                {% else %}
                                <div class="limit-reached">
                                        <i class="fas fa-moon"></i> 今日对话次数已用完，明天再来探索塔罗的奥秘吧
                                </div>
                                {% endif %}
                        </div>
                </div>
        </div>

        <script>
                // ===== 模板变量 =====
                const readingId = "{{ reading.id }}";
                const hasHistory = {{ has_history|tojson }};
                const aiPersonality = "{{ ai_personality }}";
                let isTyping = false;
                let remainingChats = {{ remaining_chats }};

                // ===== 工具函数 =====
                function escapeHtml(text) {
                        const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
                        return String(text).replace(/[&<>"']/g, m => map[m]);
                }

                function formatAIMessage(content) {
                        let text = String(content || "")
                                .replace(/[\u00A0\u2007\u202F\u3000]/g, " ")
                                .replace(/\r\n/g, "\n");

                        const codeBlocks = [];
                        text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (m, lang, code) => {
                                const id = `__CODE_BLOCK_${codeBlocks.length}__`;
                                codeBlocks.push(`<pre><code class="language-${lang || 'plaintext'}">${escapeHtml(code.trim())}</code></pre>`);
                                return id;
                        });

                        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
                        text = text.replace(/^\s*(#{1,6})[ \t\u00A0\u3000]+(.+)$/gm, (m, hashes, title) => {
                                const level = Math.min(hashes.length, 6);
                                return `<h${level}>${title.trim()}</h${level}>`;
                        });
                        text = text.replace(/^\s*>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
                        text = text.replace(/^\s*---+\s*$/gm, '<hr>');
                        text = text.replace(/^\s*\d+\.\s+(.+)$/gm, '<li>$1</li>');
                        text = text.replace(/^\s*[-*+]\s+(.+)$/gm, '<li>$1</li>');
                        text = text.replace(/(?:^(?:<li>.*<\/li>\n?)+)/gms, (block) => {
                                const raw = block.replace(/<li>|<\/li>/g, '');
                                const isOrdered = /^\s*\d+\.\s+/m.test(raw);
                                return isOrdered ? `<ol>${block.trim()}</ol>\n` : `<ul>${block.trim()}</ul>\n`;
                        });
                        text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
                                   .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                                   .replace(/\*(.+?)\*/g, '<em>$1</em>')
                                   .replace(/___(.+?)___/g, '<strong><em>$1</em></strong>')
                                   .replace(/__(.+?)__/g, '<strong>$1</strong>')
                                   .replace(/_(.+?)_/g, '<em>$1</em>')
                                   .replace(/~~(.+?)~~/g, '<del>$1</del>');
                        text = text.replace(/\|(.+)\|/g, (match, inner) => {
                                if (/^[\s\-:|]+$/.test(inner)) return match;
                                const cells = inner.split('|').map(c => c.trim());
                                return `<tr>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`;
                        });
                        text = text.replace(/(<tr>[\s\S]*?<\/tr>)+/g, (m) => `<table class="markdown-table">${m}</table>`);

                        text = text.split(/\n{2,}/).map(seg => {
                                const s = seg.trim();
                                if (!s) return '';
                                if (/^<(h\d|blockquote|hr|ul|ol|table|pre|code)/i.test(s)) return s;
                                if (s.startsWith('__CODE_BLOCK_')) return s;
                                return `<p>${s.replace(/\n/g, '<br>')}</p>`;
                        }).filter(Boolean).join('\n');

                        codeBlocks.forEach((html, i) => text = text.replace(`__CODE_BLOCK_${i}__`, html));
                        text = text.replace(/<p><(h\d|ul|ol|table|blockquote|hr)/g, '<$1').replace(/<\/(h\d|ul|ol|table|blockquote|hr)><\/p>/g, '</$1>');
                        return text;
                }

                // ===== 初始化 =====
                document.addEventListener('DOMContentLoaded', () => {
                        // 历史消息格式化
                        if (hasHistory) {
                                document.querySelectorAll('.message.assistant .message-content').forEach(el => {
                                        const original = el.textContent;
                                        el.innerHTML = formatAIMessage(original);
                                });
                        } else {
                                // 无历史 => 触发生成并轮询
                                kickOffInitial();
                                pollInitial();
                        }

                        // 输入框自适应 + 回车发送
                        const input = document.getElementById('message-input');
                        if (input) {
                                input.addEventListener('input', function() {
                                        this.style.height = 'auto';
                                        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                                });
                                input.addEventListener('keydown', function(e) {
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                                e.preventDefault();
                                                sendMessage();
                                        }
                                });
                        }
                });

                // ===== 初始解读：触发 + 轮询 =====
                async function kickOffInitial() {
                        try {
                                await fetch('/api/spread/generate_initial', {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify({ reading_id: readingId })
                                });
                        } catch (e) {
                                console.warn('kickOffInitial failed', e);
                        }
                }

                function pollInitial() {
                        const maxTries = 20; // 可根据 Dify 时延调大到 25~30
                        let tries = 0;
                        const timer = setInterval(async () => {
                                try {
                                        tries++;
                                        const r = await fetch(`/api/spread/status/${encodeURIComponent(readingId)}`, { cache: 'no-store' });
                                        if (!r.ok) throw new Error('status not ok');
                                        const s = await r.json();
                                        if (s.has_initial || s.status === 'ready') {
                                                clearInterval(timer);
                                                // 直接刷新拿历史消息（也可改成前端插入 s.initial_text）
                                                location.reload();
                                                return;
                                        }
                                        if (tries >= maxTries) {
                                                clearInterval(timer);
                                                location.reload();
                                        }
                                } catch (e) {
                                        console.warn('poll status failed:', e);
                                        if (tries >= maxTries) {
                                                clearInterval(timer);
                                                location.reload();
                                        }
                                }
                        }, 1000);
                }

                // ===== UI 交互 / 消息流 =====
                function toggleSpreadDisplay() {
                        const display = document.getElementById('spreadDisplay');
                        const icon = document.getElementById('toggleIcon');
                        display.classList.toggle('collapsed');
                        icon.className = display.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
                }

                function quickAsk(q) {
                        const input = document.getElementById('message-input');
                        if (!input) return;
                        input.value = q;
                        sendMessage();
                }

                function appendMessage(role, content, animate = true) {
                        const area = document.getElementById('messages-area');
                        const quick = area.querySelector('.quick-questions');
                        if (quick && role === 'user') quick.remove();

                        const wrap = document.createElement('div');
                        wrap.className = `message ${role}`;
                        if (animate) wrap.style.animation = 'messageSlide 0.3s ease-out';

                        const avatar = document.createElement('div');
                        avatar.className = 'message-avatar';
                        if (role === 'user') {
                                avatar.innerHTML = '<i class="fas fa-user"></i>';
                        } else {
                                const icons = { mystic:'<i class="fas fa-moon"></i>', wisdom:'<i class="fas fa-book"></i>', warm:'<i class="fas fa-heart"></i>' };
                                avatar.innerHTML = icons[aiPersonality] || '<i class="fas fa-sparkles"></i>';
                        }

                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'message-content';
                        if (role === 'assistant') contentDiv.innerHTML = formatAIMessage(content);
                        else contentDiv.textContent = content;

                        wrap.appendChild(avatar);
                        wrap.appendChild(contentDiv);
                        area.appendChild(wrap);

                        setTimeout(() => { area.scrollTop = area.scrollHeight; }, 100);
                }

                function showTyping() {
                        const area = document.getElementById('messages-area');
                        const icons = { mystic:'<i class="fas fa-moon"></i>', wisdom:'<i class="fas fa-book"></i>', warm:'<i class="fas fa-heart"></i>' };
                        const typing = document.createElement('div');
                        typing.id = 'typing-indicator';
                        typing.className = 'message assistant typing-indicator';
                        typing.innerHTML = `
                                <div class="message-avatar">${icons[aiPersonality] || '<i class="fas fa-sparkles"></i>'}</div>
                                <div class="typing-dots">
                                        <div class="typing-dot"></div>
                                        <div class="typing-dot"></div>
                                        <div class="typing-dot"></div>
                                </div>`;
                        area.appendChild(typing);
                        area.scrollTop = area.scrollHeight;
                }

                function hideTyping() {
                        const el = document.getElementById('typing-indicator');
                        if (el) el.remove();
                }

                function disableInput() {
                        const inputArea = document.querySelector('.input-area');
                        inputArea.innerHTML = `
                                <div class="limit-reached">
                                        <i class="fas fa-moon"></i> 今日对话次数已用完，明天再来探索塔罗的奥秘吧
                                </div>`;
                }

                async function sendMessage() {
                        const input = document.getElementById('message-input');
                        const msg = (input?.value || '').trim();
                        if (!msg || isTyping) return;

                        input.value = '';
                        input.style.height = 'auto';
                        appendMessage('user', msg);

                        showTyping(); isTyping = true;

                        try {
                                const r = await fetch('/api/spread/chat/send', {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify({ reading_id: readingId, message: msg })
                                });
                                const data = await r.json();
                                hideTyping(); isTyping = false;

                                appendMessage('assistant', data.reply || '让我想想…');

                                if (typeof data.remaining !== 'undefined') {
                                        remainingChats = data.remaining;
                                        const el = document.getElementById('remaining-count');
                                        if (el) el.textContent = remainingChats;
                                }
                                if (data.limit_reached) disableInput();
                        } catch (e) {
                                console.error('send failed', e);
                                hideTyping(); isTyping = false;
                                appendMessage('assistant', '抱歉，消息发送失败，请稍后重试。');
                        }
                }
        </script>
</body>
</html>
