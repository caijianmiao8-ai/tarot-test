<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ spread_config.name }} - 塔罗占卜</title>

        <!-- 本地化资源 -->
        <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}" />
        <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}" />

        <style>
                :root{
                        --primary-color:#8e6c88;
                        --secondary-color:#d1bfa7;
                        --accent-color:#6d4c67;
                        --light-color:#f8f4e9;
                        --dark-color:#333333;
                        --chat-bg:#f5f3f0;
                        --user-msg-bg:#8e6c88;
                        --ai-msg-bg:#ffffff;
                }
                html,body{
                        height:100%;
                }
                body{
                        background:linear-gradient(135deg,#f8f4e9 0%,#efe7db 100%);
                        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                        margin:0;
                        display:flex;
                        flex-direction:column;
                        color:var(--dark-color);
                        -webkit-font-smoothing:antialiased;
                }
                /* 顶部栏 */
                .chat-header{
                        background:#fff;
                        box-shadow:0 2px 10px rgba(0,0,0,.08);
                        padding:14px 20px;
                        display:flex;
                        align-items:center;
                        justify-content:space-between;
                        position:sticky;
                        top:0;
                        z-index:5;
                }
                .back-button{
                        color:var(--accent-color);
                        text-decoration:none;
                        display:flex;
                        align-items:center;
                        gap:8px;
                        transition:.25s ease;
                        font-weight:600;
                }
                .back-button:hover{
                        color:var(--primary-color);
                        transform:translateX(-2px);
                }
                .spread-info{
                        display:flex;
                        align-items:center;
                        gap:14px;
                }
                .spread-icon{
                        width:40px;height:40px;border-radius:12px;
                        display:flex;align-items:center;justify-content:center;
                        background:linear-gradient(135deg,var(--secondary-color),#c6ac92);
                        color:#6a4c45;
                        box-shadow:0 4px 14px rgba(0,0,0,.12);
                }
                .spread-details{
                        text-align:center;
                }
                .spread-name{
                        font-weight:700;color:var(--accent-color);letter-spacing:.2px;margin:0;
                }
                .spread-count{
                        font-size:.9rem;color:#6b7280;margin-top:2px;
                }
                .chat-limit{
                        background:rgba(142,108,136,.08);
                        color:var(--accent-color);
                        border:1px solid rgba(142,108,136,.18);
                        padding:6px 12px;border-radius:999px;
                        font-weight:600;font-size:.92rem;
                }
                .chat-limit .count{color:var(--primary-color)}

                /* 主布局 */
                .main-container{
                        flex:1;display:flex;overflow:hidden;position:relative;
                }

                /* 左侧：牌阵展示 */
                .spread-display{
                        width:380px;min-width:300px;max-width:420px;
                        background:#fff;overflow:auto;padding:26px;
                        border-right:1px solid #eee;
                        box-shadow:2px 0 12px rgba(0,0,0,.04);
                        transition:margin-left .28s ease;
                }
                .spread-display.collapsed{margin-left:-380px}

                .toggle-spread{
                        position:absolute;left:380px;top:50%;transform:translateY(-50%);
                        width:32px;height:60px;border:1px solid #e5e7eb;border-left:none;
                        border-radius:0 10px 10px 0;background:#fff;
                        display:flex;align-items:center;justify-content:center;
                        cursor:pointer;transition:background .2s ease,color .2s ease;
                        z-index:3;color:#6b7280;
                }
                .toggle-spread:hover{background:var(--light-color);color:var(--accent-color)}
                .spread-display.collapsed + .toggle-spread{left:0}

                .spread-title{
                        font-size:1.35rem;font-weight:800;color:var(--accent-color);
                        text-align:center;margin:0 0 10px;
                }
                .spread-question{
                        background:rgba(142,108,136,.05);
                        border:1px dashed rgba(142,108,136,.25);
                        color:#6b7280;padding:12px 14px;border-radius:12px;
                        text-align:center;margin-bottom:18px;
                }
                .cards-layout{display:flex;flex-direction:column;gap:14px}
                .card-position{
                        background:#fff;border:2px solid #eee;border-radius:14px;padding:16px;
                        transition:all .2s ease;position:relative;overflow:hidden;
                }
                .card-position:hover{border-color:var(--primary-color);transform:translateX(4px)}
                .position-number{
                        position:absolute;top:10px;left:12px;width:28px;height:28px;border-radius:50%;
                        background:var(--primary-color);color:#fff;font-weight:700;font-size:.9rem;
                        display:flex;align-items:center;justify-content:center;
                }
                .position-info{margin-left:38px}
                .position-name{font-weight:700;color:var(--accent-color);margin-bottom:4px}
                .position-meaning{font-size:.9rem;color:#6b7280;margin-bottom:10px}
                .drawn-card{
                        background:linear-gradient(135deg,rgba(142,108,136,.05),rgba(109,76,103,.05));
                        border:1px solid rgba(142,108,136,.12);
                        border-radius:12px;padding:10px;display:flex;gap:12px;align-items:center;
                }
                .card-image{
                        width:62px;height:92px;border-radius:10px;overflow:hidden;flex:0 0 auto;
                        background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
                        display:flex;align-items:center;justify-content:center;color:#fff;
                        box-shadow:0 6px 18px rgba(0,0,0,.18);
                }
                .card-image img{width:100%;height:100%;object-fit:cover;display:block}
                .card-image.reversed img{transform:rotate(180deg)}
                .card-details{flex:1}
                .card-name{font-weight:700}
                .card-direction{font-size:.88rem;color:var(--primary-color)}

                /* 右侧：聊天区 */
                .chat-container{flex:1;display:flex;flex-direction:column;background:var(--chat-bg)}
                .messages-area{
                        flex:1;overflow:auto;padding:18px;
                        display:flex;flex-direction:column;gap:14px;scroll-behavior:smooth;
                }
                .messages-area::-webkit-scrollbar{width:6px}
                .messages-area::-webkit-scrollbar-thumb{background:rgba(142,108,136,.35);border-radius:3px}

                /* 初始骨架 */
                .loading-skeleton{
                        text-align:center;color:var(--accent-color);padding:30px 10px;
                        opacity:.9;
                }

                /* 对话泡泡 */
                .message{display:flex;gap:10px;max-width:820px;width:100%;animation:msgIn .28s ease-out}
                @keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
                .message.user{flex-direction:row-reverse;align-self:flex-end}
                .message.assistant{align-self:flex-start}
                .message-avatar{
                        width:36px;height:36px;border-radius:50%;
                        display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0;
                        background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
                }
                .message.user .message-avatar{background:var(--user-msg-bg)}
                .message-content{
                        max-width:72%;padding:12px 16px;border-radius:18px;line-height:1.6;
                        background:#fff;color:var(--dark-color);
                        border-bottom-left-radius:6px;box-shadow:0 2px 10px rgba(0,0,0,.05);
                        word-wrap:break-word;overflow-wrap:break-word;
                }
                .message.user .message-content{
                        background:var(--user-msg-bg);color:#fff;border-bottom-right-radius:6px;border-bottom-left-radius:18px;
                }

                /* Markdown 样式 */
                .message-content h1{font-size:1.35rem;margin:1em 0 .5em;color:var(--accent-color);font-weight:800}
                .message-content h2{font-size:1.2rem;margin:.9em 0 .45em;color:var(--accent-color);font-weight:700}
                .message-content h3{font-size:1.06rem;margin:.7em 0 .35em;font-weight:700}
                .message-content p{margin:.8em 0}
                .message-content ul,.message-content ol{margin:.8em 0;padding-left:1.4em}
                .message-content li{margin:.35em 0}
                .message-content strong{font-weight:800;color:var(--accent-color)}
                .message.user .message-content strong{color:#fff}
                .message-content em{font-style:italic}
                .message-content del{opacity:.75;text-decoration:line-through}
                .message-content blockquote{
                        margin:.8em 0;padding:.6em 1em;border-left:4px solid var(--primary-color);
                        background:rgba(142,108,136,.06);border-radius:0 10px 10px 0;
                }
                .message-content hr{border:none;border-top:2px solid #e5e7eb;margin:1.2em 0}
                .message-content code{
                        background:rgba(142,108,136,.12);padding:2px 6px;border-radius:6px;
                        font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
                        font-size:.92em;color:var(--accent-color);
                }
                .message-content pre{
                        background:#f6f8fa;border:1px solid #e5e7eb;border-radius:10px;padding:14px;overflow:auto;margin:1em 0;
                }
                .message-content pre code{background:none;padding:0;color:inherit;font-size:.9em}

                /* markdown 表格 */
                .markdown-table{width:100%;border-collapse:collapse;margin:.9em 0;display:block;overflow:auto}
                .markdown-table td,.markdown-table th{border:1px solid #e1e4e8;padding:8px 12px;text-align:left}
                .markdown-table tr:nth-child(even){background:#f9fafb}
                .markdown-table th{background:rgba(142,108,136,.1);font-weight:700}

                /* 打字动画 */
                .typing-indicator{display:flex;gap:10px;align-items:center;max-width:820px;width:100%;align-self:flex-start}
                .typing-dots{display:flex;gap:4px;padding:14px;background:#fff;border-radius:18px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
                .typing-dot{width:8px;height:8px;border-radius:50%;background:#a1a1aa;animation:td 1.4s infinite}
                .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
                @keyframes td{0%,60%,100%{transform:translateY(0);opacity:.55}30%{transform:translateY(-8px);opacity:1}}

                /* 快速问题 */
                .quick-questions{
                        display:flex;flex-wrap:wrap;gap:10px;justify-content:center;
                        margin:8px auto 14px;max-width:820px;
                }
                .quick-question{
                        background:#fff;border:1px solid #e5e7eb;border-radius:999px;
                        padding:9px 16px;font-weight:600;font-size:.95rem;cursor:pointer;
                        transition:.2s;user-select:none;
                }
                .quick-question:hover{
                        background:var(--primary-color);color:#fff;transform:translateY(-2px);
                        box-shadow:0 8px 18px rgba(142,108,136,.25);
                }

                /* 输入区 */
                .input-area{
                        background:#fff;border-top:1px solid #eee;padding:16px 18px;
                        box-shadow:0 -4px 12px rgba(0,0,0,.04);
                }
                .input-container{display:flex;gap:12px;align-items:flex-end;max-width:820px;margin:0 auto}
                .message-input{
                        flex:1;border:2px solid #e5e7eb;border-radius:20px;padding:12px 16px;
                        resize:none;outline:none;transition:.2s;font-size:1rem;max-height:120px;font-family:inherit;
                }
                .message-input:focus{border-color:var(--primary-color)}
                .send-button{
                        width:48px;height:48px;border-radius:50%;border:none;cursor:pointer;
                        background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
                        color:#fff;display:flex;align-items:center;justify-content:center;
                        box-shadow:0 10px 24px rgba(142,108,136,.35);transition:.2s;
                }
                .send-button:hover:not(:disabled){transform:translateY(-2px)}
                .send-button:disabled{opacity:.6;cursor:not-allowed}
                .limit-reached{
                        background:rgba(239,68,68,.09);border:1px solid rgba(239,68,68,.28);
                        color:#dc2626;border-radius:12px;padding:14px;text-align:center;font-weight:600;
                }

                /* 响应式 */
                @media (max-width:1024px){
                        .spread-display{position:absolute;left:0;top:0;bottom:0;z-index:4;width:320px}
                        .spread-display.collapsed{margin-left:-320px}
                        .toggle-spread{left:320px}
                        .spread-display.collapsed + .toggle-spread{left:0}
                }
                @media (max-width:768px){
                        .spread-info{display:none}
                        .message-content{max-width:86%}
                        .messages-area{padding:14px}
                }
        </style>
</head>
<body>
        <!-- 顶部导航 -->
        <div class="chat-header">
                <a class="back-button" href="{{ url_for('spread') }}">
                        <i class="fas fa-arrow-left"></i><span>返回</span>
                </a>

                <div class="spread-info">
                        <div class="spread-icon"><i class="fas fa-layer-group"></i></div>
                        <div class="spread-details">
                                <div class="spread-name">{{ spread_config.name }}</div>
                                <div class="spread-count">{{ spread_config.card_count }}张牌</div>
                        </div>
                </div>

                <div class="chat-limit">剩余对话：<span class="count" id="remaining-count">{{ remaining_chats }}</span></div>
        </div>

        <!-- 主容器 -->
        <div class="main-container">
                <!-- 左侧：牌阵展示 -->
                <div class="spread-display" id="spreadDisplay">
                        <h2 class="spread-title">{{ spread_config.name }}</h2>

                        {% if reading.question %}
                        <div class="spread-question">
                                <i class="fas fa-question-circle"></i>
                                {{ reading.question }}
                        </div>
                        {% endif %}

                        <div class="cards-layout">
                                {% for card in reading.cards %}
                                <div class="card-position">
                                        <div class="position-number">{{ loop.index }}</div>
                                        <div class="position-info">
                                                <div class="position-name">{{ spread_config.positions[loop.index0].name }}</div>
                                                <div class="position-meaning">{{ spread_config.positions[loop.index0].meaning }}</div>
                                                <div class="drawn-card">
                                                        <div class="card-image {% if card.direction == '逆位' %}reversed{% endif %}">
                                                                {% if card.image %}
                                                                <img src="{{ card.image }}" alt="{{ card.card_name }}" />
                                                                {% else %}
                                                                <i class="fas fa-star"></i>
                                                                {% endif %}
                                                        </div>
                                                        <div class="card-details">
                                                                <div class="card-name">{{ card.card_name }}</div>
                                                                <div class="card-direction">{{ card.direction }}</div>
                                                        </div>
                                                </div>
                                        </div>
                                </div>
                                {% endfor %}
                        </div>
                </div>

                <!-- 左侧开合按钮 -->
                <div class="toggle-spread" id="toggleSpread" onclick="toggleSpreadDisplay()">
                        <i class="fas fa-chevron-left" id="toggleIcon"></i>
                </div>

                <!-- 右侧：聊天 -->
                <div class="chat-container">
                        <div class="messages-area" id="messages-area">
                                {% if messages %}
                                        {% for msg in messages %}
                                        <div class="message {{ msg.role }}">
                                                <div class="message-avatar">
                                                        {% if msg.role == 'user' %}
                                                                <i class="fas fa-user"></i>
                                                        {% else %}
                                                                {% if ai_personality == 'mystic' %}
                                                                        <i class="fas fa-moon"></i>
                                                                {% elif ai_personality == 'wisdom' %}
                                                                        <i class="fas fa-book"></i>
                                                                {% else %}
                                                                        <i class="fas fa-heart"></i>
                                                                {% endif %}
                                                        {% endif %}
                                                </div>
                                                <div class="message-content">{{ msg.content }}</div>
                                        </div>
                                        {% endfor %}

                                        <!-- 若已有历史消息，直接显示快捷问题 -->
                                        <div class="quick-questions" id="quick-questions">
                                                <div class="quick-question" onclick="quickAsk('这个牌阵的整体建议是什么？')">整体建议</div>
                                                <div class="quick-question" onclick="quickAsk('我应该注意什么？')">注意事项</div>
                                                <div class="quick-question" onclick="quickAsk('下一步该怎么做？')">行动指南</div>
                                        </div>
                                {% else %}
                                        <!-- 首次进入：骨架加载 -->
                                        <div class="loading-skeleton" id="loading-skeleton">
                                                <div class="fas fa-spinner fa-spin" style="font-size:2.2rem;margin-bottom:12px;"></div>
                                                <div>正在连接牌阵能量，请稍候…</div>
                                        </div>
                                {% endif %}
                        </div>

                        <div class="input-area">
                                {% if can_chat %}
                                <div class="input-container">
                                        <textarea class="message-input" id="message-input" rows="1" maxlength="500" placeholder="深入探讨这个牌阵…（Shift+Enter 换行）"></textarea>
                                        <button class="send-button" id="send-button" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                                </div>
                                {% else %}
                                <div class="limit-reached">
                                        <i class="fas fa-moon"></i> 今日对话次数已用完，明天再来探索塔罗的奥秘吧
                                </div>
                                {% endif %}
                        </div>
                </div>
        </div>

        <script>
                /* ===== 模板变量 ===== */
                const readingId = "{{ reading.id }}";
                const hasHistory = {{ has_history|tojson }};
                const aiPersonality = "{{ ai_personality or 'warm' }}";
                let remainingChats = {{ remaining_chats }};
                let isTyping = false;

                /* ===== 工具：HTML 转义 & Markdown 格式化 ===== */
                function escapeHtml(text){
                        const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
                        return String(text||'').replace(/[&<>"']/g,m=>map[m]);
                }

function formatAIMessage(content){
  let text = String(content || '').replace(/\r\n/g,'\n');

  // 1) 提前摘走代码块（三引号），并安全转义其内容
  const fences = [];
  text = text.replace(/```([a-zA-Z0-9_+\-]*)\n([\s\S]*?)```/g, (m, lang, body) => {
    const id = `__FENCE_${fences.length}__`;
    fences.push(
      `<pre><code class="language-${(lang||'plaintext').toLowerCase()}">${escapeHtml(body)}</code></pre>`
    );
    return id;
  });

  // 2) 对“非代码块区域”统一 HTML 转义（不会影响 # * _ 等 Markdown 符号）
  text = escapeHtml(text);

  // 3) 标题（# .. ######）
  text = text.replace(/^\s*(#{1,6})[ \t\u00A0\u3000]+(.+)$/gm, (m, hs, t) => {
    const lvl = Math.min(hs.length, 6);
    return `<h${lvl}>${t.trim()}</h${lvl}>`;
  });

  // 4) 水平线
  text = text.replace(/^\s*---+\s*$/gm, '<hr>');

  // 5) 多行引用：把连续 &gt; 行合并为一个 blockquote
  text = text.replace(/(?:^|\n)(?:&gt;\s?.*(?:\n|$))+?/g, (block) => {
    const inner = block.replace(/(^|\n)&gt;\s?/g, '$1').trim();
    return `\n<blockquote>${inner.replace(/\n/g,'<br>')}</blockquote>\n`;
  });

  // 6) 行内代码（反引号）——此时文本已转义，无需再次 escape
  text = text.replace(/`([^`]+)`/g, (m, code) => `<code>${code}</code>`);

  // 7) 加粗/斜体（顺序很重要，先强再弱）
  text = text
    .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/___(.+?)___/g, '<strong><em>$1</em></strong>')
    .replace(/__(.+?)__/g, '<strong>$1</strong>')
    .replace(/_(.+?)_/g, '<em>$1</em>');

  // 8) 链接 [text](https://...)（只允许 http/https，避免 javascript:）
  text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
    '<a href="$2" target="_blank" rel="noopener noreferrer nofollow">$1</a>');

  // 9) 列表：先打标记，再成组包裹，避免 “有序→无序”误判
  text = text
    .replace(/^\s*(\d+)\.\s+(.+)$/gm, (m, n, item) => `<li data-ol="1">${item}</li>`)
    .replace(/^\s*[-*+]\s+(.+)$/gm, (m, item) => `<li data-ul="1">${item}</li>`);

  text = text.replace(/(?:^(?:<li[^>]*>.*<\/li>\n?)+)/gms, (block) => {
    const isOl = /<li[^>]*data-ol="1"/.test(block) && !/<li[^>]*data-ul="1"/.test(block);
    const clean = block.replace(/ data-(ol|ul)="1"/g, '');
    return (isOl ? `<ol>${clean.trim()}</ol>` : `<ul>${clean.trim()}</ul>`) + '\n';
  });

  // 10) 表格（简单版）：识别表头 + 多行数据；只处理形如 markdown 的表，不滥杀
  text = text.replace(
    /(?:^|\n)\|([^\n|]+(?:\|[^\n|]+)+)\|\n\|([ :\-|]+)\|\n((?:\|[^\n|]+(?:\|[^\n|]+)+\|\n?)+)/g,
    (m, header, sep, rows) => {
      const ths = header.split('|').map(s => `<th>${s.trim()}</th>`).join('');
      const trs = rows.trim().split('\n').map(r => {
        const tds = r.replace(/^\||\|$/g,'')
                     .split('|').map(s => `<td>${s.trim()}</td>`).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
      return `\n<table class="markdown-table"><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>\n`;
    }
  );

  // 11) 段落：以空行分段，保持已有块级元素不再二次包裹
  const parts = text.split(/\n{2,}/).map(seg => {
    const s = seg.trim();
    if (!s) return '';
    if (/^<(h\d|blockquote|hr|ul|ol|table|pre)/i.test(s)) return s;
    return `<p>${s.replace(/\n/g,'<br>')}</p>`;
  }).filter(Boolean);

  let html = parts.join('\n');

  // 12) 回填代码块
  fences.forEach((codeHtml, i) => {
    html = html.replace(`__FENCE_${i}__`, codeHtml);
  });

  // 13) 清理不必要的包裹
  html = html.replace(/<p><(h\d|blockquote|hr|ul|ol|table|pre)/g,'<$1')
             .replace(/<\/(h\d|blockquote|hr|ul|table|pre)><\/p>/g,'</$1>');

  return html;
}


                /* ===== 初始化：格式化历史 / 首次触发与轮询 ===== */
                document.addEventListener('DOMContentLoaded',()=>{
                        // 历史消息格式化
                        if(hasHistory){
                                document.querySelectorAll('.message.assistant .message-content').forEach(el=>{
                                        const raw=el.textContent; el.innerHTML=formatAIMessage(raw);
                                });
                        }else{
                                kickOffInitialOnce();
                                pollInitialAndInsert();
                        }

                        // 输入区增强
                        const input=document.getElementById('message-input');
                        if(input){
                                input.addEventListener('input',function(){
                                        this.style.height='auto';
                                        this.style.height=Math.min(this.scrollHeight,120)+'px';
                                });
                                input.addEventListener('keydown',function(e){
                                        if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); }
                                });
                        }
                });

                let _kicked=false;
                async function kickOffInitialOnce(){
                        if(_kicked) return; _kicked=true;
                        try{
                                await fetch('/api/spread/generate_initial',{
                                        method:'POST',
                                        headers:{'Content-Type':'application/json'},
                                        body:JSON.stringify({reading_id:readingId}),
                                        cache:'no-store'
                                });
                        }catch(e){ console.warn('kickOffInitial failed',e); }
                }

                let _inserted=false;
                async function pollInitialAndInsert(){
                        const messagesArea=document.getElementById('messages-area');
                        const loading=document.getElementById('loading-skeleton');
                        const maxTries=25; let tries=0;

                        const timer=setInterval(async ()=>{
                                tries++;
                                try{
                                        const r=await fetch(`/api/spread/status/${encodeURIComponent(readingId)}?t=${Date.now()}`,{cache:'no-store'});
                                        if(!r.ok) throw new Error('status not ok');
                                        const s=await r.json();

                                        if(s.has_initial||s.status==='ready'){
                                                clearInterval(timer);
                                                if(!_inserted && s.initial_text){
                                                        if(loading) loading.remove();
                                                        appendMessage('assistant', s.initial_text, /*format*/true);
                                                        showQuickQuestions(); // 首条插入后展示快捷问题
                                                        _inserted=true;
                                                }
                                                return;
                                        }
                                        if(!_inserted && s.message_count>0 && s.initial_text){
                                                if(loading) loading.remove();
                                                appendMessage('assistant', s.initial_text, true);
                                                showQuickQuestions();
                                                _inserted=true;
                                        }
                                        if(tries>=maxTries && !_inserted){
                                                clearInterval(timer);
                                                if(loading) loading.remove();
                                                appendMessage('assistant', '服务器有点忙，我还在连接牌阵的能量…稍后也可以再点我继续聊～', true);
                                        }
                                }catch(e){
                                        console.warn('poll status failed',e);
                                        if(tries>=maxTries && !_inserted){
                                                clearInterval(timer);
                                                if(loading) loading.remove();
                                                appendMessage('assistant','网络有些不稳，稍后再试试或刷新页面。',true);
                                        }
                                }
                        },1000);
                }

                /* ===== UI 操作 ===== */
                function toggleSpreadDisplay(){
                        const panel=document.getElementById('spreadDisplay');
                        const icon=document.getElementById('toggleIcon');
                        panel.classList.toggle('collapsed');
                        icon.className = panel.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
                }

                function showQuickQuestions(){
                        if(document.getElementById('quick-questions')) return;
                        const messagesArea=document.getElementById('messages-area');
                        const box=document.createElement('div');
                        box.className='quick-questions';
                        box.id='quick-questions';
                        box.innerHTML=`
                                <div class="quick-question" onclick="quickAsk('这个牌阵的整体建议是什么？')">整体建议</div>
                                <div class="quick-question" onclick="quickAsk('我应该注意什么？')">注意事项</div>
                                <div class="quick-question" onclick="quickAsk('下一步该怎么做？')">行动指南</div>
                        `;
                        messagesArea.appendChild(box);
                        messagesArea.scrollTop=messagesArea.scrollHeight;
                }

                function quickAsk(q){
                        const input=document.getElementById('message-input');
                        if(input){ input.value=q; sendMessage(); }
                }

                /* ===== 对话：插入/打字动画/发送 ===== */
                function personaIcon(){
                        if(aiPersonality==='mystic') return '<i class="fas fa-moon"></i>';
                        if(aiPersonality==='wisdom') return '<i class="fas fa-book"></i>';
                        return '<i class="fas fa-heart"></i>';
                }

                function appendMessage(role, content, shouldFormat){
                        const area=document.getElementById('messages-area');
                        const quick=area.querySelector('.quick-questions');
                        if(quick && role==='user'){ quick.remove(); }
                        const wrap=document.createElement('div'); wrap.className=`message ${role}`;
                        const avatar=document.createElement('div'); avatar.className='message-avatar';
                        avatar.innerHTML = role==='user' ? '<i class="fas fa-user"></i>' : personaIcon();
                        const cont=document.createElement('div'); cont.className='message-content';
cont.innerHTML = (role === 'assistant')
  ? formatAIMessage(content)         // 始终交给 parser 统一处理与转义
  : escapeHtml(content);             // 用户文本保持纯文本安全显示
                        wrap.appendChild(avatar); wrap.appendChild(cont); area.appendChild(wrap);
                        setTimeout(()=>{ area.scrollTop=area.scrollHeight; },50);
                }

                function showTyping(){
                        const area=document.getElementById('messages-area');
                        const typing=document.createElement('div');
                        typing.id='typing-indicator'; typing.className='message assistant typing-indicator';
                        typing.innerHTML=`<div class="message-avatar">${personaIcon()}</div>
                                <div class="typing-dots">
                                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                                </div>`;
                        area.appendChild(typing); area.scrollTop=area.scrollHeight;
                }

                function hideTyping(){
                        const t=document.getElementById('typing-indicator'); if(t) t.remove();
                }

                async function sendMessage(){
                        const input=document.getElementById('message-input');
                        const msg=(input?.value||'').trim(); if(!msg || isTyping) return;
                        input.value=''; input.style.height='auto';
                        appendMessage('user', msg, false);
                        showTyping(); isTyping=true;

                        try{
                                const r=await fetch('/api/spread/chat/send',{
                                        method:'POST',
                                        headers:{'Content-Type':'application/json'},
                                        body:JSON.stringify({reading_id:readingId,message:msg}),
                                        cache:'no-store'
                                });
                                const data=await r.json();
                                hideTyping(); isTyping=false;
                                appendMessage('assistant', data.reply || '让我再感应一下…', true);
                                if(typeof data.remaining==='number'){
                                        remainingChats=data.remaining;
                                        const el=document.getElementById('remaining-count'); if(el) el.textContent=remainingChats;
                                }
                                if(data.limit_reached){ disableInput(); }
                        }catch(e){
                                console.error(e);
                                hideTyping(); isTyping=false;
                                appendMessage('assistant','抱歉，网络有点卡，请稍后再试。',true);
                        }
                }

                function disableInput(){
                        const box=document.querySelector('.input-area');
                        if(box){
                                box.innerHTML=`<div class="limit-reached"><i class="fas fa-moon"></i> 今日对话次数已用完，明天再来探索塔罗的奥秘吧</div>`;
                        }
                }
        </script>
</body>
</html>
