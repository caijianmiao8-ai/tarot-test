<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æˆ‘çš„å¡”ç½—è¿åŠ¿ - è‹¥æ°´å åœ</title>
<meta name="theme-color" content="#6d66ea"/>

<style>
:root{
  --bg1:#0e0c19; --bg2:#1a1733;
  --glass:rgba(255,255,255,.06);
  --line:rgba(255,255,255,.14);
  --soft:white;
  --muted:rgba(255,255,255,.65);
  --accent:#b794f6;
  --gold1:#fde68a; --gold2:#f59e0b;
  --pink1:#fbcfe8; --vio1:#c4b5fd;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;
  min-height:100vh; display:flex; align-items:center; justify-content:center;
  background:
    radial-gradient(1200px 600px at 10% 10%, #2a2252 0%, transparent 60%),
    radial-gradient(1200px 600px at 90% 90%, #4b1d4f 0%, transparent 60%),
    linear-gradient(135deg, #212139 0%, #0b0b16 100%);
  padding:24px;
}

.share{
  width:390px; height:690px; position:relative; overflow:hidden; border-radius:28px;
  background:linear-gradient(180deg, var(--bg2), var(--bg1));
  box-shadow:0 40px 70px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.06);
}

/* æ˜Ÿç©ºä¸è£…é¥° */
.stars{position:absolute; inset:0; overflow:hidden; z-index:0}
.star{position:absolute; width:2px; height:2px; background:white; border-radius:50%; opacity:.7; animation:twinkle 3s infinite}
@keyframes twinkle{0%,100%{opacity:.3}50%{opacity:1}}
.glow{position:absolute; width:320px; height:320px; border-radius:50%; filter:blur(50px); z-index:0}
.glow.a{top:-120px; right:-120px; background:radial-gradient(circle, rgba(199,125,255,.35), transparent 65%)}
.glow.b{bottom:-140px; left:-140px; background:radial-gradient(circle, rgba(255,120,198,.30), transparent 65%)}
.moon{position:absolute; top:28px; right:28px; width:34px; height:34px; border-radius:50%;
  background:conic-gradient(from 90deg, rgba(255,255,255,.95) 0 50%, transparent 50% 100%); opacity:.45; z-index:1}

/* å†…å®¹ */
.content{position:relative; z-index:2; height:100%; padding:24px 20px; display:flex; flex-direction:column}

/* é¡¶éƒ¨ */
.top{display:flex; flex-direction:column; align-items:center; gap:6px; margin-bottom:12px}
.brand{letter-spacing:.18em; font-size:11px; color:var(--muted)}
.date{font-size:12px; color:var(--muted); letter-spacing:.12em}
.user{color:#fff; font-weight:600; font-size:18px}
.badge{color:var(--accent); font-weight:600; font-size:13px}

/* ç‰Œé¢å¡ */
.cardbox{
  position:relative; margin:12px 0 16px; padding:16px 16px 14px; border-radius:20px;
  background:linear-gradient(140deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--line); backdrop-filter:blur(8px);
}
.tarot{
  width:136px; height:204px; margin:0 auto 12px; border-radius:14px; overflow:hidden;
  background:linear-gradient(135deg, #6d66ea, #8a6ff0 45%, #ef5ea9 100%);
  box-shadow:0 12px 28px rgba(109,102,234,.35);
  transform-style:preserve-3d; animation:cardfloat 8s ease-in-out infinite;
  position:relative;
}
@keyframes cardfloat{0%,100%{transform:translateY(0) rotateY(0)}50%{transform:translateY(-6px) rotateY(10deg)}}
.tarot img{width:100%; height:100%; object-fit:cover}
.tarot::after{
  content:""; position:absolute; inset:0;
  background:repeating-linear-gradient(45deg, rgba(255,255,255,.04) 0 12px, rgba(255,255,255,.06) 12px 24px);
}
.dirchip{
  position:absolute; top:12px; right:12px; padding:6px 10px; border-radius:999px;
  font-size:12px; font-weight:700; letter-spacing:.1em; color:#1a1330;
  background:linear-gradient(135deg, var(--gold1), var(--gold2)); box-shadow:0 6px 14px rgba(245,158,11,.28);
}
.cardname{color:#fff; text-align:center; font-size:18px; font-weight:700}
.carddir{color:var(--accent); text-align:center; font-size:13px; margin-top:2px}

/* å¾—åˆ†ç¯ */
.score{
  display:flex; align-items:center; justify-content:center; gap:12px; margin:12px 0 4px;
}
.ring{
  --val:72; /* 0-100 */
  width:86px; height:86px; border-radius:50%;
  background:
   conic-gradient(from -90deg, #f890e7 calc(var(--val)*1%), rgba(255,255,255,.14) 0),
   radial-gradient(circle 36px at 50% 50%, rgba(0,0,0,.0) 98%, rgba(255,255,255,.18) 100%);
  display:grid; place-items:center; box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);
}
.ring b{font-size:20px; color:#fff}
.scoretxt{display:flex; flex-direction:column; align-items:flex-start}
.scoretxt .label{font-size:12px; color:var(--muted)}
.scoretxt .lvl{font-weight:700; color:#fff}

/* äº”ç»´åº¦ */
.dim{
  margin-top:8px; display:grid; grid-template-columns:repeat(5,1fr); gap:8px;
}
.di{ text-align:center }
.di .ico{ width:36px; height:36px; border-radius:50%; margin:0 auto 6px;
  display:flex; align-items:center; justify-content:center; font-size:16px;
  background:linear-gradient(135deg, rgba(199,125,255,.22), rgba(255,120,198,.22));
  border:1px solid var(--line);
}
.di .nm{font-size:11px; color:var(--muted); margin-bottom:2px}
.di .stars{font-size:12px; color:#ffd670; letter-spacing:1px}
.di .lv{font-size:10px; color:#b9a6ff; margin-top:2px}

/* å¹¸è¿å…ƒç´  */
.lucky{
  margin-top:12px; padding:12px; border-radius:14px; border:1px solid var(--line);
  background:linear-gradient(145deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  display:grid; grid-template-columns:repeat(2,1fr); gap:10px;
}
.litem{display:flex; align-items:center; gap:8px}
.lkey{font-size:12px; color:var(--muted)}
.lval{font-size:13px; font-weight:700; color:var(--accent);}

/* å®œå¿Œ + ç‰Œä¹‰ */
.section{ margin-top:12px; border-top:1px dashed var(--line); padding-top:12px }
.row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
.card{
  padding:12px; border-radius:14px; border:1px solid var(--line);
  background:linear-gradient(160deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
}
.card h4{font-size:13px; color:#fff; letter-spacing:.1em; margin-bottom:8px}
.ul{ list-style:none; display:flex; flex-direction:column; gap:6px }
.ul li{ font-size:12px; color:var(--soft) }

.note{ margin-top:10px; padding:12px; border-radius:14px; border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02));
}
.note h4{font-size:13px; color:#fff; margin-bottom:6px; letter-spacing:.08em}
.note p{font-size:12px; color:var(--soft); line-height:1.55}

/* åº•éƒ¨äºŒç»´ç  */
.bottom{
  margin-top:auto; display:flex; align-items:center; gap:12px; padding-top:12px; border-top:1px solid var(--line);
}
.qr{ width:66px; height:66px; border-radius:10px; background:#fff; display:grid; place-items:center; overflow:hidden }
.qr img{ width:100%; height:100%; object-fit:cover }
.qrph{ width:100%; height:100%; background:repeating-linear-gradient(0deg,#000,#000 2px,#fff 2px,#fff 4px)}
.btntxt{flex:1}
.btntxt .t{ color:#fff; font-size:14px; font-weight:700 }
.btntxt .s{ color:var(--muted); font-size:11px }
.btntxt .u{ color:var(--accent); font-size:10px; margin-top:4px; word-break:break-all }

/* æµ®åŠ¨æŒ‰é’® */
.actions{
  position:fixed; left:50%; bottom:28px; transform:translateX(-50%);
  display:flex; gap:12px; z-index:10;
}
.btn{
  padding:12px 18px; border-radius:22px; border:1px solid rgba(255,255,255,.18);
  background:linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
  color:#fff; font-weight:700; font-size:13px; cursor:pointer; backdrop-filter:blur(10px);
  display:inline-flex; align-items:center; gap:8px; text-decoration:none;
  transition:.2s transform,.2s box-shadow;
}
.btn:hover{ transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,.25)}
.btn.primary{ background:linear-gradient(135deg,#6d66ea,#ef5ea9); border-color:transparent; box-shadow:0 10px 20px rgba(239,94,169,.25)}
.btn.hidden{ display:none !important }

/* å¯¼å‡ºæ—¶éšè—æŒ‰é’® */
.exporting .actions{ display:none !important }
</style>
</head>
<body>
<div class="share" id="shareCard">
  <div class="stars" id="stars"></div>
  <div class="glow a"></div><div class="glow b"></div>
  <div class="moon"></div>

  <div class="content">
    <div class="top">
      <div class="brand">RUOSHUI TAROT</div>
      <div class="date" id="dateLabel">--</div>
      <div class="user" id="userName">ç¥ç§˜è®¿å®¢</div>
      <div class="badge">âœ¨ ä»Šæ—¥å¡”ç½—è¿åŠ¿ âœ¨</div>
    </div>

    <div class="cardbox">
      <div class="tarot" id="tarotImg"><span class="dirchip" id="dirChip">--</span></div>
      <div class="cardname" id="cardName">--</div>
      <div class="carddir" id="cardDirection">--</div>
    </div>

    <div class="score">
      <div class="ring" id="ring"><b id="scoreNum">--</b></div>
      <div class="scoretxt">
        <div class="label">æ€»è¯„</div>
        <div class="lvl" id="scoreLbl">--</div>
      </div>
    </div>

    <div class="dim" id="dimGrid"></div>

    <div class="lucky">
      <div class="litem"><div class="lkey">å¹¸è¿è‰²</div><div class="lval" id="lkColor">--</div></div>
      <div class="litem"><div class="lkey">å¹¸è¿æ•°</div><div class="lval" id="lkNum">--</div></div>
      <div class="litem"><div class="lkey">å¹¸è¿æ—¶</div><div class="lval" id="lkHour">--</div></div>
      <div class="litem"><div class="lkey">å¹¸è¿æ–¹</div><div class="lval" id="lkDir">--</div></div>
    </div>

    <div class="section">
      <div class="row">
        <div class="card">
          <h4>ä»Šæ—¥å®œ</h4>
          <ul class="ul" id="todo"></ul>
        </div>
        <div class="card">
          <h4>ä»Šæ—¥å¿Œ</h4>
          <ul class="ul" id="dont"></ul>
        </div>
      </div>
      <div class="note">
        <h4>ç‰Œä¹‰ç²¾è¦</h4>
        <p id="insight">--</p>
        <h4 style="margin-top:8px;">è¡ŒåŠ¨æŒ‡å¼•</h4>
        <p id="guide">--</p>
      </div>
    </div>

    <div class="bottom">
      <div class="qr"><img id="qrImg" alt="" style="display:none"/><div id="qrPh" class="qrph"></div></div>
      <div class="btntxt">
        <div class="t">æ‰«ç æŸ¥çœ‹æˆ‘çš„å åœ</div>
        <div class="s">æ¢ç´¢å®‡å®™èƒ½é‡çš„è½»å£°ä½è¯­</div>
        <div class="u" id="siteUrl">www.ruoshui.fun</div>
      </div>
    </div>
  </div>
</div>

<div class="actions" id="actions">
  <button class="btn primary" id="btnGen">ğŸ´ ç”Ÿæˆåˆ†äº«å¡ç‰‡</button>
  <button class="btn" id="btnCopy" style="display:none">ğŸ”— å¤åˆ¶é“¾æ¥</button>
  <button class="btn" id="btnSave">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
</div>

<!-- æœåŠ¡ç«¯æ³¨å…¥çš„æ•°æ®ï¼ˆä¿æŒä½ åŸæœ‰æ ¼å¼ï¼‰ -->
<script id="__DATA__" type="application/json">
{
  "mode": "{{ 'view' if share_data is defined else 'own' }}",
  "share_url": "{{ (request.url if share_data is defined else '')|e }}",
  "user_name": "{{ (share_data['user_name'] if share_data is defined else (user.get('username','ç¥ç§˜è®¿å®¢') if user else 'ç¥ç§˜è®¿å®¢'))|e }}",
  "date_iso": "{{ (share_data['created_at'].isoformat() if share_data is defined and share_data.get('created_at') else '')|e }}",
  "today_str": "{{ (today if today is defined else '')|e }}",
  "reading": {{ (share_data['reading'] if share_data is defined else reading)|tojson }},
  "fortune": {{ (share_data['fortune'] if share_data is defined else fortune_data)|tojson }},
  "qr_code": "{{ (share_data.get('qr_code') if share_data is defined else '')|e }}"
}
</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<script>
const $=id=>document.getElementById(id);
const ICONS={ "äº‹ä¸šè¿":"ğŸ’¼","è´¢å¯Œè¿":"ğŸ’°","çˆ±æƒ…è¿":"â¤ï¸","å¥åº·è¿":"ğŸŒ¿","è´µäººè¿":"ğŸ¤" };

function genStars(){
  const box=$('stars'); for(let i=0;i<60;i++){
    const s=document.createElement('div'); s.className='star';
    const size=Math.random()*2+1;
    Object.assign(s.style,{
      width:size+'px', height:size+'px',
      left:(Math.random()*100)+'%', top:(Math.random()*100)+'%',
      animationDelay:(Math.random()*3)+'s', opacity:.3+Math.random()*.7
    });
    box.appendChild(s);
  }
}
function labelByScore(s){ s=Number(s)||0; if(s>=85) return 'å¤§å‰'; if(s>=70) return 'ä¸­å‰'; if(s>=55) return 'å°å‰'; return 'å¹³'; }
function starText(n){ n = Math.max(0, Math.min(5, Number(n)||0)); const full=Math.floor(n), half=(n-full)>=0.5?1:0; return 'â˜…'.repeat(full)+(half?'â¯ª':'')+'â˜†'.repeat(5-full-half); }
function to2(v){return (v??'--');}
function setRing(val){ const ring=$('ring'); ring.style.setProperty('--val', (Math.max(0,Math.min(100,Number(val)||0)))); }

function fillDims(grid, fortune){
  grid.innerHTML='';
  let items = [];
  if (Array.isArray(fortune?.dimensions)) items = fortune.dimensions;
  else if (typeof fortune?.dimensions === 'string'){
    const lines = fortune.dimensions.split(/\n+/);
    items = lines.map(line=>{
      const m = line.match(/^(.*?)[ï¼š:]\s*([\d.]+)\s*æ˜Ÿ.*?(ï¼ˆ(.+?)ï¼‰)?/);
      return m? {name:m[1], stars:parseFloat(m[2]), level:(m[4]||'')} : null
    }).filter(Boolean);
  }
  const order=["äº‹ä¸šè¿","è´¢å¯Œè¿","çˆ±æƒ…è¿","å¥åº·è¿","è´µäººè¿"];
  order.forEach(nm=>{
    const it = items.find(x => (x.name===nm || x.name===nm.replace('è¿','')));
    if(!it) return;
    const li=document.createElement('div'); li.className='di';
    li.innerHTML = `
      <div class="ico">${ICONS[nm]||'âœ¨'}</div>
      <div class="nm">${nm.replace('è¿','')}</div>
      <div class="stars">${starText(it.stars)}</div>
      <div class="lv">${to2(it.level)}</div>`;
    grid.appendChild(li);
  });
}

function fillLucky(fortune){
  const L = fortune?.lucky_elements;
  const color = fortune?.lucky_color || L?.color;
  const num = fortune?.lucky_number || L?.number;
  const hour = fortune?.lucky_hour || L?.hour;
  const dir = fortune?.lucky_direction || L?.direction;
  $('lkColor').textContent = to2(color);
  $('lkNum').textContent = to2(num);
  $('lkHour').textContent = to2(hour);
  $('lkDir').textContent = to2(dir);
}

function fillTodo(fortune){
  const todo = (fortune?.do) || (fortune?.fortune_text?.do) || [];
  const dont = (fortune?.dont) || (fortune?.fortune_text?.dont) || [];
  const ul1=$('todo'), ul2=$('dont'); ul1.innerHTML=''; ul2.innerHTML='';
  (Array.isArray(todo)?todo:[]).slice(0,4).forEach(t=>{
    const li=document.createElement('li'); li.textContent='Â· '+t; ul1.appendChild(li);
  });
  (Array.isArray(dont)?dont:[]).slice(0,4).forEach(t=>{
    const li=document.createElement('li'); li.textContent='Â· '+t; ul2.appendChild(li);
  });
}

function firstNonEmpty(...arr){ for(const t of arr){ if(t && String(t).trim()) return t } return '' }

function init(){
  genStars();
  const data = JSON.parse(document.getElementById('__DATA__').textContent || '{}');
  const mode = data.mode || 'own';
  const reading = data.reading || {};
  const fortune = data.fortune || {};

  // å¤´éƒ¨
  const dateStr = (mode==='view' && data.date_iso) ? fmtYMD(data.date_iso) : (data.today_str || '--');
  $('dateLabel').textContent = dateStr;
  $('userName').textContent = data.user_name || 'ç¥ç§˜è®¿å®¢';

  // ç‰Œé¢
  const cardName = reading.card_name || reading.name || '--';
  const direction = reading.direction || reading.card_direction || '--';
  $('cardName').textContent = cardName;
  $('cardDirection').textContent = direction;
  $('dirChip').textContent = direction;
  const img = reading.image || reading.card_image;
  if (img){
    const image = new Image();
    image.onload = ()=> { const box=$('tarotImg'); box.style.background = 'none'; box.innerHTML=''; box.appendChild(image); const chip=$('dirChip'); box.appendChild(chip); };
    image.src = img;
  }

  // æ€»åˆ†
  const overall = fortune.overall_score ?? fortune.overall ?? '';
  $('scoreNum').textContent = overall || '--';
  $('scoreLbl').textContent = 'ä»Šæ—¥ Â· ' + (fortune.overall_label || labelByScore(overall));
  setRing(overall);

  // ç»´åº¦
  fillDims($('dimGrid'), fortune);

  // å¹¸è¿å…ƒç´ 
  fillLucky(fortune);

  // å®œ/å¿Œ
  fillTodo(fortune);

  // ç‰Œä¹‰ä¸æŒ‡å¼•ï¼ˆä¼˜å…ˆä»Šæ—¥æ´å¯Ÿä¸æŒ‡å¼•ï¼Œå…¶æ¬¡ Dify summary ä¸ç»´åº¦å»ºè®®ï¼Œå†æ¬¡å¡é¢å«ä¹‰ï¼‰
  const summary = firstNonEmpty(fortune.summary, fortune.fortune_text?.summary, reading.today_insight);
  $('insight').textContent = summary || firstNonEmpty(
    reading[direction==='æ­£ä½'?'meaning_up':'meaning_rev'],
    'ä»Šæ—¥ä»å®¹ä»¥å¯¹ï¼Œé¡ºåŠ¿è€Œä¸ºã€‚'
  );
  const adv = reading.guidance || (()=> {
    const advDict = fortune.dimension_advice || fortune.fortune_text?.dimension_advice || {};
    const keys = Object.keys(advDict); if (!keys.length) return '';
    return keys.map(k=>`${k}ï¼š${advDict[k]}`).join('ï¼›');
  })();
  $('guide').textContent = adv || 'ä¿æŒèŠ‚å¥ï¼Œåšé‡è¦ä¸”å…·ä½“çš„å°äº‹ã€‚';

  // äºŒç»´ç 
  if (data.qr_code) {
    $('qrImg').src = data.qr_code;
    $('qrImg').style.display = '';
    $('qrPh').style.display = 'none';
  }
  $('siteUrl').textContent = (mode==='view' ? (data.share_url || 'www.ruoshui.fun') : 'www.ruoshui.fun');

  // æŒ‰é’®çŠ¶æ€
  const btnGen=$('btnGen'), btnCopy=$('btnCopy'), btnSave=$('btnSave');
  if (mode==='view'){ btnGen.style.display='none'; btnCopy.style.display='inline-flex'; btnCopy.onclick=()=>copyText(data.share_url||location.href); }
  else {
    btnGen.onclick = async ()=>{
      btnGen.disabled = true; btnGen.textContent = 'ç”Ÿæˆä¸­â€¦';
      try{
        const resp = await fetch('/api/share/create', {method:'POST'});
        const d = await resp.json();
        if(!d.success) throw new Error(d.error||'ç”Ÿæˆå¤±è´¥');
        $('siteUrl').textContent = d.share_url;
        if (d.qr_code){ $('qrImg').src=d.qr_code; $('qrImg').style.display=''; $('qrPh').style.display='none'; }
        btnCopy.style.display='inline-flex'; btnCopy.onclick=()=>copyText(d.share_url);
        btnGen.textContent='å·²ç”Ÿæˆ';
      }catch(e){ alert(e.message||'ç”Ÿæˆå¤±è´¥'); btnGen.textContent='ç”Ÿæˆåˆ†äº«å¡ç‰‡'; }
      finally{ btnGen.disabled=false; }
    };
  }
  btnSave.onclick = ()=>savePng();
}

function fmtYMD(s){ try{ const d=new Date(s); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}.${m}.${dd}` }catch{return '--'} }
function copyText(text){ if(!text) return; (navigator.clipboard? navigator.clipboard.writeText(text) : Promise.reject()).then(()=>alert('é“¾æ¥å·²å¤åˆ¶')).catch(()=>{
  const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('é“¾æ¥å·²å¤åˆ¶');
}); }

async function savePng(){
  document.body.classList.add('exporting');
  try{
    const node=$('shareCard');
    const canvas=await html2canvas(node,{scale:2,useCORS:true,backgroundColor:null});
    const url=canvas.toDataURL('image/png');
    const a=document.createElement('a'); a.href=url; a.download=`tarot_${Date.now()}.png`; a.click();
  }catch(e){ alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•'); }
  finally{ document.body.classList.remove('exporting'); }
}

window.addEventListener('load', init);
</script>
</body>
</html>
