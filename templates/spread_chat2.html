<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>引导式牌阵占卜</title>

  <!-- iOS 全屏 & 状态栏 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="若水占卜">

  <!-- Android / Chrome 主题色（与 index 一致） -->
  <meta name="theme-color" content="#1a1625" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#2d1b4e" media="(prefers-color-scheme: light)">

  <!-- 可选：PWA 清单 / 图标（按需保留） -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-180.png') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- 本地化资源 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    /* ========== 主题变量：与 index / spread_chat 完全对齐，同时兼容旧变量名 ========== */
    :root{
      /* 新主题色板 */
      --primary:#9d7ea8; --secondary:#6d5675; --gold:#e8d4a2; --gold-light:#f4e5c3;
      --bg1:#2d1b4e; --bg2:#1a1625;
      --text:#fff; --text-light:rgba(255,255,255,.88); --text-muted:rgba(255,255,255,.65);
      --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --success:#10b981; --danger:#ef4444;

      /* 兼容原样式使用到的变量（映射到新主题） */
      --primary-color:#9d7ea8;
      --secondary-color:#f4e5c3;
      --accent-color:#6d5675;
      --light-color:#f8f4e9;
      --dark-color:#ffffff;
      --chat-bg:transparent;
      --user-msg-bg:linear-gradient(135deg, var(--primary), var(--secondary));
      --ai-msg-bg:rgba(255,255,255,.06);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Noto Serif SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC','Hiragino Sans GB','Microsoft YaHei', serif;
      color:var(--text);
      min-height:100dvh;
      min-height:calc(var(--vh,1vh)*100);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(1200px 700px at 80% 90%, rgba(232,212,162,.12), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      display:flex;flex-direction:column;
    }

    /* 背景层（与 index 一致） */
    .bg-stars{position:fixed;inset:0;z-index:-2;opacity:.25;background-image:
      radial-gradient(1px 1px at 12% 25%, #fff, transparent),
      radial-gradient(1px 1px at 32% 60%, #fff, transparent),
      radial-gradient(1px 1px at 62% 30%, #fff, transparent),
      radial-gradient(1px 1px at 82% 70%, #fff, transparent),
      radial-gradient(1px 1px at 22% 80%, #fff, transparent);
      background-size:220px 220px;animation:twinkle 4s ease-in-out infinite alternate;pointer-events:none;}
    @keyframes twinkle{from{opacity:.15}to{opacity:.35}}
    .bg-veil{position:fixed;inset:-10% -10% 0 -10%;z-index:-5;pointer-events:none;opacity:.9;filter:blur(2px);
      background:
        radial-gradient(800px 500px at 12% 14%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(720px 460px at 82% 72%, rgba(232,212,162,.12), transparent 60%),
        radial-gradient(900px 560px at 58% 12%, rgba(157,126,168,.10), transparent 70%);
      animation:veilDrift 50s linear infinite alternate;}
    @keyframes veilDrift{to{transform:translate3d(-10px,8px,0)}}
    .bg-constellations{position:fixed;inset:0;z-index:-4;pointer-events:none;opacity:.18;mix-blend-mode:screen;}
    .bg-constellations line{stroke:rgba(255,255,255,.18);stroke-width:.6}
    .bg-constellations circle{fill:rgba(255,255,255,.7);r:1.2;animation:starBlink 4.6s ease-in-out infinite}
    @keyframes starBlink{0%,100%{opacity:.25}50%{opacity:.85}}
    .bg-glyphs{
      position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.13;filter:drop-shadow(0 0 20px rgba(232,212,162,.06));
      background-repeat:no-repeat;
      background-size:68px 68px,76px 76px,64px 64px,72px 72px,60px 60px,70px 70px;
      background-position:8% 24%,86% 22%,12% 78%,88% 68%,42% 88%,34% 34%;
      animation:glyphFloat 40s ease-in-out infinite alternate;
      background-image:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M32 10 v36'/><path d='M22 30 h20'/><path d='M28 48 h8'/><circle cx='32' cy='10' r='3' fill='none'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='32' cy='32' r='16'/><path d='M32 16 L37 40 L20 26 H44 L27 40 Z'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>");
    }
    @keyframes glyphFloat{to{transform:translate3d(0,-8px,0) rotate(-0.5deg)}}
    .zodiac{position:fixed;width:820px;height:820px;left:50%;top:50%;transform:translate(-50%,-50%);z-index:-2;opacity:.1;filter:drop-shadow(0 0 20px rgba(255,255,255,.1));animation:rot 90s linear infinite;pointer-events:none;}
    @keyframes rot{to{transform:translate(-50%,-50%) rotate(360deg)}}
    @media (prefers-reduced-motion:reduce){.bg-veil,.bg-glyphs,.bg-constellations,.zodiac{animation:none}}

    /* ========== 顶部栏（玻璃拟态，与 spread_chat 一致） ========== */
    .chat-header{
      position:sticky;top:0;z-index:10;
      background:rgba(28,22,40,.6);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
      padding:10px 16px;
      display:flex;align-items:center;justify-content:space-between;
      padding-top:calc(env(safe-area-inset-top,0px) + 10px);
    }
    .back-button{
      color:var(--gold-light);text-decoration:none;display:flex;align-items:center;gap:8px;
      transition:.25s ease;font-weight:700;letter-spacing:.3px;
    }
    .back-button:hover{color:#fff;transform:translateX(-2px)}

    /* 阶段指示器 */
    .phase-info{display:flex;align-items:center;gap:14px}
    .phase-pill{
      background:rgba(255,255,255,.08);color:#fff;border:1px solid var(--border);
      padding:6px 12px;border-radius:999px;font-weight:800;font-size:.92rem;letter-spacing:.2px;
    }
    .phase-GUIDE{background:rgba(255,255,255,.08);color:var(--gold-light)}
    .phase-DRAWING{background:rgba(157,126,168,.16);color:#fff;border-color:rgba(157,126,168,.45)}
    .phase-INTERPRET{background:rgba(232,212,162,.16);color:#fff;border-color:rgba(232,212,162,.45);border-style:dashed}
    .phase-DEEP_CHAT{background:rgba(255,255,255,.10);color:#fff;border-color:var(--border)}

    /* 进度显示 */
    .progress-wrap{display:flex;align-items:center;gap:10px}
    .slots{display:flex;gap:6px}
    .slot{
      width:24px;height:24px;border-radius:50%;border:1px solid var(--border);
      background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:800;color:var(--text-muted);transition:all .3s ease;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.08);
    }
    .slot.done{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      border-color:transparent;color:#fff;transform:scale(1.1);
      box-shadow:0 4px 14px rgba(0,0,0,.25);
    }
    #progress-text{color:var(--gold-light);font-size:.9rem;font-weight:700}

    /* 主容器 */
    .main-container{flex:1;display:flex;overflow:hidden;position:relative;padding:16px;gap:16px}
    @media (max-width:1024px){.main-container{padding:12px}}

    /* 左侧牌阵展示面板（仅 DEEP_CHAT 显示） */
    .spread-display{
      width:380px;min-width:300px;max-width:420px;
      background:var(--panel);border:1px solid var(--border);
      overflow:auto;padding:22px;border-right:none;border-radius:18px;
      box-shadow:0 18px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08);
      transition:all .28s ease;display:none;
    }
    .spread-display.active{display:block}
    .spread-display.collapsed{margin-left:-380px}

    .toggle-spread{
      position:absolute;left:380px;top:50%;transform:translateY(-50%);
      width:34px;height:60px;border:1px solid var(--border);border-left:none;
      border-radius:0 12px 12px 0;background:rgba(255,255,255,.08);
      display:none;align-items:center;justify-content:center;cursor:pointer;transition:.2s;z-index:3;color:var(--text-light);
      box-shadow:0 8px 18px rgba(0,0,0,.18);backdrop-filter:blur(10px);
    }
    .toggle-spread.active{display:flex}
    .toggle-spread:hover{background:rgba(255,255,255,.12);color:#fff}
    .spread-display.collapsed + .toggle-spread{left:0}

    .spread-title{font-size:1.3rem;font-weight:800;color:var(--gold-light);text-align:center;margin:0 0 10px;text-shadow:0 2px 8px rgba(0,0,0,.25)}
    .spread-question{
      background:rgba(255,255,255,.06);border:1px dashed var(--border);color:var(--text-light);
      padding:12px 14px;border-radius:12px;text-align:center;margin-bottom:18px;
    }
    .cards-layout{display:flex;flex-direction:column;gap:14px}
    .card-position{
      background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;padding:14px;
      transition:all .2s ease;position:relative;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.12);
    }
    .card-position:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.16)}
    .position-number{
      position:absolute;top:10px;left:12px;width:28px;height:28px;border-radius:50%;
      background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:800;font-size:.9rem;
      display:flex;align-items:center;justify-content:center;border:1px solid var(--border);
    }
    .position-info{margin-left:38px}
    .position-name{font-weight:800;color:#fff;margin-bottom:4px}
    .position-meaning{font-size:.9rem;color:var(--text-muted);margin-bottom:10px}
    .drawn-card{
      background:linear-gradient(135deg, rgba(157,126,168,.10), rgba(232,212,162,.08));
      border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;gap:12px;align-items:center;
    }
    .card-image{
      width:62px;height:92px;border-radius:10px;overflow:hidden;flex:0 0 auto;
      background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.25);border:1px solid var(--border);
    }
    .card-image img{width:100%;height:100%;object-fit:cover;display:block}
    .card-image.reversed img{transform:rotate(180deg)}
    .card-details{flex:1}
    .card-name{font-weight:800;color:#fff}
    .card-direction{font-size:.88rem;color:var(--gold-light)}

    /* 右侧：聊天区（玻璃面板） */
    .chat-container{
      flex:1;display:flex;flex-direction:column;
      background:var(--panel);border:1px solid var(--border);border-radius:18px;
      box-shadow:0 18px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08);
    }
    .messages-area{
      flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:14px;scroll-behavior:smooth;
    }
    .messages-area::-webkit-scrollbar{width:6px}
    .messages-area::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:3px}

    /* 对话气泡（深色） */
    .message{display:flex;gap:10px;max-width:820px;width:100%;animation:msgIn .28s ease-out}
    @keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .message.user{flex-direction:row-reverse;align-self:flex-end}
    .message.assistant{align-self:flex-start}
    .message-avatar{
      width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0;
      background:linear-gradient(135deg,var(--primary),var(--secondary));border:1px solid var(--border);
    }
    .message.user .message-avatar{background:var(--user-msg-bg);border-color:transparent}
    .message-content{
      max-width:72%;padding:12px 16px;border-radius:18px;line-height:1.7;
      background:var(--ai-msg-bg);color:var(--text);
      border-bottom-left-radius:6px;box-shadow:0 2px 10px rgba(0,0,0,.14);
      word-wrap:break-word;overflow-wrap:break-word;border:1px solid var(--border);
    }
    .message.user .message-content{
      background:var(--user-msg-bg);color:#fff;border-bottom-right-radius:6px;border-bottom-left-radius:18px;border-color:transparent;
    }

    /* markdown 任务清单/表格/代码（深色优化） */
    .message-content .task-list{list-style:none;padding-left:0;margin:.8em 0}
    .message-content .task-list li{margin:.35em 0}
    .message-content .task-list input[type="checkbox"]{margin-right:8px;transform:scale(1.05);vertical-align:middle;accent-color:var(--primary);pointer-events:none}
    .message-content h1{font-size:1.35rem;margin:1em 0 .5em;color:var(--gold-light);font-weight:800}
    .message-content h2{font-size:1.2rem;margin:.9em 0 .45em;color:var(--gold-light);font-weight:700}
    .message-content h3{font-size:1.06rem;margin:.7em 0 .35em;font-weight:700}
    .message-content p{margin:.8em 0}
    .message-content ul,.message-content ol{margin:.8em 0;padding-left:1.4em}
    .message-content li{margin:.35em 0}
    .message-content strong{font-weight:800;color:#fff}
    .message.user .message-content strong{color:#fff}
    .message-content em{font-style:italic}
    .message-content del{opacity:.75;text-decoration:line-through}
    .message-content blockquote{margin:.8em 0;padding:.6em 1em;border-left:4px solid var(--primary);
      background:rgba(255,255,255,.06);border-radius:0 10px 10px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    .message-content hr{border:none;border-top:2px solid var(--border);margin:1.2em 0}
    .message-content code{
      background:rgba(0,0,0,.35);padding:2px 6px;border-radius:6px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.92em;color:var(--gold-light);
    }
    .message-content pre{background:#0f0d18;border:1px solid var(--border);border-radius:10px;padding:14px;overflow:auto;margin:1em 0;color:var(--text-light)}
    .message-content pre code{background:none;padding:0;color:inherit;font-size:.9em}
    .markdown-table{width:100%;border-collapse:collapse;margin:.9em 0;display:block;overflow:auto;border:1px solid var(--border)}
    .markdown-table td,.markdown-table th{border:1px solid var(--border);padding:8px 12px;text-align:left}
    .markdown-table tr:nth-child(even){background:rgba(255,255,255,.04)}
    .markdown-table th{background:rgba(255,255,255,.08);font-weight:700}

    /* 打字动画 */
    .typing-indicator{display:flex;gap:10px;align-items:center;max-width:820px;width:100%;align-self:flex-start}
    .typing-dots{display:flex;gap:4px;padding:14px;background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:18px;box-shadow:0 2px 10px rgba(0,0,0,.12)}
    .typing-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.7);animation:td 1.4s infinite}
    .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes td{0%,60%,100%{transform:translateY(0);opacity:.55}30%{transform:translateY(-8px);opacity:1}}

    /* 快速问题 */
    .quick-questions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:8px auto 14px;max-width:820px}
    .quick-question{
      background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:999px;
      padding:9px 16px;font-weight:700;font-size:.95rem;cursor:pointer;transition:.2s;user-select:none;color:var(--text-light);
      backdrop-filter:blur(8px);
    }
    .quick-question:hover{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;transform:translateY(-2px);box-shadow:0 10px 22px rgba(157,126,168,.35)}
    .hidden{display:none !important}

    /* 系统卡片（确认牌阵等） */
    .sys-card{
      background:linear-gradient(135deg,rgba(157,126,168,.08),rgba(232,212,162,.06));
      border:1px dashed var(--border);border-radius:14px;padding:16px;margin:8px 0;color:var(--text-light);
    }
    .sys-title{font-weight:800;color:#fff;margin-bottom:8px;font-size:1.05rem}
    .sys-actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn-confirm{
      background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;border:none;border-radius:10px;
      padding:8px 16px;font-weight:700;cursor:pointer;transition:.2s;box-shadow:0 6px 16px rgba(0,0,0,.2)
    }
    .btn-confirm:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(157,126,168,.35)}
    .btn-outline{
      border:1px solid var(--border);color:var(--text-light);background:rgba(255,255,255,.04);
      border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;transition:.2s;
    }
    .btn-outline:hover{background:rgba(255,255,255,.10);color:#fff}

    /* 单张牌展示气泡 */
    .card-bubble{
      display:flex;gap:14px;align-items:flex-start;background:linear-gradient(135deg,rgba(157,126,168,.08),rgba(232,212,162,.06));
      border:1px solid var(--border);border-radius:14px;padding:14px;margin:8px 0;color:var(--text-light)
    }
    .card-bubble img{
      width:86px;height:140px;object-fit:cover;border-radius:10px;border:1px solid var(--border);
      background:#0f0d18;box-shadow:0 4px 12px rgba(0,0,0,.2)
    }
    .card-meta{flex:1}
    .card-meta .pos{font-weight:800;color:var(--gold-light);font-size:.9rem;margin-bottom:4px}
    .card-meta .name{font-weight:800;color:#fff;font-size:1.1rem;margin-bottom:6px}
    .card-meta .meaning{font-size:.95rem;color:var(--text-muted);line-height:1.5}

    /* 输入区 */
    .input-area{
      background:rgba(255,255,255,.04);border-top:1px solid var(--border);padding:12px 14px;
      box-shadow:0 -4px 12px rgba(0,0,0,.14);border-radius:0 0 18px 18px;
      padding-bottom:calc(12px + env(safe-area-inset-bottom,0px));
    }
    .input-container{display:flex;gap:12px;align-items:flex-end;max-width:820px;margin:0 auto}
    .message-input{
      flex:1;border:1px solid var(--border);border-radius:16px;padding:12px 14px;
      resize:none;outline:none;transition:.2s;font-size:16px;max-height:120px;font-family:inherit;background:rgba(255,255,255,.06);color:#fff;
    }
    .message-input:focus{border-color:var(--primary)}
    .send-button{
      width:48px;height:48px;border-radius:50%;border:1px solid var(--border);cursor:pointer;
      background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;display:flex;align-items:center;justify-content:center;
      box-shadow:0 10px 24px rgba(157,126,168,.35);transition:.2s;flex-shrink:0;-webkit-tap-highlight-color:transparent
    }
    .send-button:hover:not(:disabled){transform:translateY(-2px)}
    .send-button:disabled{opacity:.6;cursor:not-allowed}

    /* Modal 背景 */
    .modal-backdrop-custom{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:1000;backdrop-filter:blur(4px)}
    .modal-backdrop-custom.show{display:block}

    /* Modal 面板（暗色玻璃） */
    .modal-panel{
      position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);
      width:min(600px,90vw);max-height:80vh;background:var(--panel);color:var(--text-light);
      border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.45);overflow:hidden;display:flex;flex-direction:column;
    }
    .modal-header{
      padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;
      background:linear-gradient(135deg,rgba(157,126,168,.12),rgba(232,212,162,.10));color:#fff
    }
    .modal-title{font-size:1.2rem;font-weight:800;margin:0}
    .modal-close{background:none;border:1px solid var(--border);color:var(--text-light);font-size:1.1rem;cursor:pointer;padding:0;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:.2s}
    .modal-close:hover{background:rgba(255,255,255,.10);color:#fff}
    .modal-body{padding:20px;overflow:auto;flex:1}

    /* 人格选择卡片 */
    .persona-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
    .persona-card{
      border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.04);color:var(--text-light)
    }
    .persona-card:hover{border-color:var(--primary);background:rgba(157,126,168,.10);transform:translateY(-2px)}
    .persona-card.selected{border-color:var(--primary);background:rgba(157,126,168,.18)}
    .persona-card .title{font-weight:800;color:#fff;margin-bottom:6px}
    .persona-card .desc{font-size:.9rem;color:var(--text-muted);line-height:1.4}

    /* 问题输入区 */
    .question-input-wrap{display:flex;gap:10px;margin-top:16px}
    .question-input{
      flex:1;border:1px solid var(--border);border-radius:12px;padding:10px 14px;font-size:1rem;outline:none;transition:.2s;background:rgba(255,255,255,.06);color:#fff;
    }
    .question-input:focus{border-color:var(--primary)}
    .btn-start{
      background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;border:1px solid var(--border);
      border-radius:12px;padding:10px 24px;font-weight:800;cursor:pointer;transition:.2s;box-shadow:0 6px 16px rgba(0,0,0,.2)
    }
    .btn-start:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(157,126,168,.35)}

    /* 全牌阵展示网格 */
    .spread-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;padding:10px}
    .spread-cell{
      border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.04);transition:all .2s;color:var(--text-light)
    }
    .spread-cell:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.25);border-color:rgba(255,255,255,.25)}
    .spread-cell img{width:100%;height:180px;object-fit:cover;border-radius:10px;border:1px solid var(--border);margin-bottom:8px;background:#0f0d18}
    .spread-cell .position{font-size:.85rem;color:var(--gold-light);font-weight:800;margin-bottom:4px}
    .spread-cell .card-name{font-weight:800;color:#fff;margin-bottom:2px}
    .spread-cell .direction{font-size:.9rem;color:var(--gold-light)}

    /* 响应式 */
    @media (max-width:1024px){
      .spread-display{position:absolute;left:0;top:0;bottom:0;z-index:4;width:320px}
      .spread-display.collapsed{margin-left:-320px}
      .toggle-spread{left:320px}
      .spread-display.collapsed + .toggle-spread{left:0}
    }
    @media (max-width:768px){
      .chat-header{padding:10px 12px;gap:8px}
      .back-button span{display:none}
      .phase-info{flex:1;justify-content:center}
      .phase-pill{font-size:.85rem;padding:4px 10px}
      .progress-wrap{display:none}
      .messages-area{padding:12px;gap:10px}
      .message-content{max-width:90%;padding:10px 14px;font-size:.95rem}
      .message-avatar{width:32px;height:32px}
      .input-area{padding:12px}
      .message-input{font-size:16px;padding:10px 14px}
      .send-button{width:44px;height:44px}
      .quick-questions{padding:0 12px;gap:8px}
      .quick-question{font-size:.9rem;padding:8px 14px}
      .sys-card{padding:12px;font-size:.95rem}
      .sys-actions{flex-direction:column;width:100%}
      .btn-confirm,.btn-outline{width:100%;padding:10px}
      .card-bubble{padding:12px;gap:12px}
      .card-bubble img{width:70px;height:114px}
      .card-meta .name{font-size:1rem}
      .card-meta .pos,.card-meta .meaning{font-size:.85rem}
      .modal-panel{
        width:95vw;max-height:90vh;border-radius:16px 16px 0 0;position:fixed;bottom:0;top:auto;transform:translateX(-50%);
      }
      .modal-header{padding:16px}
      .modal-title{font-size:1.1rem}
      .modal-body{padding:16px}
      .persona-grid{gap:10px}
      .persona-card{padding:12px}
      .persona-card .title{font-size:.95rem}
      .persona-card .desc{font-size:.85rem}
      .question-input-wrap{flex-direction:column}
      .question-input,.btn-start{width:100%}
      .btn-start{padding:12px}
      .spread-display{width:100%;max-width:100%;padding:20px}
      .spread-display.collapsed{margin-left:-100%}
      .toggle-spread{left:auto;right:10px;top:auto;bottom:80px;width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.2);border:none}
      .toggle-spread:hover{background:linear-gradient(135deg,var(--primary),var(--secondary))}
      .spread-display.collapsed + .toggle-spread{left:auto;right:10px}
      .spread-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;padding:8px}
      .spread-cell{padding:10px}
      .spread-cell img{height:160px}
    }
    @media (max-width:480px){
      .chat-header{padding:8px 10px}
      .phase-pill{font-size:.8rem;padding:3px 8px}
      .message-content{max-width:92%;padding:8px 12px;border-radius:16px;border-bottom-left-radius:4px}
      .message.user .message-content{border-bottom-right-radius:4px;border-bottom-left-radius:16px}
      .messages-area{padding:10px}
      .input-area{padding:10px}
      .message-input{padding:8px 12px;border-radius:18px}
      .send-button{width:40px;height:40px}
      .card-bubble img{width:60px;height:98px}
      .spread-grid{grid-template-columns:repeat(2,1fr)}
    }

    /* iOS 安全区域适配 */
    @supports (padding-bottom: env(safe-area-inset-bottom)){
      .input-area{padding-bottom:calc(12px + env(safe-area-inset-bottom))}
      .modal-panel{padding-bottom:env(safe-area-inset-bottom)}
    }

    /* 横屏窄高处理 */
    @media (max-height:500px) and (orientation:landscape){
      .chat-header{position:relative;padding:8px 12px}
      .messages-area{padding:8px}
      .message-content{max-width:70%;font-size:.9rem}
      .input-area{padding:8px 12px}
      .message-input{max-height:60px}
    }

    /* iOS 单层背景优化（避免 fixed 多层导致白屏） */
    @supports (-webkit-touch-callout: none) {
      .bg-veil,.bg-constellations,.bg-glyphs,.zodiac{display:none!important}
      .bg-stars{
        position:fixed!important;inset:0;height:100dvh;z-index:0;pointer-events:none;backface-visibility:hidden;animation:none;
        background:
          radial-gradient(820px 520px at 12% 14%, rgba(157,126,168,.26), transparent 60%),
          radial-gradient(760px 480px at 82% 72%, rgba(232,212,162,.20), transparent 60%),
          radial-gradient(920px 580px at 58% 12%, rgba(157,126,168,.16), transparent 72%),
          radial-gradient(1px 1px at 12% 25%, rgba(255,255,255,.95), transparent),
          radial-gradient(1px 1px at 32% 60%, rgba(255,255,255,.95), transparent),
          radial-gradient(1px 1px at 62% 30%, rgba(255,255,255,.95), transparent),
          radial-gradient(1px 1px at 82% 70%, rgba(255,255,255,.95), transparent),
          radial-gradient(1px 1px at 22% 80%, rgba(255,255,255,.95), transparent),
          linear-gradient(135deg, #2d1b4e 0%, #1a1625 100%);
        background-repeat:repeat,repeat,repeat,repeat,repeat,repeat,repeat,repeat,no-repeat;
        background-size:cover,cover,cover,220px 220px,220px 220px,220px 220px,220px 220px,220px 220px,cover;
      }
      html{background:#120c1d}
    }
  </style>
</head>
<body>
  <!-- 背景层（纯视觉） -->
  <div class="bg-stars"></div>
  <div class="bg-veil" aria-hidden="true"></div>
  <svg class="bg-constellations" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-hidden="true">
    <g>
      <line x1="90" y1="120" x2="160" y2="160"/><line x1="160" y1="160" x2="210" y2="110"/><line x1="160" y1="160" x2="110" y2="200"/>
      <circle cx="90" cy="120"/><circle cx="160" cy="160" style="animation-delay:.6s"/><circle cx="210" cy="110" style="animation-delay:1.2s"/><circle cx="110" cy="200" style="animation-delay:1.8s"/>
    </g>
    <g>
      <line x1="780" y1="120" x2="840" y2="160"/><line x1="840" y1="160" x2="900" y2="180"/><line x1="900" y1="180" x2="950" y2="150"/>
      <circle cx="780" cy="120"/><circle cx="840" cy="160" style="animation-delay:.8s"/><circle cx="900" cy="180" style="animation-delay:1.4s"/><circle cx="950" cy="150" style="animation-delay:2s"/>
    </g>
    <g>
      <line x1="760" y1="740" x2="820" y2="780"/><line x1="820" y1="780" x2="880" y2="740"/><line x1="820" y1="780" x2="840" y2="840"/>
      <circle cx="760" cy="740"/><circle cx="820" cy="780" style="animation-delay:.7s"/><circle cx="880" cy="740" style="animation-delay:1.3s"/><circle cx="840" cy="840" style="animation-delay:1.9s"/>
    </g>
  </svg>
  <div class="bg-glyphs" aria-hidden="true"></div>
  <svg class="zodiac" viewBox="0 0 100 100" aria-hidden="true">
    <g fill="none" stroke="#fff" stroke-opacity=".7" stroke-width=".3">
      <circle cx="50" cy="50" r="44"/><circle cx="50" cy="50" r="34" stroke-opacity=".4"/>
      <g stroke-opacity=".25"><line x1="50" y1="6" x2="50" y2="94"/><line x1="6" y1="50" x2="94" y2="50"/><line x1="18" y1="18" x2="82" y2="82"/><line x1="18" y1="82" x2="82" y2="18"/></g>
    </g>
  </svg>

  <!-- 顶部导航 -->
  <div class="chat-header">
    <a class="back-button" href="{{ url_for('spread') }}">
      <i class="fas fa-arrow-left"></i><span>返回</span>
    </a>

    <div class="phase-info">
      <div id="phase-pill" class="phase-pill phase-GUIDE">引导中</div>
      <div class="progress-wrap">
        <span id="progress-text">0 / 0</span>
        <div id="slots" class="slots"></div>
      </div>
    </div>

    <div style="width:80px"></div>
  </div>

  <!-- 主容器 -->
  <div class="main-container">
    <!-- 左侧：牌阵展示（仅在DEEP_CHAT阶段显示） -->
    <div class="spread-display" id="spreadDisplay">
      <h2 class="spread-title" id="spread-title">牌阵展示</h2>
      <div class="spread-question" id="spread-question-display" style="display:none">
        <i class="fas fa-question-circle"></i>
        <span id="question-text"></span>
      </div>
      <div class="cards-layout" id="cards-layout"></div>
    </div>

    <!-- 左侧开关按钮 -->
    <div class="toggle-spread" id="toggleSpread" onclick="toggleSpreadDisplay()">
      <i class="fas fa-chevron-left" id="toggleIcon"></i>
    </div>

    <!-- 右侧：聊天 -->
    <div class="chat-container">
      <div class="messages-area" id="messages-area"></div>
      <div id="quick-questions" class="quick-questions hidden"></div>

      <div class="input-area">
        <div class="input-container">
          <textarea class="message-input" id="message-input" rows="1" maxlength="500"
            placeholder="说说你想咨询的主题，或直接向占卜师发问…（Shift+Enter 换行）"></textarea>
          <button class="send-button" id="send-button" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 人格选择 Modal（URL未带persona_id时出现） -->
  <div id="persona-modal" class="modal-backdrop-custom">
    <div class="modal-panel">
      <div class="modal-header">
        <h5 class="modal-title">选择你的占卜师风格</h5>
        <button class="modal-close" onclick="closePersonaModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="persona-grid">
          <div class="persona-card" onclick="pickPersona('warm')">
            <div class="title"><i class="fas fa-heart"></i> 温柔疗愈</div>
            <div class="desc">共情、安抚、注重情绪复原与支持</div>
          </div>
          <div class="persona-card" onclick="pickPersona('wisdom')">
            <div class="title"><i class="fas fa-book"></i> 理性分析</div>
            <div class="desc">结构化、要点化、行动导向</div>
          </div>
          <div class="persona-card" onclick="pickPersona('mystic')">
            <div class="title"><i class="fas fa-moon"></i> 神秘直觉</div>
            <div class="desc">仪式感与灵感，简短有力</div>
          </div>
        </div>
        <div class="question-input-wrap">
          <input id="pref-question" class="question-input" placeholder="（可选）这次想咨询什么？"/>
          <button class="btn-start" onclick="confirmPersona()">开始占卜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 查看全牌阵 Modal -->
  <div id="spread-modal" class="modal-backdrop-custom">
    <div class="modal-panel" style="width:min(900px,95vw)">
      <div class="modal-header">
        <h5 class="modal-title">本次牌阵全览</h5>
        <div style="display:flex;gap:10px">
          <button class="btn-outline" onclick="downloadReading()">
            <i class="fas fa-download"></i> 导出
          </button>
          <button class="modal-close" onclick="closeSpreadModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div id="spread-grid" class="spread-grid"></div>
      </div>
    </div>
  </div>

  <!-- ========================= 原有脚本：功能完全保留 ========================= -->
  <script>
    // ========================= 基本配置 =========================
    const API = {
        GUIDED_CHAT: '/api/guided/chat/send_daily' // 唯一入口（Chatflow）
    };
    const DEBUG = false;

    const state = {
        phase: 'GUIDE',             // GUIDE -> DRAWING -> INTERPRET -> DEEP_CHAT
        readingId: null,
        personaId: null,
        spreadId: null,
        spreadName: null,
        question: null,
        total: 0,
        progress: 0,
        positions: [],
        drawn: [],                  // {index, position_name, card_name, upright, image_url}
        candidateSetId: null,
        interpretShown: false       // 已经收到完整解读
    };

    // ========================= 工具函数 =========================
    function log(...args){ if(DEBUG) console.log(...args); }
    function escapeHtml(text){
        const m={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}; 
        return String(text||'').replace(/[&<>"']/g, s=>m[s]);
    }
    function stripThinkTags(s){
        if(!s) return '';
        // 去除 <think>, <details>, <summary>, <thinking> 等标签及其内容
        s = s.replace(/<(think|details|summary|thinking)\b[^>]*>[\s\S]*?<\/\1>/gi, '');
        s = s.replace(/<\/?(think|details|summary|thinking)\b[^>]*>/gi, '');
        // 去除 ```json ... ```
        s = s.replace(/```json\s*([\s\S]*?)```/gi, '$1');
        return s.trim();
    }
    function normalizeCompactTables(s){
        // 让 "| |------| |" 变为换行分隔线
        s = s.replace(/\|\s*\|([ :\-|]{3,})\|\s*/g, '|\n|$1|\n');
        // 常见一行挤压：空格+|+空格+| → 换行+|
        s = s.replace(/\s\|\s\|/g, '\n|');
        return s;
    }

    // 格式化AI消息 - 与 spread_chat 保持一致
    function formatAIMessage(content){
        let text = String(content || '').replace(/\r\n/g,'\n');
        
        // 先清理指令标签
        text = stripThinkTags(text);

        // ===== 0) 代码块：先摘走，再统一转义其他部分 =====
        const fences = [];
        text = text.replace(/```([a-zA-Z0-9_+\-]*)\n([\s\S]*?)```/g, (m, lang, body) => {
            const id = `__FENCE_${fences.length}__`;
            fences.push(
                `<pre><code class="language-${(lang||'plaintext').toLowerCase()}">${escapeHtml(body)}</code></pre>`
            );
            return id;
        });

        // ===== 0.1) 表格容错：把"挤在一行"的表格修成多行 =====
        text = normalizeCompactTables(text);

        // ===== 1) 统一转义（安全基线）=====
        text = escapeHtml(text);

        // ===== 2) 标题 (# .. ######) =====
        text = text.replace(/^\s*(#{1,6})[ \t\u00A0\u3000]+(.+)$/gm, (m, hs, t) => {
            const lvl = Math.min(hs.length, 6);
            return `<h${lvl}>${t.trim()}</h${lvl}>`;
        });

        // ===== 3) 水平线 ---- =====
        text = text.replace(/^\s*---+\s*$/gm, '<hr>');

        // ===== 4) 多行引用（> ...）合并为一个 blockquote =====
        text = text.replace(/(?:^|\n)(?:&gt;\s?.*(?:\n|$))+?/g, (block) => {
            const inner = block.replace(/(^|\n)&gt;\s?/g, '$1').trim();
            return `\n<blockquote>${inner.replace(/\n/g,'<br>')}</blockquote>\n`;
        });

        // ===== 5) 行内代码 `code`
        text = text.replace(/`([^`]+)`/g, (m, code) => `<code>${code}</code>`);

        // ===== 6) 强/斜体
        text = text
            .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/___(.+?)___/g, '<strong><em>$1</em></strong>')
            .replace(/__(.+?)__/g, '<strong>$1</strong>')
            .replace(/_(.+?)_/g, '<em>$1</em>');

        // ===== 7) 链接
        text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
            '<a href="$2" target="_blank" rel="noopener noreferrer nofollow">$1</a>');

        // ===== 8) 任务清单
        text = text.replace(
            /^\s*[-*+]\s+\[( |x|X)\]\s+(.+)$/gm,
            (m, chk, body) => `<li data-task="1"><input type="checkbox" disabled ${/x/i.test(chk)?'checked':''}> ${body}</li>`
        );
        text = text.replace(/(?:^(?:<li data-task="1">.*<\/li>\n?)+)/gms, (block) => {
            return `<ul class="task-list">${block.replace(/ data-task="1"/g,'').trim()}</ul>\n`;
        });

        // ===== 9) 列表
        text = text
            .replace(/^\s*(\d+)\.\s+(.+)$/gm, (m, n, item) => `<li data-ol="1">${item}</li>`)
            .replace(/^\s*[-*+]\s+(.+)$/gm, (m, item) => `<li data-ul="1">${item}</li>`);

        text = text.replace(/(?:^(?:<li[^>]*>.*<\/li>\n?)+)/gms, (block) => {
            const isOl = /<li[^>]*data-ol="1"/.test(block) && !/<li[^>]*data-ul="1"/.test(block);
            const clean = block.replace(/ data-(ol|ul)="1"/g, '');
            return (isOl ? `<ol>${clean.trim()}</ol>` : `<ul>${clean.trim()}</ul>`) + '\n';
        });

        // ===== 10) 表格
        text = text.replace(
            /(?:^|\n)\|([^\n|]+(?:\|[^\n|]+)+)\|\n\|([ :\-|]+)\|\n((?:\|[^\n|]+(?:\|[^\n|]+)+\|\n?)+)/g,
            (m, header, sep, rows) => {
                const ths = header.split('|').map(s => `<th>${s.trim()}</th>`).join('');
                const trs = rows.trim().split('\n').map(r => {
                    const tds = r.replace(/^\||\|$/g,'')
                                 .split('|').map(s => `<td>${s.trim()}</td>`).join('');
                    return `<tr>${tds}</tr>`;
                }).join('');
                return `\n<table class="markdown-table"><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>\n`;
            }
        );

        // ===== 11) 段落包裹
        const parts = text.split(/\n{2,}/).map(seg => {
            const s = seg.trim();
            if (!s) return '';
            if (/^<(h\d|blockquote|hr|ul|ol|table|pre)/i.test(s)) return s;
            return `<p>${s.replace(/\n/g,'<br>')}</p>`;
        }).filter(Boolean);

        let html = parts.join('\n');

        // ===== 12) 回填代码块
        fences.forEach((codeHtml, i) => {
            html = html.replace(`__FENCE_${i}__`, codeHtml);
        });

        // ===== 13) 清理包裹
        html = html.replace(/<p><(h\d|blockquote|hr|ul|ol|table|pre)/g,'<$1')
                   .replace(/<\/(h\d|blockquote|hr|ul|ol|table|pre)><\/p>/g,'</$1>');

        return html;
    }

    function personaIcon(){
        if(state.personaId==='mystic') return '<i class="fas fa-moon"></i>';
        if(state.personaId==='wisdom') return '<i class="fas fa-book"></i>';
        return '<i class="fas fa-heart"></i>';
    }

    // 指令解析：抽取第一个 {...}
    function extractFirstJson(str){
        if(!str) return '';
        // 优先找 ```json 块
        const m = str.match(/```json\s*([\s\S]*?)```/i);
        if(m && m[1]) return m[1].trim();
        // 再找第一个 { 到配对 }
        let i = str.indexOf('{'); if(i<0) return '';
        let lvl=0, out=''; let inStr=false, prev=''; 
        for(let k=i;k<str.length;k++){
            const ch=str[k];
            if(ch === '"' && prev !== '\\') inStr = !inStr;
            if(!inStr){
                if(ch==='{' ) lvl++;
                if(ch==='}') lvl--;
            }
            out+=ch; prev=ch;
            if(!inStr && lvl===0) break;
        }
        return out;
    }
    
    
    // 剥离指令块，防止出现在可见文本中（兼容 [[CARD*DRAWN]] / [[SPREAD-SELECTED]] 等）
    function stripDirectiveBlocks(s){
      const re = /\[\[\s*(SPREAD\W*SELECTED|CARD\W*DRAWN)\s*\]\]\s*{[\s\S]*?}(?=\s*(?:\[\[|$))/gi;
      return String(s||'').replace(re,'').replace(/\n{3,}/g,'\n\n').trim();
    }

    // 仅规范 JSON 键名中的星号；不改值
    function normalizeJsonKeys(jsonText){
      return String(jsonText||'').replace(/\*/g, '_');
    }

    // 兼容各种分隔符/大小写/多行；可解析多段指令
    function tryParseDirectiveBlocks(text){
      const res = {spreads: [], cards: []};
      if(!text) return res;

      const blockRe = /\[\[\s*(SPREAD\W*SELECTED|CARD\W*DRAWN)\s*\]\][\s\S]*?(?=(?:\n{2,}|\[\[|$))/gi;
      const blocks = String(text).match(blockRe) || [];

      for(const b of blocks){
        const isSpread = /\bSPREAD\W*SELECTED\b/i.test(b);
        const jsonRaw = extractFirstJson(b);
        if(!jsonRaw) continue;
        const jsonClean = normalizeJsonKeys(jsonRaw);
        try{
          const obj = JSON.parse(jsonClean);
          (isSpread ? res.spreads : res.cards).push(obj);
        }catch(e){ log('parse directive fail', e, jsonClean); }
      }
      return res;
    }


    // ========================= 渲染与状态 =========================
    function appendMessage(role, raw, asAIFormat){
        const area = document.getElementById('messages-area');
        const wrap = document.createElement('div');
        wrap.className = `message ${role}`;
        const avatar = document.createElement('div'); 
        avatar.className='message-avatar';
        avatar.innerHTML = role==='user' ? '<i class="fas fa-user"></i>' : personaIcon();
        const cont = document.createElement('div'); 
        cont.className='message-content';
        
        // 处理HTML内容（系统卡片等）
        if(role==='assistant' && !asAIFormat && raw.includes('<div')){
            cont.innerHTML = raw;
        } else {
            cont.innerHTML = (role==='assistant' && asAIFormat) ? formatAIMessage(raw) : escapeHtml(String(raw||''));
        }
        
        wrap.appendChild(avatar); 
        wrap.appendChild(cont); 
        area.appendChild(wrap);
        setTimeout(()=>{ area.scrollTop = area.scrollHeight; }, 50);
        
        // 如果当前在 INTERPRET 阶段，收到了助手文本，切到 DEEP_CHAT 并展示快捷问
        if(role==='assistant' && state.phase==='INTERPRET' && !state.interpretShown){
            state.interpretShown = true;
            updatePhase('DEEP_CHAT');
            showQuickQuestions();
            showSpreadPanel();
        }
    }

    function showTyping(){
        const area=document.getElementById('messages-area');
        const t=document.createElement('div'); 
        t.id='typing-indicator'; 
        t.className='message assistant typing-indicator';
        t.innerHTML=`<div class="message-avatar">${personaIcon()}</div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>`;
        area.appendChild(t); 
        area.scrollTop=area.scrollHeight;
    }
    
    function hideTyping(){ 
        const t=document.getElementById('typing-indicator'); 
        if(t) t.remove(); 
    }

    function updatePhase(p){
        state.phase = p;
        const pill = document.getElementById('phase-pill');
        pill.className = `phase-pill phase-${p}`;
        pill.textContent = p==='GUIDE'?'引导中':(p==='DRAWING'?'抽牌中':(p==='INTERPRET'?'完整解读':'交流中'));
    }
    
    function renderSlots(){
        const box=document.getElementById('slots'); 
        box.innerHTML='';
        const n = Number(state.total)||0, done = Number(state.progress)||0;
        for(let i=1;i<=n;i++){
            const s=document.createElement('div'); 
            s.className='slot'+(i<=done?' done':''); 
            s.textContent=i; 
            box.appendChild(s);
        }
        document.getElementById('progress-text').textContent = `${done} / ${n}`;
    }

    function renderSpreadConfirm(spread){
        // spread: {spread_id, spread_name, question, positions?, card_count?, candidate_set_id?}
        const html = `
            <div class="sys-card">
                <div class="sys-title">已选牌阵：${escapeHtml(spread.spread_name||'（未命名牌阵）')}</div>
                ${spread.question?`<div style="color:var(--text-muted);margin-bottom:8px">问题：${escapeHtml(spread.question)}</div>`:''}
                ${Array.isArray(spread.positions)?`<div style="font-size:.9rem;color:var(--text-muted);margin-top:6px">位义：${spread.positions.map(p=>escapeHtml(p.name||p.title||p)).join(' / ')}</div>`:''}
                <div class="sys-actions">
                    <button class="btn-confirm" onclick='confirmSpread(${JSON.stringify(spread).replace(/'/g,"&#39;").replace(/"/g,"&quot;")})'><i class="fas fa-check"></i> 确认并开始抽牌</button>
                    <button class="btn-outline" onclick='requestChangeSpread()'><i class="fas fa-random"></i> 换一个</button>
                </div>
            </div>`;
        appendMessage('assistant', html, false);
    }

    
    function normalizeIndex(v, fallback){
      let n = Number(v);
      if(!Number.isFinite(n)) n = Number(fallback);
      if(!Number.isFinite(n)) n = 1;
      if(n <= 0) n = 1; // 0 视为第一张
      return Math.floor(n);
    }

    function applyDrawnCard(c){
      const idx = normalizeIndex(c.index ?? c.index_1, state.progress + 1);
      state.progress = Math.max(state.progress, idx);

      const item = {
        index: idx,
        position_name: c.position_name || '',
        card_name: c.card_name || '',
        upright: (typeof c.upright==='boolean') ? c.upright : String(c.direction||'').includes('正'),
        image_url: c.image_url || c.image || '',
        short_meaning: c.short_meaning || ''
      };

      // 去重：同 index 覆盖更新
      const at = state.drawn.findIndex(x => Number(x.index) === idx);
      if(at >= 0) state.drawn[at] = item; else state.drawn.push(item);

      // 稳定排序
      state.drawn.sort((a,b) => Number(a.index) - Number(b.index));

      renderSlots();
      renderCardBubble(item);
    }

    function renderCardBubble(card){
        // card: {index(展示1基), position_name, card_name, direction/upright, image_url|image, short_meaning?}
        const idx = normalizeIndex(card.index, state.progress||1);
        const upright = (typeof card.upright==='boolean') ? card.upright : (String(card.direction||'').includes('正'));
        const img = card.image_url || card.image || '';
        const html = `
            <div class="card-bubble">
                <img src="${escapeHtml(img)}" alt="${escapeHtml(card.card_name||'')}"/>
                <div class="card-meta">
                    <div class="pos">${escapeHtml(card.position_name||'')}｜第 ${idx} 张</div>
                    <div class="name">${escapeHtml(card.card_name||'')}（${upright?'正位':'逆位'}）</div>
                    ${card.short_meaning?`<div class="meaning">${escapeHtml(card.short_meaning)}</div>`:''}
                </div>
            </div>`;
        appendMessage('assistant', html, false);
    }


    // ========================= 网络交互 =========================
    let isTyping=false;
    async 
    let isTyping=false;
    async function sendMessage(overrideText=null, displayText=null){
        const input=document.getElementById('message-input');
        const msg=(typeof overrideText==='string') ? overrideText : (input?.value||'').trim();
        if(!msg||isTyping) return;

        // 只有手动输入时才清空输入框
        if(!(typeof overrideText==='string')){
          input.value=''; 
          input.style.height='auto';
        }

        // 隐藏快捷问题
        const quick = document.getElementById('quick-questions');
        if(quick) quick.classList.add('hidden');

        // 展示用文本可与发送文本不同
        const shown = (typeof displayText==='string') ? displayText : msg;
        appendMessage('user', shown, false);

        const payload = {
            message: msg,
            persona_id: state.personaId || undefined,
            reading_id: state.readingId || undefined,
            spread_id: state.spreadId || undefined,
            question: state.question || undefined
        };

        showTyping(); 
        isTyping=true;
        try{
            const r = await fetch(API.GUIDED_CHAT, {
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(payload), 
                cache:'no-store'
            });
            let data=null;
            try{ data = await r.json(); }catch(_){}
            hideTyping(); 
            isTyping=false;

            const text = (data && (data.reply||data.text||data.answer)) || '…';
            processAssistantReply(text);
        }catch(e){
            hideTyping(); 
            isTyping=false;
            appendMessage('assistant','抱歉，网络有点忙，请重试。',true);
            log(e);
        }
    }


    
    function processAssistantReply(text){
      // 1) 用户可见部分：移除所有 [[...]]{...} 指令块
      const visible = stripDirectiveBlocks(text);
      if(visible.trim()){
        appendMessage('assistant', visible, true);
      }

      // 2) 解析（用原始 text，保证不丢信号）
      const directives = tryParseDirectiveBlocks(text);

      // 2.1) 选阵确认（保持原有逻辑）
      if(directives.spreads.length){
        directives.spreads.forEach(sp=>{
          if(sp.spread_id) state.spreadId = sp.spread_id;
          if(sp.spread_name) state.spreadName = sp.spread_name;
          if(sp.card_count){ state.total = Number(sp.card_count)||0; renderSlots(); }
          if(sp.question && !state.question) state.question = sp.question;
          if(sp.reading_id) state.readingId = sp.reading_id;
          if(sp.candidate_set_id) state.candidateSetId = sp.candidate_set_id;
          if(Array.isArray(sp.positions)) state.positions = sp.positions;
          renderSpreadConfirm(sp);
        });
      }

      // 2.2) 单张翻牌
      if(directives.cards.length){
        if(state.phase!=='DRAWING') updatePhase('DRAWING');
        directives.cards.forEach(applyDrawnCard);
        if(state.total>0 && state.progress>=state.total){
          updatePhase('INTERPRET');
          appendMessage('assistant','全部抽完啦！我来整合完整解读…',true);
        }
      }
    }


    // 用户点击"确认并开始抽牌"
    async 
    async function confirmSpread(spread){
        // 让 Chatflow 知道这是确认操作，并传会话已知字段（candidate_set_id 可选）
        const token = {
            spread_id: spread.spread_id || state.spreadId,
            spread_name: spread.spread_name || state.spreadName || '',
            question: state.question || spread.question || '',
            candidate_set_id: state.candidateSetId || spread.candidate_set_id || ''
        };
        const payload = `[[SPREAD_SELECTED]] ${JSON.stringify(token)}`;
        await sendMessage(payload, '确认并开始抽牌 ✅');
    }


    function requestChangeSpread(){
        appendMessage('assistant','没问题，我们也可以换一个你更喜欢的牌阵～',true);
    }

    // ========================= 左侧牌阵面板 =========================
    function showSpreadPanel(){
        const panel = document.getElementById('spreadDisplay');
        const toggle = document.getElementById('toggleSpread');
        panel.classList.add('active');
        toggle.classList.add('active');
        
        // 更新标题和问题
        if(state.spreadName){
            document.getElementById('spread-title').textContent = state.spreadName;
        }
        if(state.question){
            const qBox = document.getElementById('spread-question-display');
            qBox.style.display = 'block';
            document.getElementById('question-text').textContent = state.question;
        }
        
        // 渲染牌阵
        renderSpreadCards();
    }

    
    function renderSpreadCards(){
        const layout = document.getElementById('cards-layout');
        layout.innerHTML = '';

        state.drawn.forEach((card, idxArr) => {
            const displayIdx = normalizeIndex(card.index, idxArr + 1);   // 展示用 1 基
            const posIdx = Math.max(0, displayIdx - 1);                  // 位义数组 0 基
            const cardEl = document.createElement('div');
            cardEl.className = 'card-position';
            cardEl.innerHTML = `
                <div class="position-number">${displayIdx}</div>
                <div class="position-info">
                    <div class="position-name">${escapeHtml(card.position_name||\`位置 \${displayIdx}\`)}</div>
                    <div class="position-meaning">${escapeHtml(state.positions[posIdx]?.meaning||'')}</div>
                    <div class="drawn-card">
                        <div class="card-image ${!card.upright?'reversed':''}">
                            ${card.image_url ? 
                                `<img src="${escapeHtml(card.image_url)}" alt="${escapeHtml(card.card_name)}"/>` :
                                '<i class="fas fa-star"></i>'
                            }
                        </div>
                        <div class="card-details">
                            <div class="card-name">${escapeHtml(card.card_name)}</div>
                            <div class="card-direction">${card.upright?'正位':'逆位'}</div>
                        </div>
                    </div>
                </div>
            `;
            layout.appendChild(cardEl);
        });
    }


    function toggleSpreadDisplay(){
        const panel=document.getElementById('spreadDisplay');
        const icon=document.getElementById('toggleIcon');
        panel.classList.toggle('collapsed');
        icon.className = panel.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
    }

    // ========================= 交互与快捷问 =========================
    function showQuickQuestions(){
        const box=document.getElementById('quick-questions'); 
        box.classList.remove('hidden');
        box.innerHTML='';
        const qs=['整体建议','我应该注意什么？','下一步该怎么做？','查看完整牌阵'];
        qs.forEach(q=>{
            const el=document.createElement('div'); 
            el.className='quick-question'; 
            el.textContent=q;
            el.onclick=()=>{ 
                if(q === '查看完整牌阵'){
                    openSpreadModal();
                } else {
                    const input=document.getElementById('message-input'); 
                    input.value=q; 
                    sendMessage(); 
                }
            };
            box.appendChild(el);
        });
    }

    // ========================= Persona 选择 =========================
    function openPersonaModal(){ 
        document.getElementById('persona-modal').classList.add('show'); 
    }
    function closePersonaModal(){ 
        document.getElementById('persona-modal').classList.remove('show'); 
    }
    function pickPersona(id){ 
        state.personaId=id; 
        // 更新选中状态
        document.querySelectorAll('.persona-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
    }
    async function confirmPersona(){
        if(!state.personaId) state.personaId='warm';
        const v = document.getElementById('pref-question').value.trim();
        if(v) state.question = v;
        closePersonaModal();

        const hello = state.question ? `你好，我想咨询：${state.question}` : '你好，我们开始吧。';
        appendMessage('user', hello, false);
        await sendFirstHello(hello);
    }

    async function sendFirstHello(msg){
        showTyping(); 
        isTyping=true;
        try{
            const r = await fetch(API.GUIDED_CHAT, {
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    message: msg, 
                    persona_id: state.personaId,
                    spread_id: state.spreadId || undefined,
                    question: state.question || undefined
                }),
                cache:'no-store'
            });
            let data=null; 
            try{ data=await r.json(); }catch(_){}
            hideTyping(); 
            isTyping=false;
            const text = (data && (data.reply||data.text||data.answer)) || '…';
            processAssistantReply(text);
        }catch(e){
            hideTyping(); 
            isTyping=false;
            appendMessage('assistant','抱歉，网络有点忙，请重试。',true);
        }
    }

    // ========================= 全牌阵查看与导出 =========================
    function openSpreadModal(){ 
        document.getElementById('spread-modal').classList.add('show'); 
        renderSpreadGrid(); 
    }
    function closeSpreadModal(){ 
        document.getElementById('spread-modal').classList.remove('show'); 
    }
    function renderSpreadGrid(){
        const grid=document.getElementById('spread-grid'); 
        grid.innerHTML='';
        state.drawn.forEach(c=>{
            const cell=document.createElement('div'); 
            cell.className='spread-cell';
            cell.innerHTML = `
                <div class="position">${escapeHtml(c.position_name||'')}</div>
                <img src="${escapeHtml(c.image_url||'')}" alt="${escapeHtml(c.card_name||'')}">
                <div class="card-name">${escapeHtml(c.card_name||'')}</div>
                <div class="direction">${c.upright?'正位':'逆位'}</div>`;
            grid.appendChild(cell);
        });
    }
    
    function downloadReading(){
        const data = {
            reading_id: state.readingId,
            persona: state.personaId,
            question: state.question,
            spread_id: state.spreadId,
            spread_name: state.spreadName,
            total: state.total,
            cards: state.drawn
        };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a=document.createElement('a'); 
        a.href=URL.createObjectURL(blob); 
        a.download=`reading_${state.readingId||'draft'}.json`; 
        a.click();
    }

    // ========================= 输入框与初始化 =========================
    function bindInputEvents(){
        const input=document.getElementById('message-input');
        input.addEventListener('input', function(){ 
            this.style.height='auto'; 
            this.style.height=Math.min(this.scrollHeight,120)+'px'; 
        });
        input.addEventListener('keydown', function(e){ 
            if(e.key==='Enter' && !e.shiftKey){ 
                e.preventDefault(); 
                sendMessage(); 
            }
        });
        document.getElementById('send-button').addEventListener('click', sendMessage);
    }
    
    function getQuery(){ 
        const p = new URLSearchParams(location.search); 
        return Object.fromEntries(p.entries()); 
    }

    async function init(){
        bindInputEvents();
        const q = getQuery();
        state.personaId = q.persona_id || null;
        state.spreadId  = q.spread_id  || null;
        state.question  = q.question   || null;
        updatePhase('GUIDE'); 
        renderSlots();

        if(!state.personaId){ 
            openPersonaModal(); 
            return; 
        }

        appendMessage('assistant','你好，我是你的占卜师～先简单聊聊你的诉求，我会为你推荐合适的牌阵。',true);
        if(state.question){ 
            appendMessage('user', `我本次的问题：${state.question}`, false); 
        }
        await sendFirstHello(state.question?`我想咨询：${state.question}`:'我们开始吧');
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
