<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>引导式牌阵占卜</title>

  <!-- 与现有项目一致的样式依赖 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}"/>

  <style>
    :root{
      --primary:#8e6c88; --primary-ink:#fff;
      --accent:#6d4c67; --bg:#f8f4e9; --ink:#333; --muted:#6b7280;
      --card:#fff; --border:#e5e7eb; --shadow:0 10px 24px rgba(0,0,0,.05);
    }
    html,body{height:100%;background:var(--bg);color:var(--ink)}
    .page{max-width:1024px;margin:0 auto;padding:16px}

    .chat-header{display:flex;align-items:center;gap:12px;margin:6px 0 12px}
    .phase-pill{padding:6px 12px;border-radius:999px;font-weight:700;border:1px solid var(--border);background:#fff}
    .phase-GUIDE{color:#374151}
    .phase-DRAWING{color:var(--primary)}
    .phase-INTERPRET{color:#b45309;border-style:dashed}
    .phase-DEEP_CHAT{color:#1e3a8a;background:#e7f5ff}

    .progress-wrap{display:flex;align-items:center;gap:10px;margin-left:auto}
    .slots{display:flex;gap:6px}
    .slot{width:20px;height:20px;border-radius:4px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;color:#9ca3af}
    .slot.done{background:var(--primary);border-color:var(--primary);color:#fff}
    #progress-text{color:var(--muted);font-size:.9rem}

    .chat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .messages{height:64vh;overflow:auto;padding:16px;scroll-behavior:smooth}
    .message{display:flex;gap:12px;margin:12px 0}
    .message-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#f4f4f5;color:#6b7280}
    .message.user .message-avatar{background:#6366f1;color:#fff}
    .message.assistant .message-avatar{background:var(--primary);color:var(--primary-ink)}
    .message-content{flex:1;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .message.assistant .message-content{background:linear-gradient(180deg,#fff,#fdf8ff)}

    .typing{display:flex;align-items:center;gap:10px;margin:6px 0}
    .typing-dots{display:flex;gap:6px}
    .typing-dot{width:7px;height:7px;background:#cbd5e1;border-radius:50%;animation:blink 1.1s infinite ease-in-out}
    .typing-dot:nth-child(2){animation-delay:.15s}
    .typing-dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,100%{opacity:.2;transform:translateY(0)}50%{opacity:1;transform:translateY(-2px)}}

    .input-area{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border)}
    .input-area textarea{flex:1;resize:none;min-height:48px;max-height:160px;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff}
    .send-btn{background:var(--primary);border:none;color:#fff;border-radius:10px;padding:0 16px;font-weight:700}
    .send-btn:disabled{opacity:.6}

    .quick-questions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:10px auto 14px;max-width:820px}
    .quick-question{background:#fff;border:1px solid var(--border);border-radius:999px;padding:9px 14px;font-weight:600;font-size:.95rem;cursor:pointer;transition:.2s}
    .quick-question:hover{background:var(--primary);color:#fff;transform:translateY(-2px);box-shadow:0 8px 18px rgba(142,108,136,.25)}

    .sys-card{border:1px dashed var(--border);border-radius:14px;background:#fafafa;padding:12px}
    .sys-title{font-weight:800;color:#374151;margin-bottom:6px}
    .sys-actions{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
    .btn-outline{border:1px solid var(--primary);color:var(--primary);background:#fff;border-radius:10px;padding:6px 12px}

    .card-bubble{display:flex;gap:12px;align-items:flex-start}
    .card-bubble img{width:86px;height:140px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#fff}
    .card-meta{font-size:.9rem;color:var(--muted)}
    .card-meta .name{font-weight:800;color:#374151}
    .card-meta .pos{font-weight:700;color:var(--accent)}

    .modal-backdrop-custom{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none}
    .modal-panel{position:fixed;inset:auto 0 0 auto;width:min(980px,96vw);height:min(84vh,96vh);background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -12px 32px rgba(0,0,0,.2);transform:translateY(100%);transition:.25s}
    .modal-backdrop-custom.show{display:block}
    .modal-backdrop-custom.show .modal-panel{transform:none}
    .spread-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;padding:10px}
    .spread-cell{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .spread-cell img{width:100%;height:180px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}

    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="page">
    <div class="chat-header">
      <div id="phase-pill" class="phase-pill phase-GUIDE">引导中</div>
      <div class="progress-wrap">
        <span id="progress-text">0 / 0</span>
        <div id="slots" class="slots"></div>
      </div>
    </div>

    <div class="chat-card">
      <div id="messages-area" class="messages"></div>
      <div class="input-area">
        <textarea id="message-input" placeholder="说说你想咨询的主题，或直接向占卜师发问…（Shift+Enter 换行）"></textarea>
        <button id="send-btn" class="send-btn"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>

    <div id="quick-questions" class="quick-questions hidden"></div>
  </div>

  <!-- 人格选择 Modal（URL 未带 persona_id 时出现） -->
  <div id="persona-modal" class="modal-backdrop-custom">
    <div class="modal-panel p-3">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="m-0">选择你的占卜师风格</h5>
        <button class="btn btn-sm btn-light" onclick="closePersonaModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-6 col-md-4">
          <div class="p-3 border rounded-3 h-100" role="button" onclick="pickPersona('warm')">
            <div class="fw-bold">温柔疗愈</div>
            <div class="small text-muted mt-1">共情、安抚、注重情绪复原与支持</div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="p-3 border rounded-3 h-100" role="button" onclick="pickPersona('wisdom')">
            <div class="fw-bold">理性分析</div>
            <div class="small text-muted mt-1">结构化、要点化、行动导向</div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="p-3 border rounded-3 h-100" role="button" onclick="pickPersona('mystic')">
            <div class="fw-bold">神秘直觉</div>
            <div class="small text-muted mt-1">仪式感与灵感，简短有力</div>
          </div>
        </div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <input id="pref-question" class="form-control" placeholder="（可选）这次想咨询什么？"/>
        <button class="btn btn-primary" onclick="confirmPersona()">开始</button>
      </div>
    </div>
  </div>

  <!-- 查看全牌阵 Modal -->
  <div id="spread-modal" class="modal-backdrop-custom">
    <div class="modal-panel">
      <div class="d-flex align-items-center justify-content-between p-3 border-bottom">
        <div class="fw-bold">本次牌阵</div>
        <div>
          <button class="btn btn-sm btn-outline-secondary" onclick="downloadReading()"><i class="fas fa-download"></i> 导出</button>
          <button class="btn btn-sm btn-light" onclick="closeSpreadModal()"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="spread-grid" class="spread-grid"></div>
    </div>
  </div>

  <script>
    // ========================= 基本配置 =========================
    const API = {
      GUIDED_CHAT: '/api/guided/chat/send' // 唯一入口（Chatflow）
    };
    const DEBUG = false; // 打开以便 console 调试

    const state = {
      phase: 'GUIDE',             // GUIDE -> DRAWING -> INTERPRET -> DEEP_CHAT
      readingId: null,
      personaId: null,
      spreadId: null,
      question: null,
      total: 0,
      progress: 0,
      positions: [],
      drawn: [],                  // {index, position_name, card_name, upright, image_url}
      candidateSetId: null,
      interpretShown: false       // 已经收到完整解读
    };

    // ========================= 工具函数 =========================
    function log(...args){ if(DEBUG) console.log(...args); }
    function escapeHtml(text){
      const m={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}; return String(text||'').replace(/[&<>"']/g, s=>m[s]);
    }
    function stripThinkTags(s){
      if(!s) return '';
      // 去除 <think>, <details>, <summary>, <thinking> 等标签及其内容
      s = s.replace(/<(think|details|summary|thinking)\b[^>]*>[\s\S]*?<\/\1>/gi, '');
      s = s.replace(/<\/?(think|details|summary|thinking)\b[^>]*>/gi, '');
      // 去除 ```json ... ```
      s = s.replace(/```json\s*([\s\S]*?)```/gi, '$1');
      return s.trim();
    }
    function normalizeCompactTables(text){
      return String(text||'').replace(/(^|\n)\s*\|[^\n]*\|\s*(?=\n|$)/g, m=>`\n${m}\n`);
    }
    function formatAIMessage(content){
      let text = stripThinkTags(String(content||'').replace(/\r\n/g,'\n'));
      const fences=[];
      text = text.replace(/```([a-zA-Z0-9_+\-]*)\n([\s\S]*?)```/g,(m,lang,body)=>{
        const id=`__FENCE_${fences.length}__`;
        fences.push(`<pre><code class="language-${(lang||'plaintext').toLowerCase()}">${escapeHtml(body)}</code></pre>`);
        return id;
      });
      text = normalizeCompactTables(text);
      text = escapeHtml(text)
        .replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>')
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.+?)\*/g,'<em>$1</em>')
        .replace(/`([^`]+)`/g,'<code>$1</code>')
        .replace(/\[(.*?)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer nofollow">$1</a>')
        .replace(/^>\s?(.+)$/gm,'<blockquote>$1</blockquote>')
        .replace(/^\s*[-*+]\s+(.+)$/gm,'<li>$1</li>')
        .replace(/^(\d+)\.\s+(.+)$/gm,'<li>$1. $2</li>');
      text = text.replace(/(__FENCE_\d+__)/g,m=>fences[Number(m.match(/\d+/)[0])]||m)
                 .replace(/(?:^|\n)(<li>.*?<\/li>)(?=\n|$)/gs,'\n<ul>$1</ul>');
      return text;
    }
    function personaIcon(){
      if(state.personaId==='mystic') return '<i class="fas fa-moon"></i>';
      if(state.personaId==='wisdom') return '<i class="fas fa-book"></i>';
      return '<i class="fas fa-heart"></i>';
    }

    // 指令解析：抽取第一个 {...}
    function extractFirstJson(str){
      if(!str) return '';
      // 优先找 ```json 块
      const m = str.match(/```json\s*([\s\S]*?)```/i);
      if(m && m[1]) return m[1].trim();
      // 再找第一个 { 到配对 }
      let i = str.indexOf('{'); if(i<0) return '';
      let lvl=0, out=''; let inStr=false, prev=''; 
      for(let k=i;k<str.length;k++){
        const ch=str[k];
        if(ch === '"' && prev !== '\\') inStr = !inStr;
        if(!inStr){
          if(ch==='{' ) lvl++;
          if(ch==='}') lvl--;
        }
        out+=ch; prev=ch;
        if(!inStr && lvl===0) break;
      }
      return out;
    }
    function tryParseDirectiveBlocks(text){
      const res = { spreads:[], cards:[] };
      const clean = String(text||'');
      // 允许多个指令行
      const lines = clean.split('\n');
      for(const line of lines){
        if(line.includes('[[SPREAD_SELECTED]]')){
          const jsonText = extractFirstJson(line.slice(line.indexOf('[[SPREAD_SELECTED]]')+18));
          if(jsonText){ try{ res.spreads.push(JSON.parse(jsonText)); }catch(e){ log('parse SPREAD_SELECTED fail',e,jsonText); } }
        }
        if(line.includes('[[CARD_DRAWN]]')){
          const jsonText = extractFirstJson(line.slice(line.indexOf('[[CARD_DRAWN]]')+14));
          if(jsonText){ try{ res.cards.push(JSON.parse(jsonText)); }catch(e){ log('parse CARD_DRAWN fail',e,jsonText); } }
        }
      }
      return res;
    }

    // ========================= 渲染与状态 =========================
    function appendMessage(role, raw, asAIFormat){
      const area = document.getElementById('messages-area');
      const wrap = document.createElement('div');
      wrap.className = `message ${role}`;
      const avatar = document.createElement('div'); avatar.className='message-avatar';
      avatar.innerHTML = role==='user' ? '<i class="fas fa-user"></i>' : personaIcon();
      const cont = document.createElement('div'); cont.className='message-content';
      cont.innerHTML = (role==='assistant' && asAIFormat) ? formatAIMessage(raw) : escapeHtml(String(raw||''));
      wrap.appendChild(avatar); wrap.appendChild(cont); area.appendChild(wrap);
      setTimeout(()=>{ area.scrollTop = area.scrollHeight; }, 30);
      // 如果当前在 INTERPRET 阶段，收到了助手文本，切到 DEEP_CHAT 并展示快捷问
      if(role==='assistant' && state.phase==='INTERPRET' && !state.interpretShown){
        state.interpretShown = true;
        updatePhase('DEEP_CHAT');
        showQuickQuestions();
      }
    }
    function showTyping(){
      const area=document.getElementById('messages-area');
      const t=document.createElement('div'); t.id='typing-indicator'; t.className='typing';
      t.innerHTML=`<div class="message-avatar">${personaIcon()}</div>
        <div class="message-content"><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
      area.appendChild(t); area.scrollTop=area.scrollHeight;
    }
    function hideTyping(){ const t=document.getElementById('typing-indicator'); if(t) t.remove(); }

    function updatePhase(p){
      state.phase = p;
      const pill = document.getElementById('phase-pill');
      pill.className = `phase-pill phase-${p}`;
      pill.textContent = p==='GUIDE'?'引导中':(p==='DRAWING'?'抽牌中':(p==='INTERPRET'?'完整解读':'交流中'));
    }
    function renderSlots(){
      const box=document.getElementById('slots'); box.innerHTML='';
      const n = Number(state.total)||0, done = Number(state.progress)||0;
      for(let i=1;i<=n;i++){
        const s=document.createElement('div'); s.className='slot'+(i<=done?' done':''); s.textContent=i; box.appendChild(s);
      }
      document.getElementById('progress-text').textContent = `${done} / ${n}`;
    }

    function renderSpreadConfirm(spread){
      // spread: {spread_id, spread_name, question, positions?, card_count?, candidate_set_id?}
      const html = `
        <div class="sys-card">
          <div class="sys-title">已选牌阵：${escapeHtml(spread.spread_name||'（未命名牌阵）')}</div>
          ${spread.question?`<div class="text-muted">问题：${escapeHtml(spread.question)}</div>`:''}
          ${Array.isArray(spread.positions)?`<div class="small text-muted mt-1">位义：${spread.positions.map(p=>escapeHtml(p.name||p.title||p)).join(' / ')}</div>`:''}
          <div class="sys-actions">
            <button class="btn btn-primary" onclick='confirmSpread(${JSON.stringify(spread).replace(/"/g,"&quot;")})'><i class="fas fa-check"></i> 确认并开始抽牌</button>
            <button class="btn btn-outline" onclick='appendMessage("assistant","没问题，我们也可以换一个你更喜欢的牌阵～",true)'><i class="fas fa-random"></i> 换一个</button>
          </div>
        </div>`;
      appendMessage('assistant', html, false);
    }

    function renderCardBubble(card){
      // card: {index(展示1基), position_name, card_name, direction/upright, image_url|image, short_meaning?}
      const idx = Number(card.index)||state.progress||1;
      const upright = (typeof card.upright==='boolean') ? card.upright : (String(card.direction||'').includes('正'));
      const img = card.image_url || card.image || '';
      const html = `
        <div class="card-bubble">
          <img src="${escapeHtml(img)}" alt="${escapeHtml(card.card_name||'')}"/>
          <div class="card-meta">
            <div class="pos">${escapeHtml(card.position_name||'')}｜第 ${idx} 张</div>
            <div class="name">${escapeHtml(card.card_name||'')}（${upright?'正位':'逆位'}）</div>
            ${card.short_meaning?`<div class="mt-1">${escapeHtml(card.short_meaning)}</div>`:''}
          </div>
        </div>`;
      appendMessage('assistant', html, false);
    }

    // ========================= 网络交互 =========================
    let isTyping=false;
    async function sendMessage(){
      const input=document.getElementById('message-input');
      const msg=(input?.value||'').trim();
      if(!msg||isTyping) return;
      input.value=''; input.style.height='auto';
      appendMessage('user', msg, false);

      const payload = {
        message: msg,
        persona_id: state.personaId || undefined,
        reading_id: state.readingId || undefined,
        spread_id: state.spreadId || undefined,
        question: state.question || undefined
      };

      showTyping(); isTyping=true;
      try{
        const r = await fetch(API.GUIDED_CHAT, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload), cache:'no-store'
        });
        let data=null;
        try{ data = await r.json(); }catch(_){}
        hideTyping(); isTyping=false;

        const text = (data && (data.reply||data.text||data.answer)) || '…';
        processAssistantReply(text);

      }catch(e){
        hideTyping(); isTyping=false;
        appendMessage('assistant','抱歉，网络有点忙，请重试。',true);
        log(e);
      }
    }

    function processAssistantReply(text){
      appendMessage('assistant', text, true);

      // 解析指令
      const directives = tryParseDirectiveBlocks(text);
      // 1) 选阵确认
      if(directives.spreads.length){
        directives.spreads.forEach(sp=>{
          // 状态写回
          if(sp.spread_id) state.spreadId = sp.spread_id;
          if(sp.card_count) { state.total = Number(sp.card_count)||0; renderSlots(); }
          if(sp.question && !state.question) state.question = sp.question;
          if(sp.reading_id) state.readingId = sp.reading_id;
          if(sp.candidate_set_id) state.candidateSetId = sp.candidate_set_id;
          if(Array.isArray(sp.positions)) state.positions = sp.positions;

          // 引导 UI
          renderSpreadConfirm(sp);
        });
      }

      // 2) 单张翻牌
      if(directives.cards.length){
        // 切换阶段
        if(state.phase!=='DRAWING'){ updatePhase('DRAWING'); }
        directives.cards.forEach(c=>{
          // 进度推进（容错）
          const idx = Number(c.index)||Number(c.index_1)|| (state.progress+1);
          state.progress = Math.max(state.progress, idx||1);
          // 记录
          state.drawn.push({
            index: idx,
            position_name: c.position_name || '',
            card_name: c.card_name || '',
            upright: (typeof c.upright==='boolean') ? c.upright : String(c.direction||'').includes('正'),
            image_url: c.image_url || c.image || '',
            short_meaning: c.short_meaning || ''
          });
          renderSlots();
          renderCardBubble(c);
        });

        // 如果抽满，切换到“完整解读”阶段，等待 Chatflow 下一条 Answer（即完整解读文本）
        if(state.total>0 && state.progress>=state.total){
          updatePhase('INTERPRET');
          appendMessage('assistant','全部抽完啦！我来整合完整解读…',true);
        }
      }
    }

    // 用户点击“确认并开始抽牌”
    async function confirmSpread(spread){
      // 让 Chatflow 知道这是确认操作，并传会话已知字段（candidate_set_id 可选）
      const token = {
        spread_id: spread.spread_id || state.spreadId,
        spread_name: spread.spread_name || '',
        question: state.question || spread.question || '',
        candidate_set_id: state.candidateSetId || spread.candidate_set_id || ''
      };
      const payload = `[[SPREAD_SELECTED]] ${JSON.stringify(token)}`;
      appendMessage('user', '确认这个牌阵', false);
      document.getElementById('message-input').value = payload;
      await sendMessage();
    }

    // ========================= 交互与快捷问 =========================
    function showQuickQuestions(){
      const box=document.getElementById('quick-questions'); box.classList.remove('hidden');
      box.innerHTML='';
      const qs=['整体建议','我应该注意什么？','下一步该怎么做？'];
      qs.forEach(q=>{
        const el=document.createElement('div'); el.className='quick-question'; el.textContent=q;
        el.onclick=()=>{ const input=document.getElementById('message-input'); input.value=q; sendMessage(); };
        box.appendChild(el);
      });
    }

    // ========================= Persona 选择 =========================
    function openPersonaModal(){ document.getElementById('persona-modal').classList.add('show'); }
    function closePersonaModal(){ document.getElementById('persona-modal').classList.remove('show'); }
    function pickPersona(id){ state.personaId=id; [...document.querySelectorAll('#persona-modal .border')].forEach(b=>b.classList.remove('border-primary')); }
    async function confirmPersona(){
      if(!state.personaId) state.personaId='warm';
      const v = document.getElementById('pref-question').value.trim();
      if(v) state.question = v;
      closePersonaModal();

      const hello = state.question ? `你好，我想咨询：${state.question}` : '你好，我们开始吧。';
      appendMessage('user', hello, false);
      await sendFirstHello(hello);
    }

    async function sendFirstHello(msg){
      showTyping(); isTyping=true;
      try{
        const r = await fetch(API.GUIDED_CHAT, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            message: msg, persona_id: state.personaId,
            spread_id: state.spreadId || undefined,
            question: state.question || undefined
          }),
          cache:'no-store'
        });
        let data=null; try{ data=await r.json(); }catch(_){}
        hideTyping(); isTyping=false;
        const text = (data && (data.reply||data.text||data.answer)) || '…';
        processAssistantReply(text);
      }catch(e){
        hideTyping(); isTyping=false;
        appendMessage('assistant','抱歉，网络有点忙，请重试。',true);
      }
    }

    // ========================= 输入框与初始化 =========================
    function bindInputEvents(){
      const input=document.getElementById('message-input');
      input.addEventListener('input', function(){ this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,160)+'px'; });
      input.addEventListener('keydown', function(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
      document.getElementById('send-btn').addEventListener('click', sendMessage);
    }
    function getQuery(){ const p = new URLSearchParams(location.search); return Object.fromEntries(p.entries()); }

    async function init(){
      bindInputEvents();
      const q = getQuery();
      state.personaId = q.persona_id || null;
      state.spreadId  = q.spread_id  || null;
      state.question  = q.question   || null;
      updatePhase('GUIDE'); renderSlots();

      if(!state.personaId){ openPersonaModal(); return; }

      appendMessage('assistant','你好，我是你的占卜师～先简单聊聊你的诉求，我会为你推荐合适的牌阵。',true);
      if(state.question){ appendMessage('user', `我本次的问题：${state.question}`, false); }
      await sendFirstHello(state.question?`我想咨询：${state.question}`:'我们开始吧');
    }

    // ========================= 全牌阵查看与导出 =========================
    function openSpreadModal(){ document.getElementById('spread-modal').classList.add('show'); renderSpreadGrid(); }
    function closeSpreadModal(){ document.getElementById('spread-modal').classList.remove('show'); }
    function renderSpreadGrid(){
      const grid=document.getElementById('spread-grid'); grid.innerHTML='';
      state.drawn.forEach(c=>{
        const cell=document.createElement('div'); cell.className='spread-cell';
        cell.innerHTML = `<div class="small text-muted mb-1">${escapeHtml(c.position_name||'')}</div>
          <img src="${escapeHtml(c.image_url||'')}" alt="${escapeHtml(c.card_name||'')}">
          <div class="fw-bold mt-1">${escapeHtml(c.card_name||'')}（${c.upright?'正位':'逆位'}）</div>`;
        grid.appendChild(cell);
      });
    }
    function downloadReading(){
      const data = {
        reading_id: state.readingId,
        persona: state.personaId,
        question: state.question,
        spread_id: state.spreadId,
        total: state.total,
        cards: state.drawn
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`reading_${state.readingId||'draft'}.json`; a.click();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
