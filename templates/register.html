<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>注册 · 若水占卜</title>

  <!-- iOS 全屏 & 状态栏 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="若水占卜">
  <!-- Android / Chrome 主题色 -->
  <meta name="theme-color" content="#1a1625" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#2d1b4e" media="(prefers-color-scheme: light)">
  <!-- PWA 清单 / 图标（与 index 保持一致路径） -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-180.png') }}">

  <!-- 与 index 同源资源 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#9d7ea8; --secondary:#6d5675; --gold:#e8d4a2; --gold-light:#f4e5c3;
      --bg1:#2d1b4e; --bg2:#1a1625;
      --text:#fff; --text-light:rgba(255,255,255,.88); --text-muted:rgba(255,255,255,.65);
      --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --success:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;min-height:100dvh;min-height:calc(var(--vh,1vh)*100);}
    html{ background:#120c1d; } /* 深色底避免 iOS 底层白闪 */

    body{
      margin:0;
      font-family:'Noto Serif SC',-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      display:flex; align-items:center; justify-content:center;
      padding: max(20px, env(safe-area-inset-top,0px)) 20px max(20px, env(safe-area-inset-bottom,0px));
      position:relative; overflow-x:hidden;
    }

    /* —— 单层合成背景（稳定&省电） —— */
    .bg-stars{
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(820px 520px at 12% 14%, rgba(157,126,168,.22), transparent 60%),
        radial-gradient(760px 480px at 82% 72%, rgba(232,212,162,.18), transparent 60%),
        radial-gradient(920px 580px at 58% 12%, rgba(157,126,168,.14), transparent 72%),

        radial-gradient(1px 1px at 12% 25%, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 32% 60%, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 62% 30%, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 82% 70%, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 22% 80%, rgba(255,255,255,.9), transparent),

        url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 1000'>\
<g stroke='rgba(255,255,255,0.28)' stroke-width='1' fill='none'>\
<line x1='90' y1='120' x2='160' y2='160'/><line x1='160' y1='160' x2='210' y2='110'/><line x1='160' y1='160' x2='110' y2='200'/>\
<line x1='780' y1='120' x2='840' y2='160'/><line x1='840' y1='160' x2='900' y2='180'/><line x1='900' y1='180' x2='950' y2='150'/>\
<line x1='760' y1='740' x2='820' y2='780'/><line x1='820' y1='780' x2='880' y2='740'/><line x1='820' y1='780' x2='840' y2='840'/>\
</g>\
<g fill='rgba(255,255,255,0.9)'>\
<circle cx='90' cy='120' r='1.2'/><circle cx='160' cy='160' r='1.2'/><circle cx='210' cy='110' r='1.2'/><circle cx='110' cy='200' r='1.2'/>\
<circle cx='780' cy='120' r='1.2'/><circle cx='840' cy='160' r='1.2'/><circle cx='900' cy='180' r='1.2'/><circle cx='950' cy='150' r='1.2'/>\
<circle cx='760' cy='740' r='1.2'/><circle cx='820' cy='780' r='1.2'/><circle cx='880' cy='740' r='1.2'/><circle cx='840' cy='840' r='1.2'/>\
</g></svg>"),

        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23f1e4b7' stroke-opacity='0.5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23f1e4b7' stroke-opacity='0.5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23f1e4b7' stroke-opacity='0.5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M32 10 v36'/><path d='M22 30 h20'/><path d='M28 48 h8'/><circle cx='32' cy='10' r='3' fill='none'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23f1e4b7' stroke-opacity='0.5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='32' cy='32' r='16'/><path d='M32 16 L37 40 L20 26 H44 L27 40 Z'/></g></svg>"),

        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      background-repeat:no-repeat,no-repeat,no-repeat,
                       repeat,repeat,repeat,repeat,repeat,
                       no-repeat,
                       no-repeat,no-repeat,no-repeat,no-repeat,
                       no-repeat;
      background-size:cover,cover,cover,
                      220px 220px,220px 220px,220px 220px,220px 220px,220px 220px,
                      cover,
                      68px 68px,76px 76px,64px 64px,76px 76px,
                      cover;
      background-position:12% 14%,82% 72%,58% 12%,
                          12% 25%,32% 60%,62% 30%,82% 70%,22% 80%,
                          center,
                          8% 24%,86% 22%,12% 78%,88% 68%,
                          center;
      filter: saturate(1.05);
    }
    .bg-stars::after{
      content:"";
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(88vmin,720px); height:min(88vmin,720px);
      opacity:.18; pointer-events:none;
      background:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>\
<g fill='none' stroke='%23ffffff' stroke-opacity='.78' stroke-width='.3'>\
<circle cx='50' cy='50' r='44'/>\
<circle cx='50' cy='50' r='34' stroke-opacity='.5'/>\
<g stroke-opacity='.35'>\
<line x1='50' y1='6' x2='50' y2='94'/>\
<line x1='6' y1='50' x2='94' y2='50'/>\
<line x1='18' y1='18' x2='82' y2='82'/>\
<line x1='18' y1='82' x2='82' y2='18'/>\
</g></g>\
<text x='50' y='10' text-anchor='middle' fill='%23ffffff' fill-opacity='.7' font-size='6' font-family='serif'>\
♈︎♉︎♊︎♋︎♌︎♍︎♎︎♏︎♐︎♑︎♒︎♓︎</text></svg>") center/100% 100% no-repeat;
      animation:spin 110s linear infinite;
    }
    @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

    /* —— 注册卡片 —— */
    .auth-card{
      width:min(92vw, 480px);
      border-radius:22px;
      padding:28px 24px;
      background:var(--panel);
      border:1px solid var(--border);
      backdrop-filter: blur(12px);
      box-shadow:0 18px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08);
      position:relative;
    }
    .brand{ text-align:center; margin-bottom:18px; }
    .brand .logo{
      width:64px; height:64px; border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      margin:0 auto 10px;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff; border:1px solid var(--border); box-shadow:0 10px 24px rgba(157,126,168,.32);
      font-size:28px;
    }
    .brand h1{ font-size:1.4rem; letter-spacing:.5px; margin:0; color:var(--gold-light); }
    .brand p{ margin:.35rem 0 0; color:var(--text-muted); }

    .form-group{ margin-bottom:14px; text-align:left; }
    label{ display:block; margin-bottom:6px; color:var(--text-light); font-weight:600; }
    .form-control{
      width:100%; padding:12px 14px; border-radius:12px;
      background:rgba(255,255,255,.06); color:var(--text);
      border:1px solid var(--border); outline:none; transition:.2s;
      font-size:16px; /* iOS 防缩放 */
    }
    .form-control::placeholder{ color:rgba(255,255,255,.5); }
    .form-control:focus{
      border-color:rgba(232,212,162,.45);
      box-shadow:0 0 0 3px rgba(232,212,162,.18);
    }

    /* 密码强度条（按你原有三档逻辑） */
    .password-strength{ margin-top:6px; height:4px; background:rgba(255,255,255,.12); border-radius:2px; overflow:hidden; }
    .password-strength-bar{ height:100%; width:0%; border-radius:2px; transition:width .25s ease, background .25s ease; }
    .strength-weak{ width:33%; background:#dc3545; }
    .strength-medium{ width:66%; background:#f0ad4e; }
    .strength-strong{ width:100%; background:#10b981; }

    .hint{ font-size:.85rem; color:var(--text-muted); margin-top:6px; }

    .register-btn{
      width:100%; margin-top:8px; padding:12px 16px;
      border-radius:20px; border:1px solid var(--border);
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff; font-weight:700; letter-spacing:.4px;
      box-shadow:0 10px 24px rgba(157,126,168,.32); transition:.25s;
    }
    .register-btn:hover{ transform:translateY(-2px); box-shadow:0 14px 28px rgba(157,126,168,.42); }
    .register-btn:active{ transform:none; }

    .links{ margin-top:14px; text-align:center; color:var(--text-muted); }
    .links a{ color:var(--gold-light); text-decoration:none; }
    .links a:hover{ text-decoration:underline; }

    /* 错误/成功提示块（保留你的风格语义） */
    .error-message{
      background:rgba(239,68,68,.12);
      color:#fff; border:1px solid rgba(239,68,68,.35);
      border-radius:12px; padding:10px 12px; margin-bottom:12px;
      display:flex; gap:8px; align-items:center;
    }
    .success-message{
      background:rgba(16,185,129,.12);
      color:#fff; border:1px solid rgba(16,185,129,.35);
      border-radius:12px; padding:10px 12px; margin-bottom:12px;
      display:flex; gap:8px; align-items:center;
    }

    /* 触控优化 */
    button,.register-btn{ touch-action:manipulation; }

    @media (max-width:480px){
      .auth-card{ padding:22px 16px; }
      .brand h1{ font-size:1.25rem; }
    }
  </style>
</head>
<body>
  <div class="bg-stars" aria-hidden="true"></div>

  <main class="auth-card" role="main" aria-label="注册">
    <div class="brand">
      <div class="logo"><i class="fas fa-sparkles"></i></div>
      <h1>若水占卜</h1>
      <p>创建账户 · 开启你的塔罗旅程</p>
    </div>

    {% if error %}
      <div class="error-message"><i class="fas fa-exclamation-circle"></i><span>{{ error }}</span></div>
    {% endif %}
    {% if success %}
      <div class="success-message"><i class="fas fa-check-circle"></i><span>{{ success }}</span></div>
    {% endif %}

    <!-- 保持你原有字段、校验与事件 -->
    <form method="POST" onsubmit="return validateForm()">
      <div class="form-group">
        <label for="username">用户名</label>
        <input class="form-control" type="text" id="username" name="username"
               placeholder="请输入用户名（至少3个字符）" required minlength="3" autocomplete="username">
      </div>

      <div class="form-group">
        <label for="password">密码</label>
        <input class="form-control" type="password" id="password" name="password"
               placeholder="请输入密码（至少6个字符）" required minlength="6" oninput="checkPasswordStrength()" autocomplete="new-password">
        <div class="password-strength"><div class="password-strength-bar" id="strength-bar"></div></div>
        <p class="hint">建议使用字母、数字和符号的组合</p>
      </div>

      <div class="form-group">
        <label for="confirm_password">确认密码</label>
        <input class="form-control" type="password" id="confirm_password" name="confirm_password"
               placeholder="请再次输入密码" required autocomplete="new-password">
      </div>

      <button type="submit" class="register-btn">
        <i class="fas fa-user-plus"></i> 立即注册
      </button>
    </form>

    <div class="links" style="margin-top:14px;">
      已有账户？ <a href="{{ url_for('login') }}">立即登录</a>
    </div>
  </main>

  <script>
    // iOS 视口高度修复：--vh
    (function(){
      const setVh = ()=>{ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); };
      setVh(); addEventListener('resize', setVh); addEventListener('orientationchange', setVh);
    })();

    // PWA Service Worker（与 index 保持一致，可忽略失败）
    if ('serviceWorker' in navigator) {
      addEventListener('load', ()=> navigator.serviceWorker.register('/sw.js').catch(()=>{}));
    }

    // —— 与你原逻辑一致的密码强度与校验 —— //
    function checkPasswordStrength() {
      const password = document.getElementById('password').value;
      const bar = document.getElementById('strength-bar');
      let strength = 0;
      if (password.length >= 6) strength++;
      if (password.length >= 10) strength++;
      if (/[a-z]/.test(password)) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^a-zA-Z0-9]/.test(password)) strength++;
      bar.className = 'password-strength-bar';
      if (strength <= 2) bar.classList.add('strength-weak');
      else if (strength <= 4) bar.classList.add('strength-medium');
      else bar.classList.add('strength-strong');
    }

    function validateForm() {
      const p1 = document.getElementById('password').value;
      const p2 = document.getElementById('confirm_password').value;
      if (p1 !== p2) { alert('两次输入的密码不一致！'); return false; }
      return true;
    }
  </script>
</body>
</html>
