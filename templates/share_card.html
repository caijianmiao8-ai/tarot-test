<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>è‹¥æ°´å åœ Â· åˆ†äº«å¡ç‰‡</title>
  <meta name="theme-color" content="#8e6c88"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap');

    :root{
      --primary: #9d7ea8;
      --secondary: #6d5675;
      --gold: #e8d4a2;
      --gold-light: #f4e5c3;
      --rose: #e6a8b5;
      --glass: rgba(255, 255, 255, 0.06);
      --glass-light: rgba(255, 255, 255, 0.1);
      --border: rgba(255, 255, 255, 0.12);
      --text: #ffffff;
      --text-light: rgba(255, 255, 255, 0.85);
      --text-muted: rgba(255, 255, 255, 0.6);
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:15px;
      background: linear-gradient(135deg, #2d1b4e 0%, #1a1625 100%);
      font-family: 'Noto Serif SC', -apple-system, serif;
      color:#fff;
    }

    /* å¯¼å‡ºæ¨¡å¼ï¼šç¦åŠ¨ç”»/éšè—æ“ä½œæ ï¼Œé¿å…æŠ–åŠ¨æé«˜ä¸€è‡´æ€§ */
    body.export-mode *{ animation: none !important; transition: none !important; }
    body.export-mode .actions{ display: none !important; }

    /* ä¸»å¡ç‰‡å®¹å™¨ - å›ºå®šé«˜åº¦ï¼ˆ9:16ï¼‰ */
    .frame{
      width:min(400px, 90vw);
      height:min(711px, 90vh);
      position:relative;
      border-radius:20px;
      overflow:hidden;
      background: linear-gradient(180deg, #2a2041 0%, #1a1625 100%);
      box-shadow: 0 20px 40px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.08);
    }

    /* èƒŒæ™¯è£…é¥° */
    .bg-glow{
      position:absolute; width:150%; height:150%; top:-25%; left:-25%;
      background:
        radial-gradient(circle at 30% 20%, rgba(157,126,168,0.15) 0%, transparent 40%),
        radial-gradient(circle at 70% 80%, rgba(232,212,162,0.1) 0%, transparent 40%);
      filter:blur(40px);
      animation: float 20s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes float{
      0%,100%{transform:translate(0,0) rotate(0deg)}
      33%{transform:translate(-5%,-5%) rotate(120deg)}
      66%{transform:translate(5%,5%) rotate(240deg)}
    }

    /* æ˜Ÿç‚¹è£…é¥° */
    .sparkles{
      position:absolute; inset:0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, white, transparent),
        radial-gradient(1px 1px at 30% 60%, white, transparent),
        radial-gradient(1px 1px at 60% 30%, white, transparent);
      background-size: 200px 200px;
      opacity:0.25;
      animation: sparkle 4s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes sparkle{ 0%{opacity:0.15} 100%{opacity:0.3} }

    /* å†…å®¹å®¹å™¨ */
    .content{
      position:absolute; inset:0; padding:15px; display:flex; flex-direction:column; z-index:1; overflow:hidden;
    }

    /* é¡¶éƒ¨å“ç‰Œ */
    .header{ text-align:center; padding-bottom:10px; flex-shrink:0; }
    .brand{ font-size:9px; letter-spacing:3px; color:var(--gold-light); font-weight:300; opacity:0.8; }
    .date-info{ margin-top:4px; font-size:10px; color:var(--text-muted); }

    /* å¡ç‰Œå±•ç¤ºåŒº */
    .card-section{ display:flex; gap:12px; margin-bottom:12px; flex-shrink:0; }
    .card-image-wrapper{
      width:130px; height:195px; border-radius:10px; overflow:hidden;
      background:var(--glass); border:1px solid var(--border);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
      flex-shrink:0;
    }
    .card-image-wrapper img{ width:100%; height:100%; object-fit:cover; }
    .card-placeholder{
      width:100%; height:100%; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg, rgba(157,126,168,0.3), rgba(232,212,162,0.2));
      color:var(--text-muted); font-size:48px; font-weight:100;
    }

    /* å¡ç‰Œä¿¡æ¯ */
    .card-info{ flex:1; display:flex; flex-direction:column; justify-content:center; }
    .card-name{
      font-size:20px; font-weight:700; margin-bottom:6px;
      background:linear-gradient(90deg, var(--gold-light), var(--gold));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; line-height:1.2;
    }
    .card-direction{ display:inline-flex; align-items:center; gap:5px; font-size:12px; color:var(--text-light); margin-bottom:12px; }
    .direction-dot{ width:4px; height:4px; border-radius:50%; background:var(--gold); }

    /* è¿åŠ¿åˆ†æ•° */
    .score-container{ display:flex; align-items:center; gap:12px; padding:10px 14px; background:var(--glass); border-radius:20px; border:1px solid var(--border); }
    .score-ring{
      --progress:0.75; width:42px; height:42px; border-radius:50%;
      background:conic-gradient(from 180deg, var(--gold) calc(var(--progress) * 360deg), var(--glass) calc(var(--progress) * 360deg));
      display:flex; align-items:center; justify-content:center; position:relative; flex-shrink:0;
    }
    .score-ring::before{ content:''; position:absolute; inset:4px; border-radius:50%; background:#1a1625; }
    .score-value{ position:relative; font-size:16px; font-weight:700; color:var(--gold); }
    .score-text{ flex:1; }
    .score-label{ font-size:9px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }
    .score-grade{ font-size:14px; font-weight:500; color:var(--gold-light); }

    /* äº”ç»´åº¦è¯„åˆ† */
    .dimensions{ display:flex; justify-content:space-between; padding:10px 8px; background:var(--glass); border-radius:12px; border:1px solid var(--border); margin-bottom:10px; flex-shrink:0; }
    .dim-item{ flex:1; text-align:center; }
    .dim-circle{
      width:30px; height:30px; margin:0 auto 4px; border-radius:50%;
      background:linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.15); display:flex; align-items:center; justify-content:center; font-size:14px;
    }
    .dim-label{ font-size:9px; color:var(--text-muted); margin-bottom:2px; }
    .dim-rating{ display:flex; justify-content:center; gap:1px; }
    .star{ width:7px; height:7px; background:var(--glass); clip-path:polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
    .star.filled{ background:linear-gradient(135deg, var(--gold-light), var(--gold)); }

    /* ä»Šæ—¥è¿åŠ¿è§£è¯»ï¼ˆä¸‰æ®µå¼ï¼‰ */
    .message-section{
      flex:1; min-height:0; display:flex; flex-direction:column; padding:12px;
      background:linear-gradient(135deg, rgba(157,126,168,0.08), transparent);
      border-radius:12px; border:1px solid var(--border); margin-bottom:10px; overflow:hidden;
    }
    .message-label{ font-size:10px; color:var(--text-light); letter-spacing:2px; margin-bottom:6px; text-align:center; font-weight:500; }
    .message-text{ flex:0 0 auto; font-size:12px; line-height:1.6; color:var(--text-light); font-weight:300; text-align:center; padding: 2px 4px 6px; }

    /* å®œ / å¿Œ åŒåˆ—ï¼ˆæ»šåŠ¨æ¡éšè—ä½†å¯æ»šï¼‰ */
    .tips{ margin-top:8px; display:grid; grid-template-columns:1fr 1fr; gap:8px; min-height:0; flex:1; }
    .tip-col{ background:var(--glass); border:1px solid var(--border); border-radius:10px; padding:8px; display:flex; flex-direction:column; min-height:0; }
    .tips-title{ font-size:10px; color:var(--text-muted); letter-spacing:1px; text-align:center; margin-bottom:6px; }
    .tips-list{ list-style:none; display:grid; gap:6px; overflow:auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .tips-list::-webkit-scrollbar{ display:none; }
    .tips-list li{ font-size:11px; line-height:1.45; color:var(--text-light); display:flex; align-items:flex-start; gap:6px; }
    .tips-list li::before{ content:'â€¢'; color:var(--gold-light); font-size:14px; line-height:1; margin-top:1px; }

    /* å¹¸è¿å…ƒç´  */
    .lucky-bar{ display:flex; justify-content:space-around; padding:8px; background:var(--glass); border-radius:10px; margin-bottom:10px; flex-shrink:0; }
    .lucky-item{ text-align:center; flex:1; }
    .lucky-icon{ width:20px; height:20px; margin:0 auto 3px; border-radius:50%; background:var(--glass-light); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:10px; }
    .color-icon{ background:var(--gold); }
    .lucky-val{ font-size:9px; color:var(--text-light); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* åº•éƒ¨ */
    .footer{ display:flex; align-items:center; gap:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.08); flex-shrink:0; }
    .qr-wrapper{ width:35px; height:35px; padding:3px; background:white; border-radius:6px; flex-shrink:0; }
    .qr-wrapper img{ width:100%; height:100%; }
    .qrph{ width:100%; height:100%; background:repeating-linear-gradient(45deg, #000, #000 2px, #fff 2px, #fff 4px); }
    .site-info{ flex:1; min-width:0; }
    .site-name{ font-size:9px; color:var(--text-light); margin-bottom:1px; }
    .site-url{ font-size:8px; color:var(--text-muted); }

    /* å·¥å…·ç±» */
    .hidden{ display:none !important; }

    /* éšè—çš„å…¼å®¹å®¹å™¨ */
    #doList, #dontList, #analysisText, #luckyDirection { display: none; }

    /* æ“ä½œæŒ‰é’® */
    .actions{
      position:fixed; bottom:25px; left:50%; transform:translateX(-50%);
      display:flex; gap:10px; z-index:100;
    }
    .btn{
      padding:10px 18px; border:none; border-radius:20px; font-size:13px; font-weight:500; cursor:pointer; transition:all .3s;
      display:inline-flex; align-items:center; gap:6px; font-family:inherit;
      background:linear-gradient(135deg, var(--primary), var(--secondary)); color:white; box-shadow:0 4px 12px rgba(157,126,168,0.3);
    }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 16px rgba(157,126,168,0.4); }
    .btn.ghost{ background:rgba(255,255,255,0.1); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.15); }
    .btn.ghost:hover{ background:rgba(255,255,255,0.15); }

    /* å°å±ä¼˜åŒ– */
    @media (max-height:650px){
      .content{ padding:12px; }
      .card-section{ margin-bottom:10px; }
      .card-image-wrapper{ width:110px; height:165px; }
      .message-section{ min-height:60px; }
      .tips-list{ max-height:64px; }
    }
  </style>
</head>
<body>
  <div class="frame" id="shareCard">
    <div class="bg-glow"></div>
    <div class="sparkles"></div>

    <div class="content">
      <!-- é¡¶éƒ¨å“ç‰Œ -->
      <div class="header">
        <div class="brand">RUOSHUI TAROT</div>
        <div class="date-info"><span id="dateTag">--</span> Â· <span id="userTag">ç¥ç§˜è®¿å®¢</span></div>
      </div>

      <!-- å¡ç‰Œå±•ç¤º -->
      <div class="card-section">
        <div class="card-image-wrapper">
          <img id="cardImg" alt="Tarot" class="hidden"/>
          <div id="cardPh" class="card-placeholder">âœ¦</div>
        </div>
        <div class="card-info">
          <div>
            <div class="card-name" id="cardName">â€”</div>
            <div class="card-direction"><span class="direction-dot"></span><span id="cardDirection">â€”</span></div>
          </div>
          <div class="score-container">
            <div class="score-ring" id="ring"><span class="score-value" id="scoreNum">â€”</span></div>
            <div class="score-text">
              <div class="score-label">Fortune</div>
              <div class="score-grade" id="scoreBadge">â€”</div>
            </div>
          </div>
        </div>
      </div>

      <!-- äº”ç»´åº¦è¯„åˆ† -->
      <div class="dimensions" id="dims"></div>

      <!-- ä»Šæ—¥è¿åŠ¿è§£è¯»ï¼ˆä¸‰æ®µå¼ï¼‰ -->
      <div class="message-section">
        <div class="message-label">ä»Šæ—¥è¿åŠ¿è§£è¯»</div>
        <div class="message-text" id="summaryText">â€”</div>
        <div class="tips">
          <div class="tip-col">
            <div class="tips-title">ä»Šæ—¥å®œåš</div>
            <ul class="tips-list" id="doListV"></ul>
          </div>
          <div class="tip-col">
            <div class="tips-title">ä»Šæ—¥å¿Œåš</div>
            <ul class="tips-list" id="dontListV"></ul>
          </div>
        </div>
      </div>

      <!-- å¹¸è¿å…ƒç´  -->
      <div class="lucky-bar">
        <div class="lucky-item">
          <div class="lucky-icon color-icon" id="swatch"></div>
          <div class="lucky-val" id="luckyColor">â€”</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-icon">âœ§</div>
          <div class="lucky-val" id="luckyNumber">â€”</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-icon">â˜½</div>
          <div class="lucky-val" id="luckyHour">â€”</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-icon">â—ˆ</div>
          <div class="lucky-val" id="luckyDirectionDisplay">â€”</div>
        </div>
      </div>

      <!-- åº•éƒ¨ -->
      <div class="footer">
        <div class="qr-wrapper">
          <img id="qrImg" alt="QR" class="hidden"/>
          <div id="qrPh" class="qrph"></div>
        </div>
        <div class="site-info">
          <div class="site-name">è‹¥æ°´å åœ Â· æ¯æ—¥æŒ‡å¼•</div>
          <div class="site-url" id="siteUrl">www.ruoshui.fun</div>
        </div>
      </div>
    </div>
  </div>

  <!-- éšè—çš„æ•°æ®å®¹å™¨ï¼ˆå…¼å®¹ï¼‰ -->
  <ul id="doList"></ul>
  <ul id="dontList"></ul>
  <div id="analysisText"></div>
  <div id="luckyDirection"></div>

  <!-- æ“ä½œæ  -->
  <div class="actions" id="actions">
    <button class="btn" id="btnGenerate">âœ¨ ç”Ÿæˆåˆ†äº«</button>
    <button class="btn ghost hidden" id="btnCopy">ğŸ”— å¤åˆ¶é“¾æ¥</button>
    <button class="btn ghost" id="btnSave">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
  </div>

  <!-- æœåŠ¡ç«¯æ•°æ®æ³¨å…¥ -->
  <script id="__DATA__" type="application/json">
  {
    "mode": "{{ 'view' if share_data is defined else 'own' }}",
    "share_url": "{{ (request.url if share_data is defined else '')|e }}",
    "user_name": "{{ (share_data['user_name'] if share_data is defined else (user.get('username','ç¥ç§˜è®¿å®¢') if user else 'ç¥ç§˜è®¿å®¢'))|e }}",
    "date_iso": "{{ (share_data['created_at'].isoformat() if share_data is defined and share_data.get('created_at') else '')|e }}",
    "today_str": "{{ (today if today is defined else '')|e }}",
    "reading": {{ (share_data['reading'] if share_data is defined else reading)|tojson }},
    "fortune": {{ (share_data['fortune'] if share_data is defined else fortune_data)|tojson }}
  }
  </script>

  <!-- å‰ç«¯å¯¼å‡ºä¾èµ–ï¼ˆå‰ç«¯å…œåº•ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <script>
    /********************
     *  é…ç½®å¼€å…³
     ********************/
    // è‹¥å¸Œæœ›äºŒç»´ç å§‹ç»ˆæŒ‡å‘å®˜ç½‘ä¸»é¡µï¼Œè¯·è®¾ä¸º trueï¼ˆåç«¯è¿”å›çš„ qr_code ä»ä¼šæ˜¾ç¤ºä¸ºå›¾ç‰‡ï¼Œç«™ç‚¹æ–‡å­—æ”¹ä¸ºä¸»é¡µï¼‰
    const FORCE_HOME_QR = false;

    /********************
     *  å·¥å…·å‡½æ•°
     ********************/
    const $ = (id)=>document.getElementById(id);
    function ymd(d){ try{ const t=typeof d==='string'?new Date(d):d; return `${t.getFullYear()}.${String(t.getMonth()+1).padStart(2,'0')}.${String(t.getDate()).padStart(2,'0')}`}catch{return '--'} }
    function labelScore(s){ s=Number(s)||0; if(s>=85)return'å¤§å‰'; if(s>=70)return'ä¸­å‰'; if(s>=55)return'å°å‰'; return'å¹³' }
    function parseDimsStr(s){
      const out={}; if(typeof s!=='string') return out;
      s.split(/\n+/).forEach(l=>{
        const m=l.match(/^(.*?)[ï¼š:]\s*([\d.]+)\s*æ˜Ÿ(?:ï¼ˆ(.*?)ï¼‰)?/);
        if(m){ out[m[1].trim()]={v:parseFloat(m[2]), tag:(m[3]||'').trim()} }
      });
      return out;
    }

    const COLOR_MAP = {
      "çº¢":"#e85b70","çº¢è‰²":"#e85b70","ç«çº¢":"#ff4d6d","ç²‰":"#f4a5c7","ç²‰è‰²":"#f4a5c7",
      "æ©™":"#ffa24d","æ©™è‰²":"#ffa24d","é‡‘":"#d6c3a3","é‡‘è‰²":"#d6c3a3",
      "é»„":"#ffd66b","é»„è‰²":"#ffd66b","ç»¿":"#65c18c","ç»¿è‰²":"#65c18c",
      "è“":"#6aa8ff","è“è‰²":"#6aa8ff","ç´«":"#8e6c88","ç´«è‰²":"#8e6c88",
      "ç™½":"#f8f4e9","ç™½è‰²":"#f8f4e9","é»‘":"#222","é»‘è‰²":"#222"
    };
    function colorToHex(name){ if(!name) return null; for(const k in COLOR_MAP){ if(name.includes(k)) return COLOR_MAP[k]; } return null; }

    function flattenFortune(f0){
      const f = JSON.parse(JSON.stringify(f0||{}));
      const ft = f.fortune_text || {};
      if(ft.summary && !f.summary) f.summary = ft.summary;
      if(ft.do && !f.do) f.do = ft.do;
      if(ft.dont && !f.dont) f.dont = ft.dont;
      if(ft.dimension_advice && !f.dimension_advice) f.dimension_advice = ft.dimension_advice;

      const lucky = f.lucky_elements || {};
      f.lucky_color = f.lucky_color || lucky.color || '';
      f.lucky_number = f.lucky_number || lucky.number || '';
      f.lucky_hour = f.lucky_hour || lucky.hour || '';
      f.lucky_direction = f.lucky_direction || lucky.direction || '';

      if(Array.isArray(f.dimensions)){
        const map={}; f.dimensions.forEach(d=>{ if(d && d.name) map[d.name] = Number(d.stars ?? d.score ?? 0) });
        f.dimensions_map = map;
        if(!f.dimensions_text){
          f.dimensions_text = f.dimensions.map(d=>`${d.name}ï¼š${d.stars ?? d.score}æ˜Ÿï¼ˆ${d.level||''}ï¼‰`).join("\n");
        }
      }else if(typeof f.dimensions==='string'){
        f.dimensions_text = f.dimensions;
      }else if(typeof f.dimensions==='object' && f.dimensions){
        f.dimensions_map = f.dimensions_map || f.dimensions;
      }
      return f;
    }

    function createStars(rating){
      const stars = [];
      const full = Math.floor(rating||0);
      for(let i=0;i<5;i++){ stars.push(`<span class="star${i<full?' filled':''}"></span>`); }
      return stars.join('');
    }

    /********************
     *  æ¸²æŸ“
     ********************/
    function render(){
      const data = JSON.parse((document.getElementById('__DATA__')?.textContent)||'{}');
      const mode = data.mode || 'own';
      const reading = data.reading || {};
      const fortune = flattenFortune(data.fortune);

      // é¡¶éƒ¨
      const dateStr = (mode==='view' && data.date_iso) ? ymd(data.date_iso) : (data.today_str || '--');
      $('dateTag').textContent = dateStr;
      $('userTag').textContent = data.user_name || 'ç¥ç§˜è®¿å®¢';

      // ç‰Œé¢
      const name = reading.card_name || reading.name || 'â€”';
      const dir  = reading.direction || reading.card_direction || 'â€”';
      $('cardName').textContent = name;
      $('cardDirection').textContent = dir;

      const imgUrl = reading.image || reading.card_image || '';
      if(imgUrl){
        const img=$('cardImg');
        img.crossOrigin = 'anonymous'; // ä¾¿äºå‰ç«¯å¯¼å‡º
        img.onload = ()=>{ img.classList.remove('hidden'); $('cardPh').classList.add('hidden'); };
        img.onerror = ()=>{ img.classList.add('hidden'); $('cardPh').classList.remove('hidden'); };
        img.src = imgUrl;
      }

      // æ€»åˆ†
      const s = Number(fortune.overall_score ?? fortune.overall ?? 0);
      $('scoreNum').textContent = s ? String(s) : 'â€”';
      $('ring').style.setProperty('--progress', (Math.max(0,Math.min(100,s))/100).toFixed(3));
      $('scoreBadge').textContent = labelScore(s);

      // ç»´åº¦
      const dimsEl = $('dims'); dimsEl.innerHTML='';
      const dimsMap = (function(){
        if(fortune.dimensions_text) return parseDimsStr(fortune.dimensions_text);
        if(fortune.dimensions_map){ const o={}; for(const k in fortune.dimensions_map){ o[k]={v:Number(fortune.dimensions_map[k])} } return o; }
        return {};
      })();
      const dimConfig = [
        {key:'äº‹ä¸šè¿', short:'äº‹ä¸š', icon:'ğŸ’¼'},
        {key:'è´¢å¯Œè¿', short:'è´¢å¯Œ', icon:'ğŸ’°'},
        {key:'çˆ±æƒ…è¿', short:'çˆ±æƒ…', icon:'ğŸ’•'},
        {key:'å¥åº·è¿', short:'å¥åº·', icon:'ğŸŒ¿'},
        {key:'è´µäººè¿', short:'è´µäºº', icon:'âœ¨'}
      ];
      dimConfig.forEach(c=>{
        const d = dimsMap[c.key] || dimsMap[c.short];
        if(!d) return;
        const item = document.createElement('div');
        item.className = 'dim-item';
        item.innerHTML = `
          <div class="dim-circle">${c.icon}</div>
          <div class="dim-label">${c.short}</div>
          <div class="dim-rating">${createStars(d.v)}</div>
        `;
        dimsEl.appendChild(item);
      });

      // æ€»è¯„
      $('summaryText').textContent = fortune.summary || 'ä»Šæ—¥è¿åŠ¿æ¸©å’Œæ¸…æ¾ˆï¼Œé¡ºåŠ¿è€Œè¡Œï¼Œå¿ƒæ€€æ¾„å‡€ï¼Œè¶³ä»¥æ¥ä½æ¸©æŸ”å¥½è¿ã€‚';

      // å®œ / å¿Œï¼ˆæœ€å¤šä¸‰æ¡ï¼‰
      const dos = (fortune.do || []).slice(0,3);
      const donts = (fortune.dont || []).slice(0,3);
      $('doListV').innerHTML   = dos.length   ? dos.map(t=>`<li>${t}</li>`).join('')   : '<li>â€”</li>';
      $('dontListV').innerHTML = donts.length ? donts.map(t=>`<li>${t}</li>`).join('') : '<li>â€”</li>';
      // å…¼å®¹éšè—å®¹å™¨
      $('doList').innerHTML   = dos.length   ? dos.map(t=>`<li>âœ… ${t}</li>`).join('')   : '<li>â€”</li>';
      $('dontList').innerHTML = donts.length ? donts.map(t=>`<li>â›” ${t}</li>`).join('') : '<li>â€”</li>';

      // å¹¸è¿å…ƒç´ 
      const luckyColorName = fortune.lucky_color || (fortune.lucky_elements && fortune.lucky_elements.color) || '';
      const luckyHex = colorToHex(luckyColorName);
      if(luckyHex) $('swatch').style.background = luckyHex;
      $('luckyColor').textContent   = luckyColorName || 'â€”';
      $('luckyNumber').textContent  = fortune.lucky_number || (fortune.lucky_elements && fortune.lucky_elements.number) || 'â€”';
      $('luckyHour').textContent    = fortune.lucky_hour   || (fortune.lucky_elements && fortune.lucky_elements.hour)   || 'â€”';
      const luckyDir = fortune.lucky_direction || (fortune.lucky_elements && fortune.lucky_elements.direction) || 'â€”';
      $('luckyDirection').textContent = luckyDir;
      $('luckyDirectionDisplay').textContent = luckyDir;

      // è§£ææ–‡æœ¬ï¼ˆä¿ç•™ï¼‰
      const isRev = (dir||'').includes('é€†');
      const meaning = isRev ? (reading.meaning_rev || reading.meaning_reverse) : (reading.meaning_up || reading.meaning_upright);
      $('analysisText').textContent = meaning || 'â€”';

      // é“¾æ¥ & æŒ‰é’®æ¨¡å¼
      const defaultSite = 'www.ruoshui.fun';
      const site = mode==='view' ? (data.share_url || defaultSite) : defaultSite;
      $('siteUrl').textContent = site;

      if(mode==='view'){
        $('btnGenerate').classList.add('hidden');
        $('btnCopy').classList.remove('hidden');
        $('btnCopy').onclick = ()=>copyText(site);
      }
    }

    /********************
     *  åˆ†äº«&å¯¼å‡º
     ********************/
    async function genShare(){
      const btn=$('btnGenerate'); btn.disabled=true; btn.textContent='ç”Ÿæˆä¸­â€¦';
      try{
        const r = await fetch('/api/share/create',{method:'POST'});
        const d = await r.json();
        if(!d.success) throw new Error(d.error || 'ç”Ÿæˆå¤±è´¥');

        // ç«™ç‚¹å±•ç¤ºï¼šå¯å¼ºåˆ¶ä¸»é¡µ
        const showUrl = FORCE_HOME_QR ? 'https://www.ruoshui.fun' : (d.share_url || $('siteUrl').textContent);
        $('siteUrl').textContent = showUrl;

        // äºŒç»´ç ï¼šåç«¯è¿”å›å³æ˜¾ç¤º
        if(d.qr_code){
          $('qrImg').src = d.qr_code;
          $('qrImg').classList.remove('hidden');
          $('qrPh').classList.add('hidden');
        }

        $('btnCopy').classList.remove('hidden');
        $('btnCopy').onclick = ()=>copyText(showUrl);
        btn.textContent='å·²ç”Ÿæˆ';
      }catch(e){
        alert(e.message||'ç”Ÿæˆå¤±è´¥');
        btn.textContent='âœ¨ ç”Ÿæˆåˆ†äº«';
      }finally{
        btn.disabled=false;
      }
    }

    function copyText(t){
      if(!t) t = $('siteUrl').textContent;
      (navigator.clipboard ? navigator.clipboard.writeText(t) : Promise.reject())
        .then(()=>alert('é“¾æ¥å·²å¤åˆ¶'))
        .catch(()=>{
          const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); ta.remove(); alert('é“¾æ¥å·²å¤åˆ¶');
        });
    }

    // ç»„è£…å¯¼å‡º HTMLï¼ˆåªåŒ…å«å¡ç‰‡ï¼Œå†…è”å½“å‰ <style>ï¼Œå¹¶å¼€å¯ export-modeï¼‰
    function buildExportHTML(){
      let css = '';
      document.querySelectorAll('style').forEach(s=> css += s.innerHTML + '\n');
      const card = document.getElementById('shareCard').outerHTML;
      return `<!DOCTYPE html>
<html lang="zh-CN"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>share-export</title>
<style>${css}</style>
</head>
<body class="export-mode">
${card}
</body></html>`;
    }

    async function savePNG(){
      const actions=$('actions'); actions.classList.add('hidden');
      document.body.classList.add('export-mode'); // ç¦åŠ¨ç”»æé«˜ä¸€è‡´æ€§
      try{
        // é¦–é€‰ï¼šåç«¯é«˜ä¿çœŸå¯¼å‡º
        const payload = {
          html: buildExportHTML(),
          selector: "#shareCard",
          width: 1080,
          height: 1920,
          scale: 1
        };
        const resp = await fetch('/api/share/export',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const d = await resp.json();
        if(d && d.success && d.image_url){
          // ç›´æ¥ä¸‹è½½åç«¯ç”Ÿæˆçš„å›¾ç‰‡
          const a=document.createElement('a');
          a.href=d.image_url; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click();
          return;
        }
        // åç«¯ä¸å¯ç”¨ -> å‰ç«¯å…œåº•
        throw new Error(d && d.error ? d.error : 'åç«¯å¯¼å‡ºä¸å¯ç”¨ï¼Œä½¿ç”¨å‰ç«¯å…œåº•');
      }catch(e){
        // å‰ç«¯å…œåº•ï¼ˆæ³¨æ„è·¨åŸŸå›¾ç‰‡éœ€è¦ CORSï¼‰
        try{
          const canvas = await html2canvas($('shareCard'),{scale:2.2, useCORS:true, backgroundColor:null});
          const url = canvas.toDataURL('image/png');
          const a=document.createElement('a');
          a.href=url; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click();
        }catch(err){
          alert('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
      }finally{
        document.body.classList.remove('export-mode');
        actions.classList.remove('hidden');
      }
    }

    /********************
     *  å¯åŠ¨
     ********************/
    window.addEventListener('load', ()=>{
      render();
      $('btnGenerate').onclick = genShare;
      $('btnCopy').onclick = ()=>copyText();
      $('btnSave').onclick = savePNG;
    });


    // å¢å¼ºçš„æ¶ˆæ¯é€šä¿¡å’Œå®¢æˆ·ç«¯å¯¼å‡ºæ”¯æŒ
(function() {
  // ç›‘å¬æ¥è‡ªçˆ¶é¡µé¢çš„æ¶ˆæ¯
  window.addEventListener('message', async function(event) {
    const message = event.data;
    if (!message || !message.type) return;
    
    switch(message.type) {
      case 'share:init':
        // åˆå§‹åŒ–æ•°æ®
        if (message.data) {
          renderFromData(message.data);
        }
        break;
        
      case 'share:update':
        // æ›´æ–°äºŒç»´ç å’Œé“¾æ¥
        if (message.qrCode) {
          const qrImg = document.getElementById('qrImg');
          const qrPh = document.getElementById('qrPh');
          qrImg.src = message.qrCode;
          qrImg.classList.remove('hidden');
          qrPh.classList.add('hidden');
        }
        if (message.shareUrl) {
          document.getElementById('siteUrl').textContent = 
            message.shareUrl.replace(/^https?:\/\//, '');
        }
        break;
        
      case 'share:export':
        // å®¢æˆ·ç«¯å¯¼å‡º
        await performClientExport();
        break;
    }
  });
  
  // ä»å¤–éƒ¨æ•°æ®æ¸²æŸ“ï¼ˆç”¨äº iframe æ¨¡å¼ï¼‰
  function renderFromData(data) {
    // æ›´æ–°æ—¥æœŸå’Œç”¨æˆ·å
    document.getElementById('dateTag').textContent = 
      data.today || new Date().toLocaleDateString('zh-CN').replace(/\//g, '.');
    document.getElementById('userTag').textContent = 
      data.user_name || 'ç¥ç§˜è®¿å®¢';
    
    // æ›´æ–°å¡ç‰Œä¿¡æ¯
    const reading = data.reading || {};
    document.getElementById('cardName').textContent = 
      reading.name || reading.card_name || 'â€”';
    document.getElementById('cardDirection').textContent = 
      reading.direction || 'â€”';
    
    // æ›´æ–°å¡ç‰Œå›¾ç‰‡
    if (reading.image) {
      const img = document.getElementById('cardImg');
      img.src = reading.image;
      img.onload = function() {
        img.classList.remove('hidden');
        document.getElementById('cardPh').classList.add('hidden');
      };
    }
    
    // æ›´æ–°è¿åŠ¿æ•°æ®
    const fortune = data.fortune || {};
    updateFortuneDisplay(fortune);
  }
  
  // æ›´æ–°è¿åŠ¿æ˜¾ç¤º
  function updateFortuneDisplay(fortune) {
    // æ€»åˆ†
    const score = Number(fortune.overall_score || 0);
    document.getElementById('scoreNum').textContent = score || 'â€”';
    document.getElementById('ring').style.setProperty('--progress', 
      (Math.max(0, Math.min(100, score)) / 100).toFixed(3));
    
    // è¯„çº§
    let grade = 'å¹³';
    if (score >= 85) grade = 'å¤§å‰';
    else if (score >= 70) grade = 'ä¸­å‰';
    else if (score >= 55) grade = 'å°å‰';
    document.getElementById('scoreBadge').textContent = grade;
    
    // æ€»è¯„
    document.getElementById('summaryText').textContent = 
      fortune.summary || 'ä»Šæ—¥è¿åŠ¿æ¸©å’Œæ¸…æ¾ˆï¼Œé¡ºåŠ¿è€Œè¡Œã€‚';
    
    // å®œå¿Œ
    const dos = (fortune.do || []).slice(0, 3);
    const donts = (fortune.dont || []).slice(0, 3);
    
    document.getElementById('doListV').innerHTML = 
      dos.length ? dos.map(t => `<li>${t}</li>`).join('') : '<li>â€”</li>';
    document.getElementById('dontListV').innerHTML = 
      donts.length ? donts.map(t => `<li>${t}</li>`).join('') : '<li>â€”</li>';
    
    // å¹¸è¿å…ƒç´ 
    const lucky = fortune.lucky_elements || {};
    document.getElementById('luckyColor').textContent = 
      fortune.lucky_color || lucky.color || 'â€”';
    document.getElementById('luckyNumber').textContent = 
      fortune.lucky_number || lucky.number || 'â€”';
    document.getElementById('luckyHour').textContent = 
      fortune.lucky_hour || lucky.hour || 'â€”';
    document.getElementById('luckyDirectionDisplay').textContent = 
      fortune.lucky_direction || lucky.direction || 'â€”';
    
    // äº”ç»´åº¦ï¼ˆå¦‚æœæœ‰ï¼‰
    if (fortune.dimensions && Array.isArray(fortune.dimensions)) {
      updateDimensions(fortune.dimensions);
    }
  }
  
  // æ›´æ–°äº”ç»´åº¦æ˜¾ç¤º
  function updateDimensions(dimensions) {
    const dimsEl = document.getElementById('dims');
    if (!dimsEl) return;
    
    dimsEl.innerHTML = '';
    const icons = {
      'äº‹ä¸šè¿': 'ğŸ’¼', 'è´¢å¯Œè¿': 'ğŸ’°', 
      'çˆ±æƒ…è¿': 'ğŸ’•', 'å¥åº·è¿': 'ğŸŒ¿', 
      'è´µäººè¿': 'âœ¨'
    };
    
    dimensions.forEach(dim => {
      const stars = Math.floor(dim.stars || dim.score || 0);
      let starsHtml = '';
      for (let i = 0; i < 5; i++) {
        starsHtml += `<span class="star${i < stars ? ' filled' : ''}"></span>`;
      }
      
      const item = document.createElement('div');
      item.className = 'dim-item';
      item.innerHTML = `
        <div class="dim-circle">${icons[dim.name] || 'â­'}</div>
        <div class="dim-label">${dim.name.replace('è¿', '')}</div>
        <div class="dim-rating">${starsHtml}</div>
      `;
      dimsEl.appendChild(item);
    });
  }
  
  // å®¢æˆ·ç«¯å¯¼å‡ºå®ç°
  async function performClientExport() {
    try {
      // éšè—æ“ä½œæŒ‰é’®
      const actions = document.getElementById('actions');
      if (actions) actions.style.display = 'none';
      
      // æ·»åŠ å¯¼å‡ºæ¨¡å¼ç±»
      document.body.classList.add('export-mode');
      
      // ç­‰å¾…é‡ç»˜
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // æ£€æŸ¥æ˜¯å¦æœ‰ html2canvas
      if (typeof html2canvas === 'undefined') {
        // åŠ¨æ€åŠ è½½ html2canvas
        await loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
      }
      
      // æ‰§è¡Œæˆªå›¾
      const canvas = await html2canvas(document.getElementById('shareCard'), {
        scale: 2,
        useCORS: true,
        backgroundColor: null,
        logging: false,
        allowTaint: false,
        onclone: function(clonedDoc) {
          // åœ¨å…‹éš†çš„æ–‡æ¡£ä¸­ç¡®ä¿æ ·å¼æ­£ç¡®
          clonedDoc.body.classList.add('export-mode');
        }
      });
      
      // è½¬æ¢ä¸º data URL
      const dataUrl = canvas.toDataURL('image/png');
      
      // å¦‚æœåœ¨ iframe ä¸­ï¼Œå‘é€ç»™çˆ¶é¡µé¢
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'share:export-ready',
          success: true,
          dataUrl: dataUrl
        }, '*');
      } else {
        // ç›´æ¥ä¸‹è½½
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `ruoshui_tarot_${Date.now()}.png`;
        a.click();
      }
      
    } catch (error) {
      console.error('Client export error:', error);
      
      // é€šçŸ¥å¤±è´¥
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'share:export-ready',
          success: false,
          error: error.message
        }, '*');
      } else {
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
      }
      
    } finally {
      // æ¢å¤ç•Œé¢
      document.body.classList.remove('export-mode');
      const actions = document.getElementById('actions');
      if (actions) actions.style.display = '';
    }
  }
  
  // åŠ¨æ€åŠ è½½è„šæœ¬
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }
  
  // å¦‚æœåœ¨ iframe ä¸­ï¼Œé€šçŸ¥çˆ¶é¡µé¢å·²å‡†å¤‡å°±ç»ª
  if (window.parent !== window) {
    window.parent.postMessage({ type: 'share:ready' }, '*');
    
    // éšè—æ“ä½œæŒ‰é’®ï¼ˆiframe æ¨¡å¼ä¸‹ï¼‰
    const actions = document.getElementById('actions');
    if (actions) actions.style.display = 'none';
  }
})();

  </script>
</body>
</html>
