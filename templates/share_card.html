<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è‹¥æ°´å åœ Â· åˆ†äº«å¡ç‰‡</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary: #9d7ea8;
      --secondary: #6d5675;
      --gold: #e8d4a2;
      --gold-light: #f4e5c3;
      --bg1: #2a2041;
      --bg2: #1a1625;
      --text: #ffffff;
      --text-light: rgba(255,255,255,0.88);
      --text-muted: rgba(255,255,255,0.65);
      --border: rgba(255,255,255,0.12);
      --glass: rgba(255,255,255,0.06);
      --star: #ffd86b;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;}
    body{
      font-family: 'Noto Serif SC', -apple-system, BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      color: var(--text);
      background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    /* ä¸»å¡ç‰‡å®¹å™¨ï¼ˆå›ºå®š idï¼‰ */
    .share-card{
      width: 400px;
      max-width: 96vw;
      background: linear-gradient(180deg, #2a2041 0%, #1a1625 100%);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.08);
      overflow: hidden;
      position: relative;
    }

    /* èƒŒæ™¯æŸ”å…‰ä¸æ˜Ÿå±‘ */
    .bg-glow{
      position:absolute; width:160%; height:160%; left:-30%; top:-30%;
      background:
        radial-gradient(circle at 30% 20%, rgba(157,126,168,0.18), transparent 40%),
        radial-gradient(circle at 75% 80%, rgba(232,212,162,0.12), transparent 40%);
      filter: blur(40px);
      animation: float 20s ease-in-out infinite alternate;
      pointer-events: none;
    }
    .sparkles{
      position:absolute; inset:0; pointer-events:none; opacity:.25;
      background-image:
        radial-gradient(1px 1px at 10% 20%, white, transparent),
        radial-gradient(1px 1px at 30% 60%, white, transparent),
        radial-gradient(1px 1px at 60% 30%, white, transparent),
        radial-gradient(1px 1px at 80% 70%, white, transparent),
        radial-gradient(1px 1px at 20% 85%, white, transparent);
      background-size: 220px 220px;
      animation: twinkle 4s ease-in-out infinite alternate;
    }
    @keyframes float{ from{transform:translateY(-1%)} to{transform:translateY(1%)} }
    @keyframes twinkle{ from{opacity:.15} to{opacity:.35} }

    .content{ position:relative; z-index:1; padding:14px; display:flex; flex-direction:column; gap:10px; }

    /* å¤´éƒ¨ */
    .header{ text-align:center; }
    .brand{ font-size:10px; letter-spacing:3px; color:var(--gold-light); opacity:.9; }
    .date-line{ margin-top:4px; font-size:11px; color:var(--text-muted); }

    /* å¡ç‰‡ä¸»åŒº */
    .row{
      display:flex; gap:12px; align-items:stretch;
      background: var(--glass);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .cover{
      width:135px; height:200px; border-radius:12px; overflow:hidden;
      background: linear-gradient(135deg, rgba(157,126,168,0.3), rgba(232,212,162,0.22));
      border:1px solid var(--border);
      box-shadow: 0 8px 20px rgba(0,0,0,0.32), inset 0 1px 0 rgba(255,255,255,0.1);
      flex-shrink:0;
    }
    .cover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .cover-ph{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-muted); font-size:42px; }

    .info{ flex:1; display:flex; flex-direction:column; justify-content:space-between; min-width:0; }
    .title{ font-size:20px; font-weight:700; line-height:1.2;
      background: linear-gradient(90deg, var(--gold-light), var(--gold));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .dir{ margin-top:6px; font-size:12px; color:var(--text-light); display:inline-flex; align-items:center; gap:6px; }
    .dot{ width:5px; height:5px; border-radius:50%; background: var(--gold); display:inline-block; }

    .score{
      margin-top:10px; display:flex; align-items:center; gap:12px;
      padding:10px 12px; border-radius:14px; background: rgba(255,255,255,0.06); border:1px solid var(--border);
    }
    .ring{
      width:44px; height:44px; border-radius:50%;
      background: radial-gradient(circle, rgba(232,212,162,.65), rgba(232,212,162,.2));
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .score-val{ font-weight:800; font-size:15px; color:var(--gold-light); }
    .score-text{ line-height:1.1; }
    .score-label{ font-size:10px; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase; }
    .score-grade{ font-size:14px; color:var(--gold-light); font-weight:600; }

    /* ç»´åº¦ */
    .dims{
      display:flex; justify-content:space-between; gap:8px;
      background: var(--glass); border:1px solid var(--border); border-radius:12px; padding:8px;
    }
    .dim{ flex:1; text-align:center; }
    .dim-ico{
      width:28px; height:28px; border-radius:50%;
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,0.15);
      display:flex; align-items:center; justify-content:center; font-size:14px; margin:0 auto 4px;
    }
    .dim-name{ font-size:10px; color:var(--text-muted); margin-bottom:2px; }
    .stars{ display:flex; justify-content:center; gap:1px; }
    .star{ width:7px; height:7px; background: rgba(255,255,255,0.1);
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
    .star.filled{ background: linear-gradient(135deg, var(--gold-light), var(--gold)); }

    /* è§£è¯» + å®œå¿Œ */
    .message{
      background: linear-gradient(135deg, rgba(157,126,168,0.08), transparent);
      border:1px solid var(--border); border-radius:12px; padding:12px;
      display:flex; flex-direction:column; gap:8px; min-height:0;
    }
    .section-label{ text-align:center; font-size:10px; letter-spacing:2px; color:var(--text-light); }
    .summary{ font-size:12px; line-height:1.7; color:var(--text-light); text-align:center; padding:2px 6px; }

    .tips{ display:grid; grid-template-columns:1fr 1fr; gap:8px; min-height:0; }
    .tip-col{ background: var(--glass); border:1px solid var(--border); border-radius:10px; padding:8px; display:flex; flex-direction:column; min-height:0; }
    .tip-title{ text-align:center; font-size:10px; color:var(--text-muted); letter-spacing:1px; margin-bottom:6px; }
    .tip-list{ list-style:none; display:grid; gap:6px; overflow:auto; -webkit-overflow-scrolling: touch; }
    .tip-list::-webkit-scrollbar{ display:none; }
    .tip-list li{ font-size:11px; line-height:1.45; color:var(--text-light); display:flex; gap:6px; align-items:flex-start; }
    .tip-list li::before{ content:'â€¢'; color:var(--gold-light); font-size:14px; line-height:1; margin-top:1px; }

    /* å¹¸è¿å…ƒç´  */
    .lucky{
      display:flex; justify-content:space-around; gap:6px;
      background: var(--glass); border:1px solid var(--border); border-radius:10px; padding:8px;
    }
    .lucky-item{ text-align:center; flex:1; min-width:0; }
    .lucky-ico{ width:20px; height:20px; border-radius:50%; border:1px solid var(--border); background: rgba(255,255,255,0.1);
      display:flex; align-items:center; justify-content:center; font-size:10px; margin:0 auto 3px; }
    .swatch{ background: var(--gold); }
    .lucky-val{ font-size:10px; color:var(--text-light); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* åº•éƒ¨ï¼šäºŒç»´ç ä¸ç«™ç‚¹ */
    .footer{
      display:flex; align-items:center; gap:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.08);
    }
    .qr{ width:36px; height:36px; background:#fff; border-radius:6px; padding:3px; }
    .qr img{ width:100%; height:100%; display:block; }
    .qr-ph{ width:100%; height:100%; background: repeating-linear-gradient(45deg, #000, #000 2px, #fff 2px, #fff 4px); }
    .site{ flex:1; min-width:0; }
    .site-name{ font-size:10px; color:var(--text-light); }
    .site-url{ font-size:9px; color:var(--text-muted); }

    /* â€”â€” åµŒå…¥æ¨¡å¼ï¼šé˜²æ­¢çˆ¶å±‚ç¼©æ”¾å¯¼è‡´è£åˆ‡ â€”â€” */
    body.embed .summary{
      display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:3; overflow:hidden;
    }
    body.embed .tips{ min-height:0; }
    body.embed .tip-col{ min-height:0; }
    body.embed .tip-list{ flex:1; min-height:0; overflow:auto; }
    body.embed .footer .site-url{ color:rgba(255,255,255,0.8); }

    /* â€”â€” å¯¼å‡ºæ¨¡å¼ï¼šé™ä½å¤æ‚æ»¤é•œï¼Œä¿è¯åç«¯æˆªå›¾ç¨³å®š â€”â€” */
    body.export-mode .bg-glow{ filter:none; opacity:.9; }
    body.export-mode .ring{ background: radial-gradient(circle, rgba(232,212,162,.7), rgba(232,212,162,.28)); }
  </style>
</head>
<body class="{% if embed %}embed{% endif %} {% if export_mode %}export-mode{% endif %}">
  <div class="share-card" id="shareCardRoot">
    <div class="bg-glow"></div>
    <div class="sparkles"></div>

    <div class="content">
      <div class="header">
        <div class="brand">RUOSHUI TAROT</div>
        <div class="date-line"><span id="scDate">â€”</span> Â· <span id="scUser">ç¥ç§˜è®¿å®¢</span></div>
      </div>

      <div class="row">
        <div class="cover">
          <img id="scImg" alt="Tarot" style="display:none"/>
          <div class="cover-ph" id="scImgPh">âœ¦</div>
        </div>
        <div class="info">
          <div>
            <div class="title" id="scName">â€”</div>
            <div class="dir"><span class="dot"></span><span id="scDir">â€”</span></div>
          </div>
          <div class="score">
            <div class="ring"><div class="score-val" id="scScore">â€”</div></div>
            <div class="score-text">
              <div class="score-label">FORTUNE</div>
              <div class="score-grade" id="scGrade">â€”</div>
            </div>
          </div>
        </div>
      </div>

      <div class="dims" id="scDims"></div>

      <div class="message">
        <div class="section-label">ä»Šæ—¥è¿åŠ¿è§£è¯»</div>
        <div class="summary" id="scSummary">â€”</div>
        <div class="tips">
          <div class="tip-col">
            <div class="tip-title">ä»Šæ—¥å®œåš</div>
            <ul class="tip-list" id="scDo"></ul>
          </div>
          <div class="tip-col">
            <div class="tip-title">ä»Šæ—¥å¿Œåš</div>
            <ul class="tip-list" id="scDont"></ul>
          </div>
        </div>
      </div>

      <div class="lucky">
        <div class="lucky-item">
          <div class="lucky-ico swatch" id="scSwatch"></div>
          <div class="lucky-val" id="scColor">â€”</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-ico">âœ§</div>
          <div class="lucky-val" id="scNumber">â€”</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-ico">â˜½</div>
          <div class="lucky-val" id="scHour">â€”</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-ico">â—ˆ</div>
          <div class="lucky-val" id="scDirection">â€”</div>
        </div>
      </div>

      <div class="footer">
        <div class="qr"><img id="scQR" alt="QR" style="display:none"/><div id="scQRPh" class="qr-ph"></div></div>
        <div class="site">
          <div class="site-name">è‹¥æ°´å åœ Â· æ¯æ—¥æŒ‡å¼•</div>
          <div class="site-url" id="scSite">www.ruoshui.fun</div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ•°æ®æ³¨å…¥ï¼ˆä¼˜å…ˆ share_dataï¼Œå…¶æ¬¡ ?payload=ï¼‰ -->
  <script id="__DATA__" type="application/json">
  {
    "share_data": {{ share_data|tojson if share_data is defined else 'null' }},
    "embed": {{ 'true' if embed else 'false' }},
    "export_mode": {{ 'true' if export_mode else 'false' }}
  }
  </script>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const COLOR_MAP = {
        "çº¢":"#e85b70","çº¢è‰²":"#e85b70","ç«çº¢":"#ff4d6d","ç²‰":"#f4a5c7","ç²‰è‰²":"#f4a5c7",
        "æ©™":"#ffa24d","æ©™è‰²":"#ffa24d","é‡‘":"#d6c3a3","é‡‘è‰²":"#d6c3a3",
        "é»„":"#ffd66b","é»„è‰²":"#ffd66b","ç»¿":"#65c18c","ç»¿è‰²":"#65c18c",
        "è“":"#6aa8ff","è“è‰²":"#6aa8ff","ç´«":"#8e6c88","ç´«è‰²":"#8e6c88",
        "ç™½":"#f8f4e9","ç™½è‰²":"#f8f4e9","é»‘":"#222","é»‘è‰²":"#222"
      };
      function hexByName(n){ if(!n) return null; for(const k in COLOR_MAP){ if(n.includes(k)) return COLOR_MAP[k]; } return null; }
      function labelScore(s){ s=Number(s)||0; if(s>=85)return"å¤§å‰"; if(s>=70)return"ä¸­å‰"; if(s>=55)return"å°å‰"; return"å¹³"; }
      function parseDimsStr(s){
        const out={}; if(typeof s!=='string') return out;
        s.split(/\n+/).forEach(l=>{ const m=l.match(/^(.*?)[ï¼š:]\s*([\d.]+)\s*æ˜Ÿ/); if(m){ out[m[1].trim()] = parseFloat(m[2]) }});
        return out;
      }
      function starsHTML(v){ v=Number(v)||0; const full=Math.floor(v); let h=''; for(let i=0;i<5;i++) h+=`<span class="star${i<full?' filled':''}"></span>`; return h; }
      function ymd(dt){ try{ const d=new Date(dt); return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`}catch{return'--'} }

      function readInjected(){
        let injected = {};
        try{ injected = JSON.parse(document.getElementById('__DATA__').textContent||'{}') }catch(e){}
        // ä¼˜å…ˆ share_dataï¼›å¦åˆ™å°è¯• URL payload
        if(!injected.share_data){
          const usp = new URLSearchParams(location.search);
          if(usp.get('payload')){
            try{ injected.share_data = JSON.parse(usp.get('payload')) }catch(e){}
          }
        }
        return injected;
      }

      function postSize(){
        const root = $('shareCardRoot');
        if(!root || !parent) return;
        const r = root.getBoundingClientRect();
        parent.postMessage({type:'ruoshui:size', data:{w:Math.round(r.width), h:Math.round(r.height)}}, '*');
      }

      async function fontsReady(){ try{ await (document.fonts && document.fonts.ready) }catch{} }

      function render(data){
        const user = data.user_name || 'ç¥ç§˜è®¿å®¢';
        const created = data.created_at || new Date().toISOString();
        const reading = data.reading || {};
        const fortune = data.fortune || {};

        // header
        $('scUser').textContent = user;
        $('scDate').textContent = ymd(created);

        // cover
        const img = reading.image || reading.card_image || '';
        if(img){
          const el = $('scImg'); el.src = img;
          el.onload = ()=>{ el.style.display='block'; $('scImgPh').style.display='none'; postSize(); };
          el.onerror = ()=>{ el.style.display='none'; $('scImgPh').style.display='flex'; postSize(); };
        }else{
          $('scImg').style.display='none'; $('scImgPh').style.display='flex';
        }

        // name & direction
        $('scName').textContent = reading.card_name || reading.name || 'â€”';
        $('scDir').textContent  = reading.direction || reading.card_direction || 'â€”';

        // score
        const score = Number(fortune.overall_score ?? fortune.overall ?? 0);
        $('scScore').textContent = score ? String(score) : 'â€”';
        $('scGrade').textContent = labelScore(score);

        // dims
        const dimsWrap = $('scDims'); dimsWrap.innerHTML='';
        let dimsMap = {};
        if(typeof fortune.dimensions === 'string') dimsMap = parseDimsStr(fortune.dimensions);
        else if(Array.isArray(fortune.dimensions)) fortune.dimensions.forEach(d=>{ if(d?.name) dimsMap[d.name] = Number(d.stars ?? d.score ?? 0) });
        else if(typeof fortune.dimensions === 'object' && fortune.dimensions) dimsMap = fortune.dimensions;

        const order = [
          {k:'äº‹ä¸šè¿', s:'äº‹ä¸š', i:'ğŸ’¼'}, {k:'è´¢å¯Œè¿', s:'è´¢å¯Œ', i:'ğŸ’°'},
          {k:'çˆ±æƒ…è¿', s:'çˆ±æƒ…', i:'ğŸ’•'}, {k:'å¥åº·è¿', s:'å¥åº·', i:'ğŸŒ¿'},
          {k:'è´µäººè¿', s:'è´µäºº', i:'âœ¨'}
        ];
        order.forEach(o=>{
          const v = dimsMap[o.k] ?? dimsMap[o.s];
          if(v==null) return;
          const node = document.createElement('div');
          node.className = 'dim';
          node.innerHTML = `
            <div class="dim-ico">${o.i}</div>
            <div class="dim-name">${o.s}</div>
            <div class="stars">${starsHTML(v)}</div>`;
          dimsWrap.appendChild(node);
        });

        // message + tips
        const summary = (fortune.fortune_text && fortune.fortune_text.summary) || fortune.summary || 'ä»Šæ—¥æ°”æ¯æ¾„æ˜ï¼Œéšé¡ºè€Œä¸ºï¼Œæ¸©æŸ”æ¥å¥½è¿ã€‚';
        $('scSummary').textContent = summary;

        const dos = (fortune.fortune_text && fortune.fortune_text.do) || fortune.do || [];
        const donts = (fortune.fortune_text && fortune.fortune_text.dont) || fortune.dont || [];
        $('scDo').innerHTML   = (dos.length? dos: ['ç•™ç™½ä¿®æ•´ï¼Œé™å¿ƒè‡ªçœ']).slice(0,6).map(x=>`<li>${x}</li>`).join('');
        $('scDont').innerHTML = (donts.length? donts: ['é¿å…å†²åŠ¨ä¸æƒ…ç»ªæ¶ˆè´¹']).slice(0,6).map(x=>`<li>${x}</li>`).join('');

        // lucky
        const colorName = fortune.lucky_color || (fortune.lucky_elements && fortune.lucky_elements.color) || '';
        const hex = hexByName(colorName);
        if(hex) $('scSwatch').style.background = hex;
        $('scColor').textContent = colorName || 'â€”';
        $('scNumber').textContent = fortune.lucky_number || (fortune.lucky_elements && fortune.lucky_elements.number) || 'â€”';
        $('scHour').textContent = fortune.lucky_hour || (fortune.lucky_elements && fortune.lucky_elements.hour) || 'â€”';
        $('scDirection').textContent = fortune.lucky_direction || (fortune.lucky_elements && fortune.lucky_elements.direction) || 'â€”';

        // site & qrï¼ˆembed/export é»˜è®¤å ä½ï¼›è‹¥æœåŠ¡ç«¯æ³¨å…¥äº† base64ï¼Œå¯æ˜¾ç¤ºï¼‰
        $('scSite').textContent = 'www.ruoshui.fun';
        if(data.qr_code){
          $('scQR').src = data.qr_code;
          $('scQR').style.display='block'; $('scQRPh').style.display='none';
        }else{
          $('scQR').style.display='none'; $('scQRPh').style.display='block';
        }
      }

      (async function init(){
        const injected = readInjected();
        const payload = injected.share_data || {};
        await fontsReady();
        render(payload);
        // é¦–æ¬¡æµ‹é‡
        setTimeout(postSize, 50);
        setTimeout(postSize, 400); // å­—ä½“å›æµåå†æµ‹ä¸€æ¬¡
      })();
    })();
  </script>
</body>
</html>
