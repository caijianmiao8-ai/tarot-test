<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æˆ‘çš„å¡”ç½—è¿åŠ¿ - è‹¥æ°´å åœ</title>
  <meta name="theme-color" content="#8e6c88"/>
  <style>
    :root{
      --violet:#8e6c88;      /* ä¸é¦™ç´«ï¼ˆä¸»è‰²ï¼‰ */
      --plum:#6d4c67;        /* æ·±æ¢…ç´«ï¼ˆå¼ºè°ƒï¼‰ */
      --champagne:#d6c3a3;   /* é¦™æ§Ÿé‡‘ï¼ˆæ–‡å­—/æè¾¹ï¼‰ */
      --ivory:#f8f4e9;       /* è±¡ç‰™æµ…åº•ï¼ˆç»†èŠ‚ï¼‰ */
      --ink:#1a1522;         /* ç„å¤œåº•è‰² */
      --ink-2:#0f0b16;       /* æ›´æ·± */
      --mist:rgba(255,255,255,.08);
      --glass:rgba(255,255,255,.06);
      --border:rgba(214,195,163,.35);
      --gold:#e5d3a0;
      --green:#65c18c;
      --rose:#ff8fb1;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      background:
        radial-gradient(1200px 800px at 80% -20%, rgba(142,108,136,.35), transparent 60%),
        radial-gradient(900px 700px at -10% 120%, rgba(109,76,103,.35), transparent 60%),
        linear-gradient(180deg,#201a2b 0%, #0e0b14 100%);
      color:#fff;
      display:flex;align-items:center;justify-content:center;padding:18px;
    }

    /* ç”»å¸ƒæ¯”ä¾‹ï¼šç¤¾äº¤å¹³å°å‹å¥½ï¼ˆ9:16 ç²¾è‡´å¡ç‰‡ï¼‰ */
    .frame{
      width:min(420px,94vw);
      aspect-ratio:9/16;
      position:relative;
      border-radius:28px;
      overflow:hidden;
      box-shadow:0 40px 80px rgba(0,0,0,.45);
      background:linear-gradient(180deg, var(--ink) 0%, var(--ink-2) 100%);
      isolation:isolate;
    }

    /* é•­å°„ç®”å…‰æ³½è¾¹æ¡†ï¼ˆç»†é‡‘è¾¹ + å˜è‰²è†œï¼‰ */
    .frame::before{
      content:"";
      position:absolute;inset:0;
      padding:1px;border-radius:28px;
      background:
        linear-gradient(135deg, rgba(214,195,163,.75), rgba(214,195,163,.25)) border-box;
      -webkit-mask:
        linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      pointer-events:none;
    }
    .foil{
      position:absolute;inset:-20%;
      background:
        conic-gradient(from 0deg at 30% 30%, rgba(255,255,255,.08), rgba(255,255,255,0) 35%),
        linear-gradient(90deg,rgba(142,108,136,.12),rgba(255,255,255,0),rgba(214,195,163,.12));
      mix-blend-mode:overlay;
      filter:blur(30px);
      animation:foil 12s ease-in-out infinite alternate;
      opacity:.6;pointer-events:none;
    }
    @keyframes foil{
      0%{transform:translate3d(-2%, -2%, 0) rotate(0.5deg)}
      100%{transform:translate3d(2%, 1%, 0) rotate(-0.5deg)}
    }

    /* æ˜Ÿç©ºä¸å¾®ç²’ */
    .stars, .dust{
      position:absolute;inset:0;pointer-events:none;z-index:0;
    }
    .stars::before, .stars::after{
      content:"";position:absolute;inset:0;background:
      radial-gradient(1px 1px at 20% 30%, #fff, transparent 55%),
      radial-gradient(1px 1px at 70% 10%, #fff, transparent 55%),
      radial-gradient(1px 1px at 80% 60%, #fff, transparent 55%),
      radial-gradient(1px 1px at 35% 80%, #fff, transparent 55%),
      radial-gradient(1px 1px at 60% 50%, #fff, transparent 55%);
      opacity:.25;animation:twinkle 5s linear infinite alternate;
    }
    .stars::after{animation-duration:7s;opacity:.18}
    @keyframes twinkle{
      0%{opacity:.12;filter:blur(.2px)}
      100%{opacity:.28;filter:blur(.0px)}
    }
    .dust{background-image:url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120">\
      <filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter>\
      <rect width="120" height="120" filter="url(%23n)" opacity="0.03"/></svg>');mix-blend-mode:soft-light}

    /* é¡¶éƒ¨ï¼šå“ç‰Œ/æ—¥æœŸ/ç”¨æˆ·å */
    .top{
      position:absolute;inset:18px 18px auto 18px;z-index:2;
      display:flex;align-items:center;justify-content:space-between;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      color:var(--champagne);letter-spacing:.12em;
      font-weight:600;font-size:12px;text-transform:uppercase;
    }
    .brand::before{
      content:"";width:18px;height:18px;border-radius:50%;
      background:
        radial-gradient(circle at 35% 35%, #fff8, transparent 60%),
        conic-gradient(from 180deg, #d7c7a9, #c5a67c, #d7c7a9);
      box-shadow:0 0 12px rgba(214,195,163,.45) inset;
    }
    .meta{
      display:flex;gap:10px;align-items:center;
      color:rgba(255,255,255,.7);font-size:12px;
    }
    .tag{
      padding:.18rem .5rem;border:1px solid var(--border);
      border-radius:999px;background:rgba(255,255,255,.04);
      color:var(--champagne)
    }

    /* ä¸­éƒ¨å¡ç‰‡å±•ç¤º + æ€»è¯„ä¸åœ†ç¯ */
    .body{
      position:absolute;inset:64px 18px 118px 18px;z-index:2;
      display:grid;grid-template-rows:auto 1fr;gap:14px;
    }

    .tarot{
      display:grid;grid-template-columns:1fr 1.15fr;gap:14px;
    }

    /* å¡ç‰‡ç”»æ¡†ï¼ˆé‡‘è¾¹+ç»ç’ƒï¼‰ */
    .art{
      border-radius:18px;position:relative;overflow:hidden;min-height:210px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      backdrop-filter: blur(8px);
      display:flex;align-items:center;justify-content:center;
    }
    .art::before{
      content:"";position:absolute;inset:0;
      background:
        linear-gradient(120deg, rgba(214,195,163,.15), transparent 35%),
        linear-gradient(300deg, rgba(142,108,136,.12), transparent 45%);
      mix-blend-mode:overlay;pointer-events:none;
    }
    .art img{width:88%;height:auto;max-height:92%;object-fit:cover;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .art .placeholder{
      width:88%;aspect-ratio:2/3;border-radius:12px;
      background:linear-gradient(135deg,#6a5a78 0%, #8e6c88 100%);
      display:flex;align-items:center;justify-content:center;
      color:#fff9;font-size:42px;letter-spacing:.1em;
      box-shadow:0 10px 30px rgba(0,0,0,.35)
    }

    .info{
      display:flex;flex-direction:column;gap:12px;justify-content:space-between;
    }
    .title{
      display:flex;flex-direction:column;gap:4px
    }
    .card-name{
      font-size:20px;font-weight:700;color:#fff;letter-spacing:.02em
    }
    .card-sub{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap
    }
    .pill{
      padding:.22rem .56rem;border-radius:999px;
      background:rgba(142,108,136,.18);
      border:1px solid rgba(214,195,163,.38);
      color:var(--champagne);font-size:12px
    }

    /* åœ†ç¯è¯„åˆ† */
    .score{
      display:flex;gap:12px;align-items:center
    }
    .ring{
      --p: .72; /* 72% ç¤ºä¾‹ï¼ŒJS åŠ¨æ€è¦†ç›– */
      width:72px;height:72px;border-radius:50%;
      background:
        conic-gradient(var(--gold) calc(var(--p)*360deg), rgba(255,255,255,.1) 0deg);
      position:relative;box-shadow:0 0 0 1px rgba(214,195,163,.25) inset;
    }
    .ring::before{
      content:"";position:absolute;inset:6px;border-radius:50%;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow: inset 0 0 0 1px rgba(214,195,163,.28);
    }
    .ring span{
      position:absolute;inset:0;display:grid;place-items:center;
      font-weight:800;color:#fff;letter-spacing:.02em
    }
    .score-col{
      display:flex;flex-direction:column;gap:4px
    }
    .score-label{color:rgba(255,255,255,.7);font-size:12px}
    .score-badge{
      font-size:12px;color:#121015;background:linear-gradient(90deg,#e9d9b8,#d6c3a3);
      display:inline-block;padding:.2rem .5rem;border-radius:999px;font-weight:700;letter-spacing:.06em
    }

    /* äº”ç»´åº¦ */
    .dim{
      display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:2px
    }
    .dim-item{text-align:center}
    .dim-ico{
      width:34px;height:34px;border-radius:50%;
      background:linear-gradient(135deg, rgba(142,108,136,.22), rgba(255,255,255,.02));
      border:1px solid var(--border);
      display:grid;place-items:center;margin:0 auto 4px;font-size:14px
    }
    .dim-name{color:rgba(255,255,255,.66);font-size:11px}
    .dim-stars{color:#ffd76a;font-size:11px;letter-spacing:.5px;margin-top:2px}
    .dim-tip{color:rgba(255,255,255,.6);font-size:10px;margin-top:2px;line-height:1.2}

    /* æ–‡æ¡ˆï¼šæ€»è¯„ + å®œå¿Œ */
    .copy{
      margin-top:10px;
      display:grid;grid-template-columns:1fr;gap:10px
    }
    .panel{
      background:var(--glass);border:1px solid var(--border);border-radius:14px;
      padding:12px;backdrop-filter: blur(8px);
    }
    .panel h4{font-size:12px;letter-spacing:.1em;color:var(--champagne);margin-bottom:6px}
    .summary{color:#fff;line-height:1.5;font-size:13px}
    .list{display:grid;gap:6px}
    .list li{font-size:12px;color:#fff;line-height:1.45}
    .list li::marker{color:var(--champagne)}

    /* åº•éƒ¨ï¼šäºŒç»´ç ä¸é“¾æ¥ */
    .bottom{
      position:absolute;inset:auto 16px 16px 16px;z-index:2;
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .qr{
      width:68px;height:68px;border-radius:12px;background:#fff;display:grid;place-items:center;border:1px solid rgba(0,0,0,.06)
    }
    .qr img{max-width:100%;max-height:100%}
    .qr-ph{width:100%;height:100%;background:
      repeating-linear-gradient(0deg,#000,#000 2px,#fff 2px,#fff 4px)}
    .link{
      flex:1;min-width:0
    }
    .link .t1{color:#fff;font-size:13px;margin-bottom:2px}
    .link .t2{color:rgba(255,255,255,.6);font-size:11px}
    .url{color:var(--champagne);font-size:10px;margin-top:6px;word-break:break-all}

    /* é¡¶éƒ¨æ“ä½œåŒºï¼ˆå¯¼å‡ºã€ç”Ÿæˆ/å¤åˆ¶ï¼‰ */
    .actions{
      position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
      display:flex;gap:12px;z-index:9
    }
    .btn{
      appearance:none;border:none;border-radius:999px;
      padding:10px 16px;display:inline-flex;gap:6px;align-items:center;
      font-weight:700;letter-spacing:.02em;cursor:pointer
    }
    .btn-primary{color:#fff;background:linear-gradient(135deg,#8e6c88,#6d4c67);border:1px solid rgba(214,195,163,.45);box-shadow:0 6px 18px rgba(142,108,136,.35)}
    .btn-ghost{color:#fff;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);backdrop-filter: blur(8px)}
    .hidden{display:none!important}

    @media (max-width:380px){
      .ring{width:64px;height:64px}
      .art{min-height:196px}
    }
  </style>
</head>
<body>
  <div class="frame" id="shareCard">
    <div class="foil"></div>
    <div class="stars"></div>
    <div class="dust"></div>

    <!-- é¡¶éƒ¨ -->
    <div class="top">
      <div class="brand">RUOSHUI TAROT</div>
      <div class="meta">
        <div class="tag" id="dateTag">--</div>
        <div class="tag" id="userTag">ç¥ç§˜è®¿å®¢</div>
      </div>
    </div>

    <!-- ä¸»ä½“ -->
    <div class="body">
      <div class="tarot">
        <div class="art">
          <img id="cardImg" alt="" class="hidden"/>
          <div id="cardPh" class="placeholder">TAROT</div>
        </div>
        <div class="info">
          <div class="title">
            <div class="card-name" id="cardName">--</div>
            <div class="card-sub">
              <div class="pill" id="cardDirection">--</div>
              <div class="pill" id="cardAlias">ä»Šæ—¥å¡”ç½—è¿åŠ¿</div>
            </div>
          </div>
          <div class="score">
            <div class="ring" id="ring"><span id="scoreNum">--</span></div>
            <div class="score-col">
              <div class="score-label">OVERALL</div>
              <div class="score-badge" id="scoreBadge">--</div>
            </div>
          </div>
          <div class="dim" id="dimGrid"><!-- JS render --></div>
        </div>
      </div>

      <div class="copy">
        <div class="panel">
          <h4>ä»Šæ—¥æ€»è¯„</h4>
          <div class="summary" id="summaryText">--</div>
        </div>
        <div class="panel" id="advPanel">
          <h4>ç»´åº¦å»ºè®®</h4>
          <ul class="list" id="advList"></ul>
        </div>
        <div class="panel">
          <h4>ä»Šæ—¥å®œ / å¿Œ</h4>
          <ul class="list" id="doList"></ul>
          <ul class="list" id="dontList" style="margin-top:6px;"></ul>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨ -->
    <div class="bottom">
      <div class="qr">
        <img id="qrImg" alt="QR" class="hidden"/>
        <div id="qrPh" class="qr-ph"></div>
      </div>
      <div class="link">
        <div class="t1">é•¿æŒ‰è¯†åˆ« Â· è‹¥æ°´å åœ</div>
        <div class="t2">å¸æ”¶å®‡å®™æ¸©æŸ”èƒ½é‡ Â· è½»ç›ˆåº¦è¿‡ä»Šå¤©</div>
        <div class="url" id="siteUrl">www.ruoshui.fun</div>
      </div>
    </div>
  </div>

  <!-- æ“ä½œæŒ‰é’®ï¼šæŸ¥çœ‹é¡µéšè—â€œç”Ÿæˆâ€ï¼Œæ˜¾ç¤ºâ€œå¤åˆ¶é“¾æ¥â€ -->
  <div class="actions" id="actions">
    <button class="btn btn-primary" id="btnGenerate">ğŸ´ ç”Ÿæˆåˆ†äº«å¡ç‰‡</button>
    <button class="btn btn-ghost hidden" id="btnCopy">ğŸ”— å¤åˆ¶é“¾æ¥</button>
    <button class="btn btn-ghost" id="btnSave">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
  </div>

  <!-- æœåŠ¡ç«¯æ•°æ®æ³¨å…¥ -->
  <script id="__DATA__" type="application/json">
  {
    "mode": "{{ 'view' if share_data is defined else 'own' }}",
    "share_url": "{{ (request.url if share_data is defined else '')|e }}",
    "user_name": "{{ (share_data['user_name'] if share_data is defined else (user.get('username','ç¥ç§˜è®¿å®¢') if user else 'ç¥ç§˜è®¿å®¢'))|e }}",
    "date_iso": "{{ (share_data['created_at'].isoformat() if share_data is defined and share_data.get('created_at') else '')|e }}",
    "today_str": "{{ (today if today is defined else '')|e }}",
    "reading": {{ (share_data['reading'] if share_data is defined else reading)|tojson }},
    "fortune": {{ (share_data['fortune'] if share_data is defined else fortune_data)|tojson }}
  }
  </script>

  <!-- ä¾èµ–ï¼šä»…å‰ç«¯å¯¼å‡ºå›¾ç‰‡ç”¨ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <script>
    function $(id){return document.getElementById(id)}
    function ymd(d){try{const t=typeof d==='string'?new Date(d):d;return `${t.getFullYear()}.${String(t.getMonth()+1).padStart(2,'0')}.${String(t.getDate()).padStart(2,'0')}`}catch{return '--'}}
    function labelByScore(s){s=Number(s)||0; if(s>=85)return'å¤§å‰'; if(s>=70)return'ä¸­å‰'; if(s>=55)return'å°å‰'; return'å¹³'}
    function toStars(v){let n=Number(v)||0; n=Math.max(0,Math.min(5,n));const f=Math.floor(n),h=(n-f)>=0.5?1:0; return 'â˜…'.repeat(f)+(h?'â¯ª':'')+'â˜†'.repeat(5-f-h)}
    function parseDims(s){const out={}; if(typeof s!=='string') return out; s.split(/\n+/).forEach(l=>{const m=l.match(/^(.*?)[ï¼š:]\s*([\d.]+)\s*æ˜Ÿ(?:ï¼ˆ(.*?)ï¼‰)?/); if(m){out[m[1].trim()]={v:parseFloat(m[2]), tag:(m[3]||'').trim()}}}); return out}

    function init(){
      const data = JSON.parse($('__DATA__').textContent||'{}');
      const mode = data.mode || 'own';
      const reading = data.reading || {};
      const fortune = data.fortune || {};

      // é¡¶éƒ¨ä¿¡æ¯
      const dateStr = (mode==='view' && data.date_iso) ? ymd(data.date_iso) : (data.today_str || '--');
      $('dateTag').textContent = dateStr;
      $('userTag').textContent = data.user_name || 'ç¥ç§˜è®¿å®¢';

      // ç‰Œé¢
      const name = reading.card_name || reading.name || '--';
      const dir  = reading.direction || reading.card_direction || '--';
      $('cardName').textContent = name;
      $('cardDirection').textContent = dir;
      const imgUrl = reading.image || reading.card_image || '';
      if(imgUrl){
        const img = $('cardImg'); img.src = imgUrl; img.onload = ()=>{ img.classList.remove('hidden'); $('cardPh').classList.add('hidden'); };
        img.onerror = ()=>{ /* ä¿ç•™å ä½ */ };
      }

      // æ€»åˆ†ä¸åœ†ç¯
      const score = Number(fortune.overall_score ?? fortune.overall ?? 0);
      $('scoreNum').textContent = score ? String(score) : '--';
      $('ring').style.setProperty('--p', (Math.max(0, Math.min(100, score))/100).toFixed(3));
      $('scoreBadge').textContent = `ä»Šæ—¥ Â· ${labelByScore(score)}`;

      // ç»´åº¦
      const grid = $('dimGrid'); grid.innerHTML='';
      const dims = typeof fortune.dimensions==='string' ? parseDims(fortune.dimensions) : fortune.dimensions || {};
      const order = ['äº‹ä¸šè¿','è´¢å¯Œè¿','çˆ±æƒ…è¿','å¥åº·è¿','è´µäººè¿'];
      const icons = {'äº‹ä¸šè¿':'ğŸ’¼','äº‹ä¸š':'ğŸ’¼','è´¢å¯Œè¿':'ğŸ’°','è´¢å¯Œ':'ğŸ’°','çˆ±æƒ…è¿':'â¤ï¸','çˆ±æƒ…':'â¤ï¸','å¥åº·è¿':'ğŸŒ¿','å¥åº·':'ğŸŒ¿','è´µäººè¿':'ğŸ¤','è´µäºº':'ğŸ¤'};
      order.forEach(k=>{
        const key2 = k.replace('è¿','');
        const obj = dims[k] || dims[key2];
        if(!obj) return;
        const v = typeof obj==='object' ? obj.v : obj;
        const tag = typeof obj==='object' ? obj.tag : '';
        const item = document.createElement('div');
        item.className='dim-item';
        item.innerHTML = `
          <div class="dim-ico">${icons[k]||'âœ¨'}</div>
          <div class="dim-name">${key2}</div>
          <div class="dim-stars">${toStars(v)}</div>
          ${tag? `<div class="dim-tip">${tag}</div>`:''}
        `;
        grid.appendChild(item);
      });

      // æ€»è¯„ / ç»´åº¦å»ºè®® / å®œå¿Œ
      const summary = fortune.summary || fortune.overall_text || '';
      $('summaryText').textContent = summary || 'ä»Šæ—¥æ—¥è¿æ¸©æŸ”è€Œç¨³ï¼Œé¡ºåŠ¿è€Œä¸ºï¼Œä¿æŒæ¾å¼›ï¼Œä¾¿èƒ½æ›´ä»å®¹åœ°æ¥ä½å¥½è¿ã€‚';

      const adv = fortune.dimension_advice || {};
      const advList = $('advList'); advList.innerHTML='';
      const advOrder = [['äº‹ä¸šè¿','äº‹ä¸š'],['è´¢å¯Œè¿','è´¢å¯Œ'],['çˆ±æƒ…è¿','çˆ±æƒ…'],['å¥åº·è¿','å¥åº·'],['è´µäººè¿','è´µäºº']];
      let advFilled = 0;
      advOrder.forEach(([a,b])=>{
        const text = adv[a] || adv[b];
        if(text){ advFilled++; const li=document.createElement('li'); li.textContent = `${b}ï¼š${text}`; advList.appendChild(li); }
      });
      if(!advFilled){ $('advPanel').classList.add('hidden'); }

      const doList = $('doList'); const dontList = $('dontList');
      (fortune.do || []).slice(0,3).forEach(t=>{ const li=document.createElement('li'); li.textContent = 'å®œï¼š' + t; doList.appendChild(li); });
      (fortune.dont || []).slice(0,3).forEach(t=>{ const li=document.createElement('li'); li.textContent = 'å¿Œï¼š' + t; dontList.appendChild(li); });

      // é“¾æ¥ & äºŒç»´ç 
      const site = mode==='view' ? (data.share_url || 'www.ruoshui.fun') : 'www.ruoshui.fun';
      $('siteUrl').textContent = site;

      if(mode==='view'){
        $('btnGenerate').classList.add('hidden');
        $('btnCopy').classList.remove('hidden');
      }

      $('btnGenerate').onclick = async ()=>{
        const btn=$('btnGenerate'); btn.disabled=true; btn.textContent='ç”Ÿæˆä¸­â€¦';
        try{
          const r = await fetch('/api/share/create',{method:'POST'});
          const d = await r.json();
          if(!d.success) throw new Error(d.error || 'ç”Ÿæˆå¤±è´¥');
          $('siteUrl').textContent = d.share_url || site;
          if(d.qr_code){ $('qrImg').src = d.qr_code; $('qrImg').classList.remove('hidden'); $('qrPh').classList.add('hidden'); }
          $('btnCopy').classList.remove('hidden');
          $('btnCopy').onclick = ()=>copyText(d.share_url);
          btn.textContent='å·²ç”Ÿæˆ';
        }catch(e){
          alert(e.message||'ç”Ÿæˆå¤±è´¥'); btn.textContent='ğŸ´ ç”Ÿæˆåˆ†äº«å¡ç‰‡';
        }finally{ btn.disabled=false; }
      };

      $('btnCopy').onclick = ()=> copyText($('siteUrl').textContent);
      $('btnSave').onclick = exportPNG;
    }

    function copyText(t){
      if(!t) return;
      (navigator.clipboard? navigator.clipboard.writeText(t) : Promise.reject()).then(
        ()=>alert('é“¾æ¥å·²å¤åˆ¶'),
        ()=>{
          const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); ta.remove(); alert('é“¾æ¥å·²å¤åˆ¶');
        }
      );
    }

    async function exportPNG(){
      const actions=$('actions'); actions.classList.add('hidden');
      try{
        const canvas = await html2canvas($('shareCard'),{scale:2,useCORS:true,backgroundColor:null});
        const url = canvas.toDataURL('image/png');
        const a=document.createElement('a'); a.href=url; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click();
      }catch(e){ alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•'); }
      finally{ actions.classList.remove('hidden'); }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
