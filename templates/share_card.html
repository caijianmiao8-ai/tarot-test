<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æˆ‘çš„å¡”ç½—è¿åŠ¿ - è‹¥æ°´å åœ</title>
  <meta name="theme-color" content="#667eea"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;
    }
    .share-card{
      width:375px;height:667px;background:linear-gradient(180deg,#1a1a2e 0%,#0f0f1e 100%);
      border-radius:24px;overflow:hidden;position:relative;box-shadow:0 30px 60px rgba(0,0,0,.4)
    }
    .celestial-bg{position:absolute;width:100%;height:100%;overflow:hidden}
    .star{position:absolute;background:white;border-radius:50%;animation:twinkle 3s infinite}
    @keyframes twinkle{0%,100%{opacity:.3}50%{opacity:1}}
    .glow-orb{position:absolute;width:300px;height:300px;border-radius:50%;
      background:radial-gradient(circle,rgba(138,97,255,.3) 0%,transparent 70%);
      filter:blur(40px);animation:float 6s ease-in-out infinite}
    .glow-orb:nth-child(1){top:-150px;right:-100px;animation-delay:0s}
    .glow-orb:nth-child(2){bottom:-150px;left:-100px;background:radial-gradient(circle,rgba(255,97,218,.3) 0%,transparent 70%);animation-delay:3s}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
    .card-content{position:relative;z-index:10;height:100%;display:flex;flex-direction:column;padding:30px 25px}
    .header-section{text-align:center;margin-bottom:25px}
    .date-label{color:rgba(255,255,255,.5);font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px}
    .user-name{color:#fff;font-size:18px;font-weight:300;margin-bottom:5px}
    .divination-type{color:#b794f6;font-size:14px;font-weight:500}
    .tarot-display{background:linear-gradient(135deg,rgba(138,97,255,.1) 0%,rgba(255,97,218,.1) 100%);
      border-radius:20px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(10px)}
    .card-image-container{width:120px;height:180px;margin:0 auto 15px;position:relative;transform-style:preserve-3d;animation:subtle-rotate 8s ease-in-out infinite}
    @keyframes subtle-rotate{0%,100%{transform:rotateY(0)}50%{transform:rotateY(10deg)}}
    .card-image{width:100%;height:100%;border-radius:12px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);box-shadow:0 10px 30px rgba(102,126,234,.3)}
    .card-image img{width:100%;height:100%;object-fit:cover}
    .card-image::before{content:'';position:absolute;width:100%;height:100%;
      background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(255,255,255,.05) 10px,rgba(255,255,255,.05) 20px)}
    .card-icon{font-size:48px;color:rgba(255,255,255,.9)}
    .card-info{text-align:center}
    .card-name{color:#fff;font-size:20px;font-weight:500;margin-bottom:5px}
    .card-direction{color:#b794f6;font-size:14px}
    .fortune-section{flex:1;display:flex;flex-direction:column;gap:15px}
    .overall-score{background:linear-gradient(135deg,rgba(255,97,218,.1) 0%,rgba(138,97,255,.1) 100%);border-radius:16px;padding:15px;text-align:center;border:1px solid rgba(255,255,255,.1)}
    .score-number{font-size:36px;font-weight:bold;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .score-label{color:rgba(255,255,255,.7);font-size:12px;margin-top:5px}
    .dimensions-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .dimension-item{text-align:center}
    .dimension-icon{width:36px;height:36px;margin:0 auto 5px;background:linear-gradient(135deg,rgba(138,97,255,.2) 0%,rgba(255,97,218,.2) 100%);
      border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.1)}
    .dimension-name{color:rgba(255,255,255,.6);font-size:10px;margin-bottom:3px}
    .dimension-stars{color:#ffd700;font-size:11px;letter-spacing:1px}
    .lucky-elements{background:rgba(255,255,255,.03);border-radius:12px;padding:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .lucky-item{display:flex;align-items:center;gap:8px}
    .lucky-label{color:rgba(255,255,255,.5);font-size:11px}
    .lucky-value{color:#b794f6;font-size:12px;font-weight:500}
    .footer-section{margin-top:auto;padding-top:20px;border-top:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:space-between}
    .qr-container{width:60px;height:60px;background:white;border-radius:8px;padding:8px;display:flex;align-items:center;justify-content:center}
    .qr-placeholder{width:100%;height:100%;background:repeating-linear-gradient(0deg,#000,#000 2px,#fff 2px,#fff 4px)}
    .invite-text{flex:1;margin-left:15px}
    .invite-title{color:#fff;font-size:14px;margin-bottom:3px}
    .invite-subtitle{color:rgba(255,255,255,.5);font-size:11px}
    .site-url{color:#b794f6;font-size:10px;margin-top:5px;word-break:break-all}
    .moon-phase{position:absolute;top:30px;right:30px;width:30px;height:30px;border-radius:50%;background:linear-gradient(90deg,#fff 50%,transparent 50%);opacity:.3}
    .mystical-symbol{position:absolute;width:100px;height:100px;opacity:.05;
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="white" stroke-width="1"/><polygon points="50,10 61,40 90,40 65,60 76,90 50,70 24,90 35,60 10,40 39,40" fill="none" stroke="white" stroke-width="1"/></svg>');animation:rotate-slow 30s linear infinite}
    .mystical-symbol:nth-child(1){top:100px;left:-50px}
    .mystical-symbol:nth-child(2){bottom:100px;right:-50px;animation-direction:reverse}
    @keyframes rotate-slow{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .action-buttons{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:15px;z-index:100}
    .action-btn{padding:12px 24px;border-radius:24px;border:none;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s ease;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .generate-btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 15px rgba(102,126,234,.3)}
    .generate-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
    .save-btn{background:rgba(255,255,255,.1);color:white;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2)}
    .save-btn:hover{background:rgba(255,255,255,.15)}
    .copy-btn{background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.2)}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="share-card" id="shareCard">
    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div class="celestial-bg" id="celestialBg"></div>
    <!-- å…‰æ™•æ•ˆæœ -->
    <div class="glow-orb"></div><div class="glow-orb"></div>
    <!-- è£…é¥° -->
    <div class="mystical-symbol"></div><div class="mystical-symbol"></div>
    <div class="moon-phase"></div>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="card-content">
      <div class="header-section">
        <div class="date-label" id="dateLabel">--</div>
        <div class="user-name" id="userName">--</div>
        <div class="divination-type">âœ¨ ä»Šæ—¥å¡”ç½—è¿åŠ¿ âœ¨</div>
      </div>

      <div class="tarot-display">
        <div class="card-image-container">
          <div class="card-image" id="cardImage">
            <div class="card-icon" id="cardIcon">ğŸ´</div>
            <!-- è‹¥æœ‰å›¾ç‰‡ï¼Œå°†ä»¥ <img> å¡«å…… -->
          </div>
        </div>
        <div class="card-info">
          <div class="card-name" id="cardName">--</div>
          <div class="card-direction" id="cardDirection">--</div>
        </div>
      </div>

      <div class="fortune-section">
        <div class="overall-score">
          <div class="score-number" id="scoreNumber">--</div>
          <div class="score-label" id="scoreLabel">ä»Šæ—¥è¿åŠ¿ Â· --</div>
        </div>

        <div class="dimensions-grid" id="dimensionsGrid">
          <!-- JS æ¸²æŸ“ï¼šäº‹ä¸š/è´¢å¯Œ/çˆ±æƒ…/å¥åº·/è´µäºº -->
        </div>

        <div class="lucky-elements" id="luckyElements">
          <div class="lucky-item"><span class="lucky-label">å¹¸è¿è‰²ï¼š</span><span class="lucky-value" id="luckyColor">--</span></div>
          <div class="lucky-item"><span class="lucky-label">å¹¸è¿æ•°ï¼š</span><span class="lucky-value" id="luckyNumber">--</span></div>
          <div class="lucky-item"><span class="lucky-label">å¹¸è¿æ—¶ï¼š</span><span class="lucky-value" id="luckyHour">--</span></div>
          <div class="lucky-item"><span class="lucky-label">å¹¸è¿æ–¹ï¼š</span><span class="lucky-value" id="luckyDirection">--</span></div>
        </div>
      </div>

      <div class="footer-section">
        <div class="qr-container">
          <img id="qrImg" class="hidden" alt="åˆ†äº«äºŒç»´ç " />
          <div id="qrPlaceholder" class="qr-placeholder"></div>
        </div>
        <div class="invite-text">
          <div class="invite-title" id="inviteTitle">æ‰«ç æµ‹è¯•ä½ çš„è¿åŠ¿</div>
          <div class="invite-subtitle">æ¢ç´¢å®‡å®™èƒ½é‡çš„æŒ‡å¼•</div>
          <div class="site-url" id="siteUrl">www.ruoshui.fun</div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ“ä½œæŒ‰é’®ï¼ˆæŸ¥çœ‹é¡µéšè—â€œç”Ÿæˆâ€ï¼Œæ˜¾ç¤ºâ€œå¤åˆ¶é“¾æ¥â€ï¼‰ -->
  <div class="action-buttons" id="actions">
    <button class="action-btn generate-btn" id="btnGenerate">
      <span>ğŸ´</span><span>ç”Ÿæˆåˆ†äº«å¡ç‰‡</span>
    </button>
    <button class="action-btn copy-btn hidden" id="btnCopy">
      <span>ğŸ”—</span><span>å¤åˆ¶é“¾æ¥</span>
    </button>
    <button class="action-btn save-btn" id="btnSave">
      <span>ğŸ’¾</span><span>ä¿å­˜å›¾ç‰‡</span>
    </button>
  </div>

  <!-- æœåŠ¡ç«¯æ•°æ®æ³¨å…¥ï¼ˆä¸¤ç§æ¨¡å¼å…¼å®¹ï¼‰ï¼šshare_data ä¼˜å…ˆï¼Œå¦åˆ™ user/reading/fortune_data/today -->
  <script id="__DATA__" type="application/json">
  {
    "mode": "{{ 'view' if share_data is defined else 'own' }}",
    "share_url": "{{ (request.url if share_data is defined else '')|e }}",
    "user_name": "{{ (share_data['user_name'] if share_data is defined else (user.get('username','ç¥ç§˜è®¿å®¢') if user else 'ç¥ç§˜è®¿å®¢'))|e }}",
    "date_iso": "{{ (share_data['created_at'].isoformat() if share_data is defined and share_data.get('created_at') else '')|e }}",
    "today_str": "{{ (today if today is defined else '')|e }}",
    "reading": {{ (share_data['reading'] if share_data is defined else reading)|tojson }},
    "fortune": {{ (share_data['fortune'] if share_data is defined else fortune_data)|tojson }}
  }
  </script>

  <!-- ä¾èµ–ï¼šhtml2canvasï¼ˆä¿å­˜å›¾ç‰‡ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <script>
    // ===== å·¥å…·å‡½æ•° =====
    function $(id){return document.getElementById(id)}
    function fmtDateYMD(d){
      try{
        const dt = (typeof d==='string')? new Date(d) : d;
        const y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), day = String(dt.getDate()).padStart(2,'0');
        return `${y}.${m}.${day}`;
      }catch{ return '--' }
    }
    function scoreLabel(s){
      s = Number(s)||0;
      if(s>=85) return 'å¤§å‰';
      if(s>=70) return 'ä¸­å‰';
      if(s>=55) return 'å°å‰';
      return 'å¹³';
    }
    function toStars(val){ // æ”¯æŒ 3.5 -> â˜…â˜…â˜…â¯ªâ˜†
      let n = Number(val)||0; n = Math.max(0, Math.min(5, n));
      const full = Math.floor(n);
      const half = (n - full)>=0.5 ? 1 : 0;
      return 'â˜…'.repeat(full) + (half?'â¯ª':'') + 'â˜†'.repeat(5-full-half);
    }
    function parseDimensions(dimStr){
      // è§£æå½¢å¦‚ï¼š
      // äº‹ä¸šè¿ï¼š3.5æ˜Ÿï¼ˆä¸­å‰ï¼‰\nè´¢å¯Œè¿ï¼š4.0æ˜Ÿï¼ˆä¸­å‰ï¼‰...
      const out = {};
      if(typeof dimStr !== 'string') return out;
      dimStr.split(/\n+/).forEach(line=>{
        const m = line.match(/^(.*?)[ï¼š:]\s*([\d.]+)\s*æ˜Ÿ/);
        if(m){ out[m[1].trim()] = parseFloat(m[2]); }
      });
      return out;
    }
    function setText(id, val){ const el=$(id); if(el) el.textContent = (val ?? '--'); }

    // æ˜Ÿç©º
    function generateStars(){
      const celestialBg = $('celestialBg');
      if(!celestialBg) return;
      const starCount = 50;
      for(let i=0;i<starCount;i++){
        const s=document.createElement('div');
        s.className='star';
        const size = Math.random()*3;
        s.style.width = size+'px';
        s.style.height = size+'px';
        s.style.left = (Math.random()*100)+'%';
        s.style.top = (Math.random()*100)+'%';
        s.style.animationDelay = (Math.random()*3)+'s';
        celestialBg.appendChild(s);
      }
    }

    // ===== é¡µé¢åˆå§‹åŒ–ï¼ˆä¸¤ç§æ¨¡å¼ï¼‰=====
    function init(){
      generateStars();

      const data = JSON.parse(document.getElementById('__DATA__').textContent || '{}');
      const mode = data.mode || 'own';
      const reading = data.reading || {};
      const fortune = data.fortune || {};

      // å¤´éƒ¨
      const dateStr = (mode==='view' && data.date_iso) ? fmtDateYMD(data.date_iso) : (data.today_str || '--');
      setText('dateLabel', dateStr);
      setText('userName', data.user_name || 'ç¥ç§˜è®¿å®¢');

      // ç‰Œé¢
      const cardName = reading.card_name || reading.name || '--';
      const direction = reading.direction || reading.card_direction || '--';
      setText('cardName', cardName);
      setText('cardDirection', direction);

      const imgUrl = reading.image || reading.card_image || '';
      const cardImage = $('cardImage'), cardIcon = $('cardIcon');
      if(imgUrl){
        const img = new Image();
        img.onload = ()=>{ cardImage.innerHTML=''; cardImage.appendChild(img); };
        img.onerror = ()=>{ /* ä¿ç•™æ¸å˜+icon */ };
        img.src = imgUrl;
      } else {
        if(cardIcon) cardIcon.textContent = 'ğŸ´';
      }

      // åˆ†æ•°ä¸æ ‡ç­¾
      const overall = fortune.overall_score ?? fortune.overall ?? '';
      setText('scoreNumber', overall || '--');
      setText('scoreLabel', 'ä»Šæ—¥è¿åŠ¿ Â· ' + scoreLabel(overall));

      // ç»´åº¦
      const dims = (typeof fortune.dimensions === 'string') ? parseDimensions(fortune.dimensions) : (fortune.dimensions || {});
      const icons = {'äº‹ä¸šè¿':'ğŸ’¼','äº‹ä¸š':'ğŸ’¼','è´¢å¯Œè¿':'ğŸ’°','è´¢å¯Œ':'ğŸ’°','çˆ±æƒ…è¿':'â¤ï¸','çˆ±æƒ…':'â¤ï¸','å¥åº·è¿':'ğŸŒ¿','å¥åº·':'ğŸŒ¿','è´µäººè¿':'ğŸ¤','è´µäºº':'ğŸ¤'};
      const order = ['äº‹ä¸šè¿','è´¢å¯Œè¿','çˆ±æƒ…è¿','å¥åº·è¿','è´µäººè¿'];
      const grid = $('dimensionsGrid');
      grid.innerHTML='';
      order.forEach(key=>{
        const v = (dims[key] ?? dims[key.replace('è¿','')]);
        if(v==null) return;
        const item = document.createElement('div');
        item.className='dimension-item';
        item.innerHTML = `
          <div class="dimension-icon">${icons[key]||'âœ¨'}</div>
          <div class="dimension-name">${key.replace('è¿','')}</div>
          <div class="dimension-stars">${toStars(v)}</div>
        `;
        grid.appendChild(item);
      });

      // å¹¸è¿å…ƒç´ 
      setText('luckyColor', fortune.lucky_color || '--');
      setText('luckyNumber', fortune.lucky_number || '--');
      setText('luckyHour', fortune.lucky_hour || '--');
      setText('luckyDirection', fortune.lucky_direction || '--');

      // æŸ¥çœ‹é¡µï¼šéšè—â€œç”Ÿæˆâ€ï¼Œæ˜¾ç¤ºâ€œå¤åˆ¶é“¾æ¥â€ï¼›äºŒç»´ç å ä½ç»´æŒï¼ˆå¯é€‰ï¼‰
      const btnGen=$('btnGenerate'), btnCopy=$('btnCopy'), siteUrl=$('siteUrl');
      if(mode==='view'){
        if(btnGen) btnGen.classList.add('hidden');
        if(btnCopy) btnCopy.classList.remove('hidden');
        if(siteUrl) siteUrl.textContent = data.share_url || 'www.ruoshui.fun';
      }

      // æŒ‰é’®äº‹ä»¶
      if(btnGen){
        btnGen.onclick = async ()=>{
          btnGen.disabled = true; btnGen.textContent = 'ç”Ÿæˆä¸­...';
          try{
            const resp = await fetch('/api/share/create', {method:'POST'});
            const d = await resp.json();
            if(!d.success) throw new Error(d.error || 'ç”Ÿæˆå¤±è´¥');
            // å¡«å……é“¾æ¥ä¸äºŒç»´ç 
            if(d.share_url){ $('siteUrl').textContent = d.share_url; }
            const qrImg=$('qrImg'), ph=$('qrPlaceholder');
            if(d.qr_code && qrImg){
              qrImg.src = d.qr_code;
              qrImg.classList.remove('hidden');
              if(ph) ph.classList.add('hidden');
            }
            // åˆ‡æ¢ä¸ºâ€œå¤åˆ¶é“¾æ¥â€
            if(btnCopy){ btnCopy.classList.remove('hidden'); btnCopy.onclick=()=>copyText(d.share_url); }
            btnGen.textContent = 'å·²ç”Ÿæˆ';
          }catch(e){
            alert(e.message || 'ç”Ÿæˆå¤±è´¥');
            btnGen.textContent = 'ç”Ÿæˆåˆ†äº«å¡ç‰‡';
          }finally{
            btnGen.disabled = false;
          }
        };
      }
      if(btnCopy && !btnCopy.onclick){
        btnCopy.onclick = ()=> copyText(siteUrl?.textContent || location.href);
      }
      const btnSave=$('btnSave');
      if(btnSave){
        btnSave.onclick = async ()=>{
          const actions = $('actions'); if(actions) actions.classList.add('hidden');
          try{
            const node = $('shareCard');
            const canvas = await html2canvas(node,{scale:2,useCORS:true,backgroundColor:null});
            const url = canvas.toDataURL('image/png');
            const a=document.createElement('a');
            a.href=url; a.download=`tarot_${Date.now()}.png`; a.click();
          }catch(e){ alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•'); }
          finally{ const actions=$('actions'); if(actions) actions.classList.remove('hidden'); }
        };
      }
    }

    function copyText(text){
      if(!text) return;
      navigator.clipboard?.writeText(text).then(()=>alert('é“¾æ¥å·²å¤åˆ¶')).catch(()=>{
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove(); alert('é“¾æ¥å·²å¤åˆ¶');
      });
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
