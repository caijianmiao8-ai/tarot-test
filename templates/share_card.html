<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>è‹¥æ°´å åœ Â· åˆ†äº«å¡ç‰‡</title>
  <meta name="theme-color" content="#8e6c88"/>
  <style>
    :root{
      --violet:#8e6c88; --plum:#6d4c67; --ink:#120f1a; --ink2:#0b0811;
      --champ:#d6c3a3; --gold:#e8d9b6; --mist:rgba(255,255,255,.06); --bd:rgba(214,195,163,.34);
      --good:#65c18c; --warn:#ffb86b; --bad:#ff8fa3;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;
      background:
        radial-gradient(1200px 800px at 85% -10%, rgba(142,108,136,.35), transparent 60%),
        radial-gradient(900px 700px at -10% 120%, rgba(109,76,103,.35), transparent 60%),
        linear-gradient(180deg,#1c1626 0%, #0e0b14 100%);
      font-family: ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      color:#fff;
    }
    /* 9:16 ç”»å¸ƒï¼ˆç¤¾äº¤å‹å¥½ï¼‰ */
    .frame{
      width:min(420px,94vw); aspect-ratio:9/16; position:relative; border-radius:28px; overflow:hidden;
      background:linear-gradient(180deg, var(--ink) 0%, var(--ink2) 100%);
      box-shadow:0 40px 80px rgba(0,0,0,.45); isolation:isolate;
    }
    /* é‡‘ç®”ç»†è¾¹ */
    .frame::before{
      content:""; position:absolute; inset:0; padding:1px; border-radius:28px;
      background:linear-gradient(120deg, rgba(214,195,163,.75), rgba(214,195,163,.22)) border-box;
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none;
    }
    /* é•­å°„å¾®å…‰ */
    .foil{position:absolute; inset:-20%; filter:blur(28px); mix-blend-mode:overlay; opacity:.55; pointer-events:none;
      background:
        conic-gradient(from 0deg at 35% 35%, rgba(255,255,255,.08), rgba(255,255,255,0) 40%),
        linear-gradient(90deg, rgba(142,108,136,.12), rgba(255,255,255,0), rgba(214,195,163,.12));
      animation:foil 12s ease-in-out infinite alternate;}
    @keyframes foil{0%{transform:translate3d(-2%,-2%,0) rotate(.6deg)}100%{transform:translate3d(2%,1%,0) rotate(-.6deg)}}
    /* æ˜Ÿè½¨ä¸å¾®ç²’ */
    .stars,.dust{position:absolute; inset:0; pointer-events:none}
    .stars::before,.stars::after{content:""; position:absolute; inset:0; opacity:.22; animation:twinkle 6s linear infinite alternate;
      background:
        radial-gradient(1px 1px at 20% 30%, #fff, transparent 55%),
        radial-gradient(1px 1px at 70% 10%, #fff, transparent 55%),
        radial-gradient(1px 1px at 74% 66%, #fff, transparent 55%),
        radial-gradient(1px 1px at 34% 78%, #fff, transparent 55%),
        radial-gradient(1px 1px at 58% 52%, #fff, transparent 55%);
    }
    .stars::after{animation-duration:8s; opacity:.16}
    @keyframes twinkle{0%{opacity:.1; filter:blur(.2px)}100%{opacity:.28; filter:blur(0)}}
    .dust{background-image:url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120">\
      <filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter>\
      <rect width="120" height="120" filter="url(%23n)" opacity="0.03"/></svg>');mix-blend-mode:soft-light}

    /* é¡¶æ ï¼šå“ç‰Œã€æ—¥æœŸã€ç”¨æˆ· */
    .top{position:absolute; inset:16px 16px auto 16px; display:flex; justify-content:space-between; align-items:center; z-index:2}
    .brand{display:flex; align-items:center; gap:10px; color:var(--champ); font-weight:700; letter-spacing:.12em; font-size:12px}
    .brand::before{content:""; width:18px;height:18px;border-radius:50%;
      background:radial-gradient(circle at 35% 35%, #fff8, transparent 60%), conic-gradient(from 210deg, #d7c7a9, #c5a67c, #d7c7a9);
      box-shadow:0 0 12px rgba(214,195,163,.45) inset}
    .meta{display:flex; gap:8px}
    .tag{padding:.22rem .56rem; border-radius:999px; background:rgba(255,255,255,.05); border:1px solid var(--bd); color:var(--champ); font-size:12px}

    /* ä¸»ä½“ */
    .body{position:absolute; inset:58px 14px 110px 14px; display:grid; grid-template-rows:auto 1fr; gap:12px; z-index:2}
    .hero{display:grid; grid-template-columns:1fr 1.2fr; gap:12px}

    /* å¡å›¾ç”»æ¡† */
    .art{border-radius:18px; overflow:hidden; position:relative; min-height:208px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid var(--bd); backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center}
    .art::before{content:""; position:absolute; inset:0;
      background:linear-gradient(120deg, rgba(214,195,163,.16), transparent 40%), linear-gradient(300deg, rgba(142,108,136,.12), transparent 50%);
      mix-blend-mode:overlay}
    .art img{width:88%; max-height:92%; object-fit:cover; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .ph{width:88%; aspect-ratio:2/3; border-radius:12px;
      background:linear-gradient(135deg,#6a5a78 0%, #8e6c88 100%);
      display:grid; place-items:center; color:#fff9; font-size:42px; letter-spacing:.1em; box-shadow:0 10px 30px rgba(0,0,0,.35)}

    .info{display:flex; flex-direction:column; gap:10px; justify-content:space-between}
    .title{display:flex; flex-direction:column; gap:4px}
    .name{font-size:20px; font-weight:800; letter-spacing:.02em}
    .sub{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:.22rem .56rem; border-radius:999px; background:rgba(142,108,136,.18); border:1px solid rgba(214,195,163,.38); color:var(--champ); font-size:12px}

    /* æ€»åˆ†åœ†ç¯ */
    .score{display:flex; gap:12px; align-items:center}
    .ring{--p:.66; width:74px;height:74px;border-radius:50%;
      background:conic-gradient(var(--gold) calc(var(--p)*360deg), rgba(255,255,255,.12) 0deg);
      position:relative; box-shadow:0 0 0 1px rgba(214,195,163,.25) inset}
    .ring::before{content:""; position:absolute; inset:6px; border-radius:50%;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); box-shadow: inset 0 0 0 1px rgba(214,195,163,.28)}
    .ring span{position:absolute; inset:0; display:grid; place-items:center; font-weight:800}
    .score-col{display:flex; flex-direction:column; gap:4px}
    .badge{font-size:12px; color:#121015; background:linear-gradient(90deg,#eadbb8,#d6c3a3); padding:.24rem .6rem; border-radius:999px; font-weight:800; letter-spacing:.05em}
    .muted{font-size:12px; color:rgba(255,255,255,.7)}

    /* ç»´åº¦ */
    .dims{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-top:2px}
    .dim{ text-align:center }
    .ico{width:34px;height:34px;border-radius:50%; margin:0 auto 4px; display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(142,108,136,.22), rgba(255,255,255,.02)); border:1px solid var(--bd); font-size:14px}
    .dname{font-size:11px; color:rgba(255,255,255,.66)}
    .stars{font-size:11px; color:#ffd76a; letter-spacing:.5px; margin-top:2px}
    .dtip{font-size:10px; color:rgba(255,255,255,.6); margin-top:2px; line-height:1.2}

    /* æ–‡æ¡ˆï¼šæ€»è¯„ã€å»ºè®®ã€å®œå¿Œã€å¹¸è¿å…ƒç´ ã€ç‰Œä¹‰è§£æ */
    .section{background:var(--mist); border:1px solid var(--bd); border-radius:14px; padding:12px; backdrop-filter: blur(8px)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .h{font-size:12px; letter-spacing:.1em; color:var(--champ); margin-bottom:6px}
    .summary{font-size:13px; line-height:1.6}
    .list{display:grid; gap:6px}
    .list li{font-size:12px; line-height:1.45}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{padding:.28rem .6rem; border-radius:999px; border:1px solid var(--bd); background:rgba(255,255,255,.05); font-size:12px; color:var(--champ)}
    .lucky{display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center}
    .swatch{width:34px;height:34px;border-radius:10px; border:1px solid rgba(0,0,0,.08); background:#c9c9c9}
    .label{font-size:12px; color:rgba(255,255,255,.7)}
    .value{font-size:13px; font-weight:700}
    .analysis{font-size:12.5px; line-height:1.6}

    /* åº•æ ï¼šäºŒç»´ç ã€é“¾æ¥ */
    .bottom{position:absolute; inset:auto 14px 14px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; z-index:2}
    .qr{width:70px;height:70px;border-radius:12px;background:#fff;display:grid;place-items:center;border:1px solid rgba(0,0,0,.06)}
    .qr img{max-width:100%;max-height:100%}
    .qrph{width:100%;height:100%;background:repeating-linear-gradient(0deg,#000,#000 2px,#fff 2px,#fff 4px)}
    .link{flex:1;min-width:0}
    .t1{font-size:13px}
    .t2{font-size:11px; color:rgba(255,255,255,.7)}
    .url{font-size:10px; color:var(--champ); margin-top:6px; word-break:break-all}

    /* é¡¶éƒ¨æ“ä½œæ¡ï¼ˆå¯¼å‡º/ç”Ÿæˆ/å¤åˆ¶ï¼‰ */
    .actions{position:fixed; left:50%; bottom:20px; transform:translateX(-50%); display:flex; gap:10px; z-index:9}
    .btn{appearance:none; border:none; border-radius:999px; padding:10px 16px; display:inline-flex; gap:6px; align-items:center; font-weight:800; letter-spacing:.02em; cursor:pointer}
    .primary{color:#fff; background:linear-gradient(135deg,#8e6c88,#6d4c67); border:1px solid rgba(214,195,163,.45); box-shadow:0 6px 18px rgba(142,108,136,.35)}
    .ghost{color:#fff; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); backdrop-filter: blur(8px)}
    .hidden{display:none!important}

    @media (max-width:380px){
      .ring{width:66px;height:66px}
      .art{min-height:196px}
    }
  </style>
</head>
<body>
  <div class="frame" id="shareCard">
    <div class="foil"></div><div class="stars"></div><div class="dust"></div>

    <!-- é¡¶æ  -->
    <div class="top">
      <div class="brand">RUOSHUI TAROT</div>
      <div class="meta">
        <div class="tag" id="dateTag">--</div>
        <div class="tag" id="userTag">ç¥ç§˜è®¿å®¢</div>
      </div>
    </div>

    <!-- ä¸»ä½“ -->
    <div class="body">
      <div class="hero">
        <!-- ç‰Œå›¾ -->
        <div class="art">
          <img id="cardImg" alt="Tarot" class="hidden"/>
          <div id="cardPh" class="ph">TAROT</div>
        </div>

        <!-- æ¦‚è§ˆ -->
        <div class="info">
          <div class="title">
            <div class="name" id="cardName">â€”</div>
            <div class="sub">
              <div class="pill" id="cardDirection">â€”</div>
              <div class="pill">ä»Šæ—¥å¡”ç½—è¿åŠ¿</div>
            </div>
          </div>

          <div class="score">
            <div class="ring" id="ring"><span id="scoreNum">â€”</span></div>
            <div class="score-col">
              <div class="muted">OVERALL</div>
              <div class="badge" id="scoreBadge">â€”</div>
            </div>
          </div>

          <!-- ç»´åº¦ -->
          <div class="dims" id="dims"><!-- JS render --></div>
        </div>
      </div>

      <!-- æ–‡æ¡ˆ/è¯¦æƒ…åŒº -->
      <div class="section">
        <div class="h">ä»Šæ—¥æ€»è¯„</div>
        <div class="summary" id="summaryText">â€”</div>
      </div>

      <div class="grid2">
        <div class="section">
          <div class="h">ä»Šæ—¥å®œ</div>
          <ul class="list" id="doList"></ul>
        </div>
        <div class="section">
          <div class="h">ä»Šæ—¥å¿Œ</div>
          <ul class="list" id="dontList"></ul>
        </div>
      </div>

      <div class="grid2">
        <div class="section">
          <div class="h">å¹¸è¿å…ƒç´ </div>
          <div class="lucky">
            <div class="swatch" id="swatch"></div>
            <div>
              <div class="label">å¹¸è¿è‰²</div>
              <div class="value" id="luckyColor">â€”</div>
            </div>
          </div>
          <div class="chips" style="margin-top:10px">
            <div class="chip" id="luckyNumber">æ•°å­— â€”</div>
            <div class="chip" id="luckyHour">æ—¶è¾° â€”</div>
            <div class="chip" id="luckyDirection">æ–¹ä½ â€”</div>
          </div>
        </div>

        <div class="section">
          <div class="h">ç‰Œä¹‰è§£æ</div>
          <div class="analysis" id="analysisText">â€”</div>
        </div>
      </div>
    </div>

    <!-- åº•æ  -->
    <div class="bottom">
      <div class="qr">
        <img id="qrImg" alt="QR" class="hidden"/>
        <div id="qrPh" class="qrph"></div>
      </div>
      <div class="link">
        <div class="t1">é•¿æŒ‰è¯†åˆ« Â· è‹¥æ°´å åœ</div>
        <div class="t2">å¸æ”¶å®‡å®™æ¸©æŸ”èƒ½é‡ Â· è½»ç›ˆåº¦è¿‡ä»Šå¤©</div>
        <div class="url" id="siteUrl">www.ruoshui.fun</div>
      </div>
    </div>
  </div>

  <!-- æ“ä½œæ¡ -->
  <div class="actions" id="actions">
    <button class="btn primary" id="btnGenerate">ğŸ´ ç”Ÿæˆåˆ†äº«</button>
    <button class="btn ghost hidden" id="btnCopy">ğŸ”— å¤åˆ¶é“¾æ¥</button>
    <button class="btn ghost" id="btnSave">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
  </div>

  <!-- æœåŠ¡ç«¯æ•°æ®æ³¨å…¥ï¼ˆshare_data ä¼˜å…ˆï¼Œå¦åˆ™ user/reading/fortune_data/todayï¼‰ -->
  <script id="__DATA__" type="application/json">
  {
    "mode": "{{ 'view' if share_data is defined else 'own' }}",
    "share_url": "{{ (request.url if share_data is defined else '')|e }}",
    "user_name": "{{ (share_data['user_name'] if share_data is defined else (user.get('username','ç¥ç§˜è®¿å®¢') if user else 'ç¥ç§˜è®¿å®¢'))|e }}",
    "date_iso": "{{ (share_data['created_at'].isoformat() if share_data is defined and share_data.get('created_at') else '')|e }}",
    "today_str": "{{ (today if today is defined else '')|e }}",
    "reading": {{ (share_data['reading'] if share_data is defined else reading)|tojson }},
    "fortune": {{ (share_data['fortune'] if share_data is defined else fortune_data)|tojson }}
  }
  </script>

  <!-- å‰ç«¯å¯¼å‡ºä¾èµ–ï¼ˆæœ¬åœ°æ¸²æŸ“ï¼Œä¸ä¼šå¯¼è‡´åç«¯ 500ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <script>
    /* ======= å°å·¥å…· & å…¼å®¹å±‚ ======= */
    function $(id){return document.getElementById(id)}
    function ymd(d){try{const t=typeof d==='string'?new Date(d):d;return `${t.getFullYear()}.${String(t.getMonth()+1).padStart(2,'0')}.${String(t.getDate()).padStart(2,'0')}`}catch{return '--'}}
    function labelScore(s){s=Number(s)||0; if(s>=85)return'å¤§å‰'; if(s>=70)return'ä¸­å‰'; if(s>=55)return'å°å‰'; return'å¹³'}
    function toStars(v){let n=Number(v)||0; n=Math.max(0,Math.min(5,n)); const f=Math.floor(n), h=(n-f)>=0.5?1:0; return 'â˜…'.repeat(f)+(h?'â¯ª':'')+'â˜†'.repeat(5-f-h)}
    function parseDimsStr(s){
      const out={}; if(typeof s!=='string') return out;
      s.split(/\n+/).forEach(l=>{const m=l.match(/^(.*?)[ï¼š:]\s*([\d.]+)\s*æ˜Ÿ(?:ï¼ˆ(.*?)ï¼‰)?/); if(m){out[m[1].trim()]={v:parseFloat(m[2]), tag:(m[3]||'').trim()}}});
      return out;
    }
    /* å¸¸è§ä¸­æ–‡é¢œè‰²æ˜ å°„åˆ° HEX */
    const COLOR_MAP = {
      "çº¢":"#e85b70","çº¢è‰²":"#e85b70","ç«çº¢":"#ff4d6d","ç²‰":"#f4a5c7","ç²‰è‰²":"#f4a5c7","æ¡ƒç²‰":"#ff9eb5",
      "æ©™":"#ffa24d","æ©™è‰²":"#ffa24d","é‡‘":"#d6c3a3","é‡‘è‰²":"#d6c3a3","é¦™æ§Ÿé‡‘":"#e8d9b6",
      "é»„":"#ffd66b","é»„è‰²":"#ffd66b","å¥¶æ²¹é»„":"#fde3a7",
      "ç»¿":"#65c18c","ç»¿è‰²":"#65c18c","ç¥–æ¯ç»¿":"#2f8f6a","è–„è·ç»¿":"#9be7c4",
      "é’ç»¿":"#5cc8b8","é’è‰²":"#4fb3d9","é’":"#4fb3d9",
      "è“":"#6aa8ff","è“è‰²":"#6aa8ff","é›é’":"#3b5ba7",
      "ç´«":"#8e6c88","ç´«è‰²":"#8e6c88","ä¸é¦™ç´«":"#a788b3","è‘¡è„ç´«":"#6d4c67",
      "ç™½":"#f8f4e9","ç™½è‰²":"#f8f4e9","è±¡ç‰™ç™½":"#f8f4e9","ç±³ç™½":"#f7f0df",
      "é»‘":"#222","é»‘è‰²":"#222","é“¶":"#ddd","é“¶è‰²":"#ddd"
    };
    function colorToHex(name){ if(!name) return null; for(const k in COLOR_MAP){ if(name.includes(k)) return COLOR_MAP[k]; } return null; }

    /* å°†åç«¯ä»»æ„å½¢æ€çš„ fortune æ‹å¹³æˆç»Ÿä¸€å¯ç”¨ç»“æ„ï¼ˆä¸ç ´ååŸå­—æ®µï¼‰ */
    function flattenFortune(f0){
      const f = JSON.parse(JSON.stringify(f0||{}));
      const ft = f.fortune_text || {};
      // æå‡ summary / do / dont / dimension_advice
      if(ft.summary && !f.summary) f.summary = ft.summary;
      if(ft.do && !f.do) f.do = ft.do;
      if(ft.dont && !f.dont) f.dont = ft.dont;
      if(ft.dimension_advice && !f.dimension_advice) f.dimension_advice = ft.dimension_advice;

      // å¹¸è¿å…ƒç´ æ‰å¹³
      const lucky = f.lucky_elements || {};
      f.lucky_color = f.lucky_color || lucky.color || '';
      f.lucky_number = f.lucky_number || lucky.number || '';
      f.lucky_hour = f.lucky_hour || lucky.hour || '';
      f.lucky_direction = f.lucky_direction || lucky.direction || '';

      // ç»´åº¦ï¼šæ”¯æŒæ•°ç»„ / æ–‡æœ¬ / map
      if(Array.isArray(f.dimensions)){
        const map={}; f.dimensions.forEach(d=>{ if(d && d.name) map[d.name] = Number(d.stars ?? d.score ?? 0) });
        f.dimensions_map = map;
        if(!f.dimensions_text){
          f.dimensions_text = f.dimensions.map(d=>`${d.name}ï¼š${d.stars ?? d.score}æ˜Ÿï¼ˆ${d.level||''}ï¼‰`).join("\n");
        }
      }else if(typeof f.dimensions==='string'){
        f.dimensions_text = f.dimensions;
      }else if(typeof f.dimensions==='object' && f.dimensions){
        f.dimensions_map = f.dimensions_map || f.dimensions;
      }
      return f;
    }

    function render(){
      const data = JSON.parse(('__DATA__' in window ? document.getElementById('__DATA__').textContent : '{}') || '{}');
      const mode = data.mode || 'own';
      const reading = data.reading || {};
      const fortune = flattenFortune(data.fortune);

      // é¡¶æ 
      const dateStr = (mode==='view' && data.date_iso) ? ymd(data.date_iso) : (data.today_str || '--');
      document.getElementById('dateTag').textContent = dateStr;
      document.getElementById('userTag').textContent = data.user_name || 'ç¥ç§˜è®¿å®¢';

      // ç‰Œé¢
      const name = reading.card_name || reading.name || 'â€”';
      const dir  = reading.direction || reading.card_direction || 'â€”';
      document.getElementById('cardName').textContent = name;
      document.getElementById('cardDirection').textContent = dir;

      const imgUrl = reading.image || reading.card_image || '';
      if(imgUrl){
        const img=$('cardImg'); img.src=imgUrl;
        img.onload = ()=>{ img.classList.remove('hidden'); $('cardPh').classList.add('hidden'); };
      }

      // æ€»åˆ† + åœ†ç¯
      const s = Number(fortune.overall_score ?? fortune.overall ?? 0);
      $('scoreNum').textContent = s ? String(s) : 'â€”';
      $('ring').style.setProperty('--p', (Math.max(0,Math.min(100,s))/100).toFixed(3));
      $('scoreBadge').textContent = `ä»Šæ—¥ Â· ${labelScore(s)}`;

      // ç»´åº¦ + ç»´åº¦å»ºè®®
      const dimsEl = $('dims'); dimsEl.innerHTML='';
      const dimsMap = (function(){
        if(fortune.dimensions_text) return parseDimsStr(fortune.dimensions_text);
        if(fortune.dimensions_map) {
          const o={}; for(const k in fortune.dimensions_map){ o[k]={v:Number(fortune.dimensions_map[k])} } return o;
        }
        return {};
      })();
      const advise = fortune.dimension_advice || {};
      const order = ['äº‹ä¸šè¿','è´¢å¯Œè¿','çˆ±æƒ…è¿','å¥åº·è¿','è´µäººè¿'];
      const icon = {'äº‹ä¸šè¿':'ğŸ’¼','äº‹ä¸š':'ğŸ’¼','è´¢å¯Œè¿':'ğŸ’°','è´¢å¯Œ':'ğŸ’°','çˆ±æƒ…è¿':'â¤ï¸','çˆ±æƒ…':'â¤ï¸','å¥åº·è¿':'ğŸŒ¿','å¥åº·':'ğŸŒ¿','è´µäººè¿':'ğŸ¤','è´µäºº':'ğŸ¤'};
      order.forEach(k=>{
        const short = k.replace('è¿','');
        const d = dimsMap[k] || dimsMap[short];
        if(!d) return;
        const tip = advise[k] || advise[short] || '';
        const item = document.createElement('div');
        item.className='dim';
        item.innerHTML = `
          <div class="ico">${icon[k]||'âœ¨'}</div>
          <div class="dname">${short}</div>
          <div class="stars">${toStars(d.v)}</div>
          ${tip ? `<div class="dtip">${tip}</div>` : ``}
        `;
        dimsEl.appendChild(item);
      });

      // æ€»è¯„
      $('summaryText').textContent = fortune.summary || 'ä»Šæ—¥æ—¥è¿æŸ”å’Œè€Œæ¸…æ¾ˆï¼Œé¡ºåŠ¿è€Œè¡Œï¼Œå¿ƒæ€€æ¾å¼›ï¼Œè¶³ä»¥æ¥ä½æ¸©æŸ”å¥½è¿ã€‚';

      // å®œ / å¿Œ
      const dos = (fortune.do || []).slice(0,3);
      const donts = (fortune.dont || []).slice(0,3);
      $('doList').innerHTML = dos.length ? dos.map(t=>`<li>âœ… ${t}</li>`).join('') : '<li>â€”</li>';
      $('dontList').innerHTML = donts.length ? donts.map(t=>`<li>â›” ${t}</li>`).join('') : '<li>â€”</li>';

      // å¹¸è¿å…ƒç´ ï¼ˆå«è‰²å—ï¼‰
      const luckyColorName = fortune.lucky_color || (fortune.lucky_elements && fortune.lucky_elements.color) || '';
      const luckyHex = colorToHex(luckyColorName);
      const swatch = $('swatch'); if(luckyHex) swatch.style.background = luckyHex;
      $('luckyColor').textContent = luckyColorName || 'â€”';
      $('luckyNumber').textContent = 'æ•°å­— ' + (fortune.lucky_number || (fortune.lucky_elements && fortune.lucky_elements.number) || 'â€”');
      $('luckyHour').textContent = 'æ—¶è¾° ' + (fortune.lucky_hour || (fortune.lucky_elements && fortune.lucky_elements.hour) || 'â€”');
      $('luckyDirection').textContent = 'æ–¹ä½ ' + (fortune.lucky_direction || (fortune.lucky_elements && fortune.lucky_elements.direction) || 'â€”');

      // ç‰Œä¹‰è§£æï¼ˆéšæ­£é€†ä½ï¼‰
      const isRev = (dir||'').includes('é€†');
      const meaning = isRev ? (reading.meaning_rev || reading.meaning_reverse) : (reading.meaning_up || reading.meaning_upright);
      $('analysisText').textContent = meaning || 'â€”';

      // é“¾æ¥ & æ¨¡å¼
      const site = mode==='view' ? (data.share_url || 'www.ruoshui.fun') : 'www.ruoshui.fun';
      $('siteUrl').textContent = site;
      if(mode==='view'){ $('btnGenerate').classList.add('hidden'); $('btnCopy').classList.remove('hidden'); }
    }

    /* ======= äº¤äº’ï¼šç”Ÿæˆ / å¤åˆ¶ / ä¿å­˜ ======= */
    async function genShare(){
      const btn=$('btnGenerate'); btn.disabled=true; btn.textContent='ç”Ÿæˆä¸­â€¦';
      try{
        const r = await fetch('/api/share/create',{method:'POST'});
        const d = await r.json();
        if(!d.success) throw new Error(d.error || 'ç”Ÿæˆå¤±è´¥');
        // å›å¡«é“¾æ¥ & äºŒç»´ç 
        $('siteUrl').textContent = d.share_url || $('siteUrl').textContent;
        if(d.qr_code){ $('qrImg').src = d.qr_code; $('qrImg').classList.remove('hidden'); $('qrPh').classList.add('hidden'); }
        $('btnCopy').classList.remove('hidden');
        $('btnCopy').onclick = ()=>copyText(d.share_url);
        btn.textContent='å·²ç”Ÿæˆ';
      }catch(e){ alert(e.message||'ç”Ÿæˆå¤±è´¥'); btn.textContent='ğŸ´ ç”Ÿæˆåˆ†äº«'; }
      finally{ btn.disabled=false; }
    }
    function copyText(t){
      if(!t) t = $('siteUrl').textContent;
      (navigator.clipboard? navigator.clipboard.writeText(t) : Promise.reject()).then(
        ()=>alert('é“¾æ¥å·²å¤åˆ¶'),
        ()=>{
          const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); ta.remove(); alert('é“¾æ¥å·²å¤åˆ¶');
        }
      );
    }
    async function savePNG(){
      const actions=$('actions'); actions.classList.add('hidden');
      try{
        const canvas = await html2canvas($('shareCard'),{scale:2.2,useCORS:true,backgroundColor:null});
        const url = canvas.toDataURL('image/png'); const a=document.createElement('a');
        a.href=url; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click();
      }catch(e){ alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•'); }
      finally{ actions.classList.remove('hidden'); }
    }

    window.addEventListener('load', ()=>{
      render();
      $('btnGenerate').onclick = genShare;
      $('btnCopy').onclick = ()=>copyText();
      $('btnSave').onclick = savePNG;
    });
  </script>
</body>
</html>
