<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>我的塔罗统计</title>
  <meta name="theme-color" content="#1a1625" />

  <!-- 本地化 Bootstrap / FontAwesome 与 index 保持一致 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    /* ===== 宇宙暗色主题令牌（与 index / result 对齐） ===== */
    :root{
      --primary:#9d7ea8; --secondary:#6d5675; --gold:#e8d4a2; --gold-light:#f4e5c3;
      --bg1:#2d1b4e; --bg2:#1a1625; --panel:rgba(255,255,255,.06); --panel-2:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.12); --text:#ffffff; --text-light:rgba(255,255,255,.88); --text-muted:rgba(255,255,255,.65);
      --success:#10b981; --warning:#f59e0b;
    }

    *{box-sizing:border-box}
    html,body{min-height:100dvh;min-height:calc(var(--vh,1vh)*100)}
    body{
      font-family:'Noto Serif SC',-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      color:var(--text); display:flex; flex-direction:column; align-items:center; padding:20px; position:relative; overflow-x:hidden;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(1200px 700px at 80% 90%, rgba(232,212,162,.12), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
    }

    /* 背景层（与 index 同款） */
    .bg-stars{position:fixed;inset:0;z-index:-2;opacity:.25;background-image:
      radial-gradient(1px 1px at 12% 25%, #fff, transparent),
      radial-gradient(1px 1px at 32% 60%, #fff, transparent),
      radial-gradient(1px 1px at 62% 30%, #fff, transparent),
      radial-gradient(1px 1px at 82% 70%, #fff, transparent),
      radial-gradient(1px 1px at 22% 80%, #fff, transparent);
      background-size:220px 220px;animation:twinkle 4s ease-in-out infinite alternate;pointer-events:none}
    @keyframes twinkle{from{opacity:.15}to{opacity:.35}}
    .bg-veil{position:fixed; inset:-10% -10% 0 -10%; z-index:-5; pointer-events:none; opacity:.9; filter:blur(2px);
      background:
        radial-gradient(800px 500px at 12% 14%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(720px 460px at 82% 72%, rgba(232,212,162,.12), transparent 60%),
        radial-gradient(900px 560px at 58% 12%, rgba(157,126,168,.10), transparent 70%);
      animation:veilDrift 50s linear infinite alternate}
    @keyframes veilDrift{to{transform:translate3d(-10px,8px,0)}}

    /* 顶部用户栏（完全复用 index 风格） */
    .user-bar{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(28,22,40,.6);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .user-bar-content{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-icon{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid var(--border)}
    .user-name{color:var(--gold-light);font-weight:600;letter-spacing:.5px}
    .user-actions{display:flex;gap:10px}
    .user-actions a{color:var(--text-light);text-decoration:none;font-size:.95rem;padding:8px 14px;border-radius:18px;border:1px solid transparent;transition:.25s;background:var(--panel)}
    .user-actions a:hover{color:#fff;border-color:var(--border);transform:translateY(-1px)}

    /* 统计主容器（对齐 result 的玻璃质感） */
    .stats-container{max-width:900px;width:100%;margin:88px auto 20px;padding:28px;background:var(--panel);border-radius:20px;border:1px solid var(--border);box-shadow:0 18px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08);position:relative;overflow:hidden}
    .header{text-align:center;margin-bottom:24px}
    .header h1{font-size:2.2rem;font-weight:800;color:var(--gold-light);text-shadow:0 2px 8px rgba(0,0,0,.25)}
    .header p{font-size:1.05rem;color:var(--text-muted);margin-top:8px}

    /* 统计卡片网格 */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin-bottom:24px}
    .stat-card{background:var(--panel-2);border-radius:14px;padding:22px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.18);transition:.25s;border:1px solid var(--border);position:relative;overflow:hidden}
    .stat-card::before{content:"";position:absolute;inset:-50% -50%;background:radial-gradient(circle, rgba(157,126,168,.16), transparent 70%);transform:rotate(45deg);opacity:0;transition:.5s}
    .stat-card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,.24)}
    .stat-card:hover::before{opacity:1}
    .stat-card i{font-size:2.4rem;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px;filter:drop-shadow(0 4px 8px rgba(0,0,0,.25))}
    .stat-number{font-size:2.2rem;font-weight:800;color:#fff;line-height:1;margin:8px 0}
    .stat-label{font-size:1rem;color:var(--text-muted)}

    /* 最近记录 */
    .recent-section{margin-top:20px}
    .section-title{font-size:1.5rem;color:var(--gold-light);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .readings-list{background:var(--panel);border-radius:14px;padding:18px;border:1px solid var(--border);box-shadow:0 6px 16px rgba(0,0,0,.18)}
    .reading-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;margin-bottom:12px;background:rgba(255,255,255,.04);border-radius:12px;border-left:4px solid var(--primary);transition:.25s;position:relative;overflow:hidden;border:1px solid var(--border)}
    .reading-item::before{content:"";position:absolute;left:0;top:0;height:100%;width:4px;background:linear-gradient(180deg,var(--primary),var(--secondary));transition:.25s;z-index:0}
    .reading-item:hover{transform:translateX(6px);box-shadow:0 8px 20px rgba(0,0,0,.22);background:rgba(255,255,255,.06)}
    .reading-item:hover::before{width:6px;filter:brightness(1.2)}
    .reading-info{display:flex;align-items:center;gap:16px;z-index:1}
    .reading-date{background:linear-gradient(135deg,var(--secondary), #d4c5b0);color:#1a1625;padding:6px 12px;border-radius:18px;font-weight:700;font-size:.9rem;min-width:86px;text-align:center;box-shadow:0 3px 8px rgba(0,0,0,.18)}
    .card-name{font-weight:700;color:#fff;font-size:1.05rem;display:flex;align-items:center;gap:8px}
    .card-name i{font-size:1rem;opacity:.6}
    .direction-badge{background:linear-gradient(135deg,var(--success),#16a34a);color:#fff;padding:6px 12px;border-radius:18px;font-size:.9rem;font-weight:800;display:flex;align-items:center;gap:6px;z-index:1;box-shadow:0 3px 8px rgba(0,0,0,.24);border:1px solid rgba(255,255,255,.12)}
    .direction-badge.reverse{background:linear-gradient(135deg,var(--warning),#d97706)}

    /* 空状态 */
    .empty-state{text-align:center;padding:48px 24px;color:var(--text-muted)}
    .empty-state i{font-size:3.6rem;margin-bottom:16px;color:var(--gold-light);opacity:.6}
    .empty-state h3{font-size:1.4rem;margin-bottom:6px;color:#fff}

    /* 按钮（与其他页统一） */
    .action-buttons{display:flex;justify-content:center;gap:12px;margin-top:20px;flex-wrap:wrap}
    .btn-tarot{display:inline-flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:12px 28px;border:none;border-radius:26px;font-size:1rem;font-weight:800;cursor:pointer;text-decoration:none;transition:.25s;box-shadow:0 12px 26px rgba(157,126,168,.4)}
    .btn-tarot:hover{transform:translateY(-2px);box-shadow:0 16px 34px rgba(157,126,168,.5)}
    .btn-tarot.secondary{background:transparent;color:var(--text-light);border:1px solid var(--border)}
    .btn-tarot.secondary:hover{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}

    .info-message{text-align:center;margin-top:18px;padding:14px;background:rgba(157,126,168,.10);border-radius:14px;color:var(--gold-light);border:1px solid var(--border)}

    /* 响应式 */
    @media (max-width:768px){
      .stats-container{padding:20px;margin-top:calc(70px + env(safe-area-inset-top,0px))}
      .header h1{font-size:1.9rem}
      .stat-number{font-size:2rem}
      .reading-item{flex-direction:column;align-items:flex-start;gap:10px;padding:12px}
      .reading-info{width:100%;justify-content:space-between}
      .btn-tarot{width:100%}
    }

    /* 计数动画（沿用原逻辑） */
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    .stat-card.loading{animation:pulse 2s infinite}
  </style>
</head>
<body>
  <!-- 背景层 -->
  <div class="bg-stars"></div>
  <div class="bg-veil" aria-hidden="true"></div>

  <!-- 用户栏（统一导航：首页/今日运势/登录注册/统计/退出） -->
  <div class="user-bar">
    <div class="user-bar-content">
      <div class="user-info">
        <div class="user-icon">
          {% if user and user.username %}
            {{ user.username[0]|upper }}
          {% else %}
            <i class="fas fa-user"></i>
          {% endif %}
        </div>
        <span class="user-name">{{ user.username if user and user.username else "神秘访客" }}</span>
      </div>
      <div class="user-actions">
        <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> 首页</a>
        {% if user and (not user.is_guest) %}
          <a href="{{ url_for('result') }}"><i class="fas fa-moon"></i> 今日运势</a>
          <a href="{{ url_for('stats') }}"><i class="fas fa-chart-line"></i> 统计</a>
          <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> 退出</a>
        {% else %}
          <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> 登录</a>
          <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> 注册</a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="stats-container">
    <div class="header">
      <h1><i class="fas fa-chart-line"></i> 我的塔罗统计</h1>
      <p>探索您的占卜历程和能量轨迹</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <i class="fas fa-layer-group"></i>
        <div class="stat-number" data-target="{{ total_readings }}">0</div>
        <div class="stat-label">累计抽牌次数</div>
      </div>

      <div class="stat-card">
        <i class="fas fa-calendar-check"></i>
        <div class="stat-number" data-target="{{ user.visit_count if user else 1 }}">0</div>
        <div class="stat-label">访问次数</div>
      </div>

      <div class="stat-card">
        <i class="fas fa-fire"></i>
        <div class="stat-number" data-target="{% if user and user.first_visit %}{{ ((user.last_visit - user.first_visit).days + 1) if user.last_visit and user.first_visit else 1 }}{% else %}1{% endif %}">0</div>
        <div class="stat-label">使用天数</div>
      </div>
    </div>

    <div class="recent-section">
      <h2 class="section-title"><i class="fas fa-history"></i> 最近的占卜记录</h2>
      <div class="readings-list">
        {% if recent_readings %}
          {% for reading in recent_readings %}
          <div class="reading-item" style="animation-delay: {{ loop.index * 0.1 }}s">
            <div class="reading-info">
              <div class="reading-date"><i class="fas fa-calendar-day"></i> {{ reading.date.strftime('%m-%d') if reading.date else '未知' }}</div>
              <div class="card-name"><i class="fas fa-moon"></i> {{ reading.card_name or '未知卡牌' }}</div>
            </div>
            <div class="direction-badge {% if reading.direction == '逆位' %}reverse{% endif %}">
              {{ reading.direction or '正位' }}
              <i class="fas {% if reading.direction == '逆位' %}fa-arrow-down{% else %}fa-arrow-up{% endif %}"></i>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <i class="fas fa-sparkles"></i>
            <h3>还没有占卜记录</h3>
            <p>开始您的第一次塔罗占卜，探索宇宙的智慧吧</p>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="action-buttons">
      <a href="{{ url_for('index') }}" class="btn-tarot secondary"><i class="fas fa-home"></i> 返回首页</a>
      {% if total_readings == 0 %}
      <a href="{{ url_for('index') }}" class="btn-tarot"><i class="fas fa-star"></i> 开始占卜</a>
      {% else %}
      <a href="{{ url_for('result') }}" class="btn-tarot"><i class="fas fa-eye"></i> 查看今日运势</a>
      {% endif %}
    </div>

    <div class="info-message">
      <p><i class="fas fa-shield-alt"></i> 您的占卜记录已安全保存，可在不同设备间同步访问</p>
    </div>
  </div>

  <script>
    // 视口高度 --vh（iOS 适配，保持与 index 同步）
    function setVh(){ document.documentElement.style.setProperty('--vh', window.innerHeight*0.01 + 'px'); }
    setVh(); window.addEventListener('resize', setVh);

    // 数字动画效果（保留原逻辑）
    document.addEventListener('DOMContentLoaded', function(){
      const statNumbers = document.querySelectorAll('.stat-number');
      const animateNumber = (el)=>{
        const target = parseInt(el.getAttribute('data-target')) || 0;
        const duration = 1500; const start = 0; const increment = target / (duration / 16); let current = start;
        const update = ()=>{ current += increment; if(current >= target){ el.textContent = target; el.closest('.stat-card')?.classList.remove('loading'); } else { el.textContent = Math.floor(current); requestAnimationFrame(update); } };
        el.closest('.stat-card')?.classList.add('loading'); update();
      };
      const observer = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{ if(entry.isIntersecting){ animateNumber(entry.target); observer.unobserve(entry.target); } });
      }, { threshold:.5 });
      statNumbers.forEach(num=>observer.observe(num));

      // 记录项淡入动画（保留）
      const readingItems = document.querySelectorAll('.reading-item');
      readingItems.forEach((item, idx)=>{
        item.style.opacity = '0'; item.style.transform = 'translateY(20px)';
        setTimeout(()=>{ item.style.transition = 'all .5s ease'; item.style.opacity = '1'; item.style.transform = 'translateY(0)'; }, 100 + (idx*100));
      });
    });
  </script>
</body>
</html>
