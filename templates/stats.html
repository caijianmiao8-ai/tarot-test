<!DOCTYPE html>
<html lang="zh-CN">
<head>
  {% include 'partials/_meta_pwa.html' %}
  {% block title %}<title>我的塔罗统计</title>{% endblock %}
  <style>
    :root{ --warning:#f59e0b; } /* 页面内补充，和 result 一致 */

    /* 容器：与 index/result 一致的玻璃质感 */
    .stats-container{
      max-width:900px;width:100%;
      margin:calc(88px + env(safe-area-inset-top,0px)) auto 20px;
      padding:26px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow:0 15px 30px rgba(0,0,0,.25);
      position:relative;overflow:hidden;
      animation:fadeIn .8s ease-out;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}

    .header{text-align:center;margin-bottom:26px}
    .header h1{
      font-size:2rem;font-weight:800;letter-spacing:.6px;
      color:var(--gold-light);text-shadow:0 2px 6px rgba(0,0,0,.25);margin:0 0 8px
    }
    .header p{font-size:1rem;color:var(--text-light);opacity:.9;margin:0}

    /* 指标卡片网格 */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin:10px 0 20px}
    .stat-card{
      background:rgba(255,255,255,.08);
      border:1px solid var(--border);
      border-radius:14px;padding:18px;
      text-align:center;box-shadow:0 8px 18px rgba(0,0,0,.14);
      transition:.25s;position:relative;overflow:hidden
    }
    .stat-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,.18)}
    .stat-card i{
      font-size:2.2rem;margin-bottom:10px;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      filter:drop-shadow(0 4px 8px rgba(157,126,168,.25));
    }
    .stat-number{font-size:2.4rem;font-weight:800;color:#fff;line-height:1;margin:2px 0 6px}
    .stat-label{font-size:.95rem;color:var(--text-muted);font-weight:600}

    /* 最近记录 */
    .recent-section{margin-top:8px}
    .section-title{
      font-size:1.35rem;color:var(--gold-light);margin:0 0 14px;
      padding-bottom:10px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:10px;font-weight:800
    }
    .readings-list{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:14px;padding:14px;
      box-shadow:0 5px 15px rgba(0,0,0,.08)
    }
    .reading-item{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:14px 12px;margin-bottom:10px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);border-radius:12px;
      transition:.25s;position:relative;overflow:hidden
    }
    .reading-item:hover{transform:translateX(4px);box-shadow:0 8px 18px rgba(0,0,0,.14)}
    .reading-item:last-child{margin-bottom:0}
    .reading-info{display:flex;align-items:center;gap:14px;z-index:1}
    .reading-date{
      background:linear-gradient(135deg,var(--secondary),#d4c5b0);
      color:#1a1625;padding:6px 12px;border-radius:999px;
      font-weight:700;font-size:.85rem;min-width:74px;text-align:center
    }
    .card-name{font-weight:700;color:#fff;font-size:1rem;display:flex;align-items:center;gap:8px}
    .card-name i{font-size:.95rem;opacity:.7}
    .direction-badge{
      background:linear-gradient(135deg,var(--success),#0ea171);
      color:#fff;padding:6px 12px;border-radius:999px;
      font-size:.85rem;font-weight:800;display:flex;align-items:center;gap:6px;z-index:1;
      box-shadow:0 3px 8px rgba(0,0,0,.12)
    }
    .direction-badge.reverse{background:linear-gradient(135deg,var(--warning),#d97706)}

    /* 空状态 */
    .empty-state{text-align:center;padding:40px 20px;color:var(--text-muted)}
    .empty-state i{font-size:3.4rem;margin-bottom:12px;color:var(--gold-light);opacity:.7}
    .empty-state h3{font-size:1.3rem;margin:4px 0 6px;color:#fff}

    /* 操作按钮 */
    .action-buttons{display:flex;justify-content:center;gap:12px;margin-top:18px;flex-wrap:wrap}
    .btn-tarot{
      display:inline-flex;align-items:center;gap:10px;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;padding:12px 24px;border-radius:999px;text-decoration:none;font-weight:800;
      box-shadow:0 10px 20px rgba(157,126,168,.3);transition:.25s
    }
    .btn-tarot:hover{transform:translateY(-2px)}
    .btn-tarot.secondary{background:#fff;color:var(--primary);border:2px solid var(--primary)}

    .info-message{
      text-align:center;margin-top:16px;padding:14px;
      background:rgba(255,255,255,.06);border:1px solid var(--border);
      border-radius:12px;color:var(--text-light)
    }

    /* 响应式 */
    @media (max-width:768px){
      .stats-container{padding:20px;margin-top:calc(74px + env(safe-area-inset-top,0px))}
      .header h1{font-size:1.6rem}
      .stat-number{font-size:2rem}
      .reading-item{flex-direction:column;align-items:flex-start}
      .reading-info{width:100%;justify-content:space-between}
      .btn-tarot{width:100%;justify-content:center}
    }

    /* 轻量呼吸动画（用于首次加载数值） */
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
    .stat-card.loading{animation:pulse 2s infinite}
  </style>
</head>
<body>
  {% include 'partials/_bg_layers.html' %}
  {% include 'partials/_user_bar.html' %}

  <div class="stats-container">
    <div class="header">
      <h1><i class="fas fa-chart-line"></i> 我的塔罗统计</h1>
      <p>探索您的占卜历程和能量轨迹</p>
    </div>

    <!-- 指标卡片：数据动画沿用你的 data-target 逻辑 -->
    <div class="stats-grid">
      <div class="stat-card">
        <i class="fas fa-layer-group"></i>
        <div class="stat-number" data-target="{{ total_readings }}">0</div>
        <div class="stat-label">累计抽牌次数</div>
      </div>

      <div class="stat-card">
        <i class="fas fa-calendar-check"></i>
        <div class="stat-number" data-target="{{ user.visit_count if user else 1 }}">0</div>
        <div class="stat-label">访问次数</div>
      </div>

      <div class="stat-card">
        <i class="fas fa-fire"></i>
        <div class="stat-number" data-target="{% if user and user.first_visit %}{{ ((user.last_visit - user.first_visit).days + 1) if user.last_visit and user.first_visit else 1 }}{% else %}1{% endif %}">0</div>
        <div class="stat-label">使用天数</div>
      </div>
    </div>

    <!-- 最近记录 -->
    <div class="recent-section">
      <h2 class="section-title"><i class="fas fa-history"></i> 最近的占卜记录</h2>
      <div class="readings-list">
        {% if recent_readings %}
          {% for reading in recent_readings %}
            <div class="reading-item" style="animation-delay: {{ loop.index * 0.1 }}s">
              <div class="reading-info">
                <div class="reading-date">
                  <i class="fas fa-calendar-day"></i> {{ reading.date.strftime('%m-%d') if reading.date else '未知' }}
                </div>
                <div class="card-name">
                  <i class="fas fa-moon"></i>{{ reading.card_name or '未知卡牌' }}
                </div>
              </div>
              <div class="direction-badge {% if reading.direction == '逆位' %}reverse{% endif %}">
                {{ reading.direction or '正位' }}
                <i class="fas {% if reading.direction == '逆位' %}fa-arrow-down{% else %}fa-arrow-up{% endif %}"></i>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <i class="fas fa-sparkles"></i>
            <h3>还没有占卜记录</h3>
            <p>开始您的第一次塔罗占卜，探索宇宙的智慧吧</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- 行动按钮：逻辑保持不变 -->
    <div class="action-buttons">
      <a href="{{ url_for('index') }}" class="btn-tarot secondary">
        <i class="fas fa-home"></i> 返回首页
      </a>
      {% if total_readings == 0 %}
        <a href="{{ url_for('index') }}" class="btn-tarot">
          <i class="fas fa-star"></i> 开始占卜
        </a>
      {% else %}
        <a href="{{ url_for('result') }}" class="btn-tarot">
          <i class="fas fa-eye"></i> 查看今日运势
        </a>
      {% endif %}
    </div>

    <div class="info-message">
      <p><i class="fas fa-shield-alt"></i> 您的占卜记录已安全保存，可在不同设备间同步访问</p>
    </div>
  </div>

  <script>
    // 数字动画：保留你的 IntersectionObserver 触发 + 更健壮
    document.addEventListener('DOMContentLoaded', function(){
      const statNumbers = document.querySelectorAll('.stat-number');

      function animateNumber(el){
        const target = parseInt(el.getAttribute('data-target')) || 0;
        const duration = 1500;
        const steps = Math.max(1, Math.floor(duration / 16));
        const inc = target / steps;
        let cur = 0, frame = 0;
        const tick = () => {
          frame++; cur += inc;
          if (frame >= steps) { el.textContent = target; el.closest('.stat-card')?.classList.remove('loading'); return; }
          el.textContent = Math.floor(cur);
          requestAnimationFrame(tick);
        };
        el.closest('.stat-card')?.classList.add('loading');
        tick();
      }

      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting){ animateNumber(e.target); io.unobserve(e.target); }
        });
      }, { threshold: .5 });

      statNumbers.forEach(n=> io.observe(n));

      // 最近记录淡入
      const items = document.querySelectorAll('.reading-item');
      items.forEach((it, idx)=>{
        it.style.opacity='0'; it.style.transform='translateY(16px)';
        setTimeout(()=>{
          it.style.transition='all .5s ease';
          it.style.opacity='1'; it.style.transform='translateY(0)';
        }, 120 + idx*90);
      });
    });
  </script>

  <script src="{{ url_for('static', filename='js/cosmos.js') }}"></script>
</body>
</html>
