<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>每日塔罗运势 - {{ card.name }}</title>

  <!-- 与 index 保持一致的基础资源（本地 Bootstrap / FontAwesome / 字体 & PWA 元信息） -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="若水占卜">
  <meta name="theme-color" content="#1a1625" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#2d1b4e" media="(prefers-color-scheme: light)">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-180.png') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    /* ===== 主题令牌（与 index 同款：宇宙深色系） ===== */
    :root{
      --primary:#9d7ea8; --secondary:#6d5675; --gold:#e8d4a2; --gold-light:#f4e5c3;
      --bg1:#2d1b4e; --bg2:#1a1625; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --text:#fff; --text-light:rgba(255,255,255,.88); --text-muted:rgba(255,255,255,.65);
      --success:#10b981; --warning:#f59e0b;
    }

    *{box-sizing:border-box}
    body{
      font-family:'Noto Serif SC',-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      color:var(--text); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(1200px 700px at 80% 90%, rgba(232,212,162,.12), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      position:relative; overflow-x:hidden;
    }

    /* 背景层（index 同款） */
    .bg-stars{position:fixed;inset:0;z-index:-2;opacity:.25;background-image:
      radial-gradient(1px 1px at 12% 25%, #fff, transparent),
      radial-gradient(1px 1px at 32% 60%, #fff, transparent),
      radial-gradient(1px 1px at 62% 30%, #fff, transparent),
      radial-gradient(1px 1px at 82% 70%, #fff, transparent),
      radial-gradient(1px 1px at 22% 80%, #fff, transparent);
      background-size:220px 220px;animation:twinkle 4s ease-in-out infinite alternate;pointer-events:none}
    @keyframes twinkle{from{opacity:.15}to{opacity:.35}}
    .bg-veil{position:fixed; inset:-10% -10% 0 -10%; z-index:-5; pointer-events:none; opacity:.9; filter:blur(2px);
      background:
        radial-gradient(800px 500px at 12% 14%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(720px 460px at 82% 72%, rgba(232,212,162,.12), transparent 60%),
        radial-gradient(900px 560px at 58% 12%, rgba(157,126,168,.10), transparent 70%);
      animation:veilDrift 50s linear infinite alternate}
    @keyframes veilDrift{to{transform:translate3d(-10px,8px,0)}}

    /* 顶部用户栏（保留原有结构/链接 & 统一质感） */
    .user-bar{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(28,22,40,.6);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .user-bar-content{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-icon{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid var(--border)}
    .user-name{color:var(--gold-light);font-weight:600;letter-spacing:.5px}
    .user-actions{display:flex;gap:10px}
    .user-actions a{color:var(--text-light);text-decoration:none;font-size:.95rem;padding:8px 14px;border-radius:18px;border:1px solid transparent;transition:.25s;background:var(--panel)}
    .user-actions a:hover{color:#fff;border-color:var(--border);transform:translateY(-1px)}

    /* 主容器 */
    .tarot-container{max-width:900px;width:100%;margin:88px auto 20px;padding:28px;background:var(--panel);border-radius:20px;border:1px solid var(--border);box-shadow:0 18px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08);text-align:center;position:relative;overflow:hidden}

    .header{margin-bottom:24px}
    .header h1{font-size:2.2rem;font-weight:800;color:var(--gold-light);text-shadow:0 2px 8px rgba(0,0,0,.25)}
    .date-display{font-size:1.05rem;color:var(--text-muted);margin-top:8px;padding:8px 16px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:18px;display:inline-block}

    /* 结果区域（保留原 class 名称） */
    .result-card{display:flex;flex-wrap:wrap;justify-content:center;gap:24px;margin-bottom:24px;align-items:stretch}

    /* 卡牌 3D */
    .card-visual{width:260px;height:400px;perspective:1000px;margin:0 auto;position:relative;display:inline-block}
    .card-inner{width:100%;height:100%;transform-style:preserve-3d;transition:transform .9s cubic-bezier(.175,.885,.32,1.275)}
    .card-visual.flipped .card-inner{transform:rotateY(180deg)}
    .card-front,.card-back{position:absolute;inset:0;border-radius:15px;display:flex;align-items:center;justify-content:center;backface-visibility:hidden;border:1px solid var(--border);box-shadow:0 12px 28px rgba(0,0,0,.28)}

    .card-front{background:linear-gradient(135deg, rgba(157,126,168,.36), rgba(232,212,162,.20));position:relative}
    .card-back-pattern{position:absolute;inset:0;opacity:.18;background-image:
      radial-gradient(circle at 20% 20%, transparent 30%, rgba(255,255,255,.12) 30.5%, rgba(255,255,255,.12) 31%, transparent 31.5%),
      radial-gradient(circle at 80% 80%, transparent 30%, rgba(255,255,255,.12) 30.5%, rgba(255,255,255,.12) 31%, transparent 31.5%),
      radial-gradient(circle at 50% 50%, transparent 40%, rgba(255,255,255,.12) 40.5%, rgba(255,255,255,.12) 41%, transparent 41.5%);
      background-size:200px 200px,200px 200px,300px 300px}
    .card-back-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:70%;height:70%;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .mystical-border{width:150px;height:150px;border:3px solid rgba(255,255,255,.28);border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center;animation:rotate-slow 20s linear infinite}
    .mystical-border::before{content:'';position:absolute;width:120%;height:120%;border:2px solid rgba(255,255,255,.18);border-radius:50%}
    .mystical-symbol{font-size:3rem;color:rgba(255,255,255,.75);text-shadow:0 0 20px rgba(255,255,255,.35)}
    @keyframes rotate-slow{to{transform:rotate(360deg)}}

    .card-back{transform:rotateY(180deg);background:#0f0b18;position:relative}
    .tarot-image-wrapper{position:absolute;inset:0;background:rgba(0,0,0,.1)}
    .tarot-image{width:100%;height:100%;object-fit:contain;transition:transform .6s ease}
    .tarot-image.reversed{transform:rotate(180deg)}

    .direction-badge{position:absolute;top:12px;right:12px;z-index:10;background:#fff;color:var(--direction-color);padding:6px 14px;border-radius:20px;font-weight:700;font-size:.9rem;box-shadow:0 3px 10px rgba(0,0,0,.2);border:2px solid var(--direction-color)}

    /* 牌面信息（保留原 class 名称） */
    .card-info{flex:1;max-width:500px;text-align:left}
    .card-name{font-size:2rem;color:#fff;margin-bottom:16px;font-weight:800;text-align:center}

    .interpretation-section{background:var(--panel);border-radius:14px;padding:18px;margin-bottom:16px;border:1px solid var(--border);box-shadow:0 6px 16px rgba(0,0,0,.18)}
    .interpretation-title{font-size:1.1rem;color:var(--gold-light);margin-bottom:10px;font-weight:700;display:flex;align-items:center;gap:10px}
    .interpretation-content{font-size:1.02rem;line-height:1.8;color:var(--text-light)}

    /* 访客导出区域（保留原结构与类名） */
    .export-section{background:rgba(157,126,168,.10);border:1px solid var(--border);border-radius:14px;padding:16px;margin:20px 0;text-align:center}
    .export-section p{color:var(--text-muted);margin-bottom:12px;font-weight:600}
    .export-buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .btn-export{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;border:1px solid var(--border);border-radius:24px;text-decoration:none;font-weight:700;transition:.25s;box-shadow:0 8px 20px rgba(157,126,168,.32)}
    .btn-export:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(157,126,168,.4);color:#fff}

    /* 解锁运势指数按钮（保留原结构与文案） */
    .unlock-section{text-align:center;margin:30px 0;padding:28px;background:linear-gradient(135deg, rgba(157,126,168,.08), rgba(109,76,103,.08));border-radius:20px;position:relative;overflow:hidden}
    .unlock-section::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle, rgba(157,126,168,.14) 0%, transparent 70%);animation:pulse 3s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(.8);opacity:.6}50%{transform:scale(1.2);opacity:.9}}
    .btn-unlock{display:inline-flex;align-items:center;gap:12px;background:linear-gradient(135deg, var(--primary), var(--secondary));color:#fff;padding:14px 34px;border:none;border-radius:30px;font-size:1.05rem;font-weight:800;cursor:pointer;text-decoration:none;transition:.25s;box-shadow:0 12px 26px rgba(157,126,168,.4);position:relative;z-index:1}
    .btn-unlock:hover{transform:translateY(-2px);box-shadow:0 16px 34px rgba(157,126,168,.5)}

    /* 分隔线 */
    .divider{height:1px;background:var(--border);margin:24px 0}

    /* 含义区块（保留原类名） */
    .meaning-explanation{text-align:left;margin-bottom:16px;background:var(--panel);border-radius:14px;padding:22px;border:1px solid var(--border);box-shadow:0 6px 16px rgba(0,0,0,.18)}
    .meaning-title{font-size:1.2rem;color:var(--gold-light);text-align:center;margin-bottom:14px;font-weight:700}
    .meaning-item{margin-bottom:14px;padding:14px;background:rgba(157,126,168,.10);border-radius:10px;border-left:4px solid var(--primary)}
    .meaning-item strong{color:var(--gold-light);display:block;margin-bottom:6px}

    /* 行为按钮（保留原类名） */
    .action-buttons{display:flex;justify-content:center;gap:12px;margin-top:14px;flex-wrap:wrap}
    .btn-tarot{display:inline-flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(135deg, var(--primary), var(--secondary));color:#fff;padding:12px 28px;border:none;border-radius:26px;font-size:1rem;font-weight:800;cursor:pointer;text-decoration:none;transition:.25s;box-shadow:0 12px 26px rgba(157,126,168,.4)}
    .btn-tarot:hover{transform:translateY(-2px);box-shadow:0 16px 34px rgba(157,126,168,.5)}
    .btn-tarot.secondary{background:transparent;color:var(--text-light);border:1px solid var(--border)}
    .btn-tarot.secondary:hover{background:linear-gradient(135deg, var(--primary), var(--secondary));color:#fff}

    /* 底部 */
    .footer{text-align:center;margin-top:24px;padding-top:12px;border-top:1px solid var(--border);color:var(--text-muted);font-size:.95rem}

    /* 加载动画 */
    .loading{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,.25);border-radius:50%;border-top-color:#fff;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* —— 移动端 & iOS 适配（与 index 同步） —— */
    html, body{min-height:100dvh;min-height:calc(var(--vh,1vh)*100)}
    .user-bar{padding-top:calc(env(safe-area-inset-top,0px)+10px)}
    .tarot-container{margin-top:calc(78px + env(safe-area-inset-top,0px))}
    @media (max-width:768px){
      .card-visual{width:clamp(180px,64vw,260px);height:auto;aspect-ratio:260/400}
      .btn-unlock{padding:12px 26px;font-size:1rem}
    }

    /* 让翻转后的牌面在上层，避免 3D 叠层把图片压住 */
.card-front, .card-back {
  backface-visibility: hidden;
  transform-style: preserve-3d;
}
.card-front { z-index: 1; }
.card-back  { transform: rotateY(180deg) translateZ(0.1px); z-index: 0; }

/* 翻转后，把背面（真正的牌面）层级提到最上 */
.card-visual.flipped .card-front { z-index: 0; }
.card-visual.flipped .card-back  { z-index: 2; }

/* 确保图片本身在该面内的最高层 */
.tarot-image-wrapper, .tarot-image { position: relative; z-index: 2; display: block; }

  </style>
</head>
<body>
  <!-- 背景层（装饰，与 index 统一质感） -->
  <div class="bg-stars"></div>
  <div class="bg-veil" aria-hidden="true"></div>

  <!-- 用户栏：保留首页链接 + 登录/注册/统计/退出（与原 result 一致） -->
  <div class="user-bar">
    <div class="user-bar-content">
      <div class="user-info">
        <div class="user-icon">
          {% if not user.is_guest %}
            {{ user.username[0]|upper }}
          {% else %}
            <i class="fas fa-user"></i>
          {% endif %}
        </div>
        <span class="user-name">{{ user.username if not user.is_guest else "神秘访客" }}</span>
      </div>
      <div class="user-actions">
        <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> 首页</a>
        {% if user.is_guest %}
          <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> 登录</a>
          <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> 注册</a>
        {% else %}
          <a href="{{ url_for('stats') }}"><i class="fas fa-chart-line"></i> 统计</a>
          <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> 退出</a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="tarot-container">
    <div class="header">
      <h1><i class="fas fa-stars"></i> 今日塔罗运势 <i class="fas fa-stars"></i></h1>
      <div class="date-display"><i class="fas fa-calendar-day"></i> {{ today_date }}</div>
    </div>

    <div class="result-card">
      <div class="card-visual {% if direction == '逆位' %}reversed{% endif %}" id="cardVisual">
        <div class="card-inner">
          <!-- 牌背 -->
          <div class="card-front">
            <div class="card-back-pattern"></div>
            <div class="card-back-center">
              <div class="mystical-border">
                <i class="fas fa-moon mystical-symbol"></i>
              </div>
            </div>
          </div>
          <!-- 牌面 -->
          <div class="card-back">
            <div class="direction-badge" style="--direction-color: {{ 'var(--success)' if direction == '正位' else 'var(--warning)' }}">
              {{ direction }} <i class="fas {{ 'fa-arrow-up' if direction == '正位' else 'fa-arrow-down' }}"></i>
            </div>
            <div class="tarot-image-wrapper">
              {% if card.image %}
                <img id="tarotImg"
     class="tarot-image {% if direction == '逆位' %}reversed{% endif %}"
     src="{{ card.image }}"
     alt="{{ card.name }}"
     loading="lazy"
     decoding="async"
     referrerpolicy="no-referrer"
     onerror="handleImageError(this)">
              {% else %}
                <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(157,126,168,.16), rgba(232,212,162,.12));">
                  <div style="text-align:center;color:var(--text-light)">
                    <i class="fas fa-sparkles" style="font-size:3.2rem;color:var(--gold-light);"></i>
                    <h3 style="margin-top:14px;color:var(--gold-light);font-size:1.4rem">{{ card.name }}</h3>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="card-info">
        <div class="card-name">{{ card.name }}</div>

        <div class="interpretation-section">
          <div class="interpretation-title"><i class="fas fa-compass"></i> 今日运势解读</div>
          <div class="interpretation-content">
            {% if today_insight %}
              {{ today_insight }}
            {% else %}
              <span class="loading"></span> 解读正在生成中...
            {% endif %}
          </div>
        </div>

        <div class="interpretation-section">
          <div class="interpretation-title"><i class="fas fa-hands-helping"></i> 运势指引</div>
          <div class="interpretation-content">
            {% if guidance %}
              {{ guidance }}
            {% else %}
              <span class="loading"></span> 指引正在生成中...
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    {% if user.is_guest %}
    <div class="export-section">
      <p><i class="fas fa-info-circle"></i> 作为访客，您的解读仅在本次浏览期间有效</p>
      <div class="export-buttons">
        <a href="{{ url_for('export_reading') }}" class="btn-export"><i class="fas fa-download"></i> 下载解读</a>
        <button class="btn-export" onclick="copyToClipboard()"><i class="fas fa-copy"></i> 复制内容</button>
      </div>
    </div>
    {% endif %}

    <div class="divider"></div>

    <!-- 解锁运势指数按钮（保留） -->
    <div class="unlock-section">
      <a href="{{ url_for('index') }}" class="btn-unlock"><i class="fas fa-unlock-alt"></i> 点击解锁今日运势指数</a>
    </div>

    <div class="divider"></div>

    <div class="meaning-explanation">
      <div class="meaning-title"><i class="fas fa-book-open"></i> {{ card.name }} 的深层含义</div>
      <div class="meaning-item">
        <strong><i class="fas fa-arrow-up"></i> 正位含义</strong>
        {{ card.meaning_up if card.meaning_up else "正位解释暂未提供" }}
      </div>
      <div class="meaning-item">
        <strong><i class="fas fa-arrow-down"></i> 逆位含义</strong>
        {{ card.meaning_rev if card.meaning_rev else "逆位解释暂未提供" }}
      </div>
    </div>

    <div class="action-buttons">
      <!--
      {% if not user.is_guest %}
      <a href="{{ url_for('clear_cache') }}" class="btn-tarot secondary" onclick="return confirm('确定要清除今日记录吗？清除后可以重新抽牌。')">
        <i class="fas fa-redo"></i> 重新抽牌
      </a>
      {% endif %}
      -->
      <button class="btn-tarot" onclick="shareResult()"><i class="fas fa-share-alt"></i> 分享结果</button>
    </div>

    <div class="footer">
      <p>© 2025 塔罗运势 | 宇宙能量，智慧指引</p>
      <small style="opacity:.7;">每日凌晨重置，基于北京时间</small>
    </div>
  </div>

  <!-- 复制成功提示（保留原 id） -->
  <div class="copy-success" id="copySuccess"><i class="fas fa-check-circle"></i> 复制成功！</div>

  <script>
    // 卡牌翻转动画（保留时序）
    setTimeout(()=>{ document.getElementById('cardVisual')?.classList.add('flipped'); }, 800);

    // 复制到剪贴板（保留原模板与分隔符）
    function copyToClipboard(){
      const content = `塔罗每日指引 - {{ today_date }}
━━━━━━━━━━━━━━━━━━━━━
抽到的牌：{{ card.name }}（{{ direction }}）

【今日洞察】
{{ today_insight if today_insight else '解读生成中...' }}

【指引建议】
{{ guidance if guidance else '指引生成中...' }}

【牌面含义】
正位：{{ card.meaning_up if card.meaning_up else '暂无' }}
逆位：{{ card.meaning_rev if card.meaning_rev else '暂无' }}
━━━━━━━━━━━━━━━━━━━━━
生成自：塔罗每日指引`;
      if(navigator.clipboard){ navigator.clipboard.writeText(content).then(showCopySuccess).catch(fallback); }
      else{ fallback(); }
      function fallback(){ const ta=document.createElement('textarea'); ta.value=content; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showCopySuccess(); }
    }

    function showCopySuccess(){
      const el = document.getElementById('copySuccess');
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 2000);
    }

    function shareResult(){
      const shareData = {
        title: '我的每日塔罗运势',
        text: `我抽到了${document.querySelector('.card-name').textContent}（{{ direction }}）`,
        url: window.location.href
      };
      if(navigator.share){ navigator.share(shareData).catch(err=>{ if(err.name !== 'AbortError'){ copyToClipboard(); } }); }
      else{ copyToClipboard(); }
    }

    // 若解读/指引为空：按原逻辑 5s 轮询刷新
    {% if not today_insight or not guidance %}
    setTimeout(()=>{ location.reload(); }, 5000);
    {% endif %}

    // 视口高度变量 --vh（iOS 适配）
    function setVh(){ document.documentElement.style.setProperty('--vh', window.innerHeight*0.01 + 'px'); }
    setVh(); window.addEventListener('resize', setVh);


  function handleImageError(img) {
    const s = img.getAttribute('src') || '';

    // 尝试 1：相对路径自动补 /static/
    if (!img.dataset.triedStatic && !/^https?:\/\//.test(s) && !s.startsWith('/')) {
      img.dataset.triedStatic = 1;
      img.src = '{{ url_for("static", filename="") }}' + s.replace(/^static\//,'');
      return;
    }
    // 尝试 2：去重 /static/static/
    if (!img.dataset.triedStrip && s.includes('/static/static/')) {
      img.dataset.triedStrip = 1;
      img.src = s.replace('/static/static/', '/static/');
      return;
    }
    // 尝试 3：占位（依旧失败）
    const wrap = img.closest('.tarot-image-wrapper');
    if (wrap) {
      wrap.innerHTML = `
        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
                    background:linear-gradient(135deg, rgba(157,126,168,.16), rgba(232,212,162,.12));">
          <div style="text-align:center;color:var(--text-light)">
            <i class="fas fa-image" style="font-size:3rem;color:var(--gold-light);"></i>
            <div style="margin-top:10px;font-weight:700">{{ card.name }}</div>
          </div>
        </div>`;
    }
  }

  // 页面加载后：如果 src 是相对/裸路径，先行补全一次
  (function autoFixRelative(){
    var img = document.getElementById('tarotImg');
    if (!img) return;
    var s = img.getAttribute('src') || '';
    if (!/^https?:\/\//.test(s) && !s.startsWith('/')) {
      img.src = '{{ url_for("static", filename="") }}' + s.replace(/^static\//,'');
    }
  })();


  </script>
</body>
</html>
