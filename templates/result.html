<!DOCTYPE html>
<html lang="zh-CN">
<head>
  {% include 'partials/_meta_pwa.html' %}
  {% block title %}<title>每日塔罗运势 - {{ card.name }}</title>{% endblock %}
  <style>
    .tarot-container{max-width:900px;width:100%;margin:calc(88px + env(safe-area-inset-top,0px)) auto 20px;padding:26px;background:var(--panel);border:1px solid var(--border);border-radius:20px;box-shadow:0 15px 30px rgba(0,0,0,0.25);text-align:center;overflow:hidden}
    .header h1{font-size:2rem;color:var(--gold-light);letter-spacing:.6px;margin:0}
    .date-display{font-size:1rem;color:var(--text-light);margin:10px auto 18px;padding:6px 16px;border-radius:18px;background:rgba(255,255,255,.08);border:1px solid var(--border);display:inline-block}
    .result-card{display:flex;flex-wrap:wrap;justify-content:center;gap:28px;margin:18px 0 24px;align-items:center}
    .card-visual{width:280px;height:420px;perspective:1000px}
    .card-inner{width:100%;height:100%;transform-style:preserve-3d;transition:transform 1s cubic-bezier(.175,.885,.32,1.275)}
    .card-visual.flipped .card-inner{transform:rotateY(180deg)}
    .card-front,.card-back{position:absolute;width:100%;height:100%;top:0;left:0;backface-visibility:hidden;border-radius:15px;display:flex;align-items:center;justify-content:center}
    .card-front{background:linear-gradient(135deg,var(--primary),var(--secondary));position:relative;box-shadow:0 12px 30px rgba(0,0,0,.28)}
    .card-back-pattern{position:absolute;inset:0;opacity:.18;background-image:
      radial-gradient(circle at 20% 20%, transparent 30%, rgba(255,255,255,0.18) 30.5%, rgba(255,255,255,0.18) 31%, transparent 31.5%),
      radial-gradient(circle at 80% 80%, transparent 30%, rgba(255,255,255,0.18) 30.5%, rgba(255,255,255,0.18) 31%, transparent 31.5%),
      radial-gradient(circle at 50% 50%, transparent 40%, rgba(255,255,255,0.18) 40.5%, rgba(255,255,255,0.18) 41%, transparent 41.5%);
      background-size:200px 200px,200px 200px,300px 300px}
    .mystical-border{width:150px;height:150px;border:3px solid rgba(255,255,255,.35);border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center;animation:spinSlow 20s linear infinite}
    .mystical-border::before{content:'';position:absolute;width:120%;height:120%;border:2px solid rgba(255,255,255,.2);border-radius:50%}
    .mystical-symbol{font-size:3rem;color:rgba(255,255,255,.8);text-shadow:0 0 18px rgba(255,255,255,.45)}
    @keyframes spinSlow{to{transform:rotate(360deg)}}
    .card-back{transform:rotateY(180deg);background:#fff;position:relative;box-shadow:0 12px 30px rgba(0,0,0,.28)}
    .tarot-image-wrapper{position:absolute;inset:0;background:#f9f9f9}
    .tarot-image{width:100%;height:100%;object-fit:contain;transition:transform .6s ease}
    .tarot-image.reversed{transform:rotate(180deg)}
    .direction-badge{position:absolute;top:15px;right:15px;z-index:10;background:#fff;color:var(--direction-color);padding:6px 15px;border-radius:20px;font-weight:600;font-size:.85rem;box-shadow:0 3px 10px rgba(0,0,0,.1);border:2px solid var(--direction-color)}
    .card-info{flex:1;max-width:520px;text-align:left}
    .card-name{font-size:2rem;color:var(--gold-light);margin:0 0 14px;text-align:center;font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,.25)}
    .interpretation-section{background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,.12);transition:.25s}
    .interpretation-section:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.18)}
    .interpretation-title{font-size:1.05rem;color:var(--gold-light);font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:10px}
    .interpretation-content{font-size:1rem;line-height:1.8;color:var(--text-light)}
    .export-section{background:rgba(142,108,136,.12);border:1px solid var(--border);border-radius:14px;padding:16px;margin:18px 0;text-align:center}
    .export-buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .btn-export{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;background:#fff;color:#333;border-radius:22px;text-decoration:none;border:2px solid var(--primary);transition:.25s}
    .btn-export:hover{background:var(--primary);color:#fff;transform:translateY(-2px)}
    .unlock-section{margin:24px 0;padding:22px;background:linear-gradient(135deg,rgba(142,108,136,.08),rgba(109,76,103,.08));border-radius:16px;position:relative;overflow:hidden}
    .btn-unlock{display:inline-flex;align-items:center;gap:10px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:14px 28px;border-radius:999px;text-decoration:none;font-weight:700;box-shadow:0 10px 25px rgba(157,126,168,.35)}
    .btn-unlock:hover{transform:translateY(-2px)}
    .meaning-explanation{background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:left}
    .meaning-title{font-size:1.2rem;color:var(--gold-light);text-align:center;margin-bottom:12px;font-weight:800}
    .meaning-item{margin-bottom:12px;padding:12px;background:rgba(142,108,136,.08);border-radius:10px;border-left:4px solid var(--primary)}
    .meaning-item strong{color:var(--gold-light);display:block;margin-bottom:6px}
    .action-buttons{display:flex;justify-content:center;gap:12px;margin-top:18px;flex-wrap:wrap}
    .btn-tarot{display:inline-flex;align-items:center;gap:10px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:12px 24px;border-radius:999px;text-decoration:none;font-weight:700;box-shadow:0 8px 16px rgba(157,126,168,.3)}
    .btn-tarot:hover{transform:translateY(-2px)}
    .btn-tarot.secondary{background:#fff;color:var(--primary);border:2px solid var(--primary)}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.24),transparent);margin:14px 0}
    .copy-success{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#10b981;color:#fff;padding:12px 22px;border-radius:999px;box-shadow:0 5px 15px rgba(0,0,0,.2);opacity:0;transition:.3s;z-index:1000}
    .copy-success.show{opacity:1}
    @media (max-width:768px){ .card-visual{width:240px;height:360px} .card-name{font-size:1.6rem} }
  </style>
</head>
<body>
  {% include 'partials/_bg_layers.html' %}
  {% include 'partials/_user_bar.html' %}

  <div class="tarot-container">
    <div class="header">
      <h1><i class="fas fa-stars"></i> 今日塔罗运势 <i class="fas fa-stars"></i></h1>
      <div class="date-display"><i class="fas fa-calendar-day"></i> {{ today_date }}</div>
    </div>

    <div class="result-card">
      <div class="card-visual {% if direction == '逆位' %}reversed{% endif %}" id="cardVisual">
        <div class="card-inner">
          <div class="card-front">
            <div class="card-back-pattern"></div>
            <div class="mystical-border"><i class="fas fa-moon mystical-symbol"></i></div>
          </div>

          <div class="card-back">
            <div class="direction-badge" style="--direction-color: {{ 'var(--success)' if direction == '正位' else 'var(--warning)' }}">
              {{ direction }} <i class="fas {{ 'fa-arrow-up' if direction == '正位' else 'fa-arrow-down' }}"></i>
            </div>
            <div class="tarot-image-wrapper">
              {% if card.image %}
                <img class="tarot-image {% if direction == '逆位' %}reversed{% endif %}" src="{{ card.image }}" alt="{{ card.name }}">
              {% else %}
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(142,108,136,0.1), rgba(109,76,103,0.1));">
                  <div style="text-align:center">
                    <i class="fas fa-sparkles" style="font-size:4rem;color:var(--primary);opacity:.6"></i>
                    <h3 style="margin-top:20px;color:var(--gold-light);font-size:1.4rem">{{ card.name }}</h3>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="card-info">
        <div class="card-name">{{ card.name }}</div>

        <div class="interpretation-section">
          <div class="interpretation-title"><i class="fas fa-compass"></i> 今日运势解读</div>
          <div class="interpretation-content">
            {% if today_insight %}{{ today_insight }}{% else %}<span class="loading"></span> 解读正在生成中...{% endif %}
          </div>
        </div>

        <div class="interpretation-section">
          <div class="interpretation-title"><i class="fas fa-hands-helping"></i> 运势指引</div>
          <div class="interpretation-content">
            {% if guidance %}{{ guidance }}{% else %}<span class="loading"></span> 指引正在生成中...{% endif %}
          </div>
        </div>
      </div>
    </div>

    {% if user.is_guest %}
      <div class="export-section">
        <p style="color:var(--gold-light);margin-bottom:10px"><i class="fas fa-info-circle"></i> 作为访客，您的解读仅在本次浏览期间有效</p>
        <div class="export-buttons">
          <a href="{{ url_for('export_reading') }}" class="btn-export"><i class="fas fa-download"></i> 下载解读</a>
          <button onclick="copyToClipboard()" class="btn-export"><i class="fas fa-copy"></i> 复制内容</button>
        </div>
      </div>
    {% endif %}

    <div class="divider"></div>

    <div class="unlock-section">
      <a href="{{ url_for('index') }}" class="btn-unlock"><i class="fas fa-unlock-alt"></i> 点击解锁今日运势指数</a>
    </div>

    <div class="divider"></div>

    <div class="meaning-explanation">
      <div class="meaning-title"><i class="fas fa-book-open"></i> {{ card.name }} 的深层含义</div>
      <div class="meaning-item"><strong><i class="fas fa-arrow-up"></i> 正位含义</strong>{{ card.meaning_up if card.meaning_up else "正位解释暂未提供" }}</div>
      <div class="meaning-item"><strong><i class="fas fa-arrow-down"></i> 逆位含义</strong>{{ card.meaning_rev if card.meaning_rev else "逆位解释暂未提供" }}</div>
    </div>

    <div class="action-buttons">
      <button class="btn-tarot" onclick="shareResult()"><i class="fas fa-share-alt"></i> 分享结果</button>
      <!-- 如需恢复重抽按钮，按你的注释解开即可 -->
    </div>

    <div class="footer" style="margin-top:18px">
      <p>© 2025 塔罗运势 | 宇宙能量，智慧指引</p>
      <small style="opacity:.7;">每日凌晨重置，基于北京时间</small>
    </div>
  </div>

  <div class="copy-success" id="copySuccess"><i class="fas fa-check-circle"></i> 复制成功！</div>

  <script>
    // 翻牌动画
    setTimeout(()=>{ document.getElementById('cardVisual')?.classList.add('flipped'); }, 800);

    // 复制
    function copyToClipboard() {
      const content = `塔罗每日指引 - {{ today_date }}
━━━━━━━━━━━━━━━━━━━━━
抽到的牌：{{ card.name }}（{{ direction }}）

【今日洞察】
{{ today_insight if today_insight else '解读生成中...' }}

【指引建议】
{{ guidance if guidance else '指引生成中...' }}

【牌面含义】
正位：{{ card.meaning_up if card.meaning_up else '暂无' }}
逆位：{{ card.meaning_rev if card.meaning_rev else '暂无' }}
━━━━━━━━━━━━━━━━━━━━━
生成自：塔罗每日指引`;
      const show=()=>{ const el=document.getElementById('copySuccess'); el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1500); };
      if (navigator.clipboard) navigator.clipboard.writeText(content).then(show).catch(()=>fallback());
      else fallback();
      function fallback(){ const ta=document.createElement('textarea'); ta.value=content; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); show(); }
    }

    // 分享（降级到复制）
    function shareResult() {
      const shareData = {
        title: '我的每日塔罗运势',
        text: `我抽到了{{ card.name }}（{{ direction }}）`,
        url: window.location.href
      };
      if (navigator.share) navigator.share(shareData).catch(err=>{ if (err?.name!=='AbortError') copyToClipboard(); });
      else copyToClipboard();
    }

    // 若内容仍在生成，轻量自动刷新
    {% if not today_insight or not guidance %}
      setTimeout(()=>location.reload(), 5000);
    {% endif %}
  </script>

  <script src="{{ url_for('static', filename='js/cosmos.js') }}"></script>
</body>
</html>
