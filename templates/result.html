<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>每日塔罗运势 - {{ card.name }}</title>

  <!-- iOS 全屏 & 状态栏 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="若水占卜">
  <!-- Android / Chrome 主题色 -->
  <meta name="theme-color" content="#1a1625" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#2d1b4e" media="(prefers-color-scheme: light)">
  <!-- PWA 清单 / 图标（与 index 一致） -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-180.png') }}">

  <!-- 本地化资源 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#9d7ea8; --secondary:#6d5675; --gold:#e8d4a2; --gold-light:#f4e5c3;
      --bg1:#2d1b4e; --bg2:#1a1625;
      --text:#fff; --text-light:rgba(255,255,255,.88); --text-muted:rgba(255,255,255,.65);
      --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;min-height:100dvh;min-height:calc(var(--vh,1vh)*100);}
    html{ background:#120c1d; } /* iOS 底层白闪兜底 */

    body{
      margin:0;
      font-family:'Noto Serif SC',-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      display:flex; flex-direction:column; align-items:center;
      padding:20px;
      padding-top: calc(20px + env(safe-area-inset-top,0px));
      padding-bottom: calc(20px + env(safe-area-inset-bottom,0px));
      position:relative; overflow-x:hidden;
    }

    /* —— 稳定合成背景（与登录/注册统一） —— */
    .bg-stars{
      position:fixed; inset:0; z-index:-2; pointer-events:none;
      background:
        radial-gradient(820px 520px at 12% 14%, rgba(157,126,168,.22), transparent 60%),
        radial-gradient(760px 480px at 82% 72%, rgba(232,212,162,.18), transparent 60%),
        radial-gradient(920px 580px at 58% 12%, rgba(157,126,168,.14), transparent 72%),

        radial-gradient(1px 1px at 12% 25%, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 32% 60%, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 62% 30%, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 82% 70%, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 22% 80%, rgba(255,255,255,.9), transparent),

        url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 1000'>\
<g stroke='rgba(255,255,255,0.28)' stroke-width='1' fill='none'>\
<line x1='90' y1='120' x2='160' y2='160'/><line x1='160' y1='160' x2='210' y2='110'/><line x1='160' y1='160' x2='110' y2='200'/>\
<line x1='780' y1='120' x2='840' y2='160'/><line x1='840' y1='160' x2='900' y2='180'/><line x1='900' y1='180' x2='950' y2='150'/>\
<line x1='760' y1='740' x2='820' y2='780'/><line x1='820' y1='780' x2='880' y2='740'/><line x1='820' y1='780' x2='840' y2='840'/>\
</g>\
<g fill='rgba(255,255,255,0.9)'>\
<circle cx='90' cy='120' r='1.2'/><circle cx='160' cy='160' r='1.2'/><circle cx='210' cy='110' r='1.2'/><circle cx='110' cy='200' r='1.2'/>\
<circle cx='780' cy='120' r='1.2'/><circle cx='840' cy='160' r='1.2'/><circle cx='900' cy='180' r='1.2'/><circle cx='950' cy='150' r='1.2'/>\
<circle cx='760' cy='740' r='1.2'/><circle cx='820' cy='780' r='1.2'/><circle cx='880' cy='740' r='1.2'/><circle cx='840' cy='840' r='1.2'/>\
</g></svg>"),

        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23f1e4b7' stroke-opacity='0.5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23f1e4b7' stroke-opacity='0.5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23f1e4b7' stroke-opacity='0.5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M32 10 v36'/><path d='M22 30 h20'/><path d='M28 48 h8'/><circle cx='32' cy='10' r='3' fill='none'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23f1e4b7' stroke-opacity='0.5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='32' cy='32' r='16'/><path d='M32 16 L37 40 L20 26 H44 L27 40 Z'/></g></svg>"),

        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      background-repeat:no-repeat,no-repeat,no-repeat,
                       repeat,repeat,repeat,repeat,repeat,
                       no-repeat,
                       no-repeat,no-repeat,no-repeat,no-repeat,
                       no-repeat;
      background-size:cover,cover,cover,
                      220px 220px,220px 220px,220px 220px,220px 220px,220px 220px,
                      cover,
                      68px 68px,76px 76px,64px 64px,76px 76px,
                      cover;
      background-position:12% 14%,82% 72%,58% 12%,
                          12% 25%,32% 60%,62% 30%,82% 70%,22% 80%,
                          center,
                          8% 24%,86% 22%,12% 78%,88% 68%,
                          center;
      filter: saturate(1.05);
    }
    .bg-stars::after{
      content:"";
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(88vmin,720px); height:min(88vmin,720px);
      opacity:.18; pointer-events:none;
      background:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>\
<g fill='none' stroke='%23ffffff' stroke-opacity='.78' stroke-width='.3'>\
<circle cx='50' cy='50' r='44'/>\
<circle cx='50' cy='50' r='34' stroke-opacity='.5'/>\
<g stroke-opacity='.35'>\
<line x1='50' y1='6' x2='50' y2='94'/>\
<line x1='6' y1='50' x2='94' y2='50'/>\
<line x1='18' y1='18' x2='82' y2='82'/>\
<line x1='18' y1='82' x2='82' y2='18'/>\
</g></g>\
<text x='50' y='10' text-anchor='middle' fill='%23ffffff' fill-opacity='.7' font-size='6' font-family='serif'>\
♈︎♉︎♊︎♋︎♌︎♍︎♎︎♏︎♐︎♑︎♒︎♓︎</text></svg>") center/100% 100% no-repeat;
      animation:spin 110s linear infinite;
    }
    @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

    /* 顶部用户栏（与 index 一致） */
    .user-bar{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(28,22,40,.6);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding-top:calc(env(safe-area-inset-top,0px) + 6px)}
    .user-bar-content{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-icon{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid var(--border)}
    .user-name{color:var(--gold-light);font-weight:600;letter-spacing:.5px}
    .user-actions{display:flex;gap:10px;flex-wrap:wrap}
    .user-actions a{color:var(--text-light);text-decoration:none;font-size:.95rem;padding:8px 14px;border-radius:18px;border:1px solid transparent;transition:.25s;background:rgba(255,255,255,.06);backdrop-filter:blur(8px)}
    .user-actions a:hover{color:#fff;border-color:var(--border);transform:translateY(-1px)}

    /* 主容器 */
    .main-container{max-width:980px;width:100%;margin:calc(88px + env(safe-area-inset-top,0px)) auto 24px}
    @media (max-width:768px){ .main-container{margin:calc(74px + env(safe-area-inset-top,0px)) auto 16px} }

    .tarot-card-wrap{
      background:var(--panel); border:1px solid var(--border); border-radius:22px;
      box-shadow:0 18px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08);
      overflow:hidden; padding:22px;
    }
    .header{text-align:center;margin-bottom:10px}
    .header h1{font-size:2rem;color:var(--gold-light);letter-spacing:.8px;margin:0 0 8px}
    .date-display{display:inline-block;padding:6px 14px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text-muted);}

    /* 结果区域 */
    .result-card{display:grid;grid-template-columns:1fr 1.2fr;gap:22px;align-items:start;margin-top:16px}
    @media (max-width:980px){ .result-card{grid-template-columns:1fr;gap:18px} }

    /* 卡牌 3D */
    .card-visual{margin:0 auto; width: clamp(200px, 44vw, 280px); aspect-ratio: 2 / 3; perspective: 1000px; position:relative}
    .card-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform 1s cubic-bezier(.175,.885,.32,1.275)}
    .card-visual.flipped .card-inner{transform:rotateY(180deg)}
    .card-front,.card-back{position:absolute;inset:0;border-radius:14px;backface-visibility:hidden;overflow:hidden;border:1px solid var(--border);box-shadow:0 12px 30px rgba(0,0,0,.28);}
    .card-front{
      background:linear-gradient(135deg, rgba(157,126,168,.36), rgba(232,212,162,.2));
    }
    .card-front::after{content:"";position:absolute;inset:14px;border-radius:10px;border:1px solid rgba(255,255,255,.22)}
    .card-back{transform:rotateY(180deg);background:#0f0b19}

    .card-back-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
    .mystical-border{width:58%;aspect-ratio:1/1;border:2px solid rgba(255,255,255,.35);border-radius:50%;display:flex;align-items:center;justify-content:center;animation:spin2 20s linear infinite}
    .mystical-border::before{content:"";position:absolute;width:120%;height:120%;border:1px solid rgba(255,255,255,.18);border-radius:50%}
    .mystical-symbol{font-size:min(14vmin,54px);color:rgba(255,255,255,.8);text-shadow:0 0 18px rgba(255,255,255,.35)}
    @keyframes spin2{to{transform:rotate(360deg)}}

    .tarot-image-wrapper{position:absolute;inset:0;background:#120f1f}
    .tarot-image{width:100%;height:100%;object-fit:contain;transition:transform .6s ease}
    .tarot-image.reversed{transform:rotate(180deg)}

    .direction-badge{
      position:absolute;top:12px;right:12px;z-index:2;
      background:rgba(255,255,255,.9); color:#1a1a1a; padding:6px 12px; border-radius:18px; font-weight:700; font-size:.85rem;
      border:2px solid transparent;
    }
    .direction-badge.upright{ border-color: var(--success); color: var(--success); background: rgba(16,185,129,.12) }
    .direction-badge.reversed{ border-color: var(--warning); color: var(--warning); background: rgba(245,158,11,.12) }

    /* 右侧信息块 */
    .card-info{max-width:640px;margin:0 auto;width:100%}
    .card-name{text-align:center;font-size:1.8rem;color:#fff;font-weight:800;letter-spacing:.6px;margin:6px 0 10px;text-shadow:0 2px 8px rgba(0,0,0,.25)}

    .section{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-top:12px;box-shadow:0 4px 12px rgba(0,0,0,.12)}
    .section .title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--gold-light);margin-bottom:8px}
    .section .content{color:var(--text-light);line-height:1.75}

    /* 访客导出 */
    .export-section{margin:18px 0;padding:14px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--border);text-align:center}
    .export-section p{color:var(--text-light);margin:4px 0 10px}
    .export-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .btn-export{
      display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:18px;border:1px solid var(--border);
      background:rgba(255,255,255,.08);color:#fff;text-decoration:none;transition:.25s
    }
    .btn-export:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(157,126,168,.35)}

    /* 解锁区块 */
    .unlock-section{margin:18px 0;padding:18px;border-radius:16px;background:rgba(255,255,255,.04);border:1px solid var(--border);position:relative;overflow:hidden}
    .unlock-section::before{content:"";position:absolute;inset:-50%;background:radial-gradient(circle, rgba(232,212,162,.12) 0%, transparent 70%);animation:pulse 4s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(.9);opacity:.6}50%{transform:scale(1.15);opacity:1}}
    .btn-unlock{
      position:relative;z-index:1;display:inline-flex;align-items:center;gap:10px;padding:12px 24px;border-radius:20px;border:1px solid var(--border);
      background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;text-decoration:none;box-shadow:0 10px 24px rgba(157,126,168,.32);transition:.25s
    }
    .btn-unlock:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(157,126,168,.42)}

    /* 深层含义 */
    .meaning{margin-top:16px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;padding:16px}
    .meaning .title{display:flex;align-items:center;gap:10px;color:var(--gold-light);font-weight:800;margin-bottom:10px}
    .meaning-item{background:rgba(255,255,255,.05);border-left:3px solid var(--primary);border-radius:10px;padding:12px 12px 12px 14px;margin:10px 0;color:var(--text-light)}
    .meaning-item strong{color:#fff;display:block;margin-bottom:6px}

    /* 行为按钮行 */
    .action-buttons{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin:18px 0 6px}
    .btn-tarot{display:inline-flex;align-items:center;gap:10px;padding:11px 20px;border-radius:20px;border:1px solid var(--border);background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;text-decoration:none;box-shadow:0 10px 24px rgba(157,126,168,.32);transition:.25s}
    .btn-tarot:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(157,126,168,.42)}
    .btn-tarot.secondary{background:rgba(255,255,255,.06);color:#fff}

    /* 分割线 & 页脚 */
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.24),transparent);margin:16px 0}
    .footer{text-align:center;color:var(--text-muted);font-size:.95rem;margin-top:6px}

    /* 复制成功提示 */
    .copy-success{position:fixed;bottom:calc(24px + env(safe-area-inset-bottom,0px));left:50%;transform:translateX(-50%);background:var(--success);color:#fff;padding:12px 22px;border-radius:999px;box-shadow:0 10px 24px rgba(16,185,129,.35);opacity:0;transition:.25s;z-index:200}
    .copy-success.show{opacity:1}

    /* 加载动画 */
    .loading{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin3 1s linear infinite}
    @keyframes spin3{to{transform:rotate(360deg)}}

    /* 触控优化 */
    button,.btn-tarot,.btn-export,.btn-unlock{touch-action:manipulation}

  </style>
</head>
<body>
  <div class="bg-stars" aria-hidden="true"></div>

  <!-- 用户栏 -->
  <div class="user-bar">
    <div class="user-bar-content">
      <div class="user-info">
        <div class="user-icon">
          {% if not user.is_guest %}{{ user.username[0]|upper }}{% else %}<i class="fas fa-user"></i>{% endif %}
        </div>
        <span class="user-name">{{ user.username if not user.is_guest else "神秘访客" }}</span>
      </div>
      <div class="user-actions">
        <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> 首页</a>
        {% if user.is_guest %}
          <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> 登录</a>
          <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> 注册</a>
        {% else %}
          <a href="{{ url_for('stats') }}"><i class="fas fa-chart-line"></i> 统计</a>
          <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> 退出</a>
        {% endif %}
      </div>
    </div>
  </div>

  <main class="main-container">
    <section class="tarot-card-wrap">
      <div class="header">
        <h1><i class="fas fa-star"></i> 今日塔罗运势 <i class="fas fa-star"></i></h1>
        <div class="date-display"><i class="fas fa-calendar-day"></i> {{ today_date }}</div>
      </div>

      <div class="result-card">
        <!-- 卡牌 -->
        <div class="card-visual {% if direction == '逆位' %}reversed{% endif %}" id="cardVisual">
          <div class="card-inner">
            <!-- 牌背 -->
            <div class="card-front">
              <div class="card-back-center">
                <div class="mystical-border">
                  <i class="fas fa-moon mystical-symbol"></i>
                </div>
              </div>
            </div>
            <!-- 牌面 -->
            <div class="card-back">
              <div class="direction-badge {{ 'upright' if direction=='正位' else 'reversed' }}">
                {{ direction }} <i class="fas {{ 'fa-arrow-up' if direction=='正位' else 'fa-arrow-down' }}"></i>
              </div>
              <div class="tarot-image-wrapper">
                {% if card.image %}
                  <img class="tarot-image {% if direction == '逆位' %}reversed{% endif %}" src="{{ card.image }}" alt="{{ card.name }}">
                {% else %}
                  <div style="width: 100%; height: 100%; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, rgba(157,126,168,.14), rgba(232,212,162,.12));">
                    <div style="text-align:center;">
                      <i class="fas fa-sparkles" style="font-size: 3.4rem; color: var(--gold-light); opacity:.8"></i>
                      <h3 style="margin-top: 10px; color:#fff">{{ card.name }}</h3>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- 文案 -->
        <div class="card-info">
          <div class="card-name">{{ card.name }}</div>

          <div class="section">
            <div class="title"><i class="fas fa-compass"></i> 今日运势解读</div>
            <div class="content">
              {% if today_insight %}
                {{ today_insight }}
              {% else %}
                <span class="loading"></span> 解读正在生成中...
              {% endif %}
            </div>
          </div>

          <div class="section">
            <div class="title"><i class="fas fa-hands-helping"></i> 运势指引</div>
            <div class="content">
              {% if guidance %}
                {{ guidance }}
              {% else %}
                <span class="loading"></span> 指引正在生成中...
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {% if user.is_guest %}
      <div class="export-section">
        <p><i class="fas fa-info-circle"></i> 作为访客，您的解读仅在本次浏览期间有效</p>
        <div class="export-buttons">
          <a href="{{ url_for('export_reading') }}" class="btn-export"><i class="fas fa-download"></i> 下载解读</a>
          <button onclick="copyToClipboard()" class="btn-export"><i class="fas fa-copy"></i> 复制内容</button>
        </div>
      </div>
      {% endif %}

      <div class="divider"></div>

      <div class="unlock-section">
        <a href="{{ url_for('index') }}" class="btn-unlock"><i class="fas fa-unlock-alt"></i> 点击解锁今日运势指数</a>
      </div>

      <div class="divider"></div>

      <div class="meaning">
        <div class="title"><i class="fas fa-book-open"></i> {{ card.name }} 的深层含义</div>
        <div class="meaning-item">
          <strong><i class="fas fa-arrow-up"></i> 正位含义</strong>
          {{ card.meaning_up if card.meaning_up else "正位解释暂未提供" }}
        </div>
        <div class="meaning-item">
          <strong><i class="fas fa-arrow-down"></i> 逆位含义</strong>
          {{ card.meaning_rev if card.meaning_rev else "逆位解释暂未提供" }}
        </div>
      </div>

      <div class="action-buttons">
        <!--
        {% if not user.is_guest %}
        <a href="{{ url_for('clear_cache') }}" class="btn-tarot secondary" onclick="return confirm('确定要清除今日记录吗？清除后可以重新抽牌。')">
          <i class="fas fa-redo"></i> 重新抽牌
        </a>
        {% endif %}
        -->
        <button class="btn-tarot" onclick="shareResult()"><i class="fas fa-share-alt"></i> 分享结果</button>
      </div>

      <div class="footer">
        © 2025 塔罗运势 | 宇宙能量，智慧指引<br><small style="opacity:.7;">每日凌晨重置，基于北京时间</small>
      </div>
    </section>
  </main>

  <!-- 复制成功提示 -->
  <div class="copy-success" id="copySuccess"><i class="fas fa-check-circle"></i> 复制成功！</div>

  <script>
    // iOS 视口高度修复
    (function(){ const setVh=()=>document.documentElement.style.setProperty('--vh',(window.innerHeight*0.01)+'px'); setVh(); addEventListener('resize',setVh); addEventListener('orientationchange',setVh); })();

    // PWA SW（与 index 保持一致，失败忽略）
    if ('serviceWorker' in navigator) { addEventListener('load', ()=> navigator.serviceWorker.register('/sw.js').catch(()=>{})); }

    // 翻牌动画
    setTimeout(()=>{ document.getElementById('cardVisual')?.classList.add('flipped'); }, 800);

    // 复制到剪贴板
    function copyToClipboard() {
      const content = `塔罗每日指引 - {{ today_date }}
━━━━━━━━━━━━━━━━━━━━━
抽到的牌：{{ card.name }}（{{ direction }}）

【今日洞察】
{{ today_insight if today_insight else '解读生成中...' }}

【指引建议】
{{ guidance if guidance else '指引生成中...' }}

【牌面含义】
正位：{{ card.meaning_up if card.meaning_up else '暂无' }}
逆位：{{ card.meaning_rev if card.meaning_rev else '暂无' }}
━━━━━━━━━━━━━━━━━━━━━
生成自：塔罗每日指引`;
      (navigator.clipboard ? navigator.clipboard.writeText(content) : new Promise((res,rej)=>{ try{ const ta=document.createElement('textarea'); ta.value=content; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); res(); }catch(e){ rej(e) } }))
      .then(showCopySuccess)
      .catch(()=>{ /* 兜底 */ showCopySuccess(); });
    }

    function showCopySuccess(){ const el=document.getElementById('copySuccess'); el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }

    // 原生分享（降级到复制）
    function shareResult(){
      const shareData={ title:'我的每日塔罗运势', text:`我抽到了{{ card.name }}（{{ direction }}）`, url:location.href };
      if(navigator.share){ navigator.share(shareData).catch(err=>{ if(err?.name!=='AbortError') copyToClipboard(); }); }
      else{ copyToClipboard(); }
    }

    // 缺内容自动刷新
    {% if not today_insight or not guidance %}
      setTimeout(()=>location.reload(), 5000);
    {% endif %}
  </script>
</body>
</html>
