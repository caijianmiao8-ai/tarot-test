<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>AI 塔罗解读</title>

  <!-- 与 index 一致的 PWA / 主题配置 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="若水占卜">
  <meta name="theme-color" content="#1a1625" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#2d1b4e" media="(prefers-color-scheme: light)">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-180.png') }}">

  <!-- 本地化资源 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    /* ========== 主题变量（与 index 统一） ========== */
    :root{
      --primary:#9d7ea8; --secondary:#6d5675; --gold:#e8d4a2; --gold-light:#f4e5c3;
      --bg1:#2d1b4e; --bg2:#1a1625;
      --text:#fff; --text-light:rgba(255,255,255,.88); --text-muted:rgba(255,255,255,.65);
      --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --star:#ffd700; --success:#10b981; --danger:#ef4444;

      /* 聊天局部变量（在暗色系下重映射） */
      --chat-bg: rgba(255,255,255,.04);
      --user-msg-bg: linear-gradient(135deg, var(--primary), var(--secondary));
      --ai-msg-bg: rgba(255,255,255,.06);
      --ai-msg-shadow: 0 6px 16px rgba(0,0,0,.25);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html, body{
      min-height: 100dvh;
      min-height: calc(var(--vh, 1vh) * 100);
    }
    body{
      font-family:'Noto Serif SC',-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(1200px 700px at 80% 90%, rgba(232,212,162,.12), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      display:flex; flex-direction:column;
      overflow-x:hidden;
    }

    /* 背景层（与 index 保持一致的星空/星座/符号/星盘） */
    .bg-stars{position:fixed;inset:0;z-index:-3;opacity:.25;background-image:
      radial-gradient(1px 1px at 12% 25%, #fff, transparent),
      radial-gradient(1px 1px at 32% 60%, #fff, transparent),
      radial-gradient(1px 1px at 62% 30%, #fff, transparent),
      radial-gradient(1px 1px at 82% 70%, #fff, transparent),
      radial-gradient(1px 1px at 22% 80%, #fff, transparent);
      background-size:220px 220px;animation:twinkle 4s ease-in-out infinite alternate;pointer-events:none;}
    @keyframes twinkle{from{opacity:.15}to{opacity:.35}}
    .bg-veil{
      position:fixed; inset:-10% -10% 0 -10%; z-index:-5; pointer-events:none;
      opacity:.9; filter:blur(2px);
      background:
        radial-gradient(800px 500px at 12% 14%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(720px 460px at 82% 72%, rgba(232,212,162,.12), transparent 60%),
        radial-gradient(900px 560px at 58% 12%, rgba(157,126,168,.10), transparent 70%);
      animation:veilDrift 50s linear infinite alternate;
    }
    @keyframes veilDrift{ to{ transform:translate3d(-10px,8px,0) } }

    .bg-constellations{position:fixed; inset:0; z-index:-4; pointer-events:none; opacity:.18; mix-blend-mode:screen;}
    .bg-constellations line{ stroke:rgba(255,255,255,.18); stroke-width:.6 }
    .bg-constellations circle{ fill:rgba(255,255,255,.7); r:1.2; animation:starBlink 4.6s ease-in-out infinite }
    @keyframes starBlink{ 0%,100%{opacity:.25} 50%{opacity:.85} }

    .bg-glyphs{
      position:fixed; inset:0; z-index:-2; pointer-events:none;
      opacity:.13; filter:drop-shadow(0 0 20px rgba(232,212,162,.06));
      background-repeat:no-repeat;
      background-size: 68px 68px, 76px 76px, 64px 64px, 72px 72px, 60px 60px, 70px 70px;
      background-position: 8% 24%, 86% 22%, 12% 78%, 88% 68%, 42% 88%, 34% 34%;
      animation:glyphFloat 40s ease-in-out infinite alternate;
      background-image:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M32 10 v36'/><path d='M22 30 h20'/><path d='M28 48 h8'/><circle cx='32' cy='10' r='3' fill='none'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='32' cy='32' r='16'/><path d='M32 16 L37 40 L20 26 H44 L27 40 Z'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>");
    }
    @keyframes glyphFloat{ to{ transform:translate3d(0,-8px,0) rotate(-0.5deg) } }

    .zodiac{position:fixed;width:820px;height:820px;left:50%;top:50%;transform:translate(-50%,-50%);z-index:-2;opacity:.1;filter:drop-shadow(0 0 20px rgba(255,255,255,.1));animation:rot 90s linear infinite;pointer-events:none;}
    @keyframes rot{to{transform:translate(-50%,-50%) rotate(360deg)}}

    @media (prefers-reduced-motion: reduce){
      .bg-veil,.bg-constellations,.bg-glyphs,.zodiac{ animation:none }
    }

    /* ========== 顶部栏（保留结构，仅统一视觉） ========== */
    .chat-header{
      position:sticky; top:0; z-index:10;
      background:rgba(28,22,40,.6);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
      padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
      padding-top: calc(env(safe-area-inset-top, 0px) + 12px);
    }
    .back-button{
      color:var(--gold-light); text-decoration:none; display:flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid transparent; border-radius:18px; background:rgba(255,255,255,.06);
      transition:.25s;
    }
    .back-button:hover{ transform:translateX(-2px); border-color:var(--border); color:#fff }

    .card-info{display:flex;align-items:center;gap:12px}
    .card-mini{
      width:40px;height:60px;border-radius:10px;overflow:hidden;
      background:linear-gradient(135deg, rgba(157,126,168,.36), rgba(232,212,162,.2));
      border:1px solid var(--border); box-shadow:0 8px 16px rgba(0,0,0,.25);
      display:flex;align-items:center;justify-content:center;color:var(--gold-light);
    }
    .card-details{text-align:left}
    .card-name{font-weight:700;color:var(--gold-light);line-height:1}
    .card-direction{font-size:.92rem;color:var(--text-muted);margin-top:2px}

    .chat-limit{
      background:rgba(255,255,255,.08); color:var(--gold-light);
      padding:6px 12px;border-radius:16px;border:1px solid var(--border); font-size:.92rem;
    }
    .chat-limit .count{font-weight:800;color:#fff}

    /* ========== 主体容器（玻璃面板） ========== */
    .chat-container{
      flex:1; display:flex; flex-direction:column; width:100%; max-width:980px; margin:12px auto 0;
      background:var(--panel); border:1px solid var(--border); border-radius:20px;
      box-shadow:0 16px 36px rgba(0,0,0,.28); overflow:hidden;
    }

    /* 消息区域（滚动区） */
    .messages-area{
      flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:14px; scroll-behavior:smooth;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.04));
    }
    .messages-area::-webkit-scrollbar{ width:8px }
    .messages-area::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.18); border-radius:4px }
    .messages-area::-webkit-scrollbar-thumb:hover{ background:rgba(255,255,255,.28) }

    /* 人格选择 / 欢迎区（纯视觉统一） */
    .personality-selection, .welcome-message{
      color:var(--text-light);
    }
    .personality-title{ font-size:1.6rem; color:var(--gold-light); margin-bottom:8px; font-weight:700 }
    .personality-subtitle{ color:var(--text-muted); margin-bottom:22px }
    .personality-cards{ display:flex; gap:18px; justify-content:center; flex-wrap:wrap; max-width:800px; margin:0 auto }
    .personality-card{
      background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:18px; padding:22px; width:220px; cursor:pointer;
      transition:.25s; box-shadow:0 10px 24px rgba(0,0,0,.18);
    }
    .personality-card:hover{ transform:translateY(-4px); box-shadow:0 14px 28px rgba(0,0,0,.26); border-color:var(--border) }
    .personality-icon{ font-size:2.4rem; margin-bottom:12px; display:block; height:46px; color:var(--gold-light) }
    .personality-name{ font-weight:700; color:#fff; margin-bottom:6px }
    .personality-desc{ font-size:.95rem; color:var(--text-muted) }
    .trait-tag{ background:rgba(255,255,255,.08); border:1px solid var(--border); color:var(--gold-light); padding:4px 10px; border-radius:14px; font-size:.85rem }

    .welcome-message{ text-align:center; padding:28px 16px }
    .welcome-icon{ font-size:2.4rem; color:var(--gold-light); margin-bottom:12px }
    .welcome-text{ font-size:1.05rem }
    .quick-questions{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:16px }
    .quick-question{
      background:linear-gradient(135deg, rgba(157,126,168,.20), rgba(232,212,162,.12));
      border:1px solid var(--border); color:#fff; padding:10px 16px; border-radius:18px; cursor:pointer; transition:.25s; font-size:.95rem;
      box-shadow:0 6px 16px rgba(0,0,0,.22);
    }
    .quick-question:hover{ transform:translateY(-2px) }

    /* 消息气泡 */
    .message{ display:flex; gap:10px; animation:messageSlide .25s ease-out }
    @keyframes messageSlide{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
    .message.user{ flex-direction:row-reverse }

    .message-avatar{
      width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1rem; color:#fff; flex-shrink:0;
      background:linear-gradient(135deg, var(--primary), var(--secondary));
      border:1px solid var(--border); box-shadow:0 4px 10px rgba(0,0,0,.25);
    }
    .assistant .message-avatar{ background:linear-gradient(135deg, var(--primary), var(--secondary)) }

    .message-content{
      max-width:75%;
      padding:12px 16px; border-radius:14px; line-height:1.65;
      background:var(--ai-msg-bg); color:var(--text-light); border:1px solid var(--border);
      box-shadow: var(--ai-msg-shadow);
      word-wrap: break-word; overflow-wrap: anywhere;
    }
    .user .message-content{
      background: var(--user-msg-bg); color:#fff; border-color:rgba(255,255,255,.18);
      box-shadow:0 10px 22px rgba(157,126,168,.36);
      border-bottom-right-radius:6px;
    }
    .assistant .message-content{ border-bottom-left-radius:6px }

    /* AI 富文本排版（深色对比微调） */
    .message-content p{ margin:.75em 0 }
    .message-content ul, .message-content ol{ margin:.75em 0; padding-left:1.5em }
    .message-content li{ margin:.4em 0 }
    .message-content strong{ color:var(--gold-light); font-weight:700 }
    .user .message-content strong{ color:#fff }
    .message-content em{ opacity:.95 }
    .message-content blockquote{
      margin:.9em 0; padding:.6em .9em;
      border-left:3px solid var(--gold-light);
      background:rgba(255,255,255,.06);
      border-radius:0 10px 10px 0;
    }
    .message-content h3{ font-size:1.06rem; color:var(--gold-light); margin:1em 0 .5em; font-weight:700 }
    .message-content h4{ font-size:1rem; color:#fff; margin:.8em 0 .4em; font-weight:700 }

    /* 打字动画 */
    .typing-indicator{ display:flex; gap:10px; align-items:center }
    .typing-dots{
      display:flex; gap:4px; padding:12px 14px; background:rgba(255,255,255,.06);
      border-radius:12px; border:1px solid var(--border); box-shadow:0 6px 14px rgba(0,0,0,.2);
    }
    .typing-dot{ width:8px; height:8px; background:rgba(255,255,255,.6); border-radius:50%; animation:typingDot 1.4s infinite }
    .typing-dot:nth-child(2){ animation-delay:.2s } .typing-dot:nth-child(3){ animation-delay:.4s }
    @keyframes typingDot{ 0%,60%,100%{ transform:translateY(0); opacity:.5 } 30%{ transform:translateY(-8px); opacity:1 } }

    /* 输入区（贴底留安全区） */
    .input-area{
      background:rgba(28,22,40,.6); border-top:1px solid var(--border);
      padding:14px 16px; box-shadow:0 -10px 20px rgba(0,0,0,.18);
      padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px));
    }
    .input-container{ display:flex; gap:10px; align-items:flex-end; max-width:720px; margin:0 auto }
    .message-input{
      flex:1; border:1px solid var(--border); border-radius:18px; padding:12px 14px; resize:none; outline:none; font-size:16px; /* 防 iOS 放大 */
      background:rgba(255,255,255,.06); color:#fff; max-height:160px;
    }
    .message-input:focus{ box-shadow:0 0 0 2px rgba(157,126,168,.28) inset }
    .send-button{
      background:linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; border:none; width:48px; height:48px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.25s;
      border:1px solid var(--border); box-shadow:0 10px 22px rgba(157,126,168,.32);
      -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    }
    .send-button:hover:not(:disabled){ transform:translateY(-2px) }
    .send-button:disabled{ opacity:.6; cursor:not-allowed }

    /* 限制提示 */
    .limit-reached{
      background: rgba(239,68,68,.08); border:1px solid rgba(239,68,68,.35);
      padding:14px; border-radius:12px; text-align:center; color:#fecaca; /* 较亮的红 */
    }

    /* 加载骨架 */
    .loading-skeleton{ display:none; text-align:center; padding:40px; color:var(--text-muted) }
    .skeleton-pulse{
      display:inline-block; width:60px; height:60px;
      background:linear-gradient(90deg, rgba(255,255,255,.10) 25%, rgba(255,255,255,.16) 50%, rgba(255,255,255,.10) 75%);
      background-size:200% 100%; animation:pulse 1.5s infinite; border-radius:50%; margin-bottom:16px;
    }
    @keyframes pulse{ 0%{ background-position:200% 0 } 100%{ background-position:-200% 0 } }

    /* 响应式 */
    @media (max-width: 768px){
      .card-info{ display:none }
      .messages-area{ padding:16px }
      .message-content{ max-width:88% }
      .personality-card{ width:100%; max-width:300px }
      .chat-container{ border-radius:16px; margin:10px 10px 0 }
      .chat-header{ padding-left:12px; padding-right:12px }
    }

    /* iOS 体验增强（与 index 一致的修饰） */
    @supports (-webkit-touch-callout: none) {
      .bg-veil, .bg-constellations, .bg-glyphs, .zodiac { display: none !important; }
      .bg-stars{ position: fixed !important; inset:0; height:100dvh; z-index:0; pointer-events:none; backface-visibility:hidden; transform:translateZ(0); animation:none;
        background:
          radial-gradient(820px 520px at 12% 14%, rgba(157,126,168,.26), transparent 60%),
          radial-gradient(760px 480px at 82% 72%, rgba(232,212,162,.20), transparent 60%),
          radial-gradient(920px 580px at 58% 12%, rgba(157,126,168,.16), transparent 72%),
          radial-gradient(1px 1px at 12% 25%, rgba(255,255,255,.95), transparent),
          radial-gradient(1px 1px at 32% 60%, rgba(255,255,255,.95), transparent),
          radial-gradient(1px 1px at 62% 30%, rgba(255,255,255,.95), transparent),
          radial-gradient(1px 1px at 82% 70%, rgba(255,255,255,.95), transparent),
          radial-gradient(1px 1px at 22% 80%, rgba(255,255,255,.95), transparent),
          linear-gradient(135deg, #2d1b4e 0%, #1a1625 100%);
        background-repeat: repeat,repeat,repeat, repeat,repeat,repeat,repeat,repeat, no-repeat;
        background-size: cover,cover,cover, 220px 220px,220px 220px,220px 220px,220px 220px,220px 220px, cover;
        background-position: 12% 14%,82% 72%,58% 12%, 12% 25%,32% 60%,62% 30%,82% 70%,22% 80%, center;
      }
      html{ background:#120c1d; }
    }

  </style>
</head>
<body>
  <!-- 背景层（完全视觉，不影响业务） -->
  <div class="bg-stars" aria-hidden="true"></div>
  <div class="bg-veil" aria-hidden="true"></div>
  <svg class="bg-constellations" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-hidden="true">
    <g>
      <line x1="90" y1="120" x2="160" y2="160"/><line x1="160" y1="160" x2="210" y2="110"/><line x1="160" y1="160" x2="110" y2="200"/>
      <circle cx="90" cy="120"/><circle cx="160" cy="160" style="animation-delay:.6s"/><circle cx="210" cy="110" style="animation-delay:1.2s"/><circle cx="110" cy="200" style="animation-delay:1.8s"/>
    </g>
    <g>
      <line x1="780" y1="120" x2="840" y2="160"/><line x1="840" y1="160" x2="900" y2="180"/><line x1="900" y1="180" x2="950" y2="150"/>
      <circle cx="780" cy="120"/><circle cx="840" cy="160" style="animation-delay:.8s"/><circle cx="900" cy="180" style="animation-delay:1.4s"/><circle cx="950" cy="150" style="animation-delay:2s"/>
    </g>
    <g>
      <line x1="760" y1="740" x2="820" y2="780"/><line x1="820" y1="780" x2="880" y2="740"/><line x1="820" y1="780" x2="840" y2="840"/>
      <circle cx="760" cy="740"/><circle cx="820" cy="780" style="animation-delay:.7s"/><circle cx="880" cy="740" style="animation-delay:1.3s"/><circle cx="840" cy="840" style="animation-delay:1.9s"/>
    </g>
  </svg>
  <div class="bg-glyphs" aria-hidden="true"></div>
  <svg class="zodiac" viewBox="0 0 100 100" aria-hidden="true">
    <g fill="none" stroke="#fff" stroke-opacity=".7" stroke-width=".3">
      <circle cx="50" cy="50" r="44"/>
      <circle cx="50" cy="50" r="34" stroke-opacity=".4"/>
      <g stroke-opacity=".25"><line x1="50" y1="6" x2="50" y2="94"/><line x1="6" y1="50" x2="94" y2="50"/><line x1="18" y1="18" x2="82" y2="82"/><line x1="18" y1="82" x2="82" y2="18"/></g>
    </g>
    <g fill="#fff" fill-opacity=".55" font-size="6" font-family="serif">
      <text x="50" y="10" text-anchor="middle">♈︎♉︎♊︎♋︎♌︎♍︎♎︎♏︎♐︎♑︎♒︎♓︎</text>
    </g>
  </svg>

  <!-- 顶部导航（结构不变） -->
  <div class="chat-header">
    <a href="{{ url_for('index') }}" class="back-button">
      <i class="fas fa-arrow-left"></i>
      <span>返回</span>
    </a>

    <div class="card-info">
      <div class="card-mini">
        {% if card_info.image %}
          <img src="{{ card_info.image }}" alt="{{ card_info.name }}" style="width: 100%; height: 100%; object-fit: cover;">
        {% else %}
          <i class="fas fa-sun"></i>
        {% endif %}
      </div>
      <div class="card-details">
        <div class="card-name">{{ card_info.name }}</div>
        <div class="card-direction">{{ card_info.direction }}</div>
      </div>
    </div>

    <div class="chat-limit">
      剩余对话: <span class="count" id="remaining-count">{{ remaining_chats }}</span>
    </div>
  </div>

  <!-- 聊天容器（结构不变） -->
  <div class="chat-container">
    <div class="messages-area" id="messages-area">
      <!-- 加载骨架屏 -->
      <div class="loading-skeleton" id="loading-skeleton">
        <div class="skeleton-pulse"></div>
        <div>正在准备您的专属解读空间...</div>
      </div>

      <!-- 人格选择界面 -->
      <div class="personality-selection" id="personality-selection" style="display:none;">
        <h2 class="personality-title">选择您的塔罗解读师</h2>
        <p class="personality-subtitle">每位解读师都有独特的风格，选择最适合您的那一位</p>

        <div class="personality-cards">
          <div class="personality-card mystic" onclick="selectPersonality('mystic')">
            <span class="personality-icon"><i class="fas fa-moon"></i></span>
            <h3 class="personality-name">神秘占卜师</h3>
            <p class="personality-desc">深谙古老智慧，用神秘的语言解读命运的轨迹</p>
            <div class="personality-traits">
              <span class="trait-tag">深邃</span><span class="trait-tag">神秘</span><span class="trait-tag">直觉</span>
            </div>
          </div>
          <div class="personality-card wisdom" onclick="selectPersonality('wisdom')">
            <span class="personality-icon"><i class="fas fa-book"></i></span>
            <h3 class="personality-name">智慧导师</h3>
            <p class="personality-desc">理性分析每张牌的含义，给出实用的人生建议</p>
            <div class="personality-traits">
              <span class="trait-tag">理性</span><span class="trait-tag">清晰</span><span class="trait-tag">实用</span>
            </div>
          </div>
          <div class="personality-card warm" onclick="selectPersonality('warm')">
            <span class="personality-icon"><i class="fas fa-heart"></i></span>
            <h3 class="personality-name">温暖陪伴者</h3>
            <p class="personality-desc">像朋友般倾听你的故事，用温暖的话语治愈心灵</p>
            <div class="personality-traits">
              <span class="trait-tag">温暖</span><span class="trait-tag">共情</span><span class="trait-tag">治愈</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 欢迎消息 -->
      <div class="welcome-message" id="welcome-message" style="display:none;">
        <div class="welcome-icon"><i class="fas fa-sparkles"></i></div>
        <div class="welcome-text">
          我是你的塔罗解读师，让我们一起探索<br>
          《{{ card_info.name }}》（{{ card_info.direction }}）带给你的启示
        </div>
        <div class="quick-questions">
          <div class="quick-question" onclick="quickAsk('这张牌对我今天有什么指引？')">这张牌对我今天有什么指引？</div>
          <div class="quick-question" onclick="quickAsk('在感情方面，这张牌想告诉我什么？')">感情方面的启示</div>
          <div class="quick-question" onclick="quickAsk('这张牌对我的事业有什么建议？')">事业发展建议</div>
        </div>
      </div>
    </div>

    <!-- 输入区域（结构不变） -->
    <div class="input-area">
      {% if can_chat %}
        <div class="input-container" id="input-container" style="display:none;">
          <textarea
            class="message-input"
            id="message-input"
            placeholder="问我关于这张塔罗牌的任何问题..."
            rows="1"
            maxlength="500"
          ></textarea>
          <button class="send-button" id="send-button" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      {% else %}
        <div class="limit-reached">
          <i class="fas fa-moon"></i> 今日对话次数已用完，明天再来探索塔罗的奥秘吧
        </div>
      {% endif %}
    </div>
  </div>

  <!-- ================= 原脚本：未改动任何功能 ================= -->
  <script>
    // 从服务端获取数据
    let sessionId = "{{ session_id or '' }}";
    let isTyping = false;
    let remainingChats = {{ remaining_chats }};
    const hasHistory = {{ has_history|tojson }};
    const serverMessages = {{ messages|tojson }};
    let selectedPersonality = null;
    let aiPersonality = {{ ai_personality|tojson }} || null;

    // 格式化 AI 消息
    function formatAIMessage(content) {
      // 处理换行 - 保留单个换行，双换行转为段落
      let formatted = content.split(/\n\n+/).map(para => {
        if (para.trim()) {
          return `<p>${para.trim().replace(/\n/g, '<br>')}</p>`;
        }
        return '';
      }).filter(p => p).join('');

      // 处理编号列表 (1. 2. 等)
      formatted = formatted.replace(/<p>(\d+)\.\s+(.+?)(<\/p>|<br>)/g, (match, num, text, ending) => {
        return `<li value="${num}">${text}</li>`;
      });

      // 处理无序列表 (- * • 等开头)
      formatted = formatted.replace(/<p>[\-\*•]\s+(.+?)(<\/p>|<br>)/g, (match, text, ending) => {
        return `<li>${text}</li>`;
      });

      // 将连续的 li 包装成列表
      formatted = formatted.replace(/(<li.*?<\/li>\s*)+/g, match => {
        if (match.includes('value=')) {
          return `<ol>${match}</ol>`;
        }
        return `<ul>${match}</ul>`;
      });

      // **text** 或 __text__
      formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      formatted = formatted.replace(/__(.+?)__/g, '<strong>$1</strong>');

      // *text* 或 _text_
      formatted = formatted.replace(/\*(.+?)\*/g, '<em>$1</em>');
      formatted = formatted.replace(/_(.+?)_/g, '<em>$1</em>');

      // 标题
      formatted = formatted.replace(/<p>###\s+(.+?)<\/p>/g, '<h4>$1</h4>');
      formatted = formatted.replace(/<p>##\s+(.+?)<\/p>/g, '<h3>$1</h3>');

      // 引用
      formatted = formatted.replace(/<p>&gt;\s*(.+?)<\/p>/g, '<blockquote>$1</blockquote>');

      // 分隔线
      formatted = formatted.replace(/<p>[\-\*_]{3,}<\/p>/g, '<hr style="margin: 1em 0; border: none; border-top: 1px solid rgba(255,255,255,.12);">');

      return formatted || content;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loading-skeleton').style.display = 'block';
      initializeChat();

      const input = document.getElementById('message-input');
      if (input) {
        input.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 160) + 'px';
        });

        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });

    function initializeChat() {
      document.getElementById('loading-skeleton').style.display = 'none';
      console.log('Has history:', hasHistory);
      console.log('Server messages:', serverMessages);
      console.log('AI personality:', aiPersonality);

      if (hasHistory && serverMessages.length > 0) {
        serverMessages.forEach(msg => {
          appendMessage(msg.role, msg.content, false);
        });
        document.getElementById('input-container').style.display = 'flex';
      } else if (!aiPersonality) {
        document.getElementById('personality-selection').style.display = 'block';
      } else {
        selectedPersonality = aiPersonality;
        document.getElementById('welcome-message').style.display = 'block';
        document.getElementById('input-container').style.display = 'flex';
      }

      if (!sessionId) {
        initSession();
      }
    }

    function selectPersonality(personality) {
      selectedPersonality = personality;
      document.getElementById('personality-selection').style.display = 'none';
      document.getElementById('loading-skeleton').style.display = 'block';
      initSession(personality);
    }

    async function initSession(personality = null) {
      try {
        const payload = {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            ai_personality: personality || selectedPersonality
          })
        };

        const response = await fetch('/api/chat/init', payload);

        if (response.ok) {
          const data = await response.json();
          sessionId = data.session_id;

          if (personality) {
            document.getElementById('loading-skeleton').style.display = 'none';
            document.getElementById('welcome-message').style.display = 'block';
            document.getElementById('input-container').style.display = 'flex';
          }
        }
      } catch (error) {
        console.error('Init session failed:', error);
        document.getElementById('loading-skeleton').style.display = 'none';
      }
    }

    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      if (!message || isTyping) return;

      input.value = '';
      input.style.height = 'auto';

      const welcome = document.getElementById('welcome-message');
      if (welcome) welcome.style.display = 'none';

      appendMessage('user', message);
      showTyping();
      isTyping = true;

      try {
        const response = await fetch('/api/chat/send', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            message: message,
            session_id: sessionId,
            ai_personality: selectedPersonality
          })
        });

        const data = await response.json();
        hideTyping();
        isTyping = false;

        appendMessage('assistant', data.reply);

        if (data.remaining !== undefined) {
          remainingChats = data.remaining;
          document.getElementById('remaining-count').textContent = remainingChats;
        }

        if (data.limit_reached) {
          disableInput();
        }

      } catch (error) {
        console.error('Send message failed:', error);
        hideTyping();
        isTyping = false;
        appendMessage('assistant', '抱歉，消息发送失败，请稍后重试。');
      }
    }

    function quickAsk(question) {
      const input = document.getElementById('message-input');
      if (input) {
        input.value = question;
        sendMessage();
      }
    }

    function appendMessage(role, content, animate = true) {
      const messagesArea = document.getElementById('messages-area');

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;
      if (animate) messageDiv.style.animation = 'messageSlide .25s ease-out';

      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';

      if (role === 'user') {
        avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
      } else {
        const icons = { 'mystic': '<i class="fas fa-moon"></i>', 'wisdom': '<i class="fas fa-book"></i>', 'warm': '<i class="fas fa-heart"></i>' };
        avatarDiv.innerHTML = icons[selectedPersonality] || '<i class="fas fa-sparkles"></i>';
      }

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      if (role === 'assistant') {
        contentDiv.innerHTML = formatAIMessage(content);
      } else {
        contentDiv.textContent = content;
      }

      messageDiv.appendChild(avatarDiv);
      messageDiv.appendChild(contentDiv);
      messagesArea.appendChild(messageDiv);

      setTimeout(() => { messagesArea.scrollTop = messagesArea.scrollHeight; }, 80);
    }

    function showTyping() {
      const messagesArea = document.getElementById('messages-area');
      const typingDiv = document.createElement('div');
      typingDiv.id = 'typing-indicator';
      typingDiv.className = 'message assistant typing-indicator';
      const icons = { 'mystic': '<i class="fas fa-moon"></i>', 'wisdom': '<i class="fas fa-book"></i>', 'warm': '<i class="fas fa-heart"></i>' };
      typingDiv.innerHTML = `
        <div class="message-avatar">${icons[selectedPersonality] || '<i class="fas fa-sparkles"></i>'}</div>
        <div class="typing-dots">
          <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
        </div>`;
      messagesArea.appendChild(typingDiv);
      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function hideTyping() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) typingIndicator.remove();
    }

    function disableInput() {
      const inputArea = document.querySelector('.input-area');
      inputArea.innerHTML = `
        <div class="limit-reached">
          <i class="fas fa-moon"></i> 今日对话次数已用完，明天再来探索塔罗的奥秘吧
        </div>`;
    }
  </script>
</body>
</html>
