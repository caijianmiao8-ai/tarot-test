<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>å¡”ç½—ç‰Œé˜µå åœ</title>

  <!-- æœ¬åœ°èµ„æºï¼ˆä¸ç«™ç‚¹ä¸€è‡´ï¼‰ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    /* ===== å®‡å®™ä¸»é¢˜å˜é‡ï¼ˆä¸ index/result/stats ä¿æŒä¸€è‡´ï¼‰ ===== */
    :root{
      --primary:#9d7ea8; --secondary:#6d5675; --gold:#e8d4a2; --gold-light:#f4e5c3;
      --bg1:#2d1b4e; --bg2:#1a1625;
      --text:#fff; --text-light:rgba(255,255,255,.88); --text-muted:rgba(255,255,255,.65);
      --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --star:#ffd700; --success:#10b981; --danger:#ef4444; --warning:#f59e0b;
    }

    html,body{min-height:100dvh;min-height:calc(var(--vh,1vh)*100)}
    *{box-sizing:border-box}

    body{
      margin:0; color:var(--text);
      font-family:'Noto Serif SC',-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(1200px 700px at 80% 90%, rgba(232,212,162,.12), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      position:relative; overflow-x:hidden;
    }

    /* èƒŒæ™¯å±‚ï¼ˆä¸é¦–é¡µä¸€è‡´ï¼‰ */
    .bg-stars{position:fixed;inset:0;z-index:-2;opacity:.25;background-image:
      radial-gradient(1px 1px at 12% 25%, #fff, transparent),
      radial-gradient(1px 1px at 32% 60%, #fff, transparent),
      radial-gradient(1px 1px at 62% 30%, #fff, transparent),
      radial-gradient(1px 1px at 82% 70%, #fff, transparent),
      radial-gradient(1px 1px at 22% 80%, #fff, transparent);
      background-size:220px 220px;animation:twinkle 4s ease-in-out infinite alternate;pointer-events:none;}
    @keyframes twinkle{from{opacity:.15}to{opacity:.35}}
    .zodiac{position:fixed;width:820px;height:820px;left:50%;top:50%;transform:translate(-50%,-50%);z-index:-2;opacity:.1;filter:drop-shadow(0 0 20px rgba(255,255,255,.1));animation:rot 90s linear infinite;pointer-events:none;}
    @keyframes rot{to{transform:translate(-50%,-50%) rotate(360deg)}}

    /* è½»é›¾/æ˜Ÿåº§çº¿/å››å…ƒç´ ç¬¦å· */
    .bg-veil{
      position:fixed; inset:-10% -10% 0 -10%;
      z-index:-5; pointer-events:none; opacity:.9; filter:blur(2px);
      background:
        radial-gradient(800px 500px at 12% 14%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(720px 460px at 82% 72%, rgba(232,212,162,.12), transparent 60%),
        radial-gradient(900px 560px at 58% 12%, rgba(157,126,168,.10), transparent 70%);
      animation:veilDrift 50s linear infinite alternate;
    }
    @keyframes veilDrift{to{transform:translate3d(-10px,8px,0)}}

    .bg-constellations{position:fixed; inset:0; z-index:-4; pointer-events:none; opacity:.18; mix-blend-mode:screen}
    .bg-constellations line{ stroke:rgba(255,255,255,.18); stroke-width:.6 }
    .bg-constellations circle{ fill:rgba(255,255,255,.7); r:1.2; animation:starBlink 4.6s ease-in-out infinite }
    @keyframes starBlink{ 0%,100%{opacity:.25} 50%{opacity:.85} }

    .bg-glyphs{
      position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.13;
      filter:drop-shadow(0 0 20px rgba(232,212,162,.06));
      background-repeat:no-repeat;
      background-size: 68px 68px, 76px 76px, 64px 64px, 72px 72px, 60px 60px, 70px 70px;
      background-position: 8% 24%, 86% 22%, 12% 78%, 88% 68%, 42% 88%, 34% 34%;
      animation:glyphFloat 40s ease-in-out infinite alternate;
      background-image:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke'%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M32 10 v36'/><path d='M22 30 h20'/><path d='M28 48 h8'/><circle cx='32' cy='10' r='3'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='32' cy='32' r='16'/><path d='M32 16 L37 40 L20 26 H44 L27 40 Z'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>");
    }
    @keyframes glyphFloat{ to{ transform:translate3d(0,-8px,0) rotate(-0.5deg) } }

    @media (prefers-reduced-motion: reduce){
      .bg-veil,.bg-glyphs,.bg-constellations,.zodiac{ animation:none }
    }

    /* é¡¶éƒ¨ç”¨æˆ·æ ï¼šä¸å…¨ç«™ä¸€è‡´ */
    .user-bar{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(28,22,40,.6);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding-top:calc(env(safe-area-inset-top,0px)+10px)}
    .user-bar-content{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-icon{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid var(--border)}
    .user-name{color:var(--gold-light);font-weight:600;letter-spacing:.5px}
    .user-actions{display:flex;gap:10px}
    .user-actions a{color:var(--text-light);text-decoration:none;font-size:.95rem;padding:8px 14px;border-radius:18px;border:1px solid transparent;transition:.25s;background:rgba(255,255,255,.06);backdrop-filter:blur(8px)}
    .user-actions a:hover{color:#fff;border-color:var(--border);transform:translateY(-1px)}

    /* ä¸»å®¹å™¨ */
    .main-container{max-width:1200px;margin:calc(88px + env(safe-area-inset-top,0px)) auto 100px;padding:20px}

    /* å¤´éƒ¨åŒºå— + è¿”å›æŒ‰é’® */
    .header-section{text-align:center;margin-bottom:22px}
    .page-title{margin:0;font-size:32px;font-weight:900;letter-spacing:.3px;color:var(--gold-light);text-shadow:0 2px 6px rgba(0,0,0,.25)}
    .page-subtitle{margin:8px 0 12px;color:var(--text-muted)}
    .back-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text-light);text-decoration:none}
    .back-pill:hover{transform:translateX(-2px);color:#fff}
    .status-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:999px;padding:8px 14px;color:var(--gold-light);font-weight:700;margin-top:10px}
    .remaining-count{color:#fff}

    /* åˆ†ç±»ç­›é€‰ */
    .category-container{margin:22px 0 26px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none}
    .category-container::-webkit-scrollbar{display:none}
    .category-filters{display:flex;gap:12px;min-width:max-content}
    .category-btn{
      flex-shrink:0;padding:10px 18px;border-radius:999px;font-weight:800;letter-spacing:.2px;
      color:#fff;background:rgba(255,255,255,.06);border:1px solid var(--border);backdrop-filter:blur(6px);
      transition:.2s;
    }
    .category-btn:hover{transform:translateY(-2px);background:rgba(255,255,255,.1)}
    .category-btn.active{color:#fff;border-color:transparent;background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:0 10px 28px rgba(110,80,100,.25)}

    /* ç‰Œé˜µç½‘æ ¼ä¸å¡ç‰‡ */
    .spreads-grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fill,minmax(320px,1fr))}
    .spread-card{
      position:relative;overflow:hidden;cursor:pointer;background:rgba(255,255,255,.06);
      border:1px solid var(--border);border-radius:18px;box-shadow:0 8px 18px rgba(0,0,0,.14);
      transition:transform .24s cubic-bezier(.22,.61,.36,1), box-shadow .24s;
    }
    .spread-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,.18)}
    .spread-card.selected{box-shadow:0 0 0 4px rgba(157,126,168,.22),0 10px 28px rgba(0,0,0,.18);border-color:transparent}
    .card-content{padding:18px}
    .card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px}
    .spread-name{margin:0;font-size:20px;font-weight:900;color:#fff;letter-spacing:.2px}
    .selected-check{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:0 6px 14px rgba(110,80,100,.25);opacity:0;transform:scale(0);transition:all .2s}
    .spread-card.selected .selected-check{opacity:1;transform:scale(1)}
    .spread-meta{display:flex;gap:16px;color:var(--text-muted);font-size:13px;margin-bottom:8px}
    .meta-item{display:flex;gap:6px;align-items:center}
    .difficulty-badge{padding:2px 8px;border-radius:999px;font-size:11px;font-weight:800;letter-spacing:.4px;text-transform:uppercase;background:rgba(255,255,255,.08);border:1px solid var(--border);color:var(--text-light)}
    .difficulty-badge.ç®€å•{background:rgba(16,185,129,.12);color:#8ff3c6}
    .difficulty-badge.ä¸­ç­‰{background:rgba(245,158,11,.12);color:#ffd79a}
    .difficulty-badge.å¤æ‚{background:rgba(59,130,246,.12);color:#b7d7ff}
    .spread-description{color:var(--text-light);font-size:15px;line-height:1.6;margin:8px 0 12px}
    .positions-preview{display:flex;flex-wrap:wrap;gap:6px}
    .position-tag{background:rgba(255,255,255,.08);border:1px solid var(--border);padding:4px 10px;border-radius:999px;font-size:12px;color:#fff}

    /* æµ®åŠ¨æ“ä½œé¢æ¿ */
    .floating-panel{
      position:fixed;left:50%;bottom:calc(20px + env(safe-area-inset-bottom,0px));transform:translateX(-50%);
      width:calc(100% - 40px);max-width:800px;background:rgba(28,22,40,.82);
      backdrop-filter:blur(14px) saturate(140%);-webkit-backdrop-filter:blur(14px) saturate(140%);
      border:1px solid var(--border);border-radius:20px;padding:16px 16px 14px;
      box-shadow:0 20px 44px rgba(0,0,0,.35);opacity:0;visibility:hidden;transition:all .28s cubic-bezier(.22,.61,.36,1);
      max-height:calc(100vh - 40px);overflow:auto;color:#fff;
    }
    .floating-panel.show{opacity:1;visibility:visible}
    .panel-header{display:flex;align-items:center;justify-content:space-between;padding:4px 4px 10px;border-bottom:1px solid var(--border);margin-bottom:12px}
    .panel-title-wrap{display:flex;align-items:center;gap:12px}
    .panel-icon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:0 6px 14px rgba(110,80,100,.25)}
    .panel-title{margin:0;font-size:18px;font-weight:900;color:#fff}
    .panel-subtitle{font-size:12px;color:var(--text-muted);margin-top:2px}
    .close-panel{width:30px;height:30px;border:none;border-radius:50%;background:rgba(255,255,255,.08);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;border:1px solid var(--border)}
    .close-panel:hover{background:rgba(255,255,255,.15);transform:rotate(6deg)}
    .panel-grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .panel-col{display:flex;flex-direction:column;gap:12px}
    .input-label{display:block;color:var(--text-muted);font-size:13px}
    .text-input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:#fff;font-size:16px;transition:.2s}
    .text-input::placeholder{color:rgba(255,255,255,.5)}
    .text-input:focus{outline:none;background:rgba(255,255,255,.1);box-shadow:0 0 0 4px rgba(157,126,168,.15)}
    .soft-hint{display:flex;align-items:flex-start;gap:8px;font-size:12px;color:var(--text-muted);background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .soft-hint i{color:var(--gold-light);margin-top:2px}
    .personality-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;align-items:stretch}
    .personality-card{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:14px 10px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.06);box-shadow:0 4px 16px rgba(0,0,0,.12);transition:.2s;height:100%}
    .personality-card:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(0,0,0,.18)}
    .personality-card.selected{border-color:transparent;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.14));box-shadow:0 0 0 4px rgba(157,126,168,.2),0 8px 22px rgba(0,0,0,.2)}
    .personality-emoji{font-size:24px;margin-bottom:6px}
    .personality-name{font-size:15px;font-weight:900;color:#fff;margin-bottom:2px}
    .personality-trait{font-size:12px;color:var(--text-muted)}
    .panel-right{display:grid;grid-template-rows:auto 1fr auto;gap:10px}
    .action-button{width:100%;padding:14px 28px;border:none;border-radius:14px;color:#fff;font-weight:900;letter-spacing:.3px;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:0 16px 32px rgba(157,126,168,.28);transition:.24s}
    .action-button:hover:not(:disabled){transform:translateY(-2px)}
    .action-button:disabled{opacity:.55;cursor:not-allowed}

    /* ç©ºçŠ¶æ€ */
    .empty-state{text-align:center;padding:80px 20px}
    .empty-icon{font-size:48px;color:var(--gold-light);opacity:.7;margin-bottom:20px}
    .empty-title{font-size:22px;font-weight:900;color:#fff;margin-bottom:8px}
    .empty-desc{font-size:17px;color:var(--text-muted);margin-bottom:18px}

    /* è¦†ç›–å±‚ï¼ˆå‡†å¤‡ä¸­ï¼‰ */
    .reading-overlay{position:fixed;inset:0;z-index:2000;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(8px)}
    .reading-card{width:min(560px,92vw);border-radius:20px;background:rgba(28,22,40,.9);border:1px solid var(--border);box-shadow:0 24px 48px rgba(0,0,0,.4);padding:26px 22px 20px;text-align:center;color:#fff}
    .reading-title{margin:0 0 8px;font-size:20px;font-weight:900;color:var(--gold-light)}
    .reading-sub{margin:0 0 18px;font-size:14px;color:var(--text-muted)}
    .shuffle{display:flex;align-items:center;justify-content:center;gap:12px;margin:4px 0 14px;height:96px;flex-wrap:nowrap}
    .tarot{width:64px;height:96px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:0 10px 24px rgba(110,80,100,.25);animation:floatY 1.8s ease-in-out infinite}
    @keyframes floatY{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .reading-progress{height:10px;width:100%;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--border);overflow:hidden}
    .reading-bar{height:100%;width:0%;border-radius:999px;background:linear-gradient(135deg,var(--primary),var(--secondary));transition:width .4s ease}
    .reading-hint{margin-top:10px;font-size:13px;color:var(--text-muted);min-height:18px}
    .reading-cancel{margin-top:14px;background:rgba(255,255,255,.08);border:1px solid var(--border);color:#fff;border-radius:999px;padding:8px 14px;font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.18)}
    .reading-cancel:hover{background:rgba(255,255,255,.15)}

    /* å“åº”å¼ */
    @media (max-width:992px){ .spreads-grid{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))} .panel-grid{grid-template-columns:1fr 1fr} }
    @media (max-width:768px){
      .main-container{margin:calc(74px + env(safe-area-inset-top,0px)) auto 90px}
      .page-title{font-size:28px}
    }
    @media (max-width:640px){ .floating-panel{max-width:600px} .panel-grid{grid-template-columns:1fr} }

    /* è§¦æ§ä¼˜åŒ– */
    a,.action-button,.reading-cancel,.category-btn,.spread-card{touch-action:manipulation}
  </style>
</head>
<body>
  <!-- èƒŒæ™¯å±‚ -->
  <div class="bg-stars"></div>
  <div class="bg-veil" aria-hidden="true"></div>
  <svg class="bg-constellations" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-hidden="true">
    <g><line x1="90" y1="120" x2="160" y2="160"/><line x1="160" y1="160" x2="210" y2="110"/><line x1="160" y1="160" x2="110" y2="200"/><circle cx="90" cy="120"/><circle cx="160" cy="160" style="animation-delay:.6s"/><circle cx="210" cy="110" style="animation-delay:1.2s"/><circle cx="110" cy="200" style="animation-delay:1.8s"/></g>
    <g><line x1="780" y1="120" x2="840" y2="160"/><line x1="840" y1="160" x2="900" y2="180"/><line x1="900" y1="180" x2="950" y2="150"/><circle cx="780" cy="120"/><circle cx="840" cy="160" style="animation-delay:.8s"/><circle cx="900" cy="180" style="animation-delay:1.4s"/><circle cx="950" cy="150" style="animation-delay:2s"/></g>
    <g><line x1="760" y1="740" x2="820" y2="780"/><line x1="820" y1="780" x2="880" y2="740"/><line x1="820" y1="780" x2="840" y2="840"/><circle cx="760" cy="740"/><circle cx="820" cy="780" style="animation-delay:.7s"/><circle cx="880" cy="740" style="animation-delay:1.3s"/><circle cx="840" cy="840" style="animation-delay:1.9s"/></g>
  </svg>
  <div class="bg-glyphs" aria-hidden="true"></div>
  <svg class="zodiac" viewBox="0 0 100 100" aria-hidden="true">
    <g fill="none" stroke="#fff" stroke-opacity=".7" stroke-width=".3">
      <circle cx="50" cy="50" r="44"/><circle cx="50" cy="50" r="34" stroke-opacity=".4"/>
      <g stroke-opacity=".25"><line x1="50" y1="6" x2="50" y2="94"/><line x1="6" y1="50" x2="94" y2="50"/><line x1="18" y1="18" x2="82" y2="82"/><line x1="18" y1="82" x2="82" y2="18"/></g>
    </g>
    <g fill="#fff" fill-opacity=".55" font-size="6" font-family="serif">
      <text x="50" y="10" text-anchor="middle">â™ˆï¸â™‰ï¸â™Šï¸â™‹ï¸â™Œï¸â™ï¸â™ï¸â™ï¸â™ï¸â™‘ï¸â™’ï¸â™“ï¸</text>
    </g>
  </svg>

  <!-- é¡¶éƒ¨ç”¨æˆ·æ ï¼ˆç»Ÿä¸€ï¼‰ -->
  <div class="user-bar">
    <div class="user-bar-content">
      <div class="user-info">
        <div class="user-icon">
          {% if not user.is_guest %}{{ user.username[0]|upper }}{% else %}<i class="fas fa-user"></i>{% endif %}
        </div>
        <span class="user-name">{{ user.username if not user.is_guest else "ç¥ç§˜è®¿å®¢" }}</span>
      </div>
      <div class="user-actions">
        <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> é¦–é¡µ</a>
        {% if user.is_guest %}
          <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> ç™»å½•</a>
          <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> æ³¨å†Œ</a>
        {% else %}
          <a href="{{ url_for('stats') }}"><i class="fas fa-chart-line"></i> ç»Ÿè®¡</a>
          <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ä¸»å®¹å™¨ -->
  <div class="main-container">
    {% if can_divine %}
      <div class="header-section">
        <a class="back-pill" href="{{ url_for('index') }}"><i class="fas fa-chevron-left"></i> è¿”å›</a>
        <h1 class="page-title">å¡”ç½—ç‰Œé˜µå åœ</h1>
        <p class="page-subtitle">é€‰æ‹©é€‚åˆä½ çš„ç‰Œé˜µï¼Œæ·±å…¥æ¢ç´¢é—®é¢˜çš„ç­”æ¡ˆ</p>
        <div class="status-badge"><i class="fas fa-sparkles"></i> ä»Šæ—¥å‰©ä½™ <span class="remaining-count">{{ remaining_divinations }}</span> æ¬¡</div>
      </div>

      <!-- åˆ†ç±»ç­›é€‰ -->
      <div class="category-container">
        <div class="category-filters">
          <button class="category-btn active" onclick="filterCategory('all', event)">å…¨éƒ¨</button>
          <button class="category-btn" onclick="filterCategory('é€šç”¨', event)">é€šç”¨å åœ</button>
          <button class="category-btn" onclick="filterCategory('çˆ±æƒ…', event)">çˆ±æƒ…å…³ç³»</button>
          <button class="category-btn" onclick="filterCategory('äº‹ä¸š', event)">äº‹ä¸šå‘å±•</button>
          <button class="category-btn" onclick="filterCategory('å†³ç­–', event)">å†³ç­–æŒ‡å¼•</button>
          <button class="category-btn" onclick="filterCategory('ä¸ªäººæˆé•¿', event)">ä¸ªäººæˆé•¿</button>
          <button class="category-btn" onclick="filterCategory('è´¢å¯Œ', event)">è´¢å¯Œé‡‘é’±</button>
        </div>
      </div>

      <!-- ç‰Œé˜µç½‘æ ¼ -->
      <div class="spreads-grid" id="spreadsGrid">
        {% for spread in spreads %}
          <div class="spread-card"
               data-category="{{ spread.category }}"
               data-spread-id="{{ spread.id }}"
               data-spread-name="{{ spread.name }}"
               data-card-count="{{ spread.card_count }}"
               onclick="selectSpread('{{ spread.id }}','{{ spread.name }}', {{ spread.card_count }})">
            <div class="card-content">
              <div class="card-header">
                <h3 class="spread-name">{{ spread.name }}</h3>
                <div class="selected-check"><i class="fas fa-check" style="font-size:14px;"></i></div>
              </div>
              <div class="spread-meta">
                <div class="meta-item"><i class="fas fa-layer-group" style="font-size:12px;"></i><span>{{ spread.card_count }}å¼ ç‰Œ</span></div>
                <div class="meta-item"><span class="difficulty-badge {{ spread.difficulty }}">{{ spread.difficulty }}</span></div>
              </div>
              <p class="spread-description">{{ spread.description }}</p>
              <div class="positions-preview">
                {% for position in spread.positions[:4] %}
                  <span class="position-tag">{{ position.name }}</span>
                {% endfor %}
                {% if spread.positions|length > 4 %}
                  <span class="position-tag">+{{ spread.positions|length - 4 }}</span>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- æµ®åŠ¨æ“ä½œé¢æ¿ -->
      <div class="floating-panel" id="floatingPanel">
        <div class="panel-header">
          <div class="panel-title-wrap">
            <div class="panel-icon"><i class="fas fa-layer-group"></i></div>
            <div>
              <h3 class="panel-title" id="selectedSpreadName">é€‰æ‹©çš„ç‰Œé˜µ</h3>
              <div class="panel-subtitle">å‡†å¤‡ä½ çš„é—®é¢˜ä¸è§£è¯»é£æ ¼</div>
            </div>
          </div>
          <button class="close-panel" onclick="closePanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="panel-grid">
          <div class="panel-col panel-left">
            <label class="input-label">ä½ çš„é—®é¢˜ï¼ˆé€‰å¡«ï¼‰</label>
            <input type="text" class="text-input" id="questionInput" placeholder="æè¿°ä½ æƒ³æ¢ç´¢çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæˆ‘å¦‚ä½•æ”¹å–„å½“å‰å…³ç³»ï¼Ÿ" maxlength="200">
            <div class="soft-hint"><i class="fas fa-lightbulb"></i><div>å°æç¤ºï¼šé—®é¢˜è¶Šå…·ä½“ï¼ŒæŒ‡å¼•è¶Šæ¸…æ™°ï¼›è‹¥ä¸€æ—¶æ— ä»ä¸‹æ‰‹ï¼Œä¹Ÿå¯ä»¥å…ˆç•™ç©ºï¼Œä»æ•´ä½“èƒ½é‡å¼€å§‹ã€‚</div></div>
          </div>
          <div class="panel-col panel-right">
            <label class="input-label">é€‰æ‹©è§£è¯»é£æ ¼</label>
            <div class="personality-grid">
              <div class="personality-card selected" data-personality="wisdom" onclick="selectPersonality('wisdom')">
                <div class="personality-emoji">ğŸ“š</div><div class="personality-name">æ™ºæ…§</div><div class="personality-trait">ç†æ€§åˆ†æ</div>
              </div>
              <div class="personality-card" data-personality="mystic" onclick="selectPersonality('mystic')">
                <div class="personality-emoji">ğŸ”®</div><div class="personality-name">ç¥ç§˜</div><div class="personality-trait">æ·±é‚ƒç›´è§‰</div>
              </div>
              <div class="personality-card" data-personality="warm" onclick="selectPersonality('warm')">
                <div class="personality-emoji">ğŸ’</div><div class="personality-name">æ¸©æš–</div><div class="personality-trait">è´´å¿ƒé™ªä¼´</div>
              </div>
            </div>
            <button class="action-button" id="startButton" onclick="startDivination()"><i class="fas fa-sparkles"></i><span> å¼€å§‹å åœ</span></button>
          </div>
        </div>
      </div>
    {% else %}
      <!-- æ— æƒé™ -->
      <div class="empty-state">
        <div class="empty-icon"><i class="fas fa-moon"></i></div>
        <h2 class="empty-title">ä»Šæ—¥å åœæ¬¡æ•°å·²ç”¨å®Œ</h2>
        <p class="empty-desc">æ˜å¤©å†æ¥æ¢ç´¢å¡”ç½—çš„å¥¥ç§˜å§</p>
        <button class="action-button" onclick="window.location.href='{{ url_for('index') }}'">è¿”å›é¦–é¡µ</button>
      </div>
    {% endif %}
  </div>

  <!-- è¦†ç›–å±‚ï¼šå åœå‡†å¤‡ä¸­ -->
  <div class="reading-overlay" id="readingOverlay" aria-hidden="true">
    <div class="reading-card" role="dialog" aria-live="polite" aria-label="æ­£åœ¨å‡†å¤‡å åœ">
      <h3 class="reading-title">æ­£åœ¨ä¸ºä½ è¿æ¥å¡”ç½—èƒ½é‡</h3>
      <div class="reading-sub">æ´—ç‰Œ Â· åˆ‡ç‰Œ Â· å¯¹é½ä½ çš„é—®é¢˜æ„å›¾</div>
      <div class="shuffle" id="shuffleContainer"></div>
      <div class="reading-progress" aria-hidden="true"><div class="reading-bar" id="readingBar"></div></div>
      <div class="reading-hint" id="readingHint">æ­£åœ¨æ´—ç‰Œå¹¶é“¾æ¥ä½ çš„é—®é¢˜â€¦</div>
      <button class="reading-cancel" id="readingCancel" type="button" onclick="cancelOverlay()">å…ˆç­‰ç­‰ï¼Œæˆ‘æƒ³æ”¹ä¸ªé—®é¢˜</button>
    </div>
  </div>

  <script>
    /* ===== iOS è§†å£ä¿®å¤ï¼Œä¿è¯ 100dvh å¯ç”¨ ===== */
    (function fixIOSVh(){
      const setVh=()=>{const vh=window.innerHeight*0.01;document.documentElement.style.setProperty('--vh',`${vh}px`);}
      setVh(); window.addEventListener('resize',setVh); window.addEventListener('orientationchange',setVh);
    })();

    /* ===== åŸæœ‰äº¤äº’é€»è¾‘ï¼šä¸€å­—æœªæ”¹ï¼Œä»…æ ·å¼ç»Ÿä¸€ ===== */
    let selectedSpread=null, selectedSpreadName='', selectedPersonality='wisdom';
    let selectedCardCount=3;
    let overlayTimer=null, overlayProgressTimer=null;
    let overlayStartAt=0;

    const HINT_INTERVAL_MS = 2200;
    const PROGRESS_TICK_MS = 400;
    const PROGRESS_MAX_BEFORE_REDIRECT = 96;
    const TIMEOUT_SOFT_HINT_MS = 45000;
    const REDIRECT_FILL_MS = 500;
    const MIN_OVERLAY_SHOW_MS = 900;

    const hintsBase = [
      'æ­£åœ¨æ´—ç‰Œå¹¶é“¾æ¥ä½ çš„é—®é¢˜â€¦','æŠ½å–ä½ çš„ä¸“å±ç‰Œé¢ä¸­â€¦','åŒæ­¥æœˆç›¸ä¸èƒ½é‡èŠ‚å¾‹â€¦','ç¼–ç»‡è±¡å¾ä¸ç›´è§‰çš„çº¿ç´¢â€¦',
      'æ•´ç†å¯ç¤ºè¯ä¸è¡ŒåŠ¨å»ºè®®â€¦','è†å¬ç‰Œé¢çš„ç»†è¯­ï¼Œç­‰å¾…å®ƒä»¬å¼€å£â€¦','ä¸ºä½ å¯¹é½å½“ä¸‹ä¸æœªæ¥çš„äº¤æ±‡ç‚¹â€¦',
      'æ”¶é›†å…³é”®ç¬¦å·ï¼Œæ‹¼åˆå±äºä½ çš„å›¾æ™¯â€¦','ç¡®è®¤èƒ½é‡æµå‘ï¼Œå®‰æ”¾æœ€æ ¸å¿ƒçš„ä¸»é¢˜â€¦','æ¸©æŸ”åœ°ä¸ºç­”æ¡ˆæ‰«æ¸…é˜»å¡ä¸å™ªå£°â€¦'
    ];
    const hintsByPersona={
      'wisdom':['æå–å…³é”®ä¿¡æ¯ï¼Œæ„å»ºç†æ€§æ¡†æ¶â€¦','æ¢³ç†å› æœä¸çº¿ç´¢ï¼Œå¯»æ‰¾å¯è¡ŒåŠ¨çš„åˆ‡å£â€¦','éªŒè¯ç›´è§‰ä¸ç°å®çš„å¯è¡Œæ€§â€¦','å¯¹é½çŸ­æœŸä¸é•¿æœŸçš„å¹³è¡¡ç‚¹â€¦'],
      'mystic':['è®©ç›´è§‰åœ¨ç‰Œå½±é—´æµåŠ¨â€¦','å‡è§†è±¡å¾ï¼Œå¯»æ±‚æ›´é«˜çš„å›åº”â€¦','å‘¼å”¤æ½œæ„è¯†ä¸­çš„ç­”æ¡ˆâ€¦','è®©çµæ„Ÿä¸å…±æ—¶æ€§è‡ªç„¶æ±‡èšâ€¦'],
      'warm':['ä¸ºä½ æ•´ç†æœ€æ¸©æŸ”çš„æé†’â€¦','æ›¿ä½ å®‰æ”¾é‚£äº›ä¸å®‰ä¸æ‹…å¿ƒâ€¦','æ‹¥æŠ±æ­¤åˆ»ï¼Œå¹¶ç»™å‡ºå¯è½åœ°çš„å…³æ€€â€¦','è®©ç­”æ¡ˆä»¥æ›´æŸ”å’Œçš„æ–¹å¼é è¿‘â€¦']
    };
    function getHintsByPersonality(p){return [...hintsBase, ...(hintsByPersona[p]||[])]}

    function selectSpread(spreadId, spreadName, cardCount){
      document.querySelectorAll('.spread-card').forEach(c=>c.classList.remove('selected'));
      const card=document.querySelector(`[data-spread-id="${spreadId}"]`);
      if(card){
        card.classList.add('selected');
        selectedSpread=spreadId; selectedSpreadName=spreadName;
        const n=parseInt(cardCount||card?.dataset?.cardCount||3,10);
        selectedCardCount=Math.min(Math.max(isNaN(n)?3:n,2),7);
        showPanel();
      }
    }
    function showPanel(){
      const panel=document.getElementById('floatingPanel');
      const nameEl=document.getElementById('selectedSpreadName');
      nameEl.textContent=selectedSpreadName||'é€‰æ‹©çš„ç‰Œé˜µ';
      panel.classList.add('show');
      setTimeout(()=>document.getElementById('questionInput').focus(),220);
    }
    function closePanel(){
      const panel=document.getElementById('floatingPanel');
      panel.classList.remove('show');
      document.querySelectorAll('.spread-card').forEach(c=>c.classList.remove('selected'));
      selectedSpread=null; selectedSpreadName='';
    }
    function selectPersonality(p){
      document.querySelectorAll('.personality-card').forEach(c=>c.classList.remove('selected'));
      const card=document.querySelector(`[data-personality="${p}"]`);
      if(card){ card.classList.add('selected'); selectedPersonality=p; }
    }
    function filterCategory(category, event){
      document.querySelectorAll('.category-btn').forEach(btn=>btn.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.spread-card').forEach(card=>{
        card.style.display=(category==='all'||card.dataset.category===category)?'block':'none';
      });
      closePanel();
    }

    function renderShuffle(n){
      const wrap=document.getElementById('shuffleContainer'); wrap.innerHTML='';
      for(let i=0;i<n;i++){
        const d=document.createElement('div'); d.className='tarot';
        d.style.animationDelay=(i*0.15)+'s';
        const rot=(i%2===0?1:-1)*(3+Math.random()*2);
        const ty=(i%3===0?-1:1)*(1+Math.random()*2);
        d.style.transform=`translateY(${ty}px) rotate(${rot}deg)`;
        wrap.appendChild(d);
      }
    }

    function showOverlay(){
      renderShuffle(selectedCardCount);
      const ov=document.getElementById('readingOverlay');
      const bar=document.getElementById('readingBar');
      const hint=document.getElementById('readingHint');
      ov.style.display='flex'; ov.setAttribute('aria-hidden','false'); overlayStartAt=Date.now();
      const hints=getHintsByPersonality(selectedPersonality); let i=0; hint.textContent=hints[i];
      overlayTimer=setInterval(()=>{i=(i+1)%hints.length;hint.textContent=hints[i];},HINT_INTERVAL_MS);
      let p=0; overlayProgressTimer=setInterval(()=>{
        const remain=PROGRESS_MAX_BEFORE_REDIRECT-p;
        const step=Math.max(1.2,Math.min(6.8,remain*0.12))+(Math.random()*1.4);
        p=Math.min(PROGRESS_MAX_BEFORE_REDIRECT,p+step);
        bar.style.width=p.toFixed(0)+'%';
      },PROGRESS_TICK_MS);
      setTimeout(()=>{ if(ov.style.display==='flex'){ hint.textContent='æœåŠ¡å™¨æœ‰ç‚¹å¿™ï¼Œå†é™ªä½ ç­‰ä¸€ä¸‹ä¸‹â€¦'; }},TIMEOUT_SOFT_HINT_MS);
    }
    function hideOverlay(){
      const ov=document.getElementById('readingOverlay'); const bar=document.getElementById('readingBar');
      ov.style.display='none'; ov.setAttribute('aria-hidden','true');
      clearInterval(overlayTimer); clearInterval(overlayProgressTimer);
      overlayTimer=null; overlayProgressTimer=null; bar.style.width='0%';
    }
    function finalizeOverlayThenRedirect(url){
      const bar=document.getElementById('readingBar'); const hint=document.getElementById('readingHint');
      const elapsed=Date.now()-overlayStartAt; const waitMore=Math.max(0,MIN_OVERLAY_SHOW_MS-elapsed);
      setTimeout(()=>{ bar.style.width='100%'; hint.textContent='å¯ç¤ºå·²å°±ç»ªï¼Œé©¬ä¸Šä¸ºä½ å‘ˆç°â€¦'; setTimeout(()=>{ window.location.href=url; }, REDIRECT_FILL_MS); }, waitMore);
    }
    function cancelOverlay(){
      hideOverlay();
      const button=document.getElementById('startButton');
      button.disabled=false; button.innerHTML='<i class="fas fa-sparkles"></i><span> å¼€å§‹å åœ</span>';
    }

    async function startDivination(){
      if(!selectedSpread) return;
      const button=document.getElementById('startButton');
      const question=document.getElementById('questionInput').value.trim();
      showOverlay(); button.disabled=true; button.innerHTML='<i class="fas fa-spinner fa-spin"></i><span> å‡†å¤‡ä¸­...</span>';
      try{
        const res=await fetch('/api/spread/draw',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({spread_id:selectedSpread,question:question,ai_personality:selectedPersonality})});
        const data=await res.json();
        if(data.success && data.redirect){ finalizeOverlayThenRedirect(data.redirect); }
        else{ hideOverlay(); alert(data.error||'å åœå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'); button.disabled=false; button.innerHTML='<i class="fas fa-sparkles"></i><span> å¼€å§‹å åœ</span>'; }
      }catch(err){
        console.error('Error:',err);
        hideOverlay(); alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        button.disabled=false; button.innerHTML='<i class="fas fa-sparkles"></i><span> å¼€å§‹å åœ</span>';
      }
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
    document.addEventListener('click',function(e){
      const panel=document.getElementById('floatingPanel');
      const inside=panel.contains(e.target)||e.target.closest('.spread-card');
      if(!inside && panel.classList.contains('show')) closePanel();
    });
    // å›è½¦æäº¤
    document.getElementById('questionInput')?.addEventListener('keypress',function(e){
      if(e.key==='Enter' && selectedSpread) startDivination();
    });
  </script>
</body>
</html>
