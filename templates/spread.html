<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>å¡”ç½—ç‰Œé˜µå åœ</title>

        <!-- æœ¬åœ°èµ„æº -->
        <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">

        <style>
        /* =========================
           ä¸»é¢˜å˜é‡ï¼ˆä¸ chat é¡µç»Ÿä¸€ï¼‰
           ========================= */
        :root{
                --primary-color: #8e6c88;   /* ä¸ç»’ç´«ï¼ˆä¸»è‰²ï¼‰ */
                --accent-color:  #6d4c67;   /* æ·±æ¢…ç´«ï¼ˆå¼ºè°ƒï¼‰ */
                --secondary-color:#d1bfa7;  /* é¦™æ§Ÿç±³ï¼ˆè¾…åŠ©ï¼‰ */
                --bg-ivory:      #f8f4e9;   /* è±¡ç‰™æµ…åº• */
                --ink:           #333333;   /* æ·±æ–‡æœ¬ */
                --muted:         #7a707a;   /* æ¬¡æ–‡æœ¬ */

                --card:          #ffffff;
                --border:        rgba(0,0,0,0.08);
                --shadow-sm:     0 4px 16px rgba(30,20,35,0.08);
                --shadow-md:     0 10px 28px rgba(30,20,35,0.12);
                --shadow-lg:     0 16px 44px rgba(30,20,35,0.16);

                --radius-lg: 18px;
                --radius-md: 14px;
                --radius-sm: 10px;
        }

        /* èƒŒæ™¯ï¼šç»†è…»çš„ä¸ç»’æ¸å˜ + å¾®å¾®çº¹ç†æ„Ÿ */
        html,body{ height:100% }
        body{
                margin:0;
                color:var(--ink);
                font-family: ui-sans-serif, -apple-system, "PingFang SC","Microsoft YaHei", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
                -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
                background:
                        radial-gradient(1000px 800px at 10% 0%, #fbf9f3 0%, rgba(251,249,243,0) 60%),
                        radial-gradient(1200px 900px at 90% 10%, #f3ece1 0%, rgba(243,236,225,0) 60%),
                        linear-gradient(135deg, #f8f4e9 0%, #ece4d7 100%);
        }

        /* ============= é¡¶éƒ¨å¯¼èˆª ============= */
        .navbar{
                position:sticky; top:0; z-index:1000;
                background: rgba(255,255,255,0.8);
                backdrop-filter: blur(14px) saturate(140%);
                -webkit-backdrop-filter: blur(14px) saturate(140%);
                border-bottom: 1px solid var(--border);
                box-shadow: var(--shadow-sm);
        }
        .navbar-content{
                max-width:1200px; margin:0 auto; padding:14px 20px;
                display:flex; align-items:center; justify-content:space-between;
        }
        .back-link{
                display:flex; align-items:center; gap:8px;
                color:var(--accent-color); text-decoration:none; font-weight:700;
                transition: color .2s ease, transform .2s ease;
        }
        .back-link:hover{ color:var(--primary-color); transform: translateX(-2px); }

        .user-info{ display:flex; align-items:center; gap:12px; color:var(--muted) }
        .user-avatar{
                width:34px; height:34px; border-radius:50%;
                display:flex; align-items:center; justify-content:center;
                background: linear-gradient(145deg, var(--primary-color), var(--accent-color));
                color:#fff; font-weight:800; box-shadow: var(--shadow-sm);
        }

        /* ============= ä¸»å®¹å™¨ ============= */
        .main-container{ max-width:1200px; margin:0 auto; padding:40px 20px 120px; }

        /* ============= å¤´éƒ¨åŒºå— ============= */
        .header-section{ text-align:center; margin-bottom:28px; }
        .page-title{
                margin:0 0 10px; font-size:32px; font-weight:900; letter-spacing:-.3px;
                color:var(--accent-color);
        }
        .page-subtitle{ margin:0 0 16px; font-size:18px; color:var(--muted); }
        .status-badge{
                display:inline-flex; align-items:center; gap:8px;
                background: #fff; border:1px solid var(--border); border-radius:999px;
                padding:8px 14px; color:var(--accent-color); font-weight:700;
                box-shadow: var(--shadow-sm);
        }
        .remaining-count{ color:var(--primary-color); }

        /* ============= åˆ†ç±»ç­›é€‰ ============= */
        .category-container{ margin:22px 0 26px; overflow-x:auto; scrollbar-width:none; -ms-overflow-style:none; }
        .category-container::-webkit-scrollbar{ display:none; }
        .category-filters{ display:flex; gap:12px; min-width:max-content; }

        .category-btn{
                flex-shrink:0;
                padding:10px 18px; border-radius:999px; font-weight:700; letter-spacing:.2px;
                color:#1d1d1f; background:#fff; border:1px solid var(--border);
                box-shadow: var(--shadow-sm);
                transition: all .2s ease;
        }
        .category-btn:hover{ transform: translateY(-2px); background: #fafafa; }
        .category-btn.active{
                color:#fff; border-color:transparent;
                background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                box-shadow: 0 10px 28px rgba(110, 80, 100, .25);
        }

        /* ============= ç‰Œé˜µç½‘æ ¼ä¸å¡ç‰‡ ============= */
        .spreads-grid{
                display:grid; gap:20px;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }

        .spread-card{
                position:relative; overflow:hidden; cursor:pointer;
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-sm);
                transition: transform .24s cubic-bezier(.22,.61,.36,1), box-shadow .24s;
        }
        .spread-card:hover{ transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .spread-card.selected{
                box-shadow: 0 0 0 4px rgba(142,108,136,0.12), var(--shadow-md);
                border-color: transparent;
        }

        .card-content{ padding:20px; }
        .card-header{
                display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:10px;
        }
        .spread-name{ margin:0; font-size:20px; font-weight:900; color:#1d1d1f; letter-spacing:-.2px; }
        .selected-check{
                width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center;
                color:#fff; background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                box-shadow: 0 6px 14px rgba(110, 80, 100, .25);
                opacity:0; transform: scale(0); transition: all .2s;
        }
        .spread-card.selected .selected-check{ opacity:1; transform: scale(1); }

        .spread-meta{ display:flex; gap:16px; color:var(--muted); font-size:13px; margin-bottom:10px; }
        .meta-item{ display:flex; gap:6px; align-items:center; }

        .difficulty-badge{
                padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; letter-spacing:.4px; text-transform:uppercase;
                background: #fafafa; border:1px solid var(--border);
        }
        .difficulty-badge.ç®€å•{ background:rgba(52,199,89,.14); color:#1f8a50 }
        .difficulty-badge.ä¸­ç­‰{ background:rgba(255,149,0,.14); color:#a35d00 }
        .difficulty-badge.å¤æ‚{ background:rgba(90,200,250,.14); color:#0661a3 }

        .spread-description{ color:#4a3f4a; font-size:15px; line-height:1.6; margin:10px 0 14px; }
        .positions-preview{ display:flex; flex-wrap:wrap; gap:6px; }
        .position-tag{
                background:#faf7f2; border:1px solid var(--border);
                padding:4px 10px; border-radius:999px; font-size:12px; color:#2f2a33;
        }

        /* ===== æµ®åŠ¨æ“ä½œé¢æ¿ï¼ˆä¸¤åˆ—ç²¾è‡´å¸ƒå±€ï¼‰ ===== */
        .floating-panel{
                position: fixed;
                left: 50%;
                bottom: 20px;
                transform: translateX(-50%);
                width: calc(100% - 40px);
                max-width: 800px;
                background: rgba(255,255,255,0.92);
                backdrop-filter: blur(14px) saturate(140%);
                -webkit-backdrop-filter: blur(14px) saturate(140%);
                border: 1px solid var(--border);
                border-radius: 20px;
                padding: 18px 18px 16px;
                box-shadow: var(--shadow-lg);
                opacity: 0;
                visibility: hidden;
                transition: all .28s cubic-bezier(.22,.61,.36,1);
                max-height: calc(100vh - 40px);
                overflow: auto;
        }
        .floating-panel.show{ opacity: 1; visibility: visible; }

        .panel-header{
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 4px 4px 10px;
                border-bottom: 1px solid var(--border);
                margin-bottom: 12px;
        }
        .panel-title-wrap{ display: flex; align-items: center; gap: 12px; }
        .panel-icon{
                width: 34px;
                height: 34px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                box-shadow: var(--shadow-sm);
        }
        .panel-title{
                margin: 0;
                font-size: 18px;
                font-weight: 900;
                color: #1d1d1f;
                letter-spacing: -.2px;
        }
        .panel-subtitle{ font-size: 12px; color: var(--muted); margin-top: 2px; }
        .close-panel{
                width: 30px; height: 30px; border: none; border-radius: 50%;
                background: #fff; color: var(--muted); cursor: pointer;
                display: flex; align-items: center; justify-content: center;
                transition: background .2s, transform .2s; box-shadow: var(--shadow-sm);
        }
        .close-panel:hover{ background: #f2f2f2; transform: rotate(6deg); }

        .panel-grid{
                display: grid;
                grid-template-columns: 1.2fr 1fr;
                gap: 16px;
        }
        .panel-col{ display: flex; flex-direction: column; gap: 12px; }

        .input-group{ margin: 0; }
        .input-label{ display: block; color: var(--muted); font-size: 13px; }
        .text-input{
                width: 100%; padding: 12px 14px; border-radius: 12px;
                border: 1px solid var(--border); background: #fafafa;
                font-size: 16px; transition: all .2s;
        }
        .text-input:focus{
                outline: none; background: #fff;
                box-shadow: 0 0 0 4px rgba(142,108,136,0.10);
        }
        .soft-hint{
                display: flex; align-items: flex-start; gap: 8px;
                font-size: 12px; color: var(--muted);
                background: #fff; border: 1px solid var(--border);
                border-radius: 12px; padding: 10px 12px;
        }
        .soft-hint i{ color: var(--primary-color); margin-top: 2px; }

        /* äººæ ¼é€‰æ‹©ï¼šä¸‰åˆ—ç­‰åˆ† + ç­‰é«˜å¡ç‰‡ */
        .personality-grid{
                display: grid;
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 12px;
                align-items: stretch;
                justify-items: stretch;
        }
        .personality-card{
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                text-align: center;
                padding: 16px 12px;
                border: 1px solid var(--border); border-radius: 14px;
                background: #fff; box-shadow: var(--shadow-sm);
                transition: transform .2s, box-shadow .2s, border-color .2s;
                height: 100%;
        }
        .personality-card:hover{ transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .personality-card.selected{
                border-color: transparent;
                background: linear-gradient(180deg, #fff, #fdf8f2);
                box-shadow: 0 0 0 4px rgba(142,108,136,0.12), var(--shadow-md);
        }
        .personality-emoji{ font-size: 26px; margin-bottom: 6px; }
        .personality-name{ font-size: 15px; font-weight: 900; color: var(--accent-color); margin-bottom: 4px; }
        .personality-trait{ font-size: 12px; color: var(--muted); }

        /* å³åˆ—æŒ‰é’®è´´åº•æ’ */
        .panel-right{
                display: grid;
                grid-template-rows: auto 1fr auto; /* æ ‡ç­¾ + äººæ ¼ç½‘æ ¼ + æŒ‰é’® */
                gap: 10px;
        }
        .panel-right .action-button{ width: 100%; margin-top: 4px; }

        /* è¡ŒåŠ¨æŒ‰é’®ï¼ˆç»Ÿä¸€æ ·å¼ï¼‰ */
        .action-button{
                width:100%; padding:14px 28px; border:none; border-radius:14px;
                color:#fff; font-weight:900; letter-spacing:.3px; font-size:16px;
                display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;
                background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                box-shadow: var(--shadow-md);
                transition: transform .24s, box-shadow .24s;
        }
        .action-button:hover:not(:disabled){ transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .action-button:disabled{ opacity:.55; cursor:not-allowed; }

        /* ============= ç©ºçŠ¶æ€ ============= */
        .empty-state{ text-align:center; padding:80px 20px; }
        .empty-icon{ font-size:48px; color:#c7c7cc; margin-bottom:20px; }
        .empty-title{ font-size:22px; font-weight:900; color:#1d1d1f; margin-bottom:8px; }
        .empty-desc{ font-size:17px; color:var(--muted); margin-bottom:24px; }

        /* ============= å“åº”å¼ ============= */
        @media (max-width:992px){
                .spreads-grid{ grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); }
                .panel-grid{ grid-template-columns: 1fr 1fr; }
        }
        @media (max-width:768px){
                .page-title{ font-size:28px; }
        }
        @media (max-width:640px){
                .floating-panel{ max-width: 600px; }
                .panel-grid{ grid-template-columns: 1fr; }
        }

        /* å°Šé‡ç³»ç»Ÿâ€œå‡å°‘åŠ¨æ€â€è®¾ç½® */
        @media (prefers-reduced-motion: reduce){
                .spread-card, .category-btn, .action-button, .personality-card, .floating-panel { transition: none !important; }
        }
        </style>
</head>
<body>

        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="navbar">
                <div class="navbar-content">
                        <a href="{{ url_for('index') }}" class="back-link"><i class="fas fa-chevron-left"></i><span>è¿”å›</span></a>
                        <div class="user-info">
                                <span>{{ user.username if not user.is_guest else "è®¿å®¢" }}</span>
                                <div class="user-avatar">
                                        {% if not user.is_guest %} {{ user.username[0]|upper }} {% else %}<i class="fas fa-user" style="font-size:16px;"></i>{% endif %}
                                </div>
                        </div>
                </div>
        </nav>

        <!-- ä¸»å®¹å™¨ -->
        <div class="main-container">
                {% if can_divine %}
                        <!-- æ ‡é¢˜ -->
                        <div class="header-section">
                                <h1 class="page-title">å¡”ç½—ç‰Œé˜µå åœ</h1>
                                <p class="page-subtitle">é€‰æ‹©é€‚åˆä½ çš„ç‰Œé˜µï¼Œæ·±å…¥æ¢ç´¢é—®é¢˜çš„ç­”æ¡ˆ</p>
                                <div class="status-badge">
                                        <i class="fas fa-sparkles"></i> ä»Šæ—¥å‰©ä½™ <span class="remaining-count">{{ remaining_divinations }}</span> æ¬¡
                                </div>
                        </div>

                        <!-- åˆ†ç±»ç­›é€‰ -->
                        <div class="category-container">
                                <div class="category-filters">
                                        <button class="category-btn active" onclick="filterCategory('all', event)">å…¨éƒ¨</button>
                                        <button class="category-btn" onclick="filterCategory('é€šç”¨', event)">é€šç”¨å åœ</button>
                                        <button class="category-btn" onclick="filterCategory('çˆ±æƒ…', event)">çˆ±æƒ…å…³ç³»</button>
                                        <button class="category-btn" onclick="filterCategory('äº‹ä¸š', event)">äº‹ä¸šå‘å±•</button>
                                        <button class="category-btn" onclick="filterCategory('å†³ç­–', event)">å†³ç­–æŒ‡å¼•</button>
                                        <button class="category-btn" onclick="filterCategory('ä¸ªäººæˆé•¿', event)">ä¸ªäººæˆé•¿</button>
                                        <button class="category-btn" onclick="filterCategory('è´¢å¯Œ', event)">è´¢å¯Œé‡‘é’±</button>
                                </div>
                        </div>

                        <!-- ç‰Œé˜µç½‘æ ¼ -->
                        <div class="spreads-grid" id="spreadsGrid">
                                {% for spread in spreads %}
                                <div class="spread-card"
                                     data-category="{{ spread.category }}"
                                     data-spread-id="{{ spread.id }}"
                                     data-spread-name="{{ spread.name }}"
                                     onclick="selectSpread('{{ spread.id }}','{{ spread.name }}')">
                                        <div class="card-content">
                                                <div class="card-header">
                                                        <h3 class="spread-name">{{ spread.name }}</h3>
                                                        <div class="selected-check"><i class="fas fa-check" style="font-size:14px;"></i></div>
                                                </div>
                                                <div class="spread-meta">
                                                        <div class="meta-item"><i class="fas fa-layer-group" style="font-size:12px;"></i><span>{{ spread.card_count }}å¼ ç‰Œ</span></div>
                                                        <div class="meta-item"><span class="difficulty-badge {{ spread.difficulty }}">{{ spread.difficulty }}</span></div>
                                                </div>
                                                <p class="spread-description">{{ spread.description }}</p>
                                                <div class="positions-preview">
                                                        {% for position in spread.positions[:4] %}
                                                        <span class="position-tag">{{ position.name }}</span>
                                                        {% endfor %}
                                                        {% if spread.positions|length > 4 %}
                                                        <span class="position-tag">+{{ spread.positions|length - 4 }}</span>
                                                        {% endif %}
                                                </div>
                                        </div>
                                </div>
                                {% endfor %}
                        </div>

                        <!-- æµ®åŠ¨æ“ä½œé¢æ¿ï¼ˆä¸¤åˆ—ç²¾è‡´å¸ƒå±€ï¼‰ -->
                        <div class="floating-panel" id="floatingPanel">
                                <div class="panel-header">
                                        <div class="panel-title-wrap">
                                                <div class="panel-icon"><i class="fas fa-layer-group"></i></div>
                                                <div>
                                                        <h3 class="panel-title" id="selectedSpreadName">é€‰æ‹©çš„ç‰Œé˜µ</h3>
                                                        <div class="panel-subtitle">å‡†å¤‡ä½ çš„é—®é¢˜ä¸è§£è¯»é£æ ¼</div>
                                                </div>
                                        </div>
                                        <button class="close-panel" onclick="closePanel()">
                                                <i class="fas fa-times"></i>
                                        </button>
                                </div>

                                <div class="panel-grid">
                                        <!-- å·¦åˆ—ï¼šé—®é¢˜è¾“å…¥ + æç¤º -->
                                        <div class="panel-col panel-left">
                                                <div class="input-group">
                                                        <label class="input-label">ä½ çš„é—®é¢˜ï¼ˆé€‰å¡«ï¼‰</label>
                                                        <input type="text"
                                                               class="text-input"
                                                               id="questionInput"
                                                               placeholder="æè¿°ä½ æƒ³æ¢ç´¢çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæˆ‘å¦‚ä½•æ”¹å–„å½“å‰å…³ç³»ï¼Ÿ"
                                                               maxlength="200">
                                                </div>
                                                <div class="soft-hint">
                                                        <i class="fas fa-lightbulb"></i>
                                                        <div>å°æç¤ºï¼šé—®é¢˜è¶Šå…·ä½“ï¼ŒæŒ‡å¼•è¶Šæ¸…æ™°ï¼›è‹¥ä¸€æ—¶æ— ä»ä¸‹æ‰‹ï¼Œä¹Ÿå¯ä»¥å…ˆç•™ç©ºï¼Œä»æ•´ä½“èƒ½é‡å¼€å§‹ã€‚</div>
                                                </div>
                                        </div>

                                        <!-- å³åˆ—ï¼šäººæ ¼é€‰æ‹© + æŒ‰é’® -->
                                        <div class="panel-col panel-right">
                                                <label class="input-label">é€‰æ‹©è§£è¯»é£æ ¼</label>
                                                <div class="personality-grid">
                                                        <div class="personality-card selected"
                                                             data-personality="wisdom"
                                                             onclick="selectPersonality('wisdom')">
                                                                <div class="personality-emoji">ğŸ“š</div>
                                                                <div class="personality-name">æ™ºæ…§</div>
                                                                <div class="personality-trait">ç†æ€§åˆ†æ</div>
                                                        </div>
                                                        <div class="personality-card"
                                                             data-personality="mystic"
                                                             onclick="selectPersonality('mystic')">
                                                                <div class="personality-emoji">ğŸ”®</div>
                                                                <div class="personality-name">ç¥ç§˜</div>
                                                                <div class="personality-trait">æ·±é‚ƒç›´è§‰</div>
                                                        </div>
                                                        <div class="personality-card"
                                                             data-personality="warm"
                                                             onclick="selectPersonality('warm')">
                                                                <div class="personality-emoji">ğŸ’</div>
                                                                <div class="personality-name">æ¸©æš–</div>
                                                                <div class="personality-trait">è´´å¿ƒé™ªä¼´</div>
                                                        </div>
                                                </div>

                                                <button class="action-button" id="startButton" onclick="startDivination()">
                                                        <i class="fas fa-sparkles"></i><span> å¼€å§‹å åœ</span>
                                                </button>
                                        </div>
                                </div>
                        </div>
                {% else %}
                        <!-- æ— æƒé™ -->
                        <div class="empty-state">
                                <div class="empty-icon"><i class="fas fa-moon"></i></div>
                                <h2 class="empty-title">ä»Šæ—¥å åœæ¬¡æ•°å·²ç”¨å®Œ</h2>
                                <p class="empty-desc">æ˜å¤©å†æ¥æ¢ç´¢å¡”ç½—çš„å¥¥ç§˜å§</p>
                                <button class="action-button" onclick="window.location.href='{{ url_for('index') }}'">è¿”å›é¦–é¡µ</button>
                        </div>
                {% endif %}
        </div>

        <script>
        let selectedSpread=null, selectedSpreadName='', selectedPersonality='wisdom';

        function selectSpread(spreadId, spreadName){
                document.querySelectorAll('.spread-card').forEach(c=>c.classList.remove('selected'));
                const card=document.querySelector(`[data-spread-id="${spreadId}"]`);
                if(card){
                        card.classList.add('selected');
                        selectedSpread=spreadId; selectedSpreadName=spreadName;
                        showPanel();
                }
        }
        function showPanel(){
                const panel=document.getElementById('floatingPanel');
                const nameEl=document.getElementById('selectedSpreadName');
                nameEl.textContent=selectedSpreadName||'é€‰æ‹©çš„ç‰Œé˜µ';
                panel.classList.add('show');
                setTimeout(()=>document.getElementById('questionInput').focus(),220);
        }
        function closePanel(){
                const panel=document.getElementById('floatingPanel');
                panel.classList.remove('show');
                document.querySelectorAll('.spread-card').forEach(c=>c.classList.remove('selected'));
                selectedSpread=null; selectedSpreadName='';
        }
        function selectPersonality(p){
                document.querySelectorAll('.personality-card').forEach(c=>c.classList.remove('selected'));
                const card=document.querySelector(`[data-personality="${p}"]`);
                if(card){ card.classList.add('selected'); selectedPersonality=p; }
        }
        function filterCategory(category, event){
                document.querySelectorAll('.category-btn').forEach(btn=>btn.classList.remove('active'));
                event.target.classList.add('active');
                document.querySelectorAll('.spread-card').forEach(card=>{
                        card.style.display = (category==='all' || card.dataset.category===category) ? 'block' : 'none';
                });
                closePanel();
        }
        async function startDivination(){
                if(!selectedSpread) return;
                const button=document.getElementById('startButton');
                const question=document.getElementById('questionInput').value.trim();
                button.disabled=true;
                button.innerHTML='<i class="fas fa-spinner fa-spin"></i><span> å‡†å¤‡ä¸­...</span>';
                try{
                        const res=await fetch('/api/spread/draw',{
                                method:'POST',
                                headers:{'Content-Type':'application/json'},
                                body:JSON.stringify({ spread_id:selectedSpread, question:question, ai_personality:selectedPersonality })
                        });
                        const data=await res.json();
                        if(data.success){ window.location.href=data.redirect; }
                        else{
                                alert(data.error||'å åœå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                                button.disabled=false;
                                button.innerHTML='<i class="fas fa-sparkles"></i><span> å¼€å§‹å åœ</span>';
                        }
                }catch(err){
                        console.error('Error:',err);
                        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                        button.disabled=false;
                        button.innerHTML='<i class="fas fa-sparkles"></i><span> å¼€å§‹å åœ</span>';
                }
        }
        document.addEventListener('click',function(e){
                const panel=document.getElementById('floatingPanel');
                const inside = panel.contains(e.target) || e.target.closest('.spread-card');
                if(!inside && panel.classList.contains('show')) closePanel();
        });
        document.getElementById('questionInput')?.addEventListener('keypress',function(e){
                if(e.key==='Enter' && selectedSpread) startDivination();
        });
        </script>
</body>
</html>
