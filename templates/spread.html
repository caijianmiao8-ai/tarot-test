<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡”ç½—ç‰Œé˜µå åœ</title>

    <!-- æœ¬åœ°åŒ–èµ„æº -->
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">

    <style>
        :root{
            /* ä¸ spread chat ä¸€è‡´çš„ä¸»é¢˜è‰²ç³» */
            --primary-color:#8e6c88;      /* ä¸»é¢˜ç´« */
            --secondary-color:#d1bfa7;    /* è¾…åŠ©ç±³è‰² */
            --accent-color:#6d4c67;       /* æ·±ç´«ç‚¹ç¼€ */
            --light-color:#f8f4e9;        /* æµ…èƒŒæ™¯ */
            --bg-grad-start:#f8f4e9;
            --bg-grad-end:#e8e0d1;
            --dark-color:#333333;
            --muted:#86868b;

            --card-bg:#ffffff;
            --border-color:rgba(0,0,0,0.08);
            --shadow-sm:0 2px 8px rgba(0,0,0,0.06);
            --shadow-md:0 6px 20px rgba(0,0,0,0.1);
            --shadow-lg:0 12px 32px rgba(0,0,0,0.12);

            --success-color:#34c759;
            --warning-color:#ff9500;
            --info-color:#5ac8fa;
        }

        *{ box-sizing:border-box; }
        body{
            margin:0;
            color:var(--dark-color);
            font-family:'Segoe UI','PingFang SC','Microsoft YaHei',system-ui,-apple-system,Roboto,Helvetica,Arial,sans-serif;
            background:linear-gradient(135deg,var(--bg-grad-start) 0%,var(--bg-grad-end) 100%);
            -webkit-font-smoothing:antialiased;
        }

        /* ===== é¡¶éƒ¨å¯¼èˆª ===== */
        .navbar{
            background:#fff;
            border-bottom:1px solid var(--border-color);
            box-shadow:0 2px 10px rgba(0,0,0,0.06);
            position:sticky;top:0;z-index:1000;
        }
        .navbar-content{
            max-width:1200px;margin:0 auto;
            padding:14px 20px;
            display:flex;justify-content:space-between;align-items:center;
        }
        .back-link{
            display:flex;align-items:center;gap:8px;
            color:var(--accent-color);text-decoration:none;font-weight:600;
            transition:color .2s,transform .2s;
        }
        .back-link:hover{ color:var(--primary-color); transform:translateX(-2px); }

        .user-info{ display:flex;align-items:center;gap:12px;color:#1d1d1f;font-size:15px; }
        .user-avatar{
            width:32px;height:32px;border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
            color:#fff;font-weight:700;font-size:14px;
        }

        /* ===== ä¸»å®¹å™¨ ===== */
        .main-container{ max-width:1200px;margin:0 auto;padding:40px 20px 120px; }

        /* ===== æ ‡é¢˜åŒº ===== */
        .header-section{ text-align:center;margin-bottom:36px; }
        .page-title{ margin:0 0 8px;font-size:32px;font-weight:800;color:var(--accent-color);letter-spacing:-.3px; }
        .page-subtitle{ margin:0 0 18px;font-size:18px;color:var(--muted); }
        .status-badge{
            display:inline-flex;align-items:center;gap:8px;
            padding:8px 16px;border-radius:999px;
            background:var(--light-color); color:var(--accent-color);
            border:1px solid var(--border-color); box-shadow:var(--shadow-sm); font-weight:600;
        }
        .remaining-count{ color:var(--primary-color); }

        /* ===== åˆ†ç±»ç­›é€‰ï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰ ===== */
        .category-container{ margin:24px 0 28px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
        .category-container::-webkit-scrollbar{ display:none; }
        .category-filters{ display:flex;gap:12px;min-width:max-content; }
        .category-btn{
            flex-shrink:0; padding:8px 18px;border-radius:999px;
            background:#fff;border:1px solid var(--border-color); box-shadow:var(--shadow-sm);
            font-size:14px;font-weight:600;color:#1d1d1f; cursor:pointer; transition:all .2s;
        }
        .category-btn:hover{ background:#f5f5f7; }
        .category-btn.active{ background:var(--primary-color); color:#fff; border-color:transparent; }

        /* ===== ç‰Œé˜µç½‘æ ¼ ===== */
        .spreads-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:20px; }
        .spread-card{
            background:var(--card-bg); border-radius:16px; overflow:hidden; position:relative;
            border:2px solid transparent; box-shadow:var(--shadow-sm);
            transition:transform .25s cubic-bezier(.25,.46,.45,.94), box-shadow .25s, border-color .2s;
            cursor:pointer;
        }
        .spread-card:hover{ transform:translateY(-4px); box-shadow:var(--shadow-md); }
        .spread-card.selected{ border-color:var(--primary-color); box-shadow:0 0 0 4px rgba(142,108,136,.10); }

        .card-content{ padding:20px; }
        .card-header{ display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px; }
        .spread-name{ margin:0;font-size:20px;font-weight:800;color:#1d1d1f;letter-spacing:-.2px; }
        .selected-check{
            width:24px;height:24px;border-radius:50%;
            background:var(--primary-color); color:#fff;
            display:flex;align-items:center;justify-content:center;
            opacity:0; transform:scale(0); transition:all .2s;
        }
        .spread-card.selected .selected-check{ opacity:1; transform:scale(1); }

        .spread-meta{ display:flex;gap:16px;color:var(--muted);font-size:13px;margin-bottom:10px; }
        .meta-item{ display:flex;align-items:center;gap:6px; }
        .difficulty-badge{
            padding:2px 8px;border-radius:999px;font-size:11px;font-weight:800;letter-spacing:.4px;text-transform:uppercase;
        }
        .difficulty-badge.ç®€å•{ background:rgba(52,199,89,.14); color:var(--success-color); }
        .difficulty-badge.ä¸­ç­‰{ background:rgba(255,149,0,.14); color:var(--warning-color); }
        .difficulty-badge.å¤æ‚{ background:rgba(90,200,250,.14); color:var(--info-color); }

        .spread-description{ font-size:15px;line-height:1.55;color:#3a3a3c;margin:10px 0 14px; }
        .positions-preview{ display:flex;flex-wrap:wrap;gap:6px; }
        .position-tag{ background:#f5f5f7; padding:4px 10px; border-radius:999px; font-size:13px; color:#1d1d1f; }

        /* ===== æµ®åŠ¨æ“ä½œé¢æ¿ ===== */
        .floating-panel{
            position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
            width:calc(100% - 40px); max-width:680px;
            background:rgba(255,255,255,.96);
            backdrop-filter:saturate(180%) blur(16px); -webkit-backdrop-filter:saturate(180%) blur(16px);
            border:1px solid var(--border-color); border-radius:20px; box-shadow:var(--shadow-lg);
            padding:20px; opacity:0; visibility:hidden; transition:all .3s cubic-bezier(.25,.46,.45,.94);
        }
        .floating-panel.show{ opacity:1; visibility:visible; }
        .panel-header{ display:flex;justify-content:space-between;align-items:center;margin-bottom:16px; }
        .panel-title{ margin:0;font-size:18px;font-weight:800;color:#1d1d1f; }
        .close-panel{
            width:28px;height:28px;border:none;border-radius:50%;
            background:#f5f5f7;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;
            transition:background .2s;
        }
        .close-panel:hover{ background:#e9e9ee; }

        .input-group{ margin-bottom:18px; }
        .input-label{ display:block;color:var(--muted);font-size:13px;margin-bottom:8px; }
        .text-input{
            width:100%;padding:12px 14px;border-radius:12px;
            background:#f5f5f7;border:1px solid transparent;font-size:16px;transition:all .2s;-webkit-appearance:none;
        }
        .text-input:focus{ outline:none;background:#fff;border-color:var(--primary-color); box-shadow:0 0 0 4px rgba(142,108,136,.08); }

        /* ===== äººæ ¼é€‰æ‹©ï¼ˆé‡ç‚¹ä¼˜åŒ–ï¼‰ ===== */
        .personality-grid{
            display:flex;justify-content:center;gap:16px;flex-wrap:wrap;margin:6px 0 18px;
        }
        .personality-card{
            flex:1 1 160px; max-width:210px;
            background:#fff; border:2px solid transparent; border-radius:16px; padding:16px 14px;
            display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
            cursor:pointer; transition:all .22s ease; box-shadow:var(--shadow-sm);
        }
        .personality-card:hover{ transform:translateY(-3px); box-shadow:var(--shadow-md); }
        .personality-card.selected{
            border-color:var(--primary-color); background:var(--light-color);
            box-shadow:0 0 0 4px rgba(142,108,136,.10);
        }
        .personality-emoji{ font-size:28px;margin-bottom:8px; }
        .personality-name{ font-size:15px;font-weight:800;color:var(--accent-color);margin-bottom:4px;letter-spacing:.2px; }
        .personality-trait{ font-size:12px;color:var(--muted); }

        /* ===== ä¸»æ“ä½œæŒ‰é’® ===== */
        .action-button{
            width:100%; padding:14px 28px; border:none; border-radius:12px;
            background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
            color:#fff; font-weight:800; font-size:16px; letter-spacing:.3px;
            display:flex; align-items:center; justify-content:center; gap:8px;
            cursor:pointer; transition:transform .25s, box-shadow .25s; box-shadow:var(--shadow-md);
        }
        .action-button:hover:not(:disabled){ transform:translateY(-2px); box-shadow:var(--shadow-lg); }
        .action-button:disabled{ opacity:.55; cursor:not-allowed; }

        /* ===== ç©ºçŠ¶æ€ ===== */
        .empty-state{ text-align:center; padding:80px 20px; }
        .empty-icon{ font-size:48px; color:#c7c7cc; margin-bottom:20px; }
        .empty-title{ font-size:22px; font-weight:800; color:#1d1d1f; margin-bottom:8px; }
        .empty-desc{ font-size:17px; color:var(--muted); margin-bottom:24px; }

        /* ===== å“åº”å¼ ===== */
        @media (max-width: 992px){
            .spreads-grid{ grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); }
        }
        @media (max-width: 768px){
            .page-title{ font-size:26px; }
            .personality-card{ flex:1 1 calc(50% - 10px); max-width:none; padding:14px 12px; }
            .personality-emoji{ font-size:24px;margin-bottom:6px; }
            .panel-title{ font-size:16px; }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="{{ url_for('index') }}" class="back-link">
                <i class="fas fa-chevron-left"></i><span>è¿”å›</span>
            </a>
            <div class="user-info">
                <span>{{ user.username if not user.is_guest else "è®¿å®¢" }}</span>
                <div class="user-avatar">
                    {% if not user.is_guest %} {{ user.username[0]|upper }} {% else %}<i class="fas fa-user" style="font-size:16px;"></i>{% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        {% if can_divine %}
            <!-- æ ‡é¢˜ -->
            <div class="header-section">
                <h1 class="page-title">å¡”ç½—ç‰Œé˜µå åœ</h1>
                <p class="page-subtitle">é€‰æ‹©é€‚åˆä½ çš„ç‰Œé˜µï¼Œæ·±å…¥æ¢ç´¢é—®é¢˜çš„ç­”æ¡ˆ</p>
                <div class="status-badge">
                    <i class="fas fa-sparkles"></i>
                    ä»Šæ—¥å‰©ä½™ <span class="remaining-count">{{ remaining_divinations }}</span> æ¬¡
                </div>
            </div>

            <!-- åˆ†ç±»ç­›é€‰ -->
            <div class="category-container">
                <div class="category-filters">
                    <button class="category-btn active" onclick="filterCategory('all', event)">å…¨éƒ¨</button>
                    <button class="category-btn" onclick="filterCategory('é€šç”¨', event)">é€šç”¨å åœ</button>
                    <button class="category-btn" onclick="filterCategory('çˆ±æƒ…', event)">çˆ±æƒ…å…³ç³»</button>
                    <button class="category-btn" onclick="filterCategory('äº‹ä¸š', event)">äº‹ä¸šå‘å±•</button>
                    <button class="category-btn" onclick="filterCategory('å†³ç­–', event)">å†³ç­–æŒ‡å¼•</button>
                    <button class="category-btn" onclick="filterCategory('ä¸ªäººæˆé•¿', event)">ä¸ªäººæˆé•¿</button>
                    <button class="category-btn" onclick="filterCategory('è´¢å¯Œ', event)">è´¢å¯Œé‡‘é’±</button>
                </div>
            </div>

            <!-- ç‰Œé˜µç½‘æ ¼ -->
            <div class="spreads-grid" id="spreadsGrid">
                {% for spread in spreads %}
                <div class="spread-card"
                     data-category="{{ spread.category }}"
                     data-spread-id="{{ spread.id }}"
                     data-spread-name="{{ spread.name }}"
                     onclick="selectSpread('{{ spread.id }}','{{ spread.name }}')">
                    <div class="card-content">
                        <div class="card-header">
                            <h3 class="spread-name">{{ spread.name }}</h3>
                            <div class="selected-check"><i class="fas fa-check" style="font-size:14px;"></i></div>
                        </div>
                        <div class="spread-meta">
                            <div class="meta-item">
                                <i class="fas fa-layer-group" style="font-size:12px;"></i>
                                <span>{{ spread.card_count }}å¼ ç‰Œ</span>
                            </div>
                            <div class="meta-item">
                                <span class="difficulty-badge {{ spread.difficulty }}">{{ spread.difficulty }}</span>
                            </div>
                        </div>
                        <p class="spread-description">{{ spread.description }}</p>
                        <div class="positions-preview">
                            {% for position in spread.positions[:4] %}
                            <span class="position-tag">{{ position.name }}</span>
                            {% endfor %}
                            {% if spread.positions|length > 4 %}
                            <span class="position-tag">+{{ spread.positions|length - 4 }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- æµ®åŠ¨æ“ä½œé¢æ¿ -->
            <div class="floating-panel" id="floatingPanel">
                <div class="panel-header">
                    <h3 class="panel-title" id="selectedSpreadName">é€‰æ‹©çš„ç‰Œé˜µ</h3>
                    <button class="close-panel" onclick="closePanel()"><i class="fas fa-times"></i></button>
                </div>

                <!-- é—®é¢˜è¾“å…¥ -->
                <div class="input-group">
                    <label class="input-label">ä½ çš„é—®é¢˜ï¼ˆé€‰å¡«ï¼‰</label>
                    <input type="text" class="text-input" id="questionInput" placeholder="æè¿°ä½ æƒ³æ¢ç´¢çš„é—®é¢˜..." maxlength="200">
                </div>

                <!-- äººæ ¼é€‰æ‹©ï¼ˆç¾åŒ–åï¼‰ -->
                <div class="input-group">
                    <label class="input-label">é€‰æ‹©è§£è¯»é£æ ¼</label>
                    <div class="personality-grid">
                        <div class="personality-card selected" data-personality="wisdom" onclick="selectPersonality('wisdom')">
                            <div class="personality-emoji">ğŸ“š</div>
                            <div class="personality-name">æ™ºæ…§</div>
                            <div class="personality-trait">ç†æ€§åˆ†æ</div>
                        </div>
                        <div class="personality-card" data-personality="mystic" onclick="selectPersonality('mystic')">
                            <div class="personality-emoji">ğŸ”®</div>
                            <div class="personality-name">ç¥ç§˜</div>
                            <div class="personality-trait">æ·±é‚ƒç›´è§‰</div>
                        </div>
                        <div class="personality-card" data-personality="warm" onclick="selectPersonality('warm')">
                            <div class="personality-emoji">ğŸ’</div>
                            <div class="personality-name">æ¸©æš–</div>
                            <div class="personality-trait">è´´å¿ƒé™ªä¼´</div>
                        </div>
                    </div>
                </div>

                <!-- å¼€å§‹æŒ‰é’® -->
                <button class="action-button" id="startButton" onclick="startDivination()">
                    <i class="fas fa-sparkles"></i><span>å¼€å§‹å åœ</span>
                </button>
            </div>
        {% else %}
            <!-- æ— æƒé™æç¤º -->
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-moon"></i></div>
                <h2 class="empty-title">ä»Šæ—¥å åœæ¬¡æ•°å·²ç”¨å®Œ</h2>
                <p class="empty-desc">æ˜å¤©å†æ¥æ¢ç´¢å¡”ç½—çš„å¥¥ç§˜å§</p>
                <button class="action-button" onclick="window.location.href='{{ url_for('index') }}'">è¿”å›é¦–é¡µ</button>
            </div>
        {% endif %}
    </div>

    <script>
        let selectedSpread=null;
        let selectedSpreadName='';
        let selectedPersonality='wisdom';

        // é€‰æ‹©ç‰Œé˜µ
        function selectSpread(spreadId, spreadName){
            document.querySelectorAll('.spread-card').forEach(c=>c.classList.remove('selected'));
            const card=document.querySelector(`[data-spread-id="${spreadId}"]`);
            if(card){
                card.classList.add('selected');
                selectedSpread=spreadId;
                selectedSpreadName=spreadName;
                showPanel();
            }
        }

        // æ˜¾ç¤ºæµ®åŠ¨é¢æ¿
        function showPanel(){
            const panel=document.getElementById('floatingPanel');
            const nameEl=document.getElementById('selectedSpreadName');
            nameEl.textContent=selectedSpreadName||'é€‰æ‹©çš„ç‰Œé˜µ';
            panel.classList.add('show');
            setTimeout(()=>document.getElementById('questionInput').focus(),250);
        }

        // å…³é—­é¢æ¿
        function closePanel(){
            const panel=document.getElementById('floatingPanel');
            panel.classList.remove('show');
            document.querySelectorAll('.spread-card').forEach(c=>c.classList.remove('selected'));
            selectedSpread=null; selectedSpreadName='';
        }

        // äººæ ¼é€‰æ‹©
        function selectPersonality(p){
            document.querySelectorAll('.personality-card').forEach(c=>c.classList.remove('selected'));
            const card=document.querySelector(`[data-personality="${p}"]`);
            if(card){ card.classList.add('selected'); selectedPersonality=p; }
        }

        // åˆ†ç±»ç­›é€‰
        function filterCategory(category, event){
            document.querySelectorAll('.category-btn').forEach(btn=>btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.spread-card').forEach(card=>{
                card.style.display = (category==='all' || card.dataset.category===category) ? 'block' : 'none';
            });
            closePanel();
        }

        // å¼€å§‹å åœ
        async function startDivination(){
            if(!selectedSpread) return;
            const button=document.getElementById('startButton');
            const question=document.getElementById('questionInput').value.trim();

            button.disabled=true;
            button.innerHTML='<i class="fas fa-spinner fa-spin"></i><span> å‡†å¤‡ä¸­...</span>';

            try{
                const res=await fetch('/api/spread/draw',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        spread_id:selectedSpread,
                        question:question,
                        ai_personality:selectedPersonality
                    })
                });
                const data=await res.json();
                if(data.success){
                    window.location.href=data.redirect;
                }else{
                    alert(data.error||'å åœå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    button.disabled=false;
                    button.innerHTML='<i class="fas fa-sparkles"></i><span> å¼€å§‹å åœ</span>';
                }
            }catch(err){
                console.error('Error:',err);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                button.disabled=false;
                button.innerHTML='<i class="fas fa-sparkles"></i><span> å¼€å§‹å åœ</span>';
            }
        }

        // ç‚¹å‡»å¤–éƒ¨æ”¶èµ·é¢æ¿
        document.addEventListener('click',function(e){
            const panel=document.getElementById('floatingPanel');
            const clickInside=panel.contains(e.target) || e.target.closest('.spread-card');
            if(!clickInside && panel.classList.contains('show')) closePanel();
        });

        // å›è½¦æäº¤
        document.getElementById('questionInput')?.addEventListener('keypress',function(e){
            if(e.key==='Enter' && selectedSpread) startDivination();
        });
    </script>
</body>
</html>
