<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

<!-- iOS å…¨å± & çŠ¶æ€æ æ ·å¼ï¼ˆé»‘è‰²åŠé€æ˜ï¼Œæ²‰æµ¸æ„Ÿæ›´å¼ºï¼‰ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="è‹¥æ°´å åœ">

<!-- Android / Chrome ä¸»é¢˜è‰² -->
<meta name="theme-color" content="#1a1625" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#2d1b4e" media="(prefers-color-scheme: light)">

<!-- PWA æ¸…å• -->
<link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">

<!-- ä¸»å±å¹•å›¾æ ‡ï¼ˆå¯å…ˆæ”¾ä¸€å¼  180x180 PNG åˆ° /static/icons/ï¼‰ -->
<link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-180.png') }}">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <title>æ¯æ—¥å¡”ç½—è¿åŠ¿ Â· è‹¥æ°´å åœ</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#9d7ea8; --secondary:#6d5675; --gold:#e8d4a2; --gold-light:#f4e5c3;
      --bg1:#2d1b4e; --bg2:#1a1625;
      --text:#fff; --text-light:rgba(255,255,255,.88); --text-muted:rgba(255,255,255,.65);
      --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --star:#ffd700; --success:#10b981; --danger:#ef4444;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Noto Serif SC',-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      color:var(--text); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(157,126,168,.18), transparent 60%),
        radial-gradient(1200px 700px at 80% 90%, rgba(232,212,162,.12), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      position:relative; overflow-x:hidden;
    }
    .bg-stars{position:fixed;inset:0;z-index:-2;opacity:.25;background-image:
      radial-gradient(1px 1px at 12% 25%, #fff, transparent),
      radial-gradient(1px 1px at 32% 60%, #fff, transparent),
      radial-gradient(1px 1px at 62% 30%, #fff, transparent),
      radial-gradient(1px 1px at 82% 70%, #fff, transparent),
      radial-gradient(1px 1px at 22% 80%, #fff, transparent);
      background-size:220px 220px;animation:twinkle 4s ease-in-out infinite alternate;pointer-events:none;}
    @keyframes twinkle{from{opacity:.15}to{opacity:.35}}
    .zodiac{position:fixed;width:820px;height:820px;left:50%;top:50%;transform:translate(-50%,-50%);z-index:-2;opacity:.1;filter:drop-shadow(0 0 20px rgba(255,255,255,.1));animation:rot 90s linear infinite;pointer-events:none;}
    @keyframes rot{to{transform:translate(-50%,-50%) rotate(360deg)}}

    .user-bar{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(28,22,40,.6);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);}
    .user-bar-content{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-icon{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid var(--border)}
    .user-name{color:var(--gold-light);font-weight:600;letter-spacing:.5px}
    .user-actions{display:flex;gap:10px}
    .user-actions a{color:var(--text-light);text-decoration:none;font-size:.95rem;padding:8px 14px;border-radius:18px;border:1px solid transparent;transition:.25s;background:rgba(255,255,255,.06);backdrop-filter:blur(8px)}
    .user-actions a:hover{color:#fff;border-color:var(--border);transform:translateY(-1px)}

    .flash-messages{position:fixed;top:68px;right:20px;z-index:200;max-width:380px}
    .alert{padding:12px 14px;margin-bottom:10px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 18px rgba(0,0,0,.18);color:#fff;border:none;animation:in .3s ease-out;backdrop-filter:blur(6px)}
    .alert-success{background:rgba(16,185,129,.9)} .alert-info{background:rgba(59,130,246,.9)} .alert-error{background:rgba(239,68,68,.9)}
    .alert .close{background:none;border:none;color:#fff;font-size:1.4rem;opacity:.85}.alert .close:hover{opacity:1}
    @keyframes in{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

    .main-container{max-width:980px;width:100%;margin:88px auto 24px}

    .tarot-container{position:relative;overflow:hidden;margin-bottom:30px;padding:28px;border-radius:22px;background:rgba(255,255,255,.06);border:1px solid var(--border);box-shadow:0 18px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08)}
    .header h1{font-size:2.2rem;color:var(--gold-light);letter-spacing:1px;text-align:center;text-shadow:0 2px 8px rgba(0,0,0,.25)}
    .header p{color:var(--text-muted);text-align:center;margin-top:6px}
    .tarot-card{width:220px;height:340px;margin:24px auto 10px;border-radius:14px;overflow:hidden;background:linear-gradient(135deg, rgba(157,126,168,.36), rgba(232,212,162,.2));border:1px solid var(--border);box-shadow:0 12px 30px rgba(0,0,0,.28);transform-style:preserve-3d;transition:transform .8s cubic-bezier(.175,.885,.32,1.275), box-shadow .35s ease;cursor:pointer}
    .tarot-card:hover{transform:translateY(-6px) rotate(3deg);box-shadow:0 16px 36px rgba(0,0,0,.34)}
    .tarot-card::after{content:"";position:absolute;inset:14px;border-radius:10px;border:1px solid rgba(255,255,255,.22)}
    .action-section{text-align:center;margin:16px 0 6px}
    .btn-tarot,.already-drawn{display:inline-flex;align-items:center;gap:10px;padding:13px 28px;border-radius:24px;border:1px solid var(--border);background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;letter-spacing:.4px;box-shadow:0 10px 24px rgba(157,126,168,.32);text-decoration:none;transition:.3s}
    .btn-tarot:hover,.already-drawn:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(157,126,168,.42);color:#fff}
    .btn-tarot:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .guest-tip{max-width:520px;margin:12px auto 0;padding:12px 14px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text-light)}

    .fortune-card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:22px;padding:0;box-shadow:0 16px 36px rgba(0,0,0,.28);overflow:hidden;display:none}
    .fortune-header{background:linear-gradient(135deg, rgba(157,126,168,.3), rgba(232,212,162,.16));color:var(--text);padding:26px;text-align:center;border-bottom:1px solid var(--border)}
    .fortune-date{font-size:.95rem;color:var(--text-muted);margin-bottom:6px}
    .fortune-score{font-size:3.8rem;font-weight:800;letter-spacing:1px;color:var(--gold-light);text-shadow:0 2px 10px rgba(0,0,0,.22);display:inline-block}
    .fortune-score::after{content:'åˆ†';font-size:1.2rem;font-weight:400;margin-left:6px;color:var(--text-light)}
    .fortune-label{margin-top:10px;display:inline-block;padding:6px 18px;border-radius:18px;background:rgba(255,255,255,.16);color:var(--text);font-weight:700;border:1px solid var(--border)}
    .fortune-summary{font-size:1rem;line-height:1.7;color:var(--text-light);max-width:680px;margin:10px auto 0}
    .dimensions-section{padding:24px;background:rgba(0,0,0,.08)}
    .section-title{font-size:1.2rem;color:var(--gold-light);text-align:center;margin-bottom:16px;font-weight:700}
    .dimensions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:20px}
    .dimension-item{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.12);transition:.25s ease}
    .dimension-item:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.16)}
    .dimension-icon{width:42px;height:42px;border-radius:12px;margin:0 auto 8px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.1rem;border:1px solid var(--border)}
    .dimension-name{font-weight:700;color:var(--text);margin-bottom:6px}
    .dimension-stars{font-size:1.05rem;color:var(--star);letter-spacing:2px;margin-bottom:4px}
    .dimension-level{font-size:.9rem;color:var(--text-muted);background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:12px;display:inline-block;padding:4px 10px}
    .advice-grid{display:grid;gap:10px}
    .advice-item{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:12px;padding:12px 15px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .advice-icon{width:34px;height:34px;border-radius:10px;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;color:var(--gold-light)}
    .advice-name{font-weight:700;color:var(--text);font-size:.95rem;margin-bottom:2px}
    .advice-text{color:var(--text-muted);font-size:.95rem;line-height:1.5}
    .bottom-section{padding:24px;display:grid;grid-template-columns:1fr 1.5fr;gap:22px}
    .lucky-section{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;padding:16px}
    .lucky-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .lucky-item{background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:12px;text-align:center;padding:10px}
    .lucky-label{font-size:.88rem;color:var(--text-muted);margin-bottom:4px}
    .lucky-value{font-weight:700;color:var(--gold-light);font-size:1.06rem}
    .suggestions-section{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .suggestion-card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;padding:16px}
    .suggestion-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .suggestion-icon{width:30px;height:30px;border-radius:8px;color:#fff;display:flex;align-items:center;justify-content:center}
    .suggestion-do .suggestion-icon{background:var(--success)}
    .suggestion-dont .suggestion-icon{background:var(--danger)}
    .suggestion-title{font-weight:700;font-size:1.02rem}
    .suggestion-list{list-style:none;margin:0;padding:0}
    .suggestion-list li{padding:6px 0 6px 22px;position:relative;color:var(--text-muted)}
    .suggestion-list li::before{content:'â€¢';position:absolute;left:8px;top:2px;font-weight:700}
    .suggestion-do li::before{color:var(--success)} .suggestion-dont li::before{color:var(--danger)}
    .action-bar{text-align:center;padding:16px;background:rgba(255,255,255,.06);border-top:1px solid var(--border)}
    .btn-refresh,.btn-ai-chat{padding:11px 20px;border-radius:20px;border:1px solid var(--border);background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;text-decoration:none;display:inline-block;transition:.25s;box-shadow:0 6px 16px rgba(157,126,168,.3)}
    .btn-refresh:hover,.btn-ai-chat:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(157,126,168,.4);color:#fff}

    .fab-share{position:fixed;right:20px;bottom:20px;z-index:300;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;border:1px solid var(--border);background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:0 12px 26px rgba(157,126,168,.32);transition:.25s}
    .fab-share:hover{transform:translateY(-2px);box-shadow:0 16px 30px rgba(157,126,168,.42)}
    .fab-share.disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

/* ========= Tarot èƒŒæ™¯å¢å¼ºï¼ˆä»…è§†è§‰å±‚ï¼›ä¸æ”¹åŠ¨ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼‰ ========= */

/* 1) æŸ”é›¾ï¼šæ›´æœ‰å±‚æ¬¡çš„ç¥ç§˜æ°›å›´ */
.bg-veil{
  position:fixed; inset:-10% -10% 0 -10%;
  z-index:-5; pointer-events:none;
  opacity:.9; filter:blur(2px);
  background:
    radial-gradient(800px 500px at 12% 14%, rgba(157,126,168,.18), transparent 60%),
    radial-gradient(720px 460px at 82% 72%, rgba(232,212,162,.12), transparent 60%),
    radial-gradient(900px 560px at 58% 12%, rgba(157,126,168,.10), transparent 70%);
  animation:veilDrift 50s linear infinite alternate;
}
@keyframes veilDrift{ to{ transform:translate3d(-10px,8px,0) } }

/* 2) ç»†çº¿æ˜Ÿåº§ï¼šä¸åŸæœ‰æ˜Ÿç‚¹äº’è¡¥ï¼Œä¿æŒè½»ç›ˆ */
.bg-constellations{
  position:fixed; inset:0; z-index:-4; pointer-events:none;
  opacity:.18; mix-blend-mode:screen;
}
.bg-constellations line{ stroke:rgba(255,255,255,.18); stroke-width:.6 }
.bg-constellations circle{ fill:rgba(255,255,255,.7); r:1.2; animation:starBlink 4.6s ease-in-out infinite }
@keyframes starBlink{ 0%,100%{opacity:.25} 50%{opacity:.85} }

/* 3) å¡”ç½—å››å…ƒç´ è½»æµ®å±‚ï¼šæƒæ–/åœ£æ¯/å®å‰‘/æ˜Ÿå¸ï¼ˆä½é¥±å’Œã€ä½ä¸é€æ˜åº¦ï¼‰ */
.bg-glyphs{
  position:fixed; inset:0; z-index:-1; pointer-events:none;
  opacity:.13; filter:drop-shadow(0 0 20px rgba(232,212,162,.06));
  background-repeat:no-repeat;
  background-size: 68px 68px, 76px 76px, 64px 64px, 72px 72px, 60px 60px, 70px 70px;
  background-position: 8% 24%, 86% 22%, 12% 78%, 88% 68%, 42% 88%, 34% 34%;
  animation:glyphFloat 40s ease-in-out infinite alternate;
  /* å…­ä¸ªç‚¹ä½çš„ SVGï¼ˆå››ä¸ªå›¾æ¡ˆå¤ç”¨ï¼‰ */
  background-image:
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"), /* Wand */
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>"), /* Cup */
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M32 10 v36'/><path d='M22 30 h20'/><path d='M28 48 h8'/><circle cx='32' cy='10' r='3' fill='none'/></g></svg>"), /* Sword */
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='32' cy='32' r='16'/><path d='M32 16 L37 40 L20 26 H44 L27 40 Z'/></g></svg>"), /* Pentacle */
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>"), /* Wand(å¤ç”¨) */
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>"); /* Cup(å¤ç”¨) */
}
@keyframes glyphFloat{ to{ transform:translate3d(0,-8px,0) rotate(-0.5deg) } }

/* ä½è¿åŠ¨åå¥½ï¼šç¦ç”¨åŠ¨ç”»ï¼Œä¿è¯æ²‰é™è´¨æ„Ÿ */
@media (prefers-reduced-motion: reduce){
  .bg-veil,.bg-glyphs,.bg-constellations,.zodiac{ animation:none }
}

.sc-overlay{
  position:fixed;
  inset:0;
  z-index:500;
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
}
.sc-mask{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.75);
  backdrop-filter:blur(4px);
}
.sc-panel{
  position:relative;
  z-index:1;
  max-width:480px;
  max-height:90vh;
  width:100%;
  padding:16px;
  border-radius:20px;
  background:rgba(255,255,255,.08);
  border:1px solid var(--border);
  box-shadow:0 24px 48px rgba(0,0,0,.4);
  display:flex;
  flex-direction:column;
  gap:12px;
}
.sc-close{
  position:absolute;
  right:14px;
  top:14px;
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  color:#fff;
  background:rgba(255,255,255,.1);
  border:1px solid var(--border);
  transition:.2s;
}
.sc-close:hover{
  background:rgba(255,255,255,.15);
  transform:scale(1.1);
}
.sc-frame-wrapper{
  flex:1;
  min-height:0;
  border-radius:16px;
  overflow:hidden;
  background:#1a1625;
  position:relative;
}
.sc-frame{
  width:100%;
  height:100%;
  border:0;
  display:block;
}
.sc-actions{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  padding-top:8px;
}
.sc-btn{
  padding:12px 20px;
  border-radius:20px;
  border:1px solid var(--border);
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;
  font-weight:600;
  cursor:pointer;
  transition:.25s;
  font-size:14px;
}
.sc-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(157,126,168,.35);
}
.sc-btn.ghost{
  background:rgba(255,255,255,.08);
}
.sc-btn:disabled{
  opacity:.5;
  cursor:not-allowed;
  transform:none;
}
.loading-spinner{
  display:inline-block;
  width:14px;
  height:14px;
  border:2px solid rgba(255,255,255,.3);
  border-radius:50%;
  border-top-color:#fff;
  animation:spin .6s linear infinite;
  margin-right:6px;
}
@keyframes spin{
  to{transform:rotate(360deg)}
}

    @media (max-width:768px){
      .main-container{margin-top:74px}
      .bottom-section{grid-template-columns:1fr}
      .suggestions-section{grid-template-columns:1fr}
      .dimensions-grid{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
      .fortune-score{font-size:3rem}
      .lucky-grid{grid-template-columns:1fr}
      .sc-frame{max-width:92vw}
    }

  /* ===== ç§»åŠ¨ç«¯ & iOS é€‚é…è¡¥ä¸ï¼ˆä¸è§¦ç¢°ä¸šåŠ¡é€»è¾‘ï¼‰ ===== */

/* è®©é¡µé¢é«˜åº¦åœ¨ iOS ä¸Šå¯é ï¼šä¼˜å…ˆä½¿ç”¨ 100dvhï¼Œé™çº§åˆ°è‡ªå®šä¹‰ --vh */
html, body{
  min-height: 100dvh;
  min-height: calc(var(--vh, 1vh) * 100);
}

/* é¡¶éƒ¨å›ºå®šæ ä¸å†…å®¹åŒºï¼šä¸ºåˆ˜æµ·ç•™ç™½ */
.user-bar{
  padding-top: calc(env(safe-area-inset-top, 0px) + 10px);
}
.main-container{
  margin-top: calc(88px + env(safe-area-inset-top, 0px));
}
@media (max-width:768px){
  .main-container{
    margin-top: calc(74px + env(safe-area-inset-top, 0px));
  }
}

/* åº•éƒ¨æµ®åŠ¨æŒ‰é’®ä¸å¼¹å±‚æ“ä½œåŒºï¼šä¸º Home æŒ‡ç¤ºæ¡ç•™ç™½ */
.fab-share{
  bottom: calc(20px + env(safe-area-inset-bottom, 0px));
}
.sc-actions{
  padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
}

/* iOS ç‚¹å‡»ä¼˜åŒ–ï¼ˆé¿å…åŒå‡»ç¼©æ”¾ã€è§¦æ§æ›´çµæ•ï¼‰ */
button, .btn-tarot, .already-drawn, .sc-btn, .fab-share{
  touch-action: manipulation;
}

/* é˜²æ­¢ iOS å› è¾“å…¥å­—å°äº 16px è‡ªåŠ¨æ”¾å¤§ï¼ˆå¦‚åç»­æœ‰è¾“å…¥æ¡†ï¼‰ */
input, select, textarea{
  font-size: 16px;
}

/* Tarot å¡ç‰‡åœ¨å°å±çš„è‡ªé€‚åº”æ¯”ä¾‹ï¼ˆä¸æ”¹æ¡Œé¢å¸ƒå±€ï¼‰ */
@media (max-width:768px){
  .tarot-card{
    /* ä½¿ç”¨çºµæ¨ªæ¯”ï¼Œè‡ªåŠ¨ç®—é«˜ */
    aspect-ratio: 220 / 340;
    width: clamp(180px, 64vw, 260px);
    height: auto;
  }
}

/* èƒŒæ™¯åŠ¨æ•ˆåœ¨ç§»åŠ¨ç«¯æ›´ç¨³ï¼ˆå¯é€‰ï¼‰ */
.bg-veil, .bg-constellations, .bg-glyphs, .zodiac{
  will-change: transform, opacity;
}

/* ===== iOS ä¸“ç”¨ï¼šç”¨ transform â€œé’‰ä½â€èƒŒæ™¯ï¼Œæ›¿ä»£ position:fixedï¼ˆé¿å…ç™½å±ï¼‰ ===== */

:root { --sy: 0px; }  /* å½“å‰æ»šåŠ¨ä½ç½®ï¼ˆåƒç´ ï¼‰ */

.ios-pin .bg-stars,
.ios-pin .bg-veil,
.ios-pin .bg-constellations,
.ios-pin .bg-glyphs,
.ios-pin .zodiac{
  position: absolute !important;    /* æ›¿ä»£ fixed */
  top: 0; left: 0; right: 0;
  height: 100vh; width: 100%;
  transform: translate3d(0, var(--sy), 0);  /* éš scrollY æŠµæ¶ˆæ»šåŠ¨ */
  z-index: 0;                        /* åœ¨å†…å®¹ä¸‹æ–¹ã€ä½†ä¸ä¸ºè´Ÿï¼Œé¿å…è¢« body èƒŒæ™¯ç›–ä½ */
  pointer-events: none;
  backface-visibility: hidden;
  will-change: transform;            /* GPU åˆæˆï¼Œä¸å¡é¡¿ */
}

/* ç¡®ä¿ä¸»ä½“å†…å®¹åœ¨èƒŒæ™¯ä¹‹ä¸Šï¼ˆä¸å½±å“ä½ çš„ fixed é¡¶æ ä¸å¼¹å±‚ï¼‰ */
.ios-pin .main-container,
.ios-pin .features,
.ios-pin .footer{
  position: relative;
  z-index: 2;
}


/* ========== iOS ä¸“ç”¨ï¼šç”¨ä¸€å±‚ .bg-stars æ‰¿è½½å…¨éƒ¨èƒŒæ™¯ï¼Œå…¶ä»–èƒŒæ™¯å±‚éšè— ========== */
@supports (-webkit-touch-callout: none) {
  /* 1) éšè— iOS ä¸Šæ˜“è§¦å‘ç™½å±çš„å¤šå±‚ fixed èƒŒæ™¯ */
  .bg-veil,
  .bg-constellations,
  .bg-glyphs,
  .zodiac { display: none !important; }

  /* 2) æŠŠ .bg-stars æ”¹ä¸ºâ€œå•å±‚ç²˜æ»èƒŒæ™¯â€ï¼Œæ‰¿è½½æ‰€æœ‰è£…é¥°å›¾æ¡ˆ */
  .bg-stars{
    position: sticky !important;    /* ä»£æ›¿ fixedï¼Œæ›´ç¨³ */
    top: 0;
    height: 100svh;                 /* iOS è§†å£å®‰å…¨å•ä½ */
    inset: 0;                       /* è¦†ç›–å…¨å± */
    z-index: 0;                     /* åœ¨å†…å®¹ä¹‹ä¸‹ï¼Œä½†ä¸æ˜¯è´Ÿæ•° */
    pointer-events: none;
    backface-visibility: hidden;
    transform: translateZ(0);       /* GPU åˆæˆï¼Œé¿å…é—ªçƒ */
    animation: none;                /* å…³é—­åŸ twinkle åŠ¨ç”»ï¼ˆåˆå¹¶åˆ°ä¸‹æ–¹è£…é¥°ï¼‰ */

    /* 3) ä¸€å±‚é‡Œå åŠ å…¨éƒ¨èƒŒæ™¯ï¼ˆæ˜Ÿç‚¹/æŸ”é›¾/å››å…ƒç´ /æ˜Ÿåº§çº¿ï¼‰ */
    background:
      /* æŸ”é›¾å±‚ï¼ˆä¿æŒä½ çš„é…è‰²ï¼‰ */
      radial-gradient(800px 500px at 12% 14%, rgba(157,126,168,.18), transparent 60%),
      radial-gradient(720px 460px at 82% 72%, rgba(232,212,162,.12), transparent 60%),
      radial-gradient(900px 560px at 58% 12%, rgba(157,126,168,.10), transparent 70%),

      /* ç»†æ˜Ÿç‚¹ï¼ˆåŸæœ‰æ˜Ÿç©ºè´¨æ„Ÿï¼‰ */
      radial-gradient(1px 1px at 12% 25%, rgba(255,255,255,.8), transparent),
      radial-gradient(1px 1px at 32% 60%, rgba(255,255,255,.8), transparent),
      radial-gradient(1px 1px at 62% 30%, rgba(255,255,255,.8), transparent),
      radial-gradient(1px 1px at 82% 70%, rgba(255,255,255,.8), transparent),
      radial-gradient(1px 1px at 22% 80%, rgba(255,255,255,.8), transparent),

      /* çº¿æ€§æ˜Ÿåº§ï¼ˆåˆå¹¶ä¸ºèƒŒæ™¯å›¾ç‰‡ï¼‰ */
      url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 1000'>\
<g stroke='rgba(255,255,255,0.18)' stroke-width='1' fill='none'>\
<line x1='90' y1='120' x2='160' y2='160'/><line x1='160' y1='160' x2='210' y2='110'/><line x1='160' y1='160' x2='110' y2='200'/>\
<line x1='780' y1='120' x2='840' y2='160'/><line x1='840' y1='160' x2='900' y2='180'/><line x1='900' y1='180' x2='950' y2='150'/>\
<line x1='760' y1='740' x2='820' y2='780'/><line x1='820' y1='780' x2='880' y2='740'/><line x1='820' y1='780' x2='840' y2='840'/>\
</g>\
<g fill='rgba(255,255,255,0.7)'>\
<circle cx='90' cy='120' r='1.2'/><circle cx='160' cy='160' r='1.2'/><circle cx='210' cy='110' r='1.2'/><circle cx='110' cy='200' r='1.2'/>\
<circle cx='780' cy='120' r='1.2'/><circle cx='840' cy='160' r='1.2'/><circle cx='900' cy='180' r='1.2'/><circle cx='950' cy='150' r='1.2'/>\
<circle cx='760' cy='740' r='1.2'/><circle cx='820' cy='780' r='1.2'/><circle cx='880' cy='740' r='1.2'/><circle cx='840' cy='840' r='1.2'/>\
</g></svg>"),

      /* å››å…ƒç´  glyphï¼ˆWand / Cup / Sword / Pentacleï¼‰ï¼Œä¸åŸå¸ƒå±€ä¸€è‡´ */
      url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 50 L50 14'/><circle cx='50' cy='14' r='4'/><path d='M18 46 q6 -2 8 4'/></g></svg>\"),
      url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 16 h32 a10 10 0 0 1 -10 10 h-12 a10 10 0 0 1 -10 -10 z'/><path d='M32 26 v16'/><path d='M24 42 h16'/></g></svg>\"),
      url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M32 10 v36'/><path d='M22 30 h20'/><path d='M28 48 h8'/><circle cx='32' cy='10' r='3' fill='none'/></g></svg>\"),
      url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g fill='none' stroke='%23e8d4a2' stroke-opacity='.35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='32' cy='32' r='16'/><path d='M32 16 L37 40 L20 26 H44 L27 40 Z'/></g></svg>"),

      /* æœ€åº•å±‚ä½ çš„çº¿æ€§æ¸å˜ */
      linear-gradient(135deg, #2d1b4e 0%, #1a1625 100%);

    background-repeat: no-repeat, no-repeat, no-repeat,
                       repeat, repeat, repeat, repeat, repeat,
                       no-repeat,
                       no-repeat, no-repeat, no-repeat, no-repeat,
                       no-repeat;
    background-size:
      cover, cover, cover,           /* ä¸‰å±‚æŸ”é›¾ */
      220px 220px, 220px 220px, 220px 220px, 220px 220px, 220px 220px,  /* æ˜Ÿç‚¹é˜µåˆ— */
      cover,                         /* çº¿æ€§æ˜Ÿåº§ SVG */
      68px 68px, 76px 76px, 64px 64px, 72px 72px,                       /* å››å…ƒç´  glyph */
      cover;                         /* çº¿æ€§æ¸å˜åº• */
    background-position:
      12% 14%, 82% 72%, 58% 12%,     /* æŸ”é›¾é”šç‚¹ */
      12% 25%, 32% 60%, 62% 30%, 82% 70%, 22% 80%,  /* æ˜Ÿç‚¹ */
      center,                        /* æ˜Ÿåº§çº¿è¦†ç›–å…¨å± */
      8% 24%, 86% 22%, 12% 78%, 88% 68%,            /* glyph å¸ƒå±€ */
      center;                        /* æ¸å˜åº• */
    opacity: .98;                    /* è½»å¾®æäº®ï¼Œé¿å…çœ‹èµ·æ¥â€œå˜æš—â€ */
  }

  /* 4) åœ¨ .bg-stars ä¸Šè¿½åŠ â€œæ—‹è½¬æ˜Ÿç›˜â€ä¼ªå…ƒç´ ï¼ˆiOS ä¹Ÿè¦æœ‰é«˜çº§æ„Ÿï¼‰ */
  .bg-stars::after{
    content: "";
    position: absolute;
    left: 50%; top: 50%;
    width: 560px; height: 560px;     /* ç§»åŠ¨ç«¯å°ºå¯¸ï¼›æ¡Œé¢ä¸Šä½ å·²æœ‰ SVG */
    transform: translate(-50%, -50%);
    opacity: .12;
    pointer-events: none;
    background: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>\
<g fill='none' stroke='%23ffffff' stroke-opacity='.7' stroke-width='.3'>\
<circle cx='50' cy='50' r='44'/><circle cx='50' cy='50' r='34' stroke-opacity='.4'/>\
<g stroke-opacity='.25'><line x1='50' y1='6' x2='50' y2='94'/><line x1='6' y1='50' x2='94' y2='50'/><line x1='18' y1='18' x2='82' y2='82'/><line x1='18' y1='82' x2='82' y2='18'/></g>\
</g>\
</svg>") center/100% 100% no-repeat;
    animation: iosZodiacSpin 110s linear infinite;
    will-change: transform;
  }
  @keyframes iosZodiacSpin { to { transform: translate(-50%, -50%) rotate(360deg); } }

  /* 5) ä¸»ä½“åœ¨èƒŒæ™¯ä¹‹ä¸Šï¼ˆä¸å½±å“ä½ çš„ fixed é¡¶æ /å¼¹å±‚ï¼‰ */
  .main-container, .features, .footer { position: relative; z-index: 2; }
  html{ background:#120c1d; }     /* é˜²æç«¯å›å¼¹æ—¶ç™½åº• */
}


  </style>
</head>
<body>
  <div class="bg-stars"></div>
  <div class="bg-veil" aria-hidden="true"></div>

<svg class="bg-constellations" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-hidden="true">
  <!-- å·¦ä¸Šè§’å°æ˜Ÿç¾¤ -->
  <g>
    <line x1="90" y1="120" x2="160" y2="160"/><line x1="160" y1="160" x2="210" y2="110"/><line x1="160" y1="160" x2="110" y2="200"/>
    <circle cx="90" cy="120"/><circle cx="160" cy="160" style="animation-delay:.6s"/><circle cx="210" cy="110" style="animation-delay:1.2s"/><circle cx="110" cy="200" style="animation-delay:1.8s"/>
  </g>
  <!-- å³ä¸Šè§’é•¿é“¾ -->
  <g>
    <line x1="780" y1="120" x2="840" y2="160"/><line x1="840" y1="160" x2="900" y2="180"/><line x1="900" y1="180" x2="950" y2="150"/>
    <circle cx="780" cy="120"/><circle cx="840" cy="160" style="animation-delay:.8s"/><circle cx="900" cy="180" style="animation-delay:1.4s"/><circle cx="950" cy="150" style="animation-delay:2s"/>
  </g>
  <!-- å³ä¸‹è§’æŠ˜çº¿ -->
  <g>
    <line x1="760" y1="740" x2="820" y2="780"/><line x1="820" y1="780" x2="880" y2="740"/><line x1="820" y1="780" x2="840" y2="840"/>
    <circle cx="760" cy="740"/><circle cx="820" cy="780" style="animation-delay:.7s"/><circle cx="880" cy="740" style="animation-delay:1.3s"/><circle cx="840" cy="840" style="animation-delay:1.9s"/>
  </g>
</svg>

<div class="bg-glyphs" aria-hidden="true"></div>

  <svg class="zodiac" viewBox="0 0 100 100" aria-hidden="true">
    <g fill="none" stroke="#fff" stroke-opacity=".7" stroke-width=".3">
      <circle cx="50" cy="50" r="44"/>
      <circle cx="50" cy="50" r="34" stroke-opacity=".4"/>
      <g stroke-opacity=".25"><line x1="50" y1="6" x2="50" y2="94"/><line x1="6" y1="50" x2="94" y2="50"/><line x1="18" y1="18" x2="82" y2="82"/><line x1="18" y1="82" x2="82" y2="18"/></g>
    </g>
    <g fill="#fff" fill-opacity=".55" font-size="6" font-family="serif">
      <text x="50" y="10" text-anchor="middle">â™ˆï¸â™‰ï¸â™Šï¸â™‹ï¸â™Œï¸â™ï¸â™ï¸â™ï¸â™ï¸â™‘ï¸â™’ï¸â™“ï¸</text>
    </g>
  </svg>

  <div class="user-bar">
    <div class="user-bar-content">
      <div class="user-info">
        <div class="user-icon">{% if not user.is_guest %}{{ user.username[0]|upper }}{% else %}<i class="fas fa-user"></i>{% endif %}</div>
        <span class="user-name">{{ user.username if not user.is_guest else "ç¥ç§˜è®¿å®¢" }}</span>
      </div>
      <div class="user-actions">
        {% if user.is_guest %}
          <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> ç™»å½•</a>
          <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> æ³¨å†Œ</a>
        {% else %}
          <a href="{{ url_for('stats') }}"><i class="fas fa-chart-line"></i> ç»Ÿè®¡</a>
          <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a>
        {% endif %}
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}"><span>{{ message }}</span><button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button></div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="main-container">
    <div class="tarot-container">
      <div class="header">
        <h1><i class="fas fa-star"></i> æ¯æ—¥å¡”ç½—è¿åŠ¿ <i class="fas fa-star"></i></h1>
        <p>æ¢ç´¢å®‡å®™çš„å¥¥ç§˜ï¼Œæ­ç¤ºä»Šæ—¥çš„æŒ‡å¼•</p>
      </div>

      <div class="tarot-card" id="tarot-card-display">
        {% if today_card %}
          {% if today_card.image %}
            <img src="{{ today_card.image }}" alt="{{ today_card.name }}" style="width:100%;height:100%;object-fit:cover;border-radius:14px;">
            <div class="card-info" style="position:absolute;left:0;right:0;bottom:0;padding:16px;border-radius:0 0 14px 14px;background:linear-gradient(to top, rgba(0,0,0,.65), transparent);color:#fff;">
              <div style="font-weight:700;font-size:1.08rem;text-shadow:0 2px 6px rgba(0,0,0,.4);">{{ today_card.name }}</div>
              <div style="font-size:.92rem;opacity:.92;margin-top:4px;">{{ today_card.direction }}</div>
            </div>
          {% else %}
            <div style="text-align:center;padding:24px;color:var(--text-light);">
              <i class="fas fa-sun" style="font-size:3rem;margin-bottom:14px;color:var(--gold-light)"></i>
              <div style="font-weight:700;font-size:1.1rem;color:#fff;margin-bottom:6px;">{{ today_card.name }}</div>
              <div style="font-size:.95rem;color:var(--text-muted)">{{ today_card.direction }}</div>
            </div>
          {% endif %}
        {% else %}
          <i class="fas fa-question" style="color: var(--text-muted); font-size: 2rem;"></i>
        {% endif %}
      </div>

      {% if user.is_guest and not has_drawn %}
        <div class="guest-tip"><i class="fas fa-info-circle"></i>
          <span>ä½œä¸ºè®¿å®¢ï¼Œè§£è¯»ä»…åœ¨æœ¬æ¬¡æµè§ˆæœ‰æ•ˆã€‚<a href="{{ url_for('register') }}" style="color: var(--gold-light); text-decoration: underline;">æ³¨å†Œè´¦å·</a>å¯ä¿å­˜å†å²è®°å½•ã€‚</span>
        </div>
      {% endif %}

      <div class="action-section">
        {% if has_drawn %}
          <a href="{{ url_for('result') }}" class="already-drawn"><i class="fas fa-eye"></i> æŸ¥çœ‹ä»Šæ—¥å¡”ç½—è§£è¯»</a>
          <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background: linear-gradient(135deg, #4a6fa5, #2e4578);"><i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ</a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot"><i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ</a>
          </div>
          <div class="info-text" style="margin-top:8px;color:var(--text-muted)">æ‚¨ä»Šå¤©å·²ç»æŠ½å–è¿‡å¡”ç½—ç‰Œäº†</div>
        {% else %}
          <form id="draw-form" action="{{ url_for('draw_card') }}" method="post">
            <button type="submit" class="btn-tarot" id="draw-btn"><i class="fas fa-hand-sparkles"></i> æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œ</button>
          </form>
          <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background:#6c757d;"><i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ</a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot"><i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ</a>
          </div>
          <div class="info-text" style="margin-top:8px;color:var(--text-muted)">ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œï¼Œæˆ–ç›´æ¥è¿›å…¥ç‰Œé˜µå åœ</div>
        {% endif %}
      </div>
    </div>

    <div id="fortune-card" class="fortune-card">
      <div class="fortune-header">
        <div class="fortune-date">{{ today }} Â· ä»Šæ—¥è¿åŠ¿</div>
        <div class="fortune-score" id="overall-score">-</div>
        <div class="fortune-label" id="overall-label">-</div>
        <div class="fortune-summary" id="fortune-summary-text"></div>
      </div>

      <div class="dimensions-section">
        <h3 class="section-title">äº”ç»´åº¦è¿åŠ¿æŒ‡æ•°</h3>
        <div class="dimensions-grid" id="dimensions-grid"></div>
        <div class="advice-grid" id="advice-grid"></div>
      </div>

      <div class="bottom-section">
        <div class="lucky-section">
          <h3 class="section-title" style="margin-bottom:12px;">ä»Šæ—¥å¹¸è¿å…ƒç´ </h3>
          <div class="lucky-grid" id="lucky-grid"></div>
        </div>
        <div class="suggestions-section">
          <div class="suggestion-card suggestion-do">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-check"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å®œåš</div>
            </div>
            <ul class="suggestion-list" id="do-list"></ul>
          </div>
          <div class="suggestion-card suggestion-dont">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-times"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å¿Œåš</div>
            </div>
            <ul class="suggestion-list" id="dont-list"></ul>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn-refresh" onclick="refreshFortune()"><i class="fas fa-sync-alt"></i> åˆ·æ–°è¿åŠ¿</button>
        {% if has_drawn %}
          <a href="{{ url_for('chat_page') }}" class="btn-ai-chat"><i class="fas fa-comments"></i> AI æ·±åº¦è§£è¯»</a>
          <button type="button" class="btn-ai-chat" id="openShareBtn"><i class="fas fa-share-alt"></i> ç”Ÿæˆåˆ†äº«å¡ç‰‡</button>
        {% endif %}
      </div>
    </div>

    <div class="features" style="display:flex;justify-content:space-around;flex-wrap:wrap;margin:28px 0;gap:12px;">
      <a class="feature" onclick="goHistory()" style="flex:0 0 30%;min-width:220px;padding:18px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.14);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-moon" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.15rem;color:#fff;margin-bottom:6px;">æ¯æ—¥æŒ‡å¼•</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">æ¯å¤©æŠ½å–ä¸€å¼ å¡”ç½—ç‰Œï¼Œè·å–ä¸“å±ä»Šæ—¥çš„å®‡å®™æŒ‡å¼•</p>
      </a>
      <a class="feature" href="{{ url_for('guide_spread') }}" style="flex:0 0 30%;min-width:220px;padding:18px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.14);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-magic" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.15rem;color:#fff;margin-bottom:6px;">å¼•å¯¼é€‰æ‹©ç‰Œé˜µ</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">åƒå’Œå åœå¸ˆèŠå¤©ä¸€æ ·ï¼Œç”±ç³»ç»Ÿå¼•å¯¼é€‰æ‹©æœ€åˆé€‚çš„ç‰Œé˜µ</p>
      </a>
      <a class="feature" onclick="goHistory()" style="flex:0 0 30%;min-width:220px;padding:18px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.14);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-history" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.15rem;color:#fff;margin-bottom:6px;">å†å²è®°å½•</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">{{ 'æŸ¥çœ‹æ‚¨çš„æŠ½å¡è®°å½•å’Œè¿åŠ¿è¶‹åŠ¿' if not user.is_guest else 'æ³¨å†Œåå¯ä¿å­˜å†å²è®°å½•' }}</p>
      </a>
    </div>

    <div class="footer" style="text-align:center;color:var(--text-muted);font-size:.95rem;margin-top:4px;">
      Â© 2025 å¡”ç½—è¿åŠ¿ | å®‡å®™èƒ½é‡ï¼Œæ™ºæ…§æŒ‡å¼•<br><small style="opacity:.7;">æ¯æ—¥å‡Œæ™¨é‡ç½®ï¼ŒåŸºäºåŒ—äº¬æ—¶é—´</small>
    </div>
  </div>

  <div class="fab-share {% if not has_drawn %}disabled{% endif %}" id="fabShare" title="ç”Ÿæˆåˆ†äº«å¡ç‰‡"><i class="fas fa-share-alt"></i></div>

<div class="sc-overlay" id="scOverlay">
  <div class="sc-mask" onclick="closeShareOverlay()"></div>
  <div class="sc-panel">
    <button class="sc-close" onclick="closeShareOverlay()">
      <i class="fas fa-times"></i>
    </button>
    
    <div class="sc-frame-wrapper">
      <iframe id="shareFrame" class="sc-frame" title="åˆ†äº«å¡ç‰‡"></iframe>
    </div>
    
    <div class="sc-actions">
      <button class="sc-btn" id="btnGenShare" onclick="generateShare()">
        âœ¨ ç”Ÿæˆåˆ†äº«é“¾æ¥
      </button>
      <button class="sc-btn ghost" id="btnCopyLink" style="display:none" onclick="copyShareLink()">
        ğŸ”— å¤åˆ¶é“¾æ¥
      </button>
      <button class="sc-btn ghost" id="btnSaveImg" onclick="saveShareImage()">
        ğŸ’¾ ä¿å­˜å›¾ç‰‡
      </button>
    </div>
  </div>
</div>


  <script id="INDEX_DATA" type="application/json">
    {
      "user_name": "{{ user.username if not user.is_guest else 'ç¥ç§˜è®¿å®¢' }}",
      "today": "{{ today }}",
      "has_drawn": {{ 'true' if has_drawn else 'false' }},
      "reading": {{ (today_card or {})|tojson }},
      "fortune": {{ (fortune_data or {})|tojson }}
    }
  </script>

  <script>
    const $ = (id)=>document.getElementById(id);
    const dimensionIcons = {"äº‹ä¸šè¿":"fas fa-briefcase","è´¢å¯Œè¿":"fas fa-coins","çˆ±æƒ…è¿":"fas fa-heart","å¥åº·è¿":"fas fa-heartbeat","è´µäººè¿":"fas fa-hands-helping"};
    function generateStars(r){ const full=Math.floor(r||0); let s=''; for(let i=0;i<5;i++) s+=i<full?'â˜…':'â˜†'; return s; }

    document.addEventListener('DOMContentLoaded', ()=>{
      const data = JSON.parse($('INDEX_DATA').textContent || '{}');
      if (data.fortune && Object.keys(data.fortune).length>0) renderFortune(data.fortune);

      document.getElementById('draw-form')?.addEventListener('submit', function(e){
        e.preventDefault(); const btn=$('draw-btn'); btn.disabled=true; setTimeout(()=>this.submit(), 900 + Math.random()*900);
      });

      const openShare = ()=> openShareOverlay(data);
      $('openShareBtn')?.addEventListener('click', openShare);
      $('fabShare')?.addEventListener('click', ()=>{ if(!$('fabShare').classList.contains('disabled')) openShare(); });

      $('scMask').addEventListener('click', closeShareOverlay);
      $('scClose').addEventListener('click', closeShareOverlay);

      // å­é¡µå°ºå¯¸ -> è‡ªé€‚åº” iframeï¼ˆæ— ä»»ä½•æ»šåŠ¨æ¡ï¼‰
      const PAD_X = 32, PAD_Y = 160;
      window.addEventListener('message', (evt)=>{
        const msg = evt.data || {};
        if(msg.type === 'ruoshui:size' && msg.data){
          const frame = $('scFrame'); if(!frame) return;
          frame.style.width  = Math.min(msg.data.w, window.innerWidth - PAD_X) + 'px';
          frame.style.height = Math.min(msg.data.h, window.innerHeight - PAD_Y) + 'px';
        }
      });

      // æŒ‰é’®
      $('scGen').addEventListener('click', generateShareId);
      $('scCopy').addEventListener('click', ()=>copyText('https://www.ruoshui.fun'));
      $('scSave').addEventListener('click', saveShareImage);

      // çª—å£å°ºå¯¸å˜åŒ– -> å°†çˆ¶é¡µå¯è§†é«˜åº¦å‘ç»™å­é¡µï¼Œå­é¡µæ®æ­¤è¿›å…¥ compact
      window.addEventListener('resize', sendViewportToChild);
    });

    function renderFortune(data){
      $('fortune-card').style.display = 'block';
      $('overall-score').textContent = data.overall_score || '-';
      $('overall-label').textContent = data.overall_label || '-';
      $('fortune-summary-text').textContent = (data.fortune_text && data.fortune_text.summary) || data.summary || '';

      const grid = $('dimensions-grid'); grid.innerHTML='';
      if (data.dimensions && Array.isArray(data.dimensions)) {
        data.dimensions.forEach(dim=>{
          grid.insertAdjacentHTML('beforeend', `
            <div class="dimension-item">
              <div class="dimension-icon"><i class="${dimensionIcons[dim.name]||'fas fa-star'}"></i></div>
              <div class="dimension-name">${dim.name}</div>
              <div class="dimension-stars">${generateStars(dim.stars||3)}</div>
              <div class="dimension-level">${dim.level||'â€”'}</div>
            </div>`);
        });
      }

      const adviceGrid = $('advice-grid'); adviceGrid.innerHTML='';
      if (data.fortune_text && data.fortune_text.dimension_advice) {
        Object.entries(data.fortune_text.dimension_advice).forEach(([name, advice])=>{
          const icon = dimensionIcons[name]||'fas fa-star';
          adviceGrid.insertAdjacentHTML('beforeend', `
            <div class="advice-item">
              <div class="advice-icon"><i class="${icon}"></i></div>
              <div class="advice-content">
                <div class="advice-name">${name}</div>
                <div class="advice-text">${advice}</div>
              </div>
            </div>`);
        });
      }

      const luckyGrid = $('lucky-grid'); luckyGrid.innerHTML='';
      if (data.lucky_elements) {
        if (Array.isArray(data.lucky_elements)) {
          data.lucky_elements.forEach(item=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item"><div class="lucky-label">${item.name}</div><div class="lucky-value">${item.value}</div></div>`);
          });
        } else if (typeof data.lucky_elements === 'object') {
          const nameMap = {color:'å¹¸è¿é¢œè‰²',number:'å¹¸è¿æ•°å­—',hour:'å¹¸è¿æ—¶è¾°',direction:'å¹¸è¿æ–¹ä½'};
          Object.entries(data.lucky_elements).forEach(([k,v])=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item"><div class="lucky-label">${nameMap[k] || k}</div><div class="lucky-value">${v}</div></div>`);
          });
        }
      }

      const doList = $('do-list'); doList.innerHTML='';
      if (data.fortune_text && data.fortune_text.do) data.fortune_text.do.forEach(x=> doList.insertAdjacentHTML('beforeend', `<li>${x}</li>`));
      const dontList = $('dont-list'); dontList.innerHTML='';
      if (data.fortune_text && data.fortune_text.dont) data.fortune_text.dont.forEach(x=> dontList.insertAdjacentHTML('beforeend', `<li>${x}</li>`));
    }

    function goHistory(){
      {% if user.is_guest %}
        if (confirm("æŸ¥çœ‹å†å²è®°å½•éœ€è¦ç™»å½•è´¦å·ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ")) {
          window.location.href = "{{ url_for('login', next=url_for('stats') ) }}";
        }
      {% else %}
        window.location.href = "{{ url_for('stats') }}";
      {% endif %}
    }

    function refreshFortune(){
      const today = "{{ today }}";
      const btn = event.target.closest('button'); btn.disabled = true;
      fetch(`{{ url_for('api_fortune', date='') }}${today}`)
        .then(r=>r.json())
        .then(d=>{ if(d.error) alert(d.error); else renderFortune(d); })
        .catch(e=>{ console.error(e); alert('è¿åŠ¿åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•'); })
        .finally(()=>{ btn.disabled=false; });
    }

    // â€”â€” åˆ†äº«å¡ï¼šiframe é¢„è§ˆ&é€šä¿¡ â€”â€”
let shareState = {
  shareId: null,
  shareUrl: null,
  qrCode: null
};

// æ‰“å¼€åˆ†äº«å¼¹å±‚
function openShareOverlay() {
  const data = JSON.parse(document.getElementById('INDEX_DATA').textContent || '{}');
  if (!data.has_drawn) {
    alert('è¯·å…ˆæŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œ');
    return;
  }
  
  // æ˜¾ç¤ºå¼¹å±‚
  document.getElementById('scOverlay').style.display = 'flex';
  
  // åŠ è½½é¢„è§ˆé¡µé¢
  const frame = document.getElementById('shareFrame');
  frame.src = '/share/card?embed=1';
  
  // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåå‘é€æ•°æ®
  frame.onload = function() {
    // å‘é€æ•°æ®åˆ° iframe
    frame.contentWindow.postMessage({
      type: 'share:init',
      data: {
        user_name: data.user_name,
        today: data.today,
        reading: data.reading,
        fortune: data.fortune
      }
    }, '*');
  };
  
  // é‡ç½®çŠ¶æ€
  shareState = { shareId: null, shareUrl: null, qrCode: null };
  document.getElementById('btnCopyLink').style.display = 'none';
}

// å…³é—­åˆ†äº«å¼¹å±‚
function closeShareOverlay() {
  document.getElementById('scOverlay').style.display = 'none';
  document.getElementById('shareFrame').src = 'about:blank';
}

// ç”Ÿæˆåˆ†äº«é“¾æ¥
async function generateShare() {
  const btn = document.getElementById('btnGenShare');
  btn.disabled = true;
  btn.innerHTML = '<span class="loading-spinner"></span>ç”Ÿæˆä¸­...';
  
  try {
    const response = await fetch('/api/share/create', { method: 'POST' });
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');
    }
    
    // ä¿å­˜çŠ¶æ€
    shareState.shareId = data.share_id;
    shareState.shareUrl = data.share_url || 'https://www.ruoshui.fun';
    shareState.qrCode = data.qr_code;
    
    // æ›´æ–° iframe ä¸­çš„äºŒç»´ç 
    const frame = document.getElementById('shareFrame');
    frame.contentWindow.postMessage({
      type: 'share:update',
      qrCode: shareState.qrCode,
      shareUrl: shareState.shareUrl
    }, '*');
    
    // æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®
    document.getElementById('btnCopyLink').style.display = 'inline-block';
    
    btn.innerHTML = 'âœ… å·²ç”Ÿæˆ';
    setTimeout(() => {
      btn.innerHTML = 'âœ¨ ç”Ÿæˆåˆ†äº«é“¾æ¥';
    }, 2000);
    
  } catch (error) {
    alert(error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
    btn.innerHTML = 'âœ¨ ç”Ÿæˆåˆ†äº«é“¾æ¥';
  } finally {
    btn.disabled = false;
  }
}

// å¤åˆ¶åˆ†äº«é“¾æ¥
function copyShareLink() {
  const text = shareState.shareUrl || 'https://www.ruoshui.fun';
  
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(() => {
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
  
  function fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    textarea.remove();
    alert('é“¾æ¥å·²å¤åˆ¶');
  }
}

// ä¿å­˜åˆ†äº«å›¾ç‰‡
async function saveShareImage() {
  const btn = document.getElementById('btnSaveImg');
  
  // å¦‚æœè¿˜æ²¡æœ‰ç”Ÿæˆåˆ†äº«IDï¼Œå…ˆç”Ÿæˆ
  if (!shareState.shareId) {
    await generateShare();
    if (!shareState.shareId) {
      alert('è¯·å…ˆç”Ÿæˆåˆ†äº«é“¾æ¥');
      return;
    }
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="loading-spinner"></span>å¯¼å‡ºä¸­...';
  
  try {
    // å°è¯•æœåŠ¡ç«¯å¯¼å‡º
    const response = await fetch('/api/share/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ share_id: shareState.shareId })
    });
    
    if (response.ok) {
      // æ£€æŸ¥æ˜¯å¦è¿”å›å›¾ç‰‡
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('image')) {
        // æœåŠ¡ç«¯è¿”å›äº†å›¾ç‰‡
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ruoshui_tarot_${Date.now()}.png`;
        a.click();
        URL.revokeObjectURL(url);
        btn.innerHTML = 'âœ… å·²ä¿å­˜';
      } else {
        // æœåŠ¡ç«¯æç¤ºä½¿ç”¨å®¢æˆ·ç«¯æ–¹æ¡ˆ
        const data = await response.json();
        if (data.fallback === 'client') {
          await clientSideExport();
        } else {
          throw new Error(data.error || 'å¯¼å‡ºå¤±è´¥');
        }
      }
    } else {
      // é™çº§åˆ°å®¢æˆ·ç«¯å¯¼å‡º
      await clientSideExport();
    }
    
  } catch (error) {
    console.error('Export error:', error);
    // æœ€åçš„é™çº§ï¼šå®¢æˆ·ç«¯å¯¼å‡º
    await clientSideExport();
  } finally {
    setTimeout(() => {
      btn.innerHTML = 'ğŸ’¾ ä¿å­˜å›¾ç‰‡';
      btn.disabled = false;
    }, 2000);
  }
}

// å®¢æˆ·ç«¯å¯¼å‡ºï¼ˆé™çº§æ–¹æ¡ˆï¼‰
async function clientSideExport() {
  // é€šçŸ¥ iframe å‡†å¤‡å¯¼å‡º
  const frame = document.getElementById('shareFrame');
  
  return new Promise((resolve, reject) => {
    // è®¾ç½®ä¸€æ¬¡æ€§æ¶ˆæ¯ç›‘å¬å™¨
    function handleMessage(event) {
      if (event.data && event.data.type === 'share:export-ready') {
        window.removeEventListener('message', handleMessage);
        
        if (event.data.success && event.data.dataUrl) {
          // ä¸‹è½½å›¾ç‰‡
          const a = document.createElement('a');
          a.href = event.data.dataUrl;
          a.download = `ruoshui_tarot_${Date.now()}.png`;
          a.click();
          resolve();
        } else {
          alert('å®¢æˆ·ç«¯å¯¼å‡ºå¤±è´¥ï¼Œè¯·ä½¿ç”¨æˆªå›¾å·¥å…·');
          reject(new Error('Client export failed'));
        }
      }
    }
    
    window.addEventListener('message', handleMessage);
    
    // å‘é€å¯¼å‡ºè¯·æ±‚åˆ° iframe
    frame.contentWindow.postMessage({ type: 'share:export' }, '*');
    
    // è¶…æ—¶å¤„ç†
    setTimeout(() => {
      window.removeEventListener('message', handleMessage);
      alert('å¯¼å‡ºè¶…æ—¶ï¼Œè¯·ä½¿ç”¨æˆªå›¾å·¥å…·');
      reject(new Error('Export timeout'));
    }, 10000);
  });
}

// ç»‘å®šäº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
  // åˆ†äº«æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  document.getElementById('openShareBtn')?.addEventListener('click', openShareOverlay);
  document.getElementById('fabShare')?.addEventListener('click', function() {
    if (!this.classList.contains('disabled')) {
      openShareOverlay();
    }
  });
});

</script>
<script>
  // 1) iOS è§†å£é«˜åº¦ä¿®å¤ï¼šè®¡ç®— --vh å•ä½
  (function fixIOSVh(){
    const setVh = () => {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    };
    setVh();
    window.addEventListener('resize', setVh);
    window.addEventListener('orientationchange', setVh);
  })();

  // 2) PWAï¼šæ³¨å†Œ Service Workerï¼ˆå¯é€‰ï¼Œä½†å¼ºçƒˆå»ºè®®ï¼‰
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(()=>{ /* é™é»˜å¤±è´¥å³å¯ */ });
    });
  }

  // 3) ç‹¬ç«‹æ¨¡å¼æ£€æµ‹ï¼ˆiOSï¼šnavigator.standaloneï¼›å…¶ä»–ï¼šdisplay-modeï¼‰
  (function detectStandalone(){
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (isStandalone) {
      document.documentElement.classList.add('standalone');
      // ä½ å¯ä»¥åœ¨è¿™é‡Œåšäº›ä»…ä¸»å±æ¨¡å¼ä¸‹çš„ UI å¾®è°ƒï¼ˆå¦‚éšè—é¡µè„šç­‰ï¼‰
      // document.querySelector('.footer')?.classList.add('hidden');
    }
  })();
</script>

</body>
</html>
