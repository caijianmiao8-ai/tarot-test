<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯æ—¥å¡”ç½—è¿åŠ¿ Â· è‹¥æ°´å åœ</title>

  <!-- æœ¬åœ° Bootstrap / FontAwesome -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">
  <!-- å­—ä½“ï¼ˆå¯æŒ‰éœ€ä¿ç•™/æœ¬åœ°åŒ–ï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#9d7ea8; --secondary:#6d5675; --accent:#8e6c88;
      --gold:#e8d4a2; --gold-light:#f4e5c3;
      --bg-deep-1:#271b44; --bg-deep-2:#171427;

      --text:#ffffff; --text-strong:#fff;
      --text-light:rgba(255,255,255,.9);
      --text-muted:rgba(255,255,255,.68);

      --panel:rgba(255,255,255,.06);
      --panel-2:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.12);

      --star-color:#ffd700;
      --success-color:#10b981;
      --warning-color:#f59e0b;
      --danger-color:#ef4444;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Noto Serif SC',-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      color:var(--text);
      min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px;
      background:
        radial-gradient(1200px 700px at 18% 8%, rgba(157,126,168,.16), transparent 60%),
        radial-gradient(1200px 700px at 82% 92%, rgba(232,212,162,.10), transparent 60%),
        linear-gradient(135deg, var(--bg-deep-1) 0%, var(--bg-deep-2) 100%);
      position:relative; overflow-x:hidden;
    }

    /* èƒŒæ™¯åŠ¨æ•ˆå±‚ï¼ˆä½é¥±å’Œåº¦ï¼‰ */
    .bg-cosmos{ position:fixed; inset:0; z-index:-2; pointer-events:none; }
    .bg-stars{
      position:absolute; inset:0; opacity:.22;
      background-image:
        radial-gradient(1px 1px at 12% 25%, #fff, transparent),
        radial-gradient(1px 1px at 32% 60%, #fff, transparent),
        radial-gradient(1px 1px at 62% 30%, #fff, transparent),
        radial-gradient(1px 1px at 82% 70%, #fff, transparent),
        radial-gradient(1px 1px at 22% 80%, #fff, transparent);
      background-size:220px 220px;
      animation:twinkle 4s ease-in-out infinite alternate;
    }
    @keyframes twinkle{from{opacity:.12}to{opacity:.32}}
    .zodiac-ring{
      position:absolute; width:820px; height:820px; left:50%; top:50%;
      transform:translate(-50%,-50%); opacity:.10; filter:drop-shadow(0 0 18px rgba(255,255,255,.12));
      animation:slow-rotate 90s linear infinite;
    }
    @keyframes slow-rotate{to{transform:translate(-50%,-50%) rotate(360deg)}}
    .bg-glow{
      position:absolute; inset:-10%;
      background:
        radial-gradient(600px 600px at 20% 10%, rgba(157,126,168,.12), transparent 60%),
        radial-gradient(600px 600px at 80% 90%, rgba(232,212,162,.10), transparent 60%);
      filter:blur(36px); animation:float 18s ease-in-out infinite alternate;
    }
    @keyframes float{from{transform:translateY(-1%)}to{transform:translateY(1%)}}

    /* é¡¶éƒ¨ç”¨æˆ·æ  */
    .user-bar{
      position:fixed; top:0; left:0; right:0; z-index:100;
      background:rgba(28,22,40,.58); backdrop-filter:blur(10px); border-bottom:1px solid var(--border);
    }
    .user-bar-content{
      max-width:1200px; margin:0 auto; padding:10px 20px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .user-info{ display:flex; align-items:center; gap:12px; }
    .user-icon{
      width:36px; height:36px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff; font-weight:700; border:1px solid var(--border); box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    .user-name{ color:var(--gold-light); font-weight:600; letter-spacing:.5px; }
    .user-actions{ display:flex; gap:10px; }
    .user-actions a{
      color:var(--text-light); text-decoration:none; font-size:.95rem;
      padding:8px 14px; border-radius:18px; border:1px solid transparent;
      transition:.25s ease; background:rgba(255,255,255,.06); backdrop-filter:blur(8px);
    }
    .user-actions a:hover{ color:#fff; border-color:var(--border); transform:translateY(-1px); }

    /* flash */
    .flash-messages{ position:fixed; top:68px; right:20px; z-index:200; max-width:380px; }
    .alert{
      padding:12px 14px; margin-bottom:10px; border-radius:10px; display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 6px 18px rgba(0,0,0,.18); color:#fff; border:none; animation:slideIn .3s ease-out; backdrop-filter:blur(6px);
    }
    .alert-success{ background:rgba(16,185,129,.9) }
    .alert-info{ background:rgba(59,130,246,.9) }
    .alert-error{ background:rgba(239,68,68,.9) }
    .alert .close{ background:none; border:none; color:#fff; font-size:1.4rem; opacity:.85; }
    .alert .close:hover{ opacity:1 }
    @keyframes slideIn{ from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }

    /* ä¸»å®¹å™¨ */
    .main-container{ max-width:980px; width:100%; margin:88px auto 24px; }

    /* æŠ½ç‰Œå®¹å™¨ */
    .tarot-container{
      position:relative; overflow:hidden; margin-bottom:30px;
      padding:28px; border-radius:22px; background:var(--panel); border:1px solid var(--border);
      box-shadow:0 18px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08);
    }
    .tarot-container::before{
      content:""; position:absolute; inset:-2px;
      background: radial-gradient(500px 300px at -5% -5%, rgba(157,126,168,.16), transparent 50%),
                  radial-gradient(500px 300px at 105% 105%, rgba(232,212,162,.10), transparent 50%);
      filter:blur(6px); z-index:-1;
    }
    .header h1{
      font-size:2.2rem; color:var(--gold-light); letter-spacing:1px;
      text-shadow:0 2px 8px rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .header h1 i{ color:var(--gold-light) }
    .header p{ color:var(--text-muted); text-align:center; margin-top:6px; }

    .tarot-card{
      width:220px; height:340px; margin:24px auto 10px; border-radius:14px; overflow:hidden; position:relative;
      background:linear-gradient(135deg, rgba(157,126,168,.32), rgba(232,212,162,.18));
      border:1px solid var(--border); box-shadow:0 12px 30px rgba(0,0,0,.28);
      transform-style:preserve-3d; transition:transform .8s cubic-bezier(.175,.885,.32,1.275), box-shadow .35s ease; cursor:pointer;
    }
    .tarot-card:hover{ transform:translateY(-6px) rotate(3deg); box-shadow:0 16px 36px rgba(0,0,0,.34); }
    .tarot-card::after{ content:""; position:absolute; inset:14px; border-radius:10px; border:1px solid rgba(255,255,255,.22); }

    .action-section{ margin:16px 0 6px; text-align:center; }
    .btn-tarot{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:13px 28px; border-radius:24px; border:1px solid var(--border);
      background:linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff; font-weight:700; letter-spacing:.4px; box-shadow:0 10px 24px rgba(157,126,168,.32);
      text-decoration:none; transition:.3s;
    }
    .btn-tarot:hover{ transform:translateY(-2px); box-shadow:0 14px 28px rgba(157,126,168,.42); color:#fff; }
    .btn-tarot:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .already-drawn{
      display:inline-flex; align-items:center; gap:8px; padding:11px 22px; border-radius:22px; color:#fff; text-decoration:none;
      background:linear-gradient(135deg, var(--primary), var(--secondary)); border:1px solid var(--border); box-shadow:0 10px 24px rgba(157,126,168,.32);
      transition:.3s;
    }
    .already-drawn:hover{ transform:translateY(-1px); box-shadow:0 14px 28px rgba(157,126,168,.42); color:#fff; }

    .guest-tip{
      max-width:520px; margin:12px auto 0; padding:12px 14px; border-radius:12px;
      background:var(--panel); border:1px solid var(--border); color:var(--text-light);
    }

    /* è¿åŠ¿å¡ç‰‡ */
    .fortune-card{
      background:var(--panel); border:1px solid var(--border); border-radius:22px; padding:0;
      box-shadow:0 16px 36px rgba(0,0,0,.28); overflow:hidden; display:none;
    }
    .fortune-header{
      background:linear-gradient(135deg, rgba(157,126,168,.26), rgba(232,212,162,.14));
      color:var(--text); padding:26px; text-align:center; position:relative; overflow:hidden; border-bottom:1px solid var(--border);
    }
    .fortune-header::before{ content:''; position:absolute; width:340px; height:340px; top:-120px; right:-40px; background:rgba(255,255,255,.08); border-radius:50%; }
    .fortune-header::after{ content:''; position:absolute; width:240px; height:240px; bottom:-120px; left:-40px; background:rgba(255,255,255,.05); border-radius:50%; }
    .fortune-date{ font-size:.95rem; color:var(--text-muted); margin-bottom:6px; }
    .fortune-score{ font-size:3.8rem; font-weight:800; letter-spacing:1px; color:var(--gold-light); text-shadow:0 2px 10px rgba(0,0,0,.22); display:inline-block; }
    .fortune-score::after{ content:'åˆ†'; font-size:1.2rem; font-weight:400; margin-left:6px; color:var(--text-light); }
    .fortune-label{ margin-top:10px; display:inline-block; padding:6px 18px; border-radius:18px; background:rgba(255,255,255,.16); color:var(--text); font-weight:700; letter-spacing:.8px; border:1px solid var(--border); }
    .fortune-summary{ font-size:1rem; line-height:1.7; color:var(--text-muted); max-width:680px; margin:10px auto 0; }

    .dimensions-section{ padding:24px; background:rgba(0,0,0,.08); }
    .section-title{ font-size:1.2rem; color:var(--gold-light); text-align:center; margin-bottom:16px; font-weight:700; }
    .dimensions-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(150px,1fr)); gap:14px; margin-bottom:20px; }
    .dimension-item{
      background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; text-align:center;
      box-shadow:0 4px 12px rgba(0,0,0,.12); transition:.25s ease;
    }
    .dimension-item:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.16); }
    .dimension-icon{
      width:42px; height:42px; border-radius:12px; margin:0 auto 8px; background:linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff; display:flex; align-items:center; justify-content:center; font-size:1.1rem; border:1px solid var(--border);
    }
    .dimension-name{ font-weight:700; color:var(--text); margin-bottom:6px; }
    .dimension-stars{ font-size:1.05rem; color:var(--star-color); letter-spacing:2px; margin-bottom:4px; }
    .dimension-level{ font-size:.9rem; color:var(--text-muted); background:rgba(255,255,255,.08); border:1px solid var(--border); border-radius:12px; display:inline-block; padding:4px 10px; }

    .advice-grid{ display:grid; gap:10px; }
    .advice-item{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px 15px; display:flex; align-items:center; gap:12px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
    .advice-icon{ width:34px; height:34px; border-radius:10px; background:rgba(255,255,255,.12); display:flex; align-items:center; justify-content:center; color:var(--gold-light); }
    .advice-name{ font-weight:700; color:var(--text); font-size:.95rem; margin-bottom:2px; }
    .advice-text{ color:var(--text-muted); font-size:.95rem; line-height:1.5; }

    .bottom-section{ padding:24px; display:grid; grid-template-columns:1fr 1.5fr; gap:22px; }
    .lucky-section{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; }
    .lucky-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .lucky-item{ background:rgba(255,255,255,.08); border:1px solid var(--border); border-radius:12px; text-align:center; padding:10px; }
    .lucky-label{ font-size:.88rem; color:var(--text-muted); margin-bottom:4px; }
    .lucky-value{ font-weight:700; color:var(--gold-light); font-size:1.06rem; }

    .suggestions-section{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .suggestion-card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; }
    .suggestion-header{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .suggestion-icon{ width:30px; height:30px; border-radius:8px; color:#fff; display:flex; align-items:center; justify-content:center; }
    .suggestion-do .suggestion-icon{ background:var(--success-color) }
    .suggestion-dont .suggestion-icon{ background:var(--danger-color) }
    .suggestion-title{ font-weight:700; font-size:1.02rem; }
    .suggestion-list{ list-style:none; margin:0; padding:0; }
    .suggestion-list li{ padding:6px 0 6px 22px; position:relative; color:var(--text-muted); }
    .suggestion-list li::before{ content:'â€¢'; position:absolute; left:8px; top:2px; font-weight:700; }
    .suggestion-do li::before{ color:var(--success-color) }
    .suggestion-dont li::before{ color:var(--danger-color) }

    .action-bar{ padding:16px; text-align:center; background:var(--panel); border-top:1px solid var(--border); }
    .btn-refresh{
      padding:11px 20px; border-radius:20px; border:1px solid var(--border);
      background:linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; font-weight:700;
      box-shadow:0 6px 16px rgba(157,126,168,.3); transition:.25s ease;
    }
    .btn-refresh:hover{ transform:translateY(-2px); box-shadow:0 10px 22px rgba(157,126,168,.4); color:#fff; }
    .btn-ai-chat{
      margin-left:10px; padding:11px 20px; border-radius:20px; border:1px solid var(--border);
      background:linear-gradient(135deg, var(--secondary), var(--primary)); color:#fff; font-weight:700;
      text-decoration:none; display:inline-block; transition:.25s ease;
    }
    .btn-ai-chat:hover{ transform:translateY(-2px); box-shadow:0 10px 22px rgba(157,126,168,.4); color:#fff; }

    /* å³ä¸‹è§’æ‚¬æµ®åˆ†äº«æŒ‰é’®ï¼ˆå¯é€‰ï¼‰ */
    .fab-share{
      position:fixed; right:20px; bottom:20px; z-index:300; width:56px; height:56px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; color:#fff; cursor:pointer; border:1px solid var(--border);
      background:linear-gradient(135deg, var(--primary), var(--secondary)); box-shadow:0 12px 26px rgba(157,126,168,.32); transition:.25s ease;
    }
    .fab-share:hover{ transform:translateY(-2px); box-shadow:0 16px 30px rgba(157,126,168,.42) }
    .fab-share.disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }
    .fab-tip{
      position:absolute; right:70px; bottom:18px; padding:8px 12px; border-radius:10px;
      background:rgba(255,255,255,.08); border:1px solid var(--border); color:var(--text-light);
      backdrop-filter:blur(8px); white-space:nowrap; font-size:.9rem;
    }

    /* è½»é‡åˆ†äº«å¡ Overlayï¼ˆiframe æ–¹æ¡ˆï¼‰ */
    .sc-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:500; }
    .sc-mask{ position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter:blur(3px); }
    .sc-panel{
      position:relative; z-index:1; padding:14px; border-radius:18px; background:var(--panel);
      border:1px solid var(--border); box-shadow:0 18px 42px rgba(0,0,0,.38);
      display:flex; flex-direction:column; align-items:center; gap:10px; max-width:96vw; max-height:96vh;
    }
    .sc-close{
      position:absolute; right:10px; top:10px; width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      cursor:pointer; color:#fff; background:rgba(255,255,255,.08); border:1px solid var(--border);
    }

    /* å“åº” */
    @media (max-width:768px){
      .main-container{ margin-top:74px; }
      .bottom-section{ grid-template-columns:1fr; }
      .suggestions-section{ grid-template-columns:1fr; }
      .dimensions-grid{ grid-template-columns:repeat(auto-fit, minmax(120px,1fr)); }
      .fortune-score{ font-size:3.2rem; }
      .lucky-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <!-- èƒŒæ™¯å±‚ -->
  <div class="bg-cosmos" aria-hidden="true">
    <div class="bg-stars"></div>
    <svg class="zodiac-ring" viewBox="0 0 100 100">
      <g fill="none" stroke="#fff" stroke-opacity=".7" stroke-width=".3">
        <circle cx="50" cy="50" r="44"/>
        <circle cx="50" cy="50" r="34" stroke-opacity=".4"/>
        <g stroke-opacity=".25">
          <line x1="50" y1="6" x2="50" y2="94"/>
          <line x1="6" y1="50" x2="94" y2="50"/>
          <line x1="18" y1="18" x2="82" y2="82"/>
          <line x1="18" y1="82" x2="82" y2="18"/>
        </g>
      </g>
      <g fill="#fff" fill-opacity=".55" font-size="6" font-family="serif">
        <text x="50" y="10" text-anchor="middle">â™ˆï¸â™‰ï¸â™Šï¸â™‹ï¸â™Œï¸â™ï¸â™ï¸â™ï¸â™ï¸â™‘ï¸â™’ï¸â™“ï¸</text>
      </g>
    </svg>
    <div class="bg-glow"></div>
  </div>

  <!-- é¡¶éƒ¨ç”¨æˆ·æ  -->
  <div class="user-bar">
    <div class="user-bar-content">
      <div class="user-info">
        <div class="user-icon">
          {% if not user.is_guest %}{{ user.username[0]|upper }}{% else %}<i class="fas fa-user"></i>{% endif %}
        </div>
        <span class="user-name">{{ user.username if not user.is_guest else "ç¥ç§˜è®¿å®¢" }}</span>
      </div>
      <div class="user-actions">
        {% if user.is_guest %}
          <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> ç™»å½•</a>
          <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> æ³¨å†Œ</a>
        {% else %}
          <a href="{{ url_for('stats') }}"><i class="fas fa-chart-line"></i> ç»Ÿè®¡</a>
          <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Flash æ¶ˆæ¯ -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            <span>{{ message }}</span>
            <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ä¸»å®¹å™¨ -->
  <div class="main-container">
    <!-- æŠ½ç‰ŒåŒº -->
    <div class="tarot-container">
      <div class="header">
        <h1><i class="fas fa-star"></i> æ¯æ—¥å¡”ç½—è¿åŠ¿ <i class="fas fa-star"></i></h1>
        <p>æ¢ç´¢å®‡å®™çš„å¥¥ç§˜ï¼Œæ­ç¤ºä»Šæ—¥çš„æŒ‡å¼•</p>
      </div>

      <div class="tarot-card" id="tarot-card-display">
        {% if today_card %}
          {% if today_card.image %}
            <img src="{{ today_card.image }}" alt="{{ today_card.name }}" style="width:100%;height:100%;object-fit:cover;border-radius:14px;">
            <div class="card-info" style="position:absolute;left:0;right:0;bottom:0;padding:16px;border-radius:0 0 14px 14px;background:linear-gradient(to top, rgba(0,0,0,.65), transparent);color:#fff;">
              <div style="font-weight:700;font-size:1.08rem;text-shadow:0 2px 6px rgba(0,0,0,.4);">{{ today_card.name }}</div>
              <div style="font-size:.92rem;opacity:.92;margin-top:4px;">{{ today_card.direction }}</div>
            </div>
          {% else %}
            <div style="text-align:center;padding:24px;color:var(--text-light);">
              <i class="fas fa-sun" style="font-size:3rem;margin-bottom:14px;color: var(--gold-light)"></i>
              <div style="font-weight:700;font-size:1.1rem;color:#fff;margin-bottom:6px;">{{ today_card.name }}</div>
              <div style="font-size:.95rem;color:var(--text-muted)">{{ today_card.direction }}</div>
            </div>
          {% endif %}
        {% else %}
          <i class="fas fa-question" style="color:var(--text-muted);font-size:2rem;"></i>
        {% endif %}
      </div>

      {% if user.is_guest and not has_drawn %}
        <div class="guest-tip"><i class="fas fa-info-circle"></i>
          <span>ä½œä¸ºè®¿å®¢ï¼Œè§£è¯»ä»…åœ¨æœ¬æ¬¡æµè§ˆæœ‰æ•ˆã€‚<a href="{{ url_for('register') }}" style="color: var(--gold-light); text-decoration: underline;">æ³¨å†Œè´¦å·</a>å¯ä¿å­˜å†å²è®°å½•ã€‚</span>
        </div>
      {% endif %}

      <div class="action-section">
        {% if has_drawn %}
          <a href="{{ url_for('result') }}" class="already-drawn"><i class="fas fa-eye"></i> æŸ¥çœ‹ä»Šæ—¥å¡”ç½—è§£è¯»</a>
          <div style="margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background:linear-gradient(135deg,#4a6fa5,#2e4578);">
              <i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ
            </a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot">
              <i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ
            </a>
          </div>
          <div class="info-text" style="margin-top:8px;color:var(--text-muted)">æ‚¨ä»Šå¤©å·²ç»æŠ½å–è¿‡å¡”ç½—ç‰Œäº†</div>
        {% else %}
          <form id="draw-form" action="{{ url_for('draw_card') }}" method="post">
            <button type="submit" class="btn-tarot" id="draw-btn"><i class="fas fa-hand-sparkles"></i> æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œ</button>
          </form>
          <div style="margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background:#6c757d;">
              <i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ
            </a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot">
              <i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ
            </a>
          </div>
          <div class="info-text" style="margin-top:8px;color:var(--text-muted)">ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œï¼Œæˆ–ç›´æ¥è¿›å…¥ç‰Œé˜µå åœ</div>
        {% endif %}
      </div>
    </div>

    <!-- è¿åŠ¿å¡ç‰‡ -->
    <div id="fortune-card" class="fortune-card">
      <div class="fortune-header">
        <div class="fortune-date">{{ today }} Â· ä»Šæ—¥è¿åŠ¿</div>
        <div class="fortune-score" id="overall-score">-</div>
        <div class="fortune-label" id="overall-label">-</div>
        <div class="fortune-summary" id="fortune-summary-text"></div>
      </div>

      <div class="dimensions-section">
        <h3 class="section-title">äº”ç»´åº¦è¿åŠ¿æŒ‡æ•°</h3>
        <div class="dimensions-grid" id="dimensions-grid"></div>
        <div class="advice-grid" id="advice-grid"></div>
      </div>

      <div class="bottom-section">
        <div class="lucky-section">
          <h3 class="section-title" style="margin-bottom:12px;">ä»Šæ—¥å¹¸è¿å…ƒç´ </h3>
          <div class="lucky-grid" id="lucky-grid"></div>
        </div>
        <div class="suggestions-section">
          <div class="suggestion-card suggestion-do">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-check"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å®œåš</div>
            </div>
            <ul class="suggestion-list" id="do-list"></ul>
          </div>
          <div class="suggestion-card suggestion-dont">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-times"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å¿Œåš</div>
            </div>
            <ul class="suggestion-list" id="dont-list"></ul>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn-refresh" onclick="refreshFortune()"><i class="fas fa-sync-alt"></i> åˆ·æ–°è¿åŠ¿</button>
        {% if has_drawn %}
          <a href="{{ url_for('chat_page') }}" class="btn-ai-chat"><i class="fas fa-comments"></i> AI æ·±åº¦è§£è¯»</a>
          <!-- å¼¹å±‚æ–¹å¼æ‰“å¼€åˆ†äº«å¡ -->
          <button type="button" class="btn-ai-chat" id="openShareBtn"><i class="fas fa-share-alt"></i> ç”Ÿæˆåˆ†äº«å¡ç‰‡</button>
        {% endif %}
      </div>
    </div>

    <!-- åŠŸèƒ½åŒº -->
    <div class="features" style="display:flex;justify-content:space-around;flex-wrap:wrap;margin:28px 0;gap:12px;">
      <a class="feature" onclick="goHistory()" style="flex:0 0 30%;min-width:220px;padding:18px;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.14);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-moon" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.15rem;color:#fff;margin-bottom:6px;">æ¯æ—¥æŒ‡å¼•</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">æ¯å¤©æŠ½å–ä¸€å¼ å¡”ç½—ç‰Œï¼Œè·å–ä¸“å±ä»Šæ—¥çš„å®‡å®™æŒ‡å¼•</p>
      </a>
      <a class="feature" href="{{ url_for('guide_spread') }}" style="flex:0 0 30%;min-width:220px;padding:18px;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.14);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-magic" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.15rem;color:#fff;margin-bottom:6px;">å¼•å¯¼é€‰æ‹©ç‰Œé˜µ</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">åƒå’Œå åœå¸ˆèŠå¤©ä¸€æ ·ï¼Œç”±ç³»ç»Ÿå¼•å¯¼é€‰æ‹©æœ€åˆé€‚çš„ç‰Œé˜µ</p>
      </a>
      <a class="feature" onclick="goHistory()" style="flex:0 0 30%;min-width:220px;padding:18px;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.14);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-history" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.15rem;color:#fff;margin-bottom:6px;">å†å²è®°å½•</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">{{ 'æŸ¥çœ‹æ‚¨çš„æŠ½å¡è®°å½•å’Œè¿åŠ¿è¶‹åŠ¿' if not user.is_guest else 'æ³¨å†Œåå¯ä¿å­˜å†å²è®°å½•' }}</p>
      </a>
    </div>

    <div class="footer" style="text-align:center;color:var(--text-muted);font-size:.95rem;margin-top:4px;">
      Â© 2025 å¡”ç½—è¿åŠ¿ | å®‡å®™èƒ½é‡ï¼Œæ™ºæ…§æŒ‡å¼•<br>
      <small style="opacity:.7;">æ¯æ—¥å‡Œæ™¨é‡ç½®ï¼ŒåŸºäºåŒ—äº¬æ—¶é—´</small>
    </div>
  </div>

  <!-- å³ä¸‹è§’æ‚¬æµ®åˆ†äº« -->
  <div class="fab-share {% if not has_drawn %}disabled{% endif %}" id="fabShare" title="ç”Ÿæˆåˆ†äº«å¡ç‰‡">
    <i class="fas fa-share-alt"></i>
    <div class="fab-tip">ç”Ÿæˆåˆ†äº«å¡ç‰‡</div>
  </div>

  <!-- è½»é‡åˆ†äº«å¡ Overlayï¼ˆiframe æ–¹æ¡ˆï¼‰ -->
  <div class="sc-overlay" id="scOverlay" aria-modal="true" role="dialog">
    <div class="sc-mask" id="scMask"></div>
    <div class="sc-panel">
      <button class="sc-close" id="scClose"><i class="fas fa-times"></i></button>
      <iframe id="scFrame"
              src="{{ url_for('share_card') }}?embed=1"
              title="åˆ†äº«å¡é¢„è§ˆ"
              style="width:min(400px,90vw);height:min(711px,90vh);border:0;border-radius:20px;overflow:hidden;background:transparent;"
              allowtransparency="true"></iframe>
      <div style="display:flex;gap:10px;margin-top:4px;">
        <button class="btn" id="scBtnGen" style="padding:10px 18px;border-radius:20px;border:1px solid var(--border);background:linear-gradient(135deg, var(--primary), var(--secondary));color:#fff;box-shadow:0 4px 12px rgba(157,126,168,.3);">âœ¨ ç”Ÿæˆåˆ†äº«</button>
        <button class="btn ghost hidden" id="scBtnCopy" style="padding:10px 18px;border-radius:20px;border:1px solid var(--border);background:rgba(255,255,255,.1);backdrop-filter:blur(10px);color:#fff;">ğŸ”— å¤åˆ¶é“¾æ¥</button>
        <button class="btn ghost" id="scBtnSave" style="padding:10px 18px;border-radius:20px;border:1px solid var(--border);background:rgba(255,255,255,.1);backdrop-filter:blur(10px);color:#fff;">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
      </div>
    </div>
  </div>

  <!-- æ•°æ®æ³¨å…¥ï¼ˆé¦–é¡µ + åˆ†äº«å¡å…±ç”¨ï¼‰ -->
  <script id="INDEX_DATA" type="application/json">
    {
      "user_name": "{{ user.username if not user.is_guest else 'ç¥ç§˜è®¿å®¢' }}",
      "today": "{{ today }}",
      "has_drawn": {{ 'true' if has_drawn else 'false' }},
      "reading": {{ (today_card or {})|tojson }},
      "fortune": {{ (fortune_data or {})|tojson }}
    }
  </script>

  <script>
    /* ===== å·¥å…· ===== */
    const $ = (id)=>document.getElementById(id);
    function generateStars(rating){ const full=Math.floor(rating||0); let s=''; for(let i=0;i<5;i++) s+= (i<full)?'â˜…':'â˜†'; return s; }
    function labelScore(s){ s=Number(s)||0; if(s>=85)return'å¤§å‰'; if(s>=70)return'ä¸­å‰'; if(s>=55)return'å°å‰'; return'å¹³' }

    /* æ˜ å°„ */
    const dimensionIcons = {
      "äº‹ä¸šè¿":"fas fa-briefcase","è´¢å¯Œè¿":"fas fa-coins","çˆ±æƒ…è¿":"fas fa-heart","å¥åº·è¿":"fas fa-heartbeat","è´µäººè¿":"fas fa-hands-helping"
    };

    document.addEventListener('DOMContentLoaded', ()=>{
      const data = JSON.parse($('INDEX_DATA').textContent || '{}');
      if (data.fortune && Object.keys(data.fortune).length>0) renderFortune(data.fortune);

      // æŠ½ç‰Œä»ªå¼æ„Ÿ
      document.getElementById('draw-form')?.addEventListener('submit', function(e){
        e.preventDefault();
        const btn = document.getElementById('draw-btn'); btn.disabled = true;
        setTimeout(()=>this.submit(), 900 + Math.random()*900);
      });

      // åˆ†äº«å¡å…¥å£ï¼ˆæŒ‰é’®+æ‚¬æµ®æ°”æ³¡ï¼‰
      const openShare = ()=>{
        if(!data.has_drawn){ alert('è¯·å…ˆæŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œ'); return; }
        openShareOverlay({
          user_name: data.user_name,
          date: data.today,
          reading: data.reading || {},
          fortune: data.fortune || {}
        });
      };
      $('openShareBtn')?.addEventListener('click', openShare);
      $('fabShare')?.addEventListener('click', ()=>{ if(!$('fabShare').classList.contains('disabled')) openShare(); });
    });

    function renderFortune(d){
      $('fortune-card').style.display = 'block';
      $('overall-score').textContent = d.overall_score || '-';
      $('overall-label').textContent = d.overall_label || '-';
      const summaryText = (d.fortune_text && d.fortune_text.summary) || d.summary || '';
      $('fortune-summary-text').textContent = summaryText;

      const grid = $('dimensions-grid'); grid.innerHTML='';
      if (d.dimensions && Array.isArray(d.dimensions)) {
        d.dimensions.forEach(dim=>{
          const stars = generateStars(dim.stars || 3);
          const icon = dimensionIcons[dim.name] || 'fas fa-star';
          grid.insertAdjacentHTML('beforeend', `
            <div class="dimension-item">
              <div class="dimension-icon"><i class="${icon}"></i></div>
              <div class="dimension-name">${dim.name}</div>
              <div class="dimension-stars">${stars}</div>
              <div class="dimension-level">${dim.level || 'â€”'}</div>
            </div>`);
        });
      }

      const adviceGrid = $('advice-grid'); adviceGrid.innerHTML='';
      if (d.fortune_text && d.fortune_text.dimension_advice) {
        Object.entries(d.fortune_text.dimension_advice).forEach(([name, advice])=>{
          const icon = dimensionIcons[name] || 'fas fa-star';
          adviceGrid.insertAdjacentHTML('beforeend', `
            <div class="advice-item">
              <div class="advice-icon"><i class="${icon}"></i></div>
              <div class="advice-content">
                <div class="advice-name">${name}</div>
                <div class="advice-text">${advice}</div>
              </div>
            </div>`);
        });
      }

      const luckyGrid = $('lucky-grid'); luckyGrid.innerHTML='';
      if (d.lucky_elements) {
        if (Array.isArray(d.lucky_elements)) {
          d.lucky_elements.forEach(item=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item">
                <div class="lucky-label">${item.name}</div>
                <div class="lucky-value">${item.value}</div>
              </div>`);
          });
        } else if (typeof d.lucky_elements === 'object') {
          const map = {'color':'å¹¸è¿é¢œè‰²','number':'å¹¸è¿æ•°å­—','hour':'å¹¸è¿æ—¶è¾°','direction':'å¹¸è¿æ–¹ä½'};
          Object.entries(d.lucky_elements).forEach(([k,v])=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item">
                <div class="lucky-label">${map[k]||k}</div>
                <div class="lucky-value">${v}</div>
              </div>`);
          });
        }
      }

      const doList = $('do-list'); doList.innerHTML='';
      if (d.fortune_text && d.fortune_text.do) d.fortune_text.do.forEach(x=> doList.insertAdjacentHTML('beforeend', `<li>${x}</li>`));
      const dontList = $('dont-list'); dontList.innerHTML='';
      if (d.fortune_text && d.fortune_text.dont) d.fortune_text.dont.forEach(x=> dontList.insertAdjacentHTML('beforeend', `<li>${x}</li>`));
    }

    function goHistory(){
      {% if user.is_guest %}
        if(confirm("æŸ¥çœ‹å†å²è®°å½•éœ€è¦ç™»å½•è´¦å·ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ")){
          window.location.href = "{{ url_for('login', next=url_for('stats') ) }}";
        }
      {% else %}
        window.location.href = "{{ url_for('stats') }}";
      {% endif %}
    }

    function refreshFortune(){
      const today = "{{ today }}";
      const btn = event.target.closest('button'); btn.disabled = true;
      fetch(`{{ url_for('api_fortune', date='') }}${today}`)
        .then(r=>r.json())
        .then(d=>{ if(d.error) alert(d.error); else renderFortune(d); })
        .catch(e=>{ console.error(e); alert('è¿åŠ¿åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•'); })
        .finally(()=>{ btn.disabled=false; });
    }

    /* ===== iframe å¼¹å±‚ï¼ˆæ–¹æ¡ˆCï¼‰ ===== */
    const origin = location.origin;
    function openShareOverlay(payload){
      const overlay = $('scOverlay'); const frame = $('scFrame');
      overlay.style.display = 'flex';

      const send = ()=> frame.contentWindow.postMessage({ type:'ruoshui:render', payload }, origin);
      if (frame.contentDocument && frame.contentDocument.readyState === 'complete') send();
      else frame.onload = send;
    }
    function closeShareOverlay(){ $('scOverlay').style.display = 'none'; }
    $('scMask')?.addEventListener('click', closeShareOverlay);
    $('scClose')?.addEventListener('click', closeShareOverlay);

    // æ“ä½œæŒ‰é’®ï¼šç”Ÿæˆ / ä¿å­˜ / å¤åˆ¶
    $('scBtnGen')?.addEventListener('click', ()=> $('scFrame').contentWindow.postMessage({ type:'ruoshui:generate' }, origin));
    $('scBtnSave')?.addEventListener('click', ()=> $('scFrame').contentWindow.postMessage({ type:'ruoshui:export' }, origin));
    $('scBtnCopy')?.addEventListener('click', ()=>{
      const url = $('scBtnCopy').getAttribute('data-share') || 'https://www.ruoshui.fun';
      (navigator.clipboard? navigator.clipboard.writeText(url) : Promise.reject())
        .then(()=>alert('é“¾æ¥å·²å¤åˆ¶'))
        .catch(()=>{ const ta=document.createElement('textarea'); ta.value=url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('é“¾æ¥å·²å¤åˆ¶'); });
    });

    // æ¥æ”¶åˆ†äº«é¡µå›ä¼ 
    window.addEventListener('message', (evt)=>{
      if (evt.origin !== origin && evt.origin !== 'null') return;
      const { type, shareUrl, dataURL } = evt.data || {};
      if (type === 'ruoshui:generate:done') {
        $('scBtnCopy').classList.remove('hidden');
        $('scBtnCopy').setAttribute('data-share', shareUrl || 'https://www.ruoshui.fun');
      } else if (type === 'ruoshui:generate:error') {
        alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } else if (type === 'ruoshui:export:done') {
        const a = document.createElement('a'); a.href = dataURL; a.download = `ruoshui_tarot_${Date.now()}.png`; a.click();
      }
    });

    /* Flash è‡ªåŠ¨æ·¡å‡º */
    setTimeout(()=>{
      (document.querySelectorAll('.alert')||[]).forEach(el=>{
        el.style.transition='transform .3s ease, opacity .3s ease';
        el.style.transform='translateX(120%)'; el.style.opacity='0';
        setTimeout(()=> el.remove(), 320);
      });
    }, 5000);
  </script>
</body>
</html>
