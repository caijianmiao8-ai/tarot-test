<!DOCTYPE html>
<html lang="zh-CN">
<head>
  {% include 'partials/_meta_pwa.html' %}
  {% block title %}<title>æ¯æ—¥å¡”ç½—è¿åŠ¿ Â· è‹¥æ°´å åœ</title>{% endblock %}

  <!-- é¡µé¢ä¸“å±æ ·å¼ï¼šä¿ç•™ä½ åŸæœ‰è§†è§‰ï¼ˆå¿…è¦çš„éƒ¨åˆ†ï¼‰ -->
  <style>
    .tarot-container{position:relative;overflow:hidden;margin-bottom:30px;padding:28px;border-radius:22px;background:var(--panel);border:1px solid var(--border);box-shadow:0 18px 36px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08)}
    .header h1{font-size:2.2rem;color:var(--gold-light);letter-spacing:1px;text-align:center;text-shadow:0 2px 8px rgba(0,0,0,.25)}
    .header p{color:var(--text-muted);text-align:center;margin-top:6px}
    .tarot-card{width:220px;height:340px;margin:24px auto 10px;border-radius:14px;overflow:hidden;background:linear-gradient(135deg, rgba(157,126,168,.36), rgba(232,212,162,.2));border:1px solid var(--border);box-shadow:0 12px 30px rgba(0,0,0,.28);transform-style:preserve-3d;transition:transform .8s cubic-bezier(.175,.885,.32,1.275), box-shadow .35s ease;cursor:pointer}
    .tarot-card:hover{transform:translateY(-6px) rotate(3deg);box-shadow:0 16px 36px rgba(0,0,0,.34)}
    .tarot-card::after{content:"";position:absolute;inset:14px;border-radius:10px;border:1px solid rgba(255,255,255,.22)}
    .action-section{text-align:center;margin:16px 0 6px}
    .btn-tarot,.already-drawn{display:inline-flex;align-items:center;gap:10px;padding:13px 28px;border-radius:24px;border:1px solid var(--border);background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;letter-spacing:.4px;box-shadow:0 10px 24px rgba(157,126,168,.32);text-decoration:none;transition:.3s}
    .btn-tarot:hover,.already-drawn:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(157,126,168,.42);color:#fff}
    .btn-tarot:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .guest-tip{max-width:520px;margin:12px auto 0;padding:12px 14px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text-light)}

    .fortune-card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:22px;padding:0;box-shadow:0 16px 36px rgba(0,0,0,.28);overflow:hidden;display:none}
    .fortune-header{background:linear-gradient(135deg, rgba(157,126,168,.3), rgba(232,212,162,.16));color:var(--text);padding:26px;text-align:center;border-bottom:1px solid var(--border)}
    .fortune-date{font-size:.95rem;color:var(--text-muted);margin-bottom:6px}
    .fortune-score{font-size:3.8rem;font-weight:800;letter-spacing:1px;color:var(--gold-light);text-shadow:0 2px 10px rgba(0,0,0,.22);display:inline-block}
    .fortune-score::after{content:'åˆ†';font-size:1.2rem;font-weight:400;margin-left:6px;color:var(--text-light)}
    .fortune-label{margin-top:10px;display:inline-block;padding:6px 18px;border-radius:18px;background:rgba(255,255,255,.16);color:var(--text);font-weight:700;border:1px solid var(--border)}
    .fortune-summary{font-size:1rem;line-height:1.7;color:var(--text-light);max-width:680px;margin:10px auto 0}
    .dimensions-section{padding:24px;background:rgba(0,0,0,.08)}
    .section-title{font-size:1.2rem;color:var(--gold-light);text-align:center;margin-bottom:16px;font-weight:700}
    .dimensions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:20px}
    .dimension-item{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.12);transition:.25s ease}
    .dimension-item:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.16)}
    .dimension-icon{width:42px;height:42px;border-radius:12px;margin:0 auto 8px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.1rem;border:1px solid var(--border)}
    .dimension-name{font-weight:700;color:var(--text);margin-bottom:6px}
    .dimension-stars{font-size:1.05rem;color:var(--star);letter-spacing:2px;margin-bottom:4px}
    .dimension-level{font-size:.9rem;color:var(--text-muted);background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:12px;display:inline-block;padding:4px 10px}
    .advice-grid{display:grid;gap:10px}
    .advice-item{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:12px;padding:12px 15px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .advice-icon{width:34px;height:34px;border-radius:10px;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;color:var(--gold-light)}
    .advice-name{font-weight:700;color:var(--text);font-size:.95rem;margin-bottom:2px}
    .advice-text{color:var(--text-muted);font-size:.95rem;line-height:1.5}
    .bottom-section{padding:24px;display:grid;grid-template-columns:1fr 1.5fr;gap:22px}
    .lucky-section{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;padding:16px}
    .lucky-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .lucky-item{background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:12px;text-align:center;padding:10px}
    .lucky-label{font-size:.88rem;color:var(--text-muted);margin-bottom:4px}
    .lucky-value{font-weight:700;color:var(--gold-light);font-size:1.06rem}
    .suggestions-section{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .suggestion-card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;padding:16px}
    .suggestion-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .suggestion-icon{width:30px;height:30px;border-radius:8px;color:#fff;display:flex;align-items:center;justify-content:center}
    .suggestion-do .suggestion-icon{background:var(--success)}
    .suggestion-dont .suggestion-icon{background:var(--danger)}
    .suggestion-title{font-weight:700;font-size:1.02rem}
    .suggestion-list{list-style:none;margin:0;padding:0}
    .suggestion-list li{padding:6px 0 6px 22px;position:relative;color:var(--text-muted)}
    .suggestion-list li::before{content:'â€¢';position:absolute;left:8px;top:2px;font-weight:700}
    .suggestion-do li::before{color:var(--success)} .suggestion-dont li::before{color:var(--danger)}
    .action-bar{text-align:center;padding:16px;background:rgba(255,255,255,.06);border-top:1px solid var(--border)}
    .btn-refresh,.btn-ai-chat{padding:11px 20px;border-radius:20px;border:1px solid var(--border);background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;text-decoration:none;display:inline-block;transition:.25s;box-shadow:0 6px 16px rgba(157,126,168,.3)}
    .btn-refresh:hover,.btn-ai-chat:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(157,126,168,.4);color:#fff}

    .fab-share{position:fixed;right:20px;bottom:20px;z-index:300;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;border:1px solid var(--border);background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:0 12px 26px rgba(157,126,168,.32);transition:.25s}
    .fab-share:hover{transform:translateY(-2px);box-shadow:0 16px 30px rgba(157,126,168,.42)}
    .fab-share.disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

    /* åˆ†äº«å¼¹å±‚ */
    .sc-overlay{position:fixed;inset:0;z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
    .sc-mask{position:absolute;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px)}
    .sc-panel{position:relative;z-index:1;max-width:480px;max-height:90vh;width:100%;padding:16px;border-radius:20px;background:rgba(255,255,255,.08);border:1px solid var(--border);box-shadow:0 24px 48px rgba(0,0,0,.4);display:flex;flex-direction:column;gap:12px}
    .sc-close{position:absolute;right:14px;top:14px;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;background:rgba(255,255,255,.1);border:1px solid var(--border);transition:.2s}
    .sc-close:hover{background:rgba(255,255,255,.15);transform:scale(1.1)}
    .sc-frame-wrapper{flex:1;min-height:0;border-radius:16px;overflow:hidden;background:#1a1625;position:relative}
    .sc-frame{width:100%;height:100%;border:0;display:block}
    .sc-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;padding-top:8px}
    .sc-btn{padding:12px 20px;border-radius:20px;border:1px solid var(--border);background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:600;cursor:pointer;transition:.25s;font-size:14px}
    .sc-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(157,126,168,.35)}
    .sc-btn.ghost{background:rgba(255,255,255,.08)}
    .sc-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .loading-spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin .6s linear infinite;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:768px){
      .main-container{margin-top:74px}
      .bottom-section{grid-template-columns:1fr}
      .suggestions-section{grid-template-columns:1fr}
      .dimensions-grid{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
      .fortune-score{font-size:3rem}
      .lucky-grid{grid-template-columns:1fr}
      .sc-frame{max-width:92vw}
      .tarot-card{aspect-ratio:220/340;width:clamp(180px,64vw,260px);height:auto}
    }

  </style>
</head>
<body>
  {% include 'partials/_bg_layers.html' %}
  {% include 'partials/_user_bar.html' %}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages" style="position:fixed;top:68px;right:20px;z-index:200;max-width:380px">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}" style="padding:12px 14px;margin-bottom:10px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 18px rgba(0,0,0,.18);color:#fff;border:none;animation:in .3s ease-out;backdrop-filter:blur(6px)">
            <span>{{ message }}</span>
            <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="main-container">
    <div class="tarot-container">
      <div class="header">
        <h1><i class="fas fa-star"></i> æ¯æ—¥å¡”ç½—è¿åŠ¿ <i class="fas fa-star"></i></h1>
        <p>æ¢ç´¢å®‡å®™çš„å¥¥ç§˜ï¼Œæ­ç¤ºä»Šæ—¥çš„æŒ‡å¼•</p>
      </div>

      <div class="tarot-card" id="tarot-card-display">
        {% if today_card %}
          {% if today_card.image %}
            <img src="{{ today_card.image }}" alt="{{ today_card.name }}" style="width:100%;height:100%;object-fit:cover;border-radius:14px;">
            <div class="card-info" style="position:absolute;left:0;right:0;bottom:0;padding:16px;border-radius:0 0 14px 14px;background:linear-gradient(to top, rgba(0,0,0,.65), transparent);color:#fff;">
              <div style="font-weight:700;font-size:1.08rem;text-shadow:0 2px 6px rgba(0,0,0,.4);">{{ today_card.name }}</div>
              <div style="font-size:.92rem;opacity:.92;margin-top:4px;">{{ today_card.direction }}</div>
            </div>
          {% else %}
            <div style="text-align:center;padding:24px;color:var(--text-light);">
              <i class="fas fa-sun" style="font-size:3rem;margin-bottom:14px;color:var(--gold-light)"></i>
              <div style="font-weight:700;font-size:1.1rem;color:#fff;margin-bottom:6px;">{{ today_card.name }}</div>
              <div style="font-size:.95rem;color:var(--text-muted)">{{ today_card.direction }}</div>
            </div>
          {% endif %}
        {% else %}
          <i class="fas fa-question" style="color: var(--text-muted); font-size: 2rem;"></i>
        {% endif %}
      </div>

      {% if user.is_guest and not has_drawn %}
        <div class="guest-tip"><i class="fas fa-info-circle"></i>
          <span>ä½œä¸ºè®¿å®¢ï¼Œè§£è¯»ä»…åœ¨æœ¬æ¬¡æµè§ˆæœ‰æ•ˆã€‚<a href="{{ url_for('register') }}" style="color: var(--gold-light); text-decoration: underline;">æ³¨å†Œè´¦å·</a>å¯ä¿å­˜å†å²è®°å½•ã€‚</span>
        </div>
      {% endif %}

      <div class="action-section">
        {% if has_drawn %}
          <a href="{{ url_for('result') }}" class="already-drawn"><i class="fas fa-eye"></i> æŸ¥çœ‹ä»Šæ—¥å¡”ç½—è§£è¯»</a>
          <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background: linear-gradient(135deg, #4a6fa5, #2e4578);"><i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ</a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot"><i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ</a>
          </div>
          <div class="info-text" style="margin-top:8px;color:var(--text-muted)">æ‚¨ä»Šå¤©å·²ç»æŠ½å–è¿‡å¡”ç½—ç‰Œäº†</div>
        {% else %}
          <form id="draw-form" action="{{ url_for('draw_card') }}" method="post">
            <button type="submit" class="btn-tarot" id="draw-btn"><i class="fas fa-hand-sparkles"></i> æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œ</button>
          </form>
          <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background:#6c757d;"><i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ</a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot"><i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ</a>
          </div>
          <div class="info-text" style="margin-top:8px;color:var(--text-muted)">ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œï¼Œæˆ–ç›´æ¥è¿›å…¥ç‰Œé˜µå åœ</div>
        {% endif %}
      </div>
    </div>

    <div id="fortune-card" class="fortune-card">
      <div class="fortune-header">
        <div class="fortune-date">{{ today }} Â· ä»Šæ—¥è¿åŠ¿</div>
        <div class="fortune-score" id="overall-score">-</div>
        <div class="fortune-label" id="overall-label">-</div>
        <div class="fortune-summary" id="fortune-summary-text"></div>
      </div>

      <div class="dimensions-section">
        <h3 class="section-title">äº”ç»´åº¦è¿åŠ¿æŒ‡æ•°</h3>
        <div class="dimensions-grid" id="dimensions-grid"></div>
        <div class="advice-grid" id="advice-grid"></div>
      </div>

      <div class="bottom-section">
        <div class="lucky-section">
          <h3 class="section-title" style="margin-bottom:12px;">ä»Šæ—¥å¹¸è¿å…ƒç´ </h3>
          <div class="lucky-grid" id="lucky-grid"></div>
        </div>
        <div class="suggestions-section">
          <div class="suggestion-card suggestion-do">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-check"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å®œåš</div>
            </div>
            <ul class="suggestion-list" id="do-list"></ul>
          </div>
          <div class="suggestion-card suggestion-dont">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-times"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å¿Œåš</div>
            </div>
            <ul class="suggestion-list" id="dont-list"></ul>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn-refresh" onclick="refreshFortune(event)"><i class="fas fa-sync-alt"></i> åˆ·æ–°è¿åŠ¿</button>
        {% if has_drawn %}
          <a href="{{ url_for('chat_page') }}" class="btn-ai-chat"><i class="fas fa-comments"></i> AI æ·±åº¦è§£è¯»</a>
          <button type="button" class="btn-ai-chat" id="openShareBtn"><i class="fas fa-share-alt"></i> ç”Ÿæˆåˆ†äº«å¡ç‰‡</button>
        {% endif %}
      </div>
    </div>

    <div class="features" style="display:flex;justify-content:space-around;flex-wrap:wrap;margin:28px 0;gap:12px;">
      <a class="feature" onclick="goHistory()" style="flex:0 0 30%;min-width:220px;padding:18px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.14);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-moon" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.15rem;color:#fff;margin-bottom:6px;">æ¯æ—¥æŒ‡å¼•</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">æ¯å¤©æŠ½å–ä¸€å¼ å¡”ç½—ç‰Œï¼Œè·å–ä¸“å±ä»Šæ—¥çš„å®‡å®™æŒ‡å¼•</p>
      </a>
      <a class="feature" href="{{ url_for('guide_spread') }}" style="flex:0 0 30%;min-width:220px;padding:18px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.14);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-magic" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.15rem;color:#fff;margin-bottom:6px;">å¼•å¯¼é€‰æ‹©ç‰Œé˜µ</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">åƒå’Œå åœå¸ˆèŠå¤©ä¸€æ ·ï¼Œç”±ç³»ç»Ÿå¼•å¯¼é€‰æ‹©æœ€åˆé€‚çš„ç‰Œé˜µ</p>
      </a>
      <a class="feature" onclick="goHistory()" style="flex:0 0 30%;min-width:220px;padding:18px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.14);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-history" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.15rem;color:#fff;margin-bottom:6px;">å†å²è®°å½•</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">{{ 'æŸ¥çœ‹æ‚¨çš„æŠ½å¡è®°å½•å’Œè¿åŠ¿è¶‹åŠ¿' if not user.is_guest else 'æ³¨å†Œåå¯ä¿å­˜å†å²è®°å½•' }}</p>
      </a>
    </div>

    <div class="footer">
      Â© 2025 å¡”ç½—è¿åŠ¿ | å®‡å®™èƒ½é‡ï¼Œæ™ºæ…§æŒ‡å¼•<br><small style="opacity:.7;">æ¯æ—¥å‡Œæ™¨é‡ç½®ï¼ŒåŸºäºåŒ—äº¬æ—¶é—´</small>
    </div>
  </div>

  <div class="fab-share {% if not has_drawn %}disabled{% endif %}" id="fabShare" title="ç”Ÿæˆåˆ†äº«å¡ç‰‡"><i class="fas fa-share-alt"></i></div>

  <!-- åˆ†äº«å¼¹å±‚ -->
  <div class="sc-overlay" id="scOverlay">
    <div class="sc-mask" onclick="closeShareOverlay()"></div>
    <div class="sc-panel">
      <button class="sc-close" onclick="closeShareOverlay()"><i class="fas fa-times"></i></button>
      <div class="sc-frame-wrapper">
        <iframe id="shareFrame" class="sc-frame" title="åˆ†äº«å¡ç‰‡"></iframe>
      </div>
      <div class="sc-actions">
        <button class="sc-btn" id="btnGenShare" onclick="generateShare()">âœ¨ ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
        <button class="sc-btn ghost" id="btnCopyLink" style="display:none" onclick="copyShareLink()">ğŸ”— å¤åˆ¶é“¾æ¥</button>
        <button class="sc-btn ghost" id="btnSaveImg" onclick="saveShareImage()">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
      </div>
    </div>
  </div>

  <!-- é¡µé¢æ•°æ® -->
  <script id="INDEX_DATA" type="application/json">
    {
      "user_name": "{{ user.username if not user.is_guest else 'ç¥ç§˜è®¿å®¢' }}",
      "today": "{{ today }}",
      "has_drawn": {{ 'true' if has_drawn else 'false' }},
      "reading": {{ (today_card or {})|tojson }},
      "fortune": {{ (fortune_data or {})|tojson }}
    }
  </script>

  <!-- é¡µé¢é€»è¾‘ï¼šä¿ç•™ + å°ä¿®å¤ï¼ˆ?. é˜² NPEï¼›è¡¥ sendViewportToChildï¼›åˆ·æ–°æŒ‰é’® event å…¼å®¹ï¼‰ -->
  <script>
    const $ = (id)=>document.getElementById(id);
    const dimensionIcons = {"äº‹ä¸šè¿":"fas fa-briefcase","è´¢å¯Œè¿":"fas fa-coins","çˆ±æƒ…è¿":"fas fa-heart","å¥åº·è¿":"fas fa-heartbeat","è´µäººè¿":"fas fa-hands-helping"};
    function generateStars(r){ const full=Math.floor(r||0); let s=''; for(let i=0;i<5;i++) s+=i<full?'â˜…':'â˜†'; return s; }

    document.addEventListener('DOMContentLoaded', ()=>{
      const data = JSON.parse($('INDEX_DATA').textContent || '{}');
      if (data.fortune && Object.keys(data.fortune).length>0) renderFortune(data.fortune);

      document.getElementById('draw-form')?.addEventListener('submit', function(e){
        e.preventDefault(); const btn=$('draw-btn'); btn.disabled=true; setTimeout(()=>this.submit(), 900 + Math.random()*900);
      });

      const openShare = ()=> openShareOverlay(data);
      $('openShareBtn')?.addEventListener('click', openShare);
      $('fabShare')?.addEventListener('click', ()=>{ if(!$('fabShare').classList.contains('disabled')) openShare(); });

      // è¿™äº›å…ƒç´ åŸæœ¬æ²¡æœ‰ idï¼Œç”¨å¯é€‰é“¾é¿å…æŠ¥é”™ï¼ˆä½ ä¹Ÿå¯ä»¥ç»™å®ƒä»¬åŠ  idï¼‰
      document.querySelector('.sc-mask')?.addEventListener('click', closeShareOverlay);
      document.querySelector('.sc-close')?.addEventListener('click', closeShareOverlay);

      // å­é¡µå°ºå¯¸ -> è‡ªé€‚åº” iframeï¼ˆæ— æ»šåŠ¨ï¼‰
      const PAD_X = 32, PAD_Y = 160;
      window.addEventListener('message', (evt)=>{
        const msg = evt.data || {};
        if(msg.type === 'ruoshui:size' && msg.data){
          const frame = $('shareFrame'); if(!frame) return;
          frame.style.width  = Math.min(msg.data.w, window.innerWidth - PAD_X) + 'px';
          frame.style.height = Math.min(msg.data.h, window.innerHeight - PAD_Y) + 'px';
        }
      });

      // çª—å£å°ºå¯¸å˜åŒ– -> å°†çˆ¶é¡µå¯è§†é«˜åº¦å‘ç»™å­é¡µï¼ˆè¡¥é½ä½ ä»£ç é‡Œå¼•ç”¨æœªå®šä¹‰çš„å‡½æ•°ï¼‰
      window.addEventListener('resize', sendViewportToChild);
      window.addEventListener('orientationchange', sendViewportToChild);
    });

    function sendViewportToChild(){
      const frame = $('shareFrame');
      if (frame && frame.contentWindow) {
        frame.contentWindow.postMessage({ type:'ruoshui:viewport', data:{ w:window.innerWidth, h:window.innerHeight } }, '*');
      }
    }

    function renderFortune(data){
      $('fortune-card').style.display = 'block';
      $('overall-score').textContent = data.overall_score || '-';
      $('overall-label').textContent = data.overall_label || '-';
      $('fortune-summary-text').textContent = (data.fortune_text && data.fortune_text.summary) || data.summary || '';

      const grid = $('dimensions-grid'); grid.innerHTML='';
      if (data.dimensions && Array.isArray(data.dimensions)) {
        data.dimensions.forEach(dim=>{
          grid.insertAdjacentHTML('beforeend', `
            <div class="dimension-item">
              <div class="dimension-icon"><i class="${dimensionIcons[dim.name]||'fas fa-star'}"></i></div>
              <div class="dimension-name">${dim.name}</div>
              <div class="dimension-stars">${generateStars(dim.stars||3)}</div>
              <div class="dimension-level">${dim.level||'â€”'}</div>
            </div>`);
        });
      }

      const adviceGrid = $('advice-grid'); adviceGrid.innerHTML='';
      if (data.fortune_text && data.fortune_text.dimension_advice) {
        Object.entries(data.fortune_text.dimension_advice).forEach(([name, advice])=>{
          const icon = dimensionIcons[name]||'fas fa-star';
          adviceGrid.insertAdjacentHTML('beforeend', `
            <div class="advice-item">
              <div class="advice-icon"><i class="${icon}"></i></div>
              <div class="advice-content">
                <div class="advice-name">${name}</div>
                <div class="advice-text">${advice}</div>
              </div>
            </div>`);
        });
      }

      const luckyGrid = $('lucky-grid'); luckyGrid.innerHTML='';
      if (data.lucky_elements) {
        if (Array.isArray(data.lucky_elements)) {
          data.lucky_elements.forEach(item=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item"><div class="lucky-label">${item.name}</div><div class="lucky-value">${item.value}</div></div>`);
          });
        } else if (typeof data.lucky_elements === 'object') {
          const nameMap = {color:'å¹¸è¿é¢œè‰²',number:'å¹¸è¿æ•°å­—',hour:'å¹¸è¿æ—¶è¾°',direction:'å¹¸è¿æ–¹ä½'};
          Object.entries(data.lucky_elements).forEach(([k,v])=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item"><div class="lucky-label">${nameMap[k] || k}</div><div class="lucky-value">${v}</div></div>`);
          });
        }
      }

      const doList = $('do-list'); doList.innerHTML='';
      if (data.fortune_text && data.fortune_text.do) data.fortune_text.do.forEach(x=> doList.insertAdjacentHTML('beforeend', `<li>${x}</li>`));
      const dontList = $('dont-list'); dontList.innerHTML='';
      if (data.fortune_text && data.fortune_text.dont) data.fortune_text.dont.forEach(x=> dontList.insertAdjacentHTML('beforeend', `<li>${x}</li>`));
    }

    function goHistory(){
      {% if user.is_guest %}
        if (confirm("æŸ¥çœ‹å†å²è®°å½•éœ€è¦ç™»å½•è´¦å·ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ")) {
          window.location.href = "{{ url_for('login', next=url_for('stats') ) }}";
        }
      {% else %}
        window.location.href = "{{ url_for('stats') }}";
      {% endif %}
    }

    function refreshFortune(ev){
      const today = "{{ today }}";
      const btn = (ev && ev.target) ? ev.target.closest('button') : document.querySelector('.btn-refresh');
      if (btn) btn.disabled = true;
      fetch(`{{ url_for('api_fortune', date='') }}${today}`)
        .then(r=>r.json())
        .then(d=>{ if(d.error) alert(d.error); else renderFortune(d); })
        .catch(e=>{ console.error(e); alert('è¿åŠ¿åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•'); })
        .finally(()=>{ if (btn) btn.disabled=false; });
    }

    // â€”â€” åˆ†äº«å¡ â€”â€”ï¼ˆåŸæ · + å¥å£®æ€§ï¼‰
    let shareState = { shareId: null, shareUrl: null, qrCode: null };

    function openShareOverlay() {
      const data = JSON.parse(document.getElementById('INDEX_DATA').textContent || '{}');
      if (!data.has_drawn) { alert('è¯·å…ˆæŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œ'); return; }
      document.getElementById('scOverlay').style.display = 'flex';
      const frame = document.getElementById('shareFrame');
      frame.src = '/share/card?embed=1';
      frame.onload = function() {
        frame.contentWindow.postMessage({
          type: 'share:init',
          data: { user_name: data.user_name, today: data.today, reading: data.reading, fortune: data.fortune }
        }, '*');
      };
      shareState = { shareId: null, shareUrl: null, qrCode: null };
      document.getElementById('btnCopyLink').style.display = 'none';
    }
    function closeShareOverlay() {
      document.getElementById('scOverlay').style.display = 'none';
      document.getElementById('shareFrame').src = 'about:blank';
    }
    async function generateShare() {
      const btn = document.getElementById('btnGenShare');
      btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span>ç”Ÿæˆä¸­...';
      try {
        const response = await fetch('/api/share/create', { method: 'POST' });
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');
        shareState.shareId = data.share_id;
        shareState.shareUrl = data.share_url || 'https://www.ruoshui.fun';
        shareState.qrCode = data.qr_code;
        const frame = document.getElementById('shareFrame');
        frame.contentWindow.postMessage({ type:'share:update', qrCode: shareState.qrCode, shareUrl: shareState.shareUrl }, '*');
        document.getElementById('btnCopyLink').style.display = 'inline-block';
        btn.innerHTML = 'âœ… å·²ç”Ÿæˆ';
        setTimeout(()=>{ btn.innerHTML = 'âœ¨ ç”Ÿæˆåˆ†äº«é“¾æ¥'; }, 2000);
      } catch (error) {
        alert(error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
        btn.innerHTML = 'âœ¨ ç”Ÿæˆåˆ†äº«é“¾æ¥';
      } finally {
        btn.disabled = false;
      }
    }
    function copyShareLink() {
      const text = shareState.shareUrl || 'https://www.ruoshui.fun';
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(()=>alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')).catch(()=>fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
      function fallbackCopy(t){ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('é“¾æ¥å·²å¤åˆ¶'); }
    }
    async function saveShareImage() {
      const btn = document.getElementById('btnSaveImg');
      if (!shareState.shareId) { await generateShare(); if (!shareState.shareId) { alert('è¯·å…ˆç”Ÿæˆåˆ†äº«é“¾æ¥'); return; } }
      btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span>å¯¼å‡ºä¸­...';
      try {
        const response = await fetch('/api/share/export', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ share_id: shareState.shareId })
        });
        if (response.ok) {
          const ct = response.headers.get('content-type');
          if (ct && ct.includes('image')) {
            const blob = await response.blob(); const url = URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click(); URL.revokeObjectURL(url); btn.innerHTML='âœ… å·²ä¿å­˜';
          } else {
            const data = await response.json();
            if (data.fallback === 'client') await clientSideExport();
            else throw new Error(data.error || 'å¯¼å‡ºå¤±è´¥');
          }
        } else {
          await clientSideExport();
        }
      } catch (e) {
        console.error('Export error:', e);
        await clientSideExport();
      } finally {
        setTimeout(()=>{ btn.innerHTML='ğŸ’¾ ä¿å­˜å›¾ç‰‡'; btn.disabled=false; }, 2000);
      }
    }
    async function clientSideExport() {
      const frame = document.getElementById('shareFrame');
      return new Promise((resolve, reject) => {
        function handleMessage(event) {
          if (event.data && event.data.type === 'share:export-ready') {
            window.removeEventListener('message', handleMessage);
            if (event.data.success && event.data.dataUrl) {
              const a=document.createElement('a'); a.href=event.data.dataUrl; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click(); resolve();
            } else { alert('å®¢æˆ·ç«¯å¯¼å‡ºå¤±è´¥ï¼Œè¯·ä½¿ç”¨æˆªå›¾å·¥å…·'); reject(new Error('Client export failed')); }
          }
        }
        window.addEventListener('message', handleMessage);
        frame.contentWindow.postMessage({ type: 'share:export' }, '*');
        setTimeout(()=>{ window.removeEventListener('message', handleMessage); alert('å¯¼å‡ºè¶…æ—¶ï¼Œè¯·ä½¿ç”¨æˆªå›¾å·¥å…·'); reject(new Error('Export timeout')); }, 10000);
      });
    }

    // å†æ¬¡ç»‘å®šæŒ‰é’®ï¼ˆä»¥é˜² DOM åŠ¨æ€å˜åŒ–ï¼‰
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('openShareBtn')?.addEventListener('click', openShareOverlay);
      document.getElementById('fabShare')?.addEventListener('click', function() {
        if (!this.classList.contains('disabled')) openShareOverlay();
      });
    });
  </script>

  <script src="{{ url_for('static', filename='js/cosmos.js') }}"></script>
</body>
</html>
