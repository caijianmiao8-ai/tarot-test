<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯æ—¥å¡”ç½—è¿åŠ¿</title>

  <!-- æœ¬åœ°åŒ– Bootstrap / Font Awesome -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">

  <meta name="theme-color" content="#2a1e4a"/>

  <style>
    :root{
      --bg-deep:#1a1625;
      --bg-deeper:#0f0b18;
      --primary:#7a5cff;
      --primary-2:#a786ff;
      --accent:#e8d4a2;         /* é«˜é›…é‡‘ */
      --accent-soft:#f3e9c8;
      --mist:#c9b8ff;
      --text:#eae6f7;
      --text-dim:#bfb6d6;
      --text-soft:#dcd2f3;
      --danger:#ef4444;
      --success:#10b981;
      --star:#ffd700;
      --glass:rgba(255,255,255,.06);
    }

    /* ============ å…¨å±€ä¸èƒŒæ™¯ ============ */
    html,body{height:100%}
    body{
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(167,134,255,.22), transparent 60%),
        radial-gradient(1000px 800px at 110% 10%, rgba(122,92,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-deeper) 100%);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* å®‡å®™/å¡”ç½—åŠ¨æ€æš—çº¹ */
    .cosmic{
      pointer-events:none; position:fixed; inset:0; z-index:0; overflow:hidden;
    }
    .cosmic .orb{
      position:absolute; width:520px;height:520px;border-radius:50%;
      background:radial-gradient(circle,rgba(122,92,255,.25) 0%, transparent 70%);
      filter: blur(40px); animation: float 10s ease-in-out infinite;
    }
    .cosmic .orb.o1{ top:-120px; left:-120px; animation-delay:0s}
    .cosmic .orb.o2{ bottom:-140px; right:-160px; background:radial-gradient(circle,rgba(232,212,162,.22) 0%, transparent 70%); animation-delay:2.2s}
    .cosmic .sigil{
      position:absolute; width:220px; height:220px; opacity:.06;
      background:url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">\
        <circle cx="50" cy="50" r="42" fill="none" stroke="white" stroke-width="1"/>\
        <circle cx="50" cy="50" r="28" fill="none" stroke="white" stroke-width="1"/>\
        <polygon points="50,8 63,40 95,40 69,60 80,92 50,72 20,92 31,60 5,40 37,40" fill="none" stroke="white" stroke-width="1"/>\
      </svg>') center/contain no-repeat;
      animation: rotate 60s linear infinite;
    }
    .cosmic .sigil.s1{ top:8%; right:8%}
    .cosmic .sigil.s2{ bottom:6%; left:10%; animation-direction:reverse}
    .cosmic .star{ position:absolute; width:2px;height:2px;border-radius:50%; background:rgba(255,255,255,.7); animation: twinkle 3.5s infinite;}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}
    @keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    @keyframes twinkle{0%,100%{opacity:.3}50%{opacity:1}}

    /* ============ é¡¶éƒ¨ç”¨æˆ·æ  ============ */
    .user-bar{
      position:fixed; top:0; left:0; right:0; z-index:10;
      background: rgba(17,13,30,.55); backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .user-bar-content{
      max-width:1200px; margin:0 auto; padding:10px 20px;
      display:flex; align-items:center; justify-content:space-between; color:var(--text);
    }
    .user-icon{ width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      display:flex;align-items:center;justify-content:center; color:#fff; font-weight:700;
    }
    .user-name{ color:var(--accent); font-weight:600 }
    .user-actions{ display:flex; gap:12px }
    .user-actions a{
      color:var(--mist); text-decoration:none; font-size:.95rem; padding:8px 16px; border-radius:18px;
      transition:.25s; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02)
    }
    .user-actions a:hover{ color:#fff; border-color: rgba(255,255,255,.18) }

    /* ============ Flash ============ */
    .flash-messages{ position:fixed; top:72px; right:20px; z-index:11; max-width:420px }
    .alert{ border:none; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,.28); color:#fff }
    .alert-success{ background:#16a34a } .alert-info{ background:#3b82f6 } .alert-error{ background:#ef4444 }
    .alert .close{ color:#fff; opacity:.9 }

    /* ============ ä¸»å®¹å™¨ ============ */
    .main-container{ position:relative; z-index:1; max-width:1000px; width:100%; margin:100px auto 32px; padding:0 16px }

    /* ============ æŠ½ç‰Œå¡ç‰‡ ============ */
    .tarot-container{
      padding:28px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
      border-radius:22px; box-shadow: 0 20px 60px rgba(0,0,0,.35);
      position:relative; overflow:hidden;
    }
    .tarot-container::before{
      content:""; position:absolute; inset:-1px; border-radius:22px;
      background: linear-gradient(135deg, rgba(122,92,255,.35), rgba(232,212,162,.22));
      filter: blur(24px); opacity:.18; z-index:0;
    }
    .header{ position:relative; z-index:1; text-align:center }
    .header h1{ font-size:2.4rem; color:#fff; margin-bottom:8px; letter-spacing:.5px }
    .header p{ color:var(--text-dim); margin:0 auto 8px; max-width:620px }

    .tarot-card{
      width:210px;height:332px;margin:28px auto 16px;border-radius:16px; overflow:hidden;
      position:relative; background:linear-gradient(135deg,#7250ff,#caa7ff);
      box-shadow:0 12px 40px rgba(0,0,0,.35); transform-style:preserve-3d; transition:.8s cubic-bezier(.175,.885,.32,1.275);
      cursor:pointer;
    }
    .tarot-card:hover{ transform: translateY(-8px) rotate(4deg) }
    .tarot-card::after{
      content:""; position:absolute; inset:14px; border-radius:12px; border:1.2px solid rgba(255,255,255,.35)
    }
    .tarot-card i{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:4rem; color:rgba(255,255,255,.22) }
    .card-info{ position:absolute; left:0; right:0; bottom:0;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.6));
      color:#fff; padding:18px 14px 14px; font-weight:600; letter-spacing:.3px
    }

    .btn-tarot{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      background:linear-gradient(135deg, var(--primary), var(--primary-2)); color:#fff;
      padding:14px 28px; border:none; border-radius:28px; font-weight:700; letter-spacing:.3px; text-decoration:none; transition:.28s;
      box-shadow:0 14px 34px rgba(122,92,255,.35);
    }
    .btn-tarot:hover{ transform:translateY(-2px); box-shadow:0 18px 42px rgba(122,92,255,.45) }
    .already-drawn{
      background:linear-gradient(135deg,#4a6fa5,#2e4578); padding:12px 22px; border-radius:28px; color:#fff; text-decoration:none; box-shadow:0 10px 24px rgba(74,111,165,.35)
    }

    .features{ display:flex; justify-content:space-around; flex-wrap:wrap; gap:14px; margin:26px 0 }
    .feature{
      flex:0 0 30%; min-width:220px; padding:18px; border-radius:16px; text-align:center;
      background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); box-shadow:0 8px 24px rgba(0,0,0,.22);
      transition:.28s; cursor:pointer; text-decoration:none; color:var(--text)
    }
    .feature:hover{ transform: translateY(-6px) }
    .feature i{ font-size:2.2rem; color:var(--mist); margin-bottom:10px }
    .feature h3{ color:#fff; font-weight:700; margin-bottom:8px; font-size:1.2rem }
    .feature p{ color:var(--text-dim) }

    .footer{ text-align:center; margin:22px 0 10px; color:var(--text-dim); font-size:.92rem }

    /* ===== è¿åŠ¿å±•ç¤ºå¡ï¼ˆä¿æŒåŸæœ‰ç»“æ„ï¼‰ ===== */
    .fortune-card{ background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:24px; box-shadow:0 14px 46px rgba(0,0,0,.32); overflow:hidden; display:none }
    .fortune-header{ background: linear-gradient(135deg, rgba(122,92,255,.44), rgba(232,212,162,.28)); color:#fff; padding:28px; text-align:center; position:relative }
    .fortune-date{ opacity:.95 }
    .fortune-score{ font-size:3.8rem; font-weight:800; text-shadow:0 4px 18px rgba(0,0,0,.25) }
    .fortune-label{ margin-top:8px; display:inline-block; padding:6px 18px; border-radius:18px; background:rgba(0,0,0,.18) }
    .fortune-summary{ margin-top:10px; color:#f4f0ff }

    .dimensions-section{ padding:24px; background: rgba(255,255,255,.02) }
    .section-title{ text-align:center; color:#fff; font-weight:700; margin-bottom:16px }
    .dimensions-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:14px }
    .dimension-item{ background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; text-align:center; transition:.25s; box-shadow:0 6px 18px rgba(0,0,0,.22) }
    .dimension-item:hover{ transform:translateY(-3px) }
    .dimension-icon{ width:40px;height:40px;border-radius:12px; display:flex;align-items:center;justify-content:center; color:#fff; background:linear-gradient(135deg, var(--primary), var(--primary-2)); margin:0 auto 8px }
    .dimension-stars{ color:var(--star) }

    .advice-grid{ display:grid; gap:10px }
    .advice-item{ background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); padding:14px 16px; border-radius:12px; display:flex; gap:12px; align-items:center }
    .advice-icon{ width:32px;height:32px;border-radius:8px; background:#2a2344; display:flex;align-items:center;justify-content:center; color:var(--mist) }

    .bottom-section{ padding:24px; display:grid; grid-template-columns: 1fr 1.3fr; gap:22px }
    .lucky-section{ background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px }
    .lucky-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .lucky-item{ background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; text-align:center }
    .lucky-label{ color:var(--text-dim); font-size:.86rem }
    .lucky-value{ color:var(--accent); font-weight:700; letter-spacing:.3px }

    .suggestions-section{ display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    .suggestion-card{ background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px }
    .suggestion-header{ display:flex; gap:10px; align-items:center; margin-bottom:10px }
    .suggestion-icon{ width:30px;height:30px;border-radius:8px; display:flex;align-items:center;justify-content:center; color:#fff }
    .suggestion-do .suggestion-icon{ background: var(--success) } .suggestion-dont .suggestion-icon{ background: var(--danger) }
    .suggestion-list{ list-style:none; margin:0; padding:0 }
    .suggestion-list li{ padding:8px 6px 8px 20px; position:relative; color:var(--text-soft) }
    .suggestion-list li::before{ content:'â€¢'; position:absolute; left:6px; color:var(--mist) }

    .action-bar{ background:rgba(255,255,255,.02); border-top:1px solid rgba(255,255,255,.08); text-align:center; padding:16px }
    .btn-refresh, .btn-ai-chat, .btn-share{
      display:inline-block; background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; border:none;
      padding:10px 18px; border-radius:20px; font-weight:700; text-decoration:none; box-shadow:0 10px 28px rgba(122,92,255,.35); transition:.25s
    }
    .btn-ai-chat{ margin-left:10px }
    .btn-share{ margin-left:10px }
    .btn-refresh:hover, .btn-ai-chat:hover, .btn-share:hover{ transform:translateY(-2px) }

    /* ============ æ‚¬æµ®åˆ†äº«æŒ‰é’® ============ */
    .float-share{
      position:fixed; right:20px; bottom:22px; z-index:9;
      width:54px;height:54px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--accent), var(--primary));
      box-shadow:0 18px 44px rgba(0,0,0,.38), inset 0 0 24px rgba(255,255,255,.25);
      display:flex;align-items:center;justify-content:center; color:#1a132c; font-size:22px; cursor:pointer;
      transition:.28s;
    }
    .float-share:hover{ transform: translateY(-3px) scale(1.03) }

    /* ============ Share Card å¼¹å±‚ ============ */
    .sc-overlay{ position:fixed; inset:0; background:rgba(4,3,8,.72); backdrop-filter: blur(6px); z-index:20; display:none; align-items:center; justify-content:center; padding:18px }
    .sc-wrap{ position:relative; display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap; justify-content:center }

    .share-card{
      width:375px;height:667px;background:linear-gradient(180deg,#1a1a2e 0%,#0f0f1e 100%);
      border-radius:24px; overflow:hidden; position:relative; box-shadow:0 30px 60px rgba(0,0,0,.44); border:1px solid rgba(255,255,255,.1)
    }
    .bg-glow-card{ position:absolute; inset:0; pointer-events:none }
    .bg-glow-card .glow{ position:absolute; width:320px;height:320px;border-radius:50%; filter: blur(42px) }
    .bg-glow-card .g1{ top:-140px; right:-120px; background:radial-gradient(circle, rgba(122,92,255,.32), transparent 70%) }
    .bg-glow-card .g2{ bottom:-160px; left:-120px; background:radial-gradient(circle, rgba(232,212,162,.28), transparent 70%) }
    .sparkles-card .s{ position:absolute; width:2px;height:2px; background:#fff; border-radius:50%; animation: twinkle 3.4s infinite }
    .sc-content{ position:relative; z-index:2; height:100%; display:flex; flex-direction:column; padding:22px 18px }

    .sc-head{ text-align:center; margin-bottom:14px }
    .sc-date{ color:rgba(255,255,255,.68); font-size:12px; letter-spacing:2px; margin-bottom:6px }
    .sc-user{ color:#fff; font-size:18px; font-weight:600; margin-bottom:4px }
    .sc-type{ color:var(--mist); font-size:13px }

    .sc-tarot{ background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:16px; margin-bottom:14px; backdrop-filter: blur(8px) }
    .sc-img-box{ width:120px;height:180px;margin:0 auto 12px; position:relative; transform-style:preserve-3d; animation: subtle-rotate 8s ease-in-out infinite }
    @keyframes subtle-rotate{0%,100%{transform:rotateY(0)}50%{transform:rotateY(10deg)}}
    .sc-img{ width:100%;height:100%;border-radius:12px; overflow:hidden; position:relative; background:linear-gradient(135deg,#667eea,#764ba2); box-shadow:0 10px 30px rgba(102,126,234,.3) }
    .sc-img img{ width:100%;height:100%;object-fit:cover; display:block }
    .sc-img .ph{ position:absolute; inset:0; display:flex;align-items:center;justify-content:center; color:rgba(255,255,255,.85); font-size:40px }
    .sc-cardname{ color:#fff; font-weight:700; font-size:18px; text-align:center }
    .sc-direction{ color:var(--mist); font-size:12px; text-align:center }

    .sc-award{ display:flex; align-items:center; justify-content:center; gap:10px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; margin-bottom:12px }
    .sc-ring{ position:relative; width:42px;height:42px }
    .score-ring{ /* åŸ CSS åœ†ç¯ï¼Œä»…æµè§ˆæ€ç”¨ï¼›å¯¼å‡ºæ—¶éšè—ï¼Œç”¨SVGæ›¿ä»£ */ 
      position:absolute; inset:0; border-radius:50%;
      background: conic-gradient(var(--accent) calc(var(--p,0)*1%), rgba(255,255,255,.14) 0);
      mask: radial-gradient(circle 18px at 50% 50%, transparent 98%, #000 100%);
    }
    .score-svg{ display:none } /* å¯¼å‡ºæ—¶åˆ‡æ¢å¯è§ */
    .sc-score{ color:#fff; font-weight:800; font-size:22px }
    .sc-label{ color:var(--text-soft); font-size:12px }

    /* è§£æ+å®œå¿ŒåŒºåŸŸ */
    .sc-message{
      background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; margin-bottom:12px
    }
    .sc-block-title{
      color: var(--accent); font-weight:800; letter-spacing:.5px; font-size:13px; margin-bottom:6px; text-transform: uppercase
    }
    .sc-summary{ color:#f4f0ff; font-size:13px; line-height:1.45;
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; word-break: break-word; hyphens:auto;
    }

    .sc-duo{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    .sc-card{ background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px }
    .sc-card h4{ margin:0 0 6px; font-size:12px; color:#fff; font-weight:700; letter-spacing:.3px }
    .sc-list{ list-style:none; margin:0; padding:0 }
    .sc-list li{
      position:relative; padding-left:14px; color:#eae6f7; font-size:12.5px; line-height:1.4;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break: break-word; hyphens:auto;
    }
    .sc-list li::before{ content:'â€¢'; position:absolute; left:4px; color:var(--mist) }

    /* å¹¸è¿å…ƒç´ ï¼ˆç´§å‡‘ï¼Œé˜²æº¢å‡ºï¼‰ */
    .sc-lucky{
      display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;
      background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; margin-bottom:10px;
    }
    .sc-lucky .itm{ text-align:center }
    .sc-lucky .lab{ color:var(--text-dim); font-size:10px }
    .sc-lucky .val{ color:var(--accent); font-size:12px; font-weight:700; letter-spacing:.3px; word-break:break-all }

    /* åº•éƒ¨äºŒç»´ç  & æ–‡æ¡ˆï¼ˆæé«˜å¯¹æ¯”åº¦ï¼‰ */
    .sc-foot{
      margin-top:auto; padding-top:14px; border-top:1px solid rgba(255,255,255,.1);
      display:flex; align-items:center; justify-content:space-between;
    }
    .sc-qr{ width:64px;height:64px;border-radius:10px;background:#fff; padding:8px; display:flex;align-items:center;justify-content:center }
    .sc-qr img{ width:100%;height:100%;display:block }
    .sc-qr .ph{ width:100%;height:100%; background:repeating-linear-gradient(0deg,#000,#000 2px,#fff 2px,#fff 4px) }

    .sc-invite{ flex:1; margin-left:12px }
    .sc-invite .t1{ color:#ffffff; font-weight:800; font-size:14px; margin-bottom:2px; letter-spacing:.2px }
    .sc-invite .t2{ color:#e9e3ff; font-size:11px }
    .sc-invite .url{ color:var(--accent); font-size:11px; margin-top:4px; word-break:break-all }

    /* å³ä¾§æ§åˆ¶é¢æ¿ */
    .sc-panel{
      width:290px; padding:14px; border-radius:16px; background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08); color:#fff; box-shadow:0 12px 36px rgba(0,0,0,.34)
    }
    .sc-panel .row{ display:flex; gap:8px; flex-wrap:wrap }
    .sc-btn{
      padding:10px 16px; border-radius:18px; border:none; cursor:pointer; font-weight:700; letter-spacing:.3px;
      background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; box-shadow:0 12px 28px rgba(122,92,255,.35); transition:.25s
    }
    .sc-btn.alt{ background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1) }
    .sc-btn:hover{ transform: translateY(-2px) }
    .sc-close{ position:absolute; top:-12px; right:-12px; width:36px;height:36px;border-radius:50%; background:#221a37; color:#fff; display:flex;align-items:center;justify-content:center; cursor:pointer; border:1px solid rgba(255,255,255,.12); box-shadow:0 10px 26px rgba(0,0,0,.45) }

    /* â€”â€” å¯¼å‡ºæ•è·æ¨¡å¼ï¼ˆå…³é—­åŠ¨ç”»/æ»¤é•œã€æ›¿æ¢æ•ˆæœï¼‰ â€”â€” */
    .sc-capture, .sc-capture *{
      animation: none !important; transition: none !important; filter: none !important; backdrop-filter: none !important;
    }
    .sc-capture .bg-glow-card, .sc-capture .sparkles-card{ display:none !important }
    .sc-capture .score-ring{ display:none !important }
    .sc-capture .score-svg{ display:inline-block !important; width:42px; height:42px }
    .sc-capture .sc-invite .t1, .sc-capture .sc-invite .t2, .sc-capture .sc-invite .url{ color:#ffffff !important }

    /* Loading Overlay */
    .loading-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.72); z-index:100; align-items:center; justify-content:center }
    .loading-content{ color:#fff; background:rgba(122,92,255,.22); border:1px solid rgba(255,255,255,.12); padding:26px; border-radius:14px; text-align:center }
    .spinner{ width:48px;height:48px;border:5px solid rgba(255,255,255,.28); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 14px }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* å“åº”å¼ */
    @media (max-width: 768px){
      .main-container{ margin-top:84px }
      .bottom-section{ grid-template-columns:1fr }
      .suggestions-section{ grid-template-columns:1fr }
      .dimensions-grid{ grid-template-columns: repeat(auto-fit, minmax(120px,1fr)) }
      .fortune-score{ font-size:3rem }
      .lucky-grid{ grid-template-columns:1fr 1fr }
      .sc-panel{ width:100% }
    }
  </style>
</head>

<body>
  <!-- èƒŒæ™¯åŠ¨æ€å±‚ -->
  <div class="cosmic" aria-hidden="true">
    <div class="orb o1"></div><div class="orb o2"></div>
    <div class="sigil s1"></div><div class="sigil s2"></div>
    <!-- æ˜Ÿç‚¹ -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const host = document.querySelector('.cosmic');
        for(let i=0;i<90;i++){
          const st = document.createElement('div'); st.className='star';
          st.style.left = (Math.random()*100)+'%';
          st.style.top = (Math.random()*100)+'%';
          st.style.animationDelay = (Math.random()*3)+'s';
          host.appendChild(st);
        }
      });
    </script>
  </div>

  <!-- ç”¨æˆ·æ  -->
  <div class="user-bar">
    <div class="user-bar-content">
      <div class="user-info">
        <div class="user-icon">
          {% if not user.is_guest %}{{ user.username[0]|upper }}{% else %}<i class="fas fa-user"></i>{% endif %}
        </div>
        <span class="user-name">{{ user.username if not user.is_guest else "ç¥ç§˜è®¿å®¢" }}</span>
      </div>
      <div class="user-actions">
        {% if user.is_guest %}
          <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> ç™»å½•</a>
          <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> æ³¨å†Œ</a>
        {% else %}
          <a href="{{ url_for('stats') }}"><i class="fas fa-chart-line"></i> ç»Ÿè®¡</a>
          <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Flash æ¶ˆæ¯ -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            <span>{{ message }}</span>
            <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ä¸»å®¹å™¨ -->
  <div class="main-container">
    <!-- æŠ½ç‰Œ -->
    <div class="tarot-container">
      <div class="header">
        <h1><i class="fas fa-star"></i> æ¯æ—¥å¡”ç½—è¿åŠ¿ <i class="fas fa-star"></i></h1>
        <p>æ¢ç´¢å®‡å®™çš„å¥¥ç§˜ï¼Œæ­ç¤ºä»Šæ—¥çš„æŒ‡å¼•</p>
      </div>

      <div class="tarot-card" id="tarot-card-display">
        {% if today_card %}
          {% if today_card.image %}
            <img src="{{ today_card.image }}" alt="{{ today_card.name }}" style="width:100%;height:100%;object-fit:cover;">
            <div class="card-info">
              <div style="font-weight:700;font-size:1.05rem">{{ today_card.name }}</div>
              <div style="font-size:.9rem;opacity:.92">{{ today_card.direction }}</div>
            </div>
          {% else %}
            <i class="fas fa-sun"></i>
          {% endif %}
        {% else %}
          <i class="fas fa-question"></i>
        {% endif %}
      </div>

      {% if user.is_guest and not has_drawn %}
        <div class="guest-tip" style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); color:var(--text); border-radius:12px; padding:12px 14px; margin-top:6px">
          <i class="fas fa-info-circle" style="color:var(--mist)"></i>
          <span>ä½œä¸ºè®¿å®¢ï¼Œè§£è¯»ä»…åœ¨æœ¬æ¬¡æµè§ˆæœ‰æ•ˆã€‚<a href="{{ url_for('register') }}" style="color:var(--accent); text-decoration: underline;">æ³¨å†Œè´¦å·</a>å¯ä¿å­˜å†å²è®°å½•ã€‚</span>
        </div>
      {% endif %}

      <div class="action-section" style="text-align:center; margin-top:12px">
        {% if has_drawn %}
          <a href="{{ url_for('result') }}" class="already-drawn"><i class="fas fa-eye"></i> æŸ¥çœ‹ä»Šæ—¥å¡”ç½—è§£è¯»</a>
          <div style="margin-top: 14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background: linear-gradient(135deg, #4a6fa5, #2e4578); box-shadow:0 12px 26px rgba(46,69,120,.38);">
              <i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ
            </a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot">
              <i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ
            </a>
          </div>
          <div class="info-text" style="margin-top:10px; color:var(--text-dim)">æ‚¨ä»Šå¤©å·²ç»æŠ½å–è¿‡å¡”ç½—ç‰Œäº†</div>
        {% else %}
          <form id="draw-form" action="{{ url_for('draw_card') }}" method="post">
            <button type="submit" class="btn-tarot" id="draw-btn"><i class="fas fa-hand-sparkles"></i> æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œ</button>
          </form>
          <div style="margin-top: 14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background:#6c757d; box-shadow:0 12px 24px rgba(108,117,125,.34);">
              <i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ
            </a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot">
              <i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ
            </a>
          </div>
          <div class="info-text" style="margin-top:10px; color:var(--text-dim)">ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œï¼Œæˆ–ç›´æ¥è¿›å…¥ç‰Œé˜µå åœ</div>
        {% endif %}
      </div>
    </div>

    <!-- è¿åŠ¿å¡ç‰‡ï¼ˆä¿æŒä½ çš„é€»è¾‘ï¼‰ -->
    <div id="fortune-card" class="fortune-card">
      <div class="fortune-header">
        <div class="fortune-date">{{ today }} Â· ä»Šæ—¥è¿åŠ¿</div>
        <div class="fortune-score-wrapper">
          <div class="fortune-score" id="overall-score">-</div>
          <div class="fortune-label" id="overall-label">-</div>
        </div>
        <div class="fortune-summary" id="fortune-summary-text"></div>
      </div>

      <div class="dimensions-section">
        <h3 class="section-title">äº”ç»´åº¦è¿åŠ¿æŒ‡æ•°</h3>
        <div class="dimensions-grid" id="dimensions-grid"></div>
        <div class="advice-grid" id="advice-grid"></div>
      </div>

      <div class="bottom-section">
        <div class="lucky-section">
          <h3 class="section-title" style="margin-bottom:12px;">ä»Šæ—¥å¹¸è¿å…ƒç´ </h3>
          <div class="lucky-grid" id="lucky-grid"></div>
        </div>
        <div class="suggestions-section">
          <div class="suggestion-card suggestion-do">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-check"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å®œåš</div>
            </div>
            <ul class="suggestion-list" id="do-list"></ul>
          </div>
          <div class="suggestion-card suggestion-dont">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-times"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å¿Œåš</div>
            </div>
            <ul class="suggestion-list" id="dont-list"></ul>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn-refresh" onclick="refreshFortune()">
          <i class="fas fa-sync-alt"></i> åˆ·æ–°è¿åŠ¿
        </button>
        {% if has_drawn %}
        <a href="{{ url_for('chat_page') }}" class="btn-ai-chat">
          <i class="fas fa-comments"></i> AI æ·±åº¦è§£è¯»
        </a>
        <!-- è§¦å‘å¼¹å±‚çš„åˆ†äº«æŒ‰é’® -->
        <a href="javascript:void(0)" class="btn-share" onclick="SC_open()">
          <i class="fas fa-share-alt"></i> ç”Ÿæˆåˆ†äº«å¡ç‰‡
        </a>
        {% endif %}
      </div>
    </div>

    <!-- åŠŸèƒ½ç‰¹ç‚¹ -->
    <div class="features">
      <div class="feature" onclick="goHistory()">
        <i class="fas fa-moon"></i>
        <h3>æ¯æ—¥æŒ‡å¼•</h3>
        <p>æ¯å¤©æŠ½å–ä¸€å¼ å¡”ç½—ç‰Œï¼Œè·å–ä¸“å±ä»Šæ—¥çš„å®‡å®™æŒ‡å¼•å’Œèƒ½é‡æç¤º</p>
      </div>
      <div class="feature" onclick="window.location.href='{{ url_for('guide_spread') }}'">
        <i class="fas fa-magic"></i>
        <h3>å¼•å¯¼é€‰æ‹©ç‰Œé˜µ</h3>
        <p>åƒå’Œå åœå¸ˆèŠå¤©ä¸€æ ·ï¼Œç”±ç³»ç»Ÿå¼•å¯¼é€‰æ‹©æœ€åˆé€‚çš„ç‰Œé˜µä¸å¯¹è¯äººæ ¼</p>
      </div>
      <div class="feature" onclick="goHistory()">
        <i class="fas fa-history"></i>
        <h3>å†å²è®°å½•</h3>
        <p>{{ 'æŸ¥çœ‹æ‚¨çš„æŠ½å¡è®°å½•å’Œè¿åŠ¿è¶‹åŠ¿' if not user.is_guest else 'æ³¨å†Œåå¯ä¿å­˜å†å²è®°å½•' }}</p>
      </div>
    </div>

    <div class="footer">
      Â© 2025 å¡”ç½—è¿åŠ¿ | å®‡å®™èƒ½é‡ï¼Œæ™ºæ…§æŒ‡å¼•<br>
      <small style="opacity:.8">æ¯æ—¥å‡Œæ™¨é‡ç½®ï¼ŒåŸºäºåŒ—äº¬æ—¶é—´</small>
    </div>
  </div>

  <!-- æ‚¬æµ®åˆ†äº«æŒ‰é’®ï¼ˆå…¨å±€ï¼‰ -->
  <div class="float-share" onclick="SC_open()" title="ç”Ÿæˆåˆ†äº«å¡ç‰‡">
    <i class="fas fa-share-alt"></i>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3>æ­£åœ¨è¿æ¥å®‡å®™èƒ½é‡</h3>
      <p>å¡”ç½—ç‰Œæ­£åœ¨æ­ç¤ºæ‚¨çš„ä»Šæ—¥è¿åŠ¿ï¼Œè¯·ç¨å€™...</p>
    </div>
  </div>

  <!-- ================= Share Card å¼¹å±‚ ================= -->
  <div id="SC_overlay" class="sc-overlay" aria-hidden="true">
    <div class="sc-wrap">
      <!-- å…³é—­æŒ‰é’® -->
      <div class="sc-close" onclick="SC_close()"><i class="fas fa-times"></i></div>

      <!-- å¡ç‰‡æœ¬ä½“ -->
      <div id="SC_card" class="share-card">
        <div class="bg-glow-card">
          <div class="glow g1"></div><div class="glow g2"></div>
        </div>
        <div class="sparkles-card" aria-hidden="true"></div>
        <div class="sc-content">
          <!-- å¤´éƒ¨ -->
          <div class="sc-head">
            <div id="SC_date" class="sc-date">--</div>
            <div id="SC_user" class="sc-user">--</div>
            <div class="sc-type">âœ¨ ä»Šæ—¥å¡”ç½—è¿åŠ¿ âœ¨</div>
          </div>

          <!-- ç‰Œé¢ -->
          <div class="sc-tarot">
            <div class="sc-img-box">
              <div class="sc-img">
                <img id="SC_img" alt="" class="hidden" />
                <div id="SC_imgPh" class="ph">ğŸ´</div>
              </div>
            </div>
            <div class="sc-cardname" id="SC_cardname">--</div>
            <div class="sc-direction" id="SC_direction">--</div>
          </div>

          <!-- åˆ†æ•° -->
          <div class="sc-award">
            <div id="SC_ring" class="sc-ring">
              <div class="score-ring" style="--p:0;"></div>
            </div>
            <div style="text-align:center">
              <div id="SC_score" class="sc-score">--</div>
              <div id="SC_scoreLabel" class="sc-label">ä»Šæ—¥è¿åŠ¿ Â· --</div>
            </div>
          </div>

          <!-- è§£è¯» -->
          <div class="sc-message">
            <div class="sc-block-title">ä»Šæ—¥è¿åŠ¿è§£è¯»</div>
            <div id="SC_summary" class="sc-summary">--</div>
          </div>

          <!-- å®œ/å¿Œ -->
          <div class="sc-duo">
            <div class="sc-card">
              <h4>ä»Šæ—¥å®œåš</h4>
              <ul id="SC_do" class="sc-list"></ul>
            </div>
            <div class="sc-card">
              <h4>ä»Šæ—¥å¿Œåš</h4>
              <ul id="SC_dont" class="sc-list"></ul>
            </div>
          </div>

          <!-- å¹¸è¿å…ƒç´ ï¼ˆç´§å‡‘ï¼‰ -->
          <div class="sc-lucky" id="SC_lucky">
            <div class="itm"><div class="lab">å¹¸è¿è‰²</div><div id="SC_lucky_color" class="val">--</div></div>
            <div class="itm"><div class="lab">å¹¸è¿æ•°</div><div id="SC_lucky_number" class="val">--</div></div>
            <div class="itm"><div class="lab">å¹¸è¿æ—¶</div><div id="SC_lucky_hour" class="val">--</div></div>
            <div class="itm"><div class="lab">å¹¸è¿æ–¹</div><div id="SC_lucky_direction" class="val">--</div></div>
          </div>

          <!-- åº•éƒ¨ -->
          <div class="sc-foot">
            <div class="sc-qr">
              <img id="SC_qr" alt="QR" class="hidden"/>
              <div id="SC_qrPh" class="ph"></div>
            </div>
            <div class="sc-invite">
              <div class="t1">æ‰«ç æµ‹è¯•ä½ çš„è¿åŠ¿</div>
              <div class="t2">æ¢ç´¢å®‡å®™èƒ½é‡çš„æŒ‡å¼•</div>
              <div id="SC_url" class="url">www.ruoshui.fun</div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
      <div class="sc-panel">
        <div style="font-weight:800; letter-spacing:.4px; margin-bottom:10px">åˆ†äº«å¡ç‰‡</div>
        <div class="row" style="margin-bottom:10px">
          <button id="SC_btnGen" class="sc-btn" onclick="SC_generate()"><i class="fas fa-link"></i>&nbsp;ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
          <button id="SC_btnCopy" class="sc-btn alt" onclick="SC_copy()" disabled><i class="fas fa-copy"></i>&nbsp;å¤åˆ¶é“¾æ¥</button>
        </div>
        <div class="row">
          <button id="SC_btnSave" class="sc-btn" onclick="SC_savePNG()"><i class="fas fa-download"></i>&nbsp;ä¿å­˜å¡ç‰‡å›¾ç‰‡</button>
          <button class="sc-btn alt" onclick="SC_close()"><i class="fas fa-times"></i>&nbsp;å…³é—­</button>
        </div>
        <div style="margin-top:10px; font-size:12px; color:var(--text-dim)">
          äºŒç»´ç å°†æŒ‡å‘ <span style="color:var(--accent)">www.ruoshui.fun</span>ï¼Œå¤åˆ¶çš„é“¾æ¥ä¸ºä½ çš„ä¸“å±åˆ†äº«åœ°å€ã€‚
        </div>
      </div>
    </div>
  </div>
  <!-- ================= /Share Card å¼¹å±‚ ================= -->

  <!-- ä¾èµ–ï¼šhtml2canvas & html-to-image -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js" defer></script>

  <script>
    /* ========= é¡µé¢å·²æœ‰é€»è¾‘ï¼šæ¸²æŸ“è¿åŠ¿ ========= */
    const dimensionIcons = {
      "äº‹ä¸šè¿": "fas fa-briefcase", "è´¢å¯Œè¿": "fas fa-coins", "çˆ±æƒ…è¿": "fas fa-heart",
      "å¥åº·è¿": "fas fa-heartbeat", "è´µäººè¿": "fas fa-hands-helping"
    };
    document.addEventListener('DOMContentLoaded', () => {
      const fortuneData = {{ fortune_data|tojson|safe }};
      if (fortuneData && Object.keys(fortuneData).length > 0) renderFortune(fortuneData);
    });

    function renderFortune(data){
      document.getElementById('fortune-card').style.display = 'block';
      document.getElementById('overall-score').textContent = data.overall_score || '-';
      document.getElementById('overall-label').textContent = data.overall_label || '-';
      const summaryText = (data.fortune_text && data.fortune_text.summary) || data.summary || '';
      document.getElementById('fortune-summary-text').textContent = summaryText;

      const grid = document.getElementById('dimensions-grid'); grid.innerHTML='';
      if (data.dimensions && Array.isArray(data.dimensions)) {
        data.dimensions.forEach(dim=>{
          const stars = generateStars(dim.stars || 3);
          const icon = dimensionIcons[dim.name] || 'fas fa-star';
          grid.insertAdjacentHTML('beforeend', `
            <div class="dimension-item">
              <div class="dimension-icon"><i class="${icon}"></i></div>
              <div class="dimension-name">${dim.name}</div>
              <div class="dimension-stars">${stars}</div>
              <div class="dimension-level">${dim.level || 'â€”'}</div>
            </div>`);
        });
      }

      // ç»´åº¦å»ºè®®
      const adviceGrid = document.getElementById('advice-grid'); adviceGrid.innerHTML='';
      if (data.fortune_text && data.fortune_text.dimension_advice) {
        Object.entries(data.fortune_text.dimension_advice).forEach(([name, advice])=>{
          const icon = dimensionIcons[name] || 'fas fa-star';
          adviceGrid.insertAdjacentHTML('beforeend', `
            <div class="advice-item">
              <div class="advice-icon"><i class="${icon}"></i></div>
              <div class="advice-content">
                <div class="advice-name">${name}</div>
                <div class="advice-text">${advice}</div>
              </div>
            </div>`);
        });
      }

      // å¹¸è¿å…ƒç´ 
      const luckyGrid = document.getElementById('lucky-grid'); luckyGrid.innerHTML='';
      if (data.lucky_elements) {
        const map = { 'color': 'å¹¸è¿é¢œè‰²', 'number': 'å¹¸è¿æ•°å­—', 'hour': 'å¹¸è¿æ—¶è¾°', 'direction': 'å¹¸è¿æ–¹ä½' };
        if (Array.isArray(data.lucky_elements)) {
          data.lucky_elements.forEach(item=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item"><div class="lucky-label">${item.name}</div><div class="lucky-value">${item.value}</div></div>`);
          });
        } else {
          Object.entries(data.lucky_elements).forEach(([k,v])=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item"><div class="lucky-label">${map[k]||k}</div><div class="lucky-value">${v}</div></div>`);
          });
        }
      }

      // å®œå¿Œ
      const doList = document.getElementById('do-list'); doList.innerHTML='';
      const dontList = document.getElementById('dont-list'); dontList.innerHTML='';
      if (data.fortune_text?.do) data.fortune_text.do.forEach(t=> doList.insertAdjacentHTML('beforeend', `<li>${t}</li>`));
      if (data.fortune_text?.dont) data.fortune_text.dont.forEach(t=> dontList.insertAdjacentHTML('beforeend', `<li>${t}</li>`));
    }

    function generateStars(r){ const f=Math.floor(r||0), h=(r%1)>=.5; return 'â˜…'.repeat(f)+(h?'â˜†':'')+'â˜†'.repeat(5-f-(h?1:0)) }

    // æŠ½ç‰Œè¡¨å•â€œä»ªå¼æ„Ÿâ€
    document.getElementById('draw-form')?.addEventListener('submit', function(e){
      e.preventDefault(); const btn = document.getElementById('draw-btn');
      btn.disabled = true; document.getElementById('loading-overlay').style.display = 'flex';
      setTimeout(()=>{ this.submit() }, 1000 + Math.random()*1000);
    });

    function goHistory(){
      {% if user.is_guest %}
      if (confirm("æŸ¥çœ‹å†å²è®°å½•éœ€è¦ç™»å½•è´¦å·ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ")) window.location.href = "{{ url_for('login', next=url_for('stats')) }}";
      {% else %} window.location.href = "{{ url_for('stats') }}"; {% endif %}
    }

    function refreshFortune(){
      const today="{{ today }}"; const btn=event.target.closest('button'); btn.disabled=true;
      fetch(`{{ url_for('api_fortune', date='') }}${today}`).then(r=>r.json()).then(d=>{
        if(d.error) alert(d.error); else renderFortune(d);
      }).catch(()=>alert('è¿åŠ¿åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•')).finally(()=> btn.disabled=false);
    }

    /* ===================== Share Card é€»è¾‘ ===================== */
    function SC$(id){ return document.getElementById(id) }
    function SC_open(){
      // æ¸²æŸ“æ•°æ®
      const d = {{ fortune_data|tojson|safe }};
      const reading = {{ (today_card or {})|tojson|safe }};
      const userName = "{{ user.username if not user.is_guest else 'ç¥ç§˜è®¿å®¢' }}";
      SC_render({
        user_name: userName,
        date: "{{ today }}",
        reading: reading||{},
        fortune: d||{}
      });

      // å±•ç¤º
      const ov = SC$('SC_overlay'); ov.style.display='flex';
      // ç”Ÿæˆå°‘é‡æ˜Ÿç‚¹
      const sp = document.querySelector('.sparkles-card'); if(sp && !sp.dataset.init){
        for(let i=0;i<40;i++){ const s=document.createElement('div'); s.className='s'; s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*100)+'%'; s.style.animationDelay=(Math.random()*3)+'s'; sp.appendChild(s) }
        sp.dataset.init='1';
      }
    }
    function SC_close(){ SC$('SC_overlay').style.display='none' }

    function SC_scoreLabel(s){
      s=Number(s)||0; if(s>=85) return 'å¤§å‰'; if(s>=70) return 'ä¸­å‰'; if(s>=55) return 'å°å‰'; return 'å¹³';
    }

    // è‡ªåŠ¨é™å­—å·ï¼ˆé¿å…æ»šåŠ¨æ¡/æˆªæ–­ï¼‰
    function SC_fitText(container, selector, maxLines=2, minSize=11){
      const els = container.querySelectorAll(selector);
      els.forEach(el=>{
        let size = parseFloat(getComputedStyle(el).fontSize)||13;
        const lineHeight = parseFloat(getComputedStyle(el).lineHeight)||16;
        const maxH = lineHeight*maxLines + 1;
        for(let i=0;i<3;i++){
          if(el.scrollHeight<=maxH) break;
          size = Math.max(minSize, size-1);
          el.style.fontSize = size+'px';
        }
      });
    }

    function SC_render({user_name, date, reading, fortune}){
      SC$('SC_date').textContent = date || '--';
      SC$('SC_user').textContent = user_name || 'ç¥ç§˜è®¿å®¢';

      const cn = reading.card_name || reading.name || '--';
      const dir = reading.direction || reading.card_direction || '--';
      SC$('SC_cardname').textContent = cn; SC$('SC_direction').textContent = dir;

      const img = reading.image || reading.card_image || '';
      const el = SC$('SC_img');
      if(img){
        el.crossOrigin = 'anonymous';
        el.onload = ()=>{ el.classList.remove('hidden'); SC$('SC_imgPh').classList.add('hidden') };
        el.onerror = ()=>{ el.classList.add('hidden'); SC$('SC_imgPh').classList.remove('hidden') };
        el.src = img;
      }else{
        el.classList.add('hidden'); SC$('SC_imgPh').classList.remove('hidden');
      }

      const s = fortune.overall_score; const p = Math.max(0, Math.min(100, Number(s)||0));
      SC$('SC_score').textContent = s ?? '--';
      SC$('SC_scoreLabel').textContent = 'ä»Šæ—¥è¿åŠ¿ Â· ' + SC_scoreLabel(s);
      SC$('SC_ring').style.setProperty('--p', p);

      const summary = (fortune.fortune_text && fortune.fortune_text.summary) || fortune.summary || 'â€”';
      SC$('SC_summary').textContent = summary;

      const doArr = (fortune.fortune_text && fortune.fortune_text.do) || [];
      const dontArr = (fortune.fortune_text && fortune.fortune_text.dont) || [];
      const doUL = SC$('SC_do'), dontUL = SC$('SC_dont');
      doUL.innerHTML=''; dontUL.innerHTML='';
      (doArr.slice(0,2)).forEach(t=> doUL.insertAdjacentHTML('beforeend', `<li>${t}</li>`));
      (dontArr.slice(0,2)).forEach(t=> dontUL.insertAdjacentHTML('beforeend', `<li>${t}</li>`));

      SC$('SC_lucky_color').textContent = fortune.lucky_color || (fortune.lucky_elements && fortune.lucky_elements.color) || '--';
      SC$('SC_lucky_number').textContent = fortune.lucky_number || (fortune.lucky_elements && fortune.lucky_elements.number) || '--';
      SC$('SC_lucky_hour').textContent = fortune.lucky_hour || (fortune.lucky_elements && fortune.lucky_elements.hour) || '--';
      SC$('SC_lucky_direction').textContent = fortune.lucky_direction || (fortune.lucky_elements && fortune.lucky_elements.direction) || '--';

      // é™å­—å·é¿å…æ»šåŠ¨æ¡
      const card = SC$('SC_card');
      SC_fitText(card, '.sc-summary', 3, 11);
      SC_fitText(card, '#SC_do li', 2, 11);
      SC_fitText(card, '#SC_dont li', 2, 11);
    }

    async function SC_generate(){
      const btn = SC$('SC_btnGen'); btn.disabled=true; btn.textContent='ç”Ÿæˆä¸­...';
      try{
        const r = await fetch('/api/share/create', { method:'POST' });
        const d = await r.json();
        if(!d.success) throw new Error(d.error || 'ç”Ÿæˆå¤±è´¥');

        // å¤åˆ¶æŒ‰é’®å¯ç”¨
        SC$('SC_btnCopy').disabled = false;
        // ç«™ç‚¹æ–‡å­—å±•ç¤ºä¸“å±é“¾æ¥
        SC$('SC_url').textContent = d.share_url || 'https://www.ruoshui.fun';

        // ã€ŒäºŒç»´ç ä»…æŒ‡å‘ä¸»é¡µã€
        const qrTarget = 'https://www.ruoshui.fun';
        // è‹¥åç«¯å·²ç»™ qr_code å°±ç”¨å®ƒï¼ˆå‡è®¾ä¹Ÿæ˜¯ä¸»é¡µï¼‰ï¼›å¦åˆ™å ä½ä¿ç•™
        if (d.qr_code){
          const img = SC$('SC_qr');
          img.src = d.qr_code; img.onload=()=>{ img.classList.remove('hidden'); SC$('SC_qrPh').classList.add('hidden') };
        }
      }catch(e){
        alert(e.message || 'ç”Ÿæˆå¤±è´¥');
      }finally{
        btn.disabled=false; btn.textContent='ç”Ÿæˆåˆ†äº«é“¾æ¥';
      }
    }

    function SC_copy(){
      const txt = SC$('SC_url').textContent || '';
      if(!txt) return;
      (navigator.clipboard ? navigator.clipboard.writeText(txt) : (function(t){const a=document.createElement('textarea'); a.value=t; document.body.appendChild(a); a.select(); document.execCommand('copy'); a.remove();})(txt))
      .then(()=> alert('é“¾æ¥å·²å¤åˆ¶'))
      .catch(()=> alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'));
    }

    // ç­‰å¾…å­—ä½“/å›¾ç‰‡
    function SC_waitReady(node){
      const fontsReady = document.fonts ? document.fonts.ready : Promise.resolve();
      const imgs = Array.from(node.querySelectorAll('img'));
      const imgPromises = imgs.map(img => {
        if (img.complete && img.naturalWidth) return Promise.resolve();
        return new Promise(res=>{ img.addEventListener('load', res, {once:true}); img.addEventListener('error', res, {once:true}); });
      });
      return Promise.all([fontsReady, ...imgPromises]);
    }

    // å¯¼å‡ºæ•è·æ¨¡å¼ï¼šæ³¨å…¥SVGåœ†ç¯
    function SC_beginCapture(){
      const card = SC$('SC_card'); card.classList.add('sc-capture');

      const score = parseFloat(SC$('SC_score').textContent) || 0;
      const p = Math.max(0, Math.min(100, score)) / 100;
      const svgNS='http://www.w3.org/2000/svg';
      const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox','0 0 42 42'); svg.classList.add('score-svg');
      const cx=21, cy=21, r=17, len = 2*Math.PI*r;
      const bg=document.createElementNS(svgNS,'circle'); bg.setAttribute('cx',cx); bg.setAttribute('cy',cy); bg.setAttribute('r',r);
      bg.setAttribute('stroke','rgba(255,255,255,.15)'); bg.setAttribute('stroke-width','4'); bg.setAttribute('fill','none');
      const fg=document.createElementNS(svgNS,'circle'); fg.setAttribute('cx',cx); fg.setAttribute('cy',cy); fg.setAttribute('r',r);
      fg.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#e8d4a2');
      fg.setAttribute('stroke-width','4'); fg.setAttribute('fill','none'); fg.setAttribute('stroke-linecap','round');
      fg.setAttribute('stroke-dasharray',`${len}`); fg.setAttribute('stroke-dashoffset',String(len*(1-p)));
      svg.appendChild(bg); svg.appendChild(fg);

      const ring = SC$('SC_ring'); ring.parentNode.insertBefore(svg, ring);
      return ()=>{ card.classList.remove('sc-capture'); svg.remove() };
    }

    async function SC_savePNG(){
      const hide = ['SC_btnGen','SC_btnCopy','SC_btnSave'].map(SC$);
      hide.forEach(b=> b && (b.disabled=true, b.classList.add('alt')));

      const card = SC$('SC_card');
      const end = SC_beginCapture();
      try{
        await SC_waitReady(card);
        if(window.htmlToImage?.toPng){
          const dataUrl = await htmlToImage.toPng(card, {
            pixelRatio: 2.6,
            backgroundColor: '#1a1625',
            cacheBust: true,
            filter: node => {
              const style = window.getComputedStyle(node);
              return !(style && style.display==='none');
            }
          });
          const a=document.createElement('a'); a.href=dataUrl; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click();
          end(); hide.forEach(b=> b && (b.disabled=false, b.classList.remove('alt'))); return;
        }
        const canvas = await html2canvas(card, { scale:2.4, useCORS:true, backgroundColor:'#1a1625', removeContainer:true, logging:false });
        const url = canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click();
      }catch(e){
        console.error(e); alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }finally{
        end(); hide.forEach(b=> b && (b.disabled=false, b.classList.remove('alt')));
      }
    }
  </script>
</body>
</html>
