<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日塔罗运势</title>

    <!-- 本地化 Bootstrap -->
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
    <!-- 本地化 Font Awesome -->
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">

    <style>
        :root {
            --primary-color: #8e6c88;
            --secondary-color: #d1bfa7;
            --accent-color: #6d4c67;
            --light-color: #f8f4e9;
            --dark-color: #333333;
            --star-color: #ffd700;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f4e9 0%, #e8e0d1 100%);
            color: var(--dark-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* 用户栏 */
        .user-bar { position: fixed; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 10px 20px; z-index: 100; }
        .user-bar-content { max-width: 1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
        .user-info { display:flex; align-items:center; gap:15px; }
        .user-icon { width:36px; height:36px; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; }
        .user-name { font-weight:600; color:var(--accent-color); }
        .user-actions { display:flex; gap:15px; }
        .user-actions a { color:var(--primary-color); text-decoration:none; font-size:0.95rem; padding:8px 16px; border-radius:20px; transition: all 0.3s; }
        .user-actions a:hover { background: rgba(142,108,136,0.1); color: var(--accent-color); }

        /* Flash 消息 */
        .flash-messages { position: fixed; top: 70px; right: 20px; z-index: 1000; max-width: 400px; }
        .alert { padding: 15px 20px; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.3s ease-out; }
        .alert-success { background: #10b981; color: white; }
        .alert-info { background: #3b82f6; color: white; }
        .alert-error { background: #ef4444; color: white; }
        .alert .close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-left: 15px; opacity: 0.8; }
        .alert .close:hover { opacity: 1; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* 塔罗容器 */
        .tarot-container { max-width:800px; width:100%; margin:80px auto 20px; padding:30px; background: rgba(255,255,255,0.9); border-radius:20px; box-shadow:0 15px 30px rgba(0,0,0,0.1); text-align:center; position:relative; overflow:hidden; }
        .tarot-container::before { content:""; position:absolute; top:-10px; left:-10px; right:-10px; bottom:-10px; background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); z-index:-1; border-radius:25px; }
        .header h1 { font-size:2.8rem; color:var(--accent-color); margin-bottom:10px; text-shadow:2px 2px 4px rgba(0,0,0,0.1); }
        .header p { font-size:1.2rem; color:var(--dark-color); max-width:600px; margin:0 auto; }

        .tarot-card { width:200px; height:320px; margin:0 auto 30px; background: linear-gradient(135deg, var(--secondary-color), #c0a58d); border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.15); display:flex; align-items:center; justify-content:center; position:relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.175,0.885,0.32,1.275); cursor:pointer; }
        .tarot-card:hover { transform: translateY(-10px) rotate(5deg); }
        .tarot-card i { font-size:4rem; color: rgba(109,76,103,0.3); }
        .tarot-card::after { content:""; position:absolute; top:15px; left:15px; right:15px; bottom:15px; border:2px solid rgba(109,76,103,0.2); border-radius:10px; }

        .action-section { margin:30px 0; }
        .btn-tarot { display:inline-flex; align-items:center; justify-content:center; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); color:white; padding:15px 35px; border:none; border-radius:50px; font-size:1.2rem; font-weight:600; cursor:pointer; text-decoration:none; transition: all 0.3s ease; box-shadow:0 10px 20px rgba(142,108,136,0.3); }
        .btn-tarot:hover { transform: translateY(-3px); box-shadow:0 15px 25px rgba(142,108,136,0.4); }
        .btn-tarot:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-tarot i { margin-right:10px; }
        .info-text { font-size:1rem; color:var(--accent-color); margin-top:15px; }

        .features { display:flex; justify-content:space-around; flex-wrap:wrap; margin:40px 0; }
        .feature { flex:0 0 30%; min-width:200px; margin:10px; padding:20px; background:rgba(255,255,255,0.7); border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s ease; cursor:pointer; text-decoration:none; color:inherit; }
        .feature:hover { transform: translateY(-5px); }
        .feature i { font-size:2.5rem; color:var(--primary-color); margin-bottom:15px; }
        .feature h3 { font-size:1.3rem; color:var(--accent-color); margin-bottom:10px; }
        .feature p { font-size:0.95rem; color:var(--dark-color); }

        .footer { text-align:center; margin-top:30px; color:var(--accent-color); font-size:0.9rem; }

        .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center; }
        .loading-content { text-align:center; color:white; padding:30px; background: rgba(109,76,103,0.9); border-radius:15px; max-width:400px; }
        .spinner { width:50px; height:50px; border:5px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:white; animation:spin 1s linear infinite; margin:0 auto 20px; }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* 已抽牌 */
        .already-drawn { background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); color: white; padding: 12px 25px; border-radius: 50px; display: inline-flex; align-items: center; gap: 10px; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(142,108,136,0.3); }
        .already-drawn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(142,108,136,0.4); color: white; }

        /* 运势概览 */
        .fortune-overview { background: rgba(255,255,255,0.95); border-radius: 20px; padding: 25px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 2px solid rgba(142,108,136,0.1); display:none; }
        .fortune-title { font-size: 1.5rem; color: var(--accent-color); margin-bottom: 10px; font-weight: 600; text-align:center; }
        .overall-score { font-size: 3rem; font-weight: bold; color: var(--primary-color); margin: 15px 0; text-align:center; }
        .dimension-card { background: rgba(142,108,136,0.05); border: 1px solid rgba(142,108,136,0.2); border-radius: 12px; padding: 15px; text-align: center; margin:10px; display:inline-block; width:130px; }
        .dimension-stars { margin:5px 0; color:var(--star-color); }
        .lucky-elements { margin-top:20px; }
        .lucky-grid { display:flex; justify-content:space-around; flex-wrap:wrap; margin-top:10px; }
        .lucky-item { background:rgba(255,255,255,0.7); border-radius:10px; padding:10px; width:100px; margin:5px; text-align:center; }
        .fortune-summary { margin-top:15px; background: rgba(255,255,255,0.8); border-left:4px solid var(--primary-color); padding:10px; border-radius:8px; font-style:italic; }

        @media (max-width:768px){
            .tarot-container{padding:20px; margin-top:60px;}
            .header h1{font-size:2.2rem;}
            .tarot-card{width:180px;height:280px;}
            .btn-tarot{padding:12px 25px;font-size:1.1rem;}
            .feature{flex:0 0 100%;}
            .flash-messages { right: 10px; left: 10px; max-width: none; }
            .dimension-card{width:100px;margin:5px;}
            .lucky-item{width:80px;margin:3px;}
        }
    </style>
</head>
<body>
    <!-- 用户栏 -->
    <div class="user-bar">
        <div class="user-bar-content">
            <div class="user-info">
                <div class="user-icon">
                    {% if not user.is_guest %}{{ user.username[0]|upper }}{% else %}<i class="fas fa-user"></i>{% endif %}
                </div>
                <span class="user-name">{{ user.username if not user.is_guest else "神秘访客" }}</span>
            </div>
            <div class="user-actions">
                {% if user.is_guest %}
                    <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> 登录</a>
                    <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> 注册</a>
                {% else %}
                    <a href="{{ url_for('stats') }}"><i class="fas fa-chart-line"></i> 统计</a>
                    <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> 退出</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Flash 消息 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <span>{{ message }}</span>
                        <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- 塔罗抽牌 -->
    <div class="tarot-container">
        <div class="header">
            <h1><i class="fas fa-star"></i> 每日塔罗运势 <i class="fas fa-star"></i></h1>
            <p>探索宇宙的奥秘，揭示今日的指引</p>
        </div>
        <div class="tarot-card"><i class="fas fa-question"></i></div>

        {% if user.is_guest and not has_drawn %}
            <div class="guest-tip">
                <i class="fas fa-info-circle"></i>
                <span>作为访客，解读仅在本次浏览有效。<a href="{{ url_for('register') }}" style="color: var(--primary-color); text-decoration: underline;">注册账号</a>可保存历史记录。</span>
            </div>
        {% endif %}

        <div class="action-section">
            {% if has_drawn %}
                <a href="{{ url_for('result') }}" class="already-drawn"><i class="fas fa-eye"></i> 查看今日塔罗解读</a>
                <div class="info-text">您今天已经抽取过塔罗牌了</div>
            {% else %}
                <form id="draw-form" action="{{ url_for('draw_card') }}" method="post">
                    <button type="submit" class="btn-tarot" id="draw-btn"><i class="fas fa-hand-sparkles"></i> 抽取今日塔罗牌</button>
                </form>
                <div class="info-text">点击按钮开始抽取今日塔罗牌</div>
            {% endif %}
        </div>

        <!-- 运势概览 -->
        <div id="fortune-overview" class="fortune-overview">
            <div class="fortune-title">今日运势概览</div>
            <div id="overall-score" class="overall-score"></div>
            <div id="score-label" style="text-align:center;font-weight:bold;color:var(--accent-color);"></div>
            <div id="fortune-dimensions" style="display:flex;justify-content:center;flex-wrap:wrap;"></div>
            <div id="lucky-elements"></div>
            <div id="fortune-summary" class="fortune-summary"></div>
            <button id="refresh-fortune" class="btn-tarot" style="margin-top:15px;"><i class="fas fa-sync-alt"></i> 刷新运势</button>
        </div>

        <div class="features">
            <div class="feature"><i class="fas fa-moon"></i><h3>每日指引</h3><p>每天抽取一张塔罗牌，获取专属今日的宇宙指引和能量提示</p></div>
            <div class="feature"><i class="fas fa-book-open"></i><h3>深度解读</h3><p>AI 智能解读，为您提供个性化的塔罗牌深层含义</p></div>
            <div class="feature" onclick="goHistory()"><i class="fas fa-history"></i><h3>历史记录</h3><p>{{ '查看您的抽卡记录和运势趋势' if not user.is_guest else '注册后可保存历史记录' }}</p></div>
        </div>

        <div class="footer">
            © 2025 塔罗运势 | 宇宙能量，智慧指引<br>
            <small style="opacity: 0.7;">每日凌晨重置，基于北京时间</small>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>正在连接宇宙能量</h3>
            <p>塔罗牌正在揭示您的今日运势，请稍候...</p>
        </div>
    </div>

    <script>
        // 抽牌表单 loading 动画
        document.getElementById('draw-form')?.addEventListener('submit', function(e){
            e.preventDefault();
            const btn = document.getElementById('draw-btn');
            btn.disabled = true;
            document.getElementById('loading-overlay').style.display='flex';
            setTimeout(() => this.submit(), 1000 + Math.random() * 1000);
        });

        // 历史记录跳转
        function goHistory(){
            {% if user.is_guest %}
                if(confirm("查看历史记录需要登录账号，是否前往登录？")) {
                    window.location.href = "{{ url_for('login', next=url_for('stats')) }}";
                }
            {% else %}
                window.location.href = "{{ url_for('stats') }}";
            {% endif %}
        }

        // Flash 自动隐藏
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => alert.remove(), 300);
            });
        }, 5000);

        const style = document.createElement('style');
        style.textContent = '@keyframes slideOut { to { transform: translateX(120%); opacity: 0; } }';
        document.head.appendChild(style);

        // 运势数据渲染
        const fortuneData = {{ fortune_data|tojson | safe }};
        function renderFortune(data){
            const overview = document.getElementById('fortune-overview');
            overview.style.display='block';
            document.getElementById('overall-score').textContent = data.overall_score;
            document.getElementById('score-label').textContent = data.overall_label;

            const dimensionsContainer = document.getElementById('fortune-dimensions');
            dimensionsContainer.innerHTML='';
            data.dimensions.forEach(dim=>{
                const stars = Array.from({length:5},(_,i)=>i<dim.stars?'★':'☆').join('');
                const card = document.createElement('div');
                card.className='dimension-card';
                card.innerHTML = `<div><i class="${dim.icon}"></i></div><div>${dim.name}</div><div class="dimension-stars">${stars}</div><div>${dim.level}</div>`;
                dimensionsContainer.appendChild(card);
            });

            const luckyContainer = document.getElementById('lucky-elements');
            luckyContainer.innerHTML = '<div class="fortune-title">幸运元素</div><div class="lucky-grid"></div>';
            const grid = luckyContainer.querySelector('.lucky-grid');
            data.lucky_elements.forEach(el=>{
                const item = document.createElement('div');
                item.className='lucky-item';
                item.innerHTML = `<div><i class="${el.icon}"></i></div><div>${el.name}</div><div>${el.value}</div>`;
                grid.appendChild(item);
            });

            document.getElementById('fortune-summary').textContent = data.summary;
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            {% if has_drawn %}
                renderFortune(fortuneData);
            {% endif %}
        });

        document.getElementById('refresh-fortune')?.addEventListener('click', ()=>{
            fetch("{{ url_for('api_fortune') }}")
                .then(res=>res.json())
                .then(data=>renderFortune(data))
                .catch(err=>alert("运势刷新失败，请稍后再试"));
        });
    </script>
</body>
</html>
