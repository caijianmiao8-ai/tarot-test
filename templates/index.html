<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯æ—¥å¡”ç½—è¿åŠ¿ Â· è‹¥æ°´å åœ</title>

  <!-- æœ¬åœ° Bootstrap / FontAwesomeï¼ˆä¿ç•™ä½ çš„ä¾èµ–è·¯å¾„ï¼‰ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">

  <!-- å­—ä½“ï¼ˆä¸åˆ†äº«å¡ç»Ÿä¸€çš„æ°”è´¨ï¼›æ— æ³•åŠ è½½æ—¶è‡ªåŠ¨å›é€€ç³»ç»Ÿå­—ä½“ï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* â€”â€” ä½é¥±å’Œã€ä½å¯¹æ¯”çš„ç¥ç§˜ç´«ç³» â€”â€” */
      --primary: #8f7aa1;      /* ä¸»æŒ‰é’®æ¸å˜èµ·ç‚¹ï¼ˆæ›´æŸ”å’Œï¼‰ */
      --secondary: #5f4e6b;    /* ä¸»æŒ‰é’®æ¸å˜ç»ˆç‚¹ï¼ˆæ·±ä¸€äº›ï¼‰ */
      --accent: #7b6887;       /* ç‚¹ç¼€è‰²ï¼ˆè¾ƒä¸Šä¸€ç‰ˆæ›´å†…æ•›ï¼‰ */
      --gold: #d9c89e;         /* é‡‘è‰²ï¼ˆé™ä½æ˜åº¦ï¼‰ */
      --gold-light: #ebdfba;   /* æ·¡é‡‘ï¼ˆæ–‡æœ¬é«˜äº®ï¼‰ */
      --rose: #d39cab;

      --bg-deep-1: #281c42;    /* èƒŒæ™¯æ¸å˜èµ·ç‚¹ */
      --bg-deep-2: #171327;    /* èƒŒæ™¯æ¸å˜ç»ˆç‚¹ */

      --text: #f4f1fb;         /* ä¸»æ–‡æœ¬ï¼ˆç•¥åæš–çš„ç™½ï¼‰ */
      --text-strong: #ffffff;  /* çº¯ç™½ */
      --text-light: rgba(244,241,251,0.9);
      --text-muted: rgba(244,241,251,0.68);

      --panel: rgba(255,255,255,0.05);
      --panel-2: rgba(255,255,255,0.07);
      --border: rgba(255,255,255,0.12);
      --glass: rgba(255,255,255,0.06);

      --star-color: #f0cb4e;
      --success-color: #0ea672;
      --warning-color: #e59a1a;
      --danger-color: #e74646;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}

    body{
      font-family: 'Noto Serif SC', -apple-system, BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',serif;
      color: var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: 20px;
      background:
        radial-gradient(1100px 650px at 18% 12%, rgba(143,122,161,0.16), transparent 60%),
        radial-gradient(1100px 650px at 82% 88%, rgba(217,200,158,0.10), transparent 60%),
        linear-gradient(135deg, var(--bg-deep-1) 0%, var(--bg-deep-2) 100%);
      position: relative;
      overflow-x: hidden;
    }

    /* ===== èƒŒæ™¯åŠ¨æ•ˆï¼šä½å¯¹æ¯”æ˜Ÿå±‘ + é»„é“ç¯ï¼ˆæ›´æŸ”å’Œï¼‰ ===== */
    .bg-cosmos{ position: fixed; inset: 0; z-index: -2; pointer-events: none; }
    .bg-stars{
      position:absolute; inset:0; opacity: .18;
      background-image:
        radial-gradient(1px 1px at 12% 25%, #fff, transparent),
        radial-gradient(1px 1px at 32% 60%, #fff, transparent),
        radial-gradient(1px 1px at 62% 30%, #fff, transparent),
        radial-gradient(1px 1px at 82% 70%, #fff, transparent),
        radial-gradient(1px 1px at 22% 80%, #fff, transparent);
      background-size: 230px 230px;
      animation: twinkle 5.6s ease-in-out infinite alternate;
    }
    @keyframes twinkle { from{opacity:.12} to{opacity:.28} }

    .zodiac-ring{
      position:absolute; width: 780px; height: 780px; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      opacity:.09; filter: drop-shadow(0 0 18px rgba(255,255,255,0.08));
      animation: slow-rotate 110s linear infinite;
    }
    @keyframes slow-rotate{ to{ transform: translate(-50%,-50%) rotate(360deg)} }

    .bg-glow{
      position:absolute; inset:-10%;
      background:
        radial-gradient(560px 560px at 20% 12%, rgba(143,122,161,0.14), transparent 60%),
        radial-gradient(560px 560px at 80% 88%, rgba(217,200,158,0.10), transparent 60%);
      filter: blur(32px);
      animation: float 22s ease-in-out infinite alternate;
    }
    @keyframes float{ from{transform: translateY(-1.5%)} to{transform: translateY(1.5%)} }

    /* ===== é¡¶éƒ¨ç”¨æˆ·æ  ===== */
    .user-bar{
      position:fixed; top:0; left:0; right:0; z-index:100;
      background: rgba(20,16,33,0.58);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .user-bar-content{
      max-width: 1200px; margin: 0 auto; padding: 10px 20px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .user-info{ display:flex; align-items:center; gap:12px; }
    .user-icon{
      width:36px; height:36px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff; font-weight:700;
      border:1px solid var(--border); box-shadow:0 2px 8px rgba(0,0,0,.18);
    }
    .user-name{ color: var(--gold-light); font-weight:600; letter-spacing:.5px; }

    .user-actions{ display:flex; gap:10px; }
    .user-actions a{
      color: var(--text-light); text-decoration:none; font-size:.95rem;
      padding:8px 14px; border-radius:18px; border:1px solid transparent;
      transition: .25s ease; background: rgba(255,255,255,0.05);
      backdrop-filter: blur(8px);
    }
    .user-actions a:hover{
      color:#fff; border-color: var(--border);
      transform: translateY(-1px);
    }

    /* ===== flash æ¶ˆæ¯ ===== */
    .flash-messages{
      position:fixed; top:68px; right:20px; z-index:200; max-width: 380px;
    }
    .alert{
      padding: 12px 14px; margin-bottom: 10px; border-radius: 10px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 6px 18px rgba(0,0,0,.18); color:#fff; border:none;
      animation: slideIn .3s ease-out;
      backdrop-filter: blur(6px);
    }
    .alert-success{ background: rgba(16,166,114,.92); }
    .alert-info   { background: rgba(59,130,246,.92); }
    .alert-error  { background: rgba(231,70,70,.92);  }
    .alert .close{ background:none; border:none; color:#fff; font-size:1.4rem; opacity:.85; }
    .alert .close:hover{ opacity:1 }
    @keyframes slideIn{ from{transform: translateX(100%); opacity:0} to{transform: translateX(0); opacity:1} }

    /* ===== ä¸»å®¹å™¨ ===== */
    .main-container{ max-width: 980px; width:100%; margin: 88px auto 24px; }

    /* ===== å¡”ç½—æŠ½ç‰Œå®¹å™¨ ===== */
    .tarot-container{
      position:relative; overflow:hidden; margin-bottom: 30px;
      padding: 28px; border-radius: 22px;
      background: rgba(255,255,255,0.05);
      border:1px solid var(--border);
      box-shadow: 0 18px 36px rgba(0,0,0,.26), inset 0 1px 0 rgba(255,255,255,.07);
    }
    .tarot-container::before{
      content:""; position:absolute; inset:-2px;
      background: radial-gradient(480px 280px at -5% -5%, rgba(143,122,161,.16), transparent 50%),
                  radial-gradient(480px 280px at 105% 105%, rgba(217,200,158,.10), transparent 50%);
      filter: blur(6px); z-index:-1;
    }
    .header h1{
      font-size: 2.1rem; color: var(--gold-light); letter-spacing: .8px;
      text-shadow: 0 2px 8px rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .header h1 i{ color: var(--gold-light) }
    .header p{ color: var(--text-muted); text-align:center; margin-top: 6px; }

    .tarot-card{
      width: 220px; height: 340px; margin: 24px auto 10px;
      border-radius: 14px; overflow:hidden; position:relative;
      background: linear-gradient(135deg, rgba(143,122,161,.30), rgba(217,200,158,.16));
      border:1px solid var(--border);
      box-shadow: 0 12px 30px rgba(0,0,0,.24);
      transform-style: preserve-3d;
      transition: transform .8s cubic-bezier(.175,.885,.32,1.275), box-shadow .35s ease;
      cursor: pointer;
    }
    .tarot-card:hover{ transform: translateY(-5px) rotate(2.5deg); box-shadow: 0 16px 36px rgba(0,0,0,.30); }
    .tarot-card::after{
      content:""; position:absolute; inset:14px; border-radius: 10px;
      border:1px solid rgba(255,255,255,0.2);
    }

    .action-section{ margin:16px 0 6px; text-align:center; }
    .btn-tarot{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 26px; border-radius:24px; border:1px solid var(--border);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff; font-weight:700; letter-spacing:.35px;
      box-shadow:0 10px 22px rgba(143,122,161,.28);
      text-decoration:none; transition:.28s;
    }
    .btn-tarot:hover{ transform: translateY(-2px); box-shadow:0 14px 26px rgba(143,122,161,.36); color:#fff; }
    .btn-tarot:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .already-drawn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 20px; border-radius:22px; color:#fff; text-decoration:none;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border:1px solid var(--border); box-shadow: 0 10px 22px rgba(143,122,161,.28);
      transition:.28s;
    }
    .already-drawn:hover{ transform: translateY(-1px); box-shadow: 0 14px 26px rgba(143,122,161,.36); color:#fff; }

    .guest-tip{
      max-width:520px; margin: 12px auto 0; padding: 12px 14px;
      border-radius:12px; background: rgba(255,255,255,.05); border:1px solid var(--border); color: var(--text-light);
    }

    /* ===== è¿åŠ¿å¡ç‰‡ ===== */
    .fortune-card{
      background: rgba(255,255,255,0.05);
      border:1px solid var(--border);
      border-radius: 22px;
      padding: 0;
      box-shadow: 0 16px 36px rgba(0,0,0,.24);
      overflow:hidden; display:none;
    }
    .fortune-header{
      background: linear-gradient(135deg, rgba(143,122,161,.26), rgba(217,200,158,.12));
      color: var(--text);
      padding: 24px; text-align:center; position:relative; overflow:hidden;
      border-bottom: 1px solid var(--border);
    }
    .fortune-header::before{
      content:''; position:absolute; width:320px; height:320px; top:-120px; right:-60px;
      background: rgba(255,255,255,.06); border-radius:50%;
    }
    .fortune-header::after{
      content:''; position:absolute; width:220px; height:220px; bottom:-120px; left:-60px;
      background: rgba(255,255,255,.04); border-radius:50%;
    }
    .fortune-date{ font-size:.95rem; color: var(--text-muted); margin-bottom:6px; }
    .fortune-score{ font-size: 3.6rem; font-weight: 800; letter-spacing: .8px; color: var(--gold-light); text-shadow: 0 2px 10px rgba(0,0,0,.18); display:inline-block; }
    .fortune-score::after{ content:'åˆ†'; font-size: 1.1rem; font-weight: 400; margin-left: 6px; color: var(--text-light); }
    .fortune-label{
      margin-top:10px; display:inline-block; padding: 6px 16px; border-radius: 18px;
      background: rgba(255,255,255,.14); color: var(--text); font-weight: 700; letter-spacing:.5px;
      border:1px solid var(--border);
    }
    .fortune-summary{ font-size: .98rem; line-height: 1.7; color: var(--text-light); max-width: 680px; margin: 10px auto 0; }

    .dimensions-section{ padding: 22px; background: rgba(0,0,0,.07); }
    .section-title{ font-size:1.1rem; color: var(--gold-light); text-align:center; margin-bottom:14px; font-weight:700; }
    .dimensions-grid{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 18px;
    }
    .dimension-item{
      background: rgba(255,255,255,.05); border:1px solid var(--border); border-radius: 14px; padding: 14px;
      text-align:center; box-shadow: 0 4px 12px rgba(0,0,0,.10); transition:.22s ease;
    }
    .dimension-item:hover{ transform: translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.14); }
    .dimension-icon{
      width: 40px; height: 40px; border-radius:12px; margin: 0 auto 8px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff; display:flex; align-items:center; justify-content:center; font-size:1.05rem;
      border:1px solid var(--border);
    }
    .dimension-name{ font-weight:700; color: var(--text); margin-bottom: 6px; }
    .dimension-stars{ font-size:1rem; color: var(--star-color); letter-spacing: 2px; margin-bottom: 4px; }
    .dimension-level{ font-size:.9rem; color: var(--text-muted); background: rgba(255,255,255,.08); border:1px solid var(--border); border-radius: 12px; display:inline-block; padding: 4px 10px; }

    .advice-grid{ display:grid; gap:10px; }
    .advice-item{
      background: rgba(255,255,255,.05); border:1px solid var(--border); border-radius:12px;
      padding: 12px 15px; display:flex; align-items:center; gap:12px; box-shadow: 0 2px 8px rgba(0,0,0,.08);
    }
    .advice-icon{
      width: 32px; height: 32px; border-radius:10px; background: rgba(255,255,255,.1);
      display:flex; align-items:center; justify-content:center; color: var(--gold-light);
    }
    .advice-name{ font-weight:700; color: var(--text); font-size: .95rem; margin-bottom: 2px; }
    .advice-text{ color: var(--text-muted); font-size: .95rem; line-height:1.5; }

    .bottom-section{ padding: 22px; display:grid; grid-template-columns: 1fr 1.5fr; gap: 20px }
    .lucky-section{ background: rgba(255,255,255,.05); border:1px solid var(--border); border-radius: 14px; padding: 14px; }
    .lucky-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .lucky-item{ background: rgba(255,255,255,.08); border:1px solid var(--border); border-radius: 12px; text-align:center; padding: 10px; }
    .lucky-label{ font-size:.88rem; color: var(--text-muted); margin-bottom: 4px; }
    .lucky-value{ font-weight:700; color: var(--gold-light); font-size: 1.02rem; }

    .suggestions-section{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .suggestion-card{ background: rgba(255,255,255,.05); border:1px solid var(--border); border-radius: 14px; padding: 14px; }
    .suggestion-header{ display:flex; align-items:center; gap:10px; margin-bottom: 8px; }
    .suggestion-icon{
      width: 28px; height: 28px; border-radius: 8px; color: #fff; display:flex; align-items:center; justify-content:center;
    }
    .suggestion-do   .suggestion-icon{ background: var(--success-color); }
    .suggestion-dont .suggestion-icon{ background: var(--danger-color); }
    .suggestion-title{ font-weight:700; font-size: 1rem; }
    .suggestion-list{ list-style:none; margin:0; padding:0; }
    .suggestion-list li{ padding: 6px 0 6px 20px; position:relative; color: var(--text-muted); line-height: 1.5; }
    .suggestion-list li::before{ content:'â€¢'; position:absolute; left: 6px; top: 3px; font-weight:700; }
    .suggestion-do   li::before{ color: var(--success-color); }
    .suggestion-dont li::before{ color: var(--danger-color); }

    .action-bar{
      padding: 14px; text-align:center; background: rgba(255,255,255,.05); border-top: 1px solid var(--border);
    }
    .btn-refresh, .btn-ai-chat{
      padding: 10px 18px; border-radius: 20px; border:1px solid var(--border);
      background: linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff;
      font-weight:700; box-shadow: 0 6px 16px rgba(143,122,161,.26);
      transition:.25s ease; text-decoration: none; display:inline-block;
    }
    .btn-ai-chat{ margin-left:8px }
    .btn-refresh:hover, .btn-ai-chat:hover{ transform: translateY(-2px); box-shadow: 0 10px 22px rgba(143,122,161,.36); color:#fff; }

    /* ===== å³ä¸‹è§’æ‚¬æµ®æ°”æ³¡ï¼ˆæ‰“å¼€åˆ†äº«å¡ï¼‰ ===== */
    .fab-share{
      position: fixed; right: 20px; bottom: 20px; z-index: 300;
      width: 56px; height: 56px; border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      color:#fff; cursor:pointer; border:1px solid var(--border);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 12px 24px rgba(143,122,161,.28);
      transition: .25s ease;
    }
    .fab-share:hover{ transform: translateY(-2px); box-shadow: 0 16px 30px rgba(143,122,161,.36); }
    .fab-share.disabled{ opacity:.55; cursor: not-allowed; transform:none; box-shadow:none; }
    .fab-tip{
      position:absolute; right: 70px; bottom: 18px; padding:8px 12px; border-radius:10px;
      background: rgba(255,255,255,.06); border:1px solid var(--border); color: var(--text-light);
      backdrop-filter: blur(8px); white-space: nowrap; font-size: .9rem;
    }

    /* ===== åˆ†äº«å¡å¼¹å±‚ï¼ˆoverlayï¼Œå†…åµŒ share cardï¼‰ ===== */
    .sc-overlay{ position: fixed; inset:0; z-index: 500; display:none; align-items:center; justify-content:center; }
    .sc-mask{ position:absolute; inset:0; background: rgba(0,0,0,.5); backdrop-filter: blur(2px); }
    .sc-panel{
      position: relative; z-index:1; max-width: 96vw; max-height: 96vh; padding: 14px;
      border-radius: 16px; background: rgba(255,255,255,.05); border:1px solid var(--border);
      box-shadow: 0 18px 40px rgba(0,0,0,.34);
      display:flex; flex-direction:column; align-items:center; gap:10px;
    }
    .sc-close{
      position:absolute; right:10px; top: 10px; width:34px; height:34px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      color:#fff; background: rgba(255,255,255,.08); border:1px solid var(--border);
    }

    /* ===== share-cardï¼ˆç»“æ„ä¸å‰ç‰ˆä¸€è‡´ï¼Œé™ä½å¯¹æ¯”ï¼‰ ===== */
    .frame{ width:min(400px, 90vw); height:min(710px, 90vh); position:relative;
            border-radius:18px; overflow:hidden;
            background: linear-gradient(180deg, #241b39 0%, #18142a 100%);
            box-shadow: 0 18px 38px rgba(0,0,0,0.58), inset 0 1px 0 rgba(255,255,255,0.07);
    }
    .bg-glow-card{ position:absolute; width:150%; height:150%; top:-25%; left:-25%;
      background: radial-gradient(circle at 30% 20%, rgba(143,122,161,0.12) 0%, transparent 40%),
                  radial-gradient(circle at 70% 80%, rgba(217,200,158,0.08) 0%, transparent 40%);
      filter:blur(36px); animation: float 20s ease-in-out infinite; pointer-events:none; }
    .sparkles-card{
      position:absolute; inset:0; opacity:.2;
      background-image: radial-gradient(1px 1px at 10% 20%, white, transparent),
                        radial-gradient(1px 1px at 30% 60%, white, transparent),
                        radial-gradient(1px 1px at 60% 30%, white, transparent);
      background-size: 220px 220px; animation: twinkle 5s ease-in-out infinite alternate; pointer-events:none;
    }
    .content-card{ position:absolute; inset:0; padding:14px; display:flex; flex-direction:column; z-index:1; overflow:hidden; }
    .header-card{ text-align:center; padding-bottom:8px; flex-shrink:0; }
    .brand{ font-size:9px; letter-spacing:3px; color:var(--gold-light); font-weight:300; opacity:.82; }
    .date-info{ margin-top:4px; font-size:10px; color:var(--text-muted); }

    .card-section{ display:flex; gap:12px; margin-bottom:10px; flex-shrink:0; }
    .card-image-wrapper{ width:128px; height:192px; border-radius:10px; overflow:hidden; background:var(--glass); border:1px solid var(--border);
      box-shadow:0 8px 18px rgba(0,0,0,.26), inset 0 1px 0 rgba(255,255,255,.08); flex-shrink:0; }
    .card-image-wrapper img{ width:100%; height:100%; object-fit:cover; }
    .card-placeholder{ width:100%; height:100%; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg, rgba(143,122,161,0.28), rgba(217,200,158,0.16));
      color:var(--text-muted); font-size:44px; font-weight:100; }
    .card-info{ flex:1; display:flex; flex-direction:column; justify-content:center; min-width:0; }
    .card-name{ font-size:19px; font-weight:700; margin-bottom:6px; background:linear-gradient(90deg, var(--gold-light), var(--gold));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; line-height:1.2; }
    .card-direction{ display:inline-flex; align-items:center; gap:5px; font-size:12px; color:var(--text-light); margin-bottom:10px; }
    .direction-dot{ width:4px; height:4px; border-radius:50%; background:var(--gold); }

    .score-container{ display:flex; align-items:center; gap:12px; padding:9px 12px; background:var(--glass); border-radius:18px; border:1px solid var(--border); }
    .score-ring{ --progress:.75; width:40px; height:40px; border-radius:50%;
      background: conic-gradient(from 180deg, var(--gold) calc(var(--progress)*360deg), var(--glass) calc(var(--progress)*360deg));
      display:flex; align-items:center; justify-content:center; position:relative; flex-shrink:0; }
    .score-ring::before{ content:''; position:absolute; inset:4px; border-radius:50%; background:#18142a; }
    .score-value{ position:relative; font-size:15px; font-weight:700; color:var(--gold); }
    .score-text{ flex:1; min-width:0 }
    .score-label{ font-size:9px; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase; }
    .score-grade{ font-size:13px; font-weight:600; color:var(--gold-light); }

    .dimensions-card{ display:flex; justify-content:space-between; padding:8px; background:var(--glass); border-radius:12px; border:1px solid var(--border); margin-bottom:8px; flex-shrink:0; }
    .dim-item{ flex:1; text-align:center; min-width:0 }
    .dim-circle{ width:28px; height:28px; margin:0 auto 4px; border-radius:50%; background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.14); display:flex; align-items:center; justify-content:center; font-size:13px; }
    .dim-label{ font-size:9px; color:var(--text-muted); margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .dim-rating{ display:flex; justify-content:center; gap:1px; }
    .star{ width:7px; height:7px; background:var(--glass); clip-path:polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
    .star.filled{ background:linear-gradient(135deg, var(--gold-light), var(--gold)); }

    .message-section{ flex:1; min-height:0; display:flex; flex-direction:column; padding:10px; background:linear-gradient(135deg, rgba(143,122,161,0.08), transparent);
      border-radius:12px; border:1px solid var(--border); margin-bottom:8px; overflow:hidden; }
    .message-label{ font-size:10px; color:var(--text-light); letter-spacing:2px; margin-bottom:6px; text-align:center; font-weight:500; }
    .message-text{ flex:0 0 auto; font-size:12px; line-height:1.55; color:var(--text-light); font-weight:300; text-align:center; padding:2px 2px 6px;
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; }
    .tips{ margin-top:6px; display:grid; grid-template-columns:1fr 1fr; gap:8px; min-height:0; flex:1; }
    .tip-col{ background:var(--glass); border:1px solid var(--border); border-radius:10px; padding:8px; display:flex; flex-direction:column; min-height:0; }
    .tips-title{ font-size:10px; color:var(--text-muted); letter-spacing:1px; text-align:center; margin-bottom:6px; }
    .tips-list{ list-style:none; display:grid; gap:6px; overflow:hidden; }
    .tips-list li{ font-size:11px; line-height:1.42; color:var(--text-light); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; }
    .tips-list li::marker{ display:none }
    .tips-list li::before{ content:'â€¢ '; color:var(--gold-light); }

    .lucky-bar{ display:flex; justify-content:space-around; padding:7px; background:var(--glass); border-radius:10px; margin-bottom:8px; flex-shrink:0; border:1px solid var(--border) }
    .lucky-item{ text-align:center; flex:1; min-width:0 }
    .lucky-icon{ width:18px; height:18px; margin:0 auto 3px; border-radius:50%; background:rgba(255,255,255,.1); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:10px; color:var(--text-light) }
    .color-icon{ background:var(--gold); }
    .lucky-val{ font-size:9px; color:var(--text-light); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .footer-card{ display:flex; align-items:center; gap:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,.08); flex-shrink:0; }
    .qr-wrapper{ width:34px; height:34px; padding:3px; background:#fff; border-radius:6px; }
    .qrph{ width:100%; height:100%; background:repeating-linear-gradient(45deg,#000,#000 2px,#fff 2px,#fff 4px); }
    .site-info{ flex:1; min-width:0; }
    .site-name{ font-size:9px; color:var(--text-light); margin-bottom:1px; }
    .site-url{ font-size:8px; color:var(--text-muted); }
    .hidden{ display:none !important; }

    /* â€”â€” æ•è·æ¨¡å¼ï¼ˆå¯¼å‡ºå›¾ç‰‡æ—¶ç»Ÿä¸€æ¸²æŸ“ï¼‰ â€”â€” */
    .sc-capture, .sc-capture *{
      animation: none !important; transition: none !important; filter: none !important; backdrop-filter: none !important;
    }
    .sc-capture .bg-glow-card, .sc-capture .sparkles-card{ display:none !important }
    .sc-capture .score-ring{ background: none !important }
    .sc-capture #SC_svgRing{ display:block !important }
    #SC_svgRing{ display:none }

    /* Share é¢æ¿æŒ‰é’®ï¼ˆè½»æ ·å¼ï¼‰ */
    .sc-panel .btn, .sc-panel .btn.ghost{
      background: linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; border:none; padding:10px 14px; border-radius:16px; font-weight:700; cursor:pointer;
      box-shadow:0 10px 20px rgba(143,122,161,.26); transition:.2s
    }
    .sc-panel .btn:hover{ transform: translateY(-1px) }
    .sc-panel .btn.ghost{ background: rgba(255,255,255,.06); border:1px solid var(--border); color: var(--text-light); box-shadow:none }
    .sc-panel .btn.hidden{ display:none }

    /* å“åº” */
    @media (max-width: 768px){
      .main-container{ margin-top: 74px; }
      .bottom-section{ grid-template-columns: 1fr; }
      .suggestions-section{ grid-template-columns: 1fr; }
      .dimensions-grid{ grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
      .fortune-score{ font-size: 3rem; }
      .lucky-grid{ grid-template-columns: 1fr; }
      .card-section{ gap:10px }
      .card-image-wrapper{ width:120px; height:180px }
      .message-text{ -webkit-line-clamp:4 } /* ç§»åŠ¨ç«¯å¤šä¸€è¡Œï¼Œå‡å°‘æˆªæ–­æ„Ÿ */
    }
  </style>
</head>
<body>
  <!-- èƒŒæ™¯åŠ¨æ•ˆå±‚ï¼ˆæŸ”å’Œç‰ˆï¼‰ -->
  <div class="bg-cosmos" aria-hidden="true">
    <div class="bg-stars"></div>
    <svg class="zodiac-ring" viewBox="0 0 100 100">
      <g fill="none" stroke="#fff" stroke-opacity=".65" stroke-width=".28">
        <circle cx="50" cy="50" r="44"/>
        <circle cx="50" cy="50" r="34" stroke-opacity=".4"/>
        <g stroke-opacity=".22">
          <line x1="50" y1="6" x2="50" y2="94"/>
          <line x1="6" y1="50" x2="94" y2="50"/>
          <line x1="18" y1="18" x2="82" y2="82"/>
          <line x1="18" y1="82" x2="82" y2="18"/>
        </g>
      </g>
      <g fill="#fff" fill-opacity=".5" font-size="6" font-family="serif">
        <text x="50" y="10" text-anchor="middle">â™ˆï¸â™‰ï¸â™Šï¸â™‹ï¸â™Œï¸â™ï¸â™ï¸â™ï¸â™ï¸â™‘ï¸â™’ï¸â™“ï¸</text>
      </g>
    </svg>
    <div class="bg-glow"></div>
  </div>

  <!-- é¡¶éƒ¨ç”¨æˆ·æ  -->
  <div class="user-bar">
    <div class="user-bar-content">
      <div class="user-info">
        <div class="user-icon">
          {% if not user.is_guest %}{{ user.username[0]|upper }}{% else %}<i class="fas fa-user"></i>{% endif %}
        </div>
        <span class="user-name">{{ user.username if not user.is_guest else "ç¥ç§˜è®¿å®¢" }}</span>
      </div>
      <div class="user-actions">
        {% if user.is_guest %}
          <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> ç™»å½•</a>
          <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> æ³¨å†Œ</a>
        {% else %}
          <a href="{{ url_for('stats') }}"><i class="fas fa-chart-line"></i> ç»Ÿè®¡</a>
          <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Flash æ¶ˆæ¯ -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            <span>{{ message }}</span>
            <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ä¸»å®¹å™¨ -->
  <div class="main-container">
    <!-- å¡”ç½—æŠ½ç‰Œ -->
    <div class="tarot-container">
      <div class="header">
        <h1><i class="fas fa-star"></i> æ¯æ—¥å¡”ç½—è¿åŠ¿ <i class="fas fa-star"></i></h1>
        <p>æ¢ç´¢å®‡å®™çš„å¥¥ç§˜ï¼Œæ­ç¤ºä»Šæ—¥çš„æŒ‡å¼•</p>
      </div>

      <div class="tarot-card" id="tarot-card-display">
        {% if today_card %}
          {% if today_card.image %}
            <img src="{{ today_card.image }}" alt="{{ today_card.name }}" style="width:100%;height:100%;object-fit:cover;border-radius:14px;">
            <div class="card-info" style="position:absolute;left:0;right:0;bottom:0;padding:16px;border-radius:0 0 14px 14px;background:linear-gradient(to top, rgba(0,0,0,.58), transparent);color:#fff;">
              <div style="font-weight:700;font-size:1.04rem;text-shadow:0 2px 6px rgba(0,0,0,.35);">{{ today_card.name }}</div>
              <div style="font-size:.9rem;opacity:.9;margin-top:4px;">{{ today_card.direction }}</div>
            </div>
          {% else %}
            <div style="text-align:center;padding: 24px;color:var(--text-light);">
              <i class="fas fa-sun" style="font-size:3rem;margin-bottom:14px;color: var(--gold-light)"></i>
              <div style="font-weight:700;font-size:1.08rem;color:#fff;margin-bottom:6px;">{{ today_card.name }}</div>
              <div style="font-size:.95rem;color:var(--text-muted)">{{ today_card.direction }}</div>
            </div>
          {% endif %}
        {% else %}
          <i class="fas fa-question" style="color: var(--text-muted); font-size: 2rem;"></i>
        {% endif %}
      </div>

      {% if user.is_guest and not has_drawn %}
        <div class="guest-tip"><i class="fas fa-info-circle"></i>
          <span>ä½œä¸ºè®¿å®¢ï¼Œè§£è¯»ä»…åœ¨æœ¬æ¬¡æµè§ˆæœ‰æ•ˆã€‚<a href="{{ url_for('register') }}" style="color: var(--gold-light); text-decoration: underline;">æ³¨å†Œè´¦å·</a>å¯ä¿å­˜å†å²è®°å½•ã€‚</span>
        </div>
      {% endif %}

      <div class="action-section">
        {% if has_drawn %}
          <a href="{{ url_for('result') }}" class="already-drawn"><i class="fas fa-eye"></i> æŸ¥çœ‹ä»Šæ—¥å¡”ç½—è§£è¯»</a>
          <div style="margin-top: 14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background: linear-gradient(135deg, #456896, #2a3f70);">
              <i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ
            </a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot">
              <i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ
            </a>
          </div>
          <div class="info-text" style="margin-top:8px;color:var(--text-muted)">æ‚¨ä»Šå¤©å·²ç»æŠ½å–è¿‡å¡”ç½—ç‰Œäº†</div>
        {% else %}
          <form id="draw-form" action="{{ url_for('draw_card') }}" method="post">
            <button type="submit" class="btn-tarot" id="draw-btn"><i class="fas fa-hand-sparkles"></i> æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œ</button>
          </form>
          <div style="margin-top: 14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <a href="{{ url_for('spread') }}" class="btn-tarot" style="background:#6c757d;">
              <i class="fas fa-layer-group"></i> è‡ªé€‰ç‰Œé˜µ
            </a>
            <a href="{{ url_for('guide_spread') }}" class="btn-tarot">
              <i class="fas fa-magic"></i> å¼•å¯¼é€‰æ‹©ç‰Œé˜µ
            </a>
          </div>
          <div class="info-text" style="margin-top:8px;color:var(--text-muted)">ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œï¼Œæˆ–ç›´æ¥è¿›å…¥ç‰Œé˜µå åœ</div>
        {% endif %}
      </div>
    </div>

    <!-- è¿åŠ¿å¡ç‰‡ï¼ˆä¿ç•™ï¼‰ -->
    <div id="fortune-card" class="fortune-card">
      <div class="fortune-header">
        <div class="fortune-date">{{ today }} Â· ä»Šæ—¥è¿åŠ¿</div>
        <div class="fortune-score" id="overall-score">-</div>
        <div class="fortune-label" id="overall-label">-</div>
        <div class="fortune-summary" id="fortune-summary-text"></div>
      </div>

      <div class="dimensions-section">
        <h3 class="section-title">äº”ç»´åº¦è¿åŠ¿æŒ‡æ•°</h3>
        <div class="dimensions-grid" id="dimensions-grid"></div>
        <div class="advice-grid" id="advice-grid"></div>
      </div>

      <div class="bottom-section">
        <div class="lucky-section">
          <h3 class="section-title" style="margin-bottom:12px;">ä»Šæ—¥å¹¸è¿å…ƒç´ </h3>
          <div class="lucky-grid" id="lucky-grid"></div>
        </div>
        <div class="suggestions-section">
          <div class="suggestion-card suggestion-do">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-check"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å®œåš</div>
            </div>
            <ul class="suggestion-list" id="do-list"></ul>
          </div>
          <div class="suggestion-card suggestion-dont">
            <div class="suggestion-header">
              <div class="suggestion-icon"><i class="fas fa-times"></i></div>
              <div class="suggestion-title">ä»Šæ—¥å¿Œåš</div>
            </div>
            <ul class="suggestion-list" id="dont-list"></ul>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn-refresh" onclick="refreshFortune()"><i class="fas fa-sync-alt"></i> åˆ·æ–°è¿åŠ¿</button>
        {% if has_drawn %}
          <a href="{{ url_for('chat_page') }}" class="btn-ai-chat"><i class="fas fa-comments"></i> AI æ·±åº¦è§£è¯»</a>
          <!-- å‰ç«¯å¼¹å±‚æ–¹å¼æ‰“å¼€åˆ†äº«å¡ -->
          <button type="button" class="btn-ai-chat" id="openShareBtn"><i class="fas fa-share-alt"></i> ç”Ÿæˆåˆ†äº«å¡ç‰‡</button>
        {% endif %}
      </div>
    </div>

    <!-- åŠŸèƒ½ç‰¹ç‚¹ -->
    <div class="features" style="display:flex;justify-content:space-around;flex-wrap:wrap;margin:26px 0;gap:12px;">
      <a class="feature" onclick="goHistory()" style="flex:0 0 30%;min-width:220px;padding:18px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.12);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-moon" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.08rem;color:#fff;margin-bottom:6px;">æ¯æ—¥æŒ‡å¼•</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">æ¯å¤©æŠ½å–ä¸€å¼ å¡”ç½—ç‰Œï¼Œè·å–ä¸“å±ä»Šæ—¥çš„å®‡å®™æŒ‡å¼•</p>
      </a>
      <a class="feature" href="{{ url_for('guide_spread') }}" style="flex:0 0 30%;min-width:220px;padding:18px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.12);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-magic" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.08rem;color:#fff;margin-bottom:6px;">å¼•å¯¼é€‰æ‹©ç‰Œé˜µ</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">åƒå’Œå åœå¸ˆèŠå¤©ä¸€æ ·ï¼Œç”±ç³»ç»Ÿå¼•å¯¼é€‰æ‹©æœ€åˆé€‚çš„ç‰Œé˜µ</p>
      </a>
      <a class="feature" onclick="goHistory()" style="flex:0 0 30%;min-width:220px;padding:18px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.12);transition:.25s;text-decoration:none;color:inherit;">
        <i class="fas fa-history" style="font-size:2rem;color:var(--gold-light);margin-bottom:10px;"></i>
        <h3 style="font-size:1.08rem;color:#fff;margin-bottom:6px;">å†å²è®°å½•</h3>
        <p style="font-size:.95rem;color:var(--text-muted)">{{ 'æŸ¥çœ‹æ‚¨çš„æŠ½å¡è®°å½•å’Œè¿åŠ¿è¶‹åŠ¿' if not user.is_guest else 'æ³¨å†Œåå¯ä¿å­˜å†å²è®°å½•' }}</p>
      </a>
    </div>

    <div class="footer" style="text-align:center;color:var(--text-muted);font-size:.94rem;margin-top: 2px;">
      Â© 2025 å¡”ç½—è¿åŠ¿ | å®‡å®™èƒ½é‡ï¼Œæ™ºæ…§æŒ‡å¼•<br>
      <small style="opacity:.72;">æ¯æ—¥å‡Œæ™¨é‡ç½®ï¼ŒåŸºäºåŒ—äº¬æ—¶é—´</small>
    </div>
  </div>

  <!-- åˆ†äº«å¡ï¼šå³ä¸‹è§’æ‚¬æµ®æ°”æ³¡ -->
  <div class="fab-share {% if not has_drawn %}disabled{% endif %}" id="fabShare" title="ç”Ÿæˆåˆ†äº«å¡ç‰‡">
    <i class="fas fa-share-alt"></i>
    <div class="fab-tip">ç”Ÿæˆåˆ†äº«å¡ç‰‡</div>
  </div>

  <!-- åˆ†äº«å¡å¼¹å±‚ï¼ˆå†…åµŒ share-cardï¼‰ -->
  <div class="sc-overlay" id="scOverlay" aria-modal="true" role="dialog">
    <div class="sc-mask" id="scMask"></div>
    <div class="sc-panel">
      <button class="sc-close" id="scClose"><i class="fas fa-times"></i></button>

      <!-- share card æœ¬ä½“ -->
      <div class="frame" id="SC_card">
        <div class="bg-glow-card"></div>
        <div class="sparkles-card"></div>

        <div class="content-card">
          <div class="header-card">
            <div class="brand">RUOSHUI TAROT</div>
            <div class="date-info"><span id="SC_date">--</span> Â· <span id="SC_user">ç¥ç§˜è®¿å®¢</span></div>
          </div>

          <div class="card-section">
            <div class="card-image-wrapper">
              <img id="SC_img" alt="Tarot" class="hidden"/>
              <div id="SC_imgPh" class="card-placeholder">âœ¦</div>
            </div>
            <div class="card-info">
              <div>
                <div class="card-name" id="SC_name">â€”</div>
                <div class="card-direction"><span class="direction-dot"></span><span id="SC_dir">â€”</span></div>
              </div>
              <div class="score-container">
                <div class="score-ring" id="SC_ring"><span class="score-value" id="SC_score">â€”</span></div>
                <svg id="SC_svgRing" viewBox="0 0 40 40" width="40" height="40" style="position:absolute; left:14px">
                  <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#ebdfba"/><stop offset="1" stop-color="#d9c89e"/></linearGradient></defs>
                  <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,.16)" stroke-width="4"/>
                  <circle id="SC_svgFG" cx="20" cy="20" r="16" fill="none" stroke="url(#g)" stroke-width="4" stroke-linecap="round" stroke-dasharray="100" stroke-dashoffset="100"/>
                </svg>
                <div class="score-text">
                  <div class="score-label">Fortune</div>
                  <div class="score-grade" id="SC_grade">â€”</div>
                </div>
              </div>
            </div>
          </div>

          <div class="dimensions-card" id="SC_dims"></div>

          <div class="message-section">
            <div class="message-label">ä»Šæ—¥è¿åŠ¿è§£è¯»</div>
            <div class="message-text" id="SC_summary">â€”</div>
            <div class="tips">
              <div class="tip-col">
                <div class="tips-title">ä»Šæ—¥å®œåš</div>
                <ul class="tips-list" id="SC_do"></ul>
              </div>
              <div class="tip-col">
                <div class="tips-title">ä»Šæ—¥å¿Œåš</div>
                <ul class="tips-list" id="SC_dont"></ul>
              </div>
            </div>
          </div>

          <div class="lucky-bar">
            <div class="lucky-item">
              <div class="lucky-icon color-icon" id="SC_swatch"></div>
              <div class="lucky-val" id="SC_color">â€”</div>
            </div>
            <div class="lucky-item">
              <div class="lucky-icon">âœ§</div>
              <div class="lucky-val" id="SC_number">â€”</div>
            </div>
            <div class="lucky-item">
              <div class="lucky-icon">â˜½</div>
              <div class="lucky-val" id="SC_hour">â€”</div>
            </div>
            <div class="lucky-item">
              <div class="lucky-icon">â—ˆ</div>
              <div class="lucky-val" id="SC_directionDisplay">â€”</div>
            </div>
          </div>

          <div class="footer-card">
            <div class="qr-wrapper">
              <img id="SC_qr" alt="QR" class="hidden"/>
              <div id="SC_qrPh" class="qrph"></div>
            </div>
            <div class="site-info">
              <div class="site-name">è‹¥æ°´å åœ Â· æ¯æ—¥æŒ‡å¼•</div>
              <div class="site-url" id="SC_site">www.ruoshui.fun</div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæ  -->
      <div style="display:flex; gap:10px; margin-top:4px;">
        <button class="btn" id="SC_btnGen">âœ¨ ç”Ÿæˆåˆ†äº«</button>
        <button class="btn ghost hidden" id="SC_btnCopy">ğŸ”— å¤åˆ¶é“¾æ¥</button>
        <button class="btn ghost" id="SC_btnSave">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
      </div>
    </div>
  </div>

  <!-- æ•°æ®æ³¨å…¥ï¼ˆé¦–é¡µ + åˆ†äº«å¡å…±ç”¨ï¼‰ -->
  <script id="INDEX_DATA" type="application/json">
    {
      "user_name": "{{ user.username if not user.is_guest else 'ç¥ç§˜è®¿å®¢' }}",
      "today": "{{ today }}",
      "has_drawn": {{ 'true' if has_drawn else 'false' }},
      "reading": {{ (today_card or {})|tojson }},
      "fortune": {{ (fortune_data or {})|tojson }}
    }
  </script>

  <!-- ä¾èµ–ï¼šhtml2canvas + html-to-imageï¼ˆäº’ä¸ºå…œåº•ï¼Œä¿è¯å¯¼å‡ºä¸€è‡´æ€§ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js" defer></script>

  <script>
    /* ========= å·¥å…· ========= */
    const $ = (id)=>document.getElementById(id);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    function generateStars(rating){ const full = Math.floor(rating||0); let s=''; for(let i=0;i<5;i++) s+=(i<full?'â˜…':'â˜†'); return s; }
    function labelScore(s){ s=Number(s)||0; if(s>=85)return'å¤§å‰'; if(s>=70)return'ä¸­å‰'; if(s>=55)return'å°å‰'; return'å¹³' }
    function waitFontsImages(root){
      const fonts = document.fonts ? document.fonts.ready : Promise.resolve();
      const imgs = Array.from(root.querySelectorAll('img'));
      const waiting = imgs.map(img=> (img.complete && img.naturalWidth) ? Promise.resolve() : new Promise(res=>{ img.addEventListener('load',res,{once:true}); img.addEventListener('error',res,{once:true}); }));
      return Promise.all([fonts, ...waiting]);
    }

    /* ========= é¦–é¡µæ¸²æŸ“ ========= */
    const dimensionIcons = {
      "äº‹ä¸šè¿": "fas fa-briefcase","è´¢å¯Œè¿": "fas fa-coins","çˆ±æƒ…è¿": "fas fa-heart","å¥åº·è¿": "fas fa-heartbeat","è´µäººè¿": "fas fa-hands-helping"
    };

    document.addEventListener('DOMContentLoaded', ()=>{
      const data = JSON.parse($('INDEX_DATA').textContent || '{}');
      if (data.fortune && Object.keys(data.fortune).length>0) renderFortune(data.fortune);

      // æŠ½ç‰ŒæŒ‰é’®
      document.getElementById('draw-form')?.addEventListener('submit', function(e){
        e.preventDefault(); const btn = document.getElementById('draw-btn'); btn.disabled = true;
        setTimeout(()=>this.submit(), 900 + Math.random()*900);
      });

      // åˆ†äº«å¡å…¥å£ï¼ˆæŒ‰é’®+æ‚¬æµ®æ°”æ³¡ï¼‰
      const openShare = ()=>{
        if(!data.has_drawn){ alert('è¯·å…ˆæŠ½å–ä»Šæ—¥å¡”ç½—ç‰Œ'); return; }
        SC_open({ user_name:data.user_name, date:data.today, reading:data.reading||{}, fortune:data.fortune||{} });
      };
      $('openShareBtn')?.addEventListener('click', openShare);
      $('fabShare')?.addEventListener('click', ()=>{ if(!$('fabShare').classList.contains('disabled')) openShare(); });
    });

    function renderFortune(data){
      $('fortune-card').style.display = 'block';
      $('overall-score').textContent = data.overall_score || '-';
      $('overall-label').textContent = data.overall_label || '-';
      const summaryText = (data.fortune_text && data.fortune_text.summary) || data.summary || '';
      $('fortune-summary-text').textContent = summaryText;

      const grid = $('dimensions-grid'); grid.innerHTML = '';
      if (data.dimensions && Array.isArray(data.dimensions)) {
        data.dimensions.forEach(dim => {
          const stars = generateStars(dim.stars || 3);
          const icon = dimensionIcons[dim.name] || 'fas fa-star';
          grid.insertAdjacentHTML('beforeend', `
            <div class="dimension-item">
              <div class="dimension-icon"><i class="${icon}"></i></div>
              <div class="dimension-name">${dim.name}</div>
              <div class="dimension-stars">${stars}</div>
              <div class="dimension-level">${dim.level || 'â€”'}</div>
            </div>`);
        });
      }

      const adviceGrid = $('advice-grid'); adviceGrid.innerHTML = '';
      if (data.fortune_text && data.fortune_text.dimension_advice) {
        Object.entries(data.fortune_text.dimension_advice).forEach(([name, advice])=>{
          const icon = dimensionIcons[name] || 'fas fa-star';
          adviceGrid.insertAdjacentHTML('beforeend', `
            <div class="advice-item">
              <div class="advice-icon"><i class="${icon}"></i></div>
              <div class="advice-content">
                <div class="advice-name">${name}</div>
                <div class="advice-text">${advice}</div>
              </div>
            </div>`);
        });
      }

      const luckyGrid = $('lucky-grid'); luckyGrid.innerHTML = '';
      if (data.lucky_elements) {
        if (Array.isArray(data.lucky_elements)) {
          data.lucky_elements.forEach(item=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item">
                <div class="lucky-label">${item.name}</div>
                <div class="lucky-value">${item.value}</div>
              </div>`);
          });
        } else if (typeof data.lucky_elements === 'object') {
          const nameMap = { 'color':'å¹¸è¿é¢œè‰²','number':'å¹¸è¿æ•°å­—','hour':'å¹¸è¿æ—¶è¾°','direction':'å¹¸è¿æ–¹ä½' };
          Object.entries(data.lucky_elements).forEach(([k,v])=>{
            luckyGrid.insertAdjacentHTML('beforeend', `
              <div class="lucky-item">
                <div class="lucky-label">${nameMap[k] || k}</div>
                <div class="lucky-value">${v}</div>
              </div>`);
          });
        }
      }

      const doList = $('do-list'); doList.innerHTML = '';
      if (data.fortune_text && data.fortune_text.do) data.fortune_text.do.forEach(x=> doList.insertAdjacentHTML('beforeend', `<li>${x}</li>`));
      const dontList = $('dont-list'); dontList.innerHTML = '';
      if (data.fortune_text && data.fortune_text.dont) data.fortune_text.dont.forEach(x=> dontList.insertAdjacentHTML('beforeend', `<li>${x}</li>`));
    }

    function goHistory(){
      {% if user.is_guest %}
        if(confirm("æŸ¥çœ‹å†å²è®°å½•éœ€è¦ç™»å½•è´¦å·ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ")){
          window.location.href = "{{ url_for('login', next=url_for('stats') ) }}";
        }
      {% else %}
        window.location.href = "{{ url_for('stats') }}";
      {% endif %}
    }

    function refreshFortune(){
      const today = "{{ today }}";
      const btn = event.target.closest('button'); btn.disabled = true;
      fetch(`{{ url_for('api_fortune', date='') }}${today}`)
        .then(r=>r.json())
        .then(d=>{ if(d.error) alert(d.error); else renderFortune(d); })
        .catch(e=>{ console.error(e); alert('è¿åŠ¿åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•'); })
        .finally(()=>{ btn.disabled=false; });
    }

    /* ================= åˆ†äº«å¡ï¼ˆSC_ å‰ç¼€ï¼‰ ================= */
    const SC_COLOR_MAP = {
      "çº¢":"#d66575","çº¢è‰²":"#d66575","ç«çº¢":"#d25a7a","ç²‰":"#dba1b9","ç²‰è‰²":"#dba1b9",
      "æ©™":"#e49457","æ©™è‰²":"#e49457","é‡‘":"#cdb98e","é‡‘è‰²":"#cdb98e",
      "é»„":"#e4c96a","é»„è‰²":"#e4c96a","ç»¿":"#5ba680","ç»¿è‰²":"#5ba680",
      "è“":"#6c98d6","è“è‰²":"#6c98d6","ç´«":"#7b6887","ç´«è‰²":"#7b6887",
      "ç™½":"#efe9dc","ç™½è‰²":"#efe9dc","é»‘":"#2a2a2a","é»‘è‰²":"#2a2a2a"
    };
    const SC$ = (id)=>document.getElementById(id);
    function SC_colorToHex(name){ if(!name) return null; for(const k in SC_COLOR_MAP){ if(name.includes(k)) return SC_COLOR_MAP[k]; } return null; }
    function SC_parseDimsStr(s){ const out={}; if(typeof s!=='string') return out; s.split(/\n+/).forEach(l=>{const m=l.match(/^(.*?)[ï¼š:]\s*([\d.]+)\s*æ˜Ÿ/); if(m){out[m[1].trim()]=parseFloat(m[2])}}); return out; }
    function SC_createStars(v){ v=Number(v)||0; const full=Math.floor(v); let a=''; for(let i=0;i<5;i++) a+=`<span class="star${i<full?' filled':''}"></span>`; return a; }

    function SC_open(payload){
      const overlay = SC$('scOverlay'); overlay.style.display='flex';
      SC$('scMask')?.addEventListener('click', SC_close, {once:true});
      SC$('scClose')?.addEventListener('click', SC_close, {once:true});

      SC$('SC_btnGen').onclick = SC_generate;
      SC$('SC_btnCopy').onclick = ()=> SC_copy(SC$('SC_site').textContent);
      SC$('SC_btnSave').onclick = SC_saveImage;

      SC_render(payload);
    }
    function SC_close(){ SC$('scOverlay').style.display='none'; }

    function SC_render({user_name, date, reading, fortune}){
      // Header
      SC$('SC_user').textContent = user_name || 'ç¥ç§˜è®¿å®¢';
      SC$('SC_date').textContent = date || '--';

      // å¡é¢ä¿¡æ¯
      const name = reading?.card_name || reading?.name || 'â€”';
      const dir  = reading?.direction || reading?.card_direction || 'â€”';
      SC$('SC_name').textContent = name;
      SC$('SC_dir').textContent  = dir;

      const img = reading?.image || reading?.card_image || '';
      if(img){
        const imgel = SC$('SC_img');
        imgel.crossOrigin = 'anonymous';
        imgel.onload = ()=>{ imgel.classList.remove('hidden'); SC$('SC_imgPh').classList.add('hidden'); };
        imgel.onerror = ()=>{ imgel.classList.add('hidden'); SC$('SC_imgPh').classList.remove('hidden'); };
        imgel.src = img;
      }else{
        SC$('SC_img').classList.add('hidden'); SC$('SC_imgPh').classList.remove('hidden');
      }

      // åˆ†æ•°
      const score = Number(fortune?.overall_score ?? fortune?.overall ?? 0);
      const p = clamp(score,0,100)/100;
      SC$('SC_score').textContent = score ? String(score) : 'â€”';
      SC$('SC_ring').style.setProperty('--progress', p.toFixed(3));
      SC$('SC_grade').textContent = labelScore(score);
      // SVG åœ†ç¯ï¼ˆå¯¼å‡ºæ—¶ä½¿ç”¨ï¼‰
      const dash = 2*Math.PI*16; // r=16
      SC$('SC_svgFG').setAttribute('stroke-dasharray', String(dash));
      SC$('SC_svgFG').setAttribute('stroke-dashoffset', String(dash*(1-p)));

      // ç»´åº¦
      const dimsWrap = SC$('SC_dims'); dimsWrap.innerHTML='';
      let dimsMap = {};
      if(typeof fortune?.dimensions === 'string') dimsMap = SC_parseDimsStr(fortune.dimensions);
      else if(Array.isArray(fortune?.dimensions)){ fortune.dimensions.forEach(d=>{ if(d?.name) dimsMap[d.name]=Number(d.stars ?? d.score ?? 0) }) }
      else if(typeof fortune?.dimensions === 'object' && fortune.dimensions) dimsMap = fortune.dimensions;
      const order = [
        {k:'äº‹ä¸šè¿', s:'äº‹ä¸š', i:'ğŸ’¼'},
        {k:'è´¢å¯Œè¿', s:'è´¢å¯Œ', i:'ğŸ’°'},
        {k:'çˆ±æƒ…è¿', s:'çˆ±æƒ…', i:'ğŸ’•'},
        {k:'å¥åº·è¿', s:'å¥åº·', i:'ğŸŒ¿'},
        {k:'è´µäººè¿', s:'è´µäºº', i:'âœ¨'}
      ];
      order.forEach(o=>{
        const v = dimsMap[o.k] ?? dimsMap[o.s];
        if(v==null) return;
        const node = document.createElement('div');
        node.className = 'dim-item';
        node.innerHTML = `<div class="dim-circle">${o.i}</div><div class="dim-label">${o.s}</div><div class="dim-rating">${SC_createStars(v)}</div>`;
        dimsWrap.appendChild(node);
      });

      // è§£è¯» + å®œ/å¿Œï¼ˆè‡ªé€‚åº”ï¼Œé˜²æº¢å‡ºï¼‰
      const summary = (fortune?.fortune_text?.summary) || fortune?.summary || 'ä»Šæ—¥æ°”æ¯æ¾„æ˜ï¼Œéšé¡ºè€Œä¸ºï¼Œæ¸©æŸ”æ¥å¥½è¿ã€‚';
      SC$('SC_summary').textContent = summary;

      const dos = (fortune?.fortune_text?.do || fortune?.do || []);
      const donts = (fortune?.fortune_text?.dont || fortune?.dont || []);
      SC$('SC_do').innerHTML   = (dos.length? dos : ['æ•´ç†ç¯å¢ƒï¼Œæ¢³ç†æƒ…ç»ª']).slice(0,3).map(x=>`<li>${x}</li>`).join('');
      SC$('SC_dont').innerHTML = (donts.length? donts : ['é¿å…å†²åŠ¨ä¸æƒ…ç»ªæ¶ˆè´¹']).slice(0,3).map(x=>`<li>${x}</li>`).join('');

      // å¹¸è¿
      const colorName = fortune?.lucky_color || fortune?.lucky_elements?.color || '';
      const hex = (colorName && Object.keys(SC_COLOR_MAP).some(k=>colorName.includes(k))) ? SC_colorToHex(colorName) : null;
      if(hex) SC$('SC_swatch').style.background = hex;
      SC$('SC_color').textContent     = colorName || 'â€”';
      SC$('SC_number').textContent    = fortune?.lucky_number || fortune?.lucky_elements?.number || 'â€”';
      SC$('SC_hour').textContent      = fortune?.lucky_hour   || fortune?.lucky_elements?.hour   || 'â€”';
      const dirLuck = fortune?.lucky_direction || fortune?.lucky_elements?.direction || 'â€”';
      SC$('SC_directionDisplay').textContent = dirLuck;

      // ç«™ç‚¹ & äºŒç»´ç ï¼ˆæŒ‰ä½ çš„è¦æ±‚ï¼šäºŒç»´ç æŒ‡å‘ä¸»é¡µï¼‰
      SC$('SC_site').textContent = 'www.ruoshui.fun';
      SC$('SC_qr').classList.add('hidden'); SC$('SC_qrPh').classList.remove('hidden');

      // ä¿å­˜å½“å‰æ•°æ®ï¼ˆå¦‚éœ€äºŒæ¬¡ä½¿ç”¨ï¼‰
      window.__SC_PAYLOAD__ = { user_name, date, reading, fortune };
    }

    async function SC_generate(){
      const btn = SC$('SC_btnGen'); btn.disabled=true; btn.textContent='ç”Ÿæˆä¸­â€¦';
      try{
        const r = await fetch('/api/share/create',{ method:'POST' });
        const d = await r.json();
        if(!d.success) throw new Error(d.error || 'ç”Ÿæˆå¤±è´¥');

        // å¤åˆ¶ï¼šä½¿ç”¨åç«¯è¿”å›çš„ share_urlï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™é¦–é¡µ
        const copyUrl = d.share_url || 'https://www.ruoshui.fun';
        SC$('SC_site').textContent = copyUrl;
        SC$('SC_btnCopy').classList.remove('hidden');
        SC$('SC_btnCopy').onclick = ()=> SC_copy(copyUrl);

        // äºŒç»´ç ï¼šè‹¥åç«¯ç»™äº†å°±ç”¨ï¼›è‹¥æ²¡æœ‰åˆ™ä¿æŒå ä½ï¼ˆäºŒç»´ç ç›®æ ‡ç”±åç«¯å†³å®šï¼›ä½ çš„åç«¯å·²æ”¹ä¸ºä¸»é¡µï¼‰
        if(d.qr_code){
          const img = SC$('SC_qr');
          img.src = d.qr_code;
          img.onload = ()=>{ img.classList.remove('hidden'); SC$('SC_qrPh').classList.add('hidden'); };
        }

        btn.textContent='å·²ç”Ÿæˆ';
      }catch(e){
        alert(e.message || 'ç”Ÿæˆå¤±è´¥');
        btn.textContent='âœ¨ ç”Ÿæˆåˆ†äº«';
      }finally{
        btn.disabled=false;
      }
    }

    function SC_copy(text){
      (navigator.clipboard? navigator.clipboard.writeText(text) : Promise.reject())
      .then(()=>alert('é“¾æ¥å·²å¤åˆ¶'))
      .catch(()=>{
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove(); alert('é“¾æ¥å·²å¤åˆ¶');
      });
    }

    function SC_beginCapture(){
      const card = SC$('SC_card'); card.classList.add('sc-capture');
      return ()=> card.classList.remove('sc-capture');
    }

    async function SC_saveImage(){
      // éšè—æ“ä½œæŒ‰é’®ï¼Œé¿å…è¢«æˆªè¿›å›¾é‡Œ
      const btns=[SC$('SC_btnGen'),SC$('SC_btnCopy'),SC$('SC_btnSave')];
      btns.forEach(b=> b?.classList.add('hidden'));

      const end = SC_beginCapture();
      const card = SC$('SC_card');
      try{
        await waitFontsImages(card);
        if(window.htmlToImage?.toPng){
          const dataUrl = await htmlToImage.toPng(card, {pixelRatio:2.4, backgroundColor:'#18142a', cacheBust:true});
          const a=document.createElement('a'); a.href=dataUrl; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click();
        }else{
          const canvas = await html2canvas(card, {scale:2.2, useCORS:true, backgroundColor:'#18142a', removeContainer:true, logging:false});
          const url = canvas.toDataURL('image/png');
          const a=document.createElement('a'); a.href=url; a.download=`ruoshui_tarot_${Date.now()}.png`; a.click();
        }
      }catch(e){
        console.error(e); alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }finally{
        end();
        btns.forEach(b=> b?.classList.remove('hidden'));
      }
    }

    /* Flash è‡ªåŠ¨æ·¡å‡º */
    setTimeout(()=>{
      (document.querySelectorAll('.alert')||[]).forEach(el=>{
        el.style.transition='transform .3s ease, opacity .3s ease';
        el.style.transform='translateX(120%)'; el.style.opacity='0';
        setTimeout(()=> el.remove(), 320);
      });
    }, 5000);
  </script>
</body>
</html>
