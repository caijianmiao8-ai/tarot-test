<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>æ™ºèƒ½ç‰Œé˜µæ¨è - å¡”ç½—å åœ</title>

  <!-- æœ¬åœ°åŒ–èµ„æºï¼ˆä¸ spread.html ä¿æŒä¸€è‡´ï¼‰ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">

  <style>
    /* =========================
       ä¸»é¢˜å˜é‡ï¼ˆä¸ spread.html ç»Ÿä¸€ï¼‰
       ========================= */
    :root{
      --primary-color: #8e6c88;   /* ä¸é¦™ç´«ï¼ˆä¸»è‰²ï¼‰ */
      --accent-color:  #6d4c67;   /* æ·±æ¢…ç´«ï¼ˆå¼ºè°ƒï¼‰ */
      --secondary-color:#d1bfa7;  /* é¦™æ§Ÿç±³ï¼ˆè¾…åŠ©ï¼‰ */
      --bg-ivory:      #f8f4e9;   /* è±¡ç‰™æµ…åº• */
      --ink:           #333333;   /* æ·±æ–‡æœ¬ */
      --muted:         #7a707a;   /* æ¬¡æ–‡æœ¬ */

      --card:          #ffffff;
      --border:        rgba(0,0,0,0.08);
      --shadow-sm:     0 4px 16px rgba(30,20,35,0.08);
      --shadow-md:     0 10px 28px rgba(30,20,35,0.12);
      --shadow-lg:     0 16px 44px rgba(30,20,35,0.16);

      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;
    }

    html,body{ height:100dvh; height:calc(var(--vh,1vh)*100) }
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-sans-serif, -apple-system, "PingFang SC","Microsoft YaHei", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background:
        radial-gradient(1000px 800px at 10% 0%, #fbf9f3 0%, rgba(251,249,243,0) 60%),
        radial-gradient(1200px 900px at 90% 10%, #f3ece1 0%, rgba(243,236,225,0) 60%),
        linear-gradient(135deg, #f8f4e9 0%, #ece4d7 100%);
      display: flex;
      flex-direction: column;
      min-height: calc(var(--vh,1vh)*100);
      overflow-x: hidden;
    }

    /* ============= é¡¶éƒ¨å¯¼èˆªï¼ˆä¸ spread.html ç»Ÿä¸€ï¼‰ ============= */
    .navbar{
      position:sticky; top:0; z-index:1000;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      padding-top: env(safe-area-inset-top, 0px);
    }
    .navbar-content{
      max-width:1200px; margin:0 auto; padding:14px 20px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .back-link{
      display:flex; align-items:center; gap:8px;
      color:var(--accent-color); text-decoration:none; font-weight:700;
      transition: color .2s ease, transform .2s ease;
      border: 1px solid transparent;
      padding: 6px 10px;
      border-radius: 999px;
    }
    .back-link:hover{ color:var(--primary-color); transform: translateX(-2px); background: rgba(0,0,0,0.02); }
    .nav-title{
      font-size:18px; font-weight:800; color:var(--accent-color);
    }

    /* ============= ä¸»å®¹å™¨ ============= */
    .main{
      max-width:900px; width:100%; margin:40px auto; padding:0 20px; flex:1;
      display: flex; flex-direction: column;
    }

    .guide{
      background: rgba(255,255,255,0.95);
      border-radius: var(--radius-lg);
      border:1px solid var(--border);
      box-shadow: var(--shadow-md);
      overflow:hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* è£…é¥°æ¡ */
    .decor{
      height:6px;
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
    }

    .stage{
      padding:32px 28px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;            /* âœ… å…è®¸æ»šåŠ¨åŒºæ”¶ç¼© */
    }

    /* ============= è¿›åº¦æŒ‡ç¤ºå™¨ ============= */
    .progress{
      display:flex; gap:12px; justify-content:center; margin-bottom:20px;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:#e5e7eb;
      transition: all .3s ease;
    }
    .dot.active{
      width:28px;
      background:var(--primary-color);
      box-shadow: 0 4px 12px rgba(142,108,136,.3);
    }
    .dot.done{ background:var(--secondary-color); }

    /* ============= å¯¹è¯åŒºåŸŸ ============= */
    .msgs{
      display:flex; flex-direction:column; gap:16px;
      flex: 1 1 0%;        /* âœ… ç¨³å®š flex è¡Œä¸º */
      min-height: 0;       /* âœ… é…åˆçˆ¶å®¹å™¨å¯æ”¶ç¼© */
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) transparent;
      scroll-behavior: smooth;   /* âœ… è‡ªåŠ¨æ»šåŠ¨æ›´é¡ºæ»‘ */
    }
    .msgs::-webkit-scrollbar { width: 6px; }
    .msgs::-webkit-scrollbar-track { background: transparent; }
    .msgs::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 3px;
    }

    .msg{
      display:flex; gap:14px;
      animation: msgSlideIn .25s ease-out;
      max-width: 100%;
    }
    @keyframes msgSlideIn{
      from{opacity:0; transform:translateY(8px);}
      to{opacity:1; transform:translateY(0);}
    }

    .ava{
      width:40px; height:40px; border-radius:50%;
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
      color:#fff; display:flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
      font-size: 14px;
    }

    .bubble{
      background: var(--card);
      padding:16px 16px;
      border-radius: var(--radius-md);
      border-bottom-left-radius:6px;
      line-height:1.6;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      flex: 1;
      white-space: pre-line;
    }

    /* æŠ˜å å†å²å¯¹è¯ï¼ˆä»…ä¿ç•™æœ€è¿‘2æ¡å±•å¼€ï¼‰ */
    .msg.collapsed .bubble{ padding:10px 12px; opacity:.85; }
    .msg.collapsed .options{ display:none !important; }
    .msg.collapsed{ gap:10px; }
    .user.collapsed .me{ padding:8px 12px; font-weight:500; opacity:.9; }

    /* ============= é€‰é¡¹åŒºåŸŸï¼šä¸¤åˆ—ç½‘æ ¼ï¼ˆæ¡Œé¢ç«¯ï¼‰ ============= */
    .options{
      display:grid;                 /* âœ… ä»ç«–æ’æ”¹ä¸ºç½‘æ ¼ */
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px; margin-top:12px;
      align-items: stretch;
    }
    .opt{
      background: var(--card);
      border:2px solid var(--border);
      border-radius: var(--radius-md);
      padding:14px 14px;
      display:flex; align-items:center; gap:12px;
      cursor:pointer;
      transition: all .2s ease;
      position: relative;
      overflow: hidden;
      min-height: 64px;            /* âœ… ç»Ÿä¸€é«˜åº¦ï¼Œç´§å‡‘ä½†ä¸æ‹¥æŒ¤ */
      outline: none;
    }
    .opt:focus{ border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(142,108,136,0.15); }
    .opt::before {
      content: '';
      position: absolute;
      top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(142,108,136,0.05), transparent);
      transition: left .4s ease;
    }
    .opt:hover::before { left: 100%; }
    .opt:hover{
      background: rgba(142,108,136,0.02);
      border-color: var(--primary-color);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    .opt .emoji{ width:28px; text-align:center; font-size:22px; flex-shrink: 0; }
    .opt .content { flex: 1; min-width: 0; }
    .opt .ttl{
      font-weight:700; color:var(--accent-color); font-size: 15px;
      margin-bottom: 2px; line-height: 1.25;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .opt .desc{
      font-size:13px; color:var(--muted); line-height: 1.2;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .opt .arrow { color: var(--secondary-color); transition: transform .2s ease; }
    .opt:hover .arrow { transform: translateX(3px); }

    /* ç”¨æˆ·é€‰æ‹©æ¶ˆæ¯ */
    .user{ display:flex; justify-content:flex-end; }
    .user .me{
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
      color:#fff; padding:10px 14px;
      border-radius: var(--radius-md);
      border-bottom-right-radius:6px;
      box-shadow: var(--shadow-sm);
      font-weight: 600;
      max-width: 80%;
      line-height: 1.4;
    }

    /* ============= ç»“æœåŒºåŸŸ ============= */
    .result{
      display:none; text-align:center; padding:28px 24px;
      border-top:1px solid var(--border);
      background: linear-gradient(135deg, rgba(248,244,233,0.3), rgba(236,228,215,0.3));
    }
    .result-icon { font-size: 44px; margin-bottom: 10px; }
    .r-title{
      font-size:22px; font-weight:800; color:var(--accent-color);
      margin: 6px 0 6px;
    }
    .r-desc{ color:var(--muted); margin:0 0 18px; font-size: 15px; }

    /* æ¨èç‰Œé˜µå¡ç‰‡ */
    .spread-card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius-md);
      padding:18px;
      margin-bottom:18px;
      text-align:left;
      box-shadow: var(--shadow-sm);
    }
    .spread-name{ font-size:19px; font-weight:800; color:var(--primary-color); margin-bottom: 6px; }
    .spread-meta{ color:var(--muted); font-size:13px; margin-bottom: 8px; }
    .spread-desc { color: var(--ink); line-height: 1.6; }

    /* ============= AIæ€§æ ¼é€‰æ‹©ï¼ˆä¸spread.htmlç»Ÿä¸€ï¼‰ ============= */
    .personality-section { margin-bottom: 20px; }
    .personality-label{
      display: block;
      color: var(--accent-color);
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: left;
    }
    .personality-grid{
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      align-items: stretch;
      justify-items: stretch;
    }
    .personality-card{
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center;
      padding: 14px 12px;
      border: 2px solid var(--border); border-radius: var(--radius-md);
      background: var(--card); box-shadow: var(--shadow-sm);
      transition: all .2s ease;
      height: 100%;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      min-height: 82px;
      outline: none;
    }
    .personality-card:focus{ border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(142,108,136,0.15); }
    .personality-card::before {
      content: '';
      position: absolute;
      top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(142,108,136,0.1), transparent);
      transition: left .4s ease;
    }
    .personality-card:hover::before { left: 100%; }
    .personality-card:hover{ transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .personality-card.selected{
      border-color: var(--primary-color);
      background: linear-gradient(180deg, #fff, #fdf8f2);
      box-shadow: 0 0 0 3px rgba(142,108,136,0.12), var(--shadow-md);
    }
    .personality-emoji{ font-size: 24px; margin-bottom: 6px; }
    .personality-name{ font-size: 14px; font-weight: 800; color: var(--accent-color); margin-bottom: 2px; }
    .personality-trait{ font-size: 12px; color: var(--muted); line-height: 1.2; }

    /* ============= åº•éƒ¨æ“ä½œåŒº ============= */
    .footer{
      padding:16px 0 0;
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap:12px;
      padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
    }
    .ghost-btn{
      border:2px solid var(--border);
      background: var(--card);
      color: var(--accent-color);
      border-radius: var(--radius-md);
      padding:10px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: all .2s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ghost-btn:hover { background: var(--bg-ivory); border-color: var(--primary-color); transform: translateY(-1px); }

    .btn-primary{
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
      color:#fff; border:none;
      padding:12px 18px;
      border-radius: var(--radius-md);
      font-weight:700;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all .2s ease;
      font-size: 15px;
    }
    .btn-primary:hover:not([disabled]) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .btn-primary[disabled]{ opacity:.6; cursor: not-allowed; transform: none !important; }

    /* ============= å“åº”å¼ ============= */
    @media (max-width:900px){
      .options{ grid-template-columns: 1fr; }  /* âœ… ç§»åŠ¨ç«¯å•åˆ—ï¼Œé¿å…æ¨ªå‘æŒ¤å‹ */
      .personality-grid { grid-template-columns: 1fr; }
      .msgs{ gap:14px; }
    }
    @media (max-width:768px){
      .main{ margin:20px auto; padding: 0 16px; }
      .stage { padding: 24px 20px; }
      .msgs{ min-height:360px; }
      .footer { flex-direction: column-reverse; gap: 10px; }
      .ghost-btn, .btn-primary { width: 100%; justify-content: center; }
    }
    @media (max-width:480px){
      .opt { padding: 12px 12px; }
      .opt .emoji { font-size: 20px; width:24px; }
      .opt .ttl { font-size: 14px; }
    }

    /* å°Šé‡ç³»ç»Ÿ"å‡å°‘åŠ¨æ€"è®¾ç½® */
    @media (prefers-reduced-motion: reduce){
      .opt, .personality-card, .btn-primary, .ghost-btn, .msg {
        transition: none !important;
        animation: none !important;
      }
      .opt::before, .personality-card::before { display: none !important; }
      .msgs{ scroll-behavior: auto; }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar" role="navigation" aria-label="ä¸»å¯¼èˆª">
    <div class="navbar-content">
      <a class="back-link" href="{{ url_for('spread') }}">
        <i class="fas fa-chevron-left" aria-hidden="true"></i>
        <span>è¿”å›</span>
      </a>
      <div class="nav-title">æ™ºèƒ½ç‰Œé˜µæ¨è</div>
      <div style="width:80px;" aria-hidden="true"></div>
    </div>
  </nav>

  <main class="main" role="main">
    <section class="guide" aria-label="å¼•å¯¼å¯¹è¯">
      <div class="decor" aria-hidden="true"></div>

      <div class="stage">
        <!-- è¿›åº¦ -->
        <div class="progress" id="progress" role="progressbar" aria-valuemin="0" aria-valuemax="4" aria-valuenow="1" aria-label="é€‰æ‹©è¿›åº¦">
          <div class="dot active"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>

        <!-- å¯¹è¯åŒº -->
        <div class="msgs" id="msgs" aria-live="polite" aria-label="å¯¹è¯å†…å®¹"></div>

        <!-- ç»“æœåŒº -->
        <div class="result" id="result" aria-live="polite">
          <div class="result-icon" aria-hidden="true">ğŸ¯</div>
          <div class="r-title">æ‰¾åˆ°æœ€é€‚åˆä½ çš„ç‰Œé˜µï¼</div>
          <div class="r-desc">æ ¹æ®ä½ çš„é€‰é¡¹ï¼Œæˆ‘ä»¬ä¸ºä½ æ¨èï¼š</div>

          <div class="spread-card">
            <div class="spread-name" id="rName"></div>
            <div class="spread-meta" id="rMeta"></div>
            <div class="spread-desc" id="rDesc"></div>
          </div>

          <div class="personality-section">
            <label class="personality-label" for="personaList">é€‰æ‹©å¯¹è¯äººæ ¼ï¼ˆåªå½±å“è¯­æ°”ï¼Œä¸æ”¹å˜è§£è¯»ç»“è®ºï¼‰</label>
            <div class="personality-grid" id="personaList" role="listbox" aria-label="äººæ ¼åˆ—è¡¨"></div>
          </div>

          <div class="footer">
            <button class="ghost-btn" id="resetBtn" type="button" aria-label="é‡æ–°é€‰æ‹©">
              <i class="fas fa-redo" aria-hidden="true"></i>
              é‡æ–°é€‰æ‹©
            </button>
            <button class="btn-primary" id="goBtn" type="button" disabled aria-disabled="true" aria-label="å¼€å§‹å åœ">
              <i class="fas fa-sparkles" aria-hidden="true"></i>
              å¼€å§‹å åœ
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ===== iOS 100dvh ä¿®å¤ ===== */
    (function fixIOSVh(){
      const setVh = () => {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      };
      setVh();
      window.addEventListener('resize', setVh);
      window.addEventListener('orientationchange', setVh);
    })();

    /***************
     * å†³ç­–æ ‘ï¼ˆä¸ DB spreads.id å¯¹é½çš„ spread_idï¼‰
     ***************/
    const decision = {
      start: {
        message: "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å¡”ç½—å¼•å¯¼å¸ˆ âœ¨\nä»Šå¤©æƒ³æ¢ç´¢ä»€ä¹ˆä¸»é¢˜ï¼Ÿ",
        options: [
          { emoji:"ğŸ’•", title:"æ„Ÿæƒ…å…³ç³»", desc:"çˆ±æƒ…/äººé™…ç›¸å¤„", next:"love" },
          { emoji:"ğŸ’¼", title:"äº‹ä¸šå·¥ä½œ", desc:"èŒä¸šå‘å±•/æœºä¼š", next:"career" },
          { emoji:"ğŸ’°", title:"è´¢å¯Œé‡‘é’±", desc:"è´¢åŠ¡/æŠ•èµ„ç†è´¢", next:"wealth" },
          { emoji:"ğŸŒŸ", title:"ä¸ªäººæˆé•¿", desc:"è‡ªæˆ‘æ¢ç´¢/æ„ä¹‰æ„Ÿ", next:"growth" },
          { emoji:"â“", title:"é€šç”¨æŒ‡å¼•", desc:"æ—¥å¸¸/çŸ­é—®é¢˜", next:"general" }
        ]
      },
      love: {
        message: "å…³äºæ„Ÿæƒ…ï¼Œä½ æ›´æƒ³èšç„¦å“ªæ–¹é¢ï¼Ÿ",
        options: [
          { emoji:"ğŸ‘¥", title:"ç°æœ‰å…³ç³»", desc:"åŒæ–¹è§†è§’/èµ°å‘", result:"relationship" },
          { emoji:"ğŸ’˜", title:"æœªæ¥ç¼˜åˆ†", desc:"è¶‹åŠ¿ä¸æœºä¼š", result:"three_cards" },
          { emoji:"ğŸ’”", title:"å›°æƒ‘/çŸ›ç›¾", desc:"å®šä½é—®é¢˜ä¸æ”¹å–„", result:"love_cross" }
        ]
      },
      career: {
        message: "å…³äºäº‹ä¸šï¼Œä½ æ­¤åˆ»æœ€éœ€è¦ï¼Ÿ",
        options: [
          { emoji:"ğŸ“ˆ", title:"èŒä¸šå‘å±•", desc:"èµ„æº/é˜»ç¢/æœºä¼š/é£é™©", result:"career" },
          { emoji:"ğŸ¤”", title:"å·¥ä½œé€‰æ‹©", desc:"åœ¨ A/B ä¹‹é—´æŠ‰æ‹©", result:"choice_two" },
          { emoji:"ğŸ¯", title:"èŠ‚å¥è§„åˆ’", desc:"è¿‡å»-ç°åœ¨-æœªæ¥", result:"three_cards" }
        ]
      },
      wealth: {
        message: "å…³äºè´¢å¯Œï¼Œä½ æƒ³äº†è§£ï¼Ÿ",
        options: [
          { emoji:"ğŸ’¸", title:"è´¢åŠ¡ç°çŠ¶", desc:"ç°é‡‘æµä¸ä¼˜åŒ–", result:"wealth" },
          { emoji:"ğŸ“Š", title:"æŠ•èµ„å†³ç­–", desc:"Yes/No å€¾å‘", result:"yes_no" },
          { emoji:"ğŸ†", title:"æœºä¼šçª—å£", desc:"çŸ­æœŸæŠŠæ¡", result:"three_cards" }
        ]
      },
      growth: {
        message: "ä½ å¸Œæœ›åœ¨å“ªæ–¹é¢è·å¾—æˆé•¿ï¼Ÿ",
        options: [
          { emoji:"ğŸ§˜", title:"èº«å¿ƒå¹³è¡¡", desc:"èº«/å¿ƒ/çµè°ƒé¢‘", result:"mind_body_spirit" },
          { emoji:"ğŸŒˆ", title:"äººç”Ÿæ–¹å‘", desc:"é˜¶æ®µè¯¾é¢˜ä¸è¶‹åŠ¿", result:"spiritual" },
          { emoji:"âœ¨", title:"æ•´ä½“è„‰ç»œ", desc:"è¿‡å»ç°åœ¨æœªæ¥", result:"three_cards" }
        ]
      },
      general: {
        message: "é€šç”¨æŒ‡å¼•æƒ³æ€ä¹ˆæ¥ï¼Ÿ",
        options: [
          { emoji:"ğŸ“…", title:"æ¯æ—¥æç¤º", desc:"å½“ä¸‹ä¸€æ¡å»ºè®®", result:"single_card" },
          { emoji:"ğŸ²", title:"æ˜¯å¦åˆ¤æ–­", desc:"Yes/No å¿«é€Ÿåˆ¤æ–­", result:"yes_no" },
          { emoji:"ğŸŒ…", title:"æ•´ä½“è¶‹åŠ¿", desc:"ä¸‰å¼ ç‰Œçœ‹èµ°å‘", result:"three_cards" }
        ]
      }
    };

    // å±•ç¤ºä¿¡æ¯ï¼ˆä»… UIï¼Œç”¨äºç»“æœå¡ï¼‰
    const spreadsShow = {
      single_card:{ name:'å•ç‰ŒæŒ‡å¼•', cards:1, desc:'å¿«é€Ÿè·å–å½“ä¸‹æ ¸å¿ƒæç¤º' },
      yes_no:{ name:'æ˜¯å¦ç‰Œé˜µ', cards:1, desc:'åˆ¤æ–­å€¾å‘ä¸æ³¨æ„ç‚¹' },
      three_cards:{ name:'æ—¶é—´ä¸‰ç‰Œé˜µ', cards:3, desc:'è¿‡å»-ç°åœ¨-æœªæ¥' },
      relationship:{ name:'å…³ç³»ç‰Œé˜µ', cards:5, desc:'åŒæ–¹è§†è§’ä¸èµ°å‘' },
      choice_two:{ name:'äºŒé€‰ä¸€ç‰Œé˜µ', cards:3, desc:'æƒè¡¡åˆ©å¼Šä¸ç»“è®º' },
      mind_body_spirit:{ name:'èº«å¿ƒçµç‰Œé˜µ', cards:3, desc:'è‡ªæˆ‘å¹³è¡¡ä¸è°ƒé¢‘' },
      career:{ name:'èŒä¸šå‘å±•ç‰Œé˜µ', cards:5, desc:'èµ„æº/é˜»ç¢/æœºä¼š/é£é™©' },
      wealth:{ name:'è´¢å¯Œä¹‹è·¯ç‰Œé˜µ', cards:4, desc:'ç°é‡‘æµ/æœºä¼š/é£é™©' },
      love_cross:{ name:'çˆ±æƒ…åå­—ç‰Œé˜µ', cards:5, desc:'ç°çŠ¶/å†…å¤–å› /å»ºè®®/èµ°å‘' },
      spiritual:{ name:'çµæ€§æˆé•¿ç‰Œé˜µ', cards:7, desc:'é•¿æœŸæ–¹å‘ä¸è¯¾é¢˜' }
    };

    // äººæ ¼ï¼šä¼˜å…ˆ /api/personasï¼›å¤±è´¥ä½¿ç”¨ fallback
    let personas = null;
    const personasFallback = [
      { id:'wisdom',  name:'æ™ºæ…§', desc:'ç†æ€§åˆ†æ' },
      { id:'mystic',  name:'ç¥ç§˜', desc:'æ·±é‚ƒç›´è§‰' },
      { id:'warm',    name:'æ¸©æš–', desc:'è´´å¿ƒé™ªä¼´' }
    ];

    // ====== çŠ¶æ€ ======
    let current = 'start';
    let history = [];
    let chosenSpread = null;   // ä¸ DB ä¸­ spreads.id ä¸€è‡´ï¼ˆvarcharï¼‰
    let aiPersonality = null;  // æäº¤ç»™åç«¯çš„ ai_personality
    let personaDelegationBound = false;

    // å·¥å…·ï¼šç®€å•è½¬ä¹‰ + é€‰æ‹©å™¨è½¬ä¹‰
    const escapeHTML = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const escapeAttr = s => String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    function cssEscape(str){
      if (window.CSS && typeof CSS.escape === 'function') return CSS.escape(str);
      return String(str).replace(/[^a-zA-Z0-9_-]/g, m => '\\' + m.charCodeAt(0).toString(16) + ' ');
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°æœ€æ–° & æŠ˜å å†å²ï¼Œå‡å°‘æ‰‹åŠ¨ä¸‹æ»‘
    function scrollToLatest(el){
      const msgs = window.__msgs || document.getElementById('msgs');
      if (!msgs) return;
      requestAnimationFrame(()=>{
        if (el && el.scrollIntoView) { el.scrollIntoView({ behavior:'smooth', block:'nearest' }); }
        msgs.scrollTo({ top: msgs.scrollHeight, behavior:'smooth' });
      });
    }
    function collapseHistory(keep=2){
      const msgs = window.__msgs || document.getElementById('msgs');
      if (!msgs) return;
      const nodes = Array.from(msgs.children).filter(n => n.classList.contains('msg') || n.classList.contains('user'));
      nodes.slice(0, Math.max(0, nodes.length - keep)).forEach(n => n.classList.add('collapsed'));
    }

    // åˆå§‹åŒ–ï¼ˆå…¼å®¹è„šæœ¬å»¶åæ’å…¥ï¼‰
    function initGuide(){
      try {
        window.__msgs = document.getElementById('msgs') || document.querySelector('.msgs');
        if (!window.__msgs) { console.error('[guide] æœªæ‰¾åˆ° #msgs å®¹å™¨'); return; }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶ï¼ˆæ— å†…è”ï¼‰
        const resetBtn = document.getElementById('resetBtn');
        const goBtn = document.getElementById('goBtn');
        if (resetBtn) resetBtn.addEventListener('click', resetGuide);
        if (goBtn) goBtn.addEventListener('click', proceedToSpread);

        showStep('start');
      } catch (e) { console.error('[guide] åˆå§‹åŒ–å¤±è´¥ï¼š', e); }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGuide, { once:true });
    } else { initGuide(); }

    async function ensurePersonasLoaded(){
      if (personas) return personas;
      try{
        const res = await fetch('/api/personas');
        if (!res.ok) throw new Error('no personas api');
        const data = await res.json();
        personas = Array.isArray(data) && data.length ? data.map(p=>({
          id: p.id ?? p.code ?? 'warm',
          name: p.name ?? 'è‡ªå®šä¹‰äººæ ¼',
          desc: p.desc ?? (p.style ? `é£æ ¼ï¼š${p.style}` : '')
        })) : personasFallback;
      }catch(_){ personas = personasFallback; }
      return personas;
    }

    // ====== æ¸²æŸ“æ­¥éª¤ ======
    function showStep(id){
      try {
        const node = decision[id];
        if (!node) { console.warn('[guide] æœªæ‰¾åˆ°æ­¥éª¤ï¼š', id); return; }

        const msgs = window.__msgs || document.getElementById('msgs');
        if (!msgs) { console.error('[guide] #msgs å®¹å™¨ç¼ºå¤±ï¼Œæ— æ³•æ¸²æŸ“'); return; }

        current = id;
        updateProgress();

        const block = document.createElement('div');
        block.className = 'msg';
        const text = escapeHTML(node.message || '');

        const optsHTML = Array.isArray(node.options) ? node.options.map((o,i)=>`
          <div class="opt" data-idx="${i}" role="button" tabindex="0" aria-label="${escapeAttr(o.title || '')}">
            <div class="emoji" aria-hidden="true">${o.emoji || ''}</div>
            <div class="content">
              <div class="ttl">${escapeHTML(o.title || '')}</div>
              <div class="desc">${escapeHTML(o.desc || '')}</div>
            </div>
            <div class="arrow" aria-hidden="true"><i class="fas fa-chevron-right"></i></div>
          </div>
        `).join('') : '';

        block.innerHTML = `
          <div class="ava" aria-hidden="true"><i class="fas fa-sparkles"></i></div>
          <div class="bubble">
            ${text}
            <div class="options" role="group" aria-label="é€‰é¡¹åˆ—è¡¨">
              ${optsHTML}
            </div>
          </div>`;

        msgs.appendChild(block);

        // ä»…ç»™å½“å‰å—çš„é€‰é¡¹ç»‘å®šç‚¹å‡» + é”®ç›˜æ“ä½œ
        block.querySelectorAll('.opt').forEach(el=>{
          const handler = ()=> {
            el.style.pointerEvents='none';
            selectOption(parseInt(el.dataset.idx,10), block);
          };
          el.addEventListener('click', handler, { once:true });
          el.addEventListener('keydown', (e)=>{
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); el.click(); }
          });
        });

        collapseHistory(2);   // âœ… æŠ˜å æ—§æ¶ˆæ¯
        scrollToLatest(block); // âœ… è‡ªåŠ¨æ»šåˆ°æ–°æ­¥éª¤
      } catch (e) { console.error('[guide] showStep æ¸²æŸ“å¤±è´¥ï¼š', e); }
    }

    function selectOption(index, block){
      try{
        // ç¦ç”¨è¯¥å—
        block.querySelectorAll('.opt').forEach(el=>{
          el.style.pointerEvents='none';
          el.style.opacity='.6';
          el.setAttribute('tabindex','-1');
          el.setAttribute('aria-disabled','true');
        });

        const node = decision[current];
        const opt = node?.options?.[index] || {};

        // ç”¨æˆ·é€‰æ‹©æ³¡æ³¡
        const me = document.createElement('div');
        me.className = 'user';
        me.innerHTML = `<div class="me">${escapeHTML(opt.emoji || '')} ${escapeHTML(opt.title || '')}</div>`;
        (window.__msgs || document.getElementById('msgs')).appendChild(me);
        history.push({ step: current, choice: index });

        collapseHistory(2);
        scrollToLatest(me);

        setTimeout(()=>{
          if (opt.result){ showResult(opt.result); }
          else if (opt.next){ showStep(opt.next); }
          scrollToLatest();
        }, 250);
        updateProgress();
      }catch(e){ console.error('[guide] selectOption å¤±è´¥ï¼š', e); }
    }

    function updateProgress(){
      const dots = document.querySelectorAll('.dot');
      const idx = history.length;
      dots.forEach((d,i)=>{
        d.classList.toggle('done', i < idx);
        d.classList.toggle('active', i === idx);
      });
      const prog = document.getElementById('progress');
      if (prog) prog.setAttribute('aria-valuenow', Math.min(idx+1, dots.length));
    }

    // ====== ç»“æœ & äººæ ¼é€‰æ‹© ======
    async function showResult(spreadId){
      chosenSpread = spreadId;
      const s = spreadsShow[spreadId] || {name:spreadId, cards:'-', desc:''};

      // éšè—å¯¹è¯ï¼Œå±•ç¤ºç»“æœå¡
      const resultEl = document.getElementById('result');
      const progressEl = document.getElementById('progress');
      const msgs = window.__msgs || document.getElementById('msgs');

      if (resultEl) resultEl.style.display = 'block';
      if (progressEl) progressEl.style.display = 'none';
      if (msgs) msgs.style.display = 'none';

      document.getElementById('rName').textContent = s.name;
      document.getElementById('rMeta').textContent = `${s.cards} å¼  Â· ${s.desc}`;

      const descEl = document.getElementById('rDesc');
      if (descEl) { descEl.textContent = getSpreadDescription(spreadId); }

      // æ¸²æŸ“äººæ ¼åˆ—è¡¨ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
      const list = document.getElementById('personaList');
      const data = await ensurePersonasLoaded();
      list.innerHTML = data.map((p, idx)=>`
        <div class="personality-card ${idx === 0 ? 'selected' : ''}"
             role="option" tabindex="0" aria-selected="${idx===0?'true':'false'}"
             data-personality="${escapeAttr(p.id)}"
             data-name="${escapeAttr(p.name || p.id)}">
          <div class="personality-emoji" aria-hidden="true">${getPersonalityEmoji(p.id)}</div>
          <div class="personality-name">${escapeHTML(p.name || p.id)}</div>
          <div class="personality-trait">${escapeHTML(p.desc || '')}</div>
        </div>
      `).join('');

      // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªäººæ ¼
      if (data.length > 0) { aiPersonality = data[0].id; updateGoButton(); showPersonalityConfirmation(data[0].name || data[0].id); }

      bindPersonaDelegation();
      resultEl.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    function bindPersonaDelegation(){
      if (personaDelegationBound) return;
      personaDelegationBound = true;
      const list = document.getElementById('personaList');
      list.addEventListener('click', (e)=>{
        const card = e.target.closest('.personality-card');
        if (!card) return;
        pickPersona(card.dataset.personality, card.dataset.name);
      });
      list.addEventListener('keydown', (e)=>{
        const card = e.target.closest('.personality-card');
        if (!card) return;
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); pickPersona(card.dataset.personality, card.dataset.name); }
      });
    }

    function getPersonalityEmoji(id) {
      const emojiMap = { 'wisdom':'ğŸ“š','mystic':'ğŸ”®','warm':'ğŸ’','blunt':'âš¡','heal':'ğŸŒ¿','ritual':'ğŸ•¯ï¸','pro':'ğŸ“Š' };
      return emojiMap[id] || 'ğŸ—£ï¸';
    }

    function getSpreadDescription(spreadId) {
      const descriptions = {
        single_card: 'é€šè¿‡ä¸€å¼ å¡”ç½—ç‰Œè·å¾—å½“ä¸‹æœ€é‡è¦çš„æŒ‡å¼•å’Œå»ºè®®ã€‚',
        yes_no: 'é’ˆå¯¹ç‰¹å®šé—®é¢˜ç»™å‡ºæ˜ç¡®çš„æ˜¯å¦å€¾å‘åˆ¤æ–­ã€‚',
        three_cards: 'ä»æ—¶é—´ç»´åº¦åˆ†æè¿‡å»çš„å½±å“ã€ç°åœ¨çš„çŠ¶å†µå’Œæœªæ¥çš„è¶‹åŠ¿ã€‚',
        relationship: 'æ·±å…¥åˆ†æåŒæ–¹åœ¨å…³ç³»ä¸­çš„è§†è§’ã€æ„Ÿå—å’Œå¯èƒ½çš„å‘å±•æ–¹å‘ã€‚',
        choice_two: 'å¸®åŠ©ä½ åœ¨ä¸¤ä¸ªé€‰é¡¹ä¹‹é—´åšå‡ºæœ€é€‚åˆçš„å†³ç­–ã€‚',
        mind_body_spirit: 'ä»èº«ä½“ã€å¿ƒç†ã€ç²¾ç¥ä¸‰ä¸ªå±‚é¢åˆ†æå½“å‰çŠ¶æ€ã€‚',
        career: 'å…¨é¢åˆ†æèŒä¸šå‘å±•ä¸­çš„èµ„æºã€éšœç¢ã€æœºä¼šå’Œæ½œåœ¨é£é™©ã€‚',
        wealth: 'ä»å¤šè§’åº¦åˆ†æè´¢åŠ¡çŠ¶å†µå’Œé‡‘é’±èƒ½é‡çš„æµåŠ¨ã€‚',
        love_cross: 'æ·±åº¦å‰–ææ„Ÿæƒ…é—®é¢˜çš„æ ¹æºå’Œè§£å†³æ–¹æ¡ˆã€‚',
        spiritual: 'æ¢ç´¢ä¸ªäººç²¾ç¥æˆé•¿çš„æ–¹å‘å’Œäººç”Ÿè¯¾é¢˜ã€‚'
      };
      return descriptions[spreadId] || 'ä¸ºä½ æä¾›æ·±åº¦çš„æ´å¯Ÿå’ŒæŒ‡å¼•ã€‚';
    }

    function pickPersona(id, name){
      document.querySelectorAll('.personality-card').forEach(card => {
        card.classList.remove('selected');
        card.setAttribute('aria-selected','false');
      });
      const selector = `.personality-card[data-personality="${cssEscape(id)}"]`;
      const selectedCard = document.querySelector(selector);
      if (selectedCard) { selectedCard.classList.add('selected'); selectedCard.setAttribute('aria-selected','true'); }

      aiPersonality = id;
      updateGoButton();
      showPersonalityConfirmation(name || id);
    }

    function showPersonalityConfirmation(name) {
      const sec = document.querySelector('.personality-section');
      if (!sec) return;
      const existingHint = document.querySelector('.persona-confirmation');
      if (existingHint) existingHint.remove();
      const hint = document.createElement('div');
      hint.className = 'persona-confirmation';
      hint.style.cssText = `
        margin: 10px 0 0 0; padding: 8px 12px;
        background: rgba(142,108,136,0.05);
        border: 1px solid rgba(142,108,136,0.12);
        border-radius: 8px; color: var(--accent-color);
        font-size: 14px; text-align: center;
      `;
      hint.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 6px;"></i>å·²é€‰æ‹©å¯¹è¯äººæ ¼ï¼š${escapeHTML(name)}`;
      sec.appendChild(hint);
    }

    function updateGoButton() {
      const btn = document.getElementById('goBtn');
      if (!btn) return;
      const ok = Boolean(chosenSpread && aiPersonality);
      btn.disabled = !ok;
      btn.setAttribute('aria-disabled', String(!ok));
    }

    function generateQuestion(){
      const titles = [];
      for (const h of history){
        const node = decision[h.step];
        const opt = node?.options?.[h.choice];
        if (opt?.title) titles.push(opt.title);
      }
      const main = titles.slice(-2).join('ï¼Œ');
      const sName = (spreadsShow[chosenSpread]?.name) || 'æœ¬æ¬¡ç‰Œé˜µ';
      return main ? `æˆ‘æƒ³ç”¨ã€Œ${sName}ã€çœ‹çœ‹ï¼š${main}` : `æˆ‘æƒ³ç”¨ã€Œ${sName}ã€åšä¸€æ¬¡å åœï¼Œç»™æˆ‘å…·ä½“å»ºè®®ã€‚`;
    }

    // ====== å¼€å§‹å åœï¼ˆä¸åç«¯ä¸€è‡´ï¼š/api/spread/drawï¼‰ ======
    async function proceedToSpread(){
      if (!chosenSpread){ alert('è¯·å…ˆå®Œæˆé€‰æ‹©'); return; }
      if (!aiPersonality){ alert('è¯·å…ˆé€‰æ‹©å¯¹è¯äººæ ¼'); return; }

      const btn = document.getElementById('goBtn');
      const oldHTML = btn.innerHTML;
      btn.disabled = true;
      btn.setAttribute('aria-disabled','true');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‡†å¤‡ä¸­â€¦';

      try{
        const payload = {
          spread_id: chosenSpread,          // varcharï¼Œä¸ DB ä¸»é”®ä¸€è‡´
          question: generateQuestion(),     // åˆæˆé¦–é—®
          ai_personality: aiPersonality     // å­—ç¬¦ä¸²äººæ ¼
        };
        const res = await fetch('/api/spread/draw', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('æŠ½ç‰Œæ¥å£é”™è¯¯');
        const data = await res.json();
        if (data?.success && data?.redirect){
          window.location.href = data.redirect; // /spread/chat/<reading_id>
          return;
        }
        throw new Error(data?.error || 'å åœå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }catch(err){
        console.error(err);
        alert(err.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        btn.disabled = false;
        btn.setAttribute('aria-disabled','false');
        btn.innerHTML = oldHTML;
      }
    }

    function resetGuide(){
      history = [];
      chosenSpread = null;
      aiPersonality = null;
      current = 'start';

      const msgs = window.__msgs || document.getElementById('msgs');
      msgs.innerHTML = '';
      msgs.style.display = '';
      document.getElementById('result').style.display = 'none';
      document.getElementById('progress').style.display = '';

      document.querySelectorAll('.dot').forEach((d,i)=>{
        d.classList.toggle('active', i===0);
        d.classList.remove('done');
      });

      showStep('start');
      scrollToLatest();
    }
  </script>
</body>
</html>
