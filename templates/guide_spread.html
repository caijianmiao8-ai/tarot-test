<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>æ™ºèƒ½ç‰Œé˜µæ¨è - å¡”ç½—å åœ</title>

  <!-- æœ¬åœ°åŒ–èµ„æºï¼ˆä¸ spread.html ä¿æŒä¸€è‡´ï¼‰ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">

  <style>
    /* =========================
       ä¸»é¢˜å˜é‡ï¼ˆä¸ spread.html ç»Ÿä¸€ï¼‰
       ========================= */
    :root{
      --primary-color: #8e6c88;   /* ä¸é¦™ç´«ï¼ˆä¸»è‰²ï¼‰ */
      --accent-color:  #6d4c67;   /* æ·±æ¢…ç´«ï¼ˆå¼ºè°ƒï¼‰ */
      --secondary-color:#d1bfa7;  /* é¦™æ§Ÿç±³ï¼ˆè¾…åŠ©ï¼‰ */
      --bg-ivory:      #f8f4e9;   /* è±¡ç‰™æµ…åº• */
      --ink:           #333333;   /* æ·±æ–‡æœ¬ */
      --muted:         #7a707a;   /* æ¬¡æ–‡æœ¬ */

      --card:          #ffffff;
      --border:        rgba(0,0,0,0.08);
      --shadow-sm:     0 4px 16px rgba(30,20,35,0.08);
      --shadow-md:     0 10px 28px rgba(30,20,35,0.12);
      --shadow-lg:     0 16px 44px rgba(30,20,35,0.16);

      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;
    }

    /* èƒŒæ™¯ï¼šç»†è…»çš„ä¸é¦™æ¸å˜ + å¾®å¾®çº¹ç†æ„Ÿ */
    html,body{ height:100% }
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-sans-serif, -apple-system, "PingFang SC","Microsoft YaHei", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background:
        radial-gradient(1000px 800px at 10% 0%, #fbf9f3 0%, rgba(251,249,243,0) 60%),
        radial-gradient(1200px 900px at 90% 10%, #f3ece1 0%, rgba(243,236,225,0) 60%),
        linear-gradient(135deg, #f8f4e9 0%, #ece4d7 100%);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ============= é¡¶éƒ¨å¯¼èˆªï¼ˆä¸ spread.html ç»Ÿä¸€ï¼‰ ============= */
    .navbar{
      position:sticky; top:0; z-index:1000;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .navbar-content{
      max-width:1200px; margin:0 auto; padding:14px 20px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .back-link{
      display:flex; align-items:center; gap:8px;
      color:var(--accent-color); text-decoration:none; font-weight:700;
      transition: color .2s ease, transform .2s ease;
    }
    .back-link:hover{ color:var(--primary-color); transform: translateX(-2px); }
    .nav-title{
      font-size:18px; font-weight:800; color:var(--accent-color);
    }

    /* ============= ä¸»å®¹å™¨ ============= */
    .main{ 
      max-width:900px; width:100%; margin:40px auto; padding:0 20px; flex:1;
      display: flex; flex-direction: column;
    }

    .guide{ 
      background: rgba(255,255,255,0.95); 
      border-radius: var(--radius-lg); 
      border:1px solid var(--border);
      box-shadow: var(--shadow-md); 
      overflow:hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* è£…é¥°æ¡ */
    .decor{ 
      height:6px; 
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color)); 
    }

    .stage{ 
      padding:32px 28px; 
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* ============= è¿›åº¦æŒ‡ç¤ºå™¨ ============= */
    .progress{ 
      display:flex; gap:12px; justify-content:center; margin-bottom:20px; 
    }
    .dot{ 
      width:10px; height:10px; border-radius:50%; 
      background:#e5e7eb; 
      transition: all .3s ease; 
    }
    .dot.active{ 
      width:28px; 
      background:var(--primary-color); 
      box-shadow: 0 4px 12px rgba(142,108,136,.3);
    }
    .dot.done{ 
      background:var(--secondary-color); 
    }

    /* ============= å¯¹è¯åŒºåŸŸ ============= */
    .msgs{ 
      display:flex; flex-direction:column; gap:20px; 
      flex: 1;
      min-height: 420px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) transparent;
    }
    .msgs::-webkit-scrollbar { width: 6px; }
    .msgs::-webkit-scrollbar-track { background: transparent; }
    .msgs::-webkit-scrollbar-thumb { 
      background: var(--primary-color); 
      border-radius: 3px; 
    }

    .msg{ 
      display:flex; gap:14px; 
      animation: msgSlideIn .4s ease-out; 
      max-width: 100%;
    }
    @keyframes msgSlideIn{ 
      from{opacity:0; transform:translateY(12px);} 
      to{opacity:1; transform:translateY(0);} 
    }

    .ava{ 
      width:44px; height:44px; border-radius:50%; 
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
      color:#fff; display:flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }

    .bubble{ 
      background: var(--card); 
      padding:18px 20px; 
      border-radius: var(--radius-md); 
      border-bottom-left-radius:6px; 
      line-height:1.65; 
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      flex: 1;
      white-space: pre-line;
    }

    /* ============= é€‰é¡¹åŒºåŸŸï¼ˆæ”¹è¿›æ ·å¼ï¼‰ ============= */
    .options{ 
      display:flex; flex-direction:column; gap:12px; margin-top:16px; 
    }
    .opt{ 
      background: var(--card); 
      border:2px solid var(--border); 
      border-radius: var(--radius-md); 
      padding:16px 18px;
      display:flex; align-items:center; gap:14px; 
      cursor:pointer; 
      transition: all .2s ease;
      position: relative;
      overflow: hidden;
    }
    .opt::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(142,108,136,0.05), transparent);
      transition: left .4s ease;
    }
    .opt:hover::before {
      left: 100%;
    }
    .opt:hover{ 
      background: rgba(142,108,136,0.02); 
      border-color: var(--primary-color); 
      transform: translateX(4px);
      box-shadow: var(--shadow-sm);
    }
    .opt .emoji{ 
      width:32px; text-align:center; font-size:24px; flex-shrink: 0;
    }
    .opt .content {
      flex: 1;
    }
    .opt .ttl{ 
      font-weight:700; color:var(--accent-color); font-size: 16px;
      margin-bottom: 4px;
    }
    .opt .desc{ 
      font-size:14px; color:var(--muted); line-height: 1.4;
    }
    .opt .arrow {
      color: var(--secondary-color);
      transition: transform .2s ease;
    }
    .opt:hover .arrow {
      transform: translateX(4px);
    }

    /* ç”¨æˆ·é€‰æ‹©æ¶ˆæ¯ */
    .user{ 
      display:flex; justify-content:flex-end; 
    }
    .user .me{ 
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color)); 
      color:#fff; padding:12px 18px; 
      border-radius: var(--radius-md); 
      border-bottom-right-radius:6px;
      box-shadow: var(--shadow-sm);
      font-weight: 600;
    }

    /* ============= ç»“æœåŒºåŸŸ ============= */
    .result{ 
      display:none; text-align:center; padding:32px 28px; 
      border-top:1px solid var(--border);
      background: linear-gradient(135deg, rgba(248,244,233,0.3), rgba(236,228,215,0.3));
    }
    .result-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    .r-title{ 
      font-size:24px; font-weight:800; color:var(--accent-color); 
      margin: 8px 0 6px;
    }
    .r-desc{ 
      color:var(--muted); margin:0 0 24px; font-size: 16px;
    }

    /* æ¨èç‰Œé˜µå¡ç‰‡ */
    .spread-card{ 
      background: var(--card);
      border:1px solid var(--border); 
      border-radius: var(--radius-md); 
      padding:20px; 
      margin-bottom:20px; 
      text-align:left;
      box-shadow: var(--shadow-sm);
    }
    .spread-name{ 
      font-size:20px; font-weight:800; color:var(--primary-color); 
      margin-bottom: 8px;
    }
    .spread-meta{ 
      color:var(--muted); font-size:14px; margin-bottom: 12px;
    }
    .spread-desc {
      color: var(--ink);
      line-height: 1.6;
    }

    /* ============= AIæ€§æ ¼é€‰æ‹©ï¼ˆä¸spread.htmlç»Ÿä¸€ï¼‰ ============= */
    .personality-section {
      margin-bottom: 24px;
    }
    .personality-label {
      display: block;
      color: var(--accent-color);
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      text-align: left;
    }
    .personality-grid{
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      align-items: stretch;
      justify-items: stretch;
    }
    .personality-card{
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center;
      padding: 16px 12px;
      border: 2px solid var(--border); border-radius: var(--radius-md);
      background: var(--card); box-shadow: var(--shadow-sm);
      transition: all .2s ease;
      height: 100%;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .personality-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(142,108,136,0.1), transparent);
      transition: left .4s ease;
    }
    .personality-card:hover::before {
      left: 100%;
    }
    .personality-card:hover{ 
      transform: translateY(-2px); 
      box-shadow: var(--shadow-md); 
    }
    .personality-card.selected{
      border-color: var(--primary-color);
      background: linear-gradient(180deg, #fff, #fdf8f2);
      box-shadow: 0 0 0 3px rgba(142,108,136,0.12), var(--shadow-md);
    }
    .personality-emoji{ 
      font-size: 28px; margin-bottom: 8px; 
    }
    .personality-name{ 
      font-size: 15px; font-weight: 800; color: var(--accent-color); 
      margin-bottom: 4px; 
    }
    .personality-trait{ 
      font-size: 12px; color: var(--muted); line-height: 1.3;
    }

    /* ============= åº•éƒ¨æ“ä½œåŒº ============= */
    .footer{ 
      padding:20px 0 0; 
      display:flex; 
      justify-content: space-between; 
      align-items: center;
      gap:16px; 
    }
    .ghost-btn{ 
      border:2px solid var(--border); 
      background: var(--card); 
      color: var(--accent-color);
      border-radius: var(--radius-md); 
      padding:12px 20px; 
      cursor: pointer;
      font-weight: 600;
      transition: all .2s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ghost-btn:hover {
      background: var(--bg-ivory);
      border-color: var(--primary-color);
      transform: translateY(-1px);
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
      color:#fff; border:none; 
      padding:14px 24px; 
      border-radius: var(--radius-md); 
      font-weight:700;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all .2s ease;
      font-size: 16px;
    }
    .btn-primary:hover:not([disabled]) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .btn-primary[disabled]{ 
      opacity:.6; 
      cursor: not-allowed;
      transform: none !important;
    }

    /* ============= å“åº”å¼ ============= */
    @media (max-width:768px){
      .main{ margin:20px auto; padding: 0 16px; }
      .stage { padding: 24px 20px; }
      .msgs{ min-height:360px; }
      .personality-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .footer {
        flex-direction: column-reverse;
        gap: 12px;
      }
      .ghost-btn, .btn-primary {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width:480px){
      .opt {
        padding: 14px 16px;
      }
      .opt .emoji {
        font-size: 20px;
      }
      .opt .ttl {
        font-size: 15px;
      }
    }

    /* å°Šé‡ç³»ç»Ÿ"å‡å°‘åŠ¨æ€"è®¾ç½® */
    @media (prefers-reduced-motion: reduce){
      .opt, .personality-card, .btn-primary, .ghost-btn, .msg { 
        transition: none !important; 
        animation: none !important; 
      }
      .opt::before, .personality-card::before {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar">
    <div class="navbar-content">
      <a class="back-link" href="{{ url_for('spread') }}">
        <i class="fas fa-chevron-left"></i> 
        <span>è¿”å›</span>
      </a>
      <div class="nav-title">æ™ºèƒ½ç‰Œé˜µæ¨è</div>
      <div style="width:80px;"></div>
    </div>
  </nav>

  <main class="main">
    <section class="guide">
      <div class="decor"></div>

      <div class="stage">
        <!-- è¿›åº¦ -->
        <div class="progress" id="progress">
          <div class="dot active"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>

        <!-- å¯¹è¯åŒº -->
        <div class="msgs" id="msgs"></div>

        <!-- ç»“æœåŒº -->
        <div class="result" id="result">
          <div class="result-icon">ğŸ¯</div>
          <div class="r-title">æ‰¾åˆ°æœ€é€‚åˆä½ çš„ç‰Œé˜µï¼</div>
          <div class="r-desc">æ ¹æ®ä½ çš„é€‰é¡¹ï¼Œæˆ‘ä»¬ä¸ºä½ æ¨èï¼š</div>

          <div class="spread-card">
            <div class="spread-name" id="rName"></div>
            <div class="spread-meta" id="rMeta"></div>
            <div class="spread-desc" id="rDesc"></div>
          </div>

          <div class="personality-section">
            <label class="personality-label">é€‰æ‹©å¯¹è¯äººæ ¼ï¼ˆåªå½±å“è¯­æ°”ï¼Œä¸æ”¹å˜è§£è¯»ç»“è®ºï¼‰</label>
            <div class="personality-grid" id="personaList">
              <!-- åŠ¨æ€æ¸²æŸ“ï¼šä¼˜å…ˆ /api/personasï¼Œå¤±è´¥æ—¶ä½¿ç”¨å†…ç½®åˆ—è¡¨ -->
            </div>
          </div>

          <div class="footer">
            <button class="ghost-btn" onclick="resetGuide()">
              <i class="fas fa-redo"></i>
              é‡æ–°é€‰æ‹©
            </button>
            <button class="btn-primary" id="goBtn" disabled onclick="proceedToSpread(this)">
              <i class="fas fa-sparkles"></i> 
              å¼€å§‹å åœ
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ====== å†³ç­–æ ‘ï¼ˆspread_id ä½¿ç”¨ä½ æ•°æ®åº“çš„ varchar ä¸»é”®ï¼‰ ======
    const decision = {
      start: {
        message: "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å¡”ç½—å¼•å¯¼å¸ˆ âœ¨\nä»Šå¤©æƒ³æ¢ç´¢ä»€ä¹ˆä¸»é¢˜ï¼Ÿ",
        options: [
          { emoji:"ğŸ’•", title:"æ„Ÿæƒ…å…³ç³»", desc:"çˆ±æƒ…/äººé™…ç›¸å¤„", next:"love" },
          { emoji:"ğŸ’¼", title:"äº‹ä¸šå·¥ä½œ", desc:"èŒä¸šå‘å±•/æœºä¼š", next:"career" },
          { emoji:"ğŸ’°", title:"è´¢å¯Œé‡‘é’±", desc:"è´¢åŠ¡/æŠ•èµ„ç†è´¢", next:"wealth" },
          { emoji:"ğŸŒŸ", title:"ä¸ªäººæˆé•¿", desc:"è‡ªæˆ‘æ¢ç´¢/æ„ä¹‰æ„Ÿ", next:"growth" },
          { emoji:"â“", title:"é€šç”¨æŒ‡å¼•", desc:"æ—¥å¸¸/çŸ­é—®é¢˜", next:"general" }
        ]
      },
      love: {
        message: "å…³äºæ„Ÿæƒ…ï¼Œä½ æ›´æƒ³èšç„¦å“ªæ–¹é¢ï¼Ÿ",
        options: [
          { emoji:"ğŸ‘¥", title:"ç°æœ‰å…³ç³»", desc:"åŒæ–¹è§†è§’/èµ°å‘", result:"relationship" },
          { emoji:"ğŸ’˜", title:"æœªæ¥ç¼˜åˆ†", desc:"è¶‹åŠ¿ä¸æœºä¼š", result:"three_cards" },
          { emoji:"ğŸ’”", title:"å›°æƒ‘/çŸ›ç›¾", desc:"å®šä½é—®é¢˜ä¸æ”¹å–„", result:"love_cross" }
        ]
      },
      career: {
        message: "å…³äºäº‹ä¸šï¼Œä½ æ­¤åˆ»æœ€éœ€è¦ï¼Ÿ",
        options: [
          { emoji:"ğŸ“ˆ", title:"èŒä¸šå‘å±•", desc:"èµ„æº/é˜»ç¢/æœºä¼š/é£é™©", result:"career" },
          { emoji:"ğŸ¤”", title:"å·¥ä½œé€‰æ‹©", desc:"åœ¨ A/B ä¹‹é—´æŠ‰æ‹©", result:"choice_two" },
          { emoji:"ğŸ¯", title:"èŠ‚å¥è§„åˆ’", desc:"è¿‡å»-ç°åœ¨-æœªæ¥", result:"three_cards" }
        ]
      },
      wealth: {
        message: "å…³äºè´¢å¯Œï¼Œä½ æƒ³äº†è§£ï¼Ÿ",
        options: [
          { emoji:"ğŸ’¸", title:"è´¢åŠ¡ç°çŠ¶", desc:"ç°é‡‘æµä¸ä¼˜åŒ–", result:"wealth" },
          { emoji:"ğŸ“Š", title:"æŠ•èµ„å†³ç­–", desc:"Yes/No å€¾å‘", result:"yes_no" },
          { emoji:"ğŸ†", title:"æœºä¼šçª—å£", desc:"çŸ­æœŸæŠŠæ¡", result:"three_cards" }
        ]
      },
      growth: {
        message: "ä½ å¸Œæœ›åœ¨å“ªæ–¹é¢è·å¾—æˆé•¿ï¼Ÿ",
        options: [
          { emoji:"ğŸ§˜", title:"èº«å¿ƒå¹³è¡¡", desc:"èº«/å¿ƒ/çµè°ƒé¢‘", result:"mind_body_spirit" },
          { emoji:"ğŸŒˆ", title:"äººç”Ÿæ–¹å‘", desc:"é˜¶æ®µè¯¾é¢˜ä¸è¶‹åŠ¿", result:"spiritual" },
          { emoji:"âœ¨", title:"æ•´ä½“è„‰ç»œ", desc:"è¿‡å»ç°åœ¨æœªæ¥", result:"three_cards" }
        ]
      },
      general: {
        message: "é€šç”¨æŒ‡å¼•æƒ³æ€ä¹ˆæ¥ï¼Ÿ",
        options: [
          { emoji:"ğŸ“…", title:"æ¯æ—¥æç¤º", desc:"å½“ä¸‹ä¸€æ¡å»ºè®®", result:"single_card" },
          { emoji:"ğŸ²", title:"æ˜¯å¦åˆ¤æ–­", desc:"Yes/No å¿«é€Ÿåˆ¤æ–­", result:"yes_no" },
          { emoji:"ğŸŒ…", title:"æ•´ä½“è¶‹åŠ¿", desc:"ä¸‰å¼ ç‰Œçœ‹èµ°å‘", result:"three_cards" }
        ]
      }
    };

    // å±•ç¤ºä¿¡æ¯ï¼ˆä»… UI ç”¨ï¼Œä¸å½±å“åç«¯ï¼‰
    const spreadsShow = {
      single_card:{ name:'å•ç‰ŒæŒ‡å¼•', cards:1, desc:'å¿«é€Ÿè·å–å½“ä¸‹æ ¸å¿ƒæç¤º' },
      yes_no:{ name:'æ˜¯å¦ç‰Œé˜µ', cards:1, desc:'åˆ¤æ–­å€¾å‘ä¸æ³¨æ„ç‚¹' },
      three_cards:{ name:'æ—¶é—´ä¸‰ç‰Œé˜µ', cards:3, desc:'è¿‡å»-ç°åœ¨-æœªæ¥' },
      relationship:{ name:'å…³ç³»ç‰Œé˜µ', cards:5, desc:'åŒæ–¹è§†è§’ä¸èµ°å‘' },
      choice_two:{ name:'äºŒé€‰ä¸€ç‰Œé˜µ', cards:3, desc:'æƒè¡¡åˆ©å¼Šä¸ç»“è®º' },
      mind_body_spirit:{ name:'èº«å¿ƒçµç‰Œé˜µ', cards:3, desc:'è‡ªæˆ‘å¹³è¡¡ä¸è°ƒé¢‘' },
      career:{ name:'èŒä¸šå‘å±•ç‰Œé˜µ', cards:5, desc:'èµ„æº/é˜»ç¢/æœºä¼š/é£é™©' },
      wealth:{ name:'è´¢å¯Œä¹‹è·¯ç‰Œé˜µ', cards:4, desc:'ç°é‡‘æµ/æœºä¼š/é£é™©' },
      love_cross:{ name:'çˆ±æƒ…åå­—ç‰Œé˜µ', cards:5, desc:'ç°çŠ¶/å†…å¤–å› /å»ºè®®/èµ°å‘' },
      spiritual:{ name:'çµæ€§æˆé•¿ç‰Œé˜µ', cards:7, desc:'é•¿æœŸæ–¹å‘ä¸è¯¾é¢˜' }
    };

    // äººæ ¼ï¼šä¼˜å…ˆä» /api/personas å–ï¼›å¤±è´¥åˆ™ç”¨ fallbackï¼ˆä¸ spread.html é£æ ¼ç»Ÿä¸€ï¼‰
    let personas = null;
    const personasFallback = [
      { id:'wisdom',  name:'æ™ºæ…§', desc:'ç†æ€§åˆ†æ' },
      { id:'mystic',  name:'ç¥ç§˜', desc:'æ·±é‚ƒç›´è§‰' },
      { id:'warm',    name:'æ¸©æš–', desc:'è´´å¿ƒé™ªä¼´' }
    ];

    // ====== çŠ¶æ€ ======
    let current = 'start';
    let history = [];
    let chosenSpread = null;     // ä¸ DB ä¸­ spreads.id ä¸€è‡´ï¼ˆvarcharï¼‰
    let aiPersonality = null;    // å­—ç¬¦ä¸²ï¼Œæäº¤ç»™åç«¯çš„ ai_personality
    const msgs = document.getElementById('msgs');

    document.addEventListener('DOMContentLoaded', () => {
      showStep('start');
    });

    async function ensurePersonasLoaded(){
      if (personas) return personas;
      try{
        const res = await fetch('/api/personas');
        if (!res.ok) throw new Error('no personas api');
        const data = await res.json();
        // æœŸæœ›ï¼š[{id, name, desc/style?}]â€”â€”ä¸ spread.html çš„äººæ ¼é€‰æ‹©ä¿æŒä¸€è‡´ä½“éªŒ
        personas = Array.isArray(data) && data.length ? data.map(p=>({
          id: p.id ?? p.code ?? 'warm', 
          name: p.name ?? 'è‡ªå®šä¹‰äººæ ¼', 
          desc: p.desc ?? (p.style ? `é£æ ¼ï¼š${p.style}` : '')
        })) : personasFallback;
      }catch(_){
        personas = personasFallback;
      }
      return personas;
    }

    // ====== æ¸²æŸ“æ­¥éª¤ ======
    function showStep(id){
      const node = decision[id]; 
      if (!node) return;
      
      current = id; 
      updateProgress();

      const block = document.createElement('div');
      block.className = 'msg';
      const text = node.message.replace(/</g,'&lt;').replace(/>/g,'&gt;'); // ç®€å•è½¬ä¹‰
      block.innerHTML = `
        <div class="ava"><i class="fas fa-sparkles"></i></div>
        <div class="bubble">
          ${text}
          <div class="options">
            ${node.options.map((o,i)=>`
              <div class="opt" data-idx="${i}">
                <div class="emoji">${o.emoji}</div>
                <div class="content">
                  <div class="ttl">${o.title}</div>
                  <div class="desc">${o.desc || ''}</div>
                </div>
                <div class="arrow"><i class="fas fa-chevron-right"></i></div>
              </div>
            `).join('')}
          </div>
        </div>`;
      msgs.appendChild(block);

      block.querySelectorAll('.opt').forEach(el=>{
        el.addEventListener('click', ()=>selectOption(parseInt(el.dataset.idx,10), block));
      });

      setTimeout(()=>{ msgs.scrollTop = msgs.scrollHeight; }, 100);
    }

    function selectOption(index, block){
      // ç¦ç”¨è¯¥å—
      block.querySelectorAll('.opt').forEach(el=>{
        el.style.pointerEvents='none'; 
        el.style.opacity='.6'; 
      });

      const node = decision[current];
      const opt = node.options[index];

      // ç”¨æˆ·é€‰æ‹©æ³¡æ³¡
      const me = document.createElement('div');
      me.className = 'user';
      me.innerHTML = `<div class="me">${opt.emoji} ${opt.title}</div>`;
      msgs.appendChild(me);
      history.push({ step: current, choice: index });

      setTimeout(()=>{
        if (opt.result){
          showResult(opt.result);
        } else if (opt.next){
          showStep(opt.next);
        }
        msgs.scrollTop = msgs.scrollHeight;
      }, 500);
      updateProgress();
    }

    function updateProgress(){
      const dots = document.querySelectorAll('.dot');
      const idx = history.length;
      dots.forEach((d,i)=>{
        d.classList.toggle('done', i < idx);
        d.classList.toggle('active', i === idx);
      });
    }

    // ====== ç»“æœ & äººæ ¼é€‰æ‹© ======
    async function showResult(spreadId){
      chosenSpread = spreadId;
      const s = spreadsShow[spreadId] || {name:spreadId, cards:'-', desc:''};

      // éšè—å¯¹è¯ï¼Œå±•ç¤ºç»“æœå¡
      document.getElementById('result').style.display = 'block';
      document.getElementById('progress').style.display = 'none';
      msgs.style.display = 'none';

      document.getElementById('rName').textContent = s.name;
      document.getElementById('rMeta').textContent = `${s.cards} å¼  Â· ${s.desc}`;
      
      // æ·»åŠ è¯¦ç»†æè¿°
      const descEl = document.getElementById('rDesc');
      if (descEl) {
        descEl.textContent = getSpreadDescription(spreadId);
      }

      // æ¸²æŸ“äººæ ¼åˆ—è¡¨ï¼ˆä¸ spread.html çš„äººæ ¼äº¤äº’é£æ ¼ä¸€è‡´ï¼‰
      const list = document.getElementById('personaList');
      const data = await ensurePersonasLoaded();
      list.innerHTML = data.map((p, idx)=>`
        <div class="personality-card ${idx === 0 ? 'selected' : ''}" 
             data-personality="${p.id.replace(/'/g,'\\'')}" 
             onclick="pickPersona('${p.id.replace(/'/g,'\\\'')}', '${(p.name||'').replace(/'/g,'\\\'')}')"
             style="cursor: pointer;">
          <div class="personality-emoji">${getPersonalityEmoji(p.id)}</div>
          <div class="personality-name">${p.name || p.id}</div>
          <div class="personality-trait">${p.desc || ''}</div>
        </div>
      `).join('');
      
      // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªäººæ ¼
      if (data.length > 0) {
        aiPersonality = data[0].id;
        updateGoButton();
      }
    }

    function getPersonalityEmoji(id) {
      const emojiMap = {
        'wisdom': 'ğŸ“š',
        'mystic': 'ğŸ”®', 
        'warm': 'ğŸ’',
        'blunt': 'âš¡',
        'heal': 'ğŸŒ¿',
        'ritual': 'ğŸ•¯ï¸',
        'pro': 'ğŸ“Š'
      };
      return emojiMap[id] || 'ğŸ—£ï¸';
    }

    function getSpreadDescription(spreadId) {
      const descriptions = {
        single_card: 'é€šè¿‡ä¸€å¼ å¡”ç½—ç‰Œè·å¾—å½“ä¸‹æœ€é‡è¦çš„æŒ‡å¼•å’Œå»ºè®®ã€‚',
        yes_no: 'é’ˆå¯¹ç‰¹å®šé—®é¢˜ç»™å‡ºæ˜ç¡®çš„æ˜¯å¦å€¾å‘åˆ¤æ–­ã€‚',
        three_cards: 'ä»æ—¶é—´ç»´åº¦åˆ†æè¿‡å»çš„å½±å“ã€ç°åœ¨çš„çŠ¶å†µå’Œæœªæ¥çš„è¶‹åŠ¿ã€‚',
        relationship: 'æ·±å…¥åˆ†æåŒæ–¹åœ¨å…³ç³»ä¸­çš„è§†è§’ã€æ„Ÿå—å’Œå¯èƒ½çš„å‘å±•æ–¹å‘ã€‚',
        choice_two: 'å¸®åŠ©ä½ åœ¨ä¸¤ä¸ªé€‰é¡¹ä¹‹é—´åšå‡ºæœ€é€‚åˆçš„å†³ç­–ã€‚',
        mind_body_spirit: 'ä»èº«ä½“ã€å¿ƒç†ã€ç²¾ç¥ä¸‰ä¸ªå±‚é¢åˆ†æå½“å‰çŠ¶æ€ã€‚',
        career: 'å…¨é¢åˆ†æèŒä¸šå‘å±•ä¸­çš„èµ„æºã€éšœç¢ã€æœºä¼šå’Œæ½œåœ¨é£é™©ã€‚',
        wealth: 'ä»å¤šè§’åº¦åˆ†æè´¢åŠ¡çŠ¶å†µå’Œé‡‘é’±èƒ½é‡çš„æµåŠ¨ã€‚',
        love_cross: 'æ·±åº¦å‰–ææ„Ÿæƒ…é—®é¢˜çš„æ ¹æºå’Œè§£å†³æ–¹æ¡ˆã€‚',
        spiritual: 'æ¢ç´¢ä¸ªäººç²¾ç¥æˆé•¿çš„æ–¹å‘å’Œäººç”Ÿè¯¾é¢˜ã€‚'
      };
      return descriptions[spreadId] || 'ä¸ºä½ æä¾›æ·±åº¦çš„æ´å¯Ÿå’ŒæŒ‡å¼•ã€‚';
    }

    function pickPersona(id, name){
      // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.personality-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // é€‰ä¸­å½“å‰å¡ç‰‡
      const selectedCard = document.querySelector(`[data-personality="${id}"]`);
      if (selectedCard) {
        selectedCard.classList.add('selected');
      }
      
      aiPersonality = id;
      updateGoButton();
      
      // æ˜¾ç¤ºç¡®è®¤æç¤º
      showPersonalityConfirmation(name || id);
    }

    function showPersonalityConfirmation(name) {
      // ç§»é™¤ä¹‹å‰çš„æç¤º
      const existingHint = document.querySelector('.persona-confirmation');
      if (existingHint) {
        existingHint.remove();
      }
      
      const hint = document.createElement('div');
      hint.className = 'persona-confirmation';
      hint.style.cssText = `
        margin: 12px 0 0 0;
        padding: 8px 12px;
        background: rgba(142,108,136,0.05);
        border: 1px solid rgba(142,108,136,0.12);
        border-radius: 8px;
        color: var(--accent-color);
        font-size: 14px;
        text-align: center;
      `;
      hint.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 6px;"></i>å·²é€‰æ‹©å¯¹è¯äººæ ¼ï¼š${name}`;
      
      document.querySelector('.personality-section').appendChild(hint);
    }

    function updateGoButton() {
      const btn = document.getElementById('goBtn');
      if (btn) {
        btn.disabled = !(chosenSpread && aiPersonality);
      }
    }

    function generateQuestion(){
      const titles = [];
      for (const h of history){
        const node = decision[h.step];
        const opt = node?.options?.[h.choice];
        if (opt?.title) titles.push(opt.title);
      }
      const main = titles.slice(-2).join('ï¼Œ');
      const sName = (spreadsShow[chosenSpread]?.name) || 'æœ¬æ¬¡ç‰Œé˜µ';
      return main ? `æˆ‘æƒ³ç”¨ã€Œ${sName}ã€çœ‹çœ‹ï¼š${main}` : `æˆ‘æƒ³ç”¨ã€Œ${sName}ã€åšä¸€æ¬¡å åœï¼Œç»™æˆ‘å…·ä½“å»ºè®®ã€‚`;
    }

    // ====== å¼€å§‹å åœï¼ˆä¸åç«¯ä¸€è‡´ï¼š/api/spread/drawï¼‰ ======
    async function proceedToSpread(btn){
      if (!chosenSpread){ 
        alert('è¯·å…ˆå®Œæˆé€‰æ‹©'); 
        return; 
      }
      if (!aiPersonality){ 
        alert('è¯·å…ˆé€‰æ‹©å¯¹è¯äººæ ¼'); 
        return; 
      }

      const oldText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‡†å¤‡ä¸­â€¦';

      try{
        const payload = {
          spread_id: chosenSpread,          // varcharï¼Œä¸ DB ä¸»é”®ä¸€è‡´
          question: generateQuestion(),     // åˆæˆé¦–é—®
          ai_personality: aiPersonality     // å­—ç¬¦ä¸²äººæ ¼
        };
        
        const res = await fetch('/api/spread/draw', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) throw new Error('æŠ½ç‰Œæ¥å£é”™è¯¯');
        
        const data = await res.json();
        if (data?.success && data?.redirect){
          window.location.href = data.redirect; // /spread/chat/<reading_id>
          return;
        }
        
        throw new Error(data?.error || 'æŠ½ç‰Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }catch(err){
        console.error(err);
        alert(err.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        btn.disabled = false;
        btn.innerHTML = oldText;
      }
    }

    function resetGuide(){
      // é‡ç½®æ‰€æœ‰çŠ¶æ€
      history = [];
      chosenSpread = null;
      aiPersonality = null;
      current = 'start';
      
      // æ¸…ç©ºå¹¶é‡æ–°æ˜¾ç¤ºå¯¹è¯åŒº
      msgs.innerHTML = '';
      msgs.style.display = '';
      document.getElementById('result').style.display = 'none';
      document.getElementById('progress').style.display = '';
      
      // é‡ç½®è¿›åº¦æŒ‡ç¤ºå™¨
      document.querySelectorAll('.dot').forEach((d,i)=>{
        d.classList.toggle('active', i===0);
        d.classList.remove('done');
      });
      
      // é‡æ–°å¼€å§‹
      showStep('start');
    }
  </script>
</body>
</html>