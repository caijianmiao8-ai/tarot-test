<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>æ™ºèƒ½ç‰Œé˜µæ¨è - å¡”ç½—å åœ</title>

  <!-- æœ¬åœ°åŒ–èµ„æºï¼ˆä¸ spread.html ä¿æŒä¸€è‡´ï¼‰ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/all.min.css') }}">

  <style>
    :root {
      --primary-color:#8e6c88; --secondary-color:#d1bfa7; --accent-color:#6d4c67;
      --light-color:#f8f4e9; --dark-color:#333333; --option-hover:rgba(142,108,136,0.08);
    }
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:linear-gradient(135deg,#f8f4e9 0%,#e8e0d1 100%);
      color:var(--dark-color); margin:0; min-height:100vh; display:flex; flex-direction:column;
    }
    /* é¡¶æ ï¼šæ²¿ç”¨ spread.html é£æ ¼ */
    .navbar{ position:sticky; top:0; z-index:50; background:rgba(255,255,255,0.9); backdrop-filter:blur(10px);
      box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:10px 20px; }
    .navbar-content{ max-width:1100px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
    .back-link{ color:var(--accent-color); text-decoration:none; display:flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; transition:.2s; }
    .back-link:hover{ background:var(--option-hover); }
    .nav-title{ font-weight:600; color:var(--accent-color); }

    .main{ max-width:1100px; width:100%; margin:24px auto; padding:0 16px; }
    .guide{ background:rgba(255,255,255,0.95); border-radius:24px; border:1px solid rgba(0,0,0,.06);
      box-shadow:0 15px 30px rgba(0,0,0,.08); overflow:hidden; }
    .decor{ height:90px; background:linear-gradient(135deg,var(--primary-color),var(--accent-color)); opacity:.08; }

    .stage{ padding:22px 18px 10px; }
    .progress{ display:flex; gap:8px; justify-content:center; margin-bottom:14px; }
    .dot{ width:8px; height:8px; border-radius:4px; background:#e5e7eb; transition:.25s; }
    .dot.active{ width:24px; background:var(--primary-color); }
    .dot.done{ background:var(--secondary-color); }

    .msgs{ display:flex; flex-direction:column; gap:16px; min-height:420px; }
    .msg{ display:flex; gap:12px; animation:fade .25s ease-out; }
    @keyframes fade{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }
    .ava{ width:42px; height:42px; border-radius:50%; background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
      color:#fff; display:grid; place-items:center; box-shadow:0 6px 16px rgba(142,108,136,.3);}
    .bubble{ background:#faf9f7; padding:14px 16px; border-radius:16px; border-bottom-left-radius:6px; line-height:1.6; }

    .options{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .opt{ background:#fff; border:2px solid #f0f0f0; border-radius:16px; padding:12px 14px;
      display:flex; align-items:center; gap:12px; cursor:pointer; transition:.2s;}
    .opt:hover{ background:var(--option-hover); border-color:#e5d9cc; transform:translateX(3px); }
    .opt .emoji{ width:28px; text-align:center; font-size:22px; }
    .opt .ttl{ font-weight:600; color:var(--accent-color); }
    .opt .desc{ font-size:13px; color:#999; }

    .user{ display:flex; justify-content:flex-end; }
    .user .me{ background:var(--primary-color); color:#fff; padding:10px 14px; border-radius:16px; border-bottom-right-radius:6px; }

    .result{ display:none; text-align:center; padding:24px; border-top:1px solid #eee; }
    .r-title{ font-size:20px; font-weight:700; color:var(--accent-color); margin-top:6px; }
    .r-desc{ color:#666; margin:6px 0 14px; }
    .card{ background:linear-gradient(135deg, rgba(142,108,136,.05), rgba(209,191,167,.06));
      border:1px solid #eee; border-radius:16px; padding:16px; margin-bottom:14px; text-align:left;}
    .name{ font-size:18px; font-weight:700; color:var(--primary-color); }
    .meta{ color:#666; font-size:14px; }

    .persona{ display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    .footer{ padding:10px 0 2px; display:flex; justify-content:flex-end; gap:10px; }
    .ghost{ border:1px solid #e5e7eb; background:#fff; border-radius:12px; padding:10px 14px; }

    .btn-primary{
      background:linear-gradient(135deg,var(--primary-color),var(--accent-color));
      color:#fff; border:none; padding:12px 18px; border-radius:18px; font-weight:600;
      box-shadow:0 8px 20px rgba(142,108,136,.3);
    }
    .btn-primary[disabled]{ opacity:.6; }

    @media (max-width:768px){
      .main{ margin:16px auto; }
      .msgs{ min-height:360px; }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar">
    <div class="navbar-content">
      <a class="back-link" href="{{ url_for('spread') }}"><i class="fas fa-chevron-left"></i> è¿”å›</a>
      <div class="nav-title">æ™ºèƒ½ç‰Œé˜µæ¨è</div>
      <div style="width:80px;"></div>
    </div>
  </nav>

  <main class="main">
    <section class="guide">
      <div class="decor"></div>

      <div class="stage">
        <!-- è¿›åº¦ -->
        <div class="progress" id="progress">
          <div class="dot active"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>

        <!-- å¯¹è¯åŒº -->
        <div class="msgs" id="msgs"></div>

        <!-- ç»“æœåŒº -->
        <div class="result" id="result">
          <div style="font-size:40px;">ğŸ¯</div>
          <div class="r-title">æ‰¾åˆ°æœ€é€‚åˆä½ çš„ç‰Œé˜µï¼</div>
          <div class="r-desc">æ ¹æ®ä½ çš„é€‰é¡¹ï¼Œæˆ‘ä»¬ä¸ºä½ æ¨èï¼š</div>

          <div class="card">
            <div class="name" id="rName"></div>
            <div class="meta" id="rMeta"></div>
          </div>

          <div class="card">
            <div style="font-weight:700; color:var(--accent-color); margin-bottom:6px;">
              é€‰æ‹©å¯¹è¯äººæ ¼ï¼ˆåªå½±å“è¯­æ°”ï¼Œä¸æ”¹å˜è§£è¯»ç»“è®ºï¼‰
            </div>
            <div class="persona" id="personaList">
              <!-- åŠ¨æ€æ¸²æŸ“ï¼šä¼˜å…ˆ /api/personasï¼Œå¤±è´¥æ—¶ä½¿ç”¨å†…ç½®åˆ—è¡¨ -->
            </div>
          </div>

          <div class="footer">
            <button class="ghost" onclick="resetGuide()">é‡æ–°é€‰æ‹©</button>
            <button class="btn-primary" id="goBtn" disabled onclick="proceedToSpread(this)">
              <i class="fas fa-sparkles"></i> å¼€å§‹å åœ
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ====== å†³ç­–æ ‘ï¼ˆspread_id ä½¿ç”¨ä½ æ•°æ®åº“çš„ varchar ä¸»é”®ï¼‰ ======
    const decision = {
      start: {
        message: "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å¡”ç½—å¼•å¯¼å¸ˆ âœ¨\nä»Šå¤©æƒ³æ¢ç´¢ä»€ä¹ˆä¸»é¢˜ï¼Ÿ",
        options: [
          { emoji:"ğŸ’•", title:"æ„Ÿæƒ…å…³ç³»", desc:"çˆ±æƒ…/äººé™…ç›¸å¤„", next:"love" },
          { emoji:"ğŸ’¼", title:"äº‹ä¸šå·¥ä½œ", desc:"èŒä¸šå‘å±•/æœºä¼š", next:"career" },
          { emoji:"ğŸ’°", title:"è´¢å¯Œé‡‘é’±", desc:"è´¢åŠ¡/æŠ•èµ„ç†è´¢", next:"wealth" },
          { emoji:"ğŸŒŸ", title:"ä¸ªäººæˆé•¿", desc:"è‡ªæˆ‘æ¢ç´¢/æ„ä¹‰æ„Ÿ", next:"growth" },
          { emoji:"â“", title:"é€šç”¨æŒ‡å¼•", desc:"æ—¥å¸¸/çŸ­é—®é¢˜", next:"general" }
        ]
      },
      love: {
        message: "å…³äºæ„Ÿæƒ…ï¼Œä½ æ›´æƒ³èšç„¦å“ªæ–¹é¢ï¼Ÿ",
        options: [
          { emoji:"ğŸ‘¥", title:"ç°æœ‰å…³ç³»", desc:"åŒæ–¹è§†è§’/èµ°å‘", result:"relationship" },
          { emoji:"ğŸ’˜", title:"æœªæ¥ç¼˜åˆ†", desc:"è¶‹åŠ¿ä¸æœºä¼š", result:"three_cards" },
          { emoji:"ğŸ’”", title:"å›°æƒ‘/çŸ›ç›¾", desc:"å®šä½é—®é¢˜ä¸æ”¹å–„", result:"love_cross" }
        ]
      },
      career: {
        message: "å…³äºäº‹ä¸šï¼Œä½ æ­¤åˆ»æœ€éœ€è¦ï¼Ÿ",
        options: [
          { emoji:"ğŸ“ˆ", title:"èŒä¸šå‘å±•", desc:"èµ„æº/é˜»ç¢/æœºä¼š/é£é™©", result:"career" },
          { emoji:"ğŸ¤”", title:"å·¥ä½œé€‰æ‹©", desc:"åœ¨ A/B ä¹‹é—´æŠ‰æ‹©", result:"choice_two" },
          { emoji:"ğŸ¯", title:"èŠ‚å¥è§„åˆ’", desc:"è¿‡å»-ç°åœ¨-æœªæ¥", result:"three_cards" }
        ]
      },
      wealth: {
        message: "å…³äºè´¢å¯Œï¼Œä½ æƒ³äº†è§£ï¼Ÿ",
        options: [
          { emoji:"ğŸ’¸", title:"è´¢åŠ¡ç°çŠ¶", desc:"ç°é‡‘æµä¸ä¼˜åŒ–", result:"wealth" },
          { emoji:"ğŸ“Š", title:"æŠ•èµ„å†³ç­–", desc:"Yes/No å€¾å‘", result:"yes_no" },
          { emoji:"ğŸ†", title:"æœºä¼šçª—å£", desc:"çŸ­æœŸæŠŠæ¡", result:"three_cards" }
        ]
      },
      growth: {
        message: "ä½ å¸Œæœ›åœ¨å“ªæ–¹é¢è·å¾—æˆé•¿ï¼Ÿ",
        options: [
          { emoji:"ğŸ§˜", title:"èº«å¿ƒå¹³è¡¡", desc:"èº«/å¿ƒ/çµè°ƒé¢‘", result:"mind_body_spirit" },
          { emoji:"ğŸŒˆ", title:"äººç”Ÿæ–¹å‘", desc:"é˜¶æ®µè¯¾é¢˜ä¸è¶‹åŠ¿", result:"spiritual" },
          { emoji:"âœ¨", title:"æ•´ä½“è„‰ç»œ", desc:"è¿‡å»ç°åœ¨æœªæ¥", result:"three_cards" }
        ]
      },
      general: {
        message: "é€šç”¨æŒ‡å¼•æƒ³æ€ä¹ˆæ¥ï¼Ÿ",
        options: [
          { emoji:"ğŸ“…", title:"æ¯æ—¥æç¤º", desc:"å½“ä¸‹ä¸€æ¡å»ºè®®", result:"single_card" },
          { emoji:"ğŸ²", title:"æ˜¯å¦åˆ¤æ–­", desc:"Yes/No å¿«é€Ÿåˆ¤æ–­", result:"yes_no" },
          { emoji:"ğŸŒ…", title:"æ•´ä½“è¶‹åŠ¿", desc:"ä¸‰å¼ ç‰Œçœ‹èµ°å‘", result:"three_cards" }
        ]
      }
    };

    // å±•ç¤ºä¿¡æ¯ï¼ˆä»… UI ç”¨ï¼Œä¸å½±å“åç«¯ï¼‰
    const spreadsShow = {
      single_card:{ name:'å•ç‰ŒæŒ‡å¼•', cards:1, desc:'å¿«é€Ÿè·å–å½“ä¸‹æ ¸å¿ƒæç¤º' },
      yes_no:{ name:'æ˜¯å¦ç‰Œé˜µ', cards:1, desc:'åˆ¤æ–­å€¾å‘ä¸æ³¨æ„ç‚¹' },
      three_cards:{ name:'æ—¶é—´ä¸‰ç‰Œé˜µ', cards:3, desc:'è¿‡å»-ç°åœ¨-æœªæ¥' },
      relationship:{ name:'å…³ç³»ç‰Œé˜µ', cards:5, desc:'åŒæ–¹è§†è§’ä¸èµ°å‘' },
      choice_two:{ name:'äºŒé€‰ä¸€ç‰Œé˜µ', cards:3, desc:'æƒè¡¡åˆ©å¼Šä¸ç»“è®º' },
      mind_body_spirit:{ name:'èº«å¿ƒçµç‰Œé˜µ', cards:3, desc:'è‡ªæˆ‘å¹³è¡¡ä¸è°ƒé¢‘' },
      career:{ name:'èŒä¸šå‘å±•ç‰Œé˜µ', cards:5, desc:'èµ„æº/é˜»ç¢/æœºä¼š/é£é™©' },
      wealth:{ name:'è´¢å¯Œä¹‹è·¯ç‰Œé˜µ', cards:4, desc:'ç°é‡‘æµ/æœºä¼š/é£é™©' },
      love_cross:{ name:'çˆ±æƒ…åå­—ç‰Œé˜µ', cards:5, desc:'ç°çŠ¶/å†…å¤–å› /å»ºè®®/èµ°å‘' },
      spiritual:{ name:'çµæ€§æˆé•¿ç‰Œé˜µ', cards:7, desc:'é•¿æœŸæ–¹å‘ä¸è¯¾é¢˜' }
    };

    // äººæ ¼ï¼šä¼˜å…ˆä» /api/personas å–ï¼›å¤±è´¥åˆ™ç”¨ fallbackï¼ˆä¸ spread.html é£æ ¼ç»Ÿä¸€ï¼‰
    let personas = null;
    const personasFallback = [
      { id:'warm',   name:'æ¸©æŸ”åŠ¡å®', desc:'åŒç†å¿ƒå¼ºï¼Œå»ºè®®å…·ä½“å¯è½åœ°' },
      { id:'blunt',  name:'ç›´ç»™æ¯’èˆŒ', desc:'ä¸æ‹å¼¯ï¼Œç»“è®ºä¼˜å…ˆ' },
      { id:'heal',   name:'æ²»æ„ˆç³»',   desc:'æ¸©æŸ”æŠšæ…°ï¼Œæ³¨é‡æƒ…ç»ªæ”¯æŒ' },
      { id:'ritual', name:'ä»ªå¼æ„Ÿå¤é£', desc:'æ–‡é›…ç¥ç§˜çš„ä»ªå¼è¯­è¨€' },
      { id:'pro',    name:'ä¸“ä¸šå­¦è€…', desc:'ç»“æ„åŒ–ä¸æ–¹æ³•è®º' }
    ];

    // ====== çŠ¶æ€ ======
    let current = 'start';
    let history = [];
    let chosenSpread = null;     // ä¸ DB ä¸­ spreads.id ä¸€è‡´ï¼ˆvarcharï¼‰
    let aiPersonality = null;    // å­—ç¬¦ä¸²ï¼Œæäº¤ç»™åç«¯çš„ ai_personality
    const msgs = document.getElementById('msgs');

    document.addEventListener('DOMContentLoaded', () => {
      showStep('start');
    });

    async function ensurePersonasLoaded(){
      if (personas) return personas;
      try{
        const res = await fetch('/api/personas');
        if (!res.ok) throw new Error('no personas api');
        const data = await res.json();
        // æœŸæœ›ï¼š[{id, name, desc/style?}]â€”â€”ä¸ spread.html çš„äººæ ¼é€‰æ‹©ä¿æŒä¸€è‡´ä½“éªŒ
        personas = Array.isArray(data) && data.length ? data.map(p=>({
          id: p.id ?? p.code ?? 'warm', name: p.name ?? 'è‡ªå®šä¹‰äººæ ¼', desc: p.desc ?? (p.style ? `é£æ ¼ï¼š${p.style}` : '')
        })) : personasFallback;
      }catch(_){
        personas = personasFallback;
      }
      return personas;
    }

    // ====== æ¸²æŸ“æ­¥éª¤ ======
    function showStep(id){
      const node = decision[id]; if (!node) return;
      current = id; updateProgress();

      const block = document.createElement('div');
      block.className = 'msg';
      const text = node.message.replace(/</g,'&lt;').replace(/>/g,'&gt;'); // ç®€å•è½¬ä¹‰
      block.innerHTML = `
        <div class="ava"><i class="fas fa-sparkles"></i></div>
        <div class="bubble">
          <div style="white-space:pre-line">${text}</div>
          <div class="options">
            ${node.options.map((o,i)=>`
              <div class="opt" data-idx="${i}">
                <div class="emoji">${o.emoji}</div>
                <div style="flex:1">
                  <div class="ttl">${o.title}</div>
                  <div class="desc">${o.desc || ''}</div>
                </div>
                <div style="color:#d1bfa7"><i class="fas fa-chevron-right"></i></div>
              </div>
            `).join('')}
          </div>
        </div>`;
      msgs.appendChild(block);

      block.querySelectorAll('.opt').forEach(el=>{
        el.addEventListener('click', ()=>selectOption(parseInt(el.dataset.idx,10), block));
      });

      setTimeout(()=>{ msgs.scrollTop = msgs.scrollHeight; }, 50);
    }

    function selectOption(index, block){
      // ç¦ç”¨è¯¥å—
      block.querySelectorAll('.opt').forEach(el=>{ el.style.pointerEvents='none'; el.style.opacity='.6'; });

      const node = decision[current];
      const opt = node.options[index];

      // ç”¨æˆ·é€‰æ‹©æ³¡æ³¡
      const me = document.createElement('div');
      me.className = 'user';
      me.innerHTML = `<div class="me">${opt.emoji} ${opt.title}</div>`;
      msgs.appendChild(me);
      history.push({ step: current, choice: index });

      setTimeout(()=>{
        if (opt.result){
          showResult(opt.result);
        } else if (opt.next){
          showStep(opt.next);
        }
        msgs.scrollTop = msgs.scrollHeight;
      }, 450);
      updateProgress();
    }

    function updateProgress(){
      const dots = document.querySelectorAll('.dot');
      const idx = history.length;
      dots.forEach((d,i)=>{
        d.classList.toggle('done', i < idx);
        d.classList.toggle('active', i === idx);
      });
    }

    // ====== ç»“æœ & äººæ ¼é€‰æ‹© ======
    async function showResult(spreadId){
      chosenSpread = spreadId;
      const s = spreadsShow[spreadId] || {name:spreadId, cards:'-', desc:''};

      // éšè—å¯¹è¯ï¼Œå±•ç¤ºç»“æœå¡
      document.getElementById('result').style.display = 'block';
      document.getElementById('progress').style.display = 'none';
      msgs.style.display = 'none';

      document.getElementById('rName').textContent = s.name;
      document.getElementById('rMeta').textContent = `${s.cards} å¼  Â· ${s.desc}`;

      // æ¸²æŸ“äººæ ¼åˆ—è¡¨ï¼ˆä¸ spread.html çš„äººæ ¼äº¤äº’é£æ ¼ä¸€è‡´ï¼‰
      const list = document.getElementById('personaList');
      const data = await ensurePersonasLoaded();
      list.innerHTML = data.map(p=>`
        <div class="opt" onclick="pickPersona('${p.id.replace(/'/g,'\\\'')}', '${(p.name||'').replace(/'/g,'\\\'')}')">
          <div class="emoji">ğŸ—£ï¸</div>
          <div style="flex:1">
            <div class="ttl">${p.name || p.id}</div>
            <div class="desc">${p.desc || ''}</div>
          </div>
          <div><i class="fas fa-check"></i></div>
        </div>
      `).join('');
    }

    function pickPersona(id, name){
      aiPersonality = id;
      // æ˜¾ç¤ºç¡®è®¤
      const hint = document.createElement('div');
      hint.style.margin = '6px 0 0 2px';
      hint.style.color = '#6b7280';
      hint.textContent = `å·²é€‰æ‹©å¯¹è¯äººæ ¼ï¼š${name || id}`;
      document.querySelector('#personaList').after(hint);
      document.getElementById('goBtn').disabled = !(chosenSpread && aiPersonality);
    }

    function generateQuestion(){
      const titles = [];
      for (const h of history){
        const node = decision[h.step];
        const opt = node?.options?.[h.choice];
        if (opt?.title) titles.push(opt.title);
      }
      const main = titles.slice(-2).join('ï¼Œ');
      const sName = (spreadsShow[chosenSpread]?.name) || 'æœ¬æ¬¡ç‰Œé˜µ';
      return main ? `æˆ‘æƒ³ç”¨ã€Œ${sName}ã€çœ‹çœ‹ï¼š${main}` : `æˆ‘æƒ³ç”¨ã€Œ${sName}ã€åšä¸€æ¬¡å åœï¼Œç»™æˆ‘å…·ä½“å»ºè®®ã€‚`;
    }

    // ====== å¼€å§‹å åœï¼ˆä¸åç«¯ä¸€è‡´ï¼š/api/spread/drawï¼‰ ======
    async function proceedToSpread(btn){
      if (!chosenSpread){ alert('è¯·å…ˆå®Œæˆé€‰æ‹©'); return; }
      if (!aiPersonality){ alert('è¯·å…ˆé€‰æ‹©å¯¹è¯äººæ ¼'); return; }

      const old = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> å‡†å¤‡ä¸­â€¦';

      try{
        const payload = {
          spread_id: chosenSpread,          // varcharï¼Œä¸ DB ä¸»é”®ä¸€è‡´
          question: generateQuestion(),     // åˆæˆé¦–é—®
          ai_personality: aiPersonality     // å­—ç¬¦ä¸²äººæ ¼
        };
        const res = await fetch('/api/spread/draw', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('æŠ½ç‰Œæ¥å£é”™è¯¯');
        const data = await res.json();
        if (data?.success && data?.redirect){
          window.location.href = data.redirect; // /spread/chat/<reading_id>
          return;
        }
        throw new Error(data?.error || 'æŠ½ç‰Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }catch(err){
        console.error(err);
        alert(err.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        btn.disabled = false;
        btn.innerHTML = old;
      }
    }

    function resetGuide(){
      history = [];
      chosenSpread = null;
      aiPersonality = null;
      msgs.innerHTML = '';
      msgs.style.display = '';
      document.getElementById('result').style.display = 'none';
      document.getElementById('progress').style.display = '';
      document.querySelectorAll('.dot').forEach((d,i)=>{
        d.classList.toggle('active', i===0);
        d.classList.remove('done');
      });
      showStep('start');
    }
  </script>
</body>
</html>
