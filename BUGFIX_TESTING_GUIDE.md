# Bug修复 - 测试指南

## 修复的问题

### 问题描述
用户报告："无法创建角色 也无法进入世界"

### 根本原因
所有API路由缺少错误处理（try-catch块），导致：
1. 当发生错误时，服务器返回500错误
2. 前端只显示"网络错误"，无法看到真实错误信息
3. 无法调试具体问题

### 修复内容

已为以下API添加完整的错误处理：

1. **`POST /api/worlds/create`** - 创建世界
   - ✅ 添加 try-catch 包装
   - ✅ 验证 template_id 是否提供
   - ✅ 返回详细的错误信息
   - ✅ 打印错误堆栈到控制台

2. **`POST /api/characters/create`** - 创建角色
   - ✅ 添加 try-catch 包装
   - ✅ 验证 char_name 不为空
   - ✅ 返回详细的错误信息
   - ✅ 打印错误堆栈到控制台

3. **`POST /api/runs/start`** - 开始游戏
   - ✅ 添加 try-catch 包装
   - ✅ 验证 world_id 和 character_id 是否提供
   - ✅ 返回详细的错误信息
   - ✅ 打印错误堆栈到控制台

4. **`POST /api/runs/<run_id>/action`** - 提交行动
   - ✅ 添加 try-catch 包装
   - ✅ 返回详细的错误信息
   - ✅ 打印错误堆栈到控制台

### 错误响应格式

所有API现在返回统一的错误格式：

```json
{
  "ok": false,
  "error": "具体的错误描述"
}
```

成功响应格式：

```json
{
  "ok": true,
  ...其他数据
}
```

## 测试步骤

### 前提条件

1. **数据库迁移已运行**
   - 确认 `migrations/20251120_adventure_system.sql` 已在 Supabase 中执行
   - 验证5个表已创建（使用 Supabase SQL 编辑器运行 `\dt adventure_*`）

2. **环境变量已配置**（在 Vercel Dashboard）
   ```
   OPENROUTER_API_KEY=sk-or-v1-xxx...
   ADVENTURE_AI_PROVIDER=openrouter
   OPENROUTER_MODEL=qwen/qwen-2.5-72b-instruct
   ```

3. **代码已部署**
   - 推送到 GitHub
   - Vercel 自动部署完成

### 测试场景 1: 创建世界

1. 访问 `https://your-domain.com/g/world_adventure/`
2. 点击"创建新世界"按钮
3. 选择一个世界模板（应该高亮显示）
4. 填写世界名称，例如："测试世界"
5. 调整参数滑块（可选）
6. 点击"创建世界"按钮

**预期结果：**
- ✅ 显示加载动画（"AI 正在为你生成世界..."）
- ✅ 10-30秒后，跳转回主页
- ✅ 在主页看到新创建的世界

**可能的错误：**
- ❌ 如果看到"模板不存在"：数据库中没有模板数据，需要运行SQL插入模板
- ❌ 如果看到"OPENROUTER_API_KEY not configured"：环境变量未配置
- ❌ 如果看到AI相关错误：检查API key是否有效，模型名称是否正确

### 测试场景 2: 创建角色

1. 访问 `https://your-domain.com/g/world_adventure/characters/create`
2. 选择一个职业（例如：战士）
3. 填写角色名称，例如："艾莉亚"
4. 使用 +/- 按钮分配30点能力值
   - 确保剩余点数为 0
5. 填写背景故事（可选）
6. 点击"创建角色"按钮

**预期结果：**
- ✅ 按钮被禁用
- ✅ 成功后跳转回主页
- ✅ 在主页看到新创建的角色

**可能的错误：**
- ❌ 如果看到"请输入角色名称"：名称字段为空
- ❌ 如果看到"请分配完所有能力点数"：还有剩余点数

### 测试场景 3: 开始游戏

1. 在主页，确保已有世界和角色
2. 选择一个世界
3. 选择一个角色
4. 点击"开始冒险"按钮

**预期结果：**
- ✅ 跳转到游戏界面
- ✅ 左侧显示世界和角色信息
- ✅ 中间显示对话区域
- ✅ 底部有输入框

**可能的错误：**
- ❌ 如果看到"请选择世界和角色"：未选择世界或角色
- ❌ 如果看到"世界不存在"或"角色不存在"：数据库中没有对应记录

### 测试场景 4: 游玩游戏

1. 在游戏界面，输入一个行动，例如："我环顾四周，观察这个地方"
2. 点击"提交行动"按钮

**预期结果：**
- ✅ 玩家消息立即显示
- ✅ 出现"DM 正在思考..."提示
- ✅ 5-15秒后，DM响应显示
- ✅ 回合数增加

**可能的错误：**
- ❌ 如果看到"行动不能为空"：输入框为空
- ❌ 如果看到AI相关错误：检查API配置
- ❌ 如果DM响应是默认文本（"你执行了行动..."）：AI调用失败，使用了降级方案

## 查看详细错误日志

### 在 Vercel 中查看日志

1. 访问 Vercel Dashboard
2. 选择项目
3. 点击 "Logs" 标签
4. 查找包含 "创建世界失败"、"创建角色失败" 等的错误日志
5. 展开查看完整的错误堆栈

### 常见错误及解决方案

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `OPENROUTER_API_KEY not configured` | 环境变量未设置 | 在 Vercel 中添加环境变量 |
| `table "adventure_worlds" does not exist` | 数据库迁移未运行 | 在 Supabase 中运行SQL迁移文件 |
| `OpenRouter API error: 401` | API key 无效 | 检查API key是否正确 |
| `OpenRouter API error: 429` | 超过速率限制 | 等待后重试 |
| `模板不存在` | 数据库中没有模板 | 运行SQL文件中的INSERT语句 |
| `Connection refused` | 数据库连接问题 | 检查 DATABASE_URL 环境变量 |

## 成功标准

✅ **所有测试通过：**
1. 能成功创建世界（看到AI生成的描述、地点、势力、NPC）
2. 能成功创建角色（看到角色出现在列表中）
3. 能成功开始游戏（进入游戏界面）
4. 能成功提交行动（收到AI DM的响应）

✅ **错误处理正常：**
1. 如果出错，能看到具体的错误信息（不只是"网络错误"）
2. 错误信息显示在页面顶部的红色错误框中
3. Vercel日志中有详细的错误堆栈

## 下一步

如果测试通过：
- ✅ 系统正常工作
- ✅ 可以开始使用游戏功能

如果仍有问题：
1. 检查 Vercel 日志中的具体错误信息
2. 确认所有环境变量已正确配置
3. 确认数据库迁移已完全运行
4. 联系开发者并提供错误日志

---

**修复完成时间：** 2025-11-20
**修复内容：** 为所有API添加错误处理和详细错误信息
